<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ¼t Takip ProgramÄ± - Tam SÃ¼rÃ¼m</title>
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
</head>
<body>
    <div class="sidebar">
        <h1>SÃ¼t Takip ProgramÄ±</h1>
        <nav id="sidebarNav">
            <ul>
                <li><a href="#dashboard" class="nav-link active">ğŸ“ Kontrol Paneli</a></li>
                <li><a href="#cari-yonetimi" class="nav-link">ğŸ‘¥ Cari YÃ¶netimi</a></li>
                <li><a href="#sut-alimi" class="nav-link">ğŸ¥› GÃ¼nlÃ¼k SÃ¼t AlÄ±mÄ±</a></li>
                <li><a href="#yem-stok-yonetimi" class="nav-link">ğŸ“¦ Yem Stok YÃ¶netimi</a></li>
                <li><a href="#yem-satisi" class="nav-link">ğŸŒ¾ Yem SatÄ±ÅŸÄ±</a></li>
                <li><a href="#tahsilat-ve-odemeler" class="nav-link">ğŸ’³ Tahsilat ve Ã–demeler</a></li>
                <li><a href="#hesap-ozeti" class="nav-link">ğŸ“Š Cari Hesap Ã–zeti</a></li>
                <li><a href="#sut-alim-raporu" class="nav-link">ğŸ—“ï¸ AylÄ±k SÃ¼t Raporu</a></li>
                <li><a href="#aylik-yem-raporu" class="nav-link">ğŸ“ˆ AylÄ±k Yem Raporu</a></li>
                <li><a href="#ayarlar" class="nav-link">âš™ï¸ Ayarlar</a></li>
                <li class="logout-link">
                    <a href="#" id="logoutButton">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
                </li>
            </ul>
        </nav>
    </div>

    <div class="main-content">
        <section id="dashboard" class="module-section">
            <div class="module-header"><h2>ğŸ“ Kontrol Paneli</h2></div>
            <div class="container">
                <h3>Genel Ä°statistikler</h3>
                 <p>Toplam KayÄ±tlÄ± Cari SayÄ±sÄ±: <span id="totalCari">0</span></p>
                 <p>TanÄ±mlÄ± Yem Ã‡eÅŸidi: <span id="totalYemCesidi">0</span></p>
                 <p>BugÃ¼nkÃ¼ Toplam SÃ¼t AlÄ±m KayÄ±t SayÄ±sÄ±: <span id="todaySutAlim">0</span></p>
            </div>
        </section>
        
        <section id="cari-yonetimi" class="module-section">
            <div class="module-header">
                <h2>ğŸ‘¥ Cari YÃ¶netimi</h2>
                <div class="search-container dont-calisan">
                    <input type="text" id="cariSearchInput" placeholder="Cari Ara..." aria-label="Cari Arama Kutusu">
                </div>
            </div>
            <div class="container">
                <div class="form-section"><h3><span id="cariFormBaslik">Yeni Cari Kart</span></h3><form id="cariForm" action="#"><input type="hidden" id="cariEditId"><div class="form-grid">
                    <div class="form-group"><label for="cariKodu">Cari Kodu:</label><input type="text" id="cariKodu" placeholder="Ã–rn: C001"></div>
                    <div class="form-group"><label for="cariAdiSoyadi">AdÄ± SoyadÄ± / Firma AdÄ±:</label><input type="text" id="cariAdiSoyadi" required></div>
                    <div class="form-group"><label for="cariKategori">Kategori/KÃ¶y:</label><select id="cariKategori" required><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="cariDurum">Durum:</label><select id="cariDurum"><option value="aktif">Aktif</option><option value="pasif">Pasif</option></select></div>
                    <div class="form-group"><label for="cariTelefon">Telefon:</label><input type="tel" id="cariTelefon"></div>
                    <div class="form-group"><label for="cariEposta">E-posta:</label><input type="email" id="cariEposta"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="cariAdres">Adres:</label><textarea id="cariAdres"></textarea></div>
                    <div class="form-group"><label for="cariBankaAdi">Banka AdÄ±:</label><input type="text" id="cariBankaAdi"></div>
                    <div class="form-group"><label for="cariIban">IBAN:</label><input type="text" id="cariIban"></div>
                    <div class="form-group"><label for="cariVergiDairesi">Vergi Dairesi:</label><input type="text" id="cariVergiDairesi"></div>
                    <div class="form-group"><label for="cariVergiNo">Vergi No / T.C.:</label><input type="text" id="cariVergiNo"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="cariNotlar">Ã–zel Notlar:</label><textarea id="cariNotlar"></textarea></div>
                </div><button type="submit" class="btn btn-primary" id="cariKaydetBtn">Kaydet</button><button type="button" class="btn dont-calisan" id="cariFormTemizleBtn" style="display:none;">Yeni KayÄ±t</button></form></div>
                
                <div id="cari-list-printable-area" class="dont-calisan">
                    <h3 class="print-only print-title" id="cariListeRaporBaslik">Cari Listesi Raporu</h3>
                    <div class="list-section">
                        <div class="list-header-with-filter">
                            <h3>Cari Listesi</h3>
                            <select id="cariKategoriFiltre">
                                <option value="">TÃ¼m Kategoriler</option>
                            </select>
                        </div>
                        <table>
                            <thead><tr><th>Kod</th><th>Ad/Firma</th><th>Kategori</th><th>Durum</th><th>Telefon</th><th>Bakiye</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead>
                            <tbody id="cariListesiBody"></tbody>
                            <tfoot id="cariListesiFooter"></tfoot>
                        </table>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary dont-print dont-calisan" id="cariListesiYazdirBtn" style="margin-top: 20px;">Listeyi YazdÄ±r</button>
            </div>
        </section>

        <section id="sut-alimi" class="module-section hidden-section">
            <div class="module-header"><h2>ğŸ¥› GÃ¼nlÃ¼k SÃ¼t AlÄ±mÄ±</h2></div>
            <div class="container">
                <div class="form-section">
                    <h3>GiriÅŸ Filtreleri</h3>
                    <div class="form-grid" id="sutGirisFiltreler" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group"><label for="topluGirisTarih">GiriÅŸ Tarihi:</label><input type="date" id="topluGirisTarih" required></div>
                        <div class="form-group"><label for="topluGirisKategori">Kategori/KÃ¶y SeÃ§in:</label><select id="topluGirisKategori" required><option value="">TÃ¼m Kategoriler</option></select></div>
                    </div>
                </div>
                <div class="list-section">
                    <h3>GÃ¼nlÃ¼k SÃ¼t GiriÅŸi</h3>
                    <div id="topluSutGirisTablosuAlani"></div>
                    <p id="topluGirisTedarikciYokMesaji" style="text-align:center; display:none;">Bu kategoride sÃ¼t giriÅŸi beklenen aktif cari bulunmuyor.</p>
                </div>
                <hr style="margin: 40px 0;">
                <div class="list-section">
                    <h3>SÃ¼t AlÄ±m GeÃ§miÅŸi (SeÃ§ili Tarih: <span id="gecmisTarihSpan"></span>)</h3>
                    <table>
                        <thead id="sutAlimGecmisiHeader"></thead>
                        <tbody id="sutAlimGecmisiBody"></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section id="yem-stok-yonetimi" class="module-section hidden-section">
             <div class="module-header"><h2>ğŸ“¦ Yem Stok YÃ¶netimi</h2></div>
             <div class="container">
                <div class="form-section"><h3><span id="yemTanimFormBaslik">Yeni Yem TanÄ±mla</span></h3><form id="yemTanimForm" action="#"><input type="hidden" id="yemTanimEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemKodu">Kod:</label><input type="text" id="yemKodu" required></div>
                    <div class="form-group"><label for="yemAdi">Ad:</label><input type="text" id="yemAdi" required></div>
                    <div class="form-group"><label for="yemKategorisi">Kategori:</label><select id="yemKategorisi"><option value="buyukbas">BÃ¼yÃ¼kbaÅŸ</option><option value="kucukbas">KÃ¼Ã§Ã¼kbaÅŸ</option></select></div>
                    <div class="form-group"><label for="yemBirimi">Birim:</label><input type="text" id="yemBirimi" value="Ã‡uval"></div>
                    <div class="form-group"><label for="yemAlisFiyati">AlÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemAlisFiyati" step="0.01"></div>
                    <div class="form-group"><label for="yemSatisFiyati">SatÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemSatisFiyati" step="0.01"></div>
                </div><button type="submit" class="btn btn-primary" id="yemTanimKaydetBtn">Kaydet</button><button type="button" class="btn" id="yemTanimFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>TanÄ±mlÄ± Yemler & Stok</h3><table><thead><tr><th>Kod</th><th>Ad</th><th>Kategori</th><th>Birim</th><th>AlÄ±ÅŸ F.</th><th>SatÄ±ÅŸ F.</th><th>Stok</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="yemStokListesiBody"></tbody></table></div>
                <hr>
                <div class="form-section"><h3><span id="yemAlisFormBaslik">Yeni Yem AlÄ±ÅŸÄ±</span></h3><form id="yemAlisForm" action="#"><input type="hidden" id="yemAlisEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemAlisTarih">Tarih:</label><input type="date" id="yemAlisTarih" required></div>
                    <div class="form-group"><label for="yemSecimiAlis">Yem:</label><select id="yemSecimiAlis" required><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="yemAlisMiktar">Miktar:</label><input type="number" id="yemAlisMiktar" step="1" required></div>
                    <div class="form-group"><label for="yemAlisTedarikci">Cari:</label><select id="yemAlisTedarikci"><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="yemAlisBirimFiyati">AlÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemAlisBirimFiyati" step="0.01" required></div>
                    <div class="form-group"><label for="yemAlisToplamTutar">Toplam Tutar:</label><input type="text" id="yemAlisToplamTutar" readonly></div>
                </div><button type="submit" class="btn btn-primary" id="yemAlisKaydetBtn">AlÄ±ÅŸÄ± Kaydet</button><button type="button" class="btn" id="yemAlisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Yem AlÄ±ÅŸ Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Yem</th><th>Miktar</th><th>Cari</th><th>AlÄ±ÅŸ F.</th><th>Tutar</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="yemAlisHareketListesiBody"></tbody></table></div>
             </div>
        </section>
        <section id="yem-satisi" class="module-section hidden-section">
             <div class="module-header"><h2>ğŸŒ¾ Yem SatÄ±ÅŸÄ±</h2></div>
             <div class="container">
                <div class="form-section"><h3><span id="yemSatisFormBaslik">Yeni Yem SatÄ±ÅŸÄ±</span></h3><form id="yemSatisForm" action="#"><input type="hidden" id="yemSatisEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemSatisTarih">Tarih:</label><input type="date" id="yemSatisTarih" required></div>
                    <div class="form-group"><label for="yemAlanTedarikci">Alan Cari:</label><select id="yemAlanTedarikci" required><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="yemSecimiSatis">Yem:</label><select id="yemSecimiSatis" required><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="yemSatisMiktar">Miktar:</label><input type="number" id="yemSatisMiktar" step="1" required></div>
                    <div class="form-group"><label for="yemSatisBirimFiyati">SatÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemSatisBirimFiyati" step="0.01" required></div>
                    <div class="form-group"><label for="yemSatisToplamTutar">Toplam Tutar:</label><input type="text" id="yemSatisToplamTutar" readonly></div>
                </div><button type="submit" class="btn btn-primary" id="yemSatisKaydetBtn">SatÄ±ÅŸÄ± Kaydet</button><button type="button" class="btn" id="yemSatisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Yem SatÄ±ÅŸ Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Alan Cari</th><th>Yem</th><th>Miktar</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="yemSatisListesiBody"></tbody></table></div>
             </div>
        </section>
        <section id="tahsilat-ve-odemeler" class="module-section hidden-section">
            <div class="module-header"><h2>ğŸ’³ Tahsilat ve Ã–demeler</h2></div>
            <div class="container">
                 <div class="form-section"><h3><span id="odemeFormBaslik">Yeni Hareket GiriÅŸi</span></h3><form id="odemeForm" action="#"><input type="hidden" id="odemeEditId"><div class="form-grid">
                    <div class="form-group"><label for="islemTuru">Ä°ÅŸlem TÃ¼rÃ¼:</label><select id="islemTuru" required><option value="odeme">Ã–deme</option><option value="tahsilat">Tahsilat</option></select></div>
                    <div class="form-group"><label for="odemeTarih">Tarih:</label><input type="date" id="odemeTarih" required></div>
                    <div class="form-group"><label for="odemeYapilanTedarikci">Cari:</label><select id="odemeYapilanTedarikci" required><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="odemeTutari">Tutar (TL):</label><input type="number" id="odemeTutari" step="0.01" required></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="odemeAciklama">AÃ§Ä±klama:</label><textarea id="odemeAciklama" rows="2"></textarea></div>
                 </div><button type="submit" class="btn btn-primary" id="odemeKaydetBtn">Kaydet</button><button type="button" class="btn" id="odemeFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                 <div class="list-section"><h3>Ä°ÅŸlem Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Cari</th><th>Ä°ÅŸlem TÃ¼rÃ¼</th><th>Tutar</th><th>AÃ§Ä±klama</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="odemeListesiBody"></tbody></table></div>
            </div>
        </section>
        <section id="hesap-ozeti" class="module-section">
            <div class="module-header dont-print"><h2>ğŸ“Š Cari Hesap Ã–zeti</h2></div>
            <div class="container">
                <div class="report-section">
                    <h3 class="dont-print">Cari Hesap Ã–zeti</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: 1fr 1fr auto; align-items: end;">
                        <div class="form-group"><label for="raporCariSecimi">Cari SeÃ§in:</label><select id="raporCariSecimi"><option value="">SeÃ§iniz...</option></select></div>
                        <div class="form-group"><label for="raporTarihAraligi">Ay:</label><input type="month" id="raporTarihAraligi"></div>
                        <button type="button" class="btn btn-primary" id="raporOlusturBtn" style="height:45px;">Rapor OluÅŸtur</button>
                    </div> <hr class="dont-print">
                    <div id="report-content-to-print" class="printable-content format-a5">
                        <h1 class="print-only print-title">SÃ¼t Takip ProgramÄ± - Cari Hesap Ã–zeti</h1>
                        <h4 id="raporBaslik" style="text-align:center;">LÃ¼tfen Rapor Kriterlerini SeÃ§in</h4>
                        <div id="raporDetayAlani"></div>
                    </div>
                    <button type="button" class="btn btn-secondary dont-print" id="raporYazdirBtn" style="margin-top:20px;">Ã–zeti YazdÄ±r</button>
                </div>
            </div>
        </section>
        <section id="sut-alim-raporu" class="module-section">
             <div class="module-header dont-print"><h2>ğŸ—“ï¸ AylÄ±k SÃ¼t Raporu</h2></div>
            <div class="container">
                 <div class="report-section">
                    <h3>DetaylÄ± SÃ¼t AlÄ±m Raporu</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: repeat(4, 1fr); align-items: end; gap: 10px;">
                        <div class="form-group"><label for="sutRaporuTedarikciSecimi">Cari SeÃ§in:</label><select id="sutRaporuTedarikciSecimi"><option value="">SeÃ§iniz...</option></select></div>
                        <div class="form-group"><label for="sutRaporuAySecimi">Ay:</label><input type="month" id="sutRaporuAySecimi"></div>
                        <div class="form-group"><label for="sutRaporuKategoriSecimi">Kategori:</label><select id="sutRaporuKategoriSecimi"><option value="">TÃ¼mÃ¼</option></select></div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-primary" id="sutRaporuOlusturBtn" style="height:45px; flex-grow: 1;">GÃ¶ster</button>
                            <button type="button" class="btn btn-info" id="sutRaporuKategoriGosterBtn" style="height:45px; flex-grow: 1;">Kategori</button>
                            <button type="button" class="btn btn-info" id="sutRaporuTumunuGosterBtn" style="height:45px; flex-grow: 1;">Toplu</button>
                        </div>
                    </div> <hr class="dont-print">
                    <div id="sutAlimRaporAlani" class="printable-content format-a5">
                        <h1 class="print-only print-title">SÃ¼t Takip ProgramÄ± - AylÄ±k SÃ¼t AlÄ±m Detay Raporu</h1>
                        <h4 id="sutRaporuBaslik" style="text-align:center;">LÃ¼tfen Rapor Kriterlerini SeÃ§in</h4>
                        <div id="sutRaporuDetayAlani"></div>
                    </div>
                    <button type="button" class="btn btn-secondary dont-print" id="sutRaporuYazdirBtn" style="margin-top:20px;">Raporu YazdÄ±r</button>
                 </div>
            </div>
        </section>
        <section id="aylik-yem-raporu" class="module-section">
             <div class="module-header"><h2>ğŸ“ˆ AylÄ±k Yem Raporu</h2></div>
             <div class="container">
                 <div class="report-section">
                    <h3>AylÄ±k Yem SatÄ±ÅŸ KÃ¢rlÄ±lÄ±k Raporu</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: 1fr auto; align-items: end;">
                        <div class="form-group">
                            <label for="yemRaporuAySecimi">Ay SeÃ§in:</label>
                            <input type="month" id="yemRaporuAySecimi">
                        </div>
                        <button type="button" class="btn btn-primary" id="yemRaporuOlusturBtn" style="height:45px;">Raporu GÃ¶ster</button>
                    </div>
                    <hr class="dont-print">
                    <div id="yemRaporuAlani" class="printable-content format-a4">
                    </div>
                    <button type="button" class="btn btn-secondary dont-print" id="yemRaporuYazdirBtn" style="margin-top:20px;">Raporu YazdÄ±r</button>
                 </div>
             </div>
        </section>
        <section id="ayarlar" class="module-section hidden-section">
             <div class="module-header"><h2>âš™ï¸ Ayarlar</h2></div>
             <div class="container">
                <div class="ayarlar-ust-bolum">
                    <div class="settings-section">
                        <h3>Genel Ayarlar</h3>
                        <form id="ayarlarForm">
                            <div class="form-group">
                                <label for="varsayilanSutFiyati">VarsayÄ±lan SÃ¼t FiyatÄ± (TL/Lt):</label>
                                <input type="number" id="varsayilanSutFiyati" step="0.01">
                            </div>
                            <button type="submit" class="btn btn-primary">Kaydet</button>
                        </form>
                    </div>
                    <div class="settings-section">
                        <h3>Åifre DeÄŸiÅŸtir</h3>
                        <form id="sifreDegistirForm">
                            <div class="form-group"><label for="eskiSifre">Eski Åifre:</label><input type="password" id="eskiSifre" required></div>
                            <div class="form-group"><label for="yeniSifre">Yeni Åifre:</label><input type="password" id="yeniSifre" required></div>
                            <div class="form-group"><label for="yeniSifreTekrar">Yeni Åifre (Tekrar):</label><input type="password" id="yeniSifreTekrar" required></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">GÃ¼ncelle</button>
                        </form>
                    </div>
                </div>
                <hr>
                <div class="settings-section"><h3>Cari Kategori/KÃ¶y TanÄ±mlarÄ±</h3><form id="cariKategoriForm" action="#"><div class="form-grid" style="grid-template-columns: 1fr auto; align-items:end;"><div class="form-group" style="margin-bottom:0;"><label for="yeniCariKategoriAdi">Yeni Ad:</label><input type="text" id="yeniCariKategoriAdi" required></div><button type="submit" class="btn" style="height:45px;">Ekle</button></div></form><div class="list-section" style="margin-top:20px;"><h4>TanÄ±mlÄ± Kategoriler/KÃ¶yler</h4><ul id="cariKategoriListesiUl"></ul></div></div>
                <hr class="dont-calisan">
                <div class="settings-section dont-calisan"><h3>KullanÄ±cÄ± YÃ¶netimi</h3><form id="kullaniciForm"><input type="hidden" id="kullaniciEditId"><div class="form-grid">
                    <div class="form-group"><label for="kullaniciAdi">KullanÄ±cÄ± E-posta:</label><input type="email" id="kullaniciAdi" required></div>
                    <div class="form-group"><label for="kullaniciSifre">Åifre:</label><input type="password" id="kullaniciSifre" required></div>
                </div><button type="submit" class="btn" id="kullaniciKaydetBtn">Ã‡alÄ±ÅŸan Ekle</button></form>
                <div class="list-section"><h4>KullanÄ±cÄ± Listesi</h4><table><thead><tr><th>KullanÄ±cÄ± AdÄ±</th><th>Rol</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="kullaniciListesiBody"></tbody></table></div></div>
             </div>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
const firebaseConfig = {
  apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
  authDomain: "sut-takip-projem.firebaseapp.com",
  projectId: "sut-takip-projem",
  storageBucket: "sut-takip-projem.firebasestorage.app",
  messagingSenderId: "512756958486",
  appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
  measurementId: "G-LYLT9WFVNK"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUserRole = '';
let currentUserId = '';
let globalSettings = { defaultMilkPrice: 15.00 };
let editingCariId = null, editingYemTanimId = null, editingYemAlisId = null, editingYemSatisId = null, editingOdemeId = null;

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('Service Worker registered.'))
            .catch(err => console.error('Service Worker registration failed: ', err));
    });
}
auth.onAuthStateChanged(async (user) => {
    if (user) {
        console.log("TEST BAÅLADI: KullanÄ±cÄ± giriÅŸi algÄ±landÄ±. UID:", user.uid);
        console.log("TEST ADIMI: Firestore'dan kullanÄ±cÄ± belgesi okunacak...");

        try {
            const userDoc = await db.collection('kullanicilar').doc(user.uid).get();

            if (userDoc.exists) {
                // EÄER BU MESAJI GÃ–RÃœRSENÄ°Z, OKUMA Ä°ÅLEMÄ° BAÅARILI DEMEKTÄ°R.
                console.log("%c----------- TEST BAÅARILI! -----------", "color: green; font-size: 16px;");
                console.log("TEST SONUCU: Belge bulundu! Ä°Ã§erik:", userDoc.data());
                alert("TEST BAÅARILI! VeritabanÄ± okumasÄ± Ã§alÄ±ÅŸÄ±yor.");
                
                // Okuma baÅŸarÄ±lÄ± olduÄŸu iÃ§in ÅŸimdi uygulamayÄ± baÅŸlatabiliriz.
                currentUserRole = userDoc.data().rol;
                initializeApp();

            } else {
                // EÄER BU MESAJI GÃ–RÃœRSENÄ°Z, BELGE VERÄ°TABANINDA YOK DEMEKTÄ°R.
                console.error("%c---------- TEST BAÅARISIZ! (Belge Yok) ----------", "color: orange; font-size: 16px;");
                console.error("TEST SONUCU: GiriÅŸ baÅŸarÄ±lÄ± ama Firestore'da bu UID ile bir belge bulunamadÄ±:", user.uid);
                alert("TEST BAÅARISIZ! Firestore veritabanÄ±nda bu kullanÄ±cÄ± iÃ§in bir belge bulunmuyor.");
            }
        } catch (error) {
            // EÄER BU MESAJI GÃ–RÃœRSENÄ°Z, Ä°ZÄ°N VEYA BAÄLANTI HATASI VAR DEMEKTÄ°R.
            console.error("%c---------- KRÄ°TÄ°K HATA! (Ä°zin/BaÄŸlantÄ±) ----------", "color: red; font-size: 16px;");
            console.error("TEST SONUCU: Belgeyi okuma denemesi doÄŸrudan hataya dÃ¼ÅŸtÃ¼. ASIL SORUN BU:", error);
            alert("KRÄ°TÄ°K HATA! VeritabanÄ±ndan okuma iÅŸlemi temel bir nedenle (izin, kota, yanlÄ±ÅŸ proje vb.) baÅŸarÄ±sÄ±z oldu. LÃ¼tfen konsolu kontrol edin.");
        }
    } else {
        window.location.href = 'login.html';
    }
});

// DÃœZELTÄ°LMÄ°Å VERÄ° YÃœKLEME FONKSÄ°YONU
async function loadAndRenderAllData() {
    console.log("Veri yÃ¼kleme fonksiyonlarÄ± kontrollÃ¼ bir ÅŸekilde baÅŸlatÄ±lÄ±yor...");
    // Her fonksiyonu ayrÄ± ayrÄ± ve kontrollÃ¼ bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±yoruz.
    // BÃ¶ylece biri (Ã¶rneÄŸin var olmayan bir koleksiyonu okumaya Ã§alÄ±ÅŸan) hata verse bile diÄŸerleri Ã§alÄ±ÅŸmaya devam edebilir.
    try { await renderCariListesi(); } catch (e) { console.warn("Cari listesi yÃ¼klenemedi (koleksiyon henÃ¼z oluÅŸturulmamÄ±ÅŸ veya index eksik olabilir)."); }
    try { await renderYemStokListesi(); } catch (e) { console.warn("Yem stoku yÃ¼klenemedi (koleksiyon henÃ¼z oluÅŸturulmamÄ±ÅŸ veya index eksik olabilir)."); }
    try { await renderOdemeListesi(); } catch (e) { console.warn("Ã–deme listesi yÃ¼klenemedi (koleksiyon henÃ¼z oluÅŸturulmamÄ±ÅŸ veya index eksik olabilir)."); }
    try { await renderCariKategoriListesi(); } catch (e) { console.warn("Cari kategori listesi yÃ¼klenemedi (koleksiyon henÃ¼z oluÅŸturulmamÄ±ÅŸ veya index eksik olabilir)."); }
    try { await populateCariKategoriFiltre(); } catch (e) { console.warn("Cari kategori filtresi doldurulamadÄ±."); }
    try { await populateCariKategoriSelect(document.getElementById('topluGirisKategori')); } catch (e) { console.warn("Toplu giriÅŸ kategorisi doldurulamadÄ±."); }
    try { await updateDashboardStats(); } catch (e) { console.warn("Panel istatistikleri gÃ¼ncellenemedi."); }
    console.log("Veri yÃ¼kleme denemeleri tamamlandÄ±. ArayÃ¼z ÅŸimdi kullanÄ±labilir olmalÄ±.");
}


function initializeApp() {
    const sidebarNav = document.getElementById('sidebarNav');
    const moduleSections = document.querySelectorAll('.main-content .module-section');
    const bodyElement = document.body;
    const logoutButton = document.getElementById('logoutButton');
    const cariForm = document.getElementById('cariForm'), cariKaydetBtn = document.getElementById('cariKaydetBtn'), cariFormBaslik = document.getElementById('cariFormBaslik'), cariFormTemizleBtn = document.getElementById('cariFormTemizleBtn'), cariSearchInput = document.getElementById('cariSearchInput'), cariKategoriFiltre = document.getElementById('cariKategoriFiltre'), cariListesiYazdirBtn = document.getElementById('cariListesiYazdirBtn');
    const yemTanimForm = document.getElementById('yemTanimForm'), yemTanimKaydetBtn = document.getElementById('yemTanimKaydetBtn'), yemTanimFormBaslik = document.getElementById('yemTanimFormBaslik'), yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
    const yemAlisForm = document.getElementById('yemAlisForm'), yemAlisKaydetBtn = document.getElementById('yemAlisKaydetBtn'), yemAlisFormBaslik = document.getElementById('yemAlisFormBaslik'), yemAlisFormTemizleBtn = document.getElementById('yemAlisFormTemizleBtn');
    const yemSatisForm = document.getElementById('yemSatisForm'), yemSatisKaydetBtn = document.getElementById('yemSatisKaydetBtn'), yemSatisFormBaslik = document.getElementById('yemSatisFormBaslik'), yemSatisFormTemizleBtn = document.getElementById('yemSatisFormTemizleBtn');
    const ayarlarForm = document.getElementById('ayarlarForm');
    const cariKategoriForm = document.getElementById('cariKategoriForm');
    const odemeForm = document.getElementById('odemeForm'), odemeKaydetBtn = document.getElementById('odemeKaydetBtn'), odemeFormBaslik = document.getElementById('odemeFormBaslik'), odemeFormTemizleBtn = document.getElementById('odemeFormTemizleBtn');
    const kullaniciForm = document.getElementById('kullaniciForm');
    const sifreDegistirForm = document.getElementById('sifreDegistirForm');
    const raporOlusturBtn = document.getElementById('raporOlusturBtn');
    const raporYazdirBtn = document.getElementById('raporYazdirBtn');
    const sutRaporuOlusturBtn = document.getElementById('sutRaporuOlusturBtn');
    const sutRaporuTumunuGosterBtn = document.getElementById('sutRaporuTumunuGosterBtn');
    const sutRaporuKategoriGosterBtn = document.getElementById('sutRaporuKategoriGosterBtn');
    const sutRaporuYazdirBtn = document.getElementById('sutRaporuYazdirBtn');
    const yemRaporuOlusturBtn = document.getElementById('yemRaporuOlusturBtn');
    const yemRaporuYazdirBtn = document.getElementById('yemRaporuYazdirBtn');
    const topluGirisTarihInput = document.getElementById('topluGirisTarih');
    const topluGirisKategoriSelect = document.getElementById('topluGirisKategori');

    applyRolePermissions();
    loadAndRenderAllData();
    
    sidebarNav.addEventListener('click', function(event) {
        const link = event.target.closest('a.nav-link');
        if (!link || link.id === 'logoutButton') return;
        event.preventDefault();
        sidebarNav.querySelectorAll('a.nav-link').forEach(lnk => lnk.classList.remove('active'));
        link.classList.add('active');
        const targetId = link.getAttribute('href').substring(1);
        moduleSections.forEach(section => { section.style.display = 'none'; });
        const activeSection = document.getElementById(targetId);
        if(activeSection) activeSection.style.display = 'block';
        
        if (targetId === 'dashboard') { updateDashboardStats(); }
        if (targetId === 'cari-yonetimi') { populateCariKategoriFiltre(); renderCariListesi(); populateCariKategoriSelect(document.getElementById('cariKategori')); }
        if (targetId === 'sut-alimi') { if(topluGirisTarihInput) topluGirisTarihInput.value = getTodayForInput(); populateCariKategoriSelect(topluGirisKategori); renderTopluSutGirisFormu(); renderSutAlimGecmisi(); }
        if (targetId === 'yem-stok-yonetimi') { populateCariSelect(document.getElementById('yemAlisTedarikci')); populateYemSelect(document.getElementById('yemSecimiAlis')); }
        if (targetId === 'yem-satisi') { populateCariSelect(document.getElementById('yemAlanTedarikci')); populateYemSelect(document.getElementById('yemSecimiSatis')); }
        if (targetId === 'tahsilat-ve-odemeler') { populateCariSelect(document.getElementById('odemeYapilanTedarikci')); }
        if (targetId === 'hesap-ozeti'){ populateCariSelect(document.getElementById('raporCariSecimi')); if(!document.getElementById('raporTarihAraligi').value) document.getElementById('raporTarihAraligi').value = getMonthYearForInput(); }
        if (targetId === 'sut-alim-raporu'){ populateCariSelect(document.getElementById('sutRaporuTedarikciSecimi')); populateCariKategoriSelect(document.getElementById('sutRaporuKategoriSecimi'), "TÃ¼mÃ¼"); if(!document.getElementById('sutRaporuAySecimi').value) document.getElementById('sutRaporuAySecimi').value = getMonthYearForInput(); }
        if (targetId === 'aylik-yem-raporu'){ if(!document.getElementById('yemRaporuAySecimi').value) document.getElementById('yemRaporuAySecimi').value = getMonthYearForInput(); }
        if (targetId === 'ayarlar') { populateCariKategoriSelect(document.getElementById('cariKategori')); renderCariKategoriListesi(); getSettings(); renderKullaniciListesi(); }
    });
    
    logoutButton.addEventListener('click', handleLogout);
    cariForm.addEventListener('submit', handleCariKaydet);
    if(cariFormTemizleBtn) cariFormTemizleBtn.addEventListener('click', resetCariForm);
    yemTanimForm.addEventListener('submit', handleYemTanimKaydet);
    if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.addEventListener('click', resetYemTanimForm);
    yemAlisForm.addEventListener('submit', handleYemAlisKaydet);
    if(yemAlisFormTemizleBtn) yemAlisFormTemizleBtn.addEventListener('click', resetYemAlisForm);
    yemSatisForm.addEventListener('submit', handleYemSatisKaydet);
    if(yemSatisFormTemizleBtn) yemSatisFormTemizleBtn.addEventListener('click', resetYemSatisForm);
    odemeForm.addEventListener('submit', handleOdemeKaydet);
    if(odemeFormTemizleBtn) odemeFormTemizleBtn.addEventListener('click', resetOdemeForm);
    ayarlarForm.addEventListener('submit', handleAyarlarKaydet);
    cariKategoriForm.addEventListener('submit', handleCariKategoriEkle);
    if(kullaniciForm) kullaniciForm.addEventListener('submit', handleKullaniciKaydet);
    sifreDegistirForm.addEventListener('submit', handleSifreDegistir);

    cariSearchInput.addEventListener('input', renderCariListesi);
    cariKategoriFiltre.addEventListener('change', renderCariListesi);
    cariListesiYazdirBtn.addEventListener('click', handleCariListeYazdir);
    topluGirisTarihInput.addEventListener('change', () => { renderTopluSutGirisFormu(); renderSutAlimGecmisi(); });
    topluGirisKategoriSelect.addEventListener('change', renderTopluSutGirisFormu);

    raporOlusturBtn.addEventListener('click', handleHesapOzetiRaporuOlustur);
    raporYazdirBtn.addEventListener('click', () => handleYazdir('hesap-ozeti'));
    sutRaporuOlusturBtn.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: false}));
    sutRaporuTumunuGosterBtn.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: true, kategori: false}));
    sutRaporuKategoriGosterBtn.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: true}));
    sutRaporuYazdirBtn.addEventListener('click', () => handleYazdir('sut-alim-raporu'));
    yemRaporuOlusturBtn.addEventListener('click', handleYemKarRaporuOlustur);
    yemRaporuYazdirBtn.addEventListener('click', () => handleYazdir('aylik-yem-raporu'));
}

function generateId() { return db.collection('_').doc().id; }
function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('tr-TR'); }
function getTodayForInput() { return new Date().toISOString().split('T')[0]; }
function getMonthYearForInput() { const d = new Date(); return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;}
function formatCurrency(number) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(number); }
function setEditingMode(formBaslikEl, kaydetBtnEl, temizleBtnEl, editIdVar, formType) { if(!formBaslikEl || !kaydetBtnEl) return; formBaslikEl.textContent = editIdVar ? `${formType} Bilgilerini DÃ¼zenle` : `Yeni ${formType} KaydÄ±`; kaydetBtnEl.textContent = editIdVar ? 'GÃ¼ncelle' : 'Kaydet'; if (temizleBtnEl) temizleBtnEl.style.display = editIdVar ? 'inline-block' : 'none'; }
function applyRolePermissions() {
    const bodyElement = document.body;
    bodyElement.className = `role-${currentUserRole}`;
    const calisanAllowed = ['#dashboard', '#sut-alimi', '#yem-satisi', '#cari-yonetimi'];
    const activeLink = document.querySelector('#sidebarNav a.nav-link.active');
    const activeHref = activeLink ? activeLink.getAttribute('href') : '#dashboard';
    if (currentUserRole === 'calisan' && !calisanAllowed.includes(activeHref)) {
        document.querySelector('#sidebarNav a.nav-link[href="#dashboard"]').click();
    }
}


        async function renderTopluSutGirisFormu() {
    const tarih = document.getElementById('topluGirisTarih').value;
    const kategori = document.getElementById('topluGirisKategori').value;
    const container = document.getElementById('topluSutGirisTablosuAlani');
    const yokMesaji = document.getElementById('topluGirisTedarikciYokMesaji');

    if (!tarih) {
        container.innerHTML = '<p style="text-align:center;">LÃ¼tfen bir tarih seÃ§in.</p>';
        yokMesaji.style.display = 'none';
        return;
    }

    let query = db.collection('cariler').where('sahipId', '==', currentUserId).where('durum', '==', 'aktif');
    if (kategori) {
        query = query.where('kategori', '==', kategori);
    }

    try {
        const snapshot = await query.orderBy('adiSoyadi').get();

        if (snapshot.empty) {
            container.innerHTML = '';
            yokMesaji.style.display = 'block';
            return;
        }

        yokMesaji.style.display = 'none';

        let tableHTML = `
            <table>
                <thead>
                    <tr>
                        <th>AdÄ± SoyadÄ±</th>
                        <th>Sabah (Lt)</th>
                        <th>AkÅŸam (Lt)</th>
                        <th>Fiyat (TL)</th>
                        <th class="dont-print">Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody>
        `;

        const defaultFiyat = (globalSettings.defaultMilkPrice || 15.00).toFixed(2);
        snapshot.forEach(doc => {
            const cari = { id: doc.id, ...doc.data() };
            // String iÃ§indeki tÄ±rnak iÅŸaretlerinin sorun Ã§Ä±karmamasÄ± iÃ§in kaÃ§Ä±ÅŸ karakteri kullanÄ±ldÄ±
            const escapedCariAdi = cari.adiSoyadi.replace(/'/g, "\\'").replace(/"/g, '\\"');
            
            tableHTML += `
                <tr>
                    <td>${cari.adiSoyadi}</td>
                    <td><input type="number" id="sabah-${cari.id}" class="sut-input" step="0.1" min="0"></td>
                    <td><input type="number" id="aksam-${cari.id}" class="sut-input" step="0.1" min="0"></td>
                    <td><input type="number" id="fiyat-${cari.id}" class="sut-input" step="0.01" min="0" value="${defaultFiyat}"></td>
                    <td class="dont-print">
                        <button id="kaydet-btn-${cari.id}" class="btn btn-primary btn-sm" onclick="handleTopluSutKaydet('${cari.id}', '${escapedCariAdi}', '${tarih}')">Kaydet</button>
                    </td>
                </tr>
            `;
        });

        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;

    } catch (error) {
        console.error("SÃ¼t giriÅŸi iÃ§in cariler getirilirken hata:", error);
        if (error.code === 'failed-precondition') {
             container.innerHTML = '<p style="text-align:center; color: red;"><b>VeritabanÄ± HatasÄ±:</b> Bu sorgu iÃ§in bir dizin (index) oluÅŸturmanÄ±z gerekiyor.<br>LÃ¼tfen tarayÄ±cÄ± konsolundaki (F12) hatayÄ± kontrol edin ve index oluÅŸturma linkine tÄ±klayÄ±n.</p>';
        } else {
             container.innerHTML = '<p style="text-align:center; color: red;">TedarikÃ§iler yÃ¼klenirken bir hata oluÅŸtu.</p>';
        }
    }
}
async function handleTopluSutKaydet(cariId, cariAdi, tarih) {
    const sabahInput = document.getElementById(`sabah-${cariId}`);
    const aksamInput = document.getElementById(`aksam-${cariId}`);
    const fiyatInput = document.getElementById(`fiyat-${cariId}`);
    const kaydetBtn = document.getElementById(`kaydet-btn-${cariId}`);

    const sabahMiktar = parseFloat(sabahInput.value) || 0;
    const aksamMiktar = parseFloat(aksamInput.value) || 0;
    const birimFiyat = parseFloat(fiyatInput.value) || globalSettings.defaultMilkPrice || 0;
    const toplamMiktar = sabahMiktar + aksamMiktar;

    if (toplamMiktar <= 0) {
        alert("LÃ¼tfen en az bir sÃ¼t miktarÄ± girin.");
        return;
    }

    const sutAlimData = {
        tarih: tarih,
        cariId: cariId,
        cariAdi: cariAdi,
        sabah: sabahMiktar,
        aksam: aksamMiktar,
        toplam: toplamMiktar,
        fiyat: birimFiyat,
        toplamTutar: toplamMiktar * birimFiyat,
        sahipId: currentUserId
    };

    try {
        await db.collection("sut_alimlari").add(sutAlimData);
        alert(`${cariAdi} iÃ§in sÃ¼t alÄ±mÄ± kaydedildi.`);
        sabahInput.disabled = true;
        aksamInput.disabled = true;
        fiyatInput.disabled = true;
        kaydetBtn.disabled = true;
        kaydetBtn.textContent = "Kaydedildi";
        
        if (typeof renderSutAlimGecmisi === 'function') {
            renderSutAlimGecmisi();
        }
    } catch (error) {
        console.error("SÃ¼t alÄ±mÄ± kaydedilirken hata:", error);
        alert("SÃ¼t alÄ±mÄ± kaydedilirken bir hata oluÅŸtu.");
    }
}

async function handleYemKarRaporuOlustur() {
    const ayYil = document.getElementById('yemRaporuAySecimi').value;
    const raporAlani = document.getElementById('yemRaporuAlani');

    if (!ayYil) {
        alert("LÃ¼tfen bir ay seÃ§in.");
        raporAlani.innerHTML = '';
        return;
    }

    const [year, month] = ayYil.split('-');
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    const startDateStr = startDate.toISOString().split('T')[0];
    const endDateStr = endDate.toISOString().split('T')[0];

    raporAlani.innerHTML = '<p>Rapor oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';

    try {
        // 1. AdÄ±m: SeÃ§ilen aydaki tÃ¼m yem satÄ±ÅŸlarÄ±nÄ± Ã§ek
        const satisSnapshot = await db.collection('yem_satislari')
            .where('sahipId', '==', currentUserId)
            .where('tarih', '>=', startDateStr)
            .where('tarih', '<=', endDateStr)
            .get();

        if (satisSnapshot.empty) {
            raporAlani.innerHTML = '<h4>Bu ay iÃ§in yem satÄ±ÅŸÄ± bulunmuyor.</h4>';
            return;
        }

        // 2. AdÄ±m: Yemlerin maliyet fiyatlarÄ±nÄ± ve isimlerini almak iÃ§in tÃ¼m yem tanÄ±mlarÄ±nÄ± Ã§ek
        const yemlerSnapshot = await db.collection('yemler').where('sahipId', '==', currentUserId).get();
        const yemlerMap = new Map();
        yemlerSnapshot.forEach(doc => {
            yemlerMap.set(doc.id, doc.data());
        });

        // 3. AdÄ±m: SatÄ±ÅŸ verilerini iÅŸle ve kÃ¢rÄ± hesapla
        const raporVerisi = {};

        satisSnapshot.forEach(doc => {
            const satis = doc.data();
            const yemDetay = yemlerMap.get(satis.yemId);
            const yemAdi = yemDetay ? yemDetay.ad : 'Bilinmeyen Yem';
            // EÄŸer yemin alÄ±ÅŸ fiyatÄ± tanÄ±mlÄ± deÄŸilse maliyeti 0 kabul et
            const maliyet = yemDetay ? (yemDetay.alisFiyati || 0) : 0;

            if (!raporVerisi[satis.yemId]) {
                raporVerisi[satis.yemId] = {
                    ad: yemAdi,
                    toplamMiktar: 0,
                    toplamSatisTutar: 0,
                    toplamMaliyet: 0,
                    toplamKar: 0
                };
            }

            const satisKar = (satis.satisFiyati - maliyet) * satis.miktar;
            raporVerisi[satis.yemId].toplamMiktar += satis.miktar;
            raporVerisi[satis.yemId].toplamSatisTutar += satis.toplamTutar;
            raporVerisi[satis.yemId].toplamMaliyet += maliyet * satis.miktar;
            raporVerisi[satis.yemId].toplamKar += satisKar;
        });

        // 4. AdÄ±m: HTML tablosunu oluÅŸtur
        let genelToplamSatis = 0;
        let genelToplamMaliyet = 0;
        let genelToplamKar = 0;

        let tableHTML = `
            <h3 class="print-only print-title">AylÄ±k Yem SatÄ±ÅŸ KÃ¢rlÄ±lÄ±k Raporu - ${month}/${year}</h3>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Yem AdÄ±</th>
                        <th>SatÄ±lan Miktar (Birim)</th>
                        <th>Toplam SatÄ±ÅŸ TutarÄ±</th>
                        <th>Toplam Maliyet</th>
                        <th>Toplam KÃ¢r</th>
                    </tr>
                </thead>
                <tbody>
        `;

        for (const yemId in raporVerisi) {
            const veri = raporVerisi[yemId];
            genelToplamSatis += veri.toplamSatisTutar;
            genelToplamMaliyet += veri.toplamMaliyet;
            genelToplamKar += veri.toplamKar;
            tableHTML += `
                <tr>
                    <td>${veri.ad}</td>
                    <td>${veri.toplamMiktar}</td>
                    <td>${formatCurrency(veri.toplamSatisTutar)}</td>
                    <td>${formatCurrency(veri.toplamMaliyet)}</td>
                    <td>${formatCurrency(veri.toplamKar)}</td>
                </tr>
            `;
        }

        tableHTML += `
                </tbody>
                <tfoot>
                    <tr>
                        <td><strong>GENEL TOPLAM</strong></td>
                        <td></td>
                        <td><strong>${formatCurrency(genelToplamSatis)}</strong></td>
                        <td><strong>${formatCurrency(genelToplamMaliyet)}</strong></td>
                        <td><strong>${formatCurrency(genelToplamKar)}</strong></td>
                    </tr>
                </tfoot>
            </table>
        `;

        raporAlani.innerHTML = tableHTML;

    } catch (error) {
        console.error("Yem kÃ¢rlÄ±lÄ±k raporu oluÅŸturulurken hata:", error);
        raporAlani.innerHTML = `<p style="color:red;">Rapor oluÅŸturulurken bir hata oluÅŸtu. Bu sorgu iÃ§in bir Firestore dizini (index) oluÅŸturmanÄ±z gerekebilir.</p>`;
    }
}

        

async function handleHesapOzetiRaporuOlustur() {
    const cariId = document.getElementById('raporCariSecimi').value;
    const ayYil = document.getElementById('raporTarihAraligi').value;
    const raporBaslik = document.getElementById('raporBaslik');
    const raporDetayAlani = document.getElementById('raporDetayAlani');

    if (!cariId || !ayYil) {
        alert("LÃ¼tfen cari ve ay seÃ§imi yapÄ±n.");
        raporDetayAlani.innerHTML = '';
        raporBaslik.textContent = 'LÃ¼tfen Rapor Kriterlerini SeÃ§in';
        return;
    }

    const cariAdi = document.getElementById('raporCariSecimi').options[document.getElementById('raporCariSecimi').selectedIndex].text;
    const [year, month] = ayYil.split('-');
    const startDate = new Date(year, month - 1, 1);
    const endDate = new Date(year, month, 0);
    const oncekiAyEndDate = new Date(year, month - 1, 0);

    raporBaslik.textContent = `${cariAdi} - ${month}/${year} Hesap Ã–zeti`;
    raporDetayAlani.innerHTML = '<p>Rapor oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';

    try {
        // 1. AdÄ±m: Ã–nceki aydan devreden bakiyeyi hesapla
        let devredenBakiye = 0;
        const koleksiyonlar = ['sut_alimlari', 'yem_satislari', 'odemeVeTahsilatlar'];
        const devirTarihiStr = oncekiAyEndDate.toISOString().split('T')[0];

        for (const koleksiyon of koleksiyonlar) {
            const snapshot = await db.collection(koleksiyon)
                .where('sahipId', '==', currentUserId)
                .where('cariId', '==', cariId)
                .where('tarih', '<=', devirTarihiStr)
                .get();

            snapshot.forEach(doc => {
                const data = doc.data();
                if (koleksiyon === 'sut_alimlari') devredenBakiye += data.toplamTutar; // Cari alacaklanÄ±r
                else if (koleksiyon === 'yem_satislari') devredenBakiye -= data.toplamTutar; // Cari borÃ§lanÄ±r
                else if (koleksiyon === 'odemeVeTahsilatlar') {
                    if (data.islemTuru === 'tahsilat') devredenBakiye += data.tutar; // Cari alacaklanÄ±r
                    else devredenBakiye -= data.tutar; // Cari borÃ§lanÄ±r (ona Ã¶deme yapÄ±lmÄ±ÅŸ)
                }
            });
        }

        // 2. AdÄ±m: SeÃ§ili aydaki tÃ¼m hareketleri Ã§ek
        let hareketler = [];
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];

        // SÃ¼t AlÄ±mlarÄ± (Alacak)
        const sutSnapshot = await db.collection('sut_alimlari').where('sahipId', '==', currentUserId).where('cariId', '==', cariId).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get();
        sutSnapshot.forEach(doc => {
            const data = doc.data();
            hareketler.push({ tarih: data.tarih, aciklama: `SÃ¼t AlÄ±mÄ± (${data.toplam.toFixed(2)} Lt)`, borc: 0, alacak: data.toplamTutar });
        });

        // Yem SatÄ±ÅŸlarÄ± (BorÃ§)
        const yemSnapshot = await db.collection('yem_satislari').where('sahipId', '==', currentUserId).where('cariId', '==', cariId).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get();
        yemSnapshot.forEach(doc => {
            const data = doc.data();
            hareketler.push({ tarih: data.tarih, aciklama: 'Yem SatÄ±ÅŸÄ±', borc: data.toplamTutar, alacak: 0 });
        });

        // Ã–deme ve Tahsilatlar
        const odemeSnapshot = await db.collection('odemeVeTahsilatlar').where('sahipId', '==', currentUserId).where('cariId', '==', cariId).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get();
        odemeSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.islemTuru === 'tahsilat') {
                hareketler.push({ tarih: data.tarih, aciklama: data.aciklama || 'Tahsilat', borc: 0, alacak: data.tutar });
            } else {
                hareketler.push({ tarih: data.tarih, aciklama: data.aciklama || 'Ã–deme', borc: data.tutar, alacak: 0 });
            }
        });

        // 3. AdÄ±m: TÃ¼m hareketleri tarihe gÃ¶re sÄ±rala
        hareketler.sort((a, b) => new Date(a.tarih) - new Date(b.tarih));

        // 4. AdÄ±m: HTML tablosunu oluÅŸtur
        let bakiye = devredenBakiye;
        let ayIciBorc = 0;
        let ayIciAlacak = 0;

        let tableHTML = `
            <table class="report-table">
                <thead>
                    <tr><th>Tarih</th><th>AÃ§Ä±klama</th><th>BorÃ§</th><th>Alacak</th><th>Bakiye</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="4"><strong>Ã–nceki Aydan Devir</strong></td>
                        <td><strong>${formatCurrency(devredenBakiye)}</strong></td>
                    </tr>
        `;

        hareketler.forEach(h => {
            bakiye = bakiye - h.borc + h.alacak;
            ayIciBorc += h.borc;
            ayIciAlacak += h.alacak;
            tableHTML += `
                <tr>
                    <td>${formatDate(h.tarih)}</td>
                    <td>${h.aciklama}</td>
                    <td>${h.borc > 0 ? formatCurrency(h.borc) : ''}</td>
                    <td>${h.alacak > 0 ? formatCurrency(h.alacak) : ''}</td>
                    <td>${formatCurrency(bakiye)}</td>
                </tr>
            `;
        });

        tableHTML += `
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2"><strong>Ay Ä°Ã§i ToplamlarÄ±</strong></td>
                        <td><strong>${formatCurrency(ayIciBorc)}</strong></td>
                        <td><strong>${formatCurrency(ayIciAlacak)}</strong></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="4"><strong>AY SONU GENEL BAKÄ°YE</strong></td>
                        <td><strong>${formatCurrency(bakiye)}</strong></td>
                    </tr>
                </tfoot>
            </table>
        `;

        raporDetayAlani.innerHTML = tableHTML;

    } catch (error) {
        console.error("Hesap Ã¶zeti raporu oluÅŸturulurken hata:", error);
        raporDetayAlani.innerHTML = `<p style="color:red;">Rapor oluÅŸturulurken bir hata oluÅŸtu. Bu sorgu iÃ§in bir Firestore dizini (index) oluÅŸturmanÄ±z gerekebilir. LÃ¼tfen tarayÄ±cÄ± konsolunu (F12) kontrol edin.</p>`;
    }
}
        
async function handleYemAlisKaydet(event) {
    event.preventDefault();
    const yemAlisForm = document.getElementById('yemAlisForm');
    const miktar = parseInt(document.getElementById('yemAlisMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('yemAlisBirimFiyati').value);
    const yemId = document.getElementById('yemSecimiAlis').value;
    const editId = document.getElementById('yemAlisEditId').value;

    if (!yemId || isNaN(miktar) || miktar <= 0 || isNaN(birimFiyat)) {
        alert("LÃ¼tfen yem, miktar ve fiyat alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doldurun.");
        return;
    }

    const formData = {
        tarih: document.getElementById('yemAlisTarih').value,
        yemId: yemId,
        miktar: miktar,
        cariId: document.getElementById('yemAlisTedarikci').value || '',
        alisFiyati: birimFiyat,
        toplamTutar: miktar * birimFiyat,
        sahipId: currentUserId
    };

    // Bu fonksiyon dÃ¼zenleme modunu henÃ¼z desteklemediÄŸi iÃ§in sadece yeni kayÄ±t ekliyoruz.
    // EÄŸer dÃ¼zenleme eklenirse, eski stoÄŸu geri alÄ±p yeni stoÄŸu eklemek gibi bir mantÄ±k gerekir.
    if (editId) {
        alert("Yem alÄ±ÅŸÄ± dÃ¼zenleme Ã¶zelliÄŸi henÃ¼z aktif deÄŸil.");
        return;
    }

    try {
        const batch = db.batch();

        // 1. Yem alÄ±m hareketini 'yem_alimlari' koleksiyonuna kaydet
        const yemAlimRef = db.collection('yem_alimlari').doc();
        batch.set(yemAlimRef, formData);

        // 2. Ä°lgili yemin stoÄŸunu 'yemler' koleksiyonunda artÄ±r
        const yemRef = db.collection('yemler').doc(yemId);
        batch.update(yemRef, {
            stokMiktari: firebase.firestore.FieldValue.increment(miktar)
        });

        // Ä°ki iÅŸlemi aynÄ± anda gerÃ§ekleÅŸtir
        await batch.commit();

        yemAlisForm.reset();
        
        // Ä°lgili listeleri yenile
        if (typeof renderYemStokListesi === 'function') await renderYemStokListesi();
        // HenÃ¼z olmayan ama olmasÄ± gereken yem alÄ±ÅŸ hareketleri listesini yenileme fonksiyonu
        if (typeof renderYemAlisHareketleri === 'function') await renderYemAlisHareketleri(); 
        
    } catch (error) {
        console.error("Yem alÄ±ÅŸÄ± kaydedilirken hata:", error);
        alert("Yem alÄ±ÅŸÄ± kaydedilirken bir hata oluÅŸtu. Stok bilgisi gÃ¼ncellenememiÅŸ olabilir.");
    }
}
function resetOdemeForm() {
    const odemeForm = document.getElementById('odemeForm');
    const odemeFormBaslik = document.getElementById('odemeFormBaslik');
    const odemeKaydetBtn = document.getElementById('odemeKaydetBtn');
    const odemeFormTemizleBtn = document.getElementById('odemeFormTemizleBtn');

    odemeForm.reset();
    editingOdemeId = null;
    document.getElementById('odemeEditId').value = '';

    // Formu "Yeni KayÄ±t" moduna geri dÃ¶ndÃ¼r
    setEditingMode(odemeFormBaslik, odemeKaydetBtn, odemeFormTemizleBtn, null, 'Yeni Hareket GiriÅŸi');
}
async function handleOdemeKaydet(event) {
    event.preventDefault();
    const odemeForm = document.getElementById('odemeForm');
    const tutar = parseFloat(document.getElementById('odemeTutari').value);
    const cariId = document.getElementById('odemeYapilanTedarikci').value;
    const islemTuru = document.getElementById('islemTuru').value;
    const editId = document.getElementById('odemeEditId').value;

    if (!cariId || isNaN(tutar) || tutar <= 0) {
        alert("LÃ¼tfen cari ve tutar alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doldurun.");
        return;
    }

    const formData = {
        tarih: document.getElementById('odemeTarih').value,
        cariId: cariId,
        islemTuru: islemTuru,
        tutar: tutar,
        aciklama: document.getElementById('odemeAciklama').value.trim(),
        sahipId: currentUserId
    };

    try {
        if (editId) {
            // DÃ¼zenleme mantÄ±ÄŸÄ±
            await db.collection('odemeVeTahsilatlar').doc(editId).set(formData, { merge: true });
        } else {
            // Yeni kayÄ±t mantÄ±ÄŸÄ±
            await db.collection('odemeVeTahsilatlar').add(formData);
        }

        // Formu temizle ve listeyi yenile
        if (typeof resetOdemeForm === 'function') {
            resetOdemeForm();
        } else {
            odemeForm.reset();
        }

        if (typeof renderOdemeListesi === 'function') {
            await renderOdemeListesi();
        }

        alert("Ä°ÅŸlem baÅŸarÄ±yla kaydedildi.");

    } catch (error) {
        console.error("Ã–deme/Tahsilat kaydedilirken hata:", error);
        alert("Ä°ÅŸlem kaydedilirken bir hata oluÅŸtu.");
    }
}
        
function handleLogout() { auth.signOut().then(() => { window.location.href = 'login.html'; }).catch(error => console.error("Logout error", error)); }
async function getSettings() {
    const varsayilanSutFiyatiInput = document.getElementById('varsayilanSutFiyati');
    const settingsRef = db.collection('ayarlar').doc(currentUserId);
    try {
        const doc = await settingsRef.get();
        if (doc.exists) {
            globalSettings = doc.data();
        }
        varsayilanSutFiyatiInput.value = (globalSettings.defaultMilkPrice || 15.00).toFixed(2);
    } catch(e) { console.error("Ayarlar alÄ±nÄ±rken hata: ", e); }
}
async function updateDashboardStats() {
    const totalCari = document.getElementById('totalCari');
    const totalYemCesidi = document.getElementById('totalYemCesidi');
    const todaySutAlim = document.getElementById('todaySutAlim');
    const todayStr = getTodayForInput();
    try {
        const [carilerSnapshot, yemlerSnapshot, sutAlimSnapshot] = await Promise.all([
            db.collection('cariler').where("sahipId", "==", currentUserId).get(),
            db.collection('yemler').where("sahipId", "==", currentUserId).get(),
            db.collection('sut_alimlari').where("sahipId", "==", currentUserId).where("tarih", "==", todayStr).get()
        ]);
        totalCari.textContent = carilerSnapshot.size;
        totalYemCesidi.textContent = yemlerSnapshot.size;
        todaySutAlim.textContent = sutAlimSnapshot.size;
    } catch(e) { console.error("Dashboard istatistikleri alÄ±nÄ±rken hata", e); }
}

async function handleYemTanimKaydet(event) {
    event.preventDefault();
    const formData = {
        kod: document.getElementById('yemKodu').value,
        ad: document.getElementById('yemAdi').value,
        kategori: document.getElementById('yemKategorisi').value,
        birim: document.getElementById('yemBirimi').value,
        alisFiyati: parseFloat(document.getElementById('yemAlisFiyati').value) || 0,
        satisFiyati: parseFloat(document.getElementById('yemSatisFiyati').value) || 0,
        stokMiktari: 0, // Yeni yem tanÄ±mÄ±nda stok baÅŸlangÄ±Ã§ta 0'dÄ±r.
        sahipId: currentUserId
    };
    try {
        // Bu kÄ±sÄ±mda henÃ¼z bir dÃ¼zenleme (edit) mantÄ±ÄŸÄ± olmadÄ±ÄŸÄ± iÃ§in sadece yeni kayÄ±t ekliyoruz.
        await db.collection('yemler').add(formData);
        document.getElementById('yemTanimForm').reset();
        // Yem stok listesini yeniden yÃ¼klemek iÃ§in ilgili fonksiyonu Ã§aÄŸÄ±rÄ±n (aÅŸaÄŸÄ±da ekledim)
        if(typeof renderYemStokListesi === 'function') {
            await renderYemStokListesi();
        }
    } catch (error) {
        console.error("Yem tanÄ±mÄ± kaydedilirken hata:", error);
        alert("Yem tanÄ±mÄ± kaydedilirken bir hata oluÅŸtu.");
    }
}

        
async function handleCariKaydet(event) {
    event.preventDefault();
    const formData = {
        kodu: document.getElementById('cariKodu').value, adiSoyadi: document.getElementById('cariAdiSoyadi').value,
        kategori: document.getElementById('cariKategori').value, durum: document.getElementById('cariDurum').value,
        telefon: document.getElementById('cariTelefon').value, eposta: document.getElementById('cariEposta').value,
        adres: document.getElementById('cariAdres').value, bankaAdi: document.getElementById('cariBankaAdi').value,
        iban: document.getElementById('cariIban').value, vergiDairesi: document.getElementById('cariVergiDairesi').value,
        vergiNo: document.getElementById('cariVergiNo').value, notlar: document.getElementById('cariNotlar').value,
        sahipId: currentUserId
    };
    try {
        if (editingCariId) {
            await db.collection('cariler').doc(editingCariId).set(formData, { merge: true });
        } else {
            await db.collection('cariler').add(formData);
        }
        resetCariForm();
        await renderCariListesi();
    } catch(error) { console.error("Hata: ", error); alert("Cari kaydedilirken bir hata oluÅŸtu."); }
}
async function renderCariListesi() {
    const cariListesiBody = document.getElementById('cariListesiBody');
    const cariListesiFooter = document.getElementById('cariListesiFooter');
    const cariSearchInput = document.getElementById('cariSearchInput');
    const cariKategoriFiltre = document.getElementById('cariKategoriFiltre');
    const searchTerm = cariSearchInput.value.toLowerCase();
    const kategori = cariKategoriFiltre.value;
    let query = db.collection('cariler').where("sahipId", "==", currentUserId);
    if (kategori) {
        query = query.where("kategori", "==", kategori);
    }
    try {
        const snapshot = await query.orderBy('adiSoyadi').get();
        let cariler = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (searchTerm) {
            cariler = cariler.filter(c => c.kodu?.toLowerCase().includes(searchTerm) || c.adiSoyadi?.toLowerCase().includes(searchTerm));
        }
        cariListesiBody.innerHTML = '';
        cariListesiFooter.innerHTML = '';
        
        if(cariler.length === 0) return;

        const bakiyePromises = cariler.map(c => calculateCariBakiyeDetayli(c.id));
        const bakiyeler = await Promise.all(bakiyePromises);
        
        let toplamAlacak = 0;
        let toplamBorc = 0;

        cariler.forEach((c, index) => {
            const row = cariListesiBody.insertRow();
            const bakiyeDetay = bakiyeler[index];
            if (bakiyeDetay) {
                toplamAlacak += bakiyeDetay.alacak;
                toplamBorc += bakiyeDetay.borc;
                const bakiye = bakiyeDetay.bakiye;
                const durumText = c.durum === 'aktif' ? 'Aktif' : 'Pasif';
                const durumStyle = c.durum === 'aktif' ? 'color:green;' : 'color:red;';
                const bakiyeStyle = bakiye >= 0 ? 'color:green;' : 'color:red;';
                const bakiyeText = `${formatCurrency(bakiye)} ${bakiye >= 0 ? '(AlacaklÄ±)' : '(BorÃ§lu)'}`;
                row.innerHTML = `<td>${c.kodu || ''}</td><td>${c.adiSoyadi || ''}</td><td>${c.kategori || ''}</td><td style="${durumStyle}">${durumText}</td><td>${c.telefon || ''}</td><td style="${bakiyeStyle}">${bakiyeText}</td><td class="dont-print"><button class="btn btn-edit btn-sm" onclick="editCari('${c.id}')">DÃ¼zenle</button><button class="btn btn-delete btn-sm" onclick="deleteCari('${c.id}')">Sil</button></td>`;
            }
        });

        const footerRow = cariListesiFooter.insertRow();
        const toplamBakiye = toplamAlacak - toplamBorc;
        const toplamBakiyeStyle = toplamBakiye >= 0 ? 'color:green;' : 'color:red;';
        const etiket = kategori ? `Kategori ToplamÄ± ('${kategori}')` : 'Genel Toplam';
        footerRow.innerHTML = `<td colspan="5"><strong>${etiket} | Toplam Alacak: ${formatCurrency(toplamAlacak)} | Toplam BorÃ§: ${formatCurrency(toplamBorc)}</strong></td><td style="${toplamBakiyeStyle}"><strong>${formatCurrency(toplamBakiye)}</strong></td><td class="dont-print"></td>`;
    } catch (error) {
        console.error("Cariler listelenirken hata", error);
    }
}
async function editCari(id) { 
    const cariForm = document.getElementById('cariForm');
    const cariFormBaslik = document.getElementById('cariFormBaslik');
    const cariKaydetBtn = document.getElementById('cariKaydetBtn');
    const cariFormTemizleBtn = document.getElementById('cariFormTemizleBtn');
    try {
        const doc = await db.collection('cariler').doc(id).get();
        if (!doc.exists) return;
        const cari = doc.data();
        editingCariId = id; 
        document.getElementById('cariEditId').value = id; 
        document.getElementById('cariKodu').value = cari.kodu || ''; 
        document.getElementById('cariAdiSoyadi').value = cari.adiSoyadi || ''; 
        document.getElementById('cariKategori').value = cari.kategori || ''; 
        document.getElementById('cariDurum').value = cari.durum || 'aktif'; 
        document.getElementById('cariTelefon').value = cari.telefon || ''; 
        document.getElementById('cariEposta').value = cari.eposta || ''; 
        document.getElementById('cariAdres').value = cari.adres || ''; 
        document.getElementById('cariBankaAdi').value = cari.bankaAdi || ''; 
        document.getElementById('cariIban').value = cari.iban || ''; 
        document.getElementById('cariVergiDairesi').value = cari.vergiDairesi || ''; 
        document.getElementById('cariVergiNo').value = cari.vergiNo || ''; 
        document.getElementById('cariNotlar').value = cari.notlar || ''; 
        setEditingMode(cariFormBaslik, cariKaydetBtn, cariFormTemizleBtn, editingCariId, 'Cari Kart');
    } catch (error) {
        console.error("Cari dÃ¼zenleme iÃ§in getirilirken hata:", error);
    }
}
async function deleteCari(id) { 
    if (confirm('Bu cariyi ve ilgili tÃ¼m hareketlerini silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!')) {
        const batch = db.batch();
        batch.delete(db.collection('cariler').doc(id));
        const hareketler = ['sut_alimlari', 'yem_alimlari', 'yem_satislari', 'odemeVeTahsilatlar'];
        try {
            for(const koleksiyon of hareketler) {
                const snapshot = await db.collection(koleksiyon).where('cariId', '==', id).where('sahipId', '==', currentUserId).get();
                snapshot.forEach(doc => batch.delete(doc.ref));
            }
            await batch.commit();
            await renderCariListesi();
        } catch(error) {
            console.error("Cari silinirken hata:", error);
            alert("Ä°liÅŸkili hareketler silinirken bir hata oluÅŸtu.");
        }
    }
}


function resetYemSatisForm() {
    const yemSatisForm = document.getElementById('yemSatisForm');
    const yemSatisFormBaslik = document.getElementById('yemSatisFormBaslik');
    const yemSatisKaydetBtn = document.getElementById('yemSatisKaydetBtn');
    const yemSatisFormTemizleBtn = document.getElementById('yemSatisFormTemizleBtn');

    yemSatisForm.reset();
    editingYemSatisId = null;
    document.getElementById('yemSatisEditId').value = '';

    // Formu "Yeni KayÄ±t" moduna geri dÃ¶ndÃ¼r
    setEditingMode(yemSatisFormBaslik, yemSatisKaydetBtn, yemSatisFormTemizleBtn, null, 'Yeni Yem SatÄ±ÅŸÄ±');
}
        
function resetYemTanimForm() {
    const yemTanimForm = document.getElementById('yemTanimForm');
    const yemTanimFormBaslik = document.getElementById('yemTanimFormBaslik');
    const yemTanimKaydetBtn = document.getElementById('yemTanimKaydetBtn');
    const yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
    
    yemTanimForm.reset();
    editingYemTanimId = null;
    document.getElementById('yemTanimEditId').value = '';
    
    // Formu "Yeni KayÄ±t" moduna geri al
    if(yemTanimFormBaslik) yemTanimFormBaslik.textContent = 'Yeni Yem TanÄ±mla';
    if(yemTanimKaydetBtn) yemTanimKaydetBtn.textContent = 'Kaydet';
    if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.style.display = 'none';
}
async function handleYemSatisKaydet(event) {
    event.preventDefault();
    const yemSatisForm = document.getElementById('yemSatisForm');
    const miktar = parseInt(document.getElementById('yemSatisMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('yemSatisBirimFiyati').value);
    const yemId = document.getElementById('yemSecimiSatis').value;
    const cariId = document.getElementById('yemAlanTedarikci').value;
    const editId = document.getElementById('yemSatisEditId').value;

    if (!yemId || !cariId || isNaN(miktar) || miktar <= 0 || isNaN(birimFiyat)) {
        alert("LÃ¼tfen cari, yem, miktar ve fiyat alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doldurun.");
        return;
    }
    
    // DÃ¼zenleme Ã¶zelliÄŸi henÃ¼z aktif deÄŸil
    if (editId) {
        alert("Yem satÄ±ÅŸÄ± dÃ¼zenleme Ã¶zelliÄŸi henÃ¼z aktif deÄŸil.");
        return;
    }

    const yemRef = db.collection('yemler').doc(yemId);
    const yemSatisRef = db.collection('yem_satislari').doc();

    try {
        // Stok kontrolÃ¼ ve kayÄ±t iÅŸlemini bir transaction iÃ§inde yaparak veri bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ saÄŸlÄ±yoruz.
        await db.runTransaction(async (transaction) => {
            const yemDoc = await transaction.get(yemRef);
            if (!yemDoc.exists) {
                throw "SatÄ±lmak istenen yem veritabanÄ±nda bulunamadÄ±.";
            }

            const anlikStok = yemDoc.data().stokMiktari || 0;
            if (anlikStok < miktar) {
                // Hata fÄ±rlatarak iÅŸlemi durduruyoruz.
                throw `Yetersiz stok! Bu yem iÃ§in anlÄ±k stok: ${anlikStok}`;
            }

            // Stok yeterliyse, satÄ±ÅŸ bilgilerini oluÅŸtur
            const formData = {
                tarih: document.getElementById('yemSatisTarih').value,
                yemId: yemId,
                cariId: cariId,
                miktar: miktar,
                satisFiyati: birimFiyat,
                toplamTutar: miktar * birimFiyat,
                sahipId: currentUserId
            };
            
            // SatÄ±ÅŸ kaydÄ±nÄ± 'yem_satislari' koleksiyonuna ekle
            transaction.set(yemSatisRef, formData);

            // StoÄŸu dÃ¼ÅŸÃ¼r
            transaction.update(yemRef, {
                stokMiktari: firebase.firestore.FieldValue.increment(-miktar)
            });
        });

        yemSatisForm.reset();
        alert("Yem satÄ±ÅŸÄ± baÅŸarÄ±yla kaydedildi.");

        // Ä°lgili listeleri yenile
        if (typeof renderYemStokListesi === 'function') await renderYemStokListesi();
        // HenÃ¼z olmayan ama olmasÄ± gereken yem satÄ±ÅŸ hareketleri listesini yenileme fonksiyonu
        if (typeof renderYemSatisListesi === 'function') await renderYemSatisListesi();

    } catch (error) {
        console.error("Yem satÄ±ÅŸÄ± kaydedilirken hata:", error);
        // KullanÄ±cÄ±ya stok yetersizliÄŸi gibi anlamlÄ± bir hata gÃ¶stermek iÃ§in.
        alert("Yem satÄ±ÅŸÄ± kaydedilemedi: " + error);
    }
}
        function resetYemAlisForm() {
    const yemAlisForm = document.getElementById('yemAlisForm');
    const yemAlisFormBaslik = document.getElementById('yemAlisFormBaslik');
    const yemAlisKaydetBtn = document.getElementById('yemAlisKaydetBtn');
    const yemAlisFormTemizleBtn = document.getElementById('yemAlisFormTemizleBtn');

    yemAlisForm.reset();
    editingYemAlisId = null;
    document.getElementById('yemAlisEditId').value = '';

    // Formu "Yeni KayÄ±t" moduna geri dÃ¶ndÃ¼r
    setEditingMode(yemAlisFormBaslik, yemAlisKaydetBtn, yemAlisFormTemizleBtn, null, 'Yeni Yem AlÄ±ÅŸÄ±');
}
function resetCariForm(){ 
    const cariForm = document.getElementById('cariForm');
    const cariFormBaslik = document.getElementById('cariFormBaslik');
    const cariKaydetBtn = document.getElementById('cariKaydetBtn');
    const cariFormTemizleBtn = document.getElementById('cariFormTemizleBtn');
    cariForm.reset(); 
    editingCariId = null; 
    document.getElementById('cariEditId').value = ''; 
    setEditingMode(cariFormBaslik, cariKaydetBtn, cariFormTemizleBtn, null, 'Cari Kart');
}

async function handleCariKategoriEkle(event) {
  event.preventDefault();
  
  const yeniCariKategoriAdiInput = document.getElementById('yeniCariKategoriAdi');
  const yeniAd = yeniCariKategoriAdiInput.value.trim();

  if (yeniAd === '') {
    alert('Kategori/KÃ¶y adÄ± boÅŸ olamaz.');
    return;
  }

  const currentUser = firebase.auth().currentUser;
  if (!currentUser) {
    alert("LÃ¼tfen giriÅŸ yapÄ±n.");
    return;
  }

  const currentUserId = currentUser.uid;

  try {
    console.log("Yeni eklenecek kategori:", { ad: yeniAd, sahipId: currentUserId });
    
    await db.collection('cari_kategorileri').add({
      ad: yeniAd,
      sahipId: currentUserId
    });

    await Promise.all([
      renderCariKategoriListesi(),
      populateCariKategoriSelect(document.getElementById('cariKategori')),
      populateCariKategoriFiltre(),
      populateCariKategoriSelect(document.getElementById('topluGirisKategori'))
    ]);

    yeniCariKategoriAdiInput.value = '';

  } catch (error) {
    console.error("Kategori eklenirken hata: ", error);
    alert("Kategori eklenemedi. Konsolda hatayÄ± kontrol edin.");
  }
}






        
async function renderCariKategoriListesi() {
    const cariKategoriListesiUl = document.getElementById('cariKategoriListesiUl');
    if (!cariKategoriListesiUl) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", currentUserId).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        cariKategoriListesiUl.innerHTML = ''; 
        if (kategoriler.length === 0) { cariKategoriListesiUl.innerHTML = '<li>TanÄ±mlÄ± kategori/kÃ¶y bulunmuyor.</li>'; return; } 
        kategoriler.forEach(kat => { const li = document.createElement('li'); li.textContent = kat.ad; const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Sil'; deleteBtn.classList.add('btn', 'btn-delete', 'btn-sm', 'dont-print'); deleteBtn.onclick = () => deleteCariKategori(kat.id); li.appendChild(deleteBtn); cariKategoriListesiUl.appendChild(li); });
    } catch(error) { console.error("Kategoriler listelenirken hata:", error); }
}
async function deleteCariKategori(id) { 
    if (confirm('Bu kategoriyi/kÃ¶yÃ¼ silmek istediÄŸinizden emin misiniz?')) { 
        try {
            await db.collection('cari_kategorileri').doc(id).delete(); 
            await Promise.all([renderCariKategoriListesi(), populateCariKategoriSelect(document.getElementById('cariKategori')), populateCariKategoriFiltre(), populateCariKategoriSelect(document.getElementById('topluGirisKategori'))]);
        } catch(error) { console.error("Kategori silinirken hata:", error); }
    }
}
async function populateCariKategoriFiltre() { 
    const selectElement = document.getElementById('cariKategoriFiltre');
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", currentUserId).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value; 
        selectElement.innerHTML = `<option value="">TÃ¼m Kategoriler</option>`; 
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); 
        selectElement.value = currentValue; 
    } catch(error) { console.error("Kategori filtresi yÃ¼klenirken hata:", error); }
}
async function populateCariKategoriSelect(selectElement, defaultOptionText = "SeÃ§iniz...") { 
    if(!selectElement) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", currentUserId).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value; 
        selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`; 
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); 
        if (kategoriler.some(kat => kat.ad === currentValue)) { selectElement.value = currentValue; }
    } catch(error) { console.error("Kategori seÃ§imi yÃ¼klenirken hata:", error); }
}
async function populateCariSelect(selectElement, defaultText = "SeÃ§iniz...") { 
    if(!selectElement) return;
    try {
        const snapshot = await db.collection('cariler').where("sahipId", "==", currentUserId).where("durum", "==", "aktif").orderBy('adiSoyadi').get();
        const cariler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const currentValue = selectElement.value; 
        selectElement.innerHTML = ''; 
        const firstOption = document.createElement('option'); firstOption.value = ""; firstOption.textContent = defaultText; selectElement.appendChild(firstOption); 
        cariler.forEach(c => { const option = document.createElement('option'); option.value = c.id; option.textContent = `${c.adiSoyadi} (${c.kodu || 'Kodsuz'})`; selectElement.appendChild(option); }); 
        if (cariler.some(c => c.id === currentValue)) { selectElement.value = currentValue; }
    } catch(error) { console.error("Cari seÃ§imi yÃ¼klenirken hata:", error); }
}
async function populateYemSelect(selectElement, defaultText = "Yem SeÃ§iniz...") {
    if(!selectElement) return;
    try {
        const snapshot = await db.collection('yemler').where("sahipId", "==", currentUserId).orderBy('ad').get();
        const yemler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const currentValue = selectElement.value;
        selectElement.innerHTML = ''; 
        const firstOption = document.createElement('option'); firstOption.value = ""; firstOption.textContent = defaultText; selectElement.appendChild(firstOption);
        yemler.forEach(y => { const option = document.createElement('option'); option.value = y.id; option.textContent = `${y.ad} (${y.kod}) - Stok: ${y.stokMiktari || 0} ${y.birim}`; selectElement.appendChild(option); });
        if (yemler.some(y => y.id === currentValue)) { selectElement.value = currentValue; }
    } catch (error) {
        console.error("Yem seÃ§imi yÃ¼klenirken hata:", error);
    }
}
async function handleSifreDegistir(event) {
    event.preventDefault();
    const eskiSifre = document.getElementById('eskiSifre').value;
    const yeniSifre = document.getElementById('yeniSifre').value;
    const yeniSifreTekrar = document.getElementById('yeniSifreTekrar').value;

    if(!yeniSifre || yeniSifre.length < 6) { alert("Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r!"); return; }
    if(yeniSifre !== yeniSifreTekrar) { alert("Yeni ÅŸifreler uyuÅŸmuyor!"); return; }

    const user = auth.currentUser;
    const credential = firebase.auth.EmailAuthProvider.credential(user.email, eskiSifre);

    try {
        await user.reauthenticateWithCredential(credential);
        await user.updatePassword(yeniSifre);
        alert("Åifreniz baÅŸarÄ±yla gÃ¼ncellendi!");
        document.getElementById('sifreDegistirForm').reset();
    } catch (error) {
        console.error("Åifre gÃ¼ncelleme hatasÄ±:", error);
        alert("Eski ÅŸifre hatalÄ± veya bir sorun oluÅŸtu.");
    }
}
async function handleKullaniciKaydet(event) {
    event.preventDefault();
    alert("Bu Ã¶zellik gÃ¼venlik nedeniyle doÄŸrudan yeni kullanÄ±cÄ± oluÅŸturmaz. LÃ¼tfen Ã¶nce Firebase Authentication panelinden kullanÄ±cÄ±yÄ± e-posta/ÅŸifre ile oluÅŸturun, ardÄ±ndan bu panelden o kullanÄ±cÄ±ya ait bir profil (rol atamasÄ±) oluÅŸturabilirsiniz.");
}
async function deleteKullanici(id) {
    if(confirm("Bu iÅŸlem sadece kullanÄ±cÄ±nÄ±n profilini veritabanÄ±ndan siler, giriÅŸ yapmasÄ±nÄ± engellemez. KullanÄ±cÄ±yÄ± tamamen silmek iÃ§in Firebase Authentication panelini kullanÄ±n. Devam etmek istiyor musunuz?")) {
        try {
            await db.collection('kullanicilar').doc(id).delete();
            await renderKullaniciListesi();
        } catch (error) {
            console.error("KullanÄ±cÄ± silinirken hata:", error);
        }
    }
}
async function renderKullaniciListesi() {
    const kullaniciListesiBody = document.getElementById('kullaniciListesiBody');
    if(!kullaniciListesiBody) return;
    try {
        const snapshot = await db.collection('kullanicilar').where("sahipId", "==", currentUserId).get();
        kullaniciListesiBody.innerHTML = '';
        snapshot.forEach(doc => {
            const user = doc.data();
            if(user.rol === 'admin') return;
            const row = kullaniciListesiBody.insertRow();
            row.innerHTML = `<td>${user.kullaniciAdi}</td><td>Ã‡alÄ±ÅŸan</td><td class="dont-print"><button class="btn btn-delete btn-sm" onclick="deleteKullanici('${doc.id}')">Sil</button></td>`;
        });
    } catch(error) { console.error("KullanÄ±cÄ±lar listelenirken hata", error); }
}
async function handleAyarlarKaydet(event) {
    event.preventDefault();
    const varsayilanSutFiyatiInput = document.getElementById('varsayilanSutFiyati');
    const yeniFiyat = parseFloat(varsayilanSutFiyatiInput.value);
    if (!isNaN(yeniFiyat) && yeniFiyat >= 0) {
        try {
            await db.collection('ayarlar').doc(currentUserId).set({ defaultMilkPrice: yeniFiyat, sahipId: currentUserId });
            globalSettings.defaultMilkPrice = yeniFiyat;
            alert('Genel ayarlar kaydedildi.');
        } catch (error) {
            console.error("Ayarlar kaydedilirken hata:", error);
            alert("Ayarlar kaydedilemedi.");
        }
    } else {
        alert('LÃ¼tfen geÃ§erli bir sÃ¼t fiyatÄ± giriniz.');
    }
}

async function calculateCariBakiyeDetayli(cariId, endDateStr = null) {
    let alacak = 0;
    let borc = 0;
    try {
        const sutQuery = db.collection('sut_alimlari').where('sahipId', '==', currentUserId).where('cariId', '==', cariId);
        const yemQuery = db.collection('yem_satislari').where('sahipId', '==', currentUserId).where('cariId', '==', cariId);
        const odemeQuery = db.collection('odemeVeTahsilatlar').where('sahipId', '==', currentUserId).where('cariId', '==', cariId);

        const [sutSnapshot, yemSnapshot, odemeSnapshot] = await Promise.all([
            sutQuery.get(),
            yemQuery.get(),
            odemeQuery.get()
        ]);

        sutSnapshot.forEach(doc => alacak += doc.data().toplamTutar);
        yemSnapshot.forEach(doc => borc += doc.data().toplamTutar);
        odemeSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.islemTuru === 'odeme') {
                borc += data.tutar;
            } else {
                alacak += data.tutar;
            }
        });

        return { alacak, borc, bakiye: alacak - borc };
    } catch (error) {
        console.error(`Bakiye hesaplanÄ±rken hata (Cari ID: ${cariId}):`, error);
        return { alacak: 0, borc: 0, bakiye: 0 };
    }
}


function handleCariListeYazdir() {
    const kategoriFiltreElement = document.getElementById('cariKategoriFiltre');
    const seciliKategoriText = kategoriFiltreElement.options[kategoriFiltreElement.selectedIndex].text;
    document.getElementById('cariListeRaporBaslik').textContent = `${seciliKategoriText} Cari Listesi`;
    handleYazdir('cari-yonetimi');
}

function handleYazdir(sectionId) {
    const sectionToPrint = document.getElementById(sectionId);
    if (!sectionToPrint) return;
    
    let reportContent = sectionToPrint.querySelector('.printable-content, #cari-list-printable-area, #yemRaporuAlani');
    if(!reportContent && sectionId === 'cari-yonetimi') {
        reportContent = document.getElementById('cari-list-printable-area');
    }
    
    if (sectionId !== 'cari-yonetimi' && (!reportContent || reportContent.innerText.trim() === '' || reportContent.innerText.includes("LÃ¼tfen Rapor Kriterlerini SeÃ§in"))) {
            alert("LÃ¼tfen Ã¶nce bir rapor oluÅŸturun.");
            return;
    }
    
    const bodyElement = document.body;
    bodyElement.classList.add('print-active');
    sectionToPrint.classList.add('print-section-active');
    
    const pageFormatClass = reportContent.classList.contains('format-a5') ? 'format-a5' : 'format-a4';
    bodyElement.classList.add(pageFormatClass);

    window.print();
}

window.onafterprint = () => {
    const bodyElement = document.body;
    bodyElement.classList.remove('print-active', 'format-a4', 'format-a5');
    document.querySelectorAll('.print-section-active').forEach(el => {
        el.classList.remove('print-section-active');
    });
};
</script>
</body>
</html>
