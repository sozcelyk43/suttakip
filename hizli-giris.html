<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeliÅŸmiÅŸ SÃ¼t GiriÅŸi</title>
<style>
        :root {
        --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
        --danger-color: #dc3545; --warning-color: #ffc107; --light-color: #f8f9fa;
        --dark-color: #343a40; --border-color: #dee2e6; --white-color: #fff;        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: var(--light-color); 
	color: var(--dark-color); }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        header { 
	background-color: var(--primary-color); color: var(--white-color); padding: 15px 20px; text-align: center; 
	border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
	display: flex; justify-content: space-between; align-items: center;}
        header h1 { margin: 0; font-size: 1.5em; }
        main { padding: 20px 0; }
        #logoutButton { position: static; background-color: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9em; 
	font-weight: 600; transition: background-color 0.2s; line-height: 1.3; text-align: right; }
        #logoutButton:hover { background-color: #c0392b; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 1.1em; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; 
	box-sizing: border-box; }
        .time-selection { display: flex; gap: 10px; }
        .time-selection input[type="radio"] { display: none; }
        .time-selection label { flex: 1; text-align: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; 	font-weight: 600; }
        .time-selection input:not(:checked) + label { background-color: #f8f9fa; border: 1px solid #dee2e6; color: #6c757d; }
        .time-selection input:not(:checked) + label:hover { background-color: #e9ecef; border-color: #adb5bd; }
        .time-selection input:checked + label { color: white; font-weight: 700; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border: 2px solid rgba(0,0,0,0.1); }
        .time-selection input[id="aksam"]:checked + label { background-color: #ff8c00; }
        .time-selection input[id="sabah"]:checked + label { background-color: #28a745; }
        #producer-panel, #history-section { background-color: var(--white-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px 	rgba(0,0,0,0.05); margin-top: 25px; }
        #current-producer-name { font-size: 1.5em; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; text-align: center; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .btn { padding: 15px; font-size: 1.1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        #session-summary { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 1.1em; }
        #history-list { list-style: none; padding: 0; margin: 0; }
/* GeÃ§miÅŸ listesi satÄ±r dÃ¼zenini iyileÅŸtiren stil */
.history-item {
    display: flex;
    align-items: center;
    gap: 8px; /* Ã–ÄŸeler arasÄ±na 8px boÅŸluk ekler */
}

/* Ãœretici adÄ±nÄ±n esneyip uzamasÄ±nÄ± saÄŸlar */
.history-item .history-info {
    flex-grow: 1;
    min-width: 0; /* Uzun isimlerin kÃ¼Ã§Ã¼lmesine izin verir */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* SÄ±ÄŸmazsa sonuna ... ekler */
}

/* ButonlarÄ±n kÃ¼Ã§Ã¼lmesini engeller */
.history-item .history-actions {
    flex-shrink: 0;
}


        .history-item:nth-child(odd) { background-color: #f1f1f1; }
        .history-item:nth-child(even) { background-color: #ffffff; }
        .history-info strong { color: var(--primary-color); }
        .btn-icon {background: none; border: none; font-size: 1.3em; margin: 0 4px; cursor: pointer;padding: 4px; border-radius: 6px; transition: background-color 0.2s; vertical-align: 	middle; }
        .btn-icon:hover { background-color: #e2e6ea; }
        .btn-delete { color: var(--danger-color); }
        #cancel-edit-btn { display: none; margin-top: 10px; width: 100%; background-color: var(--danger-color); color: var(--white-color); }
        .toast-message { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 12px 20px; border-radius: 8px; 
	box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 1000; font-size: 1.1em; font-weight: 500; display: none; opacity: 0; transition: opacity 0.5s ease; }
        .toast-message.show { display: block; opacity: 1; }
.history-producer-name {
    flex-shrink: 1; /* Esneyerek kÃ¼Ã§Ã¼lmesine izin ver */
    white-space: nowrap; /* Alt satÄ±ra inmesini engelle */
    overflow: hidden; /* TaÅŸanÄ± gizle */
    text-overflow: ellipsis; /* Gizlenen kÄ±smÄ±n yerine '...' koy */
    display: inline-block; /* DÃ¼zgÃ¼n Ã§alÄ±ÅŸmasÄ± iÃ§in */
    max-width: 150px; /* Ã‡ok uzun isimler iÃ§in bir sÄ±nÄ±r koyalÄ±m */
    vertical-align: middle; /* Dikeyde ortala */
}
.action-buttons {
    position: -webkit-sticky; /* Safari gibi eski tarayÄ±cÄ±lar iÃ§in uyumluluk */
    position: sticky;
    bottom: 0;
    z-index: 10;
    
    /* ButonlarÄ±n arkasÄ±ndaki iÃ§eriÄŸin gÃ¶rÃ¼nmemesi iÃ§in arka plan rengi */
    background-color: var(--light-color); 
    
    /* Butonlar ekrana yapÄ±ÅŸtÄ±ÄŸÄ±nda daha iyi gÃ¶rÃ¼nmesi iÃ§in Ã¼st ve alt boÅŸluk */
    padding-top: 10px;
    padding-bottom: 10px;
    
    /* ÃœstÃ¼ndeki iÃ§erikten ayÄ±rmak iÃ§in ince bir Ã§izgi */
    border-top: 1px solid var(--border-color);
}



</style>
</head>
<body>
    <div id="toast-message" class="toast-message"></div>
    <div class="container">
        <header>
            <h1>GeliÅŸmiÅŸ SÃ¼t GiriÅŸi</h1>
            <button id="logoutButton">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
        </header>
        <main>
            <form id="setup-form" onsubmit="return false;">
                <input type="hidden" id="editingSutAlimId">
                <div class="form-group">
                    <label for="collection-date">SÃ¼t AlÄ±m Tarihi</label>
                    <input type="date" id="collection-date" name="collection-date">
                </div>
                <div class="form-group">
                    <label for="unit-price">SÃ¼t Birim FiyatÄ± (â‚º)</label>
                    <input type="number" id="unit-price" name="unit-price" step="0.01">
                </div>
                <div class="form-group">
                    <label>Zaman</label>
                    <div class="time-selection">
                        <input type="radio" id="aksam" name="time" value="aksam" checked><label for="aksam">AKÅAM</label>
                        <input type="radio" id="sabah" name="time" value="sabah"><label for="sabah">SABAH</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="category">
                        Kategori/KÃ¶y (Rota)
                        <span id="gunlukGenelToplamGosterge" style="float: right; color: var(--primary-color); font-weight: bold;"></span>
                    </label>
                    <select id="category" name="category"></select>
                </div>
            </form>

            <div id="producer-panel" style="display: none;">
                <h2 id="current-producer-name">Ãœretici AdÄ±</h2>
                <div class="form-group">
                    <label for="producer-select">Rota DÄ±ÅŸÄ± SeÃ§im / Ãœretici Atlama</label>
                    <select id="producer-select" name="producer-select"></select>
                </div>
                <div class="form-group">
                    <label for="quantity">Miktar (Litre)</label>
                    <input type="number" id="quantity" name="quantity" step="0.1" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label for="notes">AÃ§Ä±klama</label>
                    <textarea id="notes" name="notes" rows="3"></textarea>
                </div>
                <div class="action-buttons">
                    <button type="button" id="skip-btn" class="btn btn-secondary" onclick="skipCurrentProducer()">Pas GeÃ§</button>
                    <button type="button" id="save-btn" class="btn btn-success">Kaydet ve Sonraki</button>
                    <button type="button" id="cancel-edit-btn" class="btn btn-danger">Ä°ptal</button>
                </div>
            </div>

            <section id="history-section" style="display: none;">
                <h2>SÃ¼t AlÄ±m GeÃ§miÅŸi (Bu Oturum)</h2>
                <div id="session-summary"></div>
                <ul id="history-list"></ul>
            </section>
        </main>
    </div>
	
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
                authDomain: "sut-takip-projem.firebaseapp.com",
                projectId: "sut-takip-projem",
                storageBucket: "sut-takip-projem.appspot.com",
                messagingSenderId: "512756958486",
                appId: "1:512756958486:web:13cceb6835e2c575e9fc37"
            };
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.getElementById('logoutButton').addEventListener('click', () => {
	auth.signOut().then(() => { window.location.href = 'login.html'; }).catch(error => { console.error("Ã‡Ä±kÄ±ÅŸ yaparken hata oluÅŸtu:", error); });});

        let fullHistoryForDate = [];
        let allProducersMap = new Map();
        let sahipId = '';
        let currentUserRole = '';
        let routeProducers = [], collectionHistory = [];
        let currentProducerIndex = 0;
        let editingEntry = null;

        const collectionDateInput = document.getElementById('collection-date');
        const unitPriceInput = document.getElementById('unit-price');
        const categorySelect = document.getElementById('category');
        const producerPanel = document.getElementById('producer-panel');
        const currentProducerName = document.getElementById('current-producer-name');
        const producerSelect = document.getElementById('producer-select');
        const quantityInput = document.getElementById('quantity');
        const notesInput = document.getElementById('notes');
        const saveBtn = document.getElementById('save-btn');
        const skipBtn = document.getElementById('skip-btn');
        const historySection = document.getElementById('history-section');
        const historyList = document.getElementById('history-list');
        const sessionSummary = document.getElementById('session-summary');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editingSutAlimIdInput = document.getElementById('editingSutAlimId');
        const gunlukGenelToplamGosterge = document.getElementById('gunlukGenelToplamGosterge');

auth.onAuthStateChanged(user => {
            if (user) {
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && user.email) {
                    logoutButton.innerHTML = `ğŸšª Ã‡Ä±kÄ±ÅŸ Yap<br><small style="font-weight:normal; font-size:0.8em;">${user.email}</small>`;
                }
                db.collection('kullanicilar').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        sahipId = userData.sahipId || user.uid;
                        currentUserRole = userData.rol;
                        initializeApp();
                    } else {
                        alert("KullanÄ±cÄ± profili bulunamadÄ±.");
                        auth.signOut();
                    }
                });
            } else { window.location.href = 'login.html'; }
        });

async function initializeApp() {
    collectionDateInput.value = new Date().toISOString().split('T')[0];
    const settings = await getSettings();
    unitPriceInput.value = settings.defaultMilkPrice ? settings.defaultMilkPrice.toFixed(2) : "15.50";
    const producersSnapshot = await db.collection('cariler').where('sahipId', '==', sahipId).get();
    producersSnapshot.forEach(doc => allProducersMap.set(doc.id, doc.data()));
    
    await populateCategories();
    await fetchAndRenderHistory(collectionDateInput.value);
    await showDailyGrandTotal();

    collectionDateInput.addEventListener('change', async () => {
        await fetchAndRenderHistory(collectionDateInput.value);
        await showDailyGrandTotal();
        if (categorySelect.value) {
            startRoute(); // EÄŸer bir rota seÃ§iliyse, o rota iÃ§in sÄ±rayÄ± da gÃ¼ncelle
        }
    });


    quantityInput.addEventListener('focus', scrollToActivePanel);
    notesInput.addEventListener('focus', scrollToActivePanel);
    quantityInput.addEventListener('change', checkPreviousDayDifference);
    categorySelect.addEventListener('change', startRoute);
    producerSelect.addEventListener('change', jumpToProducer);
    saveBtn.addEventListener('click', handleSave);
    skipBtn.addEventListener('click', handleSkip);
    cancelEditBtn.addEventListener('click', cancelEditMode);
    const inputsToTriggerRoute = [...document.querySelectorAll('input[name="time"]')];
    inputsToTriggerRoute.forEach(el => {
        el.addEventListener('change', () => { 
            // EÄŸer bir rota zaten seÃ§ilmiÅŸse, rotayÄ± bu yeni zaman dilimi iÃ§in yeniden hesapla.
            if (categorySelect.value) {
                startRoute();
            } else {
                // Rota seÃ§ilmemiÅŸse, sadece geÃ§miÅŸ listesini filtrele.
                filterAndRenderHistory();
            }
        });
    });
} 
       
async function getSettings() {
            if (!sahipId) return {};
            try {
                const doc = await db.collection('ayarlar').doc(sahipId).get();
                return doc.exists ? doc.data() : {};
            } catch (e) { console.error("Ayarlar alÄ±namadÄ±:", e); return {}; }
        }


function filterAndRenderHistory() {
            const selectedCategory = categorySelect.value;
            let historyToRender = fullHistoryForDate;

            if (selectedCategory) {
                historyToRender = fullHistoryForDate.filter(entry => {
                    const producer = allProducersMap.get(entry.cariId);
                    return producer && producer.kategori === selectedCategory;
                });
            }
            
            renderHistory(historyToRender);
        }

function getDayDifference(dateStr) {
            const today = new Date();
            const entryDate = new Date(dateStr);
            today.setHours(0, 0, 0, 0);
            entryDate.setHours(0, 0, 0, 0);
            const diffTime = today - entryDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }


async function handleSaveAndNext() {
            const quantity = parseFloat(String(quantityInput.value).replace(',', '.')) || 0;
            if (isNaN(quantity) || quantity < 0) { alert('LÃ¼tfen geÃ§erli bir miktar girin.'); return; }
            await saveMilkEntry(quantity, notesInput.value);
        }

function handleSkip() {
            const producerName = routeProducers[currentProducerIndex]?.adiSoyadi || 'Bu Ã¼retici';
            const confirmation = confirm(`'${producerName}' iÃ§in iÅŸlem seÃ§in:\n\nâ¡ï¸ SÃœT YOK ise -> 'Tamam'a basÄ±n (0 Lt olarak kaydedilecektir).\n\nâ¡ï¸ ULAÅILAMADIYSA veya baÅŸka bir sebeple atlamak iÃ§in -> 'Ä°ptal'e basÄ±n.`);
            if (confirmation) {
                saveMilkEntry(0, "SÃ¼t yok");
            } else {
                currentProducerIndex++;
                displayCurrentProducer();
            }
        }

function populateCategories() {
            db.collection('cari_kategorileri').where('sahipId', '==', sahipId).orderBy('ad').get()
                .then(snapshot => {
                    categorySelect.innerHTML = '<option value="">Rota SeÃ§iniz...</option>';
                    snapshot.forEach(doc => {
                        categorySelect.innerHTML += `<option value="${doc.data().ad}">${doc.data().ad}</option>`;
                    });
                }).catch(e => {
                    console.error("Kategoriler yÃ¼klenirken hata:", e);
                    categorySelect.innerHTML = '<option value="" disabled selected>Hata: Rotalar yÃ¼klenemedi</option>';
                });
        }

function skipCurrentProducer() {
            if (currentProducerIndex < routeProducers.length) {
                currentProducerIndex++;
                displayCurrentProducer();
            }
        }

// LÃœTFEN MEVCUT startRoute FONKSÄ°YONUNU BU NÄ°HAÄ° VERSÄ°YONLA TAMAMEN DEÄÄ°ÅTÄ°RÄ°N.
async function startRoute() {
    filterAndRenderHistory();
    producerPanel.style.display = 'none';
    const category = categorySelect.value;
    if (!category) return;
    
    try {
        const producersSnapshot = await db.collection('cariler')
            .where('sahipId', '==', sahipId)
            .where('kategori', '==', category)
            .where('durum', '==', 'aktif')
            .where('cariGrup', 'array-contains', 'Ã¼retici')
            .orderBy('rotaSirasi').get();

        const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
        
        // *** KONTROL MANTIÄI DAHA SAÄLAM HALE GETÄ°RÄ°LDÄ° ***
        const savedProducerIds = new Set(
            fullHistoryForDate
                .filter(entry => {
                    // Bir entry'nin o zaman dilimi iÃ§in girilmiÅŸ sayÄ±lmasÄ± iÃ§in,
                    // ilgili alanÄ±n (sabah/aksam) var olmasÄ± VE deÄŸerinin null olmamasÄ± gerekir.
                    // typeof kontrolÃ¼, alanÄ±n hiÃ§ olmamasÄ± (undefined) durumunu da yakalar.
                    return typeof entry[zamanDilimi] !== 'undefined' && entry[zamanDilimi] !== null;
                })
                .map(entry => entry.cariId)
        );

        routeProducers = producersSnapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(p => !savedProducerIds.has(p.id));

        currentProducerIndex = 0;
        populateProducerSelect();
        
        if (routeProducers.length > 0) {
            producerPanel.style.display = 'block';
            displayCurrentProducer();
        } else {
            // Bu mesaj artÄ±k sadece gerÃ§ekten tÃ¼m giriÅŸler yapÄ±ldÄ±ÄŸÄ±nda gÃ¶sterilecek.
            alert("Bu rota iÃ§in bu zaman diliminde tÃ¼m sÃ¼t giriÅŸleri tamamlanmÄ±ÅŸ veya uygun Ã¼retici bulunamadÄ±.");
        }

    } catch (error) { 
        console.error("Rota baÅŸlatÄ±lÄ±rken hata:", error); 
        alert("Rota baÅŸlatÄ±lamadÄ±. LÃ¼tfen konsol kayÄ±tlarÄ±nÄ± kontrol edin."); 
    }
}


// LÃœTFEN BU FONKSÄ°YONU YAZIM HATASI DÃœZELTÄ°LMÄ°Å HALÄ°YLE DEÄÄ°ÅTÄ°RÄ°N
async function saveMilkEntry(quantity, notes) {
    const unitPrice = parseFloat(String(unitPriceInput.value).replace(',', '.')) || 0;
    const alimTarihi = collectionDateInput.value;
    const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
    const currentProducer = routeProducers[currentProducerIndex];

    if (!currentProducer) {
        alert("Hata: Ä°ÅŸlem yapÄ±lacak geÃ§erli bir Ã¼retici bulunamadÄ±.");
        return;
    }
    if (isNaN(unitPrice) || !alimTarihi) {
        alert('LÃ¼tfen Fiyat ve Tarih seÃ§imlerini doÄŸru yapÄ±n.');
        return;
    }
    saveBtn.disabled = true;
    skipBtn.disabled = true;

    try {
        const sutAlimQuery = db.collection('sut_alimlari').where('sahipId', '==', sahipId).where('cariId', '==', currentProducer.id).where('tarih', '==', alimTarihi);
        const existingSutAlimSnapshot = await sutAlimQuery.get();
        const batch = db.batch();

        if (existingSutAlimSnapshot.empty) {
            const sutAlimRef = db.collection('sut_alimlari').doc();
            let newData = {
                tarih: alimTarihi, cariId: currentProducer.id, cariAdi: currentProducer.adiSoyadi,
                fiyat: unitPrice, sahipId: sahipId, aciklama: `HÄ±zlÄ± giriÅŸ ile eklendi. Not: ${notes || ''}`
            };
            newData[zamanDilimi] = quantity;
            newData.toplam = quantity;
            newData.toplamTutar = quantity * unitPrice;
            batch.set(sutAlimRef, newData);
        } else {
            const sutAlimRef = existingSutAlimSnapshot.docs[0].ref;
            const existingData = existingSutAlimSnapshot.docs[0].data() || {};
            const updatePayload = {
                fiyat: unitPrice,
                aciklama: `HÄ±zlÄ± giriÅŸ ile gÃ¼ncellendi. Not: ${notes || ''}`
            };
            updatePayload[zamanDilimi] = quantity;
            // *** YAZIM HATASI DÃœZELTÄ°LDÄ°: "sahah" -> "sabah" ***
            const sabahMiktari = (zamanDilimi === 'sabah') ? quantity : (existingData.sabah || 0);
            const aksamMiktari = (zamanDilimi === 'aksam') ? quantity : (existingData.aksam || 0);
            updatePayload.toplam = sabahMiktari + aksamMiktari;
            updatePayload.toplamTutar = updatePayload.toplam * unitPrice;
            batch.update(sutAlimRef, updatePayload);
        }
        
        await batch.commit();
        await fetchAndRenderHistory(alimTarihi);
        await showDailyGrandTotal();

        const toast = document.getElementById('toast-message');
        toast.textContent = `âœ… ${currentProducer.adiSoyadi} iÃ§in ${quantity} Lt kaydedildi.`;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
        
        advanceToNextProducer();
        
    } catch (error) {
        console.error("KayÄ±t HatasÄ±:", error);
        alert("Veri kaydedilirken bir hata oluÅŸtu: " + error.message);
    } finally {
        saveBtn.disabled = false;
        skipBtn.disabled = false;
    }
}

async function fetchAndRenderHistory(date) {
    if (!date) return;
    
    // --- YENÄ° EKLENEN SATIR: Her yeni Ã§ekimde geÃ§miÅŸ dizisini tamamen sÄ±fÄ±rla ---
    fullHistoryForDate = []; 
    
    historySection.style.display = 'none';
    historyList.innerHTML = '';

    try {
        const existingEntriesSnapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('tarih', '==', date)
            .get();
            
        fullHistoryForDate = existingEntriesSnapshot.docs.map(doc => {
            return { ...doc.data(), sutAlimId: doc.id };
        });
        
        filterAndRenderHistory();
    } catch (error) {
        console.error("GeÃ§miÅŸ verileri alÄ±nÄ±rken bir hata oluÅŸtu:", error);
    }
}


function displayCurrentProducer() {
            if (currentProducerIndex >= routeProducers.length) {
                producerPanel.style.display = 'none';
                alert(`${categorySelect.options[categorySelect.selectedIndex].text} rotasÄ± tamamlandÄ±!`);
                return;
            }
            const producer = routeProducers[currentProducerIndex];
            currentProducerName.textContent = producer.adiSoyadi;
            producerSelect.value = currentProducerIndex;
            quantityInput.value = '';
            notesInput.value = '';
            quantityInput.focus();
        }

async function showDailyGrandTotal() {
    const displayElement = document.getElementById('gunlukGenelToplamGosterge');
    const date = collectionDateInput.value;
    if (!date) {
        displayElement.textContent = '';
        return;
    }
    displayElement.textContent = 'HesaplanÄ±yor...';

    try {
        const snapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('tarih', '==', date)
            .get();

        let genelToplam = 0;
        const toNumber = (val) => parseFloat(String(val || 0).replace(',', '.')) || 0;

        if (!snapshot.empty) {
            snapshot.forEach(doc => {
                const data = doc.data();
                const sabahMiktari = toNumber(data.sabah);
                const aksamMiktari = toNumber(data.aksam);
                genelToplam += sabahMiktari + aksamMiktari;
            });
        }
        
        displayElement.textContent = `Mevcut: ${genelToplam.toFixed(1)} Lt`;

    } catch (error) {
        // Bu konsol kaydÄ±, sadece bir hata olursa Ã§alÄ±ÅŸacaÄŸÄ± iÃ§in kalmasÄ±nda fayda var.
        console.error("GÃ¼nlÃ¼k genel toplam alÄ±nÄ±rken hata:", error);
        displayElement.textContent = 'Hata!';
    }
}
       
function populateProducerSelect() {
            producerSelect.innerHTML = '';
            routeProducers.forEach((producer, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${producer.rotaSirasi || (index + 1)}. ${producer.adiSoyadi}`;
                producerSelect.appendChild(option);
            });
        }

function jumpToProducer() {
            currentProducerIndex = parseInt(this.value);
            displayCurrentProducer();
        }

// LÃœTFEN MEVCUT renderHistory FONKSÄ°YONUNU BU NÄ°HAÄ° VERSÄ°YONLA DEÄÄ°ÅTÄ°RÄ°N
function renderHistory(dataToRender) {
    if (!historySection || !historyList || !sessionSummary) return;

    if (!dataToRender || dataToRender.length === 0) {
        historySection.style.display = 'none';
        return;
    }

    const zaman = document.querySelector('input[name="time"]:checked').value;
    historySection.style.display = 'block';
    historyList.innerHTML = '';

    let sessionTotalMilk = 0;
    let sessionTotalAmount = 0;
    
    const sortedData = [...dataToRender].sort((a, b) => {
        const producerA = allProducersMap.get(a.cariId);
        const producerB = allProducersMap.get(b.cariId);
        const orderA = producerA ? (producerA.rotaSirasi || 999) : 999;
        const orderB = producerB ? (producerB.rotaSirasi || 999) : 999;
        return orderA - orderB;
    });

    sortedData.forEach(item => {
        const isSabah = zaman === 'sabah';
        const miktar = isSabah ? (item.sabah === undefined || item.sabah === null ? -1 : item.sabah) : (item.aksam === undefined || item.aksam === null ? -1 : item.aksam);

        if (miktar >= 0) {
            const birimFiyat = item.fiyat || 0;
            const kayitTutari = miktar * birimFiyat;

            sessionTotalMilk += miktar;
            sessionTotalAmount += kayitTutari;

            const zamanLabel = isSabah ? 'Sabah' : 'AkÅŸam';
            const editIcon = isSabah ? 'â˜€ï¸âœï¸' : 'ğŸŒ™âœï¸';
            const editTitle = `${zamanLabel} DÃ¼zenle`;

            const listItem = document.createElement('li');
            listItem.className = 'history-item';
            
            // --- DAHA FERAH BÄ°R GÃ–RÃœNÃœM Ä°Ã‡Ä°N YAPI GÃœNCELLENDÄ° ---
            listItem.innerHTML = `
                <strong class="history-info" title="${item.cariAdi}">${item.cariAdi}</strong>
                <span style="white-space: nowrap;">${zamanLabel}: ${miktar.toFixed(1)} Lt</span>
                <span style="color: var(--success-color); font-weight: 500; margin-left: auto;">${kayitTutari.toFixed(2)} â‚º</span>
                <div class="history-actions">
                    <button class="btn-icon" onclick="editHistoryItem('${item.sutAlimId}', '${zaman}')" title="${editTitle}">${editIcon}</button>
                    <button class="btn-icon btn-delete" onclick="deleteHistoryItem('${item.sutAlimId}', '${zaman}')" title="Sil">ğŸ—‘ï¸</button>
                </div>
            `;
            historyList.appendChild(listItem);
        }
    });

    sessionSummary.innerHTML = `
        <strong>${zaman === 'sabah' ? 'Sabah' : 'AkÅŸam'} Toplam SÃ¼t:</strong> ${sessionTotalMilk.toFixed(1)} Lt
        | <strong>Toplam Tutar:</strong> ${sessionTotalAmount.toFixed(2)} â‚º
    `;
    
     if (historyList.children.length === 0) {
        historySection.style.display = 'none';
     }
}

// LÃ¼tfen mevcut deleteHistoryItem fonksiyonunu bununla deÄŸiÅŸtirin.
async function deleteHistoryItem(sutAlimId, zaman) {
    if (!zaman) {
        alert("Silme iÅŸleminde hata: Zaman dilimi belirtilmedi.");
        return;
    }

    const entryToDelete = fullHistoryForDate.find(item => item.sutAlimId === sutAlimId);
    if (!entryToDelete) {
        alert("Silinecek kayÄ±t oturum geÃ§miÅŸinde bulunamadÄ±.");
        return;
    }

    const dayDifference = getDayDifference(entryToDelete.tarih);
    if (currentUserRole !== 'admin' && dayDifference > 2) {
        alert('Bu kaydÄ± silme yetkiniz yok.');
        return;
    }
    
    const zamanAdi = zaman === 'sabah' ? 'sabah' : 'akÅŸam';
    if (!confirm(`'${entryToDelete.cariAdi}' iÃ§in girilen ${zamanAdi} sÃ¼t kaydÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?`)) {
        return;
    }

    saveBtn.disabled = true;
    skipBtn.disabled = true;

    try {
        const alimTarihi = entryToDelete.tarih;
        const sutAlimRef = db.collection('sut_alimlari').doc(sutAlimId);

        const digerZaman = (zaman === 'sabah') ? 'aksam' : 'sabah';
        if (entryToDelete[digerZaman] === undefined || entryToDelete[digerZaman] === null) {
            await sutAlimRef.delete();
            alert("GÃ¼nÃ¼n tek kaydÄ± olduÄŸu iÃ§in tÃ¼mÃ¼yle silindi.");
        } else {
            const updatePayload = {};
            updatePayload[zaman] = firebase.firestore.FieldValue.delete();
            updatePayload.toplam = entryToDelete[digerZaman] || 0;
            updatePayload.toplamTutar = updatePayload.toplam * (entryToDelete.fiyat || 0);
            await sutAlimRef.update(updatePayload);
            alert(`${zamanAdi} kaydÄ± baÅŸarÄ±yla silindi.`);
        }
        
        await fetchAndRenderHistory(alimTarihi);
        await showDailyGrandTotal(); // <<-- YENÄ° EKLENEN SATIR

        if (categorySelect.value) {
            await startRoute();
        }
    } catch (error) {
        console.error("Silme hatasÄ±:", error);
        alert("KayÄ±t silinirken bir hata oluÅŸtu: " + error.message);
    } finally {
        saveBtn.disabled = false;
        skipBtn.disabled = false;
    }
}



function handleSave() {
            if (editingSutAlimIdInput.value) {
                handleUpdate();
            } else {
                handleSaveAndNext();
            }
        }

function setEditMode(entry, zamanDilimi) {
    producerPanel.style.display = 'block';
    editingEntry = entry;
    editingSutAlimIdInput.value = entry.sutAlimId;

    const miktar = zamanDilimi === 'sabah' ? (entry.sabah || 0) : (entry.aksam || 0);
    document.getElementById(zamanDilimi).checked = true; 

    currentProducerName.textContent = `DÃœZENLE: ${entry.cariAdi}`;
    quantityInput.value = miktar;
    notesInput.value = entry.not || '';
    unitPriceInput.value = (entry.fiyat || 0).toFixed(2);
    
    producerSelect.disabled = true;
    categorySelect.disabled = true;
    
    skipBtn.style.display = 'none';
    saveBtn.textContent = 'GÃ¼ncelle';
    saveBtn.className = 'btn btn-warning';
    cancelEditBtn.style.display = 'block';
    
    producerPanel.scrollIntoView({ behavior: 'smooth' });
}

function cancelEditMode() {
            editingEntry = null;
            editingSutAlimIdInput.value = '';
            producerSelect.disabled = false;
            categorySelect.disabled = false;
            skipBtn.style.display = 'block';
            saveBtn.textContent = 'Kaydet ve Sonraki';
            saveBtn.className = 'btn btn-success';
            cancelEditBtn.style.display = 'none';
            
            if(routeProducers.length > 0 && currentProducerIndex < routeProducers.length) {
                 displayCurrentProducer();
            } else {
                 producerPanel.style.display = 'none';
            }
        }

// LÃ¼tfen mevcut handleUpdate fonksiyonunu bununla deÄŸiÅŸtirin.
async function handleUpdate() {
    const yeniMiktar = parseFloat(String(quantityInput.value).replace(',', '.')) || 0;
    if (isNaN(yeniMiktar) || yeniMiktar < 0) { alert('LÃ¼tfen geÃ§erli bir miktar girin.'); return; }
    if (!editingEntry) { alert("Hata: DÃ¼zenlenecek giriÅŸ bilgisi bulunamadÄ±."); return; }

    saveBtn.disabled = true;
    
    const yeniBirimFiyat = parseFloat(unitPriceInput.value);
    const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
    const sutAlimId = editingSutAlimIdInput.value;
    const alimTarihi = collectionDateInput.value;

    const sutAlimRef = db.collection('sut_alimlari').doc(sutAlimId);

    try {
        // *** GÃœNCELLEME MANTIÄI TAMAMEN YENÄ°LENDÄ° ***
        const mevcutVeri = editingEntry;
        const guncelleme = {
             fiyat: yeniBirimFiyat,
             not: notesInput.value
        };

        // DeÄŸeri doÄŸru zaman dilimine ata
        guncelleme[zamanDilimi] = yeniMiktar;

        // ToplamÄ±, girilen yeni deÄŸer ve diÄŸer zaman diliminin mevcut deÄŸerine gÃ¶re hesapla
        const sabahDegeri = zamanDilimi === 'sabah' ? yeniMiktar : (mevcutVeri.sabah || 0);
        const aksamDegeri = zamanDilimi === 'aksam' ? yeniMiktar : (mevcutVeri.aksam || 0);
        
        guncelleme.toplam = sabahDegeri + aksamDegeri;
        guncelleme.toplamTutar = guncelleme.toplam * yeniBirimFiyat;
        
        await sutAlimRef.update(guncelleme);

        alert("KayÄ±t baÅŸarÄ±yla gÃ¼ncellendi.");
        await fetchAndRenderHistory(alimTarihi);
        await showDailyGrandTotal();

        cancelEditMode(); 
        if (categorySelect.value) { await startRoute(); }

    } catch (error) {
        alert("GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu: " + error.message);
        console.error("Update Error:", error);
    } finally {
        saveBtn.disabled = false;
    }
}

/**
 * Belirtilen Ã¼retici, tarih ve zaman dilimi iÃ§in bir Ã¶nceki gÃ¼nÃ¼n sÃ¼t miktarÄ±nÄ±
 * veritabanÄ±ndan getiren fonksiyon.
 */
async function getPreviousDayQuantity(producerId, currentDateStr, timeSlot) {
    try {
        const currentDate = new Date(currentDateStr);
        // Tarihten bir gÃ¼n Ã§Ä±kararak Ã¶nceki gÃ¼nÃ¼ bul
        currentDate.setDate(currentDate.getDate() - 1);
        const previousDateStr = currentDate.toISOString().split('T')[0];

        // VeritabanÄ±nda Ã¶nceki gÃ¼ne ait kaydÄ± sorgula
        const query = db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('cariId', '==', producerId)
            .where('tarih', '==', previousDateStr);

        const snapshot = await query.get();

        if (snapshot.empty) {
            return null; // Ã–nceki gÃ¼ne ait kayÄ±t yoksa null dÃ¶ndÃ¼r
        }

        const data = snapshot.docs[0].data();
        // Ä°lgili zaman dilimindeki (sabah/aksam) miktarÄ± dÃ¶ndÃ¼r
        return data[timeSlot] !== undefined ? data[timeSlot] : null;

    } catch (error) {
        console.error("Ã–nceki gÃ¼n verisi alÄ±nÄ±rken hata:", error);
        return null; // Hata durumunda null dÃ¶ndÃ¼r
    }
}
// Miktar farkÄ± uyarÄ±sÄ±nÄ± %35'e Ã§Ä±karan gÃ¼ncel fonksiyon
async function checkPreviousDayDifference() {
    const currentQuantity = parseFloat(String(quantityInput.value).replace(',', '.')) || 0;
    if (currentQuantity <= 0) return;

    const currentProducer = routeProducers[currentProducerIndex];
    if (!currentProducer) return;

    const timeSlot = document.querySelector('input[name="time"]:checked').value;
    const currentDateStr = collectionDateInput.value;

    const previousQuantity = await getPreviousDayQuantity(currentProducer.id, currentDateStr, timeSlot);

    if (previousQuantity === null || previousQuantity <= 0) {
        console.log("KarÅŸÄ±laÅŸtÄ±rma iÃ§in Ã¶nceki gÃ¼n verisi bulunamadÄ±.");
        return;
    }

    const difference = Math.abs(currentQuantity - previousQuantity);
    const percentageChange = (difference / previousQuantity) * 100;

    // *** DEÄÄ°ÅÄ°KLÄ°K BURADA: UyarÄ± oranÄ± %20'den %35'e Ã§Ä±karÄ±ldÄ± ***
    if (percentageChange > 35) {
        const message = `DÄ°KKAT!\n\nGirilen miktar (${currentQuantity.toFixed(1)} Lt), dÃ¼nkÃ¼ miktara (${previousQuantity.toFixed(1)} Lt) gÃ¶re %${percentageChange.toFixed(0)} oranÄ±nda farklÄ±.\n\nYine de bu ÅŸekilde kaydetmek istiyor musunuz?`;
        
        const confirmation = confirm(message);

        if (!confirmation) {
            quantityInput.value = '';
            quantityInput.focus();
        }
    }
}


function advanceToNextProducer() {
    // Mevcut (iÅŸlemi tamamlanan) Ã¼reticiyi rotanÄ±n kalanlar listesinden Ã§Ä±kar.
    routeProducers.splice(currentProducerIndex, 1);

    // Ãœretici atlama dropdown listesini, kalan Ã¼reticilerle yeniden doldur.
    populateProducerSelect();
    
    // EÄŸer mevcut index, kalan Ã¼retici sayÄ±sÄ±ndan bÃ¼yÃ¼k veya eÅŸitse,
    // bu durum genellikle son Ã¼retici iÅŸlendiÄŸinde olur. BaÅŸa dÃ¶n.
    if (currentProducerIndex >= routeProducers.length) {
        currentProducerIndex = 0;
    }

    // Bir sonraki Ã¼reticiyi ekranda gÃ¶ster.
    // Diziden bir eleman sildiÄŸimiz iÃ§in indeksi artÄ±rmamÄ±za gerek yok,
    // bir sonraki eleman zaten mevcut indekse kaymÄ±ÅŸ olur.
    displayCurrentProducer();
}
function scrollToActivePanel() {
    // TarayÄ±cÄ±nÄ±n ve klavyenin yerleÅŸmesi iÃ§in Ã§ok kÄ±sa bir gecikme eklemek
    // iÅŸlemin daha stabil Ã§alÄ±ÅŸmasÄ±nÄ± saÄŸlar.
    setTimeout(() => {
        const producerPanel = document.getElementById('producer-panel');
        if (producerPanel) {
            producerPanel.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }
    }, 100);
}
function editHistoryItem(sutAlimId, zaman) {
            const entry = fullHistoryForDate.find(item => item.sutAlimId === sutAlimId);
            if (entry) {
            const dayDifference = getDayDifference(entry.tarih);
            if (currentUserRole !== 'admin' && dayDifference > 2) {
            alert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok. Sadece son 2 gÃ¼ne ait kayÄ±tlar dÃ¼zenlenebilir.');return;}
                setEditMode(entry, zaman);
            } else {alert("DÃ¼zenlenecek kayÄ±t bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyip tekrar deneyin.");}
        }

</script>
</body>
</html>