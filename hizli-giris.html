<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gelişmiş Süt Girişi</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --light-color: #f8f9fa;
            --dark-color: #343a40; --border-color: #dee2e6; --white-color: #fff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: var(--light-color); color: var(--dark-color); }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        header { background-color: var(--primary-color); color: var(--white-color); padding: 20px 15px; text-align: center; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.8em; }
        main { padding: 20px 0; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 1.1em; }
        .form-group select, .form-group input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .time-selection { display: flex; gap: 10px; }
        .time-selection input[type="radio"] { display: none; }
        .time-selection label { flex: 1; text-align: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; font-weight: 500; }
        .time-selection input[type="radio"]:checked + label { background-color: var(--primary-color); color: var(--white-color); border-color: var(--primary-color); }
        #producer-panel, #history-section { background-color: var(--white-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 25px; }
        #current-producer-name { font-size: 1.5em; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; text-align: center; }
        .action-buttons { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 25px; }
        .btn { padding: 15px; font-size: 1.1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        #session-summary { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        #history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { padding: 10px 0; border-bottom: 1px solid #f0f2f5; display: flex; align-items: center; gap: 10px; }
        .history-item-info { font-weight: 600; flex-grow: 1; }
        .history-item-details { text-align: right; }
.history-item .delete-btn {
    background-color: var(--danger-color);
    color: var(--white-color);
    padding: 8px 12px;
    font-size: 0.9em;
    flex-shrink: 0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
        .history-item .edit-btn { background-color: var(--warning-color); color: var(--dark-color); padding: 8px 12px; font-size: 0.9em; flex-shrink: 0; border-radius: 6px; border: none; cursor: pointer;}
        #cancel-edit-btn { display: none; margin-top: 10px; width: 100%; background-color: var(--danger-color); color: var(--white-color); }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Gelişmiş Süt Girişi</h1></header>
        <main>
            <form id="setup-form" onsubmit="return false;">
                <input type="hidden" id="editingMovementId">
                <div class="form-group"><label for="collection-date">Süt Alım Tarihi</label><input type="date" id="collection-date" name="collection-date"></div>
                <div class="form-group"><label for="unit-price">Süt Birim Fiyatı (₺)</label><input type="number" id="unit-price" name="unit-price" step="0.01"></div>
                <div class="form-group"><label>Zaman</label><div class="time-selection"><input type="radio" id="aksam" name="time" value="akşam" checked><label for="aksam">AKŞAM</label><input type="radio" id="sabah" name="time" value="sabah"><label for="sabah">SABAH</label></div></div>
                <div class="form-group"><label for="tank">Tank Seçimi</label><select id="tank" name="tank"></select></div>
                <div class="form-group"><label for="category">Kategori/Köy (Rota)</label><select id="category" name="category"></select></div>
            </form>
            <div id="producer-panel" style="display: none;">
                <h2 id="current-producer-name">Üretici Adı</h2>
                <div class="form-group"><label for="producer-select">Rota Dışı Seçim / Üretici Atlama</label><select id="producer-select" name="producer-select"></select></div>
                <div class="form-group"><label for="quantity">Miktar (Litre)</label><input type="number" id="quantity" name="quantity" step="0.1" inputmode="decimal"></div>
                <div class="form-group"><label for="notes">Açıklama</label><textarea id="notes" name="notes" rows="3"></textarea></div>
                <div class="action-buttons"><button type="button" id="skip-btn" class="btn btn-secondary">Pas Geç</button><button type="button" id="save-btn" class="btn btn-success">Kaydet ve Sonraki</button></div>
                <button type="button" id="cancel-edit-btn" class="btn">Düzenlemeyi İptal Et</button>
            </div>
            <section id="history-section" style="display: none;">
                <h2>Süt Alım Geçmişi (Bu Oturum)</h2><div id="session-summary"></div><ul id="history-list"></ul>
            </section>
        </main>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
            authDomain: "sut-takip-projem.firebaseapp.com",
            projectId: "sut-takip-projem",
            storageBucket: "sut-takip-projem.appspot.com",
            messagingSenderId: "512756958486",
            appId: "1:512756958486:web:13cceb6835e2c575e9fc37"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let sahipId = '';
        let routeProducers = [], collectionHistory = [];
        let currentProducerIndex = 0;
        let editingEntry = null;

        const collectionDateInput = document.getElementById('collection-date');
        const unitPriceInput = document.getElementById('unit-price');
        const tankSelect = document.getElementById('tank');
        const categorySelect = document.getElementById('category');
        const producerPanel = document.getElementById('producer-panel');
        const currentProducerName = document.getElementById('current-producer-name');
        const producerSelect = document.getElementById('producer-select');
        const quantityInput = document.getElementById('quantity');
        const notesInput = document.getElementById('notes');
        const saveBtn = document.getElementById('save-btn');
        const skipBtn = document.getElementById('skip-btn');
        const historySection = document.getElementById('history-section');
        const historyList = document.getElementById('history-list');
        const sessionSummary = document.getElementById('session-summary');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editingMovementIdInput = document.getElementById('editingMovementId');

        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection('kullanicilar').doc(user.uid).get().then(doc => {
                    if (doc.exists && doc.data().sahipId) {
                        sahipId = doc.data().sahipId;
                        initializeApp();
                    } else { alert("Kullanıcı profili veya sahip bilgisi bulunamadı."); auth.signOut(); }
                });
            } else { window.location.href = 'login.html'; }
        });

        async function initializeApp() {
            collectionDateInput.value = new Date().toISOString().split('T')[0];
            const settings = await getSettings();
            unitPriceInput.value = settings.defaultMilkPrice ? settings.defaultMilkPrice.toFixed(2) : "15.50";

            await Promise.all([populateTanks(), populateCategories()]);

            categorySelect.addEventListener('change', startRoute);
            producerSelect.addEventListener('change', jumpToProducer);
            saveBtn.addEventListener('click', handleSave);
            skipBtn.addEventListener('click', handleSkip);
            cancelEditBtn.addEventListener('click', cancelEditMode);

            [collectionDateInput, ...document.querySelectorAll('input[name="time"]')].forEach(el => {
                el.addEventListener('change', () => { if (categorySelect.value) startRoute(); });
            });
        }
        
      async function getSettings() {
    if (!sahipId) return {};
    try {
        const doc = await db.collection('ayarlar').doc(sahipId).get();
        return doc.exists ? doc.data() : {};
    } catch (e) {
        console.error("Ayarlar alınamadı:", e);
        return {};
    }
}

async function populateTanks() {
    const tankSelect = document.getElementById('tank');
    if (!tankSelect) return;

    tankSelect.innerHTML = '<option value="">Yükleniyor...</option>';

    if (!sahipId) {
        console.error("populateTanks çağrıldı ama sahipId boş. Kullanıcı oturum bilgisi bekleniyor.");
        tankSelect.innerHTML = '<option value="" disabled selected>Kullanıcı bilgisi bekleniyor...</option>';
        return;
    }

    try {
        const snapshot = await db.collection('tanklar').where('sahipId', '==', sahipId).orderBy('ad').get();

        if (snapshot.empty) {
            tankSelect.innerHTML = '<option value="" disabled selected>Tanımlı tank bulunamadı!</option>';
            console.warn(`Veritabanında sahipId'si '${sahipId}' olan bir tank bulunamadı. Lütfen Firestore veritabanınızı kontrol edin.`);
            return;
        }

        tankSelect.innerHTML = '';
        snapshot.forEach(doc => {
            const tank = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = `${tank.ad} (${tank.kapasite} Lt)`;
            tankSelect.appendChild(option);
        });
    } catch (error) {
        console.error("Tanklar yüklenirken bir Firestore hatası oluştu:", error);
        tankSelect.innerHTML = '<option value="" disabled selected>Hata: Tanklar yüklenemedi.</option>';
    }
}

async function populateCategories() {
    const categorySelect = document.getElementById('category');
    if (!categorySelect) return;
    categorySelect.innerHTML = '<option value="">Yükleniyor...</option>';
    if (!sahipId) {
        categorySelect.innerHTML = '<option value="" disabled selected>Sahip bilgisi bekleniyor...</option>';
        return;
    }
    try {
        const snapshot = await db.collection('cari_kategorileri').where('sahipId', '==', sahipId).orderBy('ad').get();
        categorySelect.innerHTML = '<option value="">Rota Seçiniz...</option>';
        snapshot.forEach(doc => {
            categorySelect.innerHTML += `<option value="${doc.data().ad}">${doc.data().ad}</option>`;
        });
    } catch (e) {
        console.error("Kategoriler yüklenirken hata:", e);
        categorySelect.innerHTML = '<option value="" disabled selected>Hata: Rotalar yüklenemedi</option>';
    }
}

function getSessionKey(category) {
    const date = document.getElementById('collection-date').value;
    const time = document.querySelector('input[name="time"]:checked').value;
    return `session_${sahipId}_${date}_${time}_${category || 'none'}`;
}

        async function startRoute() {
            producerPanel.style.display = 'none';
            collectionHistory = [];
            
            const category = categorySelect.value;
            if (!category) { return; }

            const alimTarihi = collectionDateInput.value;
            const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
            
            const [producersSnapshot, existingEntriesSnapshot] = await Promise.all([
                db.collection('cariler').where('sahipId', '==', sahipId).where('kategori', '==', category).where('durum', '==', 'aktif').where('cariGrup', '==', 'üretici').orderBy('rotaSirasi').get(),
                db.collection('tank_hareketleri').where('sahipId', '==', sahipId).where('alim_tarihi', '==', alimTarihi).where('zaman_dilimi', '==', zamanDilimi).get()
            ]);

            collectionHistory = existingEntriesSnapshot.docs.map(doc => doc.data());
            renderHistory();

            const savedProducerIds = new Set(collectionHistory.map(entry => entry.ureticiId));
            routeProducers = producersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(p => !savedProducerIds.has(p.id));

            if(routeProducers.length === 0) {
                alert("Bu rota için tüm süt girişleri tamamlanmış.");
                return;
            }
            
            currentProducerIndex = 0;
            populateProducerSelect();
            displayCurrentProducer();
            producerPanel.style.display = 'block';
        }

        function displayCurrentProducer() {
            if (currentProducerIndex >= routeProducers.length) {
                producerPanel.style.display = 'none';
                alert(`${categorySelect.options[categorySelect.selectedIndex].text} rotası tamamlandı!`);
                return;
            }
            const producer = routeProducers[currentProducerIndex];
            currentProducerName.textContent = producer.adiSoyadi;
            producerSelect.value = currentProducerIndex;
            quantityInput.value = '';
            notesInput.value = '';
            quantityInput.focus();
        }

        function populateProducerSelect() {
             producerSelect.innerHTML = '';
            routeProducers.forEach((producer, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${producer.rotaSirasi || ''}. ${producer.adiSoyadi}`;
                producerSelect.appendChild(option);
            });
        }

        function jumpToProducer() {
            currentProducerIndex = parseInt(this.value);
            displayCurrentProducer();
        }

        function goToNextProducer() {
            currentProducerIndex++;
            displayCurrentProducer();
        }

        function setEditMode(entry) {
            editingEntry = entry;
            editingMovementIdInput.value = entry.movementId;
            currentProducerName.textContent = `DÜZENLE: ${entry.ureticiAdi}`;
            quantityInput.value = entry.miktar;
            notesInput.value = entry.not || '';
            unitPriceInput.value = entry.birim_fiyat.toFixed(2);
            producerSelect.disabled = true;
            categorySelect.disabled = true;
            skipBtn.style.display = 'none';
            saveBtn.textContent = 'Güncelle';
            saveBtn.className = 'btn btn-warning';
            cancelEditBtn.style.display = 'block';
            producerPanel.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditMode() {
            editingEntry = null;
            editingMovementIdInput.value = '';
            producerSelect.disabled = false;
            categorySelect.disabled = false;
            skipBtn.style.display = 'block';
            saveBtn.textContent = 'Kaydet ve Sonraki';
            saveBtn.className = 'btn btn-success';
            cancelEditBtn.style.display = 'none';
            displayCurrentProducer();
        }

        async function handleSave() {
            if (editingMovementIdInput.value) {
                await handleUpdate();
            } else {
                await handleSaveAndNext();
            }
        }

        async function handleUpdate() {
            const yeniMiktar = parseFloat(quantityInput.value);
            if (!yeniMiktar || yeniMiktar <= 0) { alert('Lütfen geçerli bir miktar girin.'); return; }
            
            const eskiMiktar = editingEntry.miktar;
            const litreFarki = yeniMiktar - eskiMiktar;
            const yeniBirimFiyat = parseFloat(unitPriceInput.value);
            const yeniToplamTutar = yeniMiktar * yeniBirimFiyat;
            const zamanDilimi = editingEntry.zaman_dilimi;

            saveBtn.disabled = true;

            const batch = db.batch();
            const tankRef = db.collection('tanklar').doc(editingEntry.tankId);
            const movementRef = db.collection('tank_hareketleri').doc(editingEntry.movementId);
            
            const sutAlimSnapshot = await db.collection('sut_alimlari')
                .where('sahipId', '==', sahipId)
                .where('cariId', '==', editingEntry.ureticiId)
                .where('tarih', '==', editingEntry.alim_tarihi)
                .where('toplamTutar', '==', editingEntry.toplam_tutar)
                .limit(1).get();

            if (!sutAlimSnapshot.empty) {
                const sutAlimRef = sutAlimSnapshot.docs[0].ref;
                batch.update(sutAlimRef, {
                    toplam: yeniMiktar,
                    sabah: zamanDilimi === 'sabah' ? yeniMiktar : 0,
                    aksam: zamanDilimi === 'akşam' ? yeniMiktar : 0,
                    fiyat: yeniBirimFiyat,
                    toplamTutar: yeniToplamTutar
                });
            } else {
                console.warn("Güncellenecek ilgili süt alım kaydı bulunamadı.");
            }

            batch.update(movementRef, { miktar: yeniMiktar, birim_fiyat: yeniBirimFiyat, toplam_tutar: yeniToplamTutar });
            batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(litreFarki) });

            try {
                await batch.commit();
                await startRoute();
                cancelEditMode();
            } catch (error) {
                alert("Güncelleme sırasında hata: " + error.message);
            } finally {
                saveBtn.disabled = false;
            }
        }
        
        async function handleSaveAndNext() {
            const unitPrice = parseFloat(unitPriceInput.value);
            const quantity = parseFloat(quantityInput.value);
            const tankId = tankSelect.value;
            const alimTarihi = collectionDateInput.value;
            const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
            if (currentProducerIndex >= routeProducers.length) return;
            const currentProducer = routeProducers[currentProducerIndex];

            if (!unitPrice || !quantity || !tankId || quantity <= 0 || !alimTarihi) {
                alert('Lütfen Fiyat, Miktar, Tarih ve Tank seçimlerini doğru yapın.'); return;
            }
            
            saveBtn.disabled = true;
            skipBtn.disabled = true;
            
            const totalPrice = (quantity * unitPrice);
            const movementRef = db.collection('tank_hareketleri').doc();
            
            const entryData = {
                movementId: movementRef.id, ureticiId: currentProducer.id, ureticiAdi: currentProducer.adiSoyadi,
                sahipId: sahipId, calisanId: auth.currentUser.uid, tankId: tankId, alim_tarihi: alimTarihi,
                zaman_dilimi: zamanDilimi, miktar: quantity, birim_fiyat: unitPrice,
                toplam_tutar: totalPrice, not: notesInput.value, kayitZamani: new Date()
            };

            const tankRef = db.collection('tanklar').doc(tankId);
            const sutAlimRef = db.collection('sut_alimlari').doc();
            const batch = db.batch();

            batch.set(movementRef, entryData);
            batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(quantity) });
            batch.set(sutAlimRef, {
                tarih: alimTarihi, cariId: currentProducer.id, cariAdi: currentProducer.adiSoyadi,
                sabah: zamanDilimi === 'sabah' ? quantity : 0, aksam: zamanDilimi === 'akşam' ? quantity : 0,
                toplam: quantity, fiyat: unitPrice, toplamTutar: totalPrice,
                aciklama: `Hızlı giriş ile eklendi. Not: ${notesInput.value}`, sahipId: sahipId
            });

            try {
                await batch.commit();
                collectionHistory.push(entryData);
                renderHistory();
                routeProducers.splice(currentProducerIndex, 1);
                populateProducerSelect();
                displayCurrentProducer();
            } catch (error) {
                console.error("Kayıt hatası:", error);
                alert("Veri kaydedilirken bir hata oluştu: " + error.message);
            } finally {
                saveBtn.disabled = false;
                skipBtn.disabled = false;
            }
        }

        function handleSkip() {
            currentProducerIndex++;
            displayCurrentProducer();
        }

       function renderHistory() {
    if (!historySection || !historyList || !sessionSummary) return;
    if (collectionHistory.length === 0) {
        historySection.style.display = 'none';
        return;
    }
    historySection.style.display = 'block';
    historyList.innerHTML = '';
    let totalMilk = 0,
        totalValue = 0;

    collectionHistory.sort((a, b) => (b.kayitZamani.seconds || b.kayitZamani) - (a.kayitZamani.seconds || a.kayitZamani)).forEach(item => {
        // Düzenleme fonksiyonuna doğru indeksi gönderebilmek için item'ın kendisini bulalım
        const originalIndex = collectionHistory.findIndex(h => h.movementId === item.movementId);

        const listItem = document.createElement('li');
        listItem.className = 'history-item';
        listItem.innerHTML = `
            <div class="history-item-info">${item.ureticiAdi}</div>
            <div class="history-item-details">
                <span>${item.miktar.toFixed(1)} Litre</span>
                <span class="price">${item.toplam_tutar.toFixed(2)} ₺</span>
            </div>
            <div>
                <button class="btn edit-btn" onclick="editHistoryItem(${originalIndex})">Düzenle</button>
                <button class="btn delete-btn" onclick="deleteHistoryItem('${item.movementId}')">Sil</button>
            </div>
        `;
        historyList.appendChild(listItem);
        totalMilk += item.miktar;
        totalValue += item.toplam_tutar;
    });

    sessionSummary.innerHTML = `<p>Toplam Süt (Bu Oturum): <span>${totalMilk.toFixed(1)} Litre</span></p><p>Toplam Tutar (Bu Oturum): <span>${totalValue.toFixed(2)} ₺</span></p>`;
}
    async function deleteHistoryItem(movementId) {
    const entryToDelete = collectionHistory.find(item => item.movementId === movementId);
    if (!entryToDelete) {
        alert("Silinecek kayıt oturum geçmişinde bulunamadı.");
        return;
    }
    if (!confirm(`'${entryToDelete.ureticiAdi}' için girilen ${entryToDelete.miktar} Lt süt kaydını kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!`)) {
        return;
    }

    const saveBtn = document.getElementById('save-btn');
    const skipBtn = document.getElementById('skip-btn');
    saveBtn.disabled = true;
    skipBtn.disabled = true;

    const tankRef = db.collection('tanklar').doc(entryToDelete.tankId);
    const movementRef = db.collection('tank_hareketleri').doc(entryToDelete.movementId);

    // --- DÜZELTME: 'entryToEdit' olan değişken adı 'entryToDelete' olarak düzeltildi ---
    const sutAlimSnapshot = await db.collection('sut_alimlari')
        .where('sahipId', '==', sahipId)
        .where('cariId', '==', entryToDelete.ureticiId)
        .where('tarih', '==', entryToDelete.alim_tarihi)
        .where('toplamTutar', '==', entryToDelete.toplam_tutar)
        .limit(1).get();

    const batch = db.batch();

    batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(-entryToDelete.miktar) });
    batch.delete(movementRef);
    if (!sutAlimSnapshot.empty) {
        batch.delete(sutAlimSnapshot.docs[0].ref);
    }

    try {
        await batch.commit();
        alert("Kayıt başarıyla silindi.");
        startRoute();
    } catch (error) {
        console.error("Silme hatası:", error);
        alert("Kayıt silinirken bir hata oluştu: " + error.message);
    } finally {
        saveBtn.disabled = false;
        skipBtn.disabled = false;
    }
}
        function editHistoryItem(movementId) {
            const entry = collectionHistory.find(item => item.movementId === movementId);
            if (entry) {
                setEditMode(entry);
            } else {
                alert("Düzenlenecek kayıt bulunamadı.");
            }
        }
    </script>
</body>
</html>
