<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Süt Takip Programı - Tam Sürüm</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="sidebar">
        <h1>Süt Takip Programı</h1>
        <nav id="sidebarNav">
            <ul>
                <li><a href="#dashboard" class="nav-link active">📝 Kontrol Paneli</a></li>
                <li><a href="#cari-yonetimi" class="nav-link">👥 Cari Yönetimi</a></li>
                <li><a href="#sut-alimi" class="nav-link">🥛 Günlük Süt Alımı</a></li>
                <li><a href="#yem-stok-yonetimi" class="nav-link">📦 Yem Stok Yönetimi</a></li>
                <li><a href="#yem-satisi" class="nav-link">🌾 Yem Satışı</a></li>
                <li><a href="#tedarikci-odemeleri" class="nav-link">💳 Tedarikçi Ödemeleri</a></li>
                <li><a href="#hesap-ozeti" class="nav-link">📊 Cari Hesap Özeti</a></li>
                <li><a href="#sut-alim-raporu" class="nav-link">🗓️ Aylık Süt Raporu</a></li>
                <li><a href="#aylik-yem-raporu" class="nav-link">📈 Aylık Yem Raporu</a></li>
                <li><a href="#ayarlar" class="nav-link">⚙️ Ayarlar</a></li>
                <li class="logout-link">
                    <a href="#" id="logoutButton">🚪 Çıkış Yap</a>
                </li>
            </ul>
        </nav>
    </div>

    <div class="main-content">
        <section id="dashboard" class="module-section">
            <div class="module-header"><h2>📝 Kontrol Paneli</h2></div>
            <div class="container">
                <h3>Hoş Geldiniz!</h3>
                <div class="alert-info">
                    <strong>Bilgilendirme:</strong> Bu, Süt Takip Programı'nın interaktif bir önizlemesidir.
                    Verileriniz sayfa yenilendiğinde veya kapatıldığında kaybolacaktır.
                </div>
                 <p>Toplam Kayıtlı Cari Sayısı: <span id="totalCari">0</span></p>
                 <p>Tanımlı Yem Çeşidi: <span id="totalYemCesidi">0</span></p>
                 <p>Bugünkü Toplam Süt Alım Kayıt Sayısı: <span id="todaySutAlim">0</span></p>
            </div>
        </section>
        
        <section id="cari-yonetimi" class="module-section">
            <div class="module-header">
                <h2>👥 Cari Yönetimi</h2>
                <div class="search-container">
                    <select id="cariKategoriFiltre" style="padding: 8px 10px; border-radius: 4px; border: 1px solid #ced4da; font-size: 0.9em;">
                        <option value="">Tüm Kategoriler</option>
                    </select>
                    <input type="text" id="cariSearchInput" placeholder="Cari Ara...">
                </div>
            </div>
            <div class="container">
                <div class="form-section"><h3><span id="cariFormBaslik">Yeni Cari Kart</span></h3><form id="cariForm" action="#"><input type="hidden" id="cariEditId"><div class="form-grid">
                    <div class="form-group"><label for="cariKodu">Cari Kodu:</label><input type="text" id="cariKodu" placeholder="Örn: C001"></div>
                    <div class="form-group"><label for="cariAdiSoyadi">Adı Soyadı / Firma Adı:</label><input type="text" id="cariAdiSoyadi" required></div>
                    <div class="form-group"><label for="cariKategori">Kategori/Köy:</label><select id="cariKategori" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="cariDurum">Durum:</label><select id="cariDurum"><option value="aktif">Aktif</option><option value="pasif">Pasif</option></select></div>
                    <div class="form-group"><label for="cariTelefon">Telefon:</label><input type="tel" id="cariTelefon"></div>
                    <div class="form-group"><label for="cariEposta">E-posta:</label><input type="email" id="cariEposta"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="cariAdres">Adres:</label><textarea id="cariAdres"></textarea></div>
                    <div class="form-group"><label for="cariBankaAdi">Banka Adı:</label><input type="text" id="cariBankaAdi"></div>
                    <div class="form-group"><label for="cariIban">IBAN:</label><input type="text" id="cariIban"></div>
                    <div class="form-group"><label for="cariVergiDairesi">Vergi Dairesi:</label><input type="text" id="cariVergiDairesi"></div>
                    <div class="form-group"><label for="cariVergiNo">Vergi No / T.C.:</label><input type="text" id="cariVergiNo"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="cariNotlar">Özel Notlar:</label><textarea id="cariNotlar"></textarea></div>
                </div><button type="submit" class="btn dont-print" id="cariKaydetBtn">Kaydet</button><button type="button" class="btn btn-primary dont-print" id="cariFormTemizleBtn" style="display:none;">Yeni Kayıt</button></form></div>
                
                <div id="cari-list-printable-area">
                    <h3 class="print-only print-title" id="cariListeRaporBaslik">Cari Listesi Raporu</h3>
                    <div class="list-section">
                        <h3>Cari Listesi</h3>
                        <table>
                            <thead><tr><th>Kod</th><th>Ad/Firma</th><th>Kategori</th><th>Durum</th><th>Telefon</th><th>Bakiye</th><th class="dont-print">İşlemler</th></tr></thead>
                            <tbody id="cariListesiBody"></tbody>
                            <tfoot id="cariListesiFooter"></tfoot>
                        </table>
                    </div>
                </div>
                <button type="button" class="btn btn-print dont-print" id="cariListesiYazdirBtn" style="margin-top: 20px;">Listeyi Yazdır</button>
                
                <div class="totals-summary-container dont-print">
                    <h4>Genel Bakiye Özeti (Tüm Cariler)</h4>
                    <p>Toplam Alacak: <span id="genelToplamAlacak">0.00 TL</span></p>
                    <p>Toplam Borç: <span id="genelToplamBorc">0.00 TL</span></p>
                    <p>Genel Bakiye: <span id="genelToplamBakiye">0.00 TL</span></p>
                </div>
            </div>
        </section>

        <section id="sut-alimi" class="module-section hidden-section">
            <div class="module-header"><h2>🥛 Toplu Günlük Süt Alımı</h2></div>
            <div class="container">
                <div class="form-section">
                    <h3>Giriş Filtreleri</h3>
                    <div class="form-grid" id="sutGirisFiltreler" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group"><label for="topluGirisTarih">Giriş Tarihi:</label><input type="date" id="topluGirisTarih" required></div>
                        <div class="form-group"><label for="topluGirisKategori">Kategori/Köy Seçin:</label><select id="topluGirisKategori" required><option value="">Tüm Kategoriler</option></select></div>
                    </div>
                </div>
                <div class="list-section">
                    <h3>Günlük Süt Girişi</h3>
                    <div id="topluSutGirisTablosuAlani"></div>
                    <p id="topluGirisTedarikciYokMesaji" style="text-align:center; display:none;">Bu kategoride süt girişi beklenen aktif cari bulunmuyor.</p>
                </div>
                <hr style="margin: 40px 0;">
                <div class="list-section">
                    <h3>Süt Alım Geçmişi (Seçili Tarih: <span id="gecmisTarihSpan"></span>)</h3>
                    <table>
                        <thead id="sutAlimGecmisiHeader"></thead>
                        <tbody id="sutAlimGecmisiBody"></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section id="yem-stok-yonetimi" class="module-section hidden-section">
             <div class="module-header"><h2>📦 Yem Stok Yönetimi</h2></div>
             <div class="container">
                <div class="form-section"><h3><span id="yemTanimFormBaslik">Yeni Yem Tanımla</span></h3><form id="yemTanimForm" action="#"><input type="hidden" id="yemTanimEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemKodu">Kod:</label><input type="text" id="yemKodu" required></div>
                    <div class="form-group"><label for="yemAdi">Ad:</label><input type="text" id="yemAdi" required></div>
                    <div class="form-group"><label for="yemKategorisi">Kategori:</label><select id="yemKategorisi"><option value="buyukbas">Büyükbaş</option><option value="kucukbas">Küçükbaş</option></select></div>
                    <div class="form-group"><label for="yemBirimi">Birim:</label><input type="text" id="yemBirimi" value="Çuval"></div>
                    <div class="form-group"><label for="yemAlisFiyati">Alış Fiyatı:</label><input type="number" id="yemAlisFiyati" step="0.01"></div>
                    <div class="form-group"><label for="yemSatisFiyati">Satış Fiyatı:</label><input type="number" id="yemSatisFiyati" step="0.01"></div>
                </div><button type="submit" class="btn dont-print" id="yemTanimKaydetBtn">Kaydet</button><button type="button" class="btn btn-primary dont-print" id="yemTanimFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Tanımlı Yemler & Stok</h3><table><thead><tr><th>Kod</th><th>Ad</th><th>Kategori</th><th>Birim</th><th>Alış F.</th><th>Satış F.</th><th>Stok</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="yemStokListesiBody"></tbody></table></div>
                <hr>
                <div class="form-section"><h3><span id="yemAlisFormBaslik">Yeni Yem Alışı</span></h3><form id="yemAlisForm" action="#"><input type="hidden" id="yemAlisEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemAlisTarih">Tarih:</label><input type="date" id="yemAlisTarih" required></div>
                    <div class="form-group"><label for="yemSecimiAlis">Yem:</label><select id="yemSecimiAlis" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemAlisMiktar">Miktar:</label><input type="number" id="yemAlisMiktar" step="1" required></div>
                    <div class="form-group"><label for="yemAlisTedarikci">Cari:</label><select id="yemAlisTedarikci"><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemAlisBirimFiyati">Alış Fiyatı:</label><input type="number" id="yemAlisBirimFiyati" step="0.01" required></div>
                    <div class="form-group"><label>Toplam Tutar:</label><input type="text" id="yemAlisToplamTutar" readonly></div>
                </div><button type="submit" class="btn dont-print" id="yemAlisKaydetBtn">Alışı Kaydet</button><button type="button" class="btn btn-primary dont-print" id="yemAlisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Yem Alış Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Yem</th><th>Miktar</th><th>Cari</th><th>Alış F.</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="yemAlisHareketListesiBody"></tbody></table></div>
             </div>
        </section>
        <section id="yem-satisi" class="module-section hidden-section">
             <div class="module-header"><h2>🌾 Yem Satışı</h2></div>
             <div class="container">
                <div class="form-section"><h3><span id="yemSatisFormBaslik">Yeni Yem Satışı</span></h3><form id="yemSatisForm" action="#"><input type="hidden" id="yemSatisEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemSatisTarih">Tarih:</label><input type="date" id="yemSatisTarih" required></div>
                    <div class="form-group"><label for="yemAlanTedarikci">Alan Cari:</label><select id="yemAlanTedarikci" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemSecimiSatis">Yem:</label><select id="yemSecimiSatis" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemSatisMiktar">Miktar:</label><input type="number" id="yemSatisMiktar" step="1" required></div>
                    <div class="form-group"><label for="yemSatisBirimFiyati">Satış Fiyatı:</label><input type="number" id="yemSatisBirimFiyati" step="0.01" required></div>
                    <div class="form-group"><label>Toplam Tutar:</label><input type="text" id="yemSatisToplamTutar" readonly></div>
                </div><button type="submit" class="btn dont-print" id="yemSatisKaydetBtn">Satışı Kaydet</button><button type="button" class="btn btn-primary dont-print" id="yemSatisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Yem Satış Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Alan Cari</th><th>Yem</th><th>Miktar</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="yemSatisListesiBody"></tbody></table></div>
             </div>
        </section>
        <section id="tedarikci-odemeleri" class="module-section hidden-section">
            <div class="module-header"><h2>💳 Cari Ödemeler</h2></div>
            <div class="container">
                 <div class="form-section"><h3><span id="tedarikciOdemeFormBaslik">Yeni Ödeme/Tahsilat</span></h3><form id="tedarikciOdemeForm" action="#"><input type="hidden" id="tedarikciOdemeEditId"><div class="form-grid">
                    <div class="form-group"><label for="odemeTarih">Tarih:</label><input type="date" id="odemeTarih" required></div>
                    <div class="form-group"><label for="odemeYapilanTedarikci">Cari:</label><select id="odemeYapilanTedarikci" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="odemeTutari">Tutar (TL):</label><input type="number" id="odemeTutari" step="0.01" required></div>
                    <div class="form-group"><label for="odemeTuru">Tür:</label><select id="odemeTuru" required><option value="BorcKapatma">Borç Kapatma</option><option value="Avans">Avans</option><option value="Diger">Diğer</option></select></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="odemeAciklama">Açıklama:</label><textarea id="odemeAciklama" rows="2"></textarea></div>
                 </div><button type="submit" class="btn dont-print" id="tedarikciOdemeKaydetBtn">Kaydet</button><button type="button" class="btn btn-primary dont-print" id="tedarikciOdemeFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                 <div class="list-section"><h3>Yapılan Ödemeler</h3><table><thead><tr><th>Tarih</th><th>Cari</th><th>Tutar</th><th>Tür</th><th>Açıklama</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="tedarikciOdemeListesiBody"></tbody></table></div>
            </div>
        </section>
        <section id="hesap-ozeti" class="module-section hidden-section">
            <div class="module-header dont-print"><h2>📊 Cari Hesap Özeti</h2></div>
            <div class="container">
                <div class="report-section">
                    <h3 class="dont-print">Cari Hesap Özeti</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: 1fr 1fr auto; align-items: end;">
                        <div class="form-group"><label for="raporCariSecimi">Cari Seçin:</label><select id="raporCariSecimi"><option value="">Seçiniz...</option></select></div>
                        <div class="form-group"><label for="raporTarihAraligi">Ay:</label><input type="month" id="raporTarihAraligi"></div>
                        <button type="button" class="btn btn-primary dont-print" id="raporOlusturBtn" style="height:45px;">Rapor Oluştur</button>
                    </div> <hr class="dont-print">
                    <div id="report-content-to-print" class="printable-content format-a5">
                        <h1 class="print-only print-title">Süt Takip Programı - Cari Hesap Özeti</h1>
                        <h4 id="raporBaslik" style="text-align:center;">Lütfen Rapor Kriterlerini Seçin</h4>
                        <div id="raporDetayAlani"></div>
                    </div>
                    <button type="button" class="btn btn-print dont-print" id="raporYazdirBtn" style="margin-top:20px;">Özeti Yazdır</button>
                </div>
            </div>
        </section>
        <section id="sut-alim-raporu" class="module-section hidden-section">
             <div class="module-header dont-print"><h2>🗓️ Aylık Süt Alım Raporu</h2></div>
            <div class="container">
                 <div class="report-section">
                    <h3>Detaylı Süt Alım Raporu</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: 1fr 1fr auto auto; align-items: end; gap: 10px;">
                        <div class="form-group"><label for="sutRaporuTedarikciSecimi">Cari Seçin:</label><select id="sutRaporuTedarikciSecimi"><option value="">Seçiniz...</option></select></div>
                        <div class="form-group"><label for="sutRaporuAySecimi">Ay:</label><input type="month" id="sutRaporuAySecimi"></div>
                        <button type="button" class="btn btn-primary dont-print" id="sutRaporuOlusturBtn" style="height:45px;">Raporu Göster</button>
                        <button type="button" class="btn dont-print" id="sutRaporuTumunuGosterBtn" style="height:45px; background-color: #17a2b8;">Tümünü Göster</button>
                    </div> <hr class="dont-print">
                    <div id="sutAlimRaporAlani" class="printable-content format-a5">
                        <h1 class="print-only print-title">Süt Takip Programı - Aylık Süt Alım Detay Raporu</h1>
                        <h4 id="sutRaporuBaslik" style="text-align:center;">Lütfen Rapor Kriterlerini Seçin</h4>
                        <div id="sutRaporuDetayAlani"></div>
                    </div>
                    <button type="button" class="btn btn-print dont-print" id="sutRaporuYazdirBtn" style="margin-top:20px;">Raporu Yazdır</button>
                 </div>
            </div>
        </section>
        <section id="aylik-yem-raporu" class="module-section hidden-section">
             <div class="module-header"><h2>📈 Aylık Yem Raporu</h2></div>
             <div class="container">
                 <div class="report-section">
                    <h3>Aylık Yem Satış Kârlılık Raporu</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: 1fr auto; align-items: end;">
                        <div class="form-group">
                            <label for="yemRaporuAySecimi">Ay Seçin:</label>
                            <input type="month" id="yemRaporuAySecimi">
                        </div>
                        <button type="button" class="btn btn-primary dont-print" id="yemRaporuOlusturBtn" style="height:45px;">Raporu Göster</button>
                    </div>
                    <hr class="dont-print">
                    <div id="yemRaporuAlani" class="printable-content format-a4">
                    </div>
                    <button type="button" class="btn btn-print dont-print" id="yemRaporuYazdirBtn" style="margin-top:20px;">Raporu Yazdır</button>
                 </div>
             </div>
        </section>
        <section id="ayarlar" class="module-section hidden-section">
             <div class="module-header"><h2>⚙️ Ayarlar</h2></div>
             <div class="container">
                <div class="settings-section"><h3>Genel Ayarlar</h3><form id="ayarlarForm" action="#"><div class="form-group"><label for="varsayilanSutFiyati">Varsayılan Süt Fiyatı (TL/Lt):</label><input type="number" id="varsayilanSutFiyati" step="0.01"></div><button type="submit" class="btn dont-print">Kaydet</button></form></div>
                <hr>
                <div class="settings-section"><h3>Cari Kategori/Köy Tanımları</h3><form id="cariKategoriForm" action="#"><div class="form-grid" style="grid-template-columns: 1fr auto; align-items:end;"><div class="form-group" style="margin-bottom:0;"><label for="yeniCariKategoriAdi">Yeni Ad:</label><input type="text" id="yeniCariKategoriAdi" required></div><button type="submit" class="btn dont-print" style="height:45px;">Ekle</button></div></form><div class="list-section" style="margin-top:20px;"><h4>Tanımlı Kategoriler/Köyler</h4><ul id="cariKategoriListesiUl"></ul></div></div>
             </div>
        </section>
    </div>

    <script>
        const currentUserRole = sessionStorage.getItem('userRole');
        if (!currentUserRole) {
            window.location.href = 'login.html';
        }

        let db_cariler = [];
        let db_cariKategorileri = [];
        let db_sutAlimlari = [];
        let db_yemler = [];
        let db_yemAlimlari = [];
        let db_yemSatislari = [];
        let db_tedarikciOdemeleri = [];
        let globalSettings = { defaultMilkPrice: 15.00 };

        let editingCariId = null, editingYemTanimId = null, editingYemAlisId = null, editingYemSatisId = null, editingTedarikciOdemeId = null;

        const sidebarNav = document.getElementById('sidebarNav');
        const moduleSections = document.querySelectorAll('.main-content .module-section');
        const bodyElement = document.body;
        const logoutButton = document.getElementById('logoutButton');
        
        const cariForm = document.getElementById('cariForm'), cariKaydetBtn = document.getElementById('cariKaydetBtn'), cariFormBaslik = document.getElementById('cariFormBaslik'), cariFormTemizleBtn = document.getElementById('cariFormTemizleBtn'), cariSearchInput = document.getElementById('cariSearchInput'), cariKategoriFiltre = document.getElementById('cariKategoriFiltre'), cariListesiYazdirBtn = document.getElementById('cariListesiYazdirBtn'), cariListesiFooter = document.getElementById('cariListesiFooter');
        const yemTanimForm = document.getElementById('yemTanimForm'), yemTanimKaydetBtn = document.getElementById('yemTanimKaydetBtn'), yemTanimFormBaslik = document.getElementById('yemTanimFormBaslik'), yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
        const yemAlisForm = document.getElementById('yemAlisForm'), yemAlisKaydetBtn = document.getElementById('yemAlisKaydetBtn'), yemAlisFormBaslik = document.getElementById('yemAlisFormBaslik'), yemAlisFormTemizleBtn = document.getElementById('yemAlisFormTemizleBtn');
        const yemSatisForm = document.getElementById('yemSatisForm'), yemSatisKaydetBtn = document.getElementById('yemSatisKaydetBtn'), yemSatisFormBaslik = document.getElementById('yemSatisFormBaslik'), yemSatisFormTemizleBtn = document.getElementById('yemSatisFormTemizleBtn');
        const ayarlarForm = document.getElementById('ayarlarForm');
        const cariKategoriSelect = document.getElementById('cariKategori');
        const cariKategoriForm = document.getElementById('cariKategoriForm');
        const yeniCariKategoriAdiInput = document.getElementById('yeniCariKategoriAdi');
        const cariKategoriListesiUl = document.getElementById('cariKategoriListesiUl');
        const tedarikciOdemeForm = document.getElementById('tedarikciOdemeForm'), tedarikciOdemeKaydetBtn = document.getElementById('tedarikciOdemeKaydetBtn'), tedarikciOdemeFormBaslik = document.getElementById('tedarikciOdemeFormBaslik'), tedarikciOdemeFormTemizleBtn = document.getElementById('tedarikciOdemeFormTemizleBtn');
        const yemAlisTedarikciSelect = document.getElementById('yemAlisTedarikci');
        const yemSecimiAlisSelect = document.getElementById('yemSecimiAlis');
        const yemAlanTedarikciSelect = document.getElementById('yemAlanTedarikci');
        const yemSecimiSatisSelect = document.getElementById('yemSecimiSatis');
        const odemeYapilanTedarikciSelect = document.getElementById('odemeYapilanTedarikci');
        const varsayilanSutFiyatiInput = document.getElementById('varsayilanSutFiyati');
        const yemAlisBirimFiyatiInput = document.getElementById('yemAlisBirimFiyati');
        const yemSatisBirimFiyatiInput = document.getElementById('yemSatisBirimFiyati');
        const cariListesiBody = document.getElementById('cariListesiBody');
        const sutAlimGecmisiHeader = document.getElementById('sutAlimGecmisiHeader');
        const sutAlimGecmisiBody = document.getElementById('sutAlimGecmisiBody');
        const yemStokListesiBody = document.getElementById('yemStokListesiBody');
        const yemAlisHareketListesiBody = document.getElementById('yemAlisHareketListesiBody');
        const yemSatisListesiBody = document.getElementById('yemSatisListesiBody');
        const tedarikciOdemeListesiBody = document.getElementById('tedarikciOdemeListesiBody');
        const raporCariSecimi = document.getElementById('raporCariSecimi'), raporTarihAraligi = document.getElementById('raporTarihAraligi'), raporOlusturBtn = document.getElementById('raporOlusturBtn'), raporYazdirBtn = document.getElementById('raporYazdirBtn'), raporBaslik = document.getElementById('raporBaslik'), raporDetayAlani = document.getElementById('raporDetayAlani');
        const sutRaporuTedarikciSecimi = document.getElementById('sutRaporuTedarikciSecimi'), sutRaporuAySecimi = document.getElementById('sutRaporuAySecimi'), sutRaporuOlusturBtn = document.getElementById('sutRaporuOlusturBtn'), sutRaporuTumunuGosterBtn = document.getElementById('sutRaporuTumunuGosterBtn'), sutRaporuYazdirBtn = document.getElementById('sutRaporuYazdirBtn'), sutRaporuBaslik = document.getElementById('sutRaporuBaslik'), sutRaporuDetayAlani = document.getElementById('sutRaporuDetayAlani');
        const yemRaporuAySecimi = document.getElementById('yemRaporuAySecimi'), yemRaporuOlusturBtn = document.getElementById('yemRaporuOlusturBtn'), yemRaporuYazdirBtn = document.getElementById('yemRaporuYazdirBtn'), yemRaporuAlani = document.getElementById('yemRaporuAlani');
        const totalCariSpan = document.getElementById('totalCari'), totalYemCesidiSpan = document.getElementById('totalYemCesidi'), todaySutAlimSpan = document.getElementById('todaySutAlim');
        const topluGirisTarihInput = document.getElementById('topluGirisTarih');
        const topluGirisKategoriSelect = document.getElementById('topluGirisKategori');

        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substring(2, 9); }
        function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('tr-TR'); }
        function getTodayForInput() { return new Date().toISOString().split('T')[0]; }
        function getMonthYearForInput() { const d = new Date(); return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;}
        function formatCurrency(number) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(number); }
        function setEditingMode(formBaslikEl, kaydetBtnEl, temizleBtnEl, editIdVar, formType) { formBaslikEl.textContent = editIdVar ? `${formType} Bilgilerini Düzenle` : `Yeni ${formType} Kaydı`; kaydetBtnEl.textContent = editIdVar ? 'Güncelle' : 'Kaydet'; temizleBtnEl.style.display = editIdVar ? 'inline-block' : 'none'; }
        
        function applyRolePermissions() {
            bodyElement.className = `role-${currentUserRole}`;
            if (currentUserRole === 'calisan') {
                const activeLink = sidebarNav.querySelector('a.nav-link.active');
                const activeHref = activeLink ? activeLink.getAttribute('href') : '#dashboard';
                const forbiddenPages = ['#cari-yonetimi', '#yem-stok-yonetimi', '#tedarikci-odemeleri', '#ayarlar'];
                if (forbiddenPages.includes(activeHref)) {
                    sidebarNav.querySelector('a.nav-link[href="#dashboard"]').click();
                }
            }
        }
        
        function handleLogout(event) {
            event.preventDefault();
            sessionStorage.removeItem('userRole');
            window.location.href = 'login.html';
        }

        function renderSutAlimGecmisi() {
            const tarih = document.getElementById('topluGirisTarih').value;
            const gecmisTarihSpan = document.getElementById('gecmisTarihSpan');
            
            gecmisTarihSpan.textContent = formatDate(tarih) || 'Tüm Zamanlar';
            sutAlimGecmisiHeader.innerHTML = '';
            sutAlimGecmisiBody.innerHTML = ''; 

            const filtrelenmisAlimlar = db_sutAlimlari.filter(sa => sa.tarih === tarih).sort((a, b) => a.cariAdi.localeCompare(b.cariAdi));

            let totalAksam = 0, totalSabah = 0, totalLitre = 0, totalTutar = 0;

            filtrelenmisAlimlar.forEach(sa => {
                const row = sutAlimGecmisiBody.insertRow();
                row.innerHTML = `<td>${sa.cariAdi}</td>
                    <td>${sa.aksamLitre.toFixed(1)}</td>
                    <td>${sa.sabahLitre.toFixed(1)}</td>
                    <td>${sa.toplamLitre.toFixed(1)}</td>
                    <td>${formatCurrency(sa.birimFiyat)}</td>
                    <td>${formatCurrency(sa.toplamTutar)}</td>
                    <td class="dont-print"><button class="btn btn-delete btn-sm" onclick="deleteSutAlim('${sa.id}')">Sil</button></td>`;
                
                totalAksam += sa.aksamLitre;
                totalSabah += sa.sabahLitre;
                totalLitre += sa.toplamLitre;
                totalTutar += sa.toplamTutar;
            });
            
            const headerRow = sutAlimGecmisiHeader.insertRow();
            headerRow.innerHTML = `<th>Cari</th><th>Akşam (Lt)</th><th>Sabah (Lt)</th><th>Toplam (Lt)</th><th>Birim Fiyat</th><th>Toplam Tutar</th><th class="dont-print">İşlemler</th>`;

            if (filtrelenmisAlimlar.length > 0) {
                const totalsRow = sutAlimGecmisiHeader.insertRow(0);
                totalsRow.style.backgroundColor = '#e9ecef';
                totalsRow.style.fontWeight = 'bold';
                totalsRow.innerHTML = `
                    <td>GÜNLÜK TOPLAM</td>
                    <td>${totalAksam.toFixed(1)}</td>
                    <td>${totalSabah.toFixed(1)}</td>
                    <td>${totalLitre.toFixed(1)}</td>
                    <td>-</td>
                    <td>${formatCurrency(totalTutar)}</td>
                    <td class="dont-print">-</td>
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            applyRolePermissions();
            
            sidebarNav.addEventListener('click', function(event) {
                const link = event.target.closest('a.nav-link');
                if (!link) return;
                event.preventDefault();
                if (link.id === 'logoutButton') return;
                sidebarNav.querySelectorAll('a.nav-link').forEach(lnk => lnk.classList.remove('active'));
                link.classList.add('active');
                const targetId = link.getAttribute('href').substring(1);
                moduleSections.forEach(section => {
                    section.style.display = section.id === targetId ? 'block' : 'none';
                });
                if (targetId === 'dashboard') { updateDashboardStats(); }
                if (targetId === 'cari-yonetimi') { populateCariKategoriFiltre(); renderGenelBakiyeOzeti(); }
                if (targetId === 'sut-alimi') { topluGirisTarihInput.value = getTodayForInput(); populateCariKategoriSelect(topluGirisKategori); renderTopluSutGirisFormu(); renderSutAlimGecmisi(); }
                if (targetId === 'yem-stok-yonetimi') { populateCariSelect(yemAlisTedarikci); populateYemSelect(yemSecimiAlis); }
                if (targetId === 'yem-satisi') { populateCariSelect(yemAlanTedarikci); populateYemSelect(yemSecimiSatis); }
                if (targetId === 'tedarikci-odemeleri') { populateCariSelect(odemeYapilanTedarikci); }
                if (targetId === 'hesap-ozeti'){ populateCariSelect(raporCariSecimi); if(!raporTarihAraligi.value) raporTarihAraligi.value = getMonthYearForInput(); }
                if (targetId === 'sut-alim-raporu'){ populateCariSelect(sutRaporuTedarikciSecimi); if(!sutRaporuAySecimi.value) sutRaporuAySecimi.value = getMonthYearForInput(); }
                if (targetId === 'aylik-yem-raporu'){ if(!yemRaporuAySecimi.value) yemRaporuAySecimi.value = getMonthYearForInput(); }
                if (targetId === 'ayarlar' || targetId === 'cari-yonetimi') { populateCariKategoriSelect(cariKategori); if (targetId === 'ayarlar') { renderCariKategoriListesi(); varsayilanSutFiyatiInput.value = globalSettings.defaultMilkPrice.toFixed(2); } }
            });
            
            loadInitialData();
            renderAllLists();
            document.querySelector('a.nav-link[href="#dashboard"]').click();
            
            logoutButton.addEventListener('click', handleLogout);
            cariFormTemizleBtn.addEventListener('click', resetCariForm);
            yemTanimFormTemizleBtn.addEventListener('click', resetYemTanimForm);
            yemAlisFormTemizleBtn.addEventListener('click', resetYemAlisForm);
            yemSatisFormTemizleBtn.addEventListener('click', resetYemSatisForm);
            tedarikciOdemeFormTemizleBtn.addEventListener('click', resetTedarikciOdemeForm);
            cariSearchInput.addEventListener('input', renderCariListesi);
            cariKategoriFiltre.addEventListener('change', renderCariListesi);
            cariListesiYazdirBtn.addEventListener('click', handleCariListeYazdir);
            topluGirisTarihInput.addEventListener('change', () => { renderTopluSutGirisFormu(); renderSutAlimGecmisi(); });
            topluGirisKategoriSelect.addEventListener('change', renderTopluSutGirisFormu);
            
            cariForm.addEventListener('submit', handleCariKaydet);
            yemTanimForm.addEventListener('submit', handleYemTanimKaydet);
            yemAlisForm.addEventListener('submit', handleYemAlisKaydet);
            yemSatisForm.addEventListener('submit', handleYemSatisKaydet);
            tedarikciOdemeForm.addEventListener('submit', handleTedarikciOdemeKaydet);
            ayarlarForm.addEventListener('submit', handleAyarlarKaydet);
            cariKategoriForm.addEventListener('submit', handleCariKategoriEkle);

            raporOlusturBtn.addEventListener('click', handleHesapOzetiRaporuOlustur);
            raporYazdirBtn.addEventListener('click', () => handleYazdir('hesap-ozeti'));
            sutRaporuOlusturBtn.addEventListener('click', () => handleSutAlimRaporuOlustur(false));
            sutRaporuTumunuGosterBtn.addEventListener('click', () => handleSutAlimRaporuOlustur(true));
            sutRaporuYazdirBtn.addEventListener('click', () => handleYazdir('sut-alim-raporu'));
            yemRaporuOlusturBtn.addEventListener('click', handleYemKarRaporuOlustur);
            yemRaporuYazdirBtn.addEventListener('click', () => handleYazdir('aylik-yem-raporu'));
        });

        function loadInitialData() {
            const c1_id = generateId(); const c2_id = generateId(); const c3_id = generateId();
            db_cariler = [ {id: c1_id, kodu: 'C001', adiSoyadi: 'A Ticaret A.Ş.', kategori: 'A Köyü', durum: 'aktif', telefon: '05429876543'}, {id: c2_id, kodu: 'C002', adiSoyadi: 'B Marketleri Ltd.', kategori: 'Merkez', durum: 'pasif', telefon: '02321112233'}, {id: c3_id, kodu: 'C003', adiSoyadi: 'Cemil Çiftçi', kategori: 'A Köyü', durum: 'aktif', telefon: '05321234567'} ];
            db_cariKategorileri = [ {id: generateId(), ad: 'A Köyü'}, {id: generateId(), ad: 'B Mahallesi'}, {id: generateId(), ad: 'Merkez'} ];
            const y1_id = generateId(); const y2_id = generateId();
            db_yemler = [ {id: y1_id, kod: 'YEM001', ad: 'Süt Yemi Standart', stokMiktari: 50, alisFiyati: 580, satisFiyati: 650, birim: 'Çuval'}, {id: y2_id, kod: 'YEM002', ad: 'Buzağı Başlangıç Yemi', stokMiktari: 30, alisFiyati: 650, satisFiyati: 720, birim: 'Çuval'} ];
            const today = getTodayForInput();
            db_sutAlimlari = [ {id:generateId(), tarih: today, cariId: c1_id, cariAdi: 'A Ticaret A.Ş.', sabahLitre: 40, aksamLitre: 50, birimFiyat: 15.50, toplamLitre: 90, toplamTutar: 1395.00}, {id:generateId(), tarih: '2025-06-11', cariId: c1_id, cariAdi: 'A Ticaret A.Ş.', sabahLitre: 30, aksamLitre: 35, birimFiyat: 15.00, toplamLitre: 65, toplamTutar: 975.00}, {id:generateId(), tarih: today, cariId: c3_id, cariAdi: 'Cemil Çiftçi', sabahLitre: 100, aksamLitre: 110, birimFiyat: 15.50, toplamLitre: 210, toplamTutar: 3255.00} ];
            db_yemSatislari = [ {id: generateId(), tarih: today, cariId: c1_id, cariAdi: 'A Ticaret A.Ş.', yemId: y1_id, yemAdi: 'Süt Yemi Standart', miktar: 10, birimFiyat: 650.00, toplamTutar: 6500.00 }, {id: generateId(), tarih: today, cariId: c1_id, cariAdi: 'A Ticaret A.Ş.', yemId: y2_id, yemAdi: 'Buzağı Başlangıç Yemi', miktar: 5, birimFiyat: 700.00, toplamTutar: 3500.00 }, {id: generateId(), tarih: today, cariId: c2_id, cariAdi: 'B Marketleri Ltd.', yemId: y1_id, yemAdi: 'Süt Yemi Standart', miktar: 20, birimFiyat: 650.00, toplamTutar: 13000.00 } ];
            db_tedarikciOdemeleri = [ {id: generateId(), tarih: '2025-06-10', cariId: c1_id, cariAdi: 'A Ticaret A.Ş.', tutar: 300.00, odemeTuru: 'Avans', aciklama: 'Haziran avansı'} ];
            db_yemAlimlari = [ {id:generateId(), tarih:today, cariId: c2_id, cariAdi:'B Marketleri Ltd.', yemId: y1_id, yemAdi:'Süt Yemi Standart', miktar:10, birimFiyat:580, toplamTutar:5800} ];
        }

        function renderAllLists() { renderCariListesi(); populateCariKategoriFiltre(); populateCariKategoriSelect(topluGirisKategori); renderTopluSutGirisFormu(); renderSutAlimGecmisi(); renderYemStokListesi(); renderYemAlisHareketListesi(); renderYemSatisListesi(); renderTedarikciOdemeListesi(); renderCariKategoriListesi(); updateDashboardStats(); renderGenelBakiyeOzeti(); }
        function updateDashboardStats() { totalCari.textContent = db_cariler.length; totalYemCesidi.textContent = db_yemler.length; const todayStr = getTodayForInput(); const todaySutAlimCount = db_sutAlimlari.filter(sa => sa.tarih === todayStr).length; todaySutAlim.textContent = todaySutAlimCount;}
        function handleCariKaydet(event) { event.preventDefault(); const formData = { id: editingCariId || generateId(), kodu: document.getElementById('cariKodu').value, adiSoyadi: document.getElementById('cariAdiSoyadi').value, kategori: document.getElementById('cariKategori').value, durum: document.getElementById('cariDurum').value, telefon: document.getElementById('cariTelefon').value, eposta: document.getElementById('cariEposta').value, adres: document.getElementById('cariAdres').value, bankaAdi: document.getElementById('cariBankaAdi').value, iban: document.getElementById('cariIban').value, vergiDairesi: document.getElementById('cariVergiDairesi').value, vergiNo: document.getElementById('cariVergiNo').value, notlar: document.getElementById('cariNotlar').value, }; if (editingCariId) { const index = db_cariler.findIndex(c => c.id === editingCariId); if (index > -1) db_cariler[index] = formData; } else { db_cariler.push(formData); } renderAllLists(); resetCariForm(); }
        
        function renderCariListesi() {
            const searchTerm = cariSearchInput.value.toLowerCase();
            const kategori = cariKategoriFiltre.value;
            let filteredData = db_cariler;
            if (kategori) {
                filteredData = filteredData.filter(c => c.kategori === kategori);
            }
            if (searchTerm) {
                filteredData = filteredData.filter(c => c.kodu?.toLowerCase().includes(searchTerm) || c.adiSoyadi?.toLowerCase().includes(searchTerm));
            }
            cariListesiBody.innerHTML = '';
            cariListesiFooter.innerHTML = '';
            let toplamAlacak = 0;
            let toplamBorc = 0;
            filteredData.sort((a,b) => a.adiSoyadi.localeCompare(b.adiSoyadi)).forEach(c => {
                const row = cariListesiBody.insertRow();
                const bakiyeDetay = calculateCariBakiyeDetayli(c.id);
                toplamAlacak += bakiyeDetay.alacak;
                toplamBorc += bakiyeDetay.borc;
                const bakiye = bakiyeDetay.bakiye;
                const durumText = c.durum === 'aktif' ? 'Aktif' : 'Pasif';
                const durumStyle = c.durum === 'aktif' ? 'color:green;' : 'color:red;';
                const bakiyeStyle = bakiye >= 0 ? 'color:green;' : 'color:red;';
                const bakiyeText = `${formatCurrency(bakiye)} ${bakiye >= 0 ? '(Alacaklı)' : '(Borçlu)'}`;
                row.innerHTML = `<td>${c.kodu || ''}</td><td>${c.adiSoyadi || ''}</td><td>${c.kategori || ''}</td><td style="${durumStyle}">${durumText}</td><td>${c.telefon || ''}</td><td style="${bakiyeStyle}">${bakiyeText}</td><td class="dont-print"><button class="btn btn-edit btn-sm" onclick="editCari('${c.id}')">Düzenle</button><button class="btn btn-delete btn-sm" onclick="deleteCari('${c.id}')">Sil</button></td>`;
            });

            if (filteredData.length > 0) {
                const footerRow = cariListesiFooter.insertRow();
                const toplamBakiye = toplamAlacak - toplamBorc;
                const toplamBakiyeStyle = toplamBakiye >= 0 ? 'color:green;' : 'color:red;';
                const etiket = kategori ? `Kategori Toplamı ('${kategori}')` : 'Genel Toplam';
                footerRow.innerHTML = `<td colspan="5"><strong>${etiket} | Toplam Alacak: ${formatCurrency(toplamAlacak)} | Toplam Borç: ${formatCurrency(toplamBorc)}</strong></td><td style="${toplamBakiyeStyle}"><strong>${formatCurrency(toplamBakiye)}</strong></td><td class="dont-print"></td>`;
            }
        }
        
        function renderGenelBakiyeOzeti() {
            let genelToplamAlacak = 0;
            let genelToplamBorc = 0;
            db_cariler.forEach(cari => {
                const bakiyeDetay = calculateCariBakiyeDetayli(cari.id);
                genelToplamAlacak += bakiyeDetay.alacak;
                genelToplamBorc += bakiyeDetay.borc;
            });
            const genelBakiye = genelToplamAlacak - genelToplamBorc;
            document.getElementById('genelToplamAlacak').textContent = formatCurrency(genelToplamAlacak);
            document.getElementById('genelToplamBorc').textContent = formatCurrency(genelToplamBorc);
            const genelBakiyeElement = document.getElementById('genelToplamBakiye');
            genelBakiyeElement.textContent = formatCurrency(genelBakiye);
            genelBakiyeElement.style.color = genelBakiye >= 0 ? 'green' : 'red';
            genelBakiyeElement.style.fontWeight = 'bold';
        }

        function editCari(id) { const cari = db_cariler.find(c => c.id === id); if (!cari) return; editingCariId = id; document.getElementById('cariEditId').value = id; document.getElementById('cariKodu').value = cari.kodu || ''; document.getElementById('cariAdiSoyadi').value = cari.adiSoyadi || ''; document.getElementById('cariKategori').value = cari.kategori || ''; document.getElementById('cariDurum').value = cari.durum || 'aktif'; document.getElementById('cariTelefon').value = cari.telefon || ''; document.getElementById('cariEposta').value = cari.eposta || ''; document.getElementById('cariAdres').value = cari.adres || ''; document.getElementById('cariBankaAdi').value = cari.bankaAdi || ''; document.getElementById('cariIban').value = cari.iban || ''; document.getElementById('cariVergiDairesi').value = cari.vergiDairesi || ''; document.getElementById('cariVergiNo').value = cari.vergiNo || ''; document.getElementById('cariNotlar').value = cari.notlar || ''; setEditingMode(cariFormBaslik, cariKaydetBtn, cariFormTemizleBtn, editingCariId, 'Cari Kart');}
        function deleteCari(id) { if (confirm('Bu cariyi silmek istediğinizden emin misiniz? İlgili tüm kayıtları silinecektir!')) { db_cariler = db_cariler.filter(c => c.id !== id); db_sutAlimlari = db_sutAlimlari.filter(sa => sa.cariId !== id); db_yemSatislari = db_yemSatislari.filter(ys => ys.cariId !== id); db_tedarikciOdemeleri = db_tedarikciOdemeleri.filter(o => o.cariId !== id); renderAllLists(); if (editingCariId === id) resetCariForm(); }}
        function resetCariForm(){ cariForm.reset(); editingCariId = null; document.getElementById('cariEditId').value = ''; setEditingMode(cariFormBaslik, cariKaydetBtn, cariFormTemizleBtn, null, 'Cari Kart');}
        function handleCariKategoriEkle(event) { event.preventDefault(); const yeniAd = yeniCariKategoriAdiInput.value.trim(); if (yeniAd === '') { alert('Kategori/Köy adı boş olamaz.'); return; } if (db_cariKategorileri.some(kat => kat.ad.toLowerCase() === yeniAd.toLowerCase())) { alert('Bu kategori/köy zaten mevcut.'); return; } db_cariKategorileri.push({ id: generateId(), ad: yeniAd }); renderCariKategoriListesi(); populateCariKategoriSelect(cariKategori); populateCariKategoriFiltre(); populateCariKategoriSelect(topluGirisKategori); yeniCariKategoriAdiInput.value = ''; }
        function renderCariKategoriListesi() { if(!cariKategoriListesiUl) return; cariKategoriListesiUl.innerHTML = ''; if (db_cariKategorileri.length === 0) { cariKategoriListesiUl.innerHTML = '<li>Tanımlı kategori/köy bulunmuyor.</li>'; return; } db_cariKategorileri.sort((a, b) => a.ad.localeCompare(b.ad)).forEach(kat => { const li = document.createElement('li'); li.textContent = kat.ad; const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Sil'; deleteBtn.classList.add('btn', 'btn-delete', 'btn-sm', 'dont-print'); deleteBtn.onclick = function() { deleteCariKategori(kat.id); }; li.appendChild(deleteBtn); cariKategoriListesiUl.appendChild(li); });}
        function deleteCariKategori(idToDelete) { if (confirm('Bu kategoriyi/köyü silmek istediğinizden emin misiniz?')) { db_cariKategorileri = db_cariKategorileri.filter(kat => kat.id !== idToDelete); renderCariKategoriListesi(); populateCariKategoriSelect(cariKategori); populateCariKategoriFiltre(); populateCariKategoriSelect(topluGirisKategori);}}
        function populateCariKategoriFiltre() { const selectElement = cariKategoriFiltre; const currentValue = selectElement.value; selectElement.innerHTML = `<option value="">Tüm Kategoriler</option>`; db_cariKategorileri.sort((a, b) => a.ad.localeCompare(b.ad)).forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); selectElement.value = currentValue; }
        function populateCariKategoriSelect(selectElement) { if(!selectElement) return; const currentValue = selectElement.value; selectElement.innerHTML = `<option value="">Seçiniz...</option>`; db_cariKategorileri.sort((a, b) => a.ad.localeCompare(b.ad)).forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); if (db_cariKategorileri.some(kat => kat.ad === currentValue)) { selectElement.value = currentValue; } }
        function populateCariSelect(selectElement, defaultText = "Seçiniz...") { if(!selectElement) return; const currentValue = selectElement.value; selectElement.innerHTML = ''; const firstOption = document.createElement('option'); firstOption.value = ""; firstOption.textContent = defaultText; selectElement.appendChild(firstOption); db_cariler.filter(c => c.durum === 'aktif').sort((a,b) => a.adiSoyadi.localeCompare(b.adiSoyadi)).forEach(c => { const option = document.createElement('option'); option.value = c.id; option.textContent = `${c.adiSoyadi} (${c.kodu || 'Kodsuz'})`; selectElement.appendChild(option); }); if (db_cariler.find(c => c.id === currentValue)) { selectElement.value = currentValue; }}
        function renderTopluSutGirisFormu() { if (!db_cariler) return; const tarih = topluGirisTarihInput.value; const kategori = topluGirisKategoriSelect.value; const alan = document.getElementById('topluSutGirisTablosuAlani'); const yokMesaji = document.getElementById('topluGirisTedarikciYokMesaji'); const girisYapilmisCariIdleri = db_sutAlimlari.filter(sa => sa.tarih === tarih).map(sa => sa.cariId); let filtrelenmisCariler = db_cariler.filter(c => c.durum === 'aktif' && (kategori === "" || c.kategori === kategori) && !girisYapilmisCariIdleri.includes(c.id)); alan.innerHTML = ''; if (filtrelenmisCariler.length === 0) { yokMesaji.style.display = 'block'; return; } yokMesaji.style.display = 'none'; const tablo = document.createElement('table'); tablo.id = 'topluSutGirisTablosu'; tablo.innerHTML = `<thead><tr><th>Cari</th><th>Akşam (Lt)</th><th>Sabah (Lt)</th><th>Toplam Lt</th><th>Fiyat</th><th>Tutar</th><th>İşlem</th></tr></thead><tbody></tbody>`; const tbody = tablo.querySelector('tbody'); filtrelenmisCariler.sort((a,b) => a.adiSoyadi.localeCompare(b.adiSoyadi)).forEach(cari => { const row = tbody.insertRow(); row.dataset.cariId = cari.id; row.innerHTML = `<td>${cari.adiSoyadi}</td><td><input type="number" class="aksam-input" step="0.1" min="0" placeholder="0.0"></td><td><input type="number" class="sabah-input" step="0.1" min="0" placeholder="0.0"></td><td class="toplam-litre-hucre">0.0</td><td><input type="number" class="fiyat-input" value="${globalSettings.defaultMilkPrice.toFixed(2)}" step="0.01" min="0"></td><td class="tutar-hucre">0.00 TL</td><td><button class="btn btn-sm dont-print" onclick="handleTopluGirisKaydet('${cari.id}')">Kaydet</button></td>`; }); alan.appendChild(tablo); tablo.querySelectorAll('.sabah-input, .aksam-input, .fiyat-input').forEach(input => { input.addEventListener('input', handleTopluGirisHesaplama); });}
        function handleTopluGirisHesaplama(event) { const row = event.target.closest('tr'); if (!row) return; const sabahLt = parseFloat(row.querySelector('.sabah-input').value) || 0; const aksamLt = parseFloat(row.querySelector('.aksam-input').value) || 0; const fiyat = parseFloat(row.querySelector('.fiyat-input').value) || 0; const toplamLitre = sabahLt + aksamLt; const toplamTutar = toplamLitre * fiyat; row.querySelector('.toplam-litre-hucre').textContent = toplamLitre.toFixed(1); row.querySelector('.tutar-hucre').textContent = formatCurrency(toplamTutar); }
        function handleTopluGirisKaydet(cariId) { const row = document.querySelector(`#topluSutGirisTablosuAlani tr[data-cari-id='${cariId}']`); if (!row) return; const cari = db_cariler.find(c => c.id === cariId); const sabahLt = parseFloat(row.querySelector('.sabah-input').value) || 0; const aksamLt = parseFloat(row.querySelector('.aksam-input').value) || 0; const fiyat = parseFloat(row.querySelector('.fiyat-input').value) || 0; const tarih = document.getElementById('topluGirisTarih').value; if (sabahLt === 0 && aksamLt === 0) { alert("Lütfen en az bir süt miktarını giriniz."); return; } const yeniAlim = { id: generateId(), tarih: tarih, cariId: cariId, cariAdi: cari.adiSoyadi, sabahLitre: sabahLt, aksamLitre: aksamLt, toplamLitre: sabahLt + aksamLt, birimFiyat: fiyat, toplamTutar: (sabahLt + aksamLt) * fiyat }; db_sutAlimlari.push(yeniAlim); renderTopluSutGirisFormu(); renderSutAlimGecmisi(); renderCariListesi(); updateDashboardStats();}
        function deleteSutAlim(id) { if(confirm('Bu süt alım kaydını silmek istediğinizden emin misiniz?')){ db_sutAlimlari = db_sutAlimlari.filter(sa => sa.id !== id); renderTopluSutGirisFormu(); renderSutAlimGecmisi(); renderCariListesi(); updateDashboardStats();}}
        function handleYemTanimKaydet(event) { event.preventDefault(); const formData = { id: editingYemTanimId || generateId(), kod: document.getElementById('yemKodu').value.trim().toUpperCase(), ad: document.getElementById('yemAdi').value.trim(), kategori: document.getElementById('yemKategorisi').value, birim: document.getElementById('yemBirimi').value.trim() || 'Çuval', alisFiyati: parseFloat(document.getElementById('yemAlisFiyati').value) || 0, satisFiyati: parseFloat(document.getElementById('yemSatisFiyati').value) || 0, stokMiktari: editingYemTanimId ? (db_yemler.find(y=>y.id===editingYemTanimId)?.stokMiktari || 0) : 0 }; if (!formData.kod || !formData.ad) { alert('Yem Kodu ve Yem Adı boş bırakılamaz.'); return; } if (editingYemTanimId) { const existingYemWithSameCode = db_yemler.find(y => y.kod === formData.kod && y.id !== editingYemTanimId); if (existingYemWithSameCode) { alert('Bu yem kodu başka bir yem tarafından kullanılıyor.'); return; } const index = db_yemler.findIndex(y => y.id === editingYemTanimId); if (index > -1) db_yemler[index] = formData; } else { if (db_yemler.some(y => y.kod === formData.kod)) { alert('Bu yem kodu zaten kullanılıyor.'); return; } db_yemler.push(formData); } renderYemStokListesi(); populateYemSelect(yemSecimiAlis); populateYemSelect(yemSecimiSatis); resetYemTanimForm(); updateDashboardStats(); }
        function renderYemStokListesi() { yemStokListesiBody.innerHTML = ''; db_yemler.sort((a,b) => a.ad.localeCompare(b.ad)).forEach(y => { const row = yemStokListesiBody.insertRow(); row.innerHTML = `<td>${y.kod}</td><td>${y.ad}</td><td>${y.kategori}</td><td>${y.birim}</td><td>${formatCurrency(y.alisFiyati)}</td><td>${formatCurrency(y.satisFiyati)}</td><td>${y.stokMiktari}</td><td class="dont-print"><button class="btn btn-edit dont-print" onclick="editYemTanim('${y.id}')">Düzenle</button><button class="btn btn-delete dont-print" onclick="deleteYemTanim('${y.id}')">Sil</button></td>`; });}
        function editYemTanim(id) { const yem = db_yemler.find(y => y.id === id); if (!yem) return; editingYemTanimId = id; document.getElementById('yemKodu').value = yem.kod; document.getElementById('yemAdi').value = yem.ad; document.getElementById('yemKategorisi').value = yem.kategori; document.getElementById('yemBirimi').value = yem.birim; document.getElementById('yemAlisFiyati').value = yem.alisFiyati.toFixed(2); document.getElementById('yemSatisFiyati').value = yem.satisFiyati.toFixed(2); setEditingMode(yemTanimFormBaslik, yemTanimKaydetBtn, yemTanimFormTemizleBtn, editingYemTanimId, 'Yem Tanım');}
        function deleteYemTanim(id) { if (confirm('Bu yemi silmek istediğinizden emin misiniz? İlgili alış ve satış hareketleri de silinecektir!')) { db_yemler = db_yemler.filter(y => y.id !== id); db_yemAlimlari = db_yemAlimlari.filter(ya => ya.yemId !== id); db_yemSatislari = db_yemSatislari.filter(ys => ys.yemId !== id); renderAllLists(); if(editingYemTanimId === id) resetYemTanimForm(); }}
        function resetYemTanimForm() { yemTanimForm.reset(); editingYemTanimId = null; setEditingMode(yemTanimFormBaslik, yemTanimKaydetBtn, yemTanimFormTemizleBtn, null, 'Yem Tanım');}
        function handleYemAlisKaydet(event) { event.preventDefault(); const yemId = yemSecimiAlisSelect.value; const yem = db_yemler.find(y => y.id === yemId); if (!yem) { alert('Lütfen geçerli bir yem seçin.'); return; } const alinanMiktar = parseInt(document.getElementById('yemAlisMiktar').value) || 0; if (alinanMiktar <= 0) { alert('Alınan miktar pozitif olmalıdır.'); return; } const formData = { id: editingYemAlisId || generateId(), tarih: document.getElementById('yemAlisTarih').value, cariId: yemAlisTedarikciSelect.value, cariAdi: yemAlisTedarikciSelect.options[yemAlisTedarikciSelect.selectedIndex]?.text.split(' (')[0] || 'Bilinmiyor', yemId: yemId, yemAdi: yem.ad, miktar: alinanMiktar, birimFiyat: parseFloat(yemAlisBirimFiyatiInput.value) || 0, }; formData.toplamTutar = formData.miktar * formData.birimFiyat; if (editingYemAlisId) { const oldAlis = db_yemAlimlari.find(ya => ya.id === editingYemAlisId); if(oldAlis){ const eskiYemStok = db_yemler.find(y => y.id === oldAlis.yemId); if (eskiYemStok) eskiYemStok.stokMiktari -= oldAlis.miktar; } const index = db_yemAlimlari.findIndex(ya => ya.id === editingYemAlisId); if(index > -1) db_yemAlimlari[index] = formData; } else { db_yemAlimlari.push(formData); } yem.stokMiktari += formData.miktar; renderYemAlisHareketListesi(); renderYemStokListesi(); populateYemSelect(yemSecimiAlis); populateYemSelect(yemSecimiSatis); resetYemAlisForm(); }
        function renderYemAlisHareketListesi() { yemAlisHareketListesiBody.innerHTML = ''; db_yemAlimlari.sort((a,b) => new Date(b.tarih) - new Date(a.tarih)).forEach(ya => { const row = yemAlisHareketListesiBody.insertRow(); row.innerHTML = `<td>${formatDate(ya.tarih)}</td><td>${ya.yemAdi}</td><td>${ya.miktar}</td><td>${ya.cariAdi}</td><td>${formatCurrency(ya.birimFiyat)}</td><td>${formatCurrency(ya.toplamTutar)}</td><td class="dont-print"><button class="btn btn-edit dont-print" onclick="editYemAlis('${ya.id}')">Düzenle</button><button class="btn btn-delete dont-print" onclick="deleteYemAlis('${ya.id}')">Sil</button></td>`; });}
        function editYemAlis(id) { const yemAlis = db_yemAlimlari.find(ya => ya.id === id); if (!yemAlis) return; editingYemAlisId = id; document.getElementById('yemAlisTarih').value = yemAlis.tarih; yemAlisTedarikciSelect.value = yemAlis.cariId; yemSecimiAlisSelect.value = yemAlis.yemId; document.getElementById('yemAlisMiktar').value = yemAlis.miktar; yemAlisBirimFiyatiInput.value = yemAlis.birimFiyat.toFixed(2); handleYemAlisHesaplama(); setEditingMode(yemAlisFormBaslik, yemAlisKaydetBtn, yemAlisFormTemizleBtn, editingYemAlisId, 'Yem Alış');}
        function deleteYemAlis(id) { if (confirm('Bu yem alış kaydını silmek istediğinizden emin misiniz? Stok miktarı geri alınacaktır.')) { const index = db_yemAlimlari.findIndex(ya => ya.id === id); if (index > -1) { const yemAlisKaydi = db_yemAlimlari[index]; const yem = db_yemler.find(y => y.id === yemAlisKaydi.yemId); if (yem) yem.stokMiktari -= yemAlisKaydi.miktar; db_yemAlimlari.splice(index, 1); renderYemAlisHareketListesi(); renderYemStokListesi(); populateYemSelect(yemSecimiAlis); populateYemSelect(yemSecimiSatis); if (editingYemAlisId === id) resetYemAlisForm(); }}}
        function resetYemAlisForm() { yemAlisForm.reset(); editingYemAlisId = null; document.getElementById('yemAlisTarih').value = getTodayForInput(); handleYemAlisHesaplama(); setEditingMode(yemAlisFormBaslik, yemAlisKaydetBtn, yemAlisFormTemizleBtn, null, 'Yem Alış');}
        function handleYemAlisHesaplama() { const miktar = parseFloat(document.getElementById('yemAlisMiktar').value) || 0; const birimFiyat = parseFloat(document.getElementById('yemAlisBirimFiyati').value) || 0; document.getElementById('yemAlisToplamTutar').value = (miktar * birimFiyat > 0) ? formatCurrency(miktar * birimFiyat) : ''; } [document.getElementById('yemAlisMiktar'), document.getElementById('yemAlisBirimFiyati')].forEach(el => el?.addEventListener('input', handleYemAlisHesaplama));
        yemSecimiAlisSelect.addEventListener('change', function() { const yem = db_yemler.find(y => y.id === this.value); yemAlisBirimFiyatiInput.value = yem ? yem.alisFiyati.toFixed(2) : ''; handleYemAlisHesaplama(); });
        function handleYemSatisKaydet(event) { event.preventDefault(); const cariId = yemAlanTedarikciSelect.value; const yemId = yemSecimiSatisSelect.value; const yem = db_yemler.find(y => y.id === yemId); const cari = db_cariler.find(c => c.id === cariId); if (!yem) { alert('Lütfen geçerli bir yem seçin.'); return; } if (!cari) { alert('Lütfen geçerli bir cari seçin.'); return; } const satilanMiktar = parseInt(document.getElementById('yemSatisMiktar').value) || 0; if (satilanMiktar <= 0) { alert('Satılan miktar pozitif olmalıdır.'); return; } let izinVerilenSatisMiktari = yem.stokMiktari; if (editingYemSatisId) { const eskiSatis = db_yemSatislari.find(ys => ys.id === editingYemSatisId); if (eskiSatis?.yemId === yemId) { izinVerilenSatisMiktari += eskiSatis.miktar;} else if (eskiSatis?.yemId !== yemId) { const eskiYem = db_yemler.find(y_eski => y_eski.id === eskiSatis.yemId); if(eskiYem) eskiYem.stokMiktari += eskiSatis.miktar;}} if (satilanMiktar > izinVerilenSatisMiktari) { alert(`Yetersiz stok! ${yem.ad} için stok: ${yem.stokMiktari} ${yem.birim}.`); return; } const formData = { id: editingYemSatisId || generateId(), tarih: document.getElementById('yemSatisTarih').value, cariId: cariId, cariAdi: cari.adiSoyadi, yemId: yemId, yemAdi: yem.ad, miktar: satilanMiktar, birimFiyat: parseFloat(yemSatisBirimFiyatiInput.value) || 0, }; formData.toplamTutar = formData.miktar * formData.birimFiyat; if (editingYemSatisId) { const index = db_yemSatislari.findIndex(ys => ys.id === editingYemSatisId); if(index > -1) db_yemSatislari[index] = formData; } else { db_yemSatislari.push(formData); } yem.stokMiktari = izinVerilenSatisMiktari - formData.miktar; renderYemSatisListesi(); renderCariListesi(); renderYemStokListesi(); populateYemSelect(yemSecimiAlis); populateYemSelect(yemSecimiSatis); resetYemSatisForm(); }
        function renderYemSatisListesi() { yemSatisListesiBody.innerHTML = ''; db_yemSatislari.sort((a,b) => new Date(b.tarih) - new Date(a.tarih)).forEach(ys => { const row = yemSatisListesiBody.insertRow(); row.innerHTML = `<td>${formatDate(ys.tarih)}</td><td>${ys.cariAdi}</td><td>${ys.yemAdi}</td><td>${ys.miktar}</td><td>${formatCurrency(ys.birimFiyat)}</td><td>${formatCurrency(ys.toplamTutar)}</td><td class="dont-print"><button class="btn btn-edit dont-print" onclick="editYemSatis('${ys.id}')">Düzenle</button><button class="btn btn-delete dont-print" onclick="deleteYemSatis('${ys.id}')">Sil</button></td>`; });}
        function editYemSatis(id) { const yemSatis = db_yemSatislari.find(ys => ys.id === id); if (!yemSatis) return; editingYemSatisId = id; document.getElementById('yemSatisTarih').value = yemSatis.tarih; yemAlanTedarikciSelect.value = yemSatis.cariId; yemSecimiSatisSelect.value = yemSatis.yemId; document.getElementById('yemSatisMiktar').value = yemSatis.miktar; yemSatisBirimFiyatiInput.value = yemSatis.birimFiyat.toFixed(2); handleYemSatisHesaplama(); setEditingMode(yemSatisFormBaslik, yemSatisKaydetBtn, yemSatisFormTemizleBtn, editingYemSatisId, 'Yem Satış');}
        function deleteYemSatis(id) { if (confirm('Bu yem satış kaydını silmek istediğinizden emin misiniz? Stok miktarı geri eklenecektir.')) { const index = db_yemSatislari.findIndex(ys => ys.id === id); if (index > -1) { const yemSatisKaydi = db_yemSatislari[index]; const yem = db_yemler.find(y => y.id === yemSatisKaydi.yemId); if (yem) yem.stokMiktari += yemSatisKaydi.miktar; db_yemSatislari.splice(index, 1); renderYemSatisListesi(); renderCariListesi(); renderYemStokListesi(); populateYemSelect(yemSecimiAlis); populateYemSelect(yemSecimiSatis); if (editingYemSatisId === id) resetYemSatisForm(); }}}
        function resetYemSatisForm() { yemSatisForm.reset(); editingYemSatisId = null; document.getElementById('yemSatisTarih').value = getTodayForInput(); handleYemSatisHesaplama(); setEditingMode(yemSatisFormBaslik, yemSatisKaydetBtn, yemSatisFormTemizleBtn, null, 'Yem Satış');}
        function handleYemSatisHesaplama() { const miktar = parseFloat(document.getElementById('yemSatisMiktar').value) || 0; const birimFiyat = parseFloat(document.getElementById('yemSatisBirimFiyati').value) || 0; document.getElementById('yemSatisToplamTutar').value = (miktar * birimFiyat > 0) ? formatCurrency(miktar * birimFiyat) : ''; } [document.getElementById('yemSatisMiktar'), document.getElementById('yemSatisBirimFiyati')].forEach(el => el?.addEventListener('input', handleYemSatisHesaplama));
        yemSecimiSatisSelect.addEventListener('change', function() { const yem = db_yemler.find(y => y.id === this.value); yemSatisBirimFiyatiInput.value = yem ? yem.satisFiyati.toFixed(2) : ''; handleYemSatisHesaplama(); });
        function handleTedarikciOdemeKaydet(event) { event.preventDefault(); const cariId = odemeYapilanTedarikciSelect.value; const cari = db_cariler.find(c => c.id === cariId); if (!cari) { alert('Lütfen geçerli bir cari seçin.'); return; } const tutar = parseFloat(document.getElementById('odemeTutari').value); if (isNaN(tutar) || tutar <= 0) { alert('Lütfen geçerli bir ödeme tutarı girin.'); return; } const formData = { id: editingTedarikciOdemeId || generateId(), tarih: document.getElementById('odemeTarih').value, cariId: cariId, cariAdi: cari.adiSoyadi, tutar: tutar, odemeTuru: document.getElementById('odemeTuru').value, aciklama: document.getElementById('odemeAciklama').value.trim() }; if (editingTedarikciOdemeId) { const index = db_tedarikciOdemeleri.findIndex(o => o.id === editingTedarikciOdemeId); if (index > -1) db_tedarikciOdemeleri[index] = formData; } else { db_tedarikciOdemeleri.push(formData); } renderTedarikciOdemeListesi(); renderCariListesi(); resetTedarikciOdemeForm(); }
        function renderTedarikciOdemeListesi() { tedarikciOdemeListesiBody.innerHTML = ''; db_tedarikciOdemeleri.sort((a,b) => new Date(b.tarih) - new Date(a.tarih)).forEach(o => { const row = tedarikciOdemeListesiBody.insertRow(); const odemeTuruSelect = document.getElementById('odemeTuru'); const odemeTuruText = odemeTuruSelect.options[ [...odemeTuruSelect.options].findIndex(opt => opt.value === o.odemeTuru) ]?.text || o.odemeTuru; row.innerHTML = `<td>${formatDate(o.tarih)}</td><td>${o.cariAdi}</td><td>${formatCurrency(o.tutar)}</td><td>${odemeTuruText}</td><td>${o.aciklama}</td><td class="dont-print"><button class="btn btn-edit dont-print" onclick="editTedarikciOdeme('${o.id}')">Düzenle</button><button class="btn btn-delete dont-print" onclick="deleteTedarikciOdeme('${o.id}')">Sil</button></td>`; });}
        function editTedarikciOdeme(id) { const odeme = db_tedarikciOdemeleri.find(o => o.id === id); if (!odeme) return; editingTedarikciOdemeId = id; document.getElementById('odemeTarih').value = odeme.tarih; odemeYapilanTedarikciSelect.value = odeme.cariId; document.getElementById('odemeTutari').value = odeme.tutar.toFixed(2); document.getElementById('odemeTuru').value = odeme.odemeTuru; document.getElementById('odemeAciklama').value = odeme.aciklama; setEditingMode(tedarikciOdemeFormBaslik, tedarikciOdemeKaydetBtn, tedarikciOdemeFormTemizleBtn, editingTedarikciOdemeId, 'Cari Ödeme');}
        function deleteTedarikciOdeme(id) { if (confirm('Bu ödeme kaydını silmek istediğinizden emin misiniz?')) { db_tedarikciOdemeleri = db_tedarikciOdemeleri.filter(o => o.id !== id); renderTedarikciOdemeListesi(); renderCariListesi(); if (editingTedarikciOdemeId === id) resetTedarikciOdemeForm(); }}
        function resetTedarikciOdemeForm() { tedarikciOdemeForm.reset(); editingTedarikciOdemeId = null; document.getElementById('odemeTarih').value = getTodayForInput(); setEditingMode(tedarikciOdemeFormBaslik, tedarikciOdemeKaydetBtn, tedarikciOdemeFormTemizleBtn, null, 'Cari Ödeme');}
        function handleAyarlarKaydet(event) { event.preventDefault(); const yeniFiyat = parseFloat(varsayilanSutFiyatiInput.value); if (!isNaN(yeniFiyat) && yeniFiyat >= 0) { globalSettings.defaultMilkPrice = yeniFiyat; alert('Genel ayarlar kaydedildi.'); } else { alert('Lütfen geçerli bir süt fiyatı giriniz.'); }}
        function calculateCariBakiye(cariId, endDateStr = null) { const detay = calculateCariBakiyeDetayli(cariId, endDateStr); return detay.bakiye; }
        function calculateCariBakiyeDetayli(cariId, endDateStr = null) { let endDate = null; if (endDateStr) { endDate = new Date(endDateStr); endDate.setHours(23, 59, 59, 999); } let alacak = 0; db_sutAlimlari.filter(sa => sa.cariId === cariId && (!endDate || new Date(sa.tarih) <= endDate)).forEach(sa => { alacak += sa.toplamTutar; }); let borc = 0; db_yemSatislari.filter(ys => ys.cariId === cariId && (!endDate || new Date(ys.tarih) <= endDate)).forEach(ys => { borc += ys.toplamTutar; }); db_tedarikciOdemeleri.filter(o => o.cariId === cariId && (!endDate || new Date(o.tarih) <= endDate)).forEach(o => { borc += o.tutar; }); return { alacak, borc, bakiye: alacak - borc }; }
        function handleHesapOzetiRaporuOlustur() { const secilenCariId = raporCariSecimi.value; const secilenAyYil = raporTarihAraligi.value; if (!secilenAyYil || !secilenCariId) { alert("Lütfen bir cari ve ay seçiniz!"); return;} const [yil, ayStr] = secilenAyYil.split('-'); const ay = parseInt(ayStr); const cari = db_cariler.find(c => c.id === secilenCariId); if (!cari) { alert("Cari bulunamadı!"); return; } raporBaslik.textContent = `${cari.adiSoyadi} - ${ayStr}/${yil} Hesap Özeti`; const prevMonthLastDay = new Date(parseInt(yil), ay-1, 0).toISOString().split('T')[0]; const devredenBakiye = calculateCariBakiye(secilenCariId, prevMonthLastDay); let raporHtml = `<h5>Önceki Aydan Devreden Bakiye: <span class="${devredenBakiye >= 0 ? 'debit' : 'credit'}">${formatCurrency(devredenBakiye)} (${devredenBakiye >= 0 ? 'Alacaklı' : 'Borçlu'})</span></h5><hr>`; const ilgiliSutAlimlari = db_sutAlimlari.filter(sa => sa.cariId === secilenCariId && sa.tarih.startsWith(secilenAyYil)); let toplamSutAlimTutariAylik = 0; let toplamSutLitreAylik = 0; raporHtml += `<h5>Süt Alımları (Carinin Alacağı):</h5>`; if(ilgiliSutAlimlari.length > 0){ ilgiliSutAlimlari.forEach(sa => { toplamSutLitreAylik += sa.toplamLitre; toplamSutAlimTutariAylik += sa.toplamTutar; }); const ortalamaBirimFiyatAylik = toplamSutLitreAylik > 0 ? (toplamSutAlimTutariAylik / toplamSutLitreAylik) : 0; raporHtml += `<table border="1"><thead><tr><th>Aylık Toplam Süt Miktarı</th><th>Ortalama Birim Fiyat</th><th>Aylık Toplam Değer</th></tr></thead><tbody>`; raporHtml += `<tr><td>${toplamSutLitreAylik.toFixed(1)} Lt</td><td>${formatCurrency(ortalamaBirimFiyatAylik)}/Lt</td><td>${formatCurrency(toplamSutAlimTutariAylik)}</td></tr>`; raporHtml += `</tbody></table>`; } else { raporHtml += `<p>Bu ay için süt alım kaydı bulunamadı.</p>`; } raporHtml += `<strong>Aylık Toplam Süt Alım DEĞERİ: ${formatCurrency(toplamSutAlimTutariAylik)}</strong><hr>`; const ilgiliYemSatislari = db_yemSatislari.filter(ys => ys.cariId === secilenCariId && ys.tarih.startsWith(secilenAyYil)).sort((a,b) => new Date(a.tarih) - new Date(b.tarih)); let toplamYemSatisTutariAylik = 0; raporHtml += `<h5>Yem Satışları (Carinin Borcu):</h5>`; if(ilgiliYemSatislari.length > 0){ raporHtml += `<table border="1"><thead><tr><th>Tarih</th><th>Yem Adı</th><th>Miktar</th><th>Birim Fiyat</th><th>Tutar</th></tr></thead><tbody>`; ilgiliYemSatislari.forEach(ys => { const yem = db_yemler.find(y => y.id === ys.yemId); raporHtml += `<tr><td>${formatDate(ys.tarih)}</td><td>${ys.yemAdi}</td><td>${ys.miktar} ${yem?.birim || ''}</td><td>${formatCurrency(ys.birimFiyat)}</td><td>${formatCurrency(ys.toplamTutar)}</td></tr>`; toplamYemSatisTutariAylik += ys.toplamTutar; }); raporHtml += `</tbody></table>`; } else { raporHtml += `<p>Bu ay için yem satış kaydı bulunamadı.</p>`; } raporHtml += `<strong>Aylık Toplam Yem Satış Tutarı: ${formatCurrency(toplamYemSatisTutariAylik)}</strong><hr>`; const ilgiliOdemeler = db_tedarikciOdemeleri.filter(o => o.cariId === secilenCariId && o.tarih.startsWith(secilenAyYil)).sort((a,b) => new Date(a.tarih) - new Date(b.tarih)); let toplamOdemeTutariAylik = 0; raporHtml += `<h5>Yapılan Ödemeler (Carinin Alacağını Azaltan):</h5>`; if (ilgiliOdemeler.length > 0) { raporHtml += `<table border="1"><thead><tr><th>Tarih</th><th>Ödeme Türü</th><th>Açıklama</th><th>Tutar</th></tr></thead><tbody>`; const odemeTuruSelect = document.getElementById('odemeTuru'); ilgiliOdemeler.forEach(o => { const odemeTuruText = odemeTuruSelect.options[ [...odemeTuruSelect.options].findIndex(opt => opt.value === o.odemeTuru) ]?.text || o.odemeTuru; raporHtml += `<tr><td>${formatDate(o.tarih)}</td><td>${odemeTuruText}</td><td>${o.aciklama}</td><td>${formatCurrency(o.tutar)}</td></tr>`; toplamOdemeTutariAylik += o.tutar; }); raporHtml += `</tbody></table>`; } else { raporHtml += `<p>Bu ay için ödeme kaydı bulunamadı.</p>`; } raporHtml += `<strong>Aylık Toplam Ödeme Tutarı: ${formatCurrency(toplamOdemeTutariAylik)}</strong><hr>`; const cariAyNetDegisim = toplamSutAlimTutariAylik - toplamYemSatisTutariAylik - toplamOdemeTutariAylik; const donemSonuBakiye = devredenBakiye + cariAyNetDegisim; raporHtml += `<div class="calculation-example" style="margin-top:15px;"><p>Önceki Aydan Devir: <span class="${devredenBakiye >= 0 ? 'debit' : 'credit'}">${formatCurrency(devredenBakiye)}</span></p><p>+ Cari Ay Süt Alımları: <span class="debit">${formatCurrency(toplamSutAlimTutariAylik)}</span></p><p>- Cari Ay Yem Satışları: <span class="credit">${formatCurrency(toplamYemSatisTutariAylik)}</span></p><p>- Cari Ay Yapılan Ödemeler: <span class="credit">${formatCurrency(toplamOdemeTutariAylik)}</span></p><hr><p>DÖNEM SONU NET BAKİYE: <strong class="balance">${formatCurrency(donemSonuBakiye)} (${(donemSonuBakiye >= 0 ? 'Cari Alacaklı' : `Cari Borçlu`)})</strong></p></div>`; raporDetayAlani.innerHTML = raporHtml; }
        
        function handleSutAlimRaporuOlustur(tumu=false){
            const secilenAyYil = sutRaporuAySecimi.value;
            if (!secilenAyYil) { alert("Lütfen bir ay seçiniz!"); return; }

            let carilerToReport = [];
            if(tumu) {
                const ilgiliAlimlar = db_sutAlimlari.filter(sa => sa.tarih.startsWith(secilenAyYil));
                const cariIdler = [...new Set(ilgiliAlimlar.map(item => item.cariId))];
                carilerToReport = db_cariler.filter(c => cariIdler.includes(c.id));
                sutRaporuBaslik.textContent = `${secilenAyYil} Ayı Toplu Süt Alım Raporu`;
            } else {
                const secilenTedarikciId = sutRaporuTedarikciSecimi.value;
                if (!secilenTedarikciId) { alert("Lütfen bir cari seçiniz!"); return; }
                const cari = db_cariler.find(c => c.id === secilenTedarikciId);
                if (!cari) { alert("Seçilen cari bulunamadı!"); return; }
                carilerToReport.push(cari);
                sutRaporuBaslik.textContent = `${cari.adiSoyadi} - ${secilenAyYil} Süt Alım Detayları`;
            }

            sutRaporuDetayAlani.innerHTML = '';
            if(carilerToReport.length === 0) {
                sutRaporuDetayAlani.innerHTML = `<p>Seçili kriterlere uygun rapor bulunamadı.</p>`;
                return;
            }

            carilerToReport.forEach(cari => {
                const ilgiliSutAlimlari = db_sutAlimlari.filter(sa => sa.cariId === cari.id && sa.tarih.startsWith(secilenAyYil)).sort((a,b) => new Date(a.tarih) - new Date(b.tarih));
                if (ilgiliSutAlimlari.length > 0) {
                    let raporHtml = `<h5>${cari.adiSoyadi}</h5>`;
                    let genelToplamLitre = 0; let genelToplamTutar = 0;
                    raporHtml += `<table><thead><tr><th>Tarih</th><th>Akşam (Lt)</th><th>Sabah (Lt)</th><th>Günlük Toplam (Lt)</th><th>Birim Fiyat</th><th>Günlük Tutar</th></tr></thead><tbody>`; 
                    ilgiliSutAlimlari.forEach(sa => { raporHtml += `<tr><td>${formatDate(sa.tarih)}</td><td>${sa.aksamLitre.toFixed(1)}</td><td>${sa.sabahLitre.toFixed(1)}</td><td>${sa.toplamLitre.toFixed(1)}</td><td>${formatCurrency(sa.birimFiyat)}</td><td>${formatCurrency(sa.toplamTutar)}</td></tr>`; genelToplamLitre += sa.toplamLitre; genelToplamTutar += sa.toplamTutar; }); 
                    const genelOrtalamaFiyat = genelToplamLitre > 0 ? (genelToplamTutar / genelToplamLitre) : 0; 
                    raporHtml += `</tbody><tfoot><tr style="font-weight:bold;"><td>TOPLAM</td><td></td><td></td><td>${genelToplamLitre.toFixed(1)} Lt</td><td>${formatCurrency(genelOrtalamaFiyat)}</td><td>${formatCurrency(genelToplamTutar)}</td></tr></tfoot></table><hr>`;
                    sutRaporuDetayAlani.innerHTML += raporHtml;
                }
            });
        }
        
        function handleYemKarRaporuOlustur() {
            const secilenAyYil = yemRaporuAySecimi.value;
            if (!secilenAyYil) { alert("Lütfen bir ay seçiniz!"); return; }
            const ilgiliSatislar = db_yemSatislari.filter(satis => satis.tarih.startsWith(secilenAyYil));
            if (ilgiliSatislar.length === 0) { yemRaporuAlani.innerHTML = `<h4 class="print-only">Aylık Yem Satış Kârlılık Raporu (${secilenAyYil})</h4><p>Seçili ay için yem satış kaydı bulunamadı.</p>`; return; }
            const raporVerisi = {};
            ilgiliSatislar.forEach(satis => {
                const yem = db_yemler.find(y => y.id === satis.yemId);
                const maliyet = yem ? satis.miktar * yem.alisFiyati : 0;
                if (!raporVerisi[satis.cariId]) { raporVerisi[satis.cariId] = { musteriAdi: satis.cariAdi, toplamSatis: 0, toplamMaliyet: 0 }; }
                raporVerisi[satis.cariId].toplamSatis += satis.toplamTutar;
                raporVerisi[satis.cariId].toplamMaliyet += maliyet;
            });
            let genelToplamSatis = 0, genelToplamMaliyet = 0, genelNetKar = 0;
            let tableHTML = `<h4 class="print-only">Aylık Yem Satış Kârlılık Raporu (${secilenAyYil})</h4><table><thead><tr><th>Müşteri Adı</th><th>Toplam Satış Tutar</th><th>Satışların Maliyeti</th><th>NET KÂR / (ZARAR)</th></tr></thead><tbody>`;
            for (const cariId in raporVerisi) {
                const data = raporVerisi[cariId];
                const netKar = data.toplamSatis - data.toplamMaliyet;
                const karZararStyle = netKar >= 0 ? 'color:green;' : 'color:red;';
                genelToplamSatis += data.toplamSatis;
                genelToplamMaliyet += data.toplamMaliyet;
                genelNetKar += netKar;
                tableHTML += `<tr><td>${data.musteriAdi}</td><td>${formatCurrency(data.toplamSatis)}</td><td>${formatCurrency(data.toplamMaliyet)}</td><td style="${karZararStyle}">${formatCurrency(netKar)}</td></tr>`;
            }
            tableHTML += `</tbody><tfoot style="font-weight:bold; background-color:#e9ecef;"><tr><td>GENEL TOPLAM</td><td>${formatCurrency(genelToplamSatis)}</td><td>${formatCurrency(genelToplamMaliyet)}</td><td style="${genelNetKar >= 0 ? 'color:green;' : 'color:red;'}">${formatCurrency(genelNetKar)}</td></tr></tfoot></table>`;
            yemRaporuAlani.innerHTML = tableHTML;
        }

        function handleCariListeYazdir() {
            const kategoriFiltreElement = cariKategoriFiltre;
            const seciliKategoriText = kategoriFiltreElement.options[kategoriFiltreElement.selectedIndex].text;
            document.getElementById('cariListeRaporBaslik').textContent = `${seciliKategoriText} Cari Listesi`;
            handleYazdir('cari-yonetimi');
        }

        function handleYazdir(sectionId) {
            const sectionToPrint = document.getElementById(sectionId);
            const reportContent = sectionToPrint.querySelector('.printable-content, #cari-list-printable-area');

            if (!reportContent || reportContent.innerText.trim() === '' || reportContent.innerText.includes("Lütfen Rapor Kriterlerini Seçin")) {
                 if (sectionId !== 'cari-yonetimi') {
                    alert("Lütfen önce raporu oluşturun.");
                    return;
                }
            }
            bodyElement.classList.add('print-active');
            sectionToPrint.classList.add('print-section-active');
            window.print();
        }

        window.onafterprint = () => {
            bodyElement.classList.remove('print-active');
            document.querySelectorAll('.print-section-active').forEach(el => {
                el.classList.remove('print-section-active');
            });
        };

    </script>
</body>
</html>
