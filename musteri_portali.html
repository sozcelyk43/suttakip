<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Müşteri Süt Hareketleri</title>
  <meta name="theme-color" content="#2c3e50" />
<style>
    body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;line-height: 1.6;margin: 0;padding: 0;background-color: #f4f7f9;color: #333;}
    a.btn {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-content {padding: 20px;background-color: #ecf0f1;}
    .container {background-color: #fff;padding: 25px;border-radius: 8px;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);    }
    .module-header {background-color: #2c3e50;color: #fff;text-align: center;padding: 25px;border-radius: 8px;margin-bottom: 20px;}
    .module-header h2, .module-header h3 {margin: 0;}

    /* Filter/Button Layout Updated */
    .filter-buttons {display: flex;flex-direction: column;gap: 10px;margin-bottom: 20px;}
    .filter-row-top, .filter-row-bottom {display: grid; gap: 10px;}
    /* İsteğe göre güncellendi: Üstte 2, altta 3 öğe */
    .filter-row-top {grid-template-columns: 1fr 1fr;}
    .filter-row-bottom {grid-template-columns: 1fr 1fr 1fr;}

    .btn {display: inline-block;background-color: #3498db;color: #fff;padding: 12px;text-align: center;border: none;border-radius: 6px;
    	cursor: pointer;font-size: 1em;transition: background-color 0.2s;text-transform: uppercase; line-height: 1.2;}
    .btn:hover { background-color: #2980b9; }
    .btn-danger { background-color: #e74c3c; }
    .btn-danger:hover { background-color: #c0392b; }
    .btn-secondary {  color: #fff;  background-color: #95a5a6;}
    .btn-secondary:hover { background-color: #7f8c8d; }

    /* Table Layout Updated */
    table {width: 100%;border-collapse: collapse;margin-top: 20px;font-size: 0.95em;}
    th, td {padding: 12px 15px;border: 1px solid #ecf0f1;text-align: center;word-break: break-word;}
    th {background-color: #f8f9fa;font-weight: 600;color: #495057;}
    tbody tr:nth-child(odd) {background-color: #ffffff;}
    tbody tr:nth-child(even) {background-color: #f2f6fa;}
    tbody tr:hover { background-color: #f0f8ff; }
    tfoot tr {background-color: #e9ecef;font-weight: bold;color: #2c3e50;}

    select.form-control {padding: 12px;border-radius: 6px;border: 1px solid #ccc;font-size: 1em;background-color: #fff;}
    #logoutUserEmail {font-size: 0.75em;text-transform: lowercase;color: #ecf0f1; margin-top: 2px;}

    /* Yeni İstatistik Paneli Stilleri */
    .summary-stats {
      margin-top: 30px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    .summary-stats h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .summary-stats p {
      font-size: 1.1em;
      color: #333;
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
    }
    .summary-stats p span {
      font-weight: bold;
      color: #2980b9;
    }

    @media (max-width: 768px) {
      .container {padding: 15px;border-radius: 0;}
      .main-content {padding: 0;}
      .module-header {border-radius: 0;}
      /* Responsive Table Adjustments */
      table {font-size: 0.85em;}
      th, td {padding: 10px 4px;}
      .summary-stats p {font-size: 1em;}
    }
     @media (max-width: 480px) {
        .filter-row-top, .filter-row-bottom {
            grid-template-columns: 1fr; /* Stack all filter/button items vertically on very small screens */
        }
    }
</style>
</head>
<body>
  <div class="main-content">
    <div class="module-header">
      <h2>Müşteri Süt Hareketleri</h2>
      <h3>Hoş Geldiniz, <span id="musteriAdi">...</span></h3>
    </div>
    <div class="container">
      <div class="filter-buttons">
        <div class="filter-row-top">
          <a href="sifre_degistir.html" class="btn btn-secondary">Şifre Değiştir</a>
          <a href="#" id="logoutButton" class="btn btn-danger">
            <div>Çıkış Yap</div>
            <div id="logoutUserEmail"></div>
          </a>
        </div>
        <div class="filter-row-bottom">
          <select id="ayFiltresi" class="form-control"></select>
          <select id="yilFiltresi" class="form-control"></select>
          <button id="raporGosterBtn" class="btn">Göster</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>TARİH</th>
            <th>AKŞAM (LT)</th>
            <th>SABAH (LT)</th>
            <th>TOPLAM (LT)</th>
            <th>BİRİM FİYAT (TL)</th>
            <th>TOPLAM FİYAT (TL)</th>
          </tr>
        </thead>
        <tbody id="sutListesiBody">
          <tr><td colspan="6">Lütfen bir ay seçin.</td></tr>
        </tbody>
        <tfoot id="sutListesiFooter"></tfoot>
      </table>

      <div class="summary-stats">
        <h3>Genel İstatistikler</h3>
        <p>Güncel Dönem Toplam Litre: <span id="summaryTotalLitre">0.00</span></p>
        <p>Güncel Dönem Toplam Hasılat (TL): <span id="summaryTotalRevenue">0.00</span></p>
        <p>Güncel Dönem Günlük Ortalama (LT): <span id="summaryDailyAverage">0.00</span></p>
        <p>Toplam Aylık Ortalama (LT): <span id="overallMonthlyAverage">Hesaplanıyor...</span></p>
        <p>Toplam Yıllık Ortalama (LT): <span id="overallYearlyAverage">Hesaplanıyor...</span></p>
      </div>

    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
	const firebaseConfig = {
            apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
            authDomain: "sut-takip-projem.firebaseapp.com",
            projectId: "sut-takip-projem",
            storageBucket: "sut-takip-projem.appspot.com",
            messagingSenderId: "512756958486",
            appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
            measurementId: "G-LYLT9WFVNK"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let userCariId = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                const userEmailDiv = document.getElementById('logoutUserEmail');
                if (userEmailDiv) {
                    userEmailDiv.textContent = user.email;
                }

                db.collection('cariler').where('authUID', '==', user.uid).limit(1).get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        const cariDoc = snapshot.docs[0];
                        userCariId = cariDoc.id;
                        document.getElementById('musteriAdi').textContent = cariDoc.data().adiSoyadi;
                        
                        // Genel ortalamaları hesapla
                        calculateOverallAverages();

                        const aySelect = document.getElementById('ayFiltresi');
                        const yilSelect = document.getElementById('yilFiltresi');
                        const gosterBtn = document.getElementById('raporGosterBtn');
                        const now = new Date();

                        const ayIsimleri = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
                        ayIsimleri.forEach((ay, index) => {
                            const option = document.createElement('option');
                            option.value = String(index + 1).padStart(2, '0');
                            option.textContent = ay;
                            aySelect.appendChild(option);
                        });
                        aySelect.value = String(now.getMonth() + 1).padStart(2, '0');

                        for (let yil = 2050; yil >= 2000; yil--) {
                            const option = document.createElement('option');
                            option.value = yil;
                            option.textContent = yil;
                            yilSelect.appendChild(option);
                        }
                        yilSelect.value = now.getFullYear();

                        gosterBtn.addEventListener('click', () => {
                            const secilenAy = aySelect.value;
                            const secilenYil = yilSelect.value;
                            if (secilenAy && secilenYil && userCariId) {
                                const ayYil = `${secilenYil}-${secilenAy}`;
                                fetchSutHareketleri(ayYil);
                            }
                        });

                        gosterBtn.click();
                    } else {
                        alert("Bu hesaba bağlı bir müşteri kartı bulunamadı.");
                        handleLogout();
                    }
                })
                .catch(error => {
                    console.error("Müşteri bilgileri alınırken hata oluştu:", error);
                    alert("Müşteri bilgileri alınırken bir hata oluştu. Lütfen daha sonra tekrar deneyin.");
                    handleLogout();
                });

            } else {
               window.location.href = 'login.html';
            }
        });

	const logoutButton = document.getElementById('logoutButton');
	logoutButton.addEventListener('click', (event) => {
    	event.preventDefault();
    	handleLogout();
    });

    function handleLogout() {
        auth.signOut().then(() => {
            window.location.href = 'login.html';
        }).catch(error => console.error("Çıkış hatası:", error));
    }

    function resetSummaryStats() {
        document.getElementById('summaryTotalLitre').textContent = '0.00';
        document.getElementById('summaryTotalRevenue').textContent = '0.00';
        document.getElementById('summaryDailyAverage').textContent = '0.00';
    }

    async function fetchSutHareketleri(ayYil) {
        const [year, month] = ayYil.split('-');
        const startDate = `${year}-${month}-01`;
        const endDate = new Date(year, month, 0).toISOString().split('T')[0];
        
        const listBody = document.getElementById('sutListesiBody');
        const listFooter = document.getElementById('sutListesiFooter');
        listBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Veriler yükleniyor...</td></tr>`;
        listFooter.innerHTML = '';
        resetSummaryStats(); // Rapor gösterilmeden önce istatistikleri sıfırla

        try {
            const snapshot = await db.collection('sut_alimlari')
                .where('cariId', '==', userCariId)
                .where('tarih', '>=', startDate)
                .where('tarih', '<=', endDate)
                .orderBy('tarih', 'desc')
                .get();

            if (snapshot.empty) {
                listBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Bu dönem için süt kaydı bulunmuyor.</td></tr>`;
                return;
            }

            let rows = '';
            let donemToplamAksam = 0;
            let donemToplamSabah = 0;
            let donemToplamLitre = 0;
            let donemToplamHasiat = 0;

            snapshot.forEach(doc => {
                const data = doc.data();
                donemToplamAksam += data.aksam || 0;
                donemToplamSabah += data.sabah || 0;
                donemToplamLitre += data.toplam || 0;
                donemToplamHasiat += data.toplamTutar || 0;

                rows += `
                    <tr>
                        <td>${new Date(data.tarih + 'T00:00:00').toLocaleDateString('tr-TR')}</td>
                        <td>${(data.aksam || 0).toFixed(2)}</td>
                        <td>${(data.sabah || 0).toFixed(2)}</td>
                        <td><strong>${(data.toplam || 0).toFixed(2)}</strong></td>
                        <td>${(data.fiyat || 0).toFixed(2)}</td>
                        <td><strong>${(data.toplamTutar || 0).toFixed(2)}</strong></td>
                    </tr>
                `;
            });
            
            listBody.innerHTML = rows;
            const ortalamaBirimFiyat = donemToplamLitre > 0 ? (donemToplamHasiat / donemToplamLitre) : 0;
            const footerRow = `
                <tr class="report-totals-row">
                    <td><strong>DÖNEM TOPLAMI</strong></td>
                    <td><strong>${donemToplamAksam.toFixed(2)}</strong></td>
                    <td><strong>${donemToplamSabah.toFixed(2)}</strong></td>
                    <td><strong>${donemToplamLitre.toFixed(2)}</strong></td>
                    <td><strong>${ortalamaBirimFiyat.toFixed(2)}</strong></td>
                    <td><strong>${donemToplamHasiat.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} TL</strong></td>
                </tr>
            `;
            listFooter.innerHTML = footerRow;

            // İstatistik panelini güncelle
            const gunlukOrtalama = snapshot.size > 0 ? (donemToplamLitre / snapshot.size) : 0;
            document.getElementById('summaryTotalLitre').textContent = donemToplamLitre.toFixed(2);
            document.getElementById('summaryTotalRevenue').textContent = donemToplamHasiat.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('summaryDailyAverage').textContent = gunlukOrtalama.toFixed(2);


        } catch (error) {
            console.error("Süt hareketleri alınırken hata: ", error);
            listBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Veriler yüklenemedi.</td></tr>`;
        }
    }

    // Yeni Fonksiyon: Tüm zamanların aylık ve yıllık ortalamalarını hesaplar
    async function calculateOverallAverages() {
        const monthlyAvgElem = document.getElementById('overallMonthlyAverage');
        const yearlyAvgElem = document.getElementById('overallYearlyAverage');
        
        try {
            const snapshot = await db.collection('sut_alimlari')
                .where('cariId', '==', userCariId)
                .get();

            if (snapshot.empty) {
                monthlyAvgElem.textContent = '0.00';
                yearlyAvgElem.textContent = '0.00';
                return;
            }

            const monthlyTotals = {};
            const yearlyTotals = {};

            snapshot.forEach(doc => {
                const data = doc.data();
                const totalLiters = data.toplam || 0;
                const date = new Date(data.tarih + 'T00:00:00');
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const yearMonthKey = `${year}-${month}`;

                // Aylık toplamları hesapla
                monthlyTotals[yearMonthKey] = (monthlyTotals[yearMonthKey] || 0) + totalLiters;
                // Yıllık toplamları hesapla
                yearlyTotals[year] = (yearlyTotals[year] || 0) + totalLiters;
            });
            
            // Aylık Ortalamayı Hesapla
            const monthlyValues = Object.values(monthlyTotals);
            const monthlyAverage = monthlyValues.length > 0 
                ? monthlyValues.reduce((sum, current) => sum + current, 0) / monthlyValues.length 
                : 0;

            // Yıllık Ortalamayı Hesapla
            const yearlyValues = Object.values(yearlyTotals);
            const yearlyAverage = yearlyValues.length > 0 
                ? yearlyValues.reduce((sum, current) => sum + current, 0) / yearlyValues.length 
                : 0;

            monthlyAvgElem.textContent = monthlyAverage.toFixed(2);
            yearlyAvgElem.textContent = yearlyAverage.toFixed(2);

        } catch (error) {
            console.error("Genel ortalamalar hesaplanırken hata:", error);
            monthlyAvgElem.textContent = 'Hata!';
            yearlyAvgElem.textContent = 'Hata!';
        }
    }
  </script>
</body>
</html>