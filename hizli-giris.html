<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeliÅŸmiÅŸ SÃ¼t GiriÅŸi</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --light-color: #f8f9fa;
            --dark-color: #343a40; --border-color: #dee2e6; --white-color: #fff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: var(--light-color); color: var(--dark-color); }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        header { 
    background-color: var(--primary-color); 
    color: var(--white-color); 
    padding: 15px 20px; /* Kenar boÅŸluklarÄ±nÄ± biraz ayarladÄ±k */
    text-align: center; 
    border-bottom-left-radius: 15px; 
    border-bottom-right-radius: 15px; 
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

header h1 { 
    margin: 0; 
    font-size: 1.5em; /* Mobil iÃ§in biraz kÃ¼Ã§Ã¼lttÃ¼k */
}
        main { padding: 20px 0; }
        #logoutButton {
    position: static; 
    background-color: #e74c3c; 
    color: white;
    border: none;
    padding: 8px 12px; 
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8em; 
    font-weight: 500;
    transition: background-color 0.2s;
   
}
#logoutButton:hover {
    background-color: #c0392b;
}
}
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 1.1em; }
        .form-group select, .form-group input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .time-selection { display: flex; gap: 10px; }
        .time-selection input[type="radio"] { display: none; }
        .time-selection label { flex: 1; text-align: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; font-weight: 500; }
        .time-selection input[type="radio"]:checked + label { background-color: var(--primary-color); color: var(--white-color); border-color: var(--primary-color); }
        #producer-panel, #history-section { background-color: var(--white-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 25px; }
        #current-producer-name { font-size: 1.5em; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; text-align: center; }
        .action-buttons { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 25px; }
        .btn { padding: 15px; font-size: 1.1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        #session-summary { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        #history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { padding: 10px 0; border-bottom: 1px solid #f0f2f5; display: flex; align-items: center; gap: 10px; }
        .history-item-info { font-weight: 600; flex-grow: 1; }
        .history-item-details { text-align: right; }
.history-item .delete-btn {
    background-color: var(--danger-color);
    color: var(--white-color);
    padding: 8px 12px;
    font-size: 0.9em;
    flex-shrink: 0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
        .history-item .edit-btn { background-color: var(--warning-color); color: var(--dark-color); padding: 8px 12px; font-size: 0.9em; flex-shrink: 0; border-radius: 6px; border: none; cursor: pointer;}
        #cancel-edit-btn { display: none; margin-top: 10px; width: 100%; background-color: var(--danger-color); color: var(--white-color); }

/* === AKÅžAM/SABAH BUTONLARI (ON/OFF STÄ°LÄ°) === */

/* ButonlarÄ±n genel yerleÅŸimi ve geÃ§iÅŸ efekti */
.time-selection label {
    flex: 1;
    text-align: center;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    font-weight: 600; /* Metinler biraz daha okunaklÄ± olsun */
}

/* 1. SEÃ‡Ä°LÄ° OLMAYAN (OFF) BUTONUN STÄ°LÄ° */
.time-selection input:not(:checked) + label {
    background-color: #f8f9fa; /* Soluk, neredeyse beyaz bir arkaplan */
    border: 1px solid #dee2e6; /* Ä°nce, aÃ§Ä±k gri bir Ã§erÃ§eve */
    color: #6c757d;           /* Soluk metin rengi */
}
/* SeÃ§ili olmayan butonun Ã¼zerine gelince hafif bir tepki */
.time-selection input:not(:checked) + label:hover {
    background-color: #e9ecef;
    border-color: #adb5bd;
}


/* 2. SEÃ‡Ä°LÄ° OLAN (ON) BUTONUN STÄ°LÄ° */
.time-selection input:checked + label {
    color: white; /* SeÃ§iliyken metin rengi her zaman beyaz */
    font-weight: 700;
    transform: translateY(-2px); /* Hafif yukarÄ± kalkma efekti */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Belirgin bir gÃ¶lge */
    border: 2px solid rgba(0,0,0,0.1); /* Rengin etrafÄ±nda hafif bir derinlik */
}

/* SeÃ§ili olan AkÅŸam butonuna Ã¶zel renk */
.time-selection input[id="aksam"]:checked + label {
    background-color: #ff8c00; /* CanlÄ± Turuncu */
}

/* SeÃ§ili olan Sabah butonuna Ã¶zel renk */
.time-selection input[id="sabah"]:checked + label {
    background-color: #28a745; /* CanlÄ± YeÅŸil */
}

/* YENÄ° EKLENEN STÄ°L: Onay mesajÄ± iÃ§in */
.toast-message {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #28a745; /* YeÅŸil baÅŸarÄ± rengi */
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    z-index: 1000;
    font-size: 1.1em;
    font-weight: 500;
    display: none; /* VarsayÄ±lan olarak gizli */
    opacity: 0;
    transition: opacity 0.5s ease;
}
.toast-message.show {
    display: block;
    opacity: 1;
}


    </style>
</head>
<body>

	<div id="toast-message" class="toast-message"></div>
	<div class="container">
        <header><h1>GeliÅŸmiÅŸ SÃ¼t GiriÅŸi</h1><button id="logoutButton">ðŸšª Ã‡Ä±kÄ±ÅŸ Yap</button></header>
<main>
            <form id="setup-form" onsubmit="return false;">
                <input type="hidden" id="editingMovementId">
                <div class="form-group"><label for="collection-date">SÃ¼t AlÄ±m Tarihi</label><input type="date" id="collection-date" name="collection-date"></div>
                <div class="form-group"><label for="unit-price">SÃ¼t Birim FiyatÄ± (â‚º)</label><input type="number" id="unit-price" name="unit-price" step="0.01"></div>
                <div class="form-group"><label>Zaman</label><div class="time-selection"><input type="radio" id="aksam" name="time" value="akÅŸam" checked><label for="aksam">AKÅžAM</label><input type="radio" id="sabah" name="time" value="sabah"><label for="sabah">SABAH</label></div></div>
                <div class="form-group">
    		<label for="tank">Tank SeÃ§imi <button id="refresh-tanks-btn" title="Tank listesini yenile">ðŸ”„</button></label>
   			 <select id="tank" name="tank"></select>
    			<small id="tankMevcutLitre" style="display: block; margin-top: 8px; font-weight: 500; color: #007bff;"></small></div>
                <div class="form-group"><label for="category">Kategori/KÃ¶y (Rota)</label><select id="category" name="category"></select></div>
            </form>

            <div id="producer-panel" style="display: none;">
                <h2 id="current-producer-name">Ãœretici AdÄ±</h2>
                <div class="form-group"><label for="producer-select">Rota DÄ±ÅŸÄ± SeÃ§im / Ãœretici Atlama</label><select id="producer-select" name="producer-select"></select></div>
                <div class="form-group"><label for="quantity">Miktar (Litre)</label><input type="number" id="quantity" name="quantity" step="0.1" inputmode="decimal"></div>
                <div class="form-group"><label for="notes">AÃ§Ä±klama</label><textarea id="notes" name="notes" rows="3"></textarea></div>
                <div class="action-buttons"><button type="button" id="skip-btn" class="btn btn-secondary">Pas GeÃ§</button><button type="button" id="save-btn" class="btn btn-success">Kaydet ve Sonraki</button></div>
                <button type="button" id="cancel-edit-btn" class="btn">DÃ¼zenlemeyi Ä°ptal Et</button>
            </div>

            <section id="history-section" style="display: none;">
                <h2>SÃ¼t AlÄ±m GeÃ§miÅŸi (Bu Oturum)</h2><div id="session-summary"></div><ul id="history-list"></ul>
            </section>
        </main>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
            authDomain: "sut-takip-projem.firebaseapp.com",
            projectId: "sut-takip-projem",
            storageBucket: "sut-takip-projem.appspot.com",
            messagingSenderId: "512756958486",
            appId: "1:512756958486:web:13cceb6835e2c575e9fc37"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();document.getElementById('logoutButton').addEventListener('click', () => {auth.signOut().then(() => {window.location.href = 'login.html';}).catch(error => {console.error("Ã‡Ä±kÄ±ÅŸ yaparken hata oluÅŸtu:", error);    });
});
        const db = firebase.firestore();

        let sahipId = '';
        let currentUserRole = ''; 
        let routeProducers = [], collectionHistory = [];
        let currentProducerIndex = 0;
        let editingEntry = null;
        let tankDataMap = new Map(); 

        const collectionDateInput = document.getElementById('collection-date');
        const unitPriceInput = document.getElementById('unit-price');
        const tankSelect = document.getElementById('tank');
        const categorySelect = document.getElementById('category');
        const producerPanel = document.getElementById('producer-panel');
        const currentProducerName = document.getElementById('current-producer-name');
        const producerSelect = document.getElementById('producer-select');
        const quantityInput = document.getElementById('quantity');
        const notesInput = document.getElementById('notes');
        const saveBtn = document.getElementById('save-btn');
        const skipBtn = document.getElementById('skip-btn');
        const historySection = document.getElementById('history-section');
        const historyList = document.getElementById('history-list');
        const sessionSummary = document.getElementById('session-summary');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editingMovementIdInput = document.getElementById('editingMovementId');

        auth.onAuthStateChanged(user => {
            if (user) {
                // GÃœNCELLEME: KullanÄ±cÄ±nÄ±n rolÃ¼ de alÄ±nÄ±yor
                db.collection('kullanicilar').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        sahipId = userData.sahipId;
                        currentUserRole = userData.rol; // Rol bilgisi deÄŸiÅŸkene atanÄ±yor

                        if (sahipId) {
                            initializeApp();
                        } else {
                             alert("KullanÄ±cÄ± profili veya sahip bilgisi bulunamadÄ±.");
                             auth.signOut();
                        }
                    } else {
                        alert("KullanÄ±cÄ± profili bulunamadÄ±.");
                        auth.signOut();
                    }
                });
            } else { window.location.href = 'login.html'; }
        });

        async function initializeApp() {
            collectionDateInput.value = new Date().toISOString().split('T')[0];
            const settings = await getSettings();
            unitPriceInput.value = settings.defaultMilkPrice ? settings.defaultMilkPrice.toFixed(2) : "15.50";

            await Promise.all([populateTanks(), populateCategories()]);
            document.getElementById('refresh-tanks-btn').addEventListener('click', populateTanks);

            categorySelect.addEventListener('change', startRoute);
            producerSelect.addEventListener('change', jumpToProducer);
            saveBtn.addEventListener('click', handleSave);
            skipBtn.addEventListener('click', handleSkip);
            cancelEditBtn.addEventListener('click', cancelEditMode);
            tankSelect.addEventListener('change', (e) => updateTankInfoDisplay(e.target.value));
            [collectionDateInput, ...document.querySelectorAll('input[name="time"]')].forEach(el => {
                el.addEventListener('change', () => { if (categorySelect.value) startRoute(); });
            });
        }
        
      async function getSettings() {
    if (!sahipId) return {};
    try {
        const doc = await db.collection('ayarlar').doc(sahipId).get();
        return doc.exists ? doc.data() : {};
    } catch (e) {
        console.error("Ayarlar alÄ±namadÄ±:", e);
        return {};
    }
}


function getDayDifference(dateStr) {
    const today = new Date();
    const entryDate = new Date(dateStr);

    // Saat dilimi farklarÄ±ndan kaynaklanabilecek hatalarÄ± Ã¶nlemek iÃ§in saatleri sÄ±fÄ±rla
    today.setHours(0, 0, 0, 0);
    entryDate.setHours(0, 0, 0, 0);

    const diffTime = today - entryDate; // Ä°ki tarih arasÄ±ndaki fark (milisaniye)
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // FarkÄ± gÃ¼ne Ã§evir
    
    return diffDays;
}


async function saveMilkEntry(quantity, notes) {
    const unitPrice = parseFloat(unitPriceInput.value);
    const tankId = tankSelect.value;
    const alimTarihi = collectionDateInput.value;
    const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
    const currentProducer = routeProducers[currentProducerIndex];

    if (!unitPrice || !tankId || !alimTarihi) {
        alert('LÃ¼tfen Fiyat, Tarih ve Tank seÃ§imlerini doÄŸru yapÄ±n.');
        return;
    }

    const tankRef = db.collection('tanklar').doc(tankId);

    saveBtn.disabled = true;
    skipBtn.disabled = true;

    try {
        // MÃ¼kerrer KayÄ±t Engelleme KontrolÃ¼
        const existingMovementSnapshot = await db.collection('tank_hareketleri')
            .where('sahipId', '==', sahipId)
            .where('ureticiId', '==', currentProducer.id)
            .where('alim_tarihi', '==', alimTarihi)
            .where('zaman_dilimi', '==', zamanDilimi)
            .limit(1).get();

        if (!existingMovementSnapshot.empty) {
            alert("Hata: Bu Ã¼retici iÃ§in bu zaman diliminde zaten bir sÃ¼t giriÅŸi yapÄ±lmÄ±ÅŸ!");
            saveBtn.disabled = false;
            skipBtn.disabled = false;
            return;
        }

        // %20'lik DeÄŸiÅŸim UyarÄ±sÄ±
        if (quantity > 0) {
            // HATA DÃœZELTMESÄ°: Saat dilimi sorununu Ã¶nlemek iÃ§in dÃ¼nÃ¼n tarihi
            // yerel saate gÃ¶re doÄŸru formatta (YYYY-AA-GG) oluÅŸturuluyor.
            const todayForCalc = new Date(alimTarihi);
            const yesterdayForCalc = new Date(todayForCalc);
            yesterdayForCalc.setDate(todayForCalc.getDate() - 1);
            
            const year = yesterdayForCalc.getFullYear();
            const month = String(yesterdayForCalc.getMonth() + 1).padStart(2, '0');
            const day = String(yesterdayForCalc.getDate()).padStart(2, '0');
            const yesterdayStr = `${year}-${month}-${day}`;
            // DÃ¼zeltme Sonu

            const dunkuSutSnapshot = await db.collection('sut_alimlari')
                .where('sahipId', '==', sahipId)
                .where('cariId', '==', currentProducer.id)
                .where('tarih', '==', yesterdayStr) // ArtÄ±k doÄŸru tarihi sorguluyor
                .limit(1).get();
            
            if (!dunkuSutSnapshot.empty) {
                const dunkuData = dunkuSutSnapshot.docs[0].data();
                const dunkuIlgiliMiktar = dunkuData[zamanDilimi] || 0;

                if (dunkuIlgiliMiktar > 0) {
                    const altLimit = dunkuIlgiliMiktar * 0.80;
                    const ustLimit = dunkuIlgiliMiktar * 1.20;

                    if (quantity < altLimit || quantity > ustLimit) {
                        const durum = quantity > dunkuIlgiliMiktar ? 'daha fazla' : 'daha az';
                        const onay = confirm(`âš ï¸ DÄ°KKAT! \n\nGirilen miktar (${quantity.toFixed(1)} Lt), dÃ¼nkÃ¼ ${zamanDilimi} miktarÄ±ndan (${dunkuIlgiliMiktar.toFixed(1)} Lt) %20 oranÄ±nda ${durum}.\n\nBu miktar doÄŸru mu? Kaydetmek iÃ§in 'Tamam'a basÄ±n.`);
                        if (!onay) {
                            saveBtn.disabled = false;
                            skipBtn.disabled = false;
                            return;
                        }
                    }
                }
            }
        }

        // Kaydetme iÅŸlemi (Bu kÄ±sÄ±mda deÄŸiÅŸiklik yok)
        const totalPrice = (quantity * unitPrice);
        const movementRef = db.collection('tank_hareketleri').doc();
        const batch = db.batch();

        const sutAlimQuery = db.collection('sut_alimlari').where('sahipId', '==', sahipId).where('cariId', '==', currentProducer.id).where('tarih', '==', alimTarihi);
        const existingSutAlimSnapshot = await sutAlimQuery.get();
        let sutAlimRef;
        if (existingSutAlimSnapshot.empty) {
            sutAlimRef = db.collection('sut_alimlari').doc();
            const sutData = { tarih: alimTarihi, cariId: currentProducer.id, cariAdi: currentProducer.adiSoyadi, sabah: (zamanDilimi === 'sabah' ? quantity : 0), aksam: (zamanDilimi === 'akÅŸam' ? quantity : 0), toplam: quantity, fiyat: unitPrice, toplamTutar: totalPrice, sahipId: sahipId };
            batch.set(sutAlimRef, sutData);
        } else {
            const doc = existingSutAlimSnapshot.docs[0];
            sutAlimRef = doc.ref;
            const data = doc.data();
            const newSabah = (zamanDilimi === 'sabah') ? quantity : (data.sabah || 0);
            const newAksam = (zamanDilimi === 'akÅŸam') ? quantity : (data.aksam || 0);
            const newToplam = newSabah + newAksam;
            const newTutar = (data.toplamTutar - (data[zamanDilimi] || 0) * data.fiyat) + totalPrice;
            const newFiyat = newToplam > 0 ? newTutar / newToplam : 0;
            const sutUpdates = { sabah: newSabah, aksam: newAksam, toplam: newToplam, toplamTutar: newTutar, fiyat: newFiyat };
            batch.update(sutAlimRef, sutUpdates);
        }

        const entryData = { movementId: movementRef.id, sutAlimId: sutAlimRef.id, ureticiId: currentProducer.id, ureticiAdi: currentProducer.adiSoyadi, sahipId: sahipId, calisanId: auth.currentUser.uid, tankId: tankId, alim_tarihi: alimTarihi, zaman_dilimi: zamanDilimi, miktar: quantity, birim_fiyat: unitPrice, toplam_tutar: totalPrice, not: notes, kayitZamani: new Date() };
        batch.set(movementRef, entryData);
        batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(quantity) });

        await batch.commit();
        
        const toast = document.getElementById('toast-message');
        toast.textContent = `âœ… ${currentProducer.adiSoyadi} iÃ§in ${quantity} Lt kaydedildi.`;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);

        collectionHistory.push(entryData);
        renderHistory();
        routeProducers.splice(currentProducerIndex, 1);
        populateProducerSelect();
        displayCurrentProducer();

    } catch (error) {
        console.error("KayÄ±t hatasÄ±:", error);
        alert("Veri kaydedilirken bir hata oluÅŸtu: " + error.message);
    } finally {
        saveBtn.disabled = false;
        skipBtn.disabled = false;
    }
}


async function handleSkip() {
    const producerName = routeProducers[currentProducerIndex]?.adiSoyadi || 'Bu Ã¼retici';

    const confirmation = confirm(
        `'${producerName}' iÃ§in iÅŸlem seÃ§in:\n\n` +
        `âž¡ï¸ SÃœT YOK ise -> 'Tamam'a basÄ±n (0 Lt olarak kaydedilecektir).\n\n` +
        `âž¡ï¸ ULAÅžILAMADIYSA veya baÅŸka bir sebeple atlamak iÃ§in -> 'Ä°ptal'e basÄ±n.`
    );

    if (confirmation) {
        // KullanÄ±cÄ± "Tamam" dedi, yani sÃ¼t yok. 0 Lt olarak kaydet.
        await saveMilkEntry(0, "SÃ¼t yok");
    } else {
        // KullanÄ±cÄ± "Ä°ptal" dedi, sadece bir sonraki Ã¼reticiye geÃ§.
        currentProducerIndex++;
        displayCurrentProducer();
    }
}





function cancelEditMode() {
    editingEntry = null;
    editingMovementIdInput.value = '';
    
    // Form elemanlarÄ±nÄ± tekrar aktif hale getir
    producerSelect.disabled = false;
    categorySelect.disabled = false;
    
    // ButonlarÄ± baÅŸlangÄ±Ã§ durumuna dÃ¶ndÃ¼r
    skipBtn.style.display = 'block';
    saveBtn.textContent = 'Kaydet ve Sonraki';
    saveBtn.className = 'btn btn-success';
    cancelEditBtn.style.display = 'none';
    
    // Mevcut Ã¼reticiyi tekrar gÃ¶ster
    displayCurrentProducer();
}


async function populateTanks() {
    const tankSelect = document.getElementById('tank');
    if (!tankSelect) return;

    tankSelect.innerHTML = '<option value="">YÃ¼kleniyor...</option>';

    if (!sahipId) {
        console.error("populateTanks Ã§aÄŸrÄ±ldÄ± ama sahipId boÅŸ.");
        tankSelect.innerHTML = '<option value="" disabled selected>KullanÄ±cÄ± bilgisi bekleniyor...</option>';
        return;
    }

    try {
        const snapshot = await db.collection('tanklar').where('sahipId', '==', sahipId).orderBy('ad').get();

        if (snapshot.empty) {
            tankSelect.innerHTML = '<option value="" disabled selected>TanÄ±mlÄ± tank bulunamadÄ±!</option>';
            // tankMevcutLitre'yi de temizle
            const displayElement = document.getElementById('tankMevcutLitre');
            if(displayElement) displayElement.textContent = '';
            return;
        }

        tankSelect.innerHTML = '';
        tankDataMap.clear(); // HafÄ±zadaki eski tank verilerini temizle
        snapshot.forEach(doc => {
            const tank = doc.data();
            tankDataMap.set(doc.id, tank); // Yeni verileri hafÄ±zaya al
            
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = `${tank.ad} (${tank.kapasite} Lt)`;
            tankSelect.appendChild(option);
        });

        // Sayfa ilk yÃ¼klendiÄŸinde, seÃ§ili olan ilk tankÄ±n miktarÄ±nÄ± gÃ¶ster
        if (tankSelect.value) {
            updateTankInfoDisplay(tankSelect.value);
        }

    } catch (error) {
        console.error("Tanklar yÃ¼klenirken bir Firestore hatasÄ± oluÅŸtu:", error);
        tankSelect.innerHTML = '<option value="" disabled selected>Hata: Tanklar yÃ¼klenemedi.</option>';
    }
}


        
function updateTankInfoDisplay(tankId) {
    const displayElement = document.getElementById('tankMevcutLitre');
    if (!displayElement) return;

    if (tankId && tankDataMap.has(tankId)) {
        const mevcutLitre = tankDataMap.get(tankId).mevcutLitre;
        displayElement.textContent = `Mevcut: ${mevcutLitre.toLocaleString('tr-TR', {maximumFractionDigits: 1})} Lt`;
    } else {
        displayElement.textContent = '';
    }
}


async function populateCategories() {
    const categorySelect = document.getElementById('category');
    if (!categorySelect) return;
    categorySelect.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
    if (!sahipId) {
        categorySelect.innerHTML = '<option value="" disabled selected>Sahip bilgisi bekleniyor...</option>';
        return;
    }
    try {
        const snapshot = await db.collection('cari_kategorileri').where('sahipId', '==', sahipId).orderBy('ad').get();
        categorySelect.innerHTML = '<option value="">Rota SeÃ§iniz...</option>';
        snapshot.forEach(doc => {
            categorySelect.innerHTML += `<option value="${doc.data().ad}">${doc.data().ad}</option>`;
        });
    } catch (e) {
        console.error("Kategoriler yÃ¼klenirken hata:", e);
        categorySelect.innerHTML = '<option value="" disabled selected>Hata: Rotalar yÃ¼klenemedi</option>';
    }
}



function getSessionKey(category) {
    const date = document.getElementById('collection-date').value;
    const time = document.querySelector('input[name="time"]:checked').value;
    return `session_${sahipId}_${date}_${time}_${category || 'none'}`;
}

async function startRoute() {
    producerPanel.style.display = 'none';
    collectionHistory = [];
    
    const category = categorySelect.value;
    if (!category) { return; }

    const alimTarihi = collectionDateInput.value;
    const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
    
    const [producersSnapshot, existingEntriesSnapshot] = await Promise.all([
        db.collection('cariler').where('sahipId', '==', sahipId).where('kategori', '==', category).where('durum', '==', 'aktif').where('cariGrup', 'array-contains', 'Ã¼retici').orderBy('rotaSirasi').get(),
        db.collection('tank_hareketleri').where('sahipId', '==', sahipId).where('alim_tarihi', '==', alimTarihi).where('zaman_dilimi', '==', zamanDilimi).get()
    ]);

    collectionHistory = existingEntriesSnapshot.docs.map(doc => doc.data());
    renderHistory();

    const savedProducerIds = new Set(collectionHistory.map(entry => entry.ureticiId));
    routeProducers = producersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(p => !savedProducerIds.has(p.id));

    if(routeProducers.length === 0) {
        alert("Bu rota iÃ§in tÃ¼m sÃ¼t giriÅŸleri tamamlanmÄ±ÅŸ.");
        return;
    }
    
    currentProducerIndex = 0;
    populateProducerSelect();
    displayCurrentProducer();
    producerPanel.style.display = 'block';
}


function displayCurrentProducer() {
            if (currentProducerIndex >= routeProducers.length) {
                producerPanel.style.display = 'none';
                alert(`${categorySelect.options[categorySelect.selectedIndex].text} rotasÄ± tamamlandÄ±!`);
                return;
            }
            const producer = routeProducers[currentProducerIndex];
            currentProducerName.textContent = producer.adiSoyadi;
            producerSelect.value = currentProducerIndex;
            quantityInput.value = '';
            notesInput.value = '';
            quantityInput.focus();
        }

        function populateProducerSelect() {
             producerSelect.innerHTML = '';
            routeProducers.forEach((producer, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${producer.rotaSirasi || ''}. ${producer.adiSoyadi}`;
                producerSelect.appendChild(option);
            });
        }

        function jumpToProducer() {
            currentProducerIndex = parseInt(this.value);
            displayCurrentProducer();
        }

        function goToNextProducer() {
            currentProducerIndex++;
            displayCurrentProducer();
        }

function setEditMode(entry) {
    console.log("--- setEditMode Fonksiyonu BaÅŸladÄ± ---");

    // Her bir HTML elemanÄ±nÄ±n bulunup bulunamadÄ±ÄŸÄ±nÄ± kontrol edelim
    if (!producerPanel) {
        console.error("HATA: 'producerPanel' ID'li HTML elemanÄ± bulunamadÄ±!");
        return; // Eleman yoksa fonksiyonu durdur
    }
    if (!saveBtn) {
        console.error("HATA: 'saveBtn' ID'li HTML elemanÄ± bulunamadÄ±!");
        return;
    }
    // DiÄŸer tÃ¼m elemanlar iÃ§in de bu kontrolÃ¼ yapabiliriz ama ÅŸimdilik en Ã¶nemlileri bunlar.

    try {
        console.log("'producerPanel' bulundu, gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ kontrol ediliyor...");
        // Panelin gÃ¶rÃ¼nÃ¼r olduÄŸundan emin olalÄ±m.
        producerPanel.style.display = 'block';

        editingEntry = entry;
        editingMovementIdInput.value = entry.movementId;
        currentProducerName.textContent = `DÃœZENLE: ${entry.ureticiAdi}`;
        quantityInput.value = entry.miktar;
        notesInput.value = entry.not || '';
        unitPriceInput.value = (entry.birim_fiyat || 0).toFixed(2);
        
        producerSelect.disabled = true;
        categorySelect.disabled = true;
        
        skipBtn.style.display = 'none';
        saveBtn.textContent = 'GÃ¼ncelle';
        saveBtn.className = 'btn btn-warning';
        cancelEditBtn.style.display = 'block';
        
        console.log("TÃ¼m form elemanlarÄ± ayarlandÄ±. Ekrana kaydÄ±rÄ±lÄ±yor...");
        producerPanel.scrollIntoView({ behavior: 'smooth' });

        console.log("--- setEditMode BaÅŸarÄ±yla TamamlandÄ± ---");
    } catch (error) {
        console.error("setEditMode fonksiyonu iÃ§inde bir HATA oluÅŸtu:", error);
        alert("DÃ¼zenleme modu aÃ§Ä±lÄ±rken bir hata oluÅŸtu. LÃ¼tfen konsolu kontrol edin.");
    }
}

async function handleSave() {
    if (editingMovementIdInput.value) {
        await handleUpdate();
    } else {
        await handleSaveAndNext();
    }
}

async function handleUpdate() {
    const yeniMiktar = parseFloat(quantityInput.value);
    if (isNaN(yeniMiktar) || yeniMiktar < 0) { // Negatif giriÅŸleri de engelle
        alert('LÃ¼tfen geÃ§erli bir miktar girin.');
        return;
    }

    if (!editingEntry) {
        alert("Hata: DÃ¼zenlenecek giriÅŸ bilgisi bulunamadÄ±.");
        return;
    }

    saveBtn.disabled = true;

    const eskiMiktar = editingEntry.miktar;
    const litreFarki = yeniMiktar - eskiMiktar;
    const yeniBirimFiyat = parseFloat(unitPriceInput.value);
    const yeniToplamTutar = yeniMiktar * yeniBirimFiyat;
    const alimTarihi = editingEntry.alim_tarihi;
    const zamanDilimi = editingEntry.zaman_dilimi;
    const ureticiId = editingEntry.ureticiId;

    const batch = db.batch();
    const tankRef = db.collection('tanklar').doc(editingEntry.tankId);
    const movementRef = db.collection('tank_hareketleri').doc(editingEntry.movementId);

    // --- BAÅžLANGIÃ‡: GÃœVENÄ°LÄ°R KAYIT BULMA VE GÃœNCELLEME MANTIÄžI ---
    try {
        let sutAlimRef;
        // 1. Ana sÃ¼t alÄ±m kaydÄ±nÄ±n referansÄ±nÄ± al
        if (editingEntry.sutAlimId) {
            // Yeni sistemle kaydedilmiÅŸse, ID ile doÄŸrudan al
            sutAlimRef = db.collection('sut_alimlari').doc(editingEntry.sutAlimId);
        } else {
            // Eski sistemle kaydedilmiÅŸse, sorgu ile bulmayÄ± dene (geri uyumluluk iÃ§in)
            console.warn("Eski bir kayÄ±t dÃ¼zenleniyor, sutAlimId bulunamadÄ±. Sorgu ile aranÄ±yor...");
            const sutAlimSnapshot = await db.collection('sut_alimlari')
                .where('sahipId', '==', sahipId)
                .where('cariId', '==', ureticiId)
                .where('tarih', '==', alimTarihi)
                .limit(1).get();
            
            if (!sutAlimSnapshot.empty) {
                sutAlimRef = sutAlimSnapshot.docs[0].ref;
            } else {
                alert("Hata: DÃ¼zenlenecek ana sÃ¼t alÄ±m kaydÄ± veritabanÄ±nda bulunamadÄ±. Bu kaydÄ± silip yeniden eklemeniz gerekebilir.");
                saveBtn.disabled = false;
                return;
            }
        }

        // 2. GÃ¼nÃ¼n diÄŸer giriÅŸini (sabah/akÅŸam) bul
        const digerZamanDilimi = zamanDilimi === 'sabah' ? 'akÅŸam' : 'sabah';
        const digerGirisSnapshot = await db.collection('tank_hareketleri')
            .where('sahipId', '==', sahipId)
            .where('ureticiId', '==', ureticiId)
            .where('alim_tarihi', '==', alimTarihi)
            .where('zaman_dilimi', '==', digerZamanDilimi)
            .limit(1).get();

        let digerGirisMiktari = 0;
        let digerGirisTutar = 0;
        if (!digerGirisSnapshot.empty) {
            const digerData = digerGirisSnapshot.docs[0].data();
            digerGirisMiktari = digerData.miktar;
            digerGirisTutar = digerData.toplam_tutar;
        }

        // 3. Yeni toplamlarÄ± doÄŸru bir ÅŸekilde hesapla
        const yeniGunlukToplam = yeniMiktar + digerGirisMiktari;
        const yeniGunlukTutar = yeniToplamTutar + digerGirisTutar;
        
        const sutAlimUpdates = {
            toplam: yeniGunlukToplam,
            toplamTutar: yeniGunlukTutar,
            // Ortalama fiyatÄ± da gÃ¼ncelleyelim
            fiyat: yeniGunlukToplam > 0 ? (yeniGunlukTutar / yeniGunlukToplam) : 0
        };

        if (zamanDilimi === 'sabah') {
            sutAlimUpdates.sabah = yeniMiktar;
            if (digerGirisMiktari > 0) {
                 sutAlimUpdates.aksam = digerGirisMiktari;
            }
        } else { // zamanDilimi === 'akÅŸam'
            sutAlimUpdates.aksam = yeniMiktar;
            if (digerGirisMiktari > 0) {
                 sutAlimUpdates.sabah = digerGirisMiktari;
            }
        }
        
        // 4. Batch (Toplu Yazma) iÅŸlemlerini hazÄ±rla
        batch.update(sutAlimRef, sutAlimUpdates);
        batch.update(movementRef, {
            miktar: yeniMiktar,
            birim_fiyat: yeniBirimFiyat,
            toplam_tutar: yeniToplamTutar,
            not: notesInput.value
        });
        batch.update(tankRef, {
            mevcutLitre: firebase.firestore.FieldValue.increment(litreFarki)
        });

        // --- BÄ°TÄ°Åž: GÃœVENÄ°LÄ°R KAYIT BULMA VE GÃœNCELLEME MANTIÄžI ---

        await batch.commit();
        await startRoute(); // Listeyi en gÃ¼ncel haliyle yeniden yÃ¼kle
        cancelEditMode(); // DÃ¼zenleme modundan Ã§Ä±k
    } catch (error) {
        alert("GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu: " + error.message);
        console.error("Update Error:", error);
    } finally {
        saveBtn.disabled = false; // Butonu tekrar aktif et
    }
}

        
async function handleSaveAndNext() {
    const quantity = parseFloat(quantityInput.value);
    const notes = notesInput.value;

    // GÃœNCELLEME: Miktar 0 ise veya boÅŸsa da kayda izin veriyoruz (SÃ¼t Yok durumu iÃ§in)
    if (quantity === null || quantity === undefined || isNaN(quantity) || quantity < 0) {
        alert('LÃ¼tfen geÃ§erli bir miktar girin. Miktar negatif olamaz.');
        return;
    }
    
    await saveMilkEntry(quantity, notes);
}


function renderHistory() {
    if (!historySection || !historyList || !sessionSummary) return;
    if (collectionHistory.length === 0) {
        historySection.style.display = 'none';
        return;
    }
    historySection.style.display = 'block';
    historyList.innerHTML = '';
    let totalMilk = 0,
        totalValue = 0;

    collectionHistory.sort((a, b) => {
        const timeA = a.kayitZamani.seconds ? a.kayitZamani.toMillis() : a.kayitZamani.getTime();
        const timeB = b.kayitZamani.seconds ? b.kayitZamani.toMillis() : b.kayitZamani.getTime();
        return timeB - timeA;
    }).forEach(item => {
        const listItem = document.createElement('li');
        listItem.className = 'history-item';
        
        // --- YENÄ°: ButonlarÄ± gÃ¶stermeden Ã¶nce tarih kontrolÃ¼ yapÄ±lÄ±yor ---
        const dayDifference = getDayDifference(item.alim_tarihi);
        let buttonsHTML = ''; // Butonlar iÃ§in boÅŸ bir deÄŸiÅŸken

        // EÄŸer kullanÄ±cÄ± admin ise VEYA kaydÄ±n tarihi 2 gÃ¼nden eski deÄŸilse butonlarÄ± gÃ¶ster
        if (currentUserRole === 'admin' || dayDifference <= 2) {
            buttonsHTML = `
            <div>
                <button class="btn edit-btn" onclick="editHistoryItem('${item.movementId}')">DÃ¼zenle</button>
                <button class="btn delete-btn" onclick="deleteHistoryItem('${item.movementId}')">Sil</button>
            </div>
            `;
        }
        
        listItem.innerHTML = `
            <div class="history-item-info">${item.ureticiAdi}</div>
            <div class="history-item-details">
                <span>${item.miktar.toFixed(1)} Litre</span>
                <span class="price">${item.toplam_tutar.toFixed(2)} â‚º</span>
            </div>
            ${buttonsHTML} 
        `;
        // --- GÃœNCELLEME SONU ---

        historyList.appendChild(listItem);
        totalMilk += item.miktar;
        totalValue += item.toplam_tutar;
    });

    sessionSummary.innerHTML = `<p>Toplam SÃ¼t: <span>${totalMilk.toFixed(1)} Litre</span></p><p>Toplam Tutar: <span>${totalValue.toFixed(2)} â‚º</span></p>`;
}


function editHistoryItem(movementId) {
    const entry = collectionHistory.find(item => item.movementId === movementId);
    
    if (entry) {
        // --- YENÄ° GÃœVENLÄ°K KONTROLÃœ ---
        const dayDifference = getDayDifference(entry.alim_tarihi);
        if (currentUserRole !== 'admin' && dayDifference > 2) {
            alert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok. Sadece son 2 gÃ¼ne ait kayÄ±tlar dÃ¼zenlenebilir.');
            return; // Fonksiyonu durdur
        }
        // --- KONTROL SONU ---
        
        console.log("KayÄ±t bulundu:", entry);
        setEditMode(entry);
    } else {
        console.error("HATA: KayÄ±t 'collectionHistory' dizininde bulunamadÄ±!");
        alert("DÃ¼zenlenecek kayÄ±t bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyip tekrar deneyin.");
    }
}


async function deleteHistoryItem(movementId) {
    const entryToDelete = collectionHistory.find(item => item.movementId === movementId);
    if (!entryToDelete) {
        alert("Silinecek kayÄ±t oturum geÃ§miÅŸinde bulunamadÄ±.");
        return;
    }

    // --- YENÄ° GÃœVENLÄ°K KONTROLÃœ ---
    const dayDifference = getDayDifference(entryToDelete.alim_tarihi);
    if (currentUserRole !== 'admin' && dayDifference > 2) {
        alert('Bu kaydÄ± silme yetkiniz yok. Sadece son 2 gÃ¼ne ait kayÄ±tlar silinebilir.');
        return; // Fonksiyonu durdur
    }
    // --- KONTROL SONU ---
    
    if (!entryToDelete.sutAlimId) {
        alert("Hata: Silinecek ana kayÄ±t kimliÄŸi bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.");
        return;
    }
    
    // ... fonksiyonun geri kalanÄ± aynÄ± ...
    if (!confirm(`'${entryToDelete.ureticiAdi}' iÃ§in girilen ${entryToDelete.miktar} Lt sÃ¼t kaydÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!`)) {
        return;
    }

    const saveBtn = document.getElementById('save-btn');
    const skipBtn = document.getElementById('skip-btn');
    saveBtn.disabled = true;
    skipBtn.disabled = true;

    const tankRef = db.collection('tanklar').doc(entryToDelete.tankId);
    const movementRef = db.collection('tank_hareketleri').doc(entryToDelete.movementId);
    const sutAlimRef = db.collection('sut_alimlari').doc(entryToDelete.sutAlimId);
    const batch = db.batch();

    batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(-entryToDelete.miktar) });
    batch.delete(movementRef);
    batch.delete(sutAlimRef);
    
    try {
        await batch.commit();
        alert("KayÄ±t baÅŸarÄ±yla silindi.");
        await startRoute(); 
    } catch (error) {
        console.error("Silme hatasÄ±:", error);
        alert("KayÄ±t silinirken bir hata oluÅŸtu: " + error.message);
    } finally {
        saveBtn.disabled = false;
        skipBtn.disabled = false;
    }
}




</script>
</body>
</html>
