<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Süt Takip Programı - Tam Sürüm</title>
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://raw.githubusercontent.com/sozcelyk43/suttakip/refs/heads/main/favicon.ico" type="image/x-icon" />
    <link rel="manifest" href="/site.webmanifest">
</head>
<body>
    <div class="sidebar">
        <img src="logo.png" alt="Uygulama Logosu" class="sidebar-logo">
        <h1>Süt Takip Programı</h1>
        <nav id="sidebarNav">
            <ul>
		<li class="quick-entry-link">
            <a href="hizli-giris.html" target="_blank">⚡ Hızlı Süt Girişi</a>
        	</li>
                <li><a href="#dashboard" class="nav-link active">📝 Kontrol Paneli</a></li>
                <li><a href="#cari-yonetimi" class="nav-link">👥 Cari Yönetimi</a></li>
                <li><a href="#sut-alimi" class="nav-link">🥛 Günlük Süt Alımı</a></li>
                <li><a href="#yem-stok-yonetimi" class="nav-link">📦 Stok Yönetimi</a></li>
                <li><a href="#yem-satisi" class="nav-link">🌾 Yem Satışı</a></li>
                <li><a href="#tahsilat-ve-odemeler" class="nav-link">💳 Tahsilat ve Ödemeler</a></li>
                <li><a href="#hesap-ozeti" class="nav-link">📊 Cari Hesap Özeti</a></li>
                <li><a href="#sut-alim-raporu" class="nav-link">🗓️ Aylık Süt Raporu</a></li>
                <li><a href="#dinamik-sut-raporu" class="nav-link">📋 Dinamik Süt Karnesi</a></li>

                <li><a href="#aylik-yem-raporu" class="nav-link">📈 Aylık Yem Raporu</a></li>
                <li><a href="#hareket-dokumu" class="nav-link">📋 Hareket Dökümü</a></li>
<li><a href="#tank-yonetimi" class="nav-link">💧 Tank Yönetimi</a></li>
<li><a href="#tank-aktarim" class="nav-link">→ Tanktan Aktarım</a></li>
                <li><a href="#ayarlar" class="nav-link">⚙️ Ayarlar</a></li>
               <li class="logout-link">
    <a href="#" id="logoutButton">
        <div>🚪 Çıkış Yap</div>
        <div id="logoutUserEmail"></div> </a>
</li>
            </ul>
        </nav>
    </div>

    <div class="main-content">
<button id="menuToggleBtn" class="menu-toggle-btn dont-print">☰</button>

        <section id="dashboard" class="module-section">
            <div class="module-header"><h2>📝 Kontrol Paneli</h2></div>
            <div class="container">
                <h3>Genel Durum</h3>

                <div class="dashboard-grid">
                    <div class="stat-card"><h4>☀️ Bugünkü Sabah Sütü</h4><p><span id="dashSabahSut">0.00</span> Lt</p><small id="sabahSutTarih" style="font-weight: bold;"></small></div>
                    <div class="stat-card"><h4>🌙 Bugünkü Akşam Sütü</h4><p><span id="dashAksamSut">0.00</span> Lt</p><small id="aksamSutTarih" style="font-weight: bold;"></small></div>
                    <div class="stat-card"><h4>📈 Bugünkü Toplam Süt</h4><p><span id="dashToplamSut">0.00</span> Lt</p>
				<small id="toplamSutTarihAraligi" style="display: block; font-weight: bold;"></small><small id="dunKarsilastirma">(Düne göre...)</small></div>
                    <div class="stat-card"><h4>👥 Aktif Müşteri Sayısı</h4><p><span id="dashAktifMusteri">0</span></p></div>
	            <div class="stat-card" id="bakiyeDurumKarti"><h4>💰 Toplam Bakiye</h4><p><span id="dashToplamBakiye">0,00</span> ₺</p>
				<small id="bakiyeDurumUyarisi" style="font-weight: bold;"></small></div>
                   <div class="stat-card" style="border-left: 5px solid #3498db; grid-column: span 1;"><h4>Bu Ayki Süt Üretimi</h4><p style="font-size: 2.2em; color: #2980b9;">
				<span id="dashBuAykiToplamSut">0</span> Lt</p><small>(<span id="aylikGunOrtalamasi">0</span> Lt/Gün Ort.)</small></div>
                   <div class="stat-card" style="border-left: 5px solid #1abc9c; grid-column: span 1;"><h4>Üretimin Parasal Değeri</h4><p style="font-size: 2.2em; color: #16a085;">
				<span id="dashBuAykiSutDegeri">0,00</span> ₺</p><small>(Potansiyel Gelir)</small></div>
                   <div class="stat-card" style="border-left: 5px solid #f39c12;"><h4>📦 Tanımlı Yem Sayısı</h4><p style="font-size: 2.2em; color: #d35400;">
				<span id="dashYemSayisi">0</span></p><small>(Toplam Çeşit)</small></div>
                </div>

                <div class="balance-bars">
                    <div class="balance-bar-item">
                        <div class="balance-bar-header">
                            <span>Toplam Alacak (Müşteri Borcu)</span>
                            <strong id="dashToplamAlacak">0,00 ₺</strong>
                        </div>
                        <div class="progress-bar-container"><div id="alacakBar" class="progress-bar alacak" style="width: 0%;"></div></div>
                    </div>
                    <div class="balance-bar-item">
                        <div class="balance-bar-header">
                            <span>Toplam Borç (Müşteri Alacağı)</span>
                            <strong id="dashToplamBorc">0,00 ₺</strong>
                        </div>
                        <div class="progress-bar-container"><div id="borcBar" class="progress-bar borc" style="width: 0%;"></div></div>
                    </div>
                </div>

                <div class="charts-container-vertical">
                    <div class="chart-card">
                        <h3>Bugünkü Süt Alım Dağılımı (Kategori Bazlı)</h3>
                        <div class="chart-wrapper">
                            <canvas id="gunlukSutGrafik"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
    <h3>Aylık Süt Dağılımı (Kategori Bazlı)</h3>
    <div class="chart-filters">
        <input type="month" id="aylikChartAySecimi">
        <button id="aylikChartGosterBtn" class="btn btn-sm">Grafiği Göster</button>
    </div>
    <div class="chart-wrapper">
        <canvas id="aylikSutGrafik"></canvas>
    </div>
</div>

<div class="tank-dashboard-container">
    <h3>Tank Doluluk Oranları</h3>
    <div id="dashboardTanklar">
        </div>
</div>

                </div>
            </div>
        </section>
<section id="cari-yonetimi" class="module-section hidden-section">
    <div class="module-header"><h2>👥 Cari Yönetimi</h2></div>
    <div class="container">
        <div class="form-section">
            <h3><span id="cariFormBaslik">Yeni Cari Kart</span></h3>
            <form id="cariForm" action="#">
    <input type="hidden" id="cariEditId">
    <div class="form-grid">
    <div class="form-group">
        <label for="cariKodu">Cari Kodu:</label>
        <input type="text" id="cariKodu" placeholder="Örn: C001">
    </div>
    <div class="form-group">
        <label for="cariRotaSirasi">Rota Sırası:</label>
        <input type="number" id="cariRotaSirasi" placeholder="Örn: 1, 2, 3...">
    </div>
    <div class="form-group">
        <label for="cariAdiSoyadi">Adı Soyadı / Firma Adı:</label>
        <input type="text" id="cariAdiSoyadi">
    </div>
    <div class="form-group">
        <label for="cariKategori">Kategori/Köy:</label>
        <select id="cariKategori">
            <option value="">Seçiniz...</option>
        </select>
    </div>
    <div class="form-group">
        <label>Cari Grubu (Birden çok seçilebilir):</label>
        <div class="checkbox-group">
            <label for="grupUretici"><input type="checkbox" id="grupUretici" value="üretici"> Üretici</label>
            <label for="grupTedarikci"><input type="checkbox" id="grupTedarikci" value="tedarikçi"> Tedarikçi</label>
            <label for="grupSutAlici"><input type="checkbox" id="grupSutAlici" value="süt alıcı"> Süt Alıcı</label>
        </div>
    </div>
    <div class="form-group">
        <label for="cariDurum">Durum:</label>
        <select id="cariDurum">
            <option value="aktif">Aktif</option>
            <option value="pasif">Pasif</option>
        </select>
    </div>
    <div class="form-group">
        <label for="cariTipi">Cari Tipi:</label>
        <select id="cariTipi">
            <option value="sut_ve_yem">Süt ve Yem</option>
            <option value="sadece_sut">Sadece Süt</option>
            <option value="sadece_yem">Sadece Yem</option>
        </select>
    </div>
    <div class="form-group">
        <label for="cariAcilisBakiye">Açılış Bakiyesi:</label>
        <input type="number" id="cariAcilisBakiye" placeholder="Örn: 500" step="0.01">
    </div>
    <div class="form-group">
        <label for="cariAcilisBakiyeTuru">Bakiye Türü:</label>
        <select id="cariAcilisBakiyeTuru">
            <option value="yok">Yok</option>
            <option value="borc">Cari Borçlu</option>
            <option value="alacak">Cari Alacaklı</option>
        </select>
    </div>
    <div class="form-group">
        <label for="cariTelefon">Telefon:</label>
        <input type="tel" id="cariTelefon">
    </div>
    <div class="form-group">
        <label for="cariEposta">E-posta:</label>
        <input type="email" id="cariEposta">
    </div>
    <div class="form-group" style="grid-column: span 2;">
        <label for="cariAdres">Adres:</label>
        <textarea id="cariAdres"></textarea>
    </div>
    <div class="form-group">
        <label for="cariBankaAdi">Banka Adı:</label>
        <input type="text" id="cariBankaAdi">
    </div>
    <div class="form-group">
        <label for="cariIban">IBAN:</label>
        <input type="text" id="cariIban">
    </div>
    <div class="form-group">
        <label for="cariVergiDairesi">Vergi Dairesi:</label>
        <input type="text" id="cariVergiDairesi">
    </div>
    <div class="form-group">
        <label for="cariVergiNo">Vergi No / T.C.:</label>
        <input type="text" id="cariVergiNo">
    </div>
    <div class="form-group" style="grid-column: span 2;">
        <label for="cariNotlar">Özel Notlar:</label>
        <textarea id="cariNotlar"></textarea>
    </div>
</div>
    <button type="submit" class="btn btn-primary" id="cariKaydetBtn">Kaydet</button>
    <button type="button" class="btn" id="cariFormTemizleBtn" style="display:none;">Yeni Kayıt</button>
</form>
        </div>

        <div id="cari-list-printable-area" class="printable-content format-a4">
            <h1 class="print-only print-title" style="text-align: center; display: none;">Cari Listesi</h1>
            <div class="list-section">

                <div class="form-grid dont-print" style="grid-template-columns: 1fr auto; align-items: end; gap: 10px; padding: 10px; border: 1px solid #ddd; margin-bottom: 15px; border-radius: 5px;">
                    <div class="form-group">
                        <label for="cariTarihFiltresi"><strong>Tarihsel Bakiye Raporu:</strong></label>
                        <input type="date" id="cariTarihFiltresi">
                        <small>Belirli bir tarih itibarıyla bakiye durumunu görmek için bir tarih seçip 'Raporla' butonuna basın. Boş bırakırsanız güncel durumu gösterir.</small>
                    </div>
                    <button type="button" class="btn btn-primary" id="cariTarihselRaporBtn" style="height:45px;">Raporla</button>
                </div>

                <div id="cariRotaSirasiUyari" style="display: none;"></div>

                <div class="list-header-with-filter">
    <h3>Cari Listesi (<span id="raporTarihEtiketi">Güncel Durum</span>)</h3>
    <div class="search-container"><input type="text" id="cariSearchInput" placeholder="Cari Ara..." aria-label="Cari Arama Kutusu"></div>
    <select id="cariKategoriFiltre"><option value="">Tüm Kategoriler</option></select>
    
    <select id="cariDurumFiltre">
        <option value="">Tüm Durumlar</option>
        <option value="aktif">Aktif</option>
        <option value="pasif">Pasif</option>
    </select>
</div>

                <table>
                    <thead>
                        <tr>
                            <th>Kod</th>
                            <th>Ad/Firma</th>
                            <th>Kategori</th>
                            <th>Cari Grubu</th>
                            <th>Rota Sırası</th>
                            <th>Durum</th>
                            <th>Telefon</th>
                            <th>Borç</th>
                            <th>Alacak</th>
                            <th>Bakiye</th>
                            <th class="dont-print">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="cariListesiBody"></tbody>
                    <tfoot id="cariListesiFooter"></tfoot>
                </table>

            </div>
        </div>
        <button type="button" class="btn btn-secondary dont-print" id="cariListesiYazdirBtn" style="margin-top: 20px;">Listeyi Yazdır</button>
    </div>
</section>

        <section id="sut-alimi" class="module-section hidden-section">
    <div class="module-header"><h2>🥛 Günlük Süt Alımı</h2></div>
    <div class="container">
        <div class="form-section">
            <h3>Giriş Filtreleri</h3>
          <div class="form-grid" id="sutGirisFiltreler" style="grid-template-columns: 1fr 1fr 1fr;">
    <div class="form-group">
        <label for="topluGirisTarih">Giriş Tarihi:</label>
        <input type="date" id="topluGirisTarih" required>
    </div>
    <div class="form-group">
        <label for="topluGirisKategori">Kategori/Köy Seçin:</label>
        <select id="topluGirisKategori" required><option value="">Tüm Kategoriler</option></select>
    </div>
    <div class="form-group">
        <label for="topluGirisTank">Tank Seçimi:</label>
        <select id="topluGirisTank" required></select>
    </div>
</div>
        </div>
        <div class="list-section">
            <h3>Günlük Süt Girişi</h3>
            <div id="topluSutGirisTablosuAlani"></div>
            <p id="topluGirisTedarikciYokMesaji" style="text-align:center; display:none;">Bu kriterlere uygun, süt girişi bekleyen cari bulunmuyor.</p>
        </div>
        <hr style="margin: 40px 0;">
        <div id="sutDuzenleFormAlani" style="display:none; margin-bottom: 20px;">
            <h4>Süt Alımını Düzenle</h4>
            <form id="sutDuzenleForm" class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto auto;">
                <input type="hidden" id="sutDuzenleId">
                <div class="form-group"><label>Akşam (Lt)</label><input type="number" id="sutDuzenleAksam" class="sut-input" step="0.1" min="0"></div>
                <div class="form-group"><label>Sabah (Lt)</label><input type="number" id="sutDuzenleSabah" class="sut-input" step="0.1" min="0"></div>
                <div class="form-group"><label>Fiyat</label><input type="number" id="sutDuzenleFiyat" class="sut-input" step="0.01" min="0"></div>
                <button type="submit" class="btn btn-primary" style="height: 45px; align-self: end;">Güncelle</button>
                <button type="button" class="btn" style="height: 45px; align-self: end;" onclick="closeSutDuzenleForm()">İptal</button>
            </form>
                </div>
        <div class="list-section">
            <h3>Süt Alım Geçmişi (Seçili Tarih: <span id="gecmisTarihSpan"></span>)</h3>
            <table>
                <thead id="sutAlimGecmisiHeader"></thead>
                <tbody id="sutAlimGecmisiBody"></tbody>
                <tfoot id="sutAlimGecmisiFooter"></tfoot>
            </table>
        </div>
    </div>
</section>
        
        <section id="yem-stok-yonetimi" class="module-section hidden-section">
    <div class="module-header"><h2>📦 Stok Yönetimi</h2></div>
    <div class="container">
       <div class="form-section"><h3><span id="yemTanimFormBaslik">Yeni Yem Tanımla</span></h3><form id="yemTanimForm" action="#"><input type="hidden" id="yemTanimEditId"><div class="form-grid">
           <div class="form-group"><label for="yemKodu">Kod:</label><input type="text" id="yemKodu" required></div>
           <div class="form-group"><label for="yemAdi">Ad:</label><input type="text" id="yemAdi" required></div>
           <div class="form-group"><label for="yemKategorisi">Kategori:</label><select id="yemKategorisi"><option value="buyukbas">Büyükbaş</option><option value="kucukbas">Küçükbaş</option></select></div>
           <div class="form-group"><label for="yemBirimi">Birim:</label><input type="text" id="yemBirimi" value="Çuval"></div>
          
           <div class="form-group"><label for="yemSatisFiyati">Satış Fiyatı:</label><input type="number" id="yemSatisFiyati" step="0.01"></div>
       </div><button type="submit" class="btn btn-primary" id="yemTanimKaydetBtn">Kaydet</button><button type="button" class="btn" id="yemTanimFormTemizleBtn" style="display:none;">Yeni</button></form></div>
       <div class="list-section"><h3>Tanımlı Yemler & Stok</h3><table><thead><tr><th>Kod</th><th>Ad</th><th>Kategori</th><th>Birim</th><th>Alış F.</th><th>Satış F.</th><th>Stok</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="yemStokListesiBody"></tbody></table></div>
       <hr>
       <div class="form-section"><h3><span id="yemAlisFormBaslik">Yeni Yem Alışı</span></h3><form id="yemAlisForm" action="#"><input type="hidden" id="yemAlisEditId"><div class="form-grid">
           <div class="form-group"><label for="yemAlisTarih">Tarih:</label><input type="date" id="yemAlisTarih" required></div>
           <div class="form-group"><label for="yemSecimiAlis">Yem:</label><select id="yemSecimiAlis" required><option value="">Seçiniz...</option></select></div>
           <div class="form-group"><label for="yemAlisMiktar">Miktar:</label><input type="number" id="yemAlisMiktar" step="1" required></div>
           <div class="form-group"><label for="yemAlisTedarikci">Cari:</label><select id="yemAlisTedarikci"><option value="">Seçiniz...</option></select></div>
           <div class="form-group"><label for="yemAlisBirimFiyati">Alış Fiyatı:</label><input type="number" id="yemAlisBirimFiyati" step="0.01" required></div>
           <div class="form-group"><label for="yemAlisToplamTutar">Toplam Tutar:</label><input type="text" id="yemAlisToplamTutar" readonly></div>
       </div><button type="submit" class="btn btn-primary" id="yemAlisKaydetBtn">Alışı Kaydet</button><button type="button" class="btn" id="yemAlisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
       <div class="list-section"><h3>Yem Alış Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Yem</th><th>Miktar</th><th>Cari</th><th>Alış F.</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="yemAlisHareketListesiBody"></tbody></table></div>
        
        <hr style="margin: 40px 0;">

        <div class="form-section">
            <h3>Stok Sayım Girişi</h3>
            <p>Fiziksel olarak saydığınız yem miktarını girerek sistemdeki stoğu güncelleyin.</p>
            <form id="stokSayimForm" action="#">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label for="sayimTarihi">Sayım Tarihi:</label>
                        <input type="date" id="sayimTarihi" required>
                    </div>
                    <div class="form-group">
                        <label for="sayimYemSecimi">Sayımı Yapılan Yem:</label>
                        <select id="sayimYemSecimi" required>
                            <option value="">Yem Seçiniz...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sayimMevcutStok">Sistemdeki Stok:</label>
                        <input type="number" id="sayimMevcutStok" readonly style="background-color: #e9ecef;">
                    </div>
                    <div class="form-group">
                        <label for="sayimFizikselStok">Sayılan Miktar (Fiziksel):</label>
                        <input type="number" id="sayimFizikselStok" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="sayimFarki">Fark:</label>
                        <input type="text" id="sayimFarki" readonly style="background-color: #e9ecef; font-weight: bold;">
                    </div>
                    <div class="form-group" style="grid-column: span 3;">
                        <label for="sayimNotu">Açıklama / Not:</label>
                        <textarea id="sayimNotu" rows="2" placeholder="Örn: Fire, hatalı giriş düzeltmesi..."></textarea>
                    </div>
                </div>
                <button type="submit" class="btn btn-warning" id="stokSayimKaydetBtn">Sayımı Kaydet ve Stoğu Güncelle</button>
            </form>
        </div>
    
        <div class="list-section" style="margin-top: 20px;">
            <h3>Stok Sayım Hareketleri</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Yem Adı</th>
                        <th>Önceki Stok</th>
                        <th>Sayılan Miktar</th>
                        <th>Fark</th>
                        <th>Açıklama</th>
                    </tr>
                </thead>
                <tbody id="stokSayimGecmisiBody"></tbody>
            </table>
        </div>
        </div>
</section>
        
        <section id="yem-satisi" class="module-section hidden-section">
             <div class="module-header"><h2>🌾 Yem Satışı</h2></div>
             <div class="container">
                <div class="form-section"><h3><span id="yemSatisFormBaslik">Yeni Yem Satışı</span></h3><form id="yemSatisForm" action="#"><input type="hidden" id="yemSatisEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemSatisTarih">Tarih:</label><input type="date" id="yemSatisTarih" required></div>
                    <div class="form-group"><label for="yemAlanTedarikci">Alan Cari:</label><select id="yemAlanTedarikci" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemSecimiSatis">Yem:</label><select id="yemSecimiSatis" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemSatisMiktar">Miktar:</label><input type="number" id="yemSatisMiktar" step="1" required></div>
                    <div class="form-group"><label for="yemSatisBirimFiyati">Satış Fiyatı:</label><input type="number" id="yemSatisBirimFiyati" step="0.01" required></div>
                    <div class="form-group"><label for="yemSatisToplamTutar">Toplam Tutar:</label><input type="text" id="yemSatisToplamTutar" readonly></div>
                </div><button type="submit" class="btn btn-primary" id="yemSatisKaydetBtn">Satışı Kaydet</button><button type="button" class="btn" id="yemSatisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Yem Satış Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Alan Cari</th><th>Yem</th><th>Miktar</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="yemSatisListesiBody"></tbody></table></div>
             </div>
        </section>
        
        <section id="tahsilat-ve-odemeler" class="module-section hidden-section">
            <div class="module-header"><h2>💳 Tahsilat ve Ödemeler</h2></div>
            <div class="container">
                 <div class="form-section"><h3><span id="odemeFormBaslik">Yeni Hareket Girişi</span></h3>

		<form id="odemeForm" action="#">
    <input type="hidden" id="odemeEditId">
    <div class="form-grid">
        <div class="form-group"><label for="islemTuru">İşlem Türü:</label><select id="islemTuru" required><option value="odeme">Tahsilat</option><option value="tahsilat">Ödeme</option></select></div>
        <div class="form-group"><label for="odemeTarih">Tarih:</label><input type="date" id="odemeTarih" required></div>
        <div class="form-group">
            <label for="odemeYapilanTedarikci">Cari:</label>
            <select id="odemeYapilanTedarikci" required><option value="">Seçiniz...</option></select>
            <small id="cariBakiyeBilgisi" style="display: block; margin-top: 5px; font-weight: bold;"></small>
        </div>
        
        <div class="form-group">
            <label for="odemeTuru">Ödeme Türü:</label>
            <select id="odemeTuru" required>
                <option value="Kasa">Kasa</option>
                <option value="Banka">Banka</option>
                <option value="Pos">Pos</option>
                <option value="Çek">Çek</option>
                <option value="Senet">Senet</option>
            </select>
        </div>

        <div class="form-group"><label for="odemeTutari">Tutar (TL):</label><input type="number" id="odemeTutari" step="0.01" required></div>
        
        <div class="form-group" style="grid-column: span 3;"><label for="odemeAciklama">Açıklama:</label><textarea id="odemeAciklama" rows="2"></textarea></div>
    </div>
    <button type="submit" class="btn btn-primary" id="odemeKaydetBtn">Kaydet</button>
    <button type="button" class="btn" id="odemeFormTemizleBtn" style="display:none;">Yeni</button>
</form>

</div>
                 <div class="list-section"><h3>İşlem Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Cari</th><th>İşlem Türü</th><th>Tutar</th><th>Açıklama</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="odemeListesiBody"></tbody></table></div>
            </div>
        </section>
        
        <section id="hesap-ozeti" class="module-section hidden-section">
            <div class="module-header dont-print"><h2>📊 Cari Hesap Özeti</h2></div>
            <div class="container">
                <div class="report-section">
                    <h3 class="dont-print">Cari Hesap Özeti</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: 1fr 1fr auto; align-items: end;">
                        <div class="form-group"><label for="raporCariSecimi">Cari Seçin:</label><select id="raporCariSecimi"><option value="">Seçiniz...</option></select></div>
                        <div class="form-group"><label for="raporTarihAraligi">Ay:</label><input type="month" id="raporTarihAraligi"></div>
                        <button type="button" class="btn btn-primary" id="raporOlusturBtn" style="height:45px;">Rapor Oluştur</button>
                    </div> <hr class="dont-print">
                    <div id="report-content-to-print" class="printable-content format-a5">
                        <h1 class="print-only print-title">Süt Takip Programı - Cari Hesap Özeti</h1>
                        <h4 id="raporBaslik" style="text-align:center;">Lütfen Rapor Kriterlerini Seçin</h4>
                        <div id="raporDetayAlani"></div>
                    </div>

                    <div id="hesap-ozeti-export-area" style="display: none;"></div>
                    <button type="button" class="btn btn-secondary dont-print" id="raporYazdirBtn" style="margin-top:20px;">Özeti Yazdır</button>
                    <button type="button" class="btn btn-danger dont-print" id="hesapOzetiPdfBtn" style="margin-top:20px;">PDF İndir</button>
                    <button type="button" class="btn btn-success dont-print" id="hesapOzetiXlsxBtn" style="margin-top:20px;">Excel İndir</button>
                </div>
            </div>
        </section>
        
<section id="sut-alim-raporu" class="module-section hidden-section">
    <div class="module-header dont-print"><h2>🗓️ Aylık Süt Raporu</h2></div>
    <div class="container">
        <div class="report-section">
            <h3>Detaylı Süt Alım Raporu</h3>
            <div class="form-grid dont-print" style="grid-template-columns: 1fr 2fr 1fr auto; align-items: end; gap: 10px;">
    <div class="form-group">
        <label for="sutRaporuTedarikciSecimi">Cari Seçin:</label>
        <select id="sutRaporuTedarikciSecimi"><option value="">Seçiniz...</option></select>
    </div>
    <div class="form-group">
        <label>Tarih Aralığı Seçin:</label>
        <div style="display: flex; gap: 10px;">
            <input type="date" id="sutRaporuBaslangicTarihi" style="flex: 1;">
            <input type="date" id="sutRaporuBitisTarihi" style="flex: 1;">
        </div>
    </div>
    <div class="form-group">
        <label for="sutRaporuKategoriSecimi">Kategori:</label>
        <select id="sutRaporuKategoriSecimi"><option value="">Tümü</option></select>
    </div>
    <div style="display: flex; gap: 10px;">
        <button type="button" class="btn btn-primary" id="sutRaporuOlusturBtn" style="height:45px; flex-grow: 1;">Göster</button>
        <button type="button" class="btn btn-info" id="sutRaporuKategoriGosterBtn" style="height:45px; flex-grow: 1;">Kategori</button>
        <button type="button" class="btn btn-info" id="sutRaporuTumunuGosterBtn" style="height:45px; flex-grow: 1;">Toplu</button>
    </div>
</div>

<hr class="dont-print">
            
            <div id="sutAlimRaporAlani" class="printable-content format-a5">
                <h1 class="print-only print-title">Süt Takip Programı - Aylık Süt Alım Detay Raporu</h1>
                <h4 id="sutRaporuBaslik" style="text-align:center;">Lütfen Rapor Kriterlerini Seçin</h4>
                <div id="sutRaporuDetayAlani"></div>
            </div>

            <div id="sut-raporu-export-area" style="display: none;"></div>
            <button type="button" class="btn btn-secondary dont-print" id="sutRaporuYazdirBtn" style="margin-top:20px;">Raporu Yazdır</button>
            <button type="button" class="btn btn-danger dont-print" id="sutRaporuPdfBtn" style="margin-top:20px;">PDF İndir</button>
            <button type="button" class="btn btn-success dont-print" id="sutRaporuXlsxBtn" style="margin-top:20px;">Excel İndir</button>
        </div>
    </div>
</section>
        
       <section id="aylik-yem-raporu" class="module-section hidden-section">
    <div class="module-header"><h2>📈 Aylık Yem Satış Raporları</h2></div>
    <div class="container">
        <div class="report-section">
           <h3>Yem Satış Analizi</h3>
           <div class="form-grid dont-print" style="grid-template-columns: 1fr auto auto auto; align-items: end; gap: 10px;">
    <div class="form-group">
        <label for="yemRaporuAySecimi">Ay Seçin:</label>
        <input type="month" id="yemRaporuAySecimi">
    </div>
    <button type="button" class="btn btn-info" id="yemAdetRaporuBtn" style="height:45px;">Adet Bazlı Rapor</button>
    <button type="button" class="btn btn-primary" id="yemDetayliSatisRaporuBtn" style="height:45px;">Satış Raporu (Tutar)</button>
    <button type="button" class="btn btn-success" id="yemMusteriKarRaporuBtn" style="height:45px;">Kârlılık Raporu</button>
</div>
           <hr class="dont-print">
           <div id="yemRaporuAlani" class="printable-content format-a4" style="overflow-x: auto;">
        


</div>
           <button type="button" class="btn btn-secondary dont-print" id="yemRaporuYazdirBtn" style="margin-top:20px;">Raporu Yazdır</button>
           <button type="button" class="btn btn-danger dont-print" id="yemRaporuPdfBtn" style="margin-top:20px;">PDF İndir</button>
           <button type="button" class="btn btn-success dont-print" id="yemRaporuXlsxBtn" style="margin-top:20px;">Excel İndir</button>
        </div>
    </div>
</section>
   
<section id="dinamik-sut-raporu" class="module-section hidden-section">
    <div class="module-header"><h2>📋 Dinamik Süt Karnesi</h2></div>
    <div class="container">
        <div class="report-section">
            <div class="form-grid dont-print" style="grid-template-columns: 1fr 1fr auto; align-items: end; gap: 10px;">
    <div class="form-group">
        <label for="karneRaporuPeriyotSecimi">Dönem Seçin:</label>
        <select id="karneRaporuPeriyotSecimi"></select>
    </div>
    <div class="form-group">
        <label for="karneRaporuKategoriSecimi">Kategori/Köy Seçin:</label>
        <select id="karneRaporuKategoriSecimi"></select>
    </div>
    <button type="button" class="btn btn-primary" id="karneRaporuOlusturBtn" style="height:45px;">Karneyi Oluştur</button>
</div>
            <hr class="dont-print">
            
            <div id="dinamikRaporContainer" class="printable-content format-a3">
                <p style="text-align:center;">Raporu oluşturmak için lütfen yukarıdan ay ve kategori seçin.</p>
            </div>
<div class="report-buttons-footer dont-print" style="text-align: right; margin-top: 20px;">
    <button type="button" class="btn btn-secondary" id="karneYazdirBtn">🖨️ Yazdır</button>
    <button type="button" class="btn btn-danger" id="karnePdfBtn">📄 PDF İndir</button>
    <button type="button" class="btn btn-success" id="karneXlsxBtn">📊 Excel İndir</button>
</div>
        </div>
    </div>
</section>


        
        <section id="hareket-dokumu" class="module-section hidden-section">
            <div class="module-header"><h2>📋 Hareket Dökümü</h2></div>
            <div class="container">
                <div class="list-section">
                    <h3>Tüm İşlem Geçmişi (En Yeni Üstte)</h3>
                    <table>
                        <thead><tr><th>Tarih</th><th>Cari Adı</th><th>İşlem Türü</th><th>Açıklama</th><th>Tutar</th></tr></thead>
                        <tbody id="hareketDokumuBody"></tbody>
                    </table>
                    <div id="hareket-dokumu-pagination" class="pagination-controls dont-print">
                        <button id="hareketPrevBtn" class="btn btn-sm">← Önceki Sayfa</button>
                        <span id="hareketPageInfo">Sayfa 1</span>
                        <button id="hareketNextBtn" class="btn btn-sm">Sonraki Sayfa →</button>
                    </div>
                </div>
        </section>
        
        <section id="ayarlar" class="module-section hidden-section">
    <div class="module-header"><h2>⚙️ Ayarlar</h2></div>
    <div class="container">
        <div class="ayarlar-ust-bolum">
            <div class="settings-section">
                <h3>Genel Ayarlar</h3>
                <form id="ayarlarForm">
                    <div class="form-group">
                        <label for="varsayilanSutFiyati">Varsayılan Süt Fiyatı (TL/Lt):</label>
                        <input type="number" id="varsayilanSutFiyati" step="0.01">
                    </div>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </form>
            </div>
            <div class="settings-section">
                <h3>Şifre Değiştir</h3>
                <form id="sifreDegistirForm">
                    <div class="form-group"><label for="eskiSifre">Eski Şifre:</label><input type="password" id="eskiSifre" required></div>
                    <div class="form-group"><label for="yeniSifre">Yeni Şifre:</label><input type="password" id="yeniSifre" required></div>
                    <div class="form-group"><label for="yeniSifreTekrar">Yeni Şifre (Tekrar):</label><input type="password" id="yeniSifreTekrar" required></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Güncelle</button>
                </form>
            </div>
        </div>
        <hr>
        <div class="settings-section">
            <h3>Cari Kategori/Köy Tanımları</h3>
            <form id="cariKategoriForm" action="#">
                <div class="form-grid" style="grid-template-columns: 1fr auto; align-items:end;">
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="yeniCariKategoriAdi">Yeni Ad:</label>
                        <input type="text" id="yeniCariKategoriAdi" required>
                    </div>
                    <button type="submit" class="btn" style="height:45px;">Ekle</button>
                </div>
            </form>
            <div class="list-section" style="margin-top:20px;">
                <h4>Tanımlı Kategoriler/Köyler</h4>
                <ul id="cariKategoriListesiUl"></ul>
            </div>
        </div>
        <hr class="dont-calisan">
        <div class="settings-section dont-calisan">
            <h3>Kullanıcı Yönetimi</h3>
            <form id="kullaniciForm">
                <input type="hidden" id="kullaniciEditId">
                <div class="form-grid">
                    <div class="form-group"><label for="kullaniciAdi">Kullanıcı E-posta:</label><input type="email" id="kullaniciAdi" required></div>
                    <div class="form-group"><label for="kullaniciSifre">Şifre:</label><input type="password" id="kullaniciSifre" required></div>
                </div>
                <button type="submit" class="btn" id="kullaniciKaydetBtn">Çalışan Ekle</button>
            </form>
            <div class="list-section">
                <h4>Kullanıcı Listesi</h4>
                <table>
                    <thead><tr><th>Kullanıcı Adı</th><th>Rol</th><th class="dont-print">İşlemler</th></tr></thead>
                    <tbody id="kullaniciListesiBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<section id="tank-yonetimi" class="module-section hidden-section">
    <div class="module-header"><h2>💧 Tank Yönetimi</h2></div>
    <div class="container">
        <div class="form-section">
            <h3><span id="tankFormBaslik">Yeni Tank Tanımla</span></h3>
            <form id="tankForm">
                <input type="hidden" id="tankEditId">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr auto;">
                    <div class="form-group">
                        <label for="tankAdi">Tank Adı:</label>
                        <input type="text" id="tankAdi" required placeholder="Örn: Ana Tank 1">
                    </div>
                    <div class="form-group">
                        <label for="tankKapasite">Kapasite (Litre):</label>
                        <input type="number" id="tankKapasite" required placeholder="Örn: 5000">
                    </div>
                    <div style="align-self: end;">
                        <button type="submit" class="btn btn-primary" id="tankKaydetBtn">Kaydet</button>
                        <button type="button" class="btn" id="tankFormTemizleBtn" style="display:none;">Yeni</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="list-section">
            <h3>Tanımlı Tanklar</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tank Adı</th>
                        <th>Kapasite</th>
                        <th>Mevcut Miktar</th>
                        <th>Doluluk Oranı</th>
                        <th class="dont-print">İşlemler</th>
                    </tr>
                </thead>
                <tbody id="tankListesiBody"></tbody>
            </table>
        </div>
    </div>
</section>

<section id="tank-aktarim" class="module-section hidden-section">
    <div class="module-header"><h2>→ Tanktan Cari'ye Aktarım</h2></div>
    <div class="container">
        <div class="form-section">
            <h3>Tanktan Süt Aktarımı</h3>
            <form id="tankAktarimForm">
    <input type="hidden" id="aktarimEditId">
    <div class="form-grid">
        <div class="form-group">
            <label for="aktarimKaynakTank">Kaynak Tank:</label>
            <select id="aktarimKaynakTank" required></select>
            <small>Mevcut Miktar: <strong id="kaynakTankMiktar">0.00 Lt</strong></small>
        </div>
        <div class="form-group">
            <label for="aktarimHedefCari">Hedef Cari (Sütün Satıldığı Firma):</label>
            <select id="aktarimHedefCari" required></select>
        </div>
        <div class="form-group">
            <label for="aktarimMiktar">Aktarılacak Miktar (Litre):</label>
            <input type="number" id="aktarimMiktar" step="0.1" required>
        </div>
        <div class="form-group">
            <label for="aktarimFiyat">Birim Fiyat (TL/Litre):</label>
            <input type="number" id="aktarimFiyat" step="0.01" required>
        </div>
        <div class="form-group">
            <label for="aktarimTarih">İşlem Tarihi:</label>
            <input type="date" id="aktarimTarih" required>
        </div>
    </div>
    <button type="submit" class="btn btn-primary" id="aktarimKaydetBtn">Aktarımı Tamamla</button>
    <button type="button" class="btn" id="aktarimFormTemizleBtn" style="display:none;" onclick="resetAktarimForm()">Yeni Aktarım</button>
</form>
        </div>

        <div class="list-section" style="margin-top: 40px;">
            <h3>Aktarım Geçmişi (En Yeni Üstte)</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tarih / Saat</th>
                        <th>Kaynak Tank</th>
                        <th>Hedef Cari</th>
                        <th>Miktar (Lt)</th>
                        <th>Fiyat</th>
                        <th>Tutar</th>
                        <th class="dont-print">İşlemler</th>
                    </tr>
                </thead>
                <tbody id="aktarimGecmisiBody"></tbody>
            </table>
        </div>
        </div>
</section>



        </section>

    </div> 
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
        authDomain: "sut-takip-projem.firebaseapp.com",
        projectId: "sut-takip-projem",
        storageBucket: "sut-takip-projem.appspot.com",
        messagingSenderId: "512756958486",
        appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
        measurementId: "G-LYLT9WFVNK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

	let currentUserRole = '';
	let currentUserId = '';
	let sahipId = '';
	let globalSettings = { defaultMilkPrice: 15.50 };
	let editingCariId = null, editingYemTanimId = null, editingYemAlisId = null, editingYemSatisId = null, editingOdemeId = null;
	let gunlukSutunChartInstance = null;
	let aylikSutunChartInstance = null;
	let tankDataMap = new Map();
	let sutAlimGecmisiListener = null; // Süt alım geçmişi için dinleyici
	let topluGirisListener = null;     // Toplu giriş formu için dinleyici
	let dashboardTankListener = null;  // Kontrol paneli tankları için dinleyici
	let hareketDokumuListener = null; 
	let lastVisibleHareket = null;
	let firstVisibleHareketStack = [];
	let hareketPageCount = 1;

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.error('Service Worker registration failed: ', err));
        });
    }

    Chart.register(ChartDataLabels);

auth.onAuthStateChanged(async (user) => {
        if (user) {
		            document.getElementById('logoutUserEmail').textContent = user.email;

            currentUserId = user.uid;
            try {
                const userDoc = await db.collection('kullanicilar').doc(currentUserId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUserRole = userData.rol;
                    sahipId = userData.sahipId;

                    if (currentUserRole === 'admin' && !sahipId) {
                        sahipId = currentUserId;
                    }
                    if (!sahipId) {
                        alert('Kullanıcı profilinizde "sahipId" alanı bulunamadı. Lütfen yöneticinizle iletişime geçin.');
                        handleLogout();
                        return;
                    }

                    // === YENİ EKLENEN KOD BAŞLANGICI ===
                    if (currentUserRole === 'calisan') {
                        // Eğer rol 'calisan' ise, hızlı giriş sayfasına yönlendir ve geri kalan kodu çalıştırma.
                        window.location.href = 'hizli-giris.html';
                        return; 
                    }

                    initializeApp();
                } else {
                    alert("Giriş başarılı ancak kullanıcı profili veritabanında bulunamadı.");
                    handleLogout();
                }
            } catch (error) {
                console.error("Kullanıcı profili alınırken hata:", error);
                alert("Veritabanına erişirken bir sorun oluştu.");
                handleLogout();
            }
        } else {
            window.location.href = 'login.html';
        }
    });

    function initializeApp() {
        const sidebarNav = document.getElementById('sidebarNav');
        const moduleSections = document.querySelectorAll('.main-content .module-section');
        const logoutButton = document.getElementById('logoutButton');
        const cariForm = document.getElementById('cariForm');
        const cariFormTemizleBtn = document.getElementById('cariFormTemizleBtn');
        const yemTanimForm = document.getElementById('yemTanimForm');
        const yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
        const yemAlisForm = document.getElementById('yemAlisForm');
        const yemAlisFormTemizleBtn = document.getElementById('yemAlisFormTemizleBtn');
        const yemSatisForm = document.getElementById('yemSatisForm');
        const yemSatisFormTemizleBtn = document.getElementById('yemSatisFormTemizleBtn');
        const odemeForm = document.getElementById('odemeForm');
        const odemeFormTemizleBtn = document.getElementById('odemeFormTemizleBtn');
        const ayarlarForm = document.getElementById('ayarlarForm');
        const cariKategoriForm = document.getElementById('cariKategoriForm');
        const kullaniciForm = document.getElementById('kullaniciForm');
        const sifreDegistirForm = document.getElementById('sifreDegistirForm');
        const cariSearchInput = document.getElementById('cariSearchInput');
        const cariKategoriFiltre = document.getElementById('cariKategoriFiltre');
        const cariListesiYazdirBtn = document.getElementById('cariListesiYazdirBtn');
        const topluGirisTarihInput = document.getElementById('topluGirisTarih');
        const topluGirisKategoriSelect = document.getElementById('topluGirisKategori');
        const sutDuzenleForm = document.getElementById('sutDuzenleForm');
        const odemeCariSecimi = document.getElementById('odemeYapilanTedarikci');
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        const sidebar = document.querySelector('.sidebar');
        const tankForm = document.getElementById('tankForm');
        const tankFormTemizleBtn = document.getElementById('tankFormTemizleBtn');
        const tankAktarimForm = document.getElementById('tankAktarimForm');
        const aktarimKaynakTankSelect = document.getElementById('aktarimKaynakTank');
 window.yemDataMap = new Map();
    window.cariDataMap = new Map();
        if (menuToggleBtn && sidebar) {
            menuToggleBtn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
            sidebar.addEventListener('click', (event) => {
                if (window.innerWidth <= 1024 && event.target.closest('a.nav-link')) {
                    sidebar.classList.add('collapsed');
                }
            });
        }

        applyRolePermissions();
        loadAndRenderAllData();

loadAllYemlerToCache();
    loadAllCarilerToCache();
                updateMonthlyStats(); 


        
sidebarNav.addEventListener('click', function(event) {
            const link = event.target.closest('a.nav-link');
            if (!link || link.id === 'logoutButton') return;
            event.preventDefault();
            
            sidebarNav.querySelectorAll('a.nav-link').forEach(lnk => lnk.classList.remove('active'));
            link.classList.add('active');
            
            const targetId = link.getAttribute('href').substring(1);
            moduleSections.forEach(section => { section.style.display = 'none'; });
            const activeSection = document.getElementById(targetId);
            if(activeSection) activeSection.style.display = 'block';
            
            // İlgili bölüme tıklandığında çalışacak fonksiyonlar
            if (targetId === 'dashboard') { 
                updateDashboardStats();
                updateMonthlyStats();
            }
            if (targetId === 'cari-yonetimi') {
                populateCariKategoriFiltre();
                renderCariListesi();
                populateCariKategoriSelect(document.getElementById('cariKategori'));
                generateNextCariKodu();
            }
            if (targetId === 'sut-alimi') { 
                if(topluGirisTarihInput) topluGirisTarihInput.value = getTodayForInput(); 
                populateCariKategoriSelect(topluGirisKategoriSelect); 
                populateTankSelect(document.getElementById('topluGirisTank')); 
                renderTopluSutGirisFormu(); 
                renderSutAlimGecmisi(); 
            }
            if (targetId === 'yem-stok-yonetimi') { 
                populateCariSelect(document.getElementById('yemAlisTedarikci'), 'tedarikçi'); 
                populateYemSelect(document.getElementById('yemSecimiAlis')); 
                populateYemSelect(document.getElementById('sayimYemSecimi')); 
                renderStokSayimGecmisi(); 
                renderYemAlisHareketleri(); 
                renderYemStokListesi(); 
            }
            if (targetId === 'yem-satisi') { 
                populateCariSelect(document.getElementById('yemAlanTedarikci'), 'üretici'); 
                populateYemSelect(document.getElementById('yemSecimiSatis')); 
                renderYemSatisListesi(); 
            }
            if (targetId === 'tahsilat-ve-odemeler') { 
                populateCariSelect(document.getElementById('odemeYapilanTedarikci')); 
                renderOdemeListesi(); 
            }
            if (targetId === 'hesap-ozeti'){ 
                populateCariSelect(document.getElementById('raporCariSecimi')); 
                if(!document.getElementById('raporTarihAraligi').value) document.getElementById('raporTarihAraligi').value = getMonthYearForInput(); 
            }
            if (targetId === 'sut-alim-raporu'){ 
                populateCariSelect(document.getElementById('sutRaporuTedarikciSecimi'), 'üretici'); 
                populateCariKategoriSelect(document.getElementById('sutRaporuKategoriSecimi'), "Tümü"); 
                
                const baslangicTarihiInput = document.getElementById('sutRaporuBaslangicTarihi');
                const bitisTarihiInput = document.getElementById('sutRaporuBitisTarihi');
                if (baslangicTarihiInput && !baslangicTarihiInput.value && bitisTarihiInput && !bitisTarihiInput.value) {
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const formatForInput = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };
                    baslangicTarihiInput.value = formatForInput(firstDayOfMonth);
                    bitisTarihiInput.value = formatForInput(today);
                }
            }
            if (targetId === 'aylik-yem-raporu') {
                if (!document.getElementById('yemRaporuAySecimi').value) {
                    document.getElementById('yemRaporuAySecimi').value = getMonthYearForInput();
                }
            } else if (targetId === 'dinamik-sut-raporu') {
                populatePeriodSelect();
                populateCariKategoriSelect(document.getElementById('karneRaporuKategoriSecimi'), "Tüm Kategoriler");
            } else if (targetId === 'hareket-dokumu') {
                firstVisibleHareketStack = []; 
    lastVisibleHareket = null; 
    hareketPageCount = 1; 
    renderHareketDokumu('initial'); 
            } else if (targetId === 'ayarlar') {
                renderCariKategoriListesi();
                getSettings();
                if (currentUserRole === 'admin') {
                    renderKullaniciListesi();
                }
            }
            if (targetId === 'tank-yonetimi') { 
                renderTankListesi(); 
            }
            if (targetId === 'tank-aktarim') { 
                populateTankSelect(document.getElementById('aktarimKaynakTank'));
                populateCariSelect(document.getElementById('aktarimHedefCari'), 'süt alıcı');
                if(document.getElementById('aktarimTarih')) document.getElementById('aktarimTarih').value = getTodayForInput();
                renderAktarimGecmisi();
            }

            // YENİ EKLENEN OTOMATİK KAPANMA ÖZELLİĞİ
            // Küçük ekranlarda (1024px ve altı), bir menü linkine tıklandığında
            // kenar çubuğunun otomatik olarak kapanmasını sağlar.
            if (window.innerWidth <= 1024 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                if (menuToggleBtn) {
                     menuToggleBtn.classList.remove('active');
                }
            }
        });
        
        logoutButton.addEventListener('click', handleLogout);
        cariForm.addEventListener('submit', handleCariKaydet);
        yemTanimForm.addEventListener('submit', handleYemTanimKaydet);
        yemAlisForm.addEventListener('submit', handleYemAlisKaydet);
        yemSatisForm.addEventListener('submit', handleYemSatisKaydet);
        odemeForm.addEventListener('submit', handleOdemeKaydet);
        ayarlarForm.addEventListener('submit', handleAyarlarKaydet);
        cariKategoriForm.addEventListener('submit', handleCariKategoriEkle);
        if(kullaniciForm) kullaniciForm.addEventListener('submit', handleKullaniciKaydet);
        sifreDegistirForm.addEventListener('submit', handleSifreDegistir);
        if(sutDuzenleForm) sutDuzenleForm.addEventListener('submit', handleSutAlimiGuncelle);
        tankForm.addEventListener('submit', handleTankKaydet);
        tankAktarimForm.addEventListener('submit', handleTankAktarim);

        if(cariFormTemizleBtn) cariFormTemizleBtn.addEventListener('click', resetCariForm);
        if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.addEventListener('click', resetYemTanimForm);
        if(yemAlisFormTemizleBtn) yemAlisFormTemizleBtn.addEventListener('click', resetYemAlisForm);
        if(yemSatisFormTemizleBtn) yemSatisFormTemizleBtn.addEventListener('click', resetYemSatisForm);
        if(odemeFormTemizleBtn) odemeFormTemizleBtn.addEventListener('click', resetOdemeForm);
        if(tankFormTemizleBtn) tankFormTemizleBtn.addEventListener('click', resetTankForm);
        
        cariSearchInput.addEventListener('input', renderCariListesi);
        cariKategoriFiltre.addEventListener('change', renderCariListesi);
document.getElementById('cariTarihselRaporBtn')?.addEventListener('click', renderCariListesi);
        topluGirisTarihInput?.addEventListener('change', () => { renderTopluSutGirisFormu(); renderSutAlimGecmisi(); });
        topluGirisKategoriSelect?.addEventListener('change', renderTopluSutGirisFormu);
        document.getElementById('aylikChartGosterBtn')?.addEventListener('click', renderAylikSutunGrafik);
        
        if(odemeCariSecimi) {
            odemeCariSecimi.addEventListener('change', async (event) => {
                const cariId = event.target.value;
                const bakiyeBilgiAlani = document.getElementById('cariBakiyeBilgisi');
                if (!cariId) { bakiyeBilgiAlani.textContent = ''; return; }
                try {
                    bakiyeBilgiAlani.textContent = 'Bakiye hesaplanıyor...';
                    const bakiyeDetay = await calculateCariBakiyeDetayli(cariId);
                    const bakiye = bakiyeDetay.bakiye;
                    if (bakiye < 0) {
                        bakiyeBilgiAlani.textContent = `Bakiye: ${formatCurrency(bakiye)} (Cari Borçlu)`;
                        bakiyeBilgiAlani.style.color = 'red';
                    } else {
                        bakiyeBilgiAlani.textContent = `Bakiye: ${formatCurrency(bakiye)} (Cari Alacaklı)`;
                        bakiyeBilgiAlani.style.color = 'green';
                    }
                } catch (error) {
                    bakiyeBilgiAlani.textContent = 'Bakiye alınamadı.';
                }
            });
        }
        
        aktarimKaynakTankSelect?.addEventListener('change', (event) => {
            const tankId = event.target.value;
            const miktarGosterge = document.getElementById('kaynakTankMiktar');
            if (tankId && window.tankDataMap && window.tankDataMap.has(tankId)) {
                miktarGosterge.textContent = `${window.tankDataMap.get(tankId).mevcutLitre.toFixed(2)} Lt`;
            } else {
                miktarGosterge.textContent = '0.00 Lt';
            }
        });

        document.getElementById('raporOlusturBtn')?.addEventListener('click', handleHesapOzetiRaporuOlustur);
        document.getElementById('sutRaporuOlusturBtn')?.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: false}));
        document.getElementById('sutRaporuTumunuGosterBtn')?.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: true, kategori: false}));
        document.getElementById('sutRaporuKategoriGosterBtn')?.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: true}));
        document.getElementById('yemAdetRaporuBtn')?.addEventListener('click', () => handleYemPivotRaporu('adet'));
        document.getElementById('yemDetayliSatisRaporuBtn')?.addEventListener('click', () => handleYemPivotRaporu('satis'));
        document.getElementById('yemMusteriKarRaporuBtn')?.addEventListener('click', () => handleYemPivotRaporu('karlilik'));
document.getElementById('karneRaporuOlusturBtn')?.addEventListener('click', handleDinamikSutRaporu);
	document.getElementById('hareketNextBtn')?.addEventListener('click', () => renderHareketDokumu('next'));
	document.getElementById('hareketPrevBtn')?.addEventListener('click', () => renderHareketDokumu('prev'));
	document.getElementById('cariDurumFiltre')?.addEventListener('change', renderCariListesi);
cariListesiYazdirBtn?.addEventListener('click', () => handleYazdir('cari-yonetimi'));
	document.getElementById('stokSayimForm')?.addEventListener('submit', handleStokSayimKaydet);
	document.getElementById('sayimYemSecimi')?.addEventListener('change', updateSayimForm);
	document.getElementById('sayimFizikselStok')?.addEventListener('input', updateSayimForm);
document.getElementById('raporYazdirBtn')?.addEventListener('click', () => handleYazdir('hesap-ozeti'));
        document.getElementById('sutRaporuYazdirBtn')?.addEventListener('click', () => handleYazdir('sut-alim-raporu'));
        document.getElementById('yemRaporuYazdirBtn')?.addEventListener('click', () => handleYazdir('aylik-yem-raporu'));
        document.getElementById('karneYazdirBtn')?.addEventListener('click', () => handleYazdir('dinamik-sut-raporu'));
	document.getElementById('karnePdfBtn')?.addEventListener('click', () => exportTableToPdf('dinamikRaporContainer', 'sut_karnesi', 'Aylık Süt Karnesi', 				'karnePdfBtn'));
	document.getElementById('karneXlsxBtn')?.addEventListener('click', () => exportTableToExcel('dinamikRaporContainer', 'sut_karnesi'));
	document.getElementById('hesapOzetiPdfBtn')?.addEventListener('click', () => exportTableToPdf('report-content-to-print', 'hesap_ozeti', 'Cari Hesap Özeti', 			'hesapOzetiPdfBtn'));
	document.getElementById('hesapOzetiXlsxBtn')?.addEventListener('click', () => exportTableToExcel('hesap-ozeti-export-area', 'hesap_ozeti'));
	document.getElementById('sutRaporuPdfBtn')?.addEventListener('click', () => exportTableToPdf('sutAlimRaporAlani', 'sut_alim_raporu', 'Aylık Süt Alım Raporu', 			'sutRaporuPdfBtn'));
	document.getElementById('sutRaporuXlsxBtn')?.addEventListener('click', () => exportTableToExcel('sut-raporu-export-area', 'sut_alim_raporu'));
	document.getElementById('yemRaporuPdfBtn')?.addEventListener('click', () => exportTableToPdf('yemRaporuAlani', 'yem_raporu', 'Aylık Yem Raporu', 				'yemRaporuPdfBtn'));
	document.getElementById('yemRaporuXlsxBtn')?.addEventListener('click', () => exportTableToExcel('yemRaporuAlani', 'yem_raporu'));
	document.getElementById('yemAlisMiktar').addEventListener('input', () => hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar'));
    	document.getElementById('yemAlisBirimFiyati').addEventListener('input', () => hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar'));
    	document.getElementById('yemSatisMiktar').addEventListener('input', () => hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar'));
    	document.getElementById('yemSatisBirimFiyati').addEventListener('input', () => hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar'));
    	document.getElementById('yemSecimiSatis').addEventListener('change', (event) => {
        const yemId = event.target.value;
        const fiyatInput = document.getElementById('yemSatisBirimFiyati');
        if (yemId && window.yemDataMap && window.yemDataMap.has(yemId)) {
            fiyatInput.value = window.yemDataMap.get(yemId).satisFiyati || 0;
        } else {fiyatInput.value = '';}hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar');});}

async function loadAndRenderAllData() {
    console.log("Veri yükleme fonksiyonları kontrollü bir şekilde başlatılıyor...");
    try { await renderCariListesi(); } catch (e) { console.warn("Cari listesi yüklenemedi.", e); }
    try { await renderYemStokListesi(); } catch (e) { console.warn("Yem stoku yüklenemedi.", e); }
    try { await renderOdemeListesi(); } catch (e) { console.warn("Ödeme listesi yüklenemedi.", e); }
    try { await renderCariKategoriListesi(); } catch (e) { console.warn("Cari kategori listesi yüklenemedi.", e); }
    try { await populateCariKategoriFiltre(); } catch (e) { console.warn("Cari kategori filtresi doldurulamadı.", e); }
    try { await populateCariKategoriSelect(document.getElementById('topluGirisKategori')); } catch (e) { console.warn("Toplu giriş kategorisi doldurulamadı.", e); }
    try { await updateDashboardStats(); } catch (e) { console.warn("Panel istatistikleri güncellenemedi.", e); }
    console.log("Veri yükleme denemeleri tamamlandı.");
}

function generateId() { return db.collection('_').doc().id; }

function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('tr-TR'); }

function getTodayForInput() { return new Date().toISOString().split('T')[0]; }

function formatMonthYear(ayYil) {
    if (!ayYil) return '';
    const [year, month] = ayYil.split('-');
    const date = new Date(year, month - 1);
    return date.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
}

function getMonthYearForInput() { const d = new Date(); return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;}

function formatCurrency(number) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(number); }

function setEditingMode(formBaslikEl, kaydetBtnEl, temizleBtnEl, editIdVar, formType) { if(!formBaslikEl || !kaydetBtnEl) return; formBaslikEl.textContent = editIdVar ? `${formType} Bilgilerini Düzenle` : `Yeni ${formType} Kaydı`; kaydetBtnEl.textContent = editIdVar ? 'Güncelle' : 'Kaydet'; if (temizleBtnEl) temizleBtnEl.style.display = editIdVar ? 'inline-block' : 'none'; }

function applyRolePermissions() {
    const bodyElement = document.body;
    bodyElement.className = `role-${currentUserRole}`;
    const calisanAllowed = ['#dashboard', '#sut-alimi', '#yem-satisi', '#cari-yonetimi'];
    const activeLink = document.querySelector('#sidebarNav a.nav-link.active');
    const activeHref = activeLink ? activeLink.getAttribute('href') : '#dashboard';
    if (currentUserRole === 'calisan' && !calisanAllowed.includes(activeHref)) {
        document.querySelector('#sidebarNav a.nav-link[href="#dashboard"]').click();
    }
}

function handleLogout() { auth.signOut().then(() => { window.location.href = 'login.html'; }).catch(error => console.error("Logout error", error)); }

async function getSettings() {
    const varsayilanSutFiyatiInput = document.getElementById('varsayilanSutFiyati');
    const currentUser = auth.currentUser;
    if (!currentUser) {
        console.error("getSettings çağrıldı ancak aktif bir kullanıcı oturumu bulunamadı.");
        return;
    }
    const settingsRef = db.collection('ayarlar').doc(sahipId);
    try {
        const doc = await settingsRef.get();
        if (doc.exists) {
            globalSettings = doc.data();
        }
        if (globalSettings && globalSettings.defaultMilkPrice) {
            varsayilanSutFiyatiInput.value = globalSettings.defaultMilkPrice.toFixed(2);
        } else {
            varsayilanSutFiyatiInput.value = (15.50).toFixed(2);
        }
    } catch(e) { console.error("Ayarlar alınırken hata: ", e); }
}


function populatePeriodSelect() {
    const selectEl = document.getElementById('karneRaporuPeriyotSecimi');
    if (!selectEl) return;

    const now = new Date();
    const ayIsimleri = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
    let optionsHTML = '';

    for (let i = 0; i < 6; i++) {
        let date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        let year = date.getFullYear();
        let month = date.getMonth(); // 0-11
        let monthStr = String(month + 1).padStart(2, '0');
        let monthName = ayIsimleri[month];

        let lastDay = new Date(year, month + 1, 0).getDate();
        optionsHTML += `<option value="${year}-${monthStr}-2">${monthName} ${year} - 2. Yarı (16-${lastDay})</option>`;

        optionsHTML += `<option value="${year}-${monthStr}-1">${monthName} ${year} - 1. Yarı (1-15)</option>`;
    }
    selectEl.innerHTML = optionsHTML;
}



async function handleAyarlarKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }
    const varsayilanSutFiyatiInput = document.getElementById('varsayilanSutFiyati');
    const yeniFiyat = parseFloat(varsayilanSutFiyatiInput.value);
    
    if (!isNaN(yeniFiyat) && yeniFiyat >= 0) {
        try {
            await db.collection('ayarlar').doc(sahipId).set({ defaultMilkPrice: yeniFiyat, sahipId: sahipId }, { merge: true });
            globalSettings.defaultMilkPrice = yeniFiyat;
            alert('Genel ayarlar kaydedildi.');

            const sutAlimiSekmesi = document.getElementById('sut-alimi');
            if (sutAlimiSekmesi && sutAlimiSekmesi.style.display === 'block') {
                await renderTopluSutGirisFormu();
                console.log('Süt alım formu yeni fiyatla güncellendi.');
            }

        } catch (error) {
            console.error("Ayarlar kaydedilirken hata:", error);
            alert("Ayarlar kaydedilemedi.");
        }
    } else {
        alert('Lütfen geçerli bir süt fiyatı giriniz.');
    }
}


async function handleSifreDegistir(event) {
    event.preventDefault();
    const eskiSifre = document.getElementById('eskiSifre').value;
    const yeniSifre = document.getElementById('yeniSifre').value;
    const yeniSifreTekrar = document.getElementById('yeniSifreTekrar').value;

    if(!yeniSifre || yeniSifre.length < 6) { alert("Yeni şifre en az 6 karakter olmalıdır!"); return; }
    if(yeniSifre !== yeniSifreTekrar) { alert("Yeni şifreler uyuşmuyor!"); return; }

    const user = auth.currentUser;
    if (!user) { alert("Lütfen giriş yapın."); return; }
    const credential = firebase.auth.EmailAuthProvider.credential(user.email, eskiSifre);

    try {
        await user.reauthenticateWithCredential(credential);
        await user.updatePassword(yeniSifre);
        alert("Şifreniz başarıyla güncellendi!");
        document.getElementById('sifreDegistirForm').reset();
    } catch (error) {
        console.error("Şifre güncelleme hatası:", error);
        alert("Eski şifre hatalı veya bir sorun oluştu.");
    }
}


// NEW, ISOLATED FUNCTION FOR MONTHLY STATS
async function updateMonthlyStats() {
    try {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        
        const startDateStr = new Date(year, month, 1).toISOString().split('T')[0];
        const endDateStr = new Date(year, month + 1, 0).toISOString().split('T')[0];

        const thisMonthSutSnapshot = await db.collection('sut_alimlari')
            .where("sahipId", "==", sahipId)
            .where("tarih", ">=", startDateStr)
            .where("tarih", "<=", endDateStr)
            .get();

        let buAykiToplamSut = 0;
        let buAykiToplamDeger = 0; // We will calculate this again here

        thisMonthSutSnapshot.forEach(doc => {
            const alim = doc.data();
            if (alim.islemKaynagi !== 'tank-aktarim') {
                buAykiToplamSut += alim.toplam || 0;
                buAykiToplamDeger += alim.toplamTutar || 0; // Also calculate the monetary value
            }
        });
        
        const bugunAyinKaci = now.getDate();
        const gunlukOrtalama = (buAykiToplamSut > 0) ? (buAykiToplamSut / bugunAyinKaci) : 0;

        // This function will now ONLY update the monthly cards
        document.getElementById('dashBuAykiToplamSut').textContent = Math.floor(buAykiToplamSut);
        document.getElementById('dashBuAykiSutDegeri').textContent = formatCurrency(buAykiToplamDeger);
        document.getElementById('aylikGunOrtalamasi').textContent = gunlukOrtalama.toFixed(1);

    } catch(e) {
        console.error("Aylık süt istatistikleri alınırken hata:", e);
        document.getElementById('dashBuAykiToplamSut').textContent = 'Hata';
        document.getElementById('dashBuAykiSutDegeri').textContent = 'Hata';
    }
}

async function updateDashboardStats() {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    // --- 1. GÜNLÜK SÜT İSTATİSTİKLERİ (YENİ BASİT MANTIK) ---
    try {
        // --- Gerekli Tarihlerin Hesaplanması (Sadeleştirildi) ---
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);

        const formatForDB = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const todayStr = formatForDB(today);
        const yesterdayStr = formatForDB(yesterday);
        
        const formatForDisplay = (date) => {
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
        };
        const todayLabel = formatForDisplay(today);

        // --- Gerekli Verilerin Veritabanından Çekilmesi (Sadeleştirildi) ---
        const todaySutPromise = db.collection('sut_alimlari').where("sahipId", "==", sahipId).where("tarih", "==", todayStr).get();
        const yesterdaySutPromise = db.collection('sut_alimlari').where("sahipId", "==", sahipId).where("tarih", "==", yesterdayStr).get();
        const carilerPromise = db.collection('cariler').where("sahipId", "==", sahipId).where("durum", "==", "aktif").get();
        const yemlerPromise = db.collection('yemler').where("sahipId", "==", sahipId).get();

        const [todaySnapshot, yesterdaySnapshot, carilerSnapshot, yemlerSnapshot] = await Promise.all([
            todaySutPromise,
            yesterdaySutPromise,
            carilerPromise,
            yemlerPromise
        ]);

        // --- Verilerin Alınması ---
        const getSutData = (snapshot) => {
            if (snapshot.empty) return { sabah: 0, aksam: 0 };
            let totalSabah = 0, totalAksam = 0;
            snapshot.forEach(doc => {
                totalSabah += doc.data().sabah || 0;
                totalAksam += doc.data().aksam || 0;
            });
            return { sabah: totalSabah, aksam: totalAksam };
        };

        const todayData = getSutData(todaySnapshot);
        const yesterdayData = getSutData(yesterdaySnapshot);

        // --- YENİ BASİT MANTIĞA GÖRE HESAPLAMALAR ---
        const bugunkuToplamSut = todayData.sabah + todayData.aksam;
        const dunkuToplamSut = yesterdayData.sabah + yesterdayData.aksam;
        const fark = bugunkuToplamSut - dunkuToplamSut;
        
        // --- Arayüzün Güncellenmesi ---
        const karsilastirmaEl = document.getElementById('dunKarsilastirma');
        if (fark > 0) {
            karsilastirmaEl.textContent = `(Düne göre +${fark.toFixed(2)} Lt)`;
            karsilastirmaEl.style.color = 'green';
        } else if (fark < 0) {
            karsilastirmaEl.textContent = `(Düne göre ${fark.toFixed(2)} Lt)`;
            karsilastirmaEl.style.color = 'red';
        } else {
            karsilastirmaEl.textContent = '(Düne göre değişiklik yok)';
            karsilastirmaEl.style.color = '#7f8c8d';
        }

        // Kartlar bugünün verileriyle güncelleniyor
        document.getElementById('dashToplamSut').textContent = bugunkuToplamSut.toFixed(2);
        document.getElementById('dashSabahSut').textContent = todayData.sabah.toFixed(2);
        document.getElementById('dashAksamSut').textContent = todayData.aksam.toFixed(2);
        document.getElementById('dashAktifMusteri').textContent = carilerSnapshot.size;
        
        // Tarih etiketleri yeni mantığa göre güncelleniyor
        document.getElementById('sabahSutTarih').textContent = `(${todayLabel})`;
        document.getElementById('aksamSutTarih').textContent = `(${todayLabel})`;
        document.getElementById('toplamSutTarihAraligi').textContent = `${todayLabel} Toplamı`;

        document.getElementById('dashYemSayisi').textContent = yemlerSnapshot.size;

    } catch (e) { console.error("Dashboard günlük istatistikleri alınırken hata", e); }
    
    // --- DİĞER BÖLÜMLERDE DEĞİŞİKLİK YOK ---
    
    // --- 2. AYLIK SÜT VE DEĞER HESAPLAMASI ---
    try {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const startDateStr = new Date(year, month, 1).toISOString().split('T')[0];
        const endDateStr = new Date(year, month + 1, 0).toISOString().split('T')[0];
        const thisMonthSutSnapshot = await db.collection('sut_alimlari').where("sahipId", "==", sahipId).where("tarih", ">=", startDateStr).where("tarih", "<=", endDateStr).get();
        let buAykiToplamSut = 0;
        let buAykiToplamDeger = 0;
        thisMonthSutSnapshot.forEach(doc => {
            const alim = doc.data();
            if (alim.islemKaynagi !== 'tank-aktarim') {
                buAykiToplamSut += alim.toplam || 0;
                buAykiToplamDeger += alim.toplamTutar || 0;
            }
        });
        const bugunAyinKaci = now.getDate();
        const gunlukOrtalama = (buAykiToplamSut > 0) ? (buAykiToplamSut / bugunAyinKaci) : 0;
        document.getElementById('dashBuAykiToplamSut').textContent = Math.floor(buAykiToplamSut);
        document.getElementById('dashBuAykiSutDegeri').textContent = formatCurrency(buAykiToplamDeger);
        document.getElementById('aylikGunOrtalamasi').textContent = gunlukOrtalama.toFixed(1);
    } catch(e) { console.error("Dashboard aylık süt istatistikleri alınırken hata:", e); }
    
    // --- 3. BAKİYE TOPLAMLARI ---
    try {
        const allCarilerSnapshot = await db.collection('cariler').where("sahipId", "==", sahipId).get();
        let toplamMusteriBorcu = 0;
        let toplamMusteriAlacagi = 0;
        if(!allCarilerSnapshot.empty) {
            const bakiyePromises = allCarilerSnapshot.docs.map(doc => calculateCariBakiyeDetayli(doc.id));
            const tumBakiyeler = await Promise.all(bakiyePromises);
            tumBakiyeler.forEach(bakiyeDetay => {
                if (bakiyeDetay.bakiye > 0) {
                    toplamMusteriAlacagi += bakiyeDetay.bakiye;
                } else {
                    toplamMusteriBorcu += Math.abs(bakiyeDetay.bakiye);
                }
            });
        }
        document.getElementById('dashToplamAlacak').textContent = formatCurrency(toplamMusteriBorcu);
        document.getElementById('dashToplamBorc').textContent = formatCurrency(toplamMusteriAlacagi);
        const toplamBakiye = toplamMusteriAlacagi - toplamMusteriBorcu;
        const toplamBakiyeSpan = document.getElementById('dashToplamBakiye');
        const bakiyeUyariSpan = document.getElementById('bakiyeDurumUyarisi');
        const bakiyeKarti = document.getElementById('bakiyeDurumKarti');
        toplamBakiyeSpan.textContent = formatCurrency(toplamBakiye);
        if (toplamBakiye < 0) {
            bakiyeUyariSpan.textContent = "Genel Bakiye Borçlu!";
            bakiyeUyariSpan.style.color = 'red';
            toplamBakiyeSpan.style.color = 'red';
            bakiyeKarti.style.borderColor = 'red';
        } else {
            bakiyeUyariSpan.textContent = "Genel Bakiye Alacaklı";
            bakiyeUyariSpan.style.color = 'green';
            toplamBakiyeSpan.style.color = 'green';
            bakiyeKarti.style.borderColor = '#ddd';
        }
        const total = toplamMusteriBorcu + toplamMusteriAlacagi;
        const alacakYuzde = total > 0 ? (toplamMusteriBorcu / total) * 100 : 0;
        const borcYuzde = total > 0 ? (toplamMusteriAlacagi / total) * 100 : 0;
        document.getElementById('alacakBar').style.width = alacakYuzde + '%';
        document.getElementById('borcBar').style.width = borcYuzde + '%';
    } catch (e) { console.error("Dashboard bakiye toplamları alınırken hata", e); }
    
    // --- 4. GRAFİKLER ---
    try {
        if (typeof renderGunlukSutGrafik === 'function') await renderGunlukSutGrafik();
        if (typeof renderDashboardTanks === 'function') await renderDashboardTanks();
        const aylikChartInput = document.getElementById('aylikChartAySecimi');
        if (aylikChartInput && !aylikChartInput.value) {
            aylikChartInput.value = getMonthYearForInput();
        }
        if (typeof renderAylikSutunGrafik === 'function') await renderAylikSutunGrafik();
    } catch(e) { console.error("Kontrol paneli grafikleri oluşturulurken hata", e); }
}


async function handleCariKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert("Lütfen giriş yapın.");
        return;
    }

    const editingId = document.getElementById('cariEditId').value;
    
    // --- KALDIRILDI: Adı Soyadı zorunlu alan kontrolü kaldırıldı ---
    // const cariAdi = document.getElementById('cariAdiSoyadi').value;
    // if (!cariAdi) {
    //     alert("Adı Soyadı / Firma Adı alanı zorunludur.");
    //     return;
    // }

    const secilenGruplar = [];
    if (document.getElementById('grupUretici').checked) secilenGruplar.push('üretici');
    if (document.getElementById('grupTedarikci').checked) secilenGruplar.push('tedarikçi');
    if (document.getElementById('grupSutAlici').checked) secilenGruplar.push('süt alıcı');

    const rotaSirasiInput = document.getElementById('cariRotaSirasi').value;
    const yeniRotaSirasi = rotaSirasiInput ? parseInt(rotaSirasiInput, 10) : null;
    
    const formData = {
        kodu: document.getElementById('cariKodu').value,
        rotaSirasi: yeniRotaSirasi,
        adiSoyadi: document.getElementById('cariAdiSoyadi').value, // Kontrol kaldırıldığı için doğrudan alınıyor
        kategori: document.getElementById('cariKategori').value,
        durum: document.getElementById('cariDurum').value,
        cariTipi: document.getElementById('cariTipi').value,
        cariGrup: secilenGruplar,
        telefon: document.getElementById('cariTelefon').value,
        eposta: document.getElementById('cariEposta').value,
        adres: document.getElementById('cariAdres').value,
        bankaAdi: document.getElementById('cariBankaAdi').value,
        iban: document.getElementById('cariIban').value,
        vergiDairesi: document.getElementById('cariVergiDairesi').value,
        vergiNo: document.getElementById('cariVergiNo').value,
        notlar: document.getElementById('cariNotlar').value,
        sahipId: sahipId
    };

    try {
        if (editingId) {
            const cariRef = db.collection('cariler').doc(editingId);
            await db.runTransaction(async (transaction) => {
                const cariDoc = await transaction.get(cariRef);
                if (!cariDoc.exists) throw "Düzenlenecek cari bulunamadı!";
                
                const acilisBakiyeQuery = db.collection('odemeVeTahsilatlar')
                    .where('cariId', '==', editingId)
                    .where('aciklama', '==', 'Açılış Bakiyesi');
                const acilisBakiyeSnapshot = await acilisBakiyeQuery.get();
                acilisBakiyeSnapshot.forEach(doc => {
                    transaction.delete(doc.ref);
                });

                const eskiRotaSirasi = cariDoc.data().rotaSirasi;
                if (eskiRotaSirasi !== yeniRotaSirasi) {
                    if (yeniRotaSirasi && eskiRotaSirasi) {
                         if (yeniRotaSirasi > eskiRotaSirasi) {
                            const carilerToUpdateQuery = db.collection('cariler').where('sahipId', '==', sahipId).where('rotaSirasi', '>', eskiRotaSirasi).where('rotaSirasi', '<=', yeniRotaSirasi);
                            const snapshot = await carilerToUpdateQuery.get();
                            snapshot.forEach(doc => transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi - 1 }));
                        } else {
                            const carilerToUpdateQuery = db.collection('cariler').where('sahipId', '==', sahipId).where('rotaSirasi', '>=', yeniRotaSirasi).where('rotaSirasi', '<', eskiRotaSirasi);
                            const snapshot = await carilerToUpdateQuery.get();
                            snapshot.forEach(doc => transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi + 1 }));
                        }
                    } else if (yeniRotaSirasi && !eskiRotaSirasi) {
                        const carilerToUpdateQuery = db.collection('cariler').where('sahipId', '==', sahipId).where('rotaSirasi', '>=', yeniRotaSirasi);
                        const snapshot = await carilerToUpdateQuery.get();
                        snapshot.forEach(doc => transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi + 1 }));
                    } else if (!yeniRotaSirasi && eskiRotaSirasi) {
                         const carilerToUpdateQuery = db.collection('cariler').where('sahipId', '==', sahipId).where('rotaSirasi', '>', eskiRotaSirasi);
                        const snapshot = await carilerToUpdateQuery.get();
                        snapshot.forEach(doc => transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi - 1 }));
                    }
                }
                
                transaction.update(cariRef, formData);

                const acilisBakiye = parseFloat(document.getElementById('cariAcilisBakiye').value) || 0;
                const bakiyeTuru = document.getElementById('cariAcilisBakiyeTuru').value;
                if (acilisBakiye > 0 && bakiyeTuru !== 'yok') {
                    const bakiyeData = {
                        aciklama: "Açılış Bakiyesi",
                        cariId: editingId,
                        islemTuru: bakiyeTuru,
                        sahipId: sahipId,
                        tarih: new Date(1990, 0, 1).toISOString().split('T')[0],
                        tutar: acilisBakiye,
                        odemeTuru: 'Sistem'
                    };
                    const odemeRef = db.collection('odemeVeTahsilatlar').doc();
                    transaction.set(odemeRef, bakiyeData);
                }
            });
        } else {
            await db.runTransaction(async (transaction) => {
                if (yeniRotaSirasi) {
                    const carilerToUpdateQuery = db.collection('cariler').where('sahipId', '==', sahipId).where('rotaSirasi', '>=', yeniRotaSirasi);
                    const snapshot = await carilerToUpdateQuery.get();
                    snapshot.forEach(doc => {
                        transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi + 1 });
                    });
                }
                
                const newCariRef = db.collection('cariler').doc();
                transaction.set(newCariRef, formData);

                const acilisBakiye = parseFloat(document.getElementById('cariAcilisBakiye').value) || 0;
                const bakiyeTuru = document.getElementById('cariAcilisBakiyeTuru').value;
                if (acilisBakiye > 0 && bakiyeTuru !== 'yok') {
                    const bakiyeData = {
                        aciklama: "Açılış Bakiyesi",
                        cariId: newCariRef.id,
                        islemTuru: bakiyeTuru,
                        sahipId: sahipId,
                        tarih: new Date(1990, 0, 1).toISOString().split('T')[0],
                        tutar: acilisBakiye,
                        odemeTuru: 'Sistem'
                    };
                    const odemeRef = db.collection('odemeVeTahsilatlar').doc();
                    transaction.set(odemeRef, bakiyeData);
                }
            });
        }
        
        resetCariForm();
        await renderCariListesi();
        alert('Cari başarıyla kaydedildi!');

    } catch (error) {
        console.error("Cari kaydedilirken hata: ", error);
        alert("Cari kaydedilirken bir hata oluştu: " + error.message);
    }
}


async function renderCariListesi() {
    const cariListesiBody = document.getElementById('cariListesiBody');
    const cariListesiFooter = document.getElementById('cariListesiFooter');
    const cariSearchInput = document.getElementById('cariSearchInput');
    const cariKategoriFiltre = document.getElementById('cariKategoriFiltre');
    const uyariDiv = document.getElementById('cariRotaSirasiUyari');
    const searchTerm = cariSearchInput.value.toLowerCase();
    const kategori = cariKategoriFiltre.value;
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    // YENİ: Durum filtresinin değeri okunuyor.
    const durumFiltresi = document.getElementById('cariDurumFiltre').value;

    const tarihFiltresi = document.getElementById('cariTarihFiltresi').value;
    const raporTarihEtiketi = document.getElementById('raporTarihEtiketi');
    raporTarihEtiketi.textContent = tarihFiltresi ? `${formatDate(tarihFiltresi)} Tarihi İtibarıyla` : 'Güncel Durum';

    let query = db.collection('cariler').where("sahipId", "==", sahipId);
    if (kategori) {
        query = query.where("kategori", "==", kategori);
    }
    
    // YENİ: Eğer bir durum seçilmişse, sorguya durum filtresi ekleniyor.
    if (durumFiltresi) {
        query = query.where("durum", "==", durumFiltresi);
    }

    query = query.orderBy('rotaSirasi').orderBy('adiSoyadi');

    try {
        const snapshot = await query.get();
        let cariler = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const rotaSiraCounts = {};
        cariler.forEach(cari => {
            const sira = cari.rotaSirasi;
            if (sira && sira > 0) {
                rotaSiraCounts[sira] = (rotaSiraCounts[sira] || 0) + 1;
            }
        });

        const duplicates = Object.keys(rotaSiraCounts).filter(sira => rotaSiraCounts[sira] > 1);

        if (duplicates.length > 0) {
            uyariDiv.innerHTML = `<strong>⚠️ Uyarı:</strong> Aşağıdaki rota sıraları birden fazla cari için kullanılmış: <strong>${duplicates.join(', ')}</strong>. Lütfen bu carileri düzenleyerek her cariye benzersiz bir rota sırası atayın.`;
            uyariDiv.style.display = 'block';
        } else {
            uyariDiv.style.display = 'none';
        }

        if (searchTerm) {
            cariler = cariler.filter(c => c.kodu?.toLowerCase().includes(searchTerm) || c.adiSoyadi?.toLowerCase().includes(searchTerm));
        }
        
        cariListesiBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Bakiyeler hesaplanıyor...</td></tr>';
        
        const bakiyePromises = cariler.map(c => calculateCariBakiyeDetayli(c.id, tarihFiltresi));
        const bakiyeler = await Promise.all(bakiyePromises);
        
        cariListesiBody.innerHTML = '';
        cariListesiFooter.innerHTML = '';
        if (cariler.length === 0) {
            cariListesiBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Kayıtlı cari bulunmuyor.</td></tr>';
            return;
        }

        let genelToplamAlacak = 0, genelToplamBorc = 0;

        cariler.forEach((c, index) => {
            const row = cariListesiBody.insertRow();
            const bakiyeDetay = bakiyeler[index];
            if (bakiyeDetay) {
                genelToplamAlacak += bakiyeDetay.alacak;
                genelToplamBorc += bakiyeDetay.borc;
                const bakiye = bakiyeDetay.bakiye;
                const durumText = c.durum === 'aktif' ? 'Aktif' : 'Pasif';
                const durumStyle = c.durum === 'aktif' ? 'color:green;' : 'color:red;';
                const bakiyeStyle = bakiye >= 0 ? 'color:green;' : 'color:red;';
                const bakiyeText = `${formatCurrency(bakiye)} ${bakiye >= 0 ? '(A)' : '(B)'}`;
                
                row.innerHTML = `
    <td>${c.kodu || ''}</td>
    <td>${c.adiSoyadi || ''}</td>
    <td>${c.kategori || ''}</td>
    <td>${c.cariGrup || 'Belirtilmemiş'}</td>
    <td style="${duplicates.includes(String(c.rotaSirasi)) ? 'background-color:#fff3cd; color:red; font-weight:bold;' : ''}">${c.rotaSirasi || ''}</td>
    <td style="${durumStyle}">${durumText}</td>
    <td>${c.telefon || ''}</td>
    <td>${formatCurrency(bakiyeDetay.borc)}</td>
    <td>${formatCurrency(bakiyeDetay.alacak)}</td>
    <td style="${bakiyeStyle}">${bakiyeText}</td>
    
    <td class="dont-print" style="white-space: nowrap;">
        <button class="btn btn-edit btn-sm" onclick="editCari('${c.id}')">Düzenle</button>
        <button class="btn btn-delete btn-sm" onclick="deleteCari('${c.id}')">Sil</button>
    </td>`;
            }
        });

        const footerRow = cariListesiFooter.insertRow();
        const toplamBakiye = genelToplamAlacak - genelToplamBorc;
        const toplamBakiyeStyle = toplamBakiye >= 0 ? 'color:green;' : 'color:red;';
        const etiket = kategori ? `Kategori Toplamı` : 'Genel Toplam';
        
        footerRow.innerHTML = `
            <td colspan="7"><strong>${etiket}</strong></td>
            <td><strong>${formatCurrency(genelToplamBorc)}</strong></td>
            <td><strong>${formatCurrency(genelToplamAlacak)}</strong></td>
            <td style="${toplamBakiyeStyle}"><strong>${formatCurrency(toplamBakiye)}</strong></td>
            <td class="dont-print"></td>`;

    } catch (error) {
        console.error("Cariler listelenirken hata", error);
        cariListesiBody.innerHTML = '<tr><td colspan="10" style="color:red; text-align:center;">Liste yüklenirken bir hata oluştu. Firestore index\'i gerekebilir.</td></tr>';
    }
}


function exportTableToExcel(containerId, fileName = 'rapor') {
    const container = document.getElementById(containerId);
    if (!container) {
        alert('Dışa aktarılacak alan bulunamadı.');
        return;
    }
    const table = container.querySelector('table');
    if (!table) {
        alert('Dışa aktarılacak tablo bulunamadı.');
        return;
    }
    const wb = XLSX.utils.table_to_book(table, {sheet: "Rapor"});
    XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString('tr-TR')}.xlsx`);
}

async function updateSayimForm() {
    const yemId = document.getElementById('sayimYemSecimi').value;
    const mevcutStokInput = document.getElementById('sayimMevcutStok');
    const fizikselStokInput = document.getElementById('sayimFizikselStok');
    const farkInput = document.getElementById('sayimFarki');
    
    if (!yemId) {
        mevcutStokInput.value = '';
        fizikselStokInput.value = '';
        farkInput.value = '';
        return;
    }

    const yemData = window.yemDataMap.get(yemId);
    const mevcutStok = yemData ? yemData.stokMiktari || 0 : 0;
    mevcutStokInput.value = mevcutStok;

    const fizikselStok = parseFloat(fizikselStokInput.value) || 0;
    const fark = fizikselStok - mevcutStok;
    
    farkInput.value = `${fark > 0 ? '+' : ''}${fark}`;
    farkInput.style.color = fark < 0 ? 'red' : 'green';
}

// Stok sayımını veritabanına kaydeden ana fonksiyon
async function handleStokSayimKaydet(event) {
    event.preventDefault();

    const tarih = document.getElementById('sayimTarihi').value;
    const yemId = document.getElementById('sayimYemSecimi').value;
    const fizikselStok = parseFloat(document.getElementById('sayimFizikselStok').value);
    const not = document.getElementById('sayimNotu').value;

    if (!tarih || !yemId || isNaN(fizikselStok) || fizikselStok < 0) {
        alert("Lütfen tarih, yem ve geçerli bir sayım miktarı girin.");
        return;
    }

    const yemRef = db.collection('yemler').doc(yemId);
    const sayimHareketRef = db.collection('stok_sayim_hareketleri').doc();

    try {
        await db.runTransaction(async (transaction) => {
            const yemDoc = await transaction.get(yemRef);
            if (!yemDoc.exists) {
                throw new Error("Sayımı yapılacak yem bulunamadı!");
            }
            const yemData = yemDoc.data();
            const mevcutStok = yemData.stokMiktari || 0;
            const fark = fizikselStok - mevcutStok;

            // 1. Yem stoğunu doğrudan yeni sayılan miktar ile güncelle
            transaction.update(yemRef, { stokMiktari: fizikselStok });

            // 2. Bu işlemi kayıt altına al
            transaction.set(sayimHareketRef, {
                sahipId: sahipId,
                tarih: tarih,
                yemId: yemId,
                yemAdi: yemData.ad,
                mevcutStok: mevcutStok,
                fizikselStok: fizikselStok,
                fark: fark,
                not: not,
                kayitZamani: new Date()
            });
        });

        alert("Stok sayımı başarıyla kaydedildi ve yem stoğu güncellendi!");
        document.getElementById('stokSayimForm').reset();
        await Promise.all([
            renderYemStokListesi(), 
            renderStokSayimGecmisi(),
            populateYemSelect(document.getElementById('sayimYemSecimi')) // Select menüsünü yenile
        ]);

    } catch (error) {
        console.error("Stok sayımı kaydedilirken hata:", error);
        alert("Hata: " + error.message);
    }
}

// Stok sayım geçmişini listeleyen fonksiyon
async function renderStokSayimGecmisi() {
    const listBody = document.getElementById('stokSayimGecmisiBody');
    if (!listBody) return;
    listBody.innerHTML = '<tr><td colspan="6">Yükleniyor...</td></tr>';
    
    try {
        const snapshot = await db.collection('stok_sayim_hareketleri')
            .where('sahipId', '==', sahipId)
            .orderBy('tarih', 'desc')
            .limit(10)
            .get();

        if (snapshot.empty) {
            listBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Kayıtlı stok sayım hareketi bulunmuyor.</td></tr>';
            return;
        }

        let rows = '';
        snapshot.forEach(doc => {
            const sayim = doc.data();
            const farkStyle = sayim.fark < 0 ? 'color:red;' : 'color:green;';
            const farkText = `${sayim.fark > 0 ? '+' : ''}${sayim.fark}`;

            rows += `
                <tr>
                    <td>${formatDate(sayim.tarih)}</td>
                    <td>${sayim.yemAdi}</td>
                    <td>${sayim.mevcutStok}</td>
                    <td>${sayim.fizikselStok}</td>
                    <td style="${farkStyle}; font-weight:bold;">${farkText}</td>
                    <td>${sayim.not || ''}</td>
                </tr>
            `;
        });
        listBody.innerHTML = rows;

    } catch (error) {
        console.error("Stok sayım geçmişi yüklenirken hata:", error);
        listBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Geçmiş yüklenemedi.</td></tr>';
    }
}




// --- EKRAN GÖRÜNTÜSÜ YÖNTEMİ İLE ÇALIŞAN NİHAİ PDF FONKSİYONU ---
async function exportTableToPdf(containerId, fileName = 'rapor', buttonId) {
    const container = document.getElementById(containerId);
    if (!container || container.innerHTML.trim().length < 20) {
        alert('PDF oluşturmak için önce bir rapor oluşturun.');
        return;
    }

    const pdfButton = document.getElementById(buttonId);
    const originalButtonText = pdfButton?.textContent;
    if (pdfButton) {
        pdfButton.textContent = "Oluşturuluyor...";
        pdfButton.disabled = true;
    }

    // PDF oluşturulurken geçici olarak yazdırma stillerini aktif et
    document.body.classList.add('pdf-generating');
    const sourceSection = container.closest('.module-section');
    if (sourceSection) {
        sourceSection.classList.add('pdf-source-section');
    }

    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: (containerId === 'dinamikRaporContainer' ? 'landscape' : 'portrait'),
            unit: 'mm',
            format: 'a4'
        });

        // html2canvas ile belirtilen konteynerin tamamının ekran görüntüsünü al
        const canvas = await html2canvas(container, {
            scale: 2, // Görüntü kalitesini artır
            useCORS: true,
            backgroundColor: '#ffffff'
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = doc.internal.pageSize.getHeight();
        const imgWidth = pdfWidth - 20; // Sayfa kenarlarında 10mm boşluk
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 15; // Resmin PDF'teki başlangıç yüksekliği

        doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= (pdfHeight - 25);

        // Eğer içerik bir sayfadan uzunsa, yeni sayfalar ekle
        while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            doc.addPage();
            doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;
        }
        
        doc.save(`${fileName}_${new Date().toLocaleDateString('tr-TR')}.pdf`);

    } catch (error) {
        console.error("PDF oluşturulurken hata:", error);
        alert("PDF oluşturulurken bir hata oluştu.");
    } finally {
        if (pdfButton) {
            pdfButton.textContent = originalButtonText;
            pdfButton.disabled = false;
        }
        document.body.classList.remove('pdf-generating');
        if (sourceSection) {
            sourceSection.classList.remove('pdf-source-section');
        }
    }
}



function generateRandomColors(count) {
    const colors = [];
    for (let i = 0; i < count; i++) {
        const r = Math.floor(Math.random() * 200);
        const g = Math.floor(Math.random() * 200);
        const b = Math.floor(Math.random() * 200);
        colors.push(`rgba(${r}, ${g}, ${b}, 0.8)`);
    }
    return colors;
}

async function renderAylikSutunGrafik() {
    const ayYil = document.getElementById('aylikChartAySecimi').value;
    const ctx = document.getElementById('aylikSutGrafik').getContext('2d');

    if (aylikSutunChartInstance) {
        aylikSutunChartInstance.destroy();
    }
    
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

    if (!ayYil) {
        ctx.font = "16px Segoe UI";
        ctx.fillStyle = "#666";
        ctx.textAlign = "center";
        ctx.fillText("Lütfen bir ay seçip 'Grafiği Göster' butonuna basın.", ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    }

    const currentUser = auth.currentUser;
    if (!currentUser) return;
    
    ctx.font = "16px Segoe UI";
    ctx.fillStyle = "#666";
    ctx.textAlign = "center";
    ctx.fillText("Grafik oluşturuluyor...", ctx.canvas.width / 2, ctx.canvas.height / 2);

    try {
        const [year, month] = ayYil.split('-');
        const startDateStr = new Date(year, month - 1, 1).toISOString().split('T')[0];
        const endDateStr = new Date(year, month, 0).toISOString().split('T')[0];

        const alimlarSnapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('tarih', '>=', startDateStr)
            .where('tarih', '<=', endDateStr)
            .get();

        if (alimlarSnapshot.empty) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillText("Bu ayda süt alımı yok.", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return; 
        }
        
        const carilerSnapshot = await db.collection('cariler').where('sahipId', '==', sahipId).where('cariGrup', 'array-contains', 'üretici').get();
        const kategoriMap = new Map();
        carilerSnapshot.forEach(doc => {
            kategoriMap.set(doc.id, doc.data().kategori || 'Belirtilmemiş');
        });

        const dataByKategori = {};
        alimlarSnapshot.forEach(doc => {
            const alim = doc.data();
            if (kategoriMap.has(alim.cariId)) {
                const kategori = kategoriMap.get(alim.cariId);
                if (!dataByKategori[kategori]) {
                    dataByKategori[kategori] = 0;
                }
                if (alim.islemKaynagi !== 'tank-aktarim') {
                    dataByKategori[kategori] += alim.toplam;
                }
            }
        });

        const labels = Object.keys(dataByKategori);
        const data = Object.values(dataByKategori);

        // YENİ: Dinamik Renk Oluşturma Mantığı
        let backgroundColors = [];
        if (data.length > 0) {
            const maxValue = Math.max(...data);
            const minValue = Math.min(...data.filter(val => val > 0)); // 0'dan büyük en küçük değeri bul

            backgroundColors = data.map(value => {
                if (value === maxValue) {
                    return 'rgba(40, 167, 69, 0.7)'; // Yeşil
                } else if (value === minValue) {
                    return 'rgba(220, 53, 69, 0.7)'; // Kırmızı
                } else {
                    return 'rgba(255, 193, 7, 0.7)'; // Sarı
                }
            });
        }
        
        const maxValueForScale = data.length > 0 ? Math.max(...data) : 0;
        const chartMax = maxValueForScale > 0 ? maxValueForScale * 1.15 : 100;
        
        aylikSutunChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Toplam Süt (Lt)',
                    data: data,
                    // GÜNCELLEME: Tek renk yerine dinamik renk dizisi kullanılıyor
                    backgroundColor: backgroundColors,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                 plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: (value) => value.toFixed(0) + ' Lt',
                        color: '#333',
                        font: { weight: 'bold' }
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true,
                        max: chartMax 
                    } 
                }
            }
        });
    } catch (error) {
        console.error("Aylık süt grafiği oluşturulurken hata:", error);
    }
}
        
async function editCari(id) {
    try {
        const doc = await db.collection('cariler').doc(id).get();
        if (!doc.exists) return;
        const cari = doc.data();

        editingCariId = id; 
        document.getElementById('cariEditId').value = id; 
        document.getElementById('cariKodu').value = cari.kodu || ''; 
        document.getElementById('cariRotaSirasi').value = cari.rotaSirasi || null; 
        document.getElementById('cariAdiSoyadi').value = cari.adiSoyadi || ''; 
        document.getElementById('cariKategori').value = cari.kategori || ''; 

document.getElementById('grupUretici').checked = false;
document.getElementById('grupTedarikci').checked = false;
document.getElementById('grupSutAlici').checked = false;

if (Array.isArray(cari.cariGrup)) {
    cari.cariGrup.forEach(grup => {
        if (grup === 'üretici') document.getElementById('grupUretici').checked = true;
        if (grup === 'tedarikçi') document.getElementById('grupTedarikci').checked = true;
        if (grup === 'süt alıcı') document.getElementById('grupSutAlici').checked = true;
    });
}



        document.getElementById('cariDurum').value = cari.durum || 'aktif';
        document.getElementById('cariTipi').value = cari.cariTipi || 'sut_ve_yem';
        document.getElementById('cariTelefon').value = cari.telefon || ''; 
        
        // Açılış bakiyesi alanları artık düzenlenebilir olacak.
        document.getElementById('cariAcilisBakiye').disabled = false;
        document.getElementById('cariAcilisBakiyeTuru').disabled = false;
        
        // Mevcut açılış bakiyesini bulup forma yazdır
        const acilisBakiyeSnapshot = await db.collection('odemeVeTahsilatlar')
            .where('cariId', '==', id)
            .where('aciklama', '==', 'Açılış Bakiyesi')
            .limit(1).get();

        if (!acilisBakiyeSnapshot.empty) {
            const acilisBakiyeDoc = acilisBakiyeSnapshot.docs[0].data();
            document.getElementById('cariAcilisBakiye').value = acilisBakiyeDoc.tutar;
            document.getElementById('cariAcilisBakiyeTuru').value = acilisBakiyeDoc.islemTuru;
        } else {
            document.getElementById('cariAcilisBakiye').value = '';
            document.getElementById('cariAcilisBakiyeTuru').value = 'yok';
        }

        setEditingMode(document.getElementById('cariFormBaslik'), document.getElementById('cariKaydetBtn'), document.getElementById('cariFormTemizleBtn'), id, 'Cari');
	            document.getElementById('cariFormBaslik').scrollIntoView({ behavior: 'smooth' });

    } catch (e) {
        console.error("Cari bilgileri yüklenirken hata:", e);
    }
}

async function deleteCari(id) {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert("Lütfen giriş yapın.");
        return;
    }

    try {
        const cariRef = db.collection('cariler').doc(id);
        const cariDoc = await cariRef.get();
        if (!cariDoc.exists) {
            alert("Silinecek cari bulunamadı!");
            return;
        }
        
        const cariData = cariDoc.data();
        const cariAdi = cariData.adiSoyadi;
        const cariKodu = cariData.kodu || '';

        // Aşama 1: İlk Onay
        const ilkOnay = confirm(`⚠️ DİKKAT!\n\n'${cariAdi}' isimli cariyi ve bu cariye ait TÜM SÜT, YEM, ÖDEME ve TAHSİLAT kayıtlarını kalıcı olarak silmek üzeresiniz. Bu işlem geri alınamaz!\n\nDevam etmek istediğinizden emin misiniz?`);
        if (!ilkOnay) return;

        // Aşama 2: Yazarak Onay
        const ikinciOnayMesaji = `🛑 SON UYARI!\n\nSilme işlemini onaylamak için lütfen carinin kodunu (${cariKodu}) aşağıdaki kutucuğa tam olarak yazın.`;
        const kullaniciGirdisi = prompt(ikinciOnayMesaji, "");

        if (kullaniciGirdisi === null) return; // Kullanıcı iptal etti
        
        if (kullaniciGirdisi.trim() !== cariKodu) {
            alert("Girilen cari kodu yanlış! Silme işlemi iptal edildi.");
            return;
        }

        // Onaylar başarılı, silme işlemine devam et...
        const silinenRotaSirasi = cariData.rotaSirasi;
        const hareketler = ['sut_alimlari', 'yem_alimlari', 'yem_satislari', 'odemeVeTahsilatlar'];
        const hareketSnapshots = [];
        for (const koleksiyon of hareketler) {
            const q = db.collection(koleksiyon).where('cariId', '==', id).where('sahipId', '==', sahipId);
            const snapshot = await q.get();
            hareketSnapshots.push(snapshot);
        }

        let carilerToUpdateSnapshot = null;
        if (silinenRotaSirasi) {
            const carilerToUpdateQuery = db.collection('cariler').where('sahipId', '==', sahipId).where('rotaSirasi', '>', silinenRotaSirasi);
            carilerToUpdateSnapshot = await carilerToUpdateQuery.get();
        }

        await db.runTransaction(async (transaction) => {
            hareketSnapshots.forEach(snapshot => snapshot.forEach(doc => transaction.delete(doc.ref)));
            if (carilerToUpdateSnapshot) {
                carilerToUpdateSnapshot.forEach(doc => transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi - 1 }));
            }
            transaction.delete(cariRef);
        });

        await renderCariListesi();
        alert(`'${cariAdi}' isimli cari ve tüm hareketleri başarıyla silindi.`);

    } catch (error) {
        console.error("Cari silinirken hata:", error);
        alert("Cari silinirken bir hata oluştu: " + error);
    }
}

function resetCariForm(){ 
    document.getElementById('cariForm').reset(); 
    editingCariId = null; 
    document.getElementById('cariEditId').value = ''; 
    setEditingMode(document.getElementById('cariFormBaslik'), document.getElementById('cariKaydetBtn'), document.getElementById('cariFormTemizleBtn'), null, 'Cari Kart');
    generateNextCariKodu(); 
}

async function handleCariKategoriEkle(event) {
    event.preventDefault();
    const yeniCariKategoriAdiInput = document.getElementById('yeniCariKategoriAdi');
    const yeniAd = yeniCariKategoriAdiInput.value.trim();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }
    if (yeniAd === '') { alert('Kategori/Köy adı boş olamaz.'); return; }
    try {
        await db.collection('cari_kategorileri').add({ ad: yeniAd, sahipId: sahipId });
        await Promise.all([
          renderCariKategoriListesi(),
          populateCariKategoriSelect(document.getElementById('cariKategori')),
          populateCariKategoriFiltre(),
          populateCariKategoriSelect(document.getElementById('topluGirisKategori'))
        ]);
        yeniCariKategoriAdiInput.value = '';
    } catch (error) {
        console.error("Kategori eklenirken hata: ", error);
        alert("Kategori eklenemedi. Konsolu kontrol edin.");
    }
}

async function renderCariKategoriListesi() {
    const cariKategoriListesiUl = document.getElementById('cariKategoriListesiUl');
    const currentUser = auth.currentUser;
    if (!cariKategoriListesiUl || !currentUser) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", sahipId).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        cariKategoriListesiUl.innerHTML = ''; 
        if (kategoriler.length === 0) { cariKategoriListesiUl.innerHTML = '<li>Tanımlı kategori/köy bulunmuyor.</li>'; return; } 
        kategoriler.forEach(kat => { const li = document.createElement('li'); li.textContent = kat.ad; const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Sil'; deleteBtn.classList.add('btn', 'btn-delete', 'btn-sm', 'dont-print'); deleteBtn.onclick = () => deleteCariKategori(kat.id); li.appendChild(deleteBtn); cariKategoriListesiUl.appendChild(li); });
    } catch(error) { console.error("Kategoriler listelenirken hata:", error); }
}

async function deleteCariKategori(id) { 
    if (confirm('Bu kategoriyi/köyü silmek istediğinizden emin misiniz?')) { 
        try {
            await db.collection('cari_kategorileri').doc(id).delete(); 
            await Promise.all([renderCariKategoriListesi(), populateCariKategoriSelect(document.getElementById('cariKategori')), populateCariKategoriFiltre(), populateCariKategoriSelect(document.getElementById('topluGirisKategori'))]);
        } catch(error) { console.error("Kategori silinirken hata:", error); }
    }
}



async function populateCariKategoriFiltre() { 
    const selectElement = document.getElementById('cariKategoriFiltre');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", sahipId).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value; 
        selectElement.innerHTML = `<option value="">Tüm Kategoriler</option>`; 
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); 
        selectElement.value = currentValue; 
    } catch(error) { console.error("Kategori filtresi yüklenirken hata:", error); }
}

async function populateCariKategoriSelect(selectElement, defaultOptionText = "Seçiniz...") { 
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", sahipId).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value; 
        selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`; 
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); 
        if (kategoriler.some(kat => kat.ad === currentValue)) { selectElement.value = currentValue; }
    } catch(error) { console.error("Kategori seçimi yüklenirken hata:", error); }
}

async function populateCariSelect(selectElement, filterGroup = null, defaultText = "Seçiniz...") {
    if (!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    selectElement.innerHTML = `<option value="">Yükleniyor...</option>`;
    
    let query = db.collection('cariler').where("sahipId", "==", sahipId).where("durum", "==", "aktif");

    if (filterGroup) {
        query = query.where('cariGrup', 'array-contains', filterGroup);
    }
    
    query = query.orderBy('adiSoyadi');

    try {
        const snapshot = await query.get();
        const currentValue = selectElement.value;
        if (snapshot.empty) {
            selectElement.innerHTML = `<option value="">Tanımlı cari bulunamadı.</option>`;
            return;
        }
        selectElement.innerHTML = `<option value="">${defaultText}</option>`;
        const cariler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        cariler.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            // DEĞİŞİKLİK BURADA YAPILDI: Artık sadece cari adı gösteriliyor.
            option.textContent = c.adiSoyadi;
            selectElement.appendChild(option);
        });
        if (cariler.some(c => c.id === currentValue)) {
            selectElement.value = currentValue;
        }
    } catch (error) {
        console.error("Cariler yüklenirken hata:", error);
        selectElement.innerHTML = `<option value="">Hata oluştu!</option>`;
    }
}


async function populateYemSelect(selectElement, defaultText = "Yem Seçiniz...") {
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yemler').where("sahipId", "==", sahipId).orderBy('ad').get();
        const yemler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        window.yemDataMap = new Map(); // Fiyatları saklamak için global bir map
        yemler.forEach(y => window.yemDataMap.set(y.id, y));

        selectElement.innerHTML = ''; 
        const firstOption = document.createElement('option'); firstOption.value = ""; firstOption.textContent = defaultText; selectElement.appendChild(firstOption);
        yemler.forEach(y => {
            const option = document.createElement('option');
            option.value = y.id;
            option.textContent = `${y.ad} (${y.kod}) - Stok: ${y.stokMiktari || 0} ${y.birim}`;
            selectElement.appendChild(option);
        });
    } catch (error) {
        console.error("Yem seçimi yüklenirken hata:", error);
    }
}


async function renderGunlukSutGrafik() {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    const ctx = document.getElementById('gunlukSutGrafik').getContext('2d');
    if(gunlukSutunChartInstance) {
        gunlukSutunChartInstance.destroy();
    }

    try {
        const tarihStr = getTodayForInput();
        const alimlarSnapshot = await db.collection('sut_alimlari').where('sahipId', '==', sahipId).where('tarih', '==', tarihStr).get();
        
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        if (alimlarSnapshot.empty) {
            ctx.font = "16px Segoe UI";
            ctx.fillStyle = "#666";
            ctx.textAlign = "center";
            ctx.fillText("Bugün için süt alım verisi bulunmuyor.", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        const carilerSnapshot = await db.collection('cariler').where('sahipId', '==', sahipId).where('cariGrup', 'array-contains', 'üretici').get();
        const kategoriMap = new Map();
        carilerSnapshot.forEach(doc => {
            kategoriMap.set(doc.id, doc.data().kategori || 'Belirtilmemiş');
        });

        const dataByKategori = {};
        alimlarSnapshot.forEach(doc => {
            const alim = doc.data();
            if (kategoriMap.has(alim.cariId)) {
                const kategori = kategoriMap.get(alim.cariId);
                if (!dataByKategori[kategori]) {
                    dataByKategori[kategori] = 0;
                }
                if (alim.islemKaynagi !== 'tank-aktarim') {
                    dataByKategori[kategori] += alim.toplam;
                }
            }
        });

        const labels = Object.keys(dataByKategori);
        const data = Object.values(dataByKategori);

        // YENİ: Dinamik Renk Oluşturma Mantığı
        let backgroundColors = [];
        if (data.length > 0) {
            const maxValue = Math.max(...data);
            const minValue = Math.min(...data.filter(val => val > 0)); // 0'dan büyük en küçük değeri bul

            backgroundColors = data.map(value => {
                if (value === maxValue) {
                    return 'rgba(40, 167, 69, 0.7)'; // Yeşil
                } else if (value === minValue) {
                    return 'rgba(220, 53, 69, 0.7)'; // Kırmızı
                } else {
                    return 'rgba(255, 193, 7, 0.7)'; // Sarı
                }
            });
        }
        
        const maxValueForScale = data.length > 0 ? Math.max(...data) : 0;
        const chartMax = maxValueForScale > 0 ? maxValueForScale * 1.15 : 100;

        gunlukSutunChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Toplam Süt (Lt)',
                    data: data,
                    // GÜNCELLEME: Tek renk yerine dinamik renk dizisi kullanılıyor
                    backgroundColor: backgroundColors,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: (value) => value.toFixed(1) + ' Lt',
                        color: '#333',
                        font: { weight: 'bold' }
                    }
                },
                scales: { y: { beginAtZero: true, max: chartMax } }
            }
        });
    } catch(error) {
        console.error("Günlük süt grafiği oluşturulurken hata:", error);
    }
}


async function handleKullaniciKaydet(event) {
    event.preventDefault();
    alert("Bu özellik güvenlik nedeniyle doğrudan yeni kullanıcı oluşturmaz. Lütfen önce Firebase Authentication panelinden kullanıcıyı e-posta/şifre ile oluşturun, ardından bu panelden o kullanıcıya ait bir profil (rol ataması) oluşturabilirsiniz.");
}

async function deleteKullanici(id) {
    if(confirm("Kullanıcıyı silmek istiyor musunuz?")) {
        try {
            await db.collection('kullanicilar').doc(id).delete();
            await renderKullaniciListesi();
        } catch (error) {
            console.error("Kullanıcı silinirken hata:", error);
        }
    }
}

async function renderKullaniciListesi() {
    const kullaniciListesiBody = document.getElementById('kullaniciListesiBody');
    const currentUser = auth.currentUser;
    if(!kullaniciListesiBody || !currentUser) return;
    try {
        const snapshot = await db.collection('kullanicilar').where("sahipId", "==", sahipId).get();
        kullaniciListesiBody.innerHTML = '';
        snapshot.forEach(doc => {
            const user = doc.data();
            if(user.rol === 'admin') return;
            const row = kullaniciListesiBody.insertRow();
            row.innerHTML = `<td>${user.kullaniciAdi}</td><td>Çalışan</td><td class="dont-print"><button class="btn btn-delete btn-sm" onclick="deleteKullanici('${doc.id}')">Sil</button></td>`;
        });
    } catch(error) { console.error("Kullanıcılar listelenirken hata", error); }
}

async function editYemAlisi(id) {
    try {
        const doc = await db.collection('yem_alimlari').doc(id).get();
        if (!doc.exists) {
            alert("Düzenlenecek kayıt bulunamadı.");
            return;
        }
        const data = doc.data();
        
        editingYemAlisId = id; // Global düzenleme ID'sini ayarla
        document.getElementById('yemAlisEditId').value = id;
        document.getElementById('yemAlisTarih').value = data.tarih;
        document.getElementById('yemSecimiAlis').value = data.yemId;
        document.getElementById('yemAlisMiktar').value = data.miktar;
        document.getElementById('yemAlisTedarikci').value = data.cariId;
        document.getElementById('yemAlisBirimFiyati').value = data.alisFiyati;
        hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar');

        setEditingMode(document.getElementById('yemAlisFormBaslik'), document.getElementById('yemAlisKaydetBtn'), document.getElementById('yemAlisFormTemizleBtn'), id, 'Yem Alışı');
        document.getElementById('yemAlisForm').scrollIntoView();
    } catch (error) {
        console.error("Yem alışı düzenleme için getirilirken hata:", error);
    }
}


async function editYemSatisi(id) {
    try {
        const doc = await db.collection('yem_satislari').doc(id).get();
        if (!doc.exists) { alert("Düzenlenecek kayıt bulunamadı."); return; }
        const data = doc.data();

        editingYemSatisId = id;
        document.getElementById('yemSatisEditId').value = id;
        document.getElementById('yemSatisTarih').value = data.tarih;
        document.getElementById('yemAlanTedarikci').value = data.cariId;
        document.getElementById('yemSecimiSatis').value = data.yemId;
        document.getElementById('yemSatisMiktar').value = data.miktar;
        document.getElementById('yemSatisBirimFiyati').value = data.satisFiyati;
        hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar');

        document.getElementById('yemAlanTedarikci').disabled = true;
        document.getElementById('yemSecimiSatis').disabled = true;

        setEditingMode(document.getElementById('yemSatisFormBaslik'), document.getElementById('yemSatisKaydetBtn'), document.getElementById('yemSatisFormTemizleBtn'), id, 'Yem Satışı');
        document.getElementById('yemSatisForm').scrollIntoView();
    } catch (error) {
        console.error("Yem satışı düzenleme için getirilirken hata:", error);
    }
}


async function handleYemTanimKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }

    const formData = {
        kod: document.getElementById('yemKodu').value,
        ad: document.getElementById('yemAdi').value,
        kategori: document.getElementById('yemKategorisi').value,
        birim: document.getElementById('yemBirimi').value,
        // alisFiyati alanı kaldırıldı
        satisFiyati: parseFloat(document.getElementById('yemSatisFiyati').value) || 0,
        sahipId: sahipId
    };

    try {
        const editingYemTanimId = document.getElementById('yemTanimEditId').value;
        if (editingYemTanimId) {
            await db.collection('yemler').doc(editingYemTanimId).set(formData, { merge: true });
            alert("Yem tanımı güncellendi.");
        } else {
            formData.stokMiktari = 0;
            await db.collection('yemler').add(formData);
            alert("Yem tanımı kaydedildi.");
        }
        resetYemTanimForm();
        await renderYemStokListesi();
    } catch (error) {
        console.error("Yem tanımı kaydedilirken hata:", error);
        alert("Yem tanımı kaydedilirken bir hata oluştu.");
    }
}




function resetYemTanimForm() {
    const yemTanimForm = document.getElementById('yemTanimForm');
    const yemTanimFormBaslik = document.getElementById('yemTanimFormBaslik');
    const yemTanimKaydetBtn = document.getElementById('yemTanimKaydetBtn');
    const yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
    yemTanimForm.reset();
    editingYemTanimId = null;
    document.getElementById('yemTanimEditId').value = '';
    if(yemTanimFormBaslik) yemTanimFormBaslik.textContent = 'Yeni Yem Tanımla';
    if(yemTanimKaydetBtn) yemTanimKaydetBtn.textContent = 'Kaydet';
    if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.style.display = 'none';
}

async function renderYemStokListesi() {
    const yemStokListesiBody = document.getElementById('yemStokListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yemler').where('sahipId', '==', sahipId).orderBy('ad').get();
        if (snapshot.empty) {
            yemStokListesiBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Tanımlı yem bulunmuyor.</td></tr>';
            return;
        }
        let rows = '';
        snapshot.forEach(doc => {
            const yem = doc.data();
            rows += `<tr>
                <td>${yem.kod || ''}</td>
                <td>${yem.ad || ''}</td>
                <td>${yem.kategori || ''}</td>
                <td>${yem.birim || ''}</td>
                <td>${formatCurrency(yem.alisFiyati || 0)}</td>
                <td>${formatCurrency(yem.satisFiyati || 0)}</td>
                <td>${yem.stokMiktari || 0}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemTanimi('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemTanimi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        yemStokListesiBody.innerHTML = rows;
    } catch (error) { console.error("Yem stok listesi yüklenirken hata:", error); }
}

// YENİ FONKSİYON 1: Tüm yemleri hafızadaki bir haritaya yükler
async function loadAllYemlerToCache() {
    window.yemDataMap = new Map();
    try {
        const snapshot = await db.collection('yemler').where("sahipId", "==", sahipId).get();
        snapshot.forEach(doc => {
            window.yemDataMap.set(doc.id, doc.data());
        });
        console.log(`${window.yemDataMap.size} adet yem bilgisi hafızaya alındı.`);
    } catch (error) {
        console.error("Tüm yemler yüklenirken hata:", error);
    }
}

// YENİ FONKSİYON 2: Tüm carileri hafızadaki bir haritaya yükler
async function loadAllCarilerToCache() {
    window.cariDataMap = new Map();
    try {
        const snapshot = await db.collection('cariler').where("sahipId", "==", sahipId).get();
        snapshot.forEach(doc => {
            window.cariDataMap.set(doc.id, doc.data());
        });
        console.log(`${window.cariDataMap.size} adet cari bilgisi hafızaya alındı.`);
    } catch (error) {
        console.error("Tüm cariler yüklenirken hata:", error);
    }
}
async function handleYemAlisKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }

    const miktar = parseInt(document.getElementById('yemAlisMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('yemAlisBirimFiyati').value);
    const yemId = document.getElementById('yemSecimiAlis').value;
    
    if (!yemId || isNaN(miktar) || miktar < 0 || isNaN(birimFiyat)) {
        alert("Lütfen yem, miktar ve fiyat alanlarını doğru bir şekilde doldurun.");
        return;
    }

    const formData = {
        tarih: document.getElementById('yemAlisTarih').value,
        yemId: yemId,
        miktar: miktar,
        cariId: document.getElementById('yemAlisTedarikci').value || '',
        alisFiyati: birimFiyat,
        toplamTutar: miktar * birimFiyat,
        sahipId: sahipId
    };

    const yemRef = db.collection('yemler').doc(yemId);

    // DÜZENLEME MANTIĞI
    if (editingYemAlisId) {
        const alisRef = db.collection('yem_alimlari').doc(editingYemAlisId);
        
        try {
            await db.runTransaction(async (transaction) => {
                const eskiAlisDoc = await transaction.get(alisRef);
                if (!eskiAlisDoc.exists) throw "Düzenlenecek kayıt bulunamadı.";
                
                const eskiMiktar = eskiAlisDoc.data().miktar;
                if (eskiAlisDoc.data().yemId !== yemId) throw "Yem türü düzenleme sırasında değiştirilemez. Lütfen kaydı silip yeniden oluşturun.";

                const stokFarki = miktar - eskiMiktar; // Yeni ve eski miktar arasındaki fark

                transaction.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(stokFarki) });
                transaction.update(alisRef, formData);
            });
            
            alert("Yem alışı başarıyla güncellendi.");
            resetYemAlisForm();
            await Promise.all([renderYemStokListesi(), renderYemAlisHareketleri()]);

        } catch (error) {
            console.error("Yem alışı güncellenirken hata:", error);
            alert("Hata: " + error);
        }
    } 
    // YENİ KAYIT MANTIĞI
    else {
        try {
            const batch = db.batch();
            const yemAlimRef = db.collection('yem_alimlari').doc();
            batch.set(yemAlimRef, formData);
            batch.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(miktar) });
            await batch.commit();
            
            resetYemAlisForm();
            await Promise.all([renderYemStokListesi(), renderYemAlisHareketleri()]);
        } catch (error) {
            console.error("Yem alışı kaydedilirken hata:", error);
            alert("Yem alışı kaydedilirken bir hata oluştu.");
        }
    }
}


async function deleteYemTanimi(id) {
    if (!confirm("Bu yem tanımını silmek istediğinizden emin misiniz? Eğer bu yem ile ilgili bir alış veya satış yapıldıysa, silme işlemi engellenecektir.")) return;
    try {
        // Bu yemin kullanılıp kullanılmadığını kontrol et
        const alisSnapshot = await db.collection('yem_alimlari').where('yemId', '==', id).limit(1).get();
        const satisSnapshot = await db.collection('yem_satislari').where('yemId', '==', id).limit(1).get();
        if (!alisSnapshot.empty || !satisSnapshot.empty) {
            alert("Bu yem ile ilgili alış veya satış hareketleri bulunduğu için silemezsiniz.");
            return;
        }
        await db.collection('yemler').doc(id).delete();
        alert("Yem tanımı silindi.");
        await renderYemStokListesi();
    } catch (error) {
        console.error("Yem tanımı silinirken hata:", error);
        alert("Yem tanımı silinirken bir hata oluştu.");
    }
}

async function editYemTanimi(id) {
    try {
        const doc = await db.collection('yemler').doc(id).get();
        if (!doc.exists) { alert("Düzenlenecek yem bulunamadı."); return; }
        const yem = doc.data();
        
        document.getElementById('yemTanimEditId').value = id;
        document.getElementById('yemKodu').value = yem.kod;
        document.getElementById('yemAdi').value = yem.ad;
        document.getElementById('yemKategorisi').value = yem.kategori;
        document.getElementById('yemBirimi').value = yem.birim;
        // document.getElementById('yemAlisFiyati').value = yem.alisFiyati; // Bu satır kaldırıldı
        document.getElementById('yemSatisFiyati').value = yem.satisFiyati;
        
        setEditingMode(document.getElementById('yemTanimFormBaslik'), document.getElementById('yemTanimKaydetBtn'), document.getElementById('yemTanimFormTemizleBtn'), id, 'Yem Tanımı');
        document.getElementById('yemTanimForm').scrollIntoView();
    } catch (error) { console.error("Yem tanımı düzenlenirken hata:", error); }
}

function resetYemAlisForm() {
    document.getElementById('yemAlisForm').reset();
    editingYemAlisId = null;
    document.getElementById('yemAlisEditId').value = '';
    setEditingMode(document.getElementById('yemAlisFormBaslik'), document.getElementById('yemAlisKaydetBtn'), document.getElementById('yemAlisFormTemizleBtn'), null, 'Yeni Yem Alışı');
}

async function renderYemAlisHareketleri() {
    const listBody = document.getElementById('yemAlisHareketListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yem_alimlari').where('sahipId', '==', sahipId).orderBy('tarih', 'desc').limit(20).get();
        if (snapshot.empty) {
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Yem alım hareketi bulunmuyor.</td></tr>';
            return;
        }
        
        const yemIds = new Set(snapshot.docs.map(doc => doc.data().yemId));
        const cariIds = new Set(snapshot.docs.filter(doc => doc.data().cariId).map(doc => doc.data().cariId));

        const yemMap = new Map();
        const cariMap = new Map();

        if (yemIds.size > 0) {
            const yemSnapshot = await db.collection('yemler').where(firebase.firestore.FieldPath.documentId(), 'in', Array.from(yemIds)).get();
            yemSnapshot.forEach(doc => yemMap.set(doc.id, doc.data().ad));
        }
        if (cariIds.size > 0) {
            const cariSnapshot = await db.collection('cariler').where(firebase.firestore.FieldPath.documentId(), 'in', Array.from(cariIds)).get();
            cariSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));
        }
        
        let rows = '';
        snapshot.forEach(doc => {
            const alim = doc.data();
            const yemAdi = yemMap.get(alim.yemId) || 'Bilinmiyor';
            const cariAdi = alim.cariId ? cariMap.get(alim.cariId) : 'Peşin Alış';

            rows += `<tr>
                <td>${formatDate(alim.tarih)}</td>
                <td>${yemAdi}</td>
                <td>${alim.miktar}</td>
                <td>${cariAdi}</td>
                <td>${formatCurrency(alim.alisFiyati)}</td>
                <td>${formatCurrency(alim.toplamTutar)}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemAlisi('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemAlisi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;
    } catch(e) { console.error("Yem alış hareketleri yüklenirken hata:", e); }
}


async function editOdeme(id) {
    try {
        const doc = await db.collection('odemeVeTahsilatlar').doc(id).get();
        if (!doc.exists) {
            alert("Düzenlenecek kayıt bulunamadı.");
            return;
        }
        const data = doc.data();
        
        document.getElementById('odemeEditId').value = id;
        document.getElementById('islemTuru').value = data.islemTuru;
        document.getElementById('odemeTarih').value = data.tarih;
        document.getElementById('odemeYapilanTedarikci').value = data.cariId;
        document.getElementById('odemeTuru').value = data.odemeTuru || 'Kasa'; // YENİ EKLENDİ

        document.getElementById('odemeTutari').value = data.tutar;
        document.getElementById('odemeAciklama').value = data.aciklama;
        
        setEditingMode(document.getElementById('odemeFormBaslik'), document.getElementById('odemeKaydetBtn'), document.getElementById('odemeFormTemizleBtn'), id, 'Hareket Girişi');
        document.getElementById('odemeForm').scrollIntoView();

    } catch (error) {
        console.error("Ödeme düzenleme için getirilirken hata:", error);
    }
}



async function deleteOdeme(id) {
    if (confirm("Bu işlem hareketini silmek istediğinizden emin misiniz?")) {
        try {
            await db.collection('odemeVeTahsilatlar').doc(id).delete();
            await renderOdemeListesi(); // Listeyi yenile
        } catch (error) {
            console.error("Ödeme silinirken hata:", error);
            alert("İşlem silinirken bir hata oluştu.");
        }
    }
}

function closeSutDuzenleForm() {
    document.getElementById('sutDuzenleFormAlani').style.display = 'none';
    document.getElementById('sutDuzenleForm').reset();
}


function toggleLoading(button, isLoading) {
    if (!button) return;
    if (isLoading) {
        button.disabled = true;
        button.classList.add('is-loading');
        const spinner = document.createElement('span');
        spinner.className = 'loader-spinner';
        button.appendChild(spinner);
    } else {
        button.disabled = false;
        button.classList.remove('is-loading');
        const spinner = button.querySelector('.loader-spinner');
        if (spinner) {
            spinner.remove();
        }
    }
}

async function renderHareketDokumu(direction = 'initial') {
    const listBody = document.getElementById('hareketDokumuBody');
    const pageInfo = document.getElementById('hareketPageInfo');
    const nextBtn = document.getElementById('hareketNextBtn');
    const prevBtn = document.getElementById('hareketPrevBtn');
    const recordsPerPage = 30;
    const currentUser = auth.currentUser;

    if (!currentUser || !listBody) return;

    listBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Yükleniyor...</td></tr>`;

    // Bu fonksiyon tüm hareketleri birleştirmeyi hedefler. Şimdilik sadece süt alımlarını listeliyor.
    // İleride yem satışları, ödemeler vb. de buraya eklenebilir.
    let query = db.collection('sut_alimlari')
                .where('sahipId', '==', sahipId)
                .orderBy('tarih', 'desc')
                .limit(recordsPerPage);
    
    if (direction === 'next' && lastVisibleHareket) {
        query = query.startAfter(lastVisibleHareket);
    } else if (direction === 'prev') {
        firstVisibleHareketStack.pop(); // Mevcut sayfanın başlangıcını kaldır
        const prevPageStart = firstVisibleHareketStack.pop(); // Bir önceki sayfanın başlangıcını al
        if (prevPageStart) {
            query = query.startAt(prevPageStart);
        }
    }

    try {
        // HATA DÜZELTMESİ: 'snapshot.get()' yerine 'query.get()' kullanıldı.
        const snapshot = await query.get();
        const hareketler = snapshot.docs;

        if (hareketler.length === 0 && direction === 'initial') {
            listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Hiç işlem hareketi bulunmuyor.</td></tr>';
            if(nextBtn) nextBtn.disabled = true;
            if(prevBtn) prevBtn.disabled = true;
            return;
        }

        if (hareketler.length > 0) {
            lastVisibleHareket = hareketler[hareketler.length - 1];
            if (direction !== 'prev') {
                firstVisibleHareketStack.push(hareketler[0]);
            }
        }
        
        listBody.innerHTML = hareketler.map(doc => {
            const h = doc.data();
            // Bu örnekte sadece süt alımlarını gösteriyoruz.
            // Diğer hareket türleri eklendiğinde bu kısım genişletilebilir.
            return `<tr>
                <td>${formatDate(h.tarih)}</td>
                <td>${window.cariDataMap.get(h.cariId)?.adiSoyadi || 'Bilinmiyor'}</td>
                <td>${h.islemKaynagi === 'tank-aktarim' ? 'Süt Satışı (Tanktan)' : 'Süt Alımı'}</td>
                <td>${h.toplam.toFixed(2)} Lt</td>
                <td>${formatCurrency(h.toplamTutar)}</td>
            </tr>`;
        }).join('');

        if(direction === 'next') hareketPageCount++;
        if(direction === 'prev' && hareketPageCount > 1) hareketPageCount--;
        
        if(pageInfo) pageInfo.textContent = `Sayfa ${hareketPageCount}`;
        if(prevBtn) prevBtn.disabled = hareketPageCount <= 1;
        if(nextBtn) nextBtn.disabled = hareketler.length < recordsPerPage;

    } catch(e) {
        console.error("Hareket dökümü hatası:", e);
        listBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Liste yüklenirken bir hata oluştu.</td></tr>';
    }
}

async function deleteSutAlimi(id) {
    if (confirm("Bu süt alım kaydını ve ilgili tüm hareketleri kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!")) {
        try {
            const sutAlimRef = db.collection('sut_alimlari').doc(id);
            const sutAlimDoc = await sutAlimRef.get();

            if (!sutAlimDoc.exists) {
                throw new Error("Silinecek süt alım kaydı bulunamadı.");
            }

            const sutAlimData = sutAlimDoc.data();
            const silinecekMiktar = sutAlimData.toplam;

            // 1. İlgili tank hareketlerini bul
            const hareketlerSnapshot = await db.collection('tank_hareketleri')
                .where('sahipId', '==', sahipId)
                .where('ureticiId', '==', sutAlimData.cariId)
                .where('alim_tarihi', '==', sutAlimData.tarih)
                .get();

            if (hareketlerSnapshot.empty) {
                console.warn("İlgili tank hareketi bulunamadı, yine de finansal kayıt silinecek.");
            }

            // 2. Atomik bir toplu işlem başlat
            const batch = db.batch();

            let tankId = null;
            hareketlerSnapshot.forEach(doc => {
                tankId = doc.data().tankId; // Silinecek sütün hangi tankta olduğunu bul
                batch.delete(doc.ref); // İlgili tüm tank hareketlerini (sabah/akşam) sil
            });

            // 3. Tank miktarını güncelle (eğer hareket kaydı bulunduysa)
            if (tankId) {
                const tankRef = db.collection('tanklar').doc(tankId);
                batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(-silinecekMiktar) });
            }

            // 4. Ana süt alım (finansal) kaydını sil
            batch.delete(sutAlimRef);

            // 5. Tüm işlemleri tek seferde onayla
            await batch.commit();
            
            alert("Kayıt ve ilgili tüm hareketler başarıyla silindi.");

            // Arayüzü yenile
            await renderSutAlimGecmisi();
            await renderTopluSutGirisFormu();
            await updateDashboardStats(); // Kontrol panelini de güncelle

        } catch (error) {
            console.error("Süt alımı silinirken hata:", error);
            alert("Silme işlemi sırasında bir hata oluştu: " + error.message);
        }
    }
}

async function handleSutAlimiGuncelle(event) {
    event.preventDefault();
    const id = document.getElementById('sutDuzenleId').value;
    const sabah = parseFloat(document.getElementById('sutDuzenleSabah').value) || 0;
    const aksam = parseFloat(document.getElementById('sutDuzenleAksam').value) || 0;
    const fiyat = parseFloat(document.getElementById('sutDuzenleFiyat').value) || 0;
    const toplam = sabah + aksam;

    const guncelVeri = {
        sabah: sabah,
        aksam: aksam,
        fiyat: fiyat,
        toplam: toplam,
        toplamTutar: toplam * fiyat
    };

    try {
        await db.collection('sut_alimlari').doc(id).update(guncelVeri);
        closeSutDuzenleForm();
        await renderSutAlimGecmisi();
    } catch (error) { console.error("Süt alımı güncellenirken hata:", error); }
}


async function editSutAlimi(id) {
    const formAlani = document.getElementById('sutDuzenleFormAlani');
    try {
        const doc = await db.collection('sut_alimlari').doc(id).get();
        if (!doc.exists) return;
        const data = doc.data();
        
        document.getElementById('sutDuzenleId').value = id;
        document.getElementById('sutDuzenleSabah').value = data.sabah;
        document.getElementById('sutDuzenleAksam').value = data.aksam;
        document.getElementById('sutDuzenleFiyat').value = data.fiyat;
        
        formAlani.style.display = 'block';
        formAlani.scrollIntoView({behavior: 'smooth'});
    } catch (error) { console.error("Süt alımı düzenleme için getirilirken hata:", error); }
}


async function handleYemSatisUpdate() {
    const satisRef = db.collection('yem_satislari').doc(editingYemSatisId);
    const yeniMiktar = parseInt(document.getElementById('yemSatisMiktar').value);
    const yeniFiyat = parseFloat(document.getElementById('yemSatisBirimFiyati').value);
    
    try {
        await db.runTransaction(async (transaction) => {
            const satisDoc = await transaction.get(satisRef);
            if (!satisDoc.exists) throw "Güncellenecek satış kaydı bulunamadı.";

            const eskiMiktar = satisDoc.data().miktar;
            const yemId = satisDoc.data().yemId;
            const yemRef = db.collection('yemler').doc(yemId);
            const miktarFarki = eskiMiktar - yeniMiktar; // Stok farkı ters mantıkla çalışır

            const guncelVeri = {
                tarih: document.getElementById('yemSatisTarih').value,
                miktar: yeniMiktar,
                satisFiyati: yeniFiyat,
                toplamTutar: yeniMiktar * yeniFiyat
            };
            
            transaction.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(miktarFarki) });
            transaction.update(satisRef, guncelVeri);
        });

        alert("Yem satışı başarıyla güncellendi.");
        resetYemSatisForm();
        await renderYemStokListesi();
        await renderYemSatisListesi();

    } catch (error) {
        console.error("Yem satışı güncellenirken hata:", error);
        alert("Güncelleme sırasında bir hata oluştu: " + error);
    }
}

async function handleYemSatisKaydet(event) {
    event.preventDefault();
    if (editingYemSatisId) {
        await handleYemSatisUpdate();
    } else {
        const currentUser = auth.currentUser;
        if (!currentUser) { alert("Lütfen giriş yapın."); return; }
        
        const miktar = parseInt(document.getElementById('yemSatisMiktar').value);
        const birimFiyat = parseFloat(document.getElementById('yemSatisBirimFiyati').value);
        const yemId = document.getElementById('yemSecimiSatis').value;
        const cariId = document.getElementById('yemAlanTedarikci').value;
        if (!yemId || !cariId || isNaN(miktar) || miktar <= 0 || isNaN(birimFiyat)) {
            alert("Lütfen cari, yem, miktar ve fiyat alanlarını doğru bir şekilde doldurun."); return;
        }
        const yemRef = db.collection('yemler').doc(yemId);
        const yemSatisRef = db.collection('yem_satislari').doc();
        try {
            await db.runTransaction(async (transaction) => {
                const yemDoc = await transaction.get(yemRef);
                if (!yemDoc.exists) { throw "Satılmak istenen yem veritabanında bulunamadı."; }
                const anlikStok = yemDoc.data().stokMiktari || 0;
                if (anlikStok < miktar) { throw `Yetersiz stok! Anlık stok: ${anlikStok}`; }
                const formData = {
                    tarih: document.getElementById('yemSatisTarih').value, yemId: yemId, cariId: cariId, 
                    miktar: miktar, satisFiyati: birimFiyat, toplamTutar: miktar * birimFiyat, sahipId: sahipId
                };
                transaction.set(yemSatisRef, formData);
                transaction.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(-miktar) });
            });
            resetYemSatisForm();
            await renderYemStokListesi();
            await renderYemSatisListesi();
        } catch (error) {
            console.error("Yem satışı kaydedilirken hata:", error);
            alert("Yem satışı kaydedilemedi: " + error);
        }
    }
}




function resetYemSatisForm() {
    document.getElementById('yemSatisForm').reset();
    editingYemSatisId = null;
    document.getElementById('yemSatisEditId').value = '';
    setEditingMode(document.getElementById('yemSatisFormBaslik'), document.getElementById('yemSatisKaydetBtn'), document.getElementById('yemSatisFormTemizleBtn'), null, 'Yeni Yem Satışı');
    document.getElementById('yemAlanTedarikci').disabled = false;
    document.getElementById('yemSecimiSatis').disabled = false;
}

async function calculateCariBakiyeDetayli(cariId, endDate = null) {
    let alacak = 0, borc = 0;
    const currentUser = auth.currentUser;
    if (!currentUser) return { alacak: 0, borc: 0, bakiye: 0 };

    try {
        const createQuery = (collectionName) => {
            let query = db.collection(collectionName).where('sahipId', '==', sahipId).where('cariId', '==', cariId);
            if (endDate) {
                query = query.where('tarih', '<=', endDate);
            }
            return query.get();
        };

        const sutQuery = createQuery('sut_alimlari');
        const yemSatisQuery = createQuery('yem_satislari');
        const odemeQuery = createQuery('odemeVeTahsilatlar');
        const yemAlimQuery = createQuery('yem_alimlari');

        const [sutSnapshot, yemSatisSnapshot, odemeSnapshot, yemAlimSnapshot] = await Promise.all([
            sutQuery, yemSatisQuery, odemeQuery, yemAlimQuery
        ]);

        // DÜZELTME: Süt işlemleri artık kaynağına göre Borç veya Alacak olarak ayrılıyor.
        sutSnapshot.forEach(doc => {
            const alim = doc.data();
            // Eğer işlem 'tank-aktarim' ise bu bir SATIŞTIR. Cari BORÇLANIR.
            if (alim.islemKaynagi === 'tank-aktarim') {
                borc += alim.toplamTutar || 0;
            } 
            // Değilse, bu bir ALIŞTIR. Cari ALACAKLI olur.
            else {
                alacak += alim.toplamTutar || 0;
            }
        });

        yemAlimSnapshot.forEach(doc => alacak += doc.data().toplamTutar);
        yemSatisSnapshot.forEach(doc => borc += doc.data().toplamTutar);
        
        odemeSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.islemTuru === 'odeme' || data.islemTuru === 'alacak') alacak += data.tutar;
            else if (data.islemTuru === 'tahsilat' || data.islemTuru === 'borc') borc += data.tutar;
        });
        
        return { alacak, borc, bakiye: alacak - borc };

    } catch (error) {
        console.error(`Bakiye hesaplanırken hata (Cari ID: ${cariId}):`, error);
        return { alacak: 0, borc: 0, bakiye: 0 };
    }
}
        
async function renderYemSatisListesi() {
    const listBody = document.getElementById('yemSatisListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    try {
        const snapshot = await db.collection('yem_satislari').where('sahipId', '==', sahipId).orderBy('tarih', 'desc').limit(20).get();
        if (snapshot.empty) {
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Yem satış hareketi bulunmuyor.</td></tr>';
            return;
        }
        
        // GÜNCELLEME: Artık 'in' sorguları yapmak yerine doğrudan hafızadan okuyacağız.
        // Bu yüzden ID toplama ve sorgulama kodları kaldırıldı.

        let rows = '';
        snapshot.forEach(doc => {
            const satis = doc.data();
            // İsimler artık hafızadaki haritalardan (map) okunuyor.
            const yemAdi = window.yemDataMap.get(satis.yemId)?.ad || 'Bilinmiyor';
            const cariAdi = window.cariDataMap.get(satis.cariId)?.adiSoyadi || 'Bilinmiyor';
            
            rows += `<tr>
                <td>${formatDate(satis.tarih)}</td><td>${cariAdi}</td><td>${yemAdi}</td><td>${satis.miktar}</td>
                <td>${formatCurrency(satis.satisFiyati)}</td><td>${formatCurrency(satis.toplamTutar)}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemSatisi('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemSatisi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;

    } catch(e) { 
        console.error("Yem satış hareketleri yüklenirken hata:", e);
        // Hata mesajı güncellendi
        listBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Liste yüklenirken bir hata oluştu.</td></tr>';
    }
}


async function handleOdemeKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }
    
    // --- DÜZELTME BAŞLANGICI ---
    // ID'yi global değişken yerine doğrudan HTML'deki gizli input'tan alıyoruz.
    const editingId = document.getElementById('odemeEditId').value;
    // --- DÜZELTME SONU ---

    const tutar = parseFloat(document.getElementById('odemeTutari').value);
    const cariId = document.getElementById('odemeYapilanTedarikci').value;
    if (!cariId || isNaN(tutar) || tutar <= 0) {
        alert("Lütfen cari ve tutar alanlarını doğru bir şekilde doldurun.");
        return;
    }
    const formData = {
        tarih: document.getElementById('odemeTarih').value,
        cariId: cariId,
        islemTuru: document.getElementById('islemTuru').value,
        odemeTuru: document.getElementById('odemeTuru').value,
        tutar: tutar,
        aciklama: document.getElementById('odemeAciklama').value.trim(),
        sahipId: sahipId
    };
    try {
        // --- DÜZELTME: Koşulu, HTML'den okuduğumuz "editingId" ile yapıyoruz. ---
        if (editingId) {
            // Eğer bir ID varsa, bu bir güncellemedir.
            await db.collection('odemeVeTahsilatlar').doc(editingId).set(formData, { merge: true });
        } else {
            // Eğer ID yoksa, bu yeni bir kayıttır.
            await db.collection('odemeVeTahsilatlar').add(formData);
        }
        resetOdemeForm();
        await renderOdemeListesi();
    } catch (error) {
        console.error("Ödeme/Tahsilat kaydedilirken hata:", error);
        alert("İşlem kaydedilirken bir hata oluştu.");
    }
}

function resetOdemeForm() {
    document.getElementById('odemeForm').reset();
    editingOdemeId = null;
    document.getElementById('odemeEditId').value = '';
    setEditingMode(document.getElementById('odemeFormBaslik'), document.getElementById('odemeKaydetBtn'), document.getElementById('odemeFormTemizleBtn'), null, 'Yeni Hareket Girişi');
}

async function renderOdemeListesi() {
    const listBody = document.getElementById('odemeListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    // Tablo başlığı (değişiklik yok)
    const thead = listBody.parentElement.querySelector('thead');
    if (thead) {
        thead.innerHTML = `
            <tr>
                <th>Tarih</th>
                <th>Cari</th>
                <th>İşlem Türü</th>
                <th>Ödeme Türü</th>
                <th>Tutar</th>
                <th>Açıklama</th>
                <th class="dont-print">İşlemler</th>
            </tr>`;
    }
    
    try {
        const snapshot = await db.collection('odemeVeTahsilatlar')
            .where('sahipId', '==', sahipId)
            .orderBy('tarih', 'desc')
            .limit(30)
            .get();
        
        if(snapshot.empty){
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">İşlem hareketi bulunmuyor.</td></tr>';
            return;
        }

        // GÜNCELLEME: ID toplama ve 'in' sorgusu ile isim çekme kodları kaldırıldı.
        // İsimler artık uygulama başında yüklenen 'window.cariDataMap' hafızasından okunacak.

        let rows = '';
        snapshot.forEach(doc => {
            const islem = doc.data();
            // GÜNCELLEME: Cari adı artık hafızadaki haritadan (map) anında okunuyor.
            const cariAdi = window.cariDataMap.get(islem.cariId)?.adiSoyadi || 'Bilinmiyor';
            
            // Metinlerin gösterim mantığı aynı kalıyor
            let islemTuruText = islem.islemTuru;
            if(islem.islemTuru === 'odeme') islemTuruText = 'Ödeme';
            if(islem.islemTuru === 'tahsilat') islemTuruText = 'Tahsilat';
            if(islem.islemTuru === 'borc') islemTuruText = 'Açılış Borcu';
            if(islem.islemTuru === 'alacak') islemTuruText = 'Açılış Alacağı';

            rows += `<tr>
                <td>${formatDate(islem.tarih)}</td>
                <td>${cariAdi}</td>
                <td>${islemTuruText}</td>
                <td>${islem.odemeTuru || '-'}</td>
                <td>${formatCurrency(islem.tutar)}</td>
                <td>${islem.aciklama}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editOdeme('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteOdeme('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;

    } catch (e) { 
        console.error("Ödeme listesi yüklenirken hata:", e);
        listBody.innerHTML = '<tr><td colspan="7" style="color: red; text-align:center;">Ödeme listesi yüklenirken bir hata oluştu.</td></tr>';
    }
}


// YENİ EKLENEN FONKSİYON
async function generateNextCariKodu() {
    try {
        // 1. Veritabanından mevcut tüm carileri çek
        const carilerSnapshot = await db.collection('cariler').where('sahipId', '==', sahipId).get();
        
        let maxNumber = 0;
        
        // 2. Tüm carilerin kodlarını kontrol et ve en yüksek numarayı bul
        carilerSnapshot.forEach(doc => {
            const kodu = doc.data().kodu;
            // Kodun "C" ile başlayıp başlamadığını ve numerik bir değere sahip olup olmadığını kontrol et
            if (kodu && kodu.toUpperCase().startsWith('C')) {
                // Kodun numerik kısmını al (örn: C055 -> 55)
                const numberPart = parseInt(kodu.substring(1), 10);
                if (!isNaN(numberPart) && numberPart > maxNumber) {
                    maxNumber = numberPart;
                }
            }
        });

        // 3. Bir sonraki numarayı hesapla
        const nextNumber = maxNumber + 1;
        
        // 4. Yeni kodu formatla (örn: 56 -> C056)
        // .padStart(3, '0') -> sayıyı 3 haneye tamamlamak için başına '0' ekler.
        const yeniKod = "C" + String(nextNumber).padStart(3, '0');
        
        // 5. Formdaki ilgili input alanına yeni kodu yaz
        document.getElementById('cariKodu').value = yeniKod;

    } catch (error) {
        console.error("Otomatik cari kodu oluşturulurken hata:", error);
        // Hata durumunda alanı boş bırak ki kullanıcı manuel girebilsin.
        document.getElementById('cariKodu').value = '';
    }
}
async function deleteYemSatisi(id) {
    if (confirm("Bu yem satışını silmek istediğinizden emin misiniz? Bu işlem, satılan yemi stoğa geri ekleyecektir.")) {
        const currentUser = auth.currentUser;
        if (!currentUser) return;

        const satisRef = db.collection('yem_satislari').doc(id);
        try {
            const satisDoc = await satisRef.get();
            if (!satisDoc.exists) {
                throw "Silinecek satış kaydı bulunamadı.";
            }
            const satisData = satisDoc.data();
            const yemRef = db.collection('yemler').doc(satisData.yemId);

            const batch = db.batch();
            // Satış kaydını sil
            batch.delete(satisRef);
            // Stoğu geri ekle
            batch.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(satisData.miktar) });
            
            await batch.commit();
            alert("Yem satışı silindi ve stok güncellendi.");

            await renderYemSatisListesi();
            await renderYemStokListesi();

        } catch (error) {
            console.error("Yem satışı silinirken hata:", error);
            alert("Hata: " + error);
        }
    }
}

        

async function renderTopluSutGirisFormu() {
    const tarih = document.getElementById('topluGirisTarih').value;
    const kategori = document.getElementById('topluGirisKategori').value;
    const container = document.getElementById('topluSutGirisTablosuAlani');
    const yokMesaji = document.getElementById('topluGirisTedarikciYokMesaji');
    const currentUser = auth.currentUser;

    // Önceki dinleyiciyi durdur
    if (topluGirisListener) {
        topluGirisListener();
    }

    if (!currentUser || !tarih || !kategori) {
        container.innerHTML = '';
        yokMesaji.style.display = 'block';
        yokMesaji.textContent = 'Lütfen tarih ve kategori seçimi yapın.';
        return;
    }

    // Sorguları hazırla
    const carilerQuery = db.collection('cariler')
        .where('sahipId', '==', sahipId)
        .where('kategori', '==', kategori)
        .where('durum', '==', 'aktif')
        .where('cariGrup', 'array-contains', 'üretici')
        .where('cariTipi', '!=', 'sadece_yem') // Sadece yem olanları hariç tut
        .orderBy('cariTipi') // Firestore'un '!=' sorgusu için ek bir sıralama alanı gerekir
        .orderBy('rotaSirasi');

    const sutAlimlariQuery = db.collection('sut_alimlari')
        .where('sahipId', '==', sahipId)
        .where('tarih', '==', tarih);
    
    // Her iki sorguyu da dinle
    topluGirisListener = carilerQuery.onSnapshot(async carilerSnapshot => {
        const tumCariler = carilerSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Sadece cariler değiştiğinde süt alımlarını tekrar dinlemeye gerek yok,
        // bu yüzden süt alım dinleyicisini cariler dinleyicisinin içine koyuyoruz.
        sutAlimlariQuery.onSnapshot(sutAlimSnapshot => {
            const kayitliCariIdleri = new Set(sutAlimSnapshot.docs.map(doc => doc.data().cariId));
            const gosterilecekCariler = tumCariler.filter(cari => !kayitliCariIdleri.has(cari.id));

            if (gosterilecekCariler.length === 0) {
                container.innerHTML = '';
                yokMesaji.style.display = 'block';
                yokMesaji.textContent = 'Bu kriterlere uygun, süt girişi bekleyen cari bulunmuyor.';
                return;
            }
            yokMesaji.style.display = 'none';
            
            let tableHTML = `<table><thead><tr><th>Cari Adı</th><th>Akşam (Lt)</th><th>Sabah (Lt)</th><th>Toplam (Lt)</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr></thead><tbody>`;
            const defaultFiyat = (globalSettings.defaultMilkPrice || 15.50).toFixed(2);
            gosterilecekCariler.forEach(cari => {
                const escapedCariAdi = cari.adiSoyadi.replace(/'/g, "\\'").replace(/"/g, '\\"');
                tableHTML += `<tr id="satir-${cari.id}"><td>${cari.adiSoyadi} (${cari.kategori || 'Belirtilmemiş'})</td><td><input type="number" id="aksam-${cari.id}" class="sut-input" step="0.1" min="0" oninput="sutMiktarGuncelle('${cari.id}')"></td><td><input type="number" id="sabah-${cari.id}" class="sut-input" step="0.1" min="0" oninput="sutMiktarGuncelle('${cari.id}')"></td><td><span id="toplam-lt-${cari.id}">0.00</span></td><td><input type="number" id="fiyat-${cari.id}" class="sut-input" step="0.01" min="0" value="${defaultFiyat}" oninput="sutMiktarGuncelle('${cari.id}')"></td><td><span id="toplam-tutar-${cari.id}">0,00 ₺</span></td><td class="dont-print"><button id="kaydet-btn-${cari.id}" class="btn btn-primary btn-sm" onclick="handleTopluSutKaydet('${cari.id}', '${escapedCariAdi}', '${tarih}')">Kaydet</button></td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        });
    }, error => {
        console.error("Toplu süt girişi için cariler dinlenirken hata:", error);
    });
}

function sutMiktarGuncelle(cariId) {
    const sabah = parseFloat(document.getElementById(`sabah-${cariId}`).value) || 0;
    const aksam = parseFloat(document.getElementById(`aksam-${cariId}`).value) || 0;
    const fiyat = parseFloat(document.getElementById(`fiyat-${cariId}`).value) || 0;
    const toplamLt = sabah + aksam;
    const toplamTutar = toplamLt * fiyat;
    document.getElementById(`toplam-lt-${cariId}`).textContent = toplamLt.toFixed(2);
    document.getElementById(`toplam-tutar-${cariId}`).textContent = formatCurrency(toplamTutar);
}

async function handleTopluSutKaydet(cariId, cariAdi, tarih) {
    const sabahInput = document.getElementById(`sabah-${cariId}`);
    const aksamInput = document.getElementById(`aksam-${cariId}`);
    const fiyatInput = document.getElementById(`fiyat-${cariId}`);
    const tankId = document.getElementById('topluGirisTank').value;

    const sabahMiktar = parseFloat(sabahInput.value) || 0;
    const aksamMiktar = parseFloat(aksamInput.value) || 0;
    const birimFiyat = parseFloat(fiyatInput.value) || globalSettings.defaultMilkPrice || 0;
    const bugunkuToplamMiktar = sabahMiktar + aksamMiktar;
    
    if (bugunkuToplamMiktar <= 0) {
        alert("Lütfen en az bir miktar girin.");
        return;
    }
    if (!tankId) {
        alert("Lütfen bir tank seçin!");
        return;
    }
    
    // --- BAŞLANGIÇ: YENİ UYARI KONTROLÜ EKLENDİ ---
    try {
        const today = new Date(tarih);
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        const dunkuSutSnapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('cariId', '==', cariId)
            .where('tarih', '==', yesterdayStr)
            .limit(1).get();

        if (!dunkuSutSnapshot.empty) {
            const dunkuToplamMiktar = dunkuSutSnapshot.docs[0].data().toplam;
            const altLimit = dunkuToplamMiktar * 0.90;
            const ustLimit = dunkuToplamMiktar * 1.10;

            if (bugunkuToplamMiktar < altLimit || bugunkuToplamMiktar > ustLimit) {
                const fark = bugunkuToplamMiktar - dunkuToplamMiktar;
                const durum = fark > 0 ? 'daha fazla' : 'daha az';
                const onay = confirm(`⚠️ DİKKAT! \n\nBugün girilen miktar (${bugunkuToplamMiktar.toFixed(1)} Lt), dün girilen miktardan (${dunkuToplamMiktar.toFixed(1)} Lt) %10 oranında ${durum}.\n\nBu miktar doğru mu? Kaydetmek için 'Tamam'a basın.`);
                if (!onay) {
                    return; // Kullanıcı iptal ederse kaydı durdur.
                }
            }
        }
    } catch (error) {
        console.error("Önceki gün kontrolü sırasında hata:", error);
        // Hata olsa bile işleme devam et, sadece uyarısız kaydeder.
    }
    // --- BİTİŞ: YENİ UYARI KONTROLÜ EKLENDİ ---

    const satir = document.getElementById(`satir-${cariId}`);
    if(satir) satir.querySelector('button').disabled = true;

    // ... (Geri kalan kayıt kodları aynı şekilde devam ediyor)
    const calisanId = auth.currentUser.uid;
    const batch = db.batch();

    const sutAlimRef = db.collection("sut_alimlari").doc();
    batch.set(sutAlimRef, {
        tarih: tarih, cariId: cariId, cariAdi: cariAdi,
        sabah: sabahMiktar, aksam: aksamMiktar, toplam: bugunkuToplamMiktar,
        fiyat: birimFiyat, toplamTutar: bugunkuToplamMiktar * birimFiyat, sahipId: sahipId
    });

    if (sabahMiktar > 0) {
        const movementRefSabah = db.collection('tank_hareketleri').doc();
        batch.set(movementRefSabah, {
            movementId: movementRefSabah.id, ureticiId: cariId, ureticiAdi: cariAdi,
            sahipId: sahipId, calisanId: calisanId, tankId: tankId, alim_tarihi: tarih,
            zaman_dilimi: 'sabah', miktar: sabahMiktar, birim_fiyat: birimFiyat,
            toplam_tutar: sabahMiktar * birimFiyat, kayitZamani: new Date()
        });
    }
    if (aksamMiktar > 0) {
        const movementRefAksam = db.collection('tank_hareketleri').doc();
        batch.set(movementRefAksam, {
            movementId: movementRefAksam.id, ureticiId: cariId, ureticiAdi: cariAdi,
            sahipId: sahipId, calisanId: calisanId, tankId: tankId, alim_tarihi: tarih,
            zaman_dilimi: 'akşam', miktar: aksamMiktar, birim_fiyat: birimFiyat,
            toplam_tutar: aksamMiktar * birimFiyat, kayitZamani: new Date()
        });
    }

    const tankRef = db.collection('tanklar').doc(tankId);
    batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(bugunkuToplamMiktar) });

    try {
        await batch.commit();
        if (satir) satir.style.display = 'none';
        await renderSutAlimGecmisi();
    } catch (error) {
        console.error("Toplu süt alımı kaydedilirken hata:", error);
        alert("Kayıt sırasında bir hata oluştu: " + error.message);
        if(satir) satir.querySelector('button').disabled = false;
    }
}



function calculateKarneTotals() {
    let aksamGenelToplam = 0, sabahGenelToplam = 0;
    document.querySelectorAll('#sut-rapor-tablosu input.aksam').forEach(input => aksamGenelToplam += Number(input.value) || 0);
    document.querySelectorAll('#sut-rapor-tablosu input.sabah').forEach(input => sabahGenelToplam += Number(input.value) || 0);

    const aksamToplamEl = document.getElementById('aksam-genel-toplam');
    const sabahToplamEl = document.getElementById('sabah-genel-toplam');
    const genelToplamEl = document.getElementById('genel-toplam');

    if(aksamToplamEl) aksamToplamEl.textContent = aksamGenelToplam.toFixed(2);
    if(sabahToplamEl) sabahToplamEl.textContent = sabahGenelToplam.toFixed(2);
    if(genelToplamEl) genelToplamEl.textContent = (aksamGenelToplam + sabahGenelToplam).toFixed(2);
}
        
function hesaplaToplamTutar(miktarInputId, fiyatInputId, toplamInputId) {
    const miktarInput = document.getElementById(miktarInputId);
    const fiyatInput = document.getElementById(fiyatInputId);
    const toplamInput = document.getElementById(toplamInputId);

    const miktar = parseFloat(miktarInput.value) || 0;
    const fiyat = parseFloat(fiyatInput.value) || 0;
    toplamInput.value = formatCurrency(miktar * fiyat);
}

async function renderSutAlimGecmisi() {
    const tarih = document.getElementById('topluGirisTarih').value;
    const gecmisTarihSpan = document.getElementById('gecmisTarihSpan');
    const header = document.getElementById('sutAlimGecmisiHeader');
    const body = document.getElementById('sutAlimGecmisiBody');
    const footer = document.getElementById('sutAlimGecmisiFooter');
    const currentUser = auth.currentUser;

    // Önceki dinleyiciyi durdur (varsa)
    if (sutAlimGecmisiListener) {
        sutAlimGecmisiListener();
    }

    if (!currentUser || !tarih) {
        header.innerHTML = '';
        body.innerHTML = '';
        footer.innerHTML = '';
        return;
    }

    gecmisTarihSpan.textContent = formatDate(tarih);
    header.innerHTML = `<tr><th>Üretici</th><th>Akşam (Lt)</th><th>Sabah (Lt)</th><th>Toplam</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr>`;
    body.innerHTML = '<tr><td colspan="7">Yükleniyor...</td></tr>';
    footer.innerHTML = '';

    const query = db.collection('sut_alimlari')
        .where('sahipId', '==', sahipId)
        .where('tarih', '==', tarih)
        .orderBy('cariAdi');

    // .onSnapshot() kullanarak gerçek zamanlı dinleyici kur
    sutAlimGecmisiListener = query.onSnapshot(snapshot => {
    
        // DÜZELTME: Gelen veriler, tank aktarımlarını hariç tutacak şekilde burada filtreleniyor.
        const ureticiAlimlari = snapshot.docs.filter(doc => doc.data().islemKaynagi !== 'tank-aktarim');

        if (ureticiAlimlari.length === 0) {
            body.innerHTML = '<tr><td colspan="7" style="text-align:center;">Bu tarih için üretici süt alım kaydı bulunmuyor.</td></tr>';
            footer.innerHTML = ''; // Kayıt yoksa alt toplamı da temizle
            return;
        }

        const groupedData = new Map();

        // Filtrelenmiş veri (`ureticiAlimlari`) üzerinden işlemler yapılıyor.
        ureticiAlimlari.forEach(doc => {
            const alim = doc.data();
            const docId = doc.id; 

            if (!groupedData.has(alim.cariId)) {
                groupedData.set(alim.cariId, {
                    cariAdi: alim.cariAdi,
                    sabah: 0,
                    aksam: 0,
                    toplam: 0,
                    toplamTutar: 0,
                    fiyat: 0,
                    docIds: []
                });
            }
            
            const cariData = groupedData.get(alim.cariId);
            cariData.sabah += alim.sabah || 0;
            cariData.aksam += alim.aksam || 0;
            cariData.toplam += alim.toplam || 0;
            cariData.toplamTutar += alim.toplamTutar || 0;
            cariData.docIds.push(docId);
        });

        let bodyHTML = '';
        let genelToplamAksam = 0, genelToplamSabah = 0, genelToplamLitre = 0, genelToplamTutar = 0;

        groupedData.forEach((data, cariId) => {
            const ortalamaFiyat = data.toplam > 0 ? (data.toplamTutar / data.toplam) : 0;
            
            genelToplamAksam += data.aksam;
            genelToplamSabah += data.sabah;
            genelToplamLitre += data.toplam;
            genelToplamTutar += data.toplamTutar;

            const sonKayitId = data.docIds[data.docIds.length - 1];

            bodyHTML += `<tr>
                <td>${data.cariAdi}</td>
                <td>${data.aksam.toFixed(2)}</td>
                <td>${data.sabah.toFixed(2)}</td>
                <td><strong>${data.toplam.toFixed(2)}</strong></td>
                <td>${formatCurrency(ortalamaFiyat)}</td>
                <td><strong>${formatCurrency(data.toplamTutar)}</strong></td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editSutAlimi('${sonKayitId}')" title="Bu satırdaki son girişi düzenler.">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteSutAlimi('${sonKayitId}')" title="Bu satırdaki son girişi siler.">Sil</button>
                </td>
            </tr>`;
        });
        
        body.innerHTML = bodyHTML;

        const genelOrtalamaFiyat = genelToplamLitre > 0 ? (genelToplamTutar / genelToplamLitre) : 0;
        footer.innerHTML = `
            <tr style="background-color: #f0f0f0; font-weight: bold;">
                <td><strong>GÜNLÜK TOPLAM</strong></td>
                <td><strong>${genelToplamAksam.toFixed(2)}</strong></td>
                <td><strong>${genelToplamSabah.toFixed(2)}</strong></td>
                <td><strong>${genelToplamLitre.toFixed(2)}</strong></td>
                <td><strong>${formatCurrency(genelOrtalamaFiyat)}</strong></td>
                <td><strong>${formatCurrency(genelToplamTutar)}</strong></td>
                <td class="dont-print"></td>
            </tr>`;

    }, error => {
        console.error("Süt alım geçmişi dinlenirken hata:", error);
        body.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Geçmiş yüklenirken bir hata oluştu.</td></tr>';
    });
}

 
async function deleteYemAlisi(id) {
    if (confirm("Bu yem alışını silmek istediğinizden emin misiniz? Bu işlem, alınan yemi stoktan düşecektir.")) {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert("Lütfen giriş yapın.");
            return;
        }

        const alisRef = db.collection('yem_alimlari').doc(id);
        try {
            const alisDoc = await alisRef.get();
            if (!alisDoc.exists) {
                throw "Silinecek alış kaydı bulunamadı.";
            }
            const alisData = alisDoc.data();
            const yemRef = db.collection('yemler').doc(alisData.yemId);

            // Hem alış kaydını silmek hem de stoğu güncellemek için toplu işlem kullan
            const batch = db.batch();
            
            // 1. Alış kaydını sil
            batch.delete(alisRef);
            // 2. Stoğu azalt (alınan miktarın negatifini ekleyerek)
            batch.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(-alisData.miktar) });
            
            await batch.commit();
            alert("Yem alışı silindi ve stok güncellendi.");

            // Listeleri yenile
            await renderYemAlisHareketleri();
            await renderYemStokListesi();

        } catch (error) {
            console.error("Yem alışı silinirken hata:", error);
            alert("Hata: " + error);
        }
    }
}
       
async function handleSutAlimRaporuOlustur(options) {
    toggleReportButtons('sutRaporu', false);
    
    const cariId = document.getElementById('sutRaporuTedarikciSecimi').value;
    const startDateStr = document.getElementById('sutRaporuBaslangicTarihi').value;
    const endDateStr = document.getElementById('sutRaporuBitisTarihi').value;
    const kategori = document.getElementById('sutRaporuKategoriSecimi').value;
    const raporBaslik = document.getElementById('sutRaporuBaslik');
    const sutRaporuDetayAlani = document.getElementById('sutRaporuDetayAlani');

    if (!startDateStr || !endDateStr) {
        alert("Rapor oluşturmak için lütfen başlangıç ve bitiş tarihlerini seçin.");
        return;
    }
    if (!options.tumu && !options.kategori && !cariId) {
        alert("Lütfen bir cari seçin veya 'Kategori' ya da 'Toplu' raporu seçin.");
        return;
    }
    
    sutRaporuDetayAlani.innerHTML = '<p>Rapor oluşturuluyor, lütfen bekleyin...</p>';
    document.getElementById('sut-raporu-export-area').innerHTML = '';

    try {
        let baseQuery = db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('tarih', '>=', startDateStr)
            .where('tarih', '<=', endDateStr);

        let tableHTML = '';
        const raporTarihEtiketi = `${formatDate(startDateStr)} - ${formatDate(endDateStr)}`;

        // Bireysel Cari Raporu
        if (!options.tumu && !options.kategori) {
            const cariAdi = document.getElementById('sutRaporuTedarikciSecimi').options[document.getElementById('sutRaporuTedarikciSecimi').selectedIndex].text;
            raporBaslik.textContent = `${cariAdi} - ${raporTarihEtiketi} Süt Detayları`;
            
            const finalQuery = baseQuery.where('cariId', '==', cariId).orderBy('tarih');
            const snapshot = await finalQuery.get();

            if (snapshot.empty) {
                tableHTML = '<p>Seçili cari için bu tarih aralığında süt alım kaydı bulunamadı.</p>';
            } else {
                // GÜNCELLEME 1: Veriler artık tarihe göre gruplanıyor, böylece her gün için tek bir satır oluşur.
                const gunlukVeri = new Map();
                snapshot.forEach(doc => {
                    const alim = doc.data();
                    if (!gunlukVeri.has(alim.tarih)) {
                        gunlukVeri.set(alim.tarih, { tarih: alim.tarih, sabah: 0, aksam: 0, toplam: 0, toplamTutar: 0 });
                    }
                    const gun = gunlukVeri.get(alim.tarih);
                    gun.sabah += alim.sabah || 0;
                    gun.aksam += alim.aksam || 0;
                    gun.toplam += alim.toplam || 0;
                    gun.toplamTutar += alim.toplamTutar || 0;
                });
                
                tableHTML = `<table class="report-table"><thead><tr><th>Tarih</th><th>Akşam</th><th>Sabah</th><th>Toplam (Lt)</th><th>Ort. Fiyat</th><th>Tutar</th></tr></thead><tbody>`;
                let toplamSabah = 0, toplamAksam = 0, toplamLitre = 0, toplamTutar = 0;
                
                // Gruplanmış veriler ekrana yazdırılıyor.
                gunlukVeri.forEach(alim => {
                    const ortalamaFiyat = alim.toplam > 0 ? alim.toplamTutar / alim.toplam : 0;
                    toplamSabah += alim.sabah;
                    toplamAksam += alim.aksam;
                    toplamLitre += alim.toplam;
                    toplamTutar += alim.toplamTutar;
                    tableHTML += `<tr><td>${formatDate(alim.tarih)}</td><td>${alim.aksam.toFixed(2)}</td><td>${alim.sabah.toFixed(2)}</td><td>${alim.toplam.toFixed(2)}</td><td>${formatCurrency(ortalamaFiyat)}</td><td>${formatCurrency(alim.toplamTutar)}</td></tr>`;
                });

                const genelOrtalamaFiyat = toplamLitre > 0 ? (toplamTutar / toplamLitre) : 0;
                tableHTML += `</tbody><tfoot><tr class="report-totals-row"><td><strong>TOPLAM</strong></td><td><strong>${toplamAksam.toFixed(2)}</strong></td><td><strong>${toplamSabah.toFixed(2)}</strong></td><td><strong>${toplamLitre.toFixed(2)}</strong></td><td><strong>${formatCurrency(genelOrtalamaFiyat)}</strong></td><td><strong>${formatCurrency(toplamTutar)}</strong></td></tr></tfoot></table>`;
            }
        } 
        // Kategori veya Toplu Rapor
        else { 
            if(options.kategori && kategori) {
                raporBaslik.textContent = `${kategori} Kategorisi - ${raporTarihEtiketi} Özet Raporu`;
            } else {
                raporBaslik.textContent = `Tüm Üreticiler - ${raporTarihEtiketi} Özet Raporu`;
            }

            // GÜNCELLEME 2: Sadece "üretici" grubundaki cariler çekiliyor.
            const allCarilerSnapshot = await db.collection('cariler')
                .where('sahipId', '==', sahipId)
                .where('cariGrup', 'array-contains', 'üretici')
                .get();
                
            const allProducers = new Map(allCarilerSnapshot.docs.map(doc => [doc.id, doc.data()]));

            let alimlarSnapshot = await baseQuery.get();
            // Sadece üreticilere ait alımlar filtreleniyor
            let alimlar = alimlarSnapshot.docs.map(doc => doc.data()).filter(alim => allProducers.has(alim.cariId));

            if (options.kategori && kategori) {
                alimlar = alimlar.filter(alim => allProducers.get(alim.cariId)?.kategori === kategori);
            }
            
            if (alimlar.length === 0) {
                tableHTML = '<p>Seçili kriterlere uygun üretici süt alım kaydı bulunamadı.</p>';
            } else {
                const raporData = {};
                alimlar.forEach(alim => {
                    if (!raporData[alim.cariId]) {
                        const producerInfo = allProducers.get(alim.cariId);
                        raporData[alim.cariId] = { 
                            cariAdi: producerInfo?.adiSoyadi || 'Silinmiş Cari',
                            // GÜNCELLEME 3: Rota sırası bilgisi de veriye ekleniyor.
                            rotaSirasi: producerInfo?.rotaSirasi || 9999,
                            toplamSabah: 0, 
                            toplamAksam: 0, 
                            toplamLitre: 0, 
                            toplamTutar: 0 
                        };
                    }
                    const ozet = raporData[alim.cariId];
                    ozet.toplamSabah += alim.sabah || 0;
                    ozet.toplamAksam += alim.aksam || 0;
                    ozet.toplamLitre += alim.toplam || 0;
                    ozet.toplamTutar += alim.toplamTutar || 0;
                });

                tableHTML = `<table class="report-table"><thead><tr><th>Cari Adı</th><th>Toplam Akşam</th><th>Toplam Sabah</th><th>Toplam Litre</th><th>Ortalama Fiyat</th><th>Toplam Tutar</th></tr></thead><tbody>`;
                
                let genelToplamAksam = 0, genelToplamSabah = 0, genelToplamLitre = 0, genelToplamTutar = 0;

                // GÜNCELLEME 3: Sıralama artık rota sırasına göre yapılıyor.
                Object.values(raporData).sort((a,b) => a.rotaSirasi - b.rotaSirasi).forEach(data => {
                    const ortalamaFiyat = data.toplamLitre > 0 ? (data.toplamTutar / data.toplamLitre) : 0;
                    tableHTML += `<tr><td>${data.cariAdi}</td><td>${data.toplamAksam.toFixed(2)}</td><td>${data.toplamSabah.toFixed(2)}</td><td><strong>${data.toplamLitre.toFixed(2)}</strong></td><td>${formatCurrency(ortalamaFiyat)}</td><td><strong>${formatCurrency(data.toplamTutar)}</strong></td></tr>`;
                
                    genelToplamAksam += data.toplamAksam;
                    genelToplamSabah += data.toplamSabah;
                    genelToplamLitre += data.toplamLitre;
                    genelToplamTutar += data.toplamTutar;
                });
                
                const genelOrtalamaFiyat = genelToplamLitre > 0 ? (genelToplamTutar / genelToplamLitre) : 0;

                tableHTML += `</tbody>
                              <tfoot>
                                  <tr class="report-totals-row">
                                      <td><strong>GENEL TOPLAM</strong></td>
                                      <td><strong>${genelToplamAksam.toFixed(2)}</strong></td>
                                      <td><strong>${genelToplamSabah.toFixed(2)}</strong></td>
                                      <td><strong>${genelToplamLitre.toFixed(2)}</strong></td>
                                      <td><strong>${formatCurrency(genelOrtalamaFiyat)}</strong></td>
                                      <td><strong>${formatCurrency(genelToplamTutar)}</strong></td>
                                  </tr>
                              </tfoot>
                            </table>`;
            }
        }
        
        sutRaporuDetayAlani.innerHTML = tableHTML;
        document.getElementById('sut-raporu-export-area').innerHTML = tableHTML;
        toggleReportButtons('sutRaporu', true);
        
    } catch (error) {
        console.error("Süt Alım Raporu oluşturulurken hata:", error);
        sutRaporuDetayAlani.innerHTML = `<p style="color:red; font-weight:bold;">RAPOR OLUŞTURULAMADI!<br>Hata Detayı: ${error.message}</p>`;
        document.getElementById('sut-raporu-export-area').innerHTML = '';
    }
}

	
async function exportSutRaporuToExcel() {
    console.log("Özel Aylık Süt Raporu Excel dışa aktarma işlemi başlatıldı.");

    // 1. Rapor oluşturmak için gerekli olan güncel filtreleri al
    const ayYil = document.getElementById('sutRaporuAySecimi').value;
    const cariId = document.getElementById('sutRaporuTedarikciSecimi').value;
    const kategori = document.getElementById('sutRaporuKategoriSecimi').value;
    const raporButonlari = document.querySelectorAll('#sutRaporuOlusturBtn, #sutRaporuKategoriGosterBtn, #sutRaporuTumunuGosterBtn');
    
    // Hangi rapor türünün aktif olduğunu anla
    let options = {tumu: false, kategori: false};
    if (document.activeElement.id === 'sutRaporuKategoriGosterBtn') options.kategori = true;
    if (document.activeElement.id === 'sutRaporuTumunuGosterBtn') options.tumu = true;


    if (!ayYil) {
        alert("Dışa aktarmadan önce lütfen bir rapor oluşturun.");
        return;
    }

    try {
        // 2. Raporu oluşturmak için veriyi veritabanından yeniden çek
        const [year, month] = ayYil.split('-');
        const startDateStr = `${year}-${month}-01`;
        const endDate = new Date(year, parseInt(month, 10), 0);
        const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;

        let baseQuery = db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('tarih', '>=', startDateStr)
            .where('tarih', '<=', endDateStr);
        
        let dataForExcel = [];
        let sheetTitle = "Aylik Sut Raporu";

        // 3. Rapor türüne göre veriyi işle ve Excel için hazırla
        // Bireysel Rapor
        if (!options.tumu && !options.kategori) {
            if (!cariId) { alert("Lütfen bir cari seçin."); return; }
            const cariAdi = document.getElementById('sutRaporuTedarikciSecimi').options[document.getElementById('sutRaporuTedarikciSecimi').selectedIndex].text;
            sheetTitle = cariAdi;
            const snapshot = await baseQuery.where('cariId', '==', cariId).orderBy('tarih').get();
            if (snapshot.empty) { alert("Dışa aktarılacak veri bulunamadı."); return; }

            let toplamLitre = 0, toplamTutar = 0;
            dataForExcel = snapshot.docs.map(doc => {
                const alim = doc.data();
                toplamLitre += alim.toplam || 0;
                toplamTutar += alim.toplamTutar || 0;
                return {
                    "Tarih": formatDate(alim.tarih),
                    "Akşam (Lt)": (alim.aksam || 0).toFixed(2),
                    "Sabah (Lt)": (alim.sabah || 0).toFixed(2),
                    "Toplam (Lt)": (alim.toplam || 0).toFixed(2),
                    "Fiyat (₺)": (alim.fiyat || 0).toFixed(2),
                    "Tutar (₺)": (alim.toplamTutar || 0).toFixed(2)
                };
            });
            dataForExcel.push({}); // Boş satır
            dataForExcel.push({ "Tarih": "AYLIK TOPLAM", "Toplam (Lt)": toplamLitre.toFixed(2), "Tutar (₺)": toplamTutar.toFixed(2) });

        // Kategori veya Toplu Rapor
        } else {
             // ... Bu bölümün mantığı da benzer şekilde eklenebilir, şimdilik bireysel rapora odaklanıyoruz.
             alert("Toplu ve Kategori raporları için Excel dışa aktarma henüz tamamlanmadı."); return;
        }

        // 4. Veriyi kullanarak Excel dosyasını oluştur ve indir
        const worksheet = XLSX.utils.json_to_sheet(dataForExcel);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, sheetTitle);
        XLSX.writeFile(workbook, "Aylik_Sut_Raporu.xlsx");

    } catch (error) {
        console.error("Excel oluşturulurken hata oluştu:", error);
        alert("Excel dosyası oluşturulurken bir hata oluştu.");
    }
}

async function handleDinamikSutRaporu() {
    const periodValue = document.getElementById('karneRaporuPeriyotSecimi').value;
    const kategori = document.getElementById('karneRaporuKategoriSecimi').value;
    const container = document.getElementById('dinamikRaporContainer');

    if (!periodValue) {
        alert("Lütfen bir dönem seçin.");
        return;
    }
    container.innerHTML = `<p style="text-align:center; font-size:1.2em;">Rapor oluşturuluyor, veriler çekiliyor...</p>`;

    const [year, month, periodPart] = periodValue.split('-');
    const intYear = parseInt(year, 10);
    const intMonth = parseInt(month, 10);

    let baslangicGunu, bitisGunu, startDateStr, endDateStr;
    const formatForDB = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

    if (periodPart === '1') {
        baslangicGunu = 1;
        bitisGunu = 15;
    } else {
        baslangicGunu = 16;
        bitisGunu = new Date(intYear, intMonth, 0).getDate();
    }
    
    startDateStr = formatForDB(new Date(intYear, intMonth - 1, baslangicGunu));
    endDateStr = formatForDB(new Date(intYear, intMonth - 1, bitisGunu));

    const ayIsimleri = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
    const raporKategoriAdi = kategori ? `${kategori} -` : 'Tüm Kategoriler -';
    const reportTitleText = `${raporKategoriAdi} ${ayIsimleri[intMonth - 1]} ${intYear} / ${periodPart}. Yarı Süt Karnesi`;

    try {
        // GÜNCELLEME: Önce tüm üreticiler çekiliyor, sonra kod içinde filtreleniyor.
        const producersQuery = db.collection('cariler')
            .where('sahipId', '==', sahipId)
            .where('cariGrup', 'array-contains', 'üretici');

        const [allProducersSnapshot, milkSnapshot] = await Promise.all([
            producersQuery.get(),
            db.collection('sut_alimlari').where('sahipId', '==', sahipId).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get()
        ]);
        
        let allProducers = allProducersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // GÜNCELLEME: Kategori filtresi artık burada, JavaScript içinde yapılıyor.
        let producers = kategori ? allProducers.filter(p => p.kategori === kategori) : allProducers;

        if (producers.length === 0) {
            container.innerHTML = '<p style="text-align:center;">Bu kriterlere uygun üretici bulunamadı.</p>';
            return;
        }

        producers.sort((a, b) => (a.rotaSirasi || 9999) - (b.rotaSirasi || 9999));
        
        const producerIdsInReport = new Set(producers.map(p => p.id));
        const milkData = new Map();
        const dailyTotals = new Map();

        milkSnapshot.forEach(doc => {
            const alim = doc.data();
            if (producerIdsInReport.has(alim.cariId)) {
                const key = `${alim.cariId}_${alim.tarih}`;
                milkData.set(key, alim);

                const day = new Date(alim.tarih + 'T12:00:00').getDate();
                if (!dailyTotals.has(day)) {
                    dailyTotals.set(day, { sabah: 0, aksam: 0 });
                }
                const totals = dailyTotals.get(day);
                totals.sabah += alim.sabah || 0;
                totals.aksam += alim.aksam || 0;
            }
        });
        
        let tableHTML = `
            <div class="dinamik-rapor-header dont-print"><h1>${reportTitleText}</h1></div>
            <div class="table-wrapper">
                <table id="sut-rapor-tablosu">
                    <thead><tr class="gunler"></tr><tr class="vakit"></tr></thead>
                    <tbody></tbody>
                    <tfoot></tfoot>
                </table>
            </div>`;
        container.innerHTML = tableHTML;
        
        const tableHeadGunler = container.querySelector('thead tr.gunler');
        const tableHeadVakit = container.querySelector('thead tr.vakit');
        const tableBody = container.querySelector('tbody');

        tableHeadGunler.innerHTML = '<th rowspan="2" class="uretici-listesi">ÜRETİCİ LİSTESİ</th>';
        tableHeadVakit.innerHTML = '';

        for (let i = baslangicGunu; i <= bitisGunu; i++) {
            tableHeadGunler.innerHTML += `<th colspan="2">${i}</th>`;
            tableHeadVakit.innerHTML += `<th class="vakit-baslik">A</th><th class="vakit-baslik">S</th>`;
        }
        
        tableBody.innerHTML = '';
        producers.forEach(producer => {
            let rowHTML = `<td class="uretici-listesi">${producer.adiSoyadi}</td>`;
            for (let i = baslangicGunu; i <= bitisGunu; i++) {
                const day = String(i).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                const key = `${producer.id}_${dateStr}`;
                const data = milkData.get(key) || { sabah: null, aksam: null };
                const formatLitre = (val) => (val === null || val === undefined) ? '' : (val % 1 === 0 ? val.toString() : Number(val).toFixed(1).replace('.', ','));
                rowHTML += `<td>${formatLitre(data.aksam)}</td><td>${formatLitre(data.sabah)}</td>`;
            }
            tableBody.innerHTML += `<tr>${rowHTML}</tr>`;
        });
        
        const tfoot = container.querySelector('tfoot');
        let footerHTML = '<tr><td class="uretici-listesi"><strong>GÜNLÜK TOPLAM</strong></td>';
        for (let i = baslangicGunu; i <= bitisGunu; i++) {
            const totalsForDay = dailyTotals.get(i) || { sabah: 0, aksam: 0 };
            const formatLitre = (val) => (val > 0 ? (val % 1 === 0 ? val.toString() : Number(val).toFixed(1).replace('.', ',')) : '0');
            
            footerHTML += `<td><strong>${formatLitre(totalsForDay.aksam)}</strong></td>`;
            footerHTML += `<td><strong>${formatLitre(totalsForDay.sabah)}</strong></td>`;
        }
        footerHTML += '</tr>';
        tfoot.innerHTML = footerHTML;

    } catch(error) {
        console.error("Dinamik rapor oluşturulurken hata:", error);
        container.innerHTML = `<p style="color:red; text-align:center;">Rapor oluşturulurken bir hata oluştu: ${error.message}</p>`;
    }
}

async function handleYemPivotRaporu(reportType) {
    const raporAlani = document.getElementById('yemRaporuAlani');
    toggleReportButtons('yemRaporu', false);
    const ayYil = document.getElementById('yemRaporuAySecimi').value;
    const currentUser = auth.currentUser;

    if (!currentUser || !ayYil) {
        alert("Lütfen bir ay seçin.");
        raporAlani.innerHTML = '';
        return;
    }

    raporAlani.innerHTML = '<p>Rapor oluşturuluyor, lütfen bekleyin...</p>';

    try {
        const [year, month] = ayYil.split('-');
        const startDateStr = `${year}-${month}-01`;
        const endDate = new Date(year, month, 0);
        const endDateStr = endDate.toISOString().split('T')[0];

        const [satisSnapshot, yemlerSnapshot, carilerSnapshot, yemAlimlariSnapshot] = await Promise.all([
            db.collection('yem_satislari').where('sahipId', '==', sahipId).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get(),
            db.collection('yemler').where('sahipId', '==', sahipId).get(),
            db.collection('cariler').where('sahipId', '==', sahipId).get(),
            db.collection('yem_alimlari').where('sahipId', '==', sahipId).orderBy('tarih').get()
        ]);

        if (satisSnapshot.empty) {
            raporAlani.innerHTML = '<h4>Bu ay için yem satışı bulunmuyor.</h4>';
            return;
        }

        const yemMap = new Map(yemlerSnapshot.docs.map(doc => [doc.id, doc.data()]));
        const cariMap = new Map(carilerSnapshot.docs.map(doc => [doc.id, doc.data()]));
        
        const ortalamaMaliyetMap = new Map();
        if (reportType === 'karlilik') {
            const maliyetMap = new Map();
            yemAlimlariSnapshot.forEach(doc => {
                const alim = doc.data();
                if (!maliyetMap.has(alim.yemId)) maliyetMap.set(alim.yemId, { toplamTutar: 0, toplamMiktar: 0 });
                const yemMaliyet = maliyetMap.get(alim.yemId);
                yemMaliyet.toplamTutar += alim.toplamTutar;
                yemMaliyet.toplamMiktar += alim.miktar;
            });
            maliyetMap.forEach((value, key) => {
                if (value.toplamMiktar > 0) ortalamaMaliyetMap.set(key, value.toplamTutar / value.toplamMiktar);
            });
        }

        const reportData = new Map();
        const yemlerInReport = new Set();
        satisSnapshot.forEach(doc => {
            const satis = doc.data();
            yemlerInReport.add(satis.yemId);

            if (!reportData.has(satis.cariId)) {
                reportData.set(satis.cariId, {
                    cariAdi: cariMap.get(satis.cariId)?.adiSoyadi || 'Bilinmeyen Cari',
                    yemler: new Map(),
                    musteriToplamSatis: 0,
                    musteriToplamKar: 0,
                    musteriToplamAdet: 0
                });
            }
            
            const cariData = reportData.get(satis.cariId);

            if (!cariData.yemler.has(satis.yemId)) {
                cariData.yemler.set(satis.yemId, { adet: 0, toplamSatis: 0, toplamKar: 0 });
            }

            const yemData = cariData.yemler.get(satis.yemId);
            yemData.adet += satis.miktar;
            yemData.toplamSatis += satis.toplamTutar;
            
            const maliyet = ortalamaMaliyetMap.get(satis.yemId) || 0;
            const satisKar = (satis.satisFiyati - maliyet) * satis.miktar;
            yemData.toplamKar += satisKar;
            
            cariData.musteriToplamSatis += satis.toplamTutar;
            cariData.musteriToplamKar += satisKar;
            cariData.musteriToplamAdet += satis.miktar;
        });

        const sortedYemList = Array.from(yemlerInReport).sort((a, b) => (yemMap.get(a)?.ad || '').localeCompare(yemMap.get(b)?.ad || ''));
        
        let reportTitle = '';
        if (reportType === 'adet') reportTitle = 'Adet Bazlı Yem Satış Raporu';
        else if (reportType === 'satis') reportTitle = 'Detaylı Yem Satış Raporu (Tutar)';
        else reportTitle = 'Müşteri Bazlı Yem Kârlılık Raporu';

        let tableHTML = `<h3 class="print-only print-title" style="text-align:center;">${reportTitle} - ${formatMonthYear(ayYil)}</h3>`;
        tableHTML += `<table class="report-table"><thead>`;
        
        let headerRow1 = `<tr><th rowspan="${reportType === 'adet' ? '1' : '2'}" style="vertical-align: middle;">Müşteri Adı</th>`;
        sortedYemList.forEach(yemId => {
            const yemAdi = yemMap.get(yemId)?.ad || 'Bilinmeyen';
            let colSpan = (reportType === 'adet') ? 1 : (reportType === 'satis' ? 3 : 5);
            headerRow1 += `<th colspan="${colSpan}" style="text-align: center;">${yemAdi}</th>`;
        });
        
        let lastColTitle = (reportType === 'adet') ? 'Üretici Toplam (Adet)' : (reportType === 'satis' ? 'Müşteri Toplamı' : 'Müşteri Toplam Kârı');
        headerRow1 += `<th rowspan="${reportType === 'adet' ? '1' : '2'}" style="vertical-align: middle;">${lastColTitle}</th></tr>`;
        
        let headerRow2 = '<tr>';
        if(reportType !== 'adet') {
             sortedYemList.forEach(() => {
                if (reportType === 'satis') headerRow2 += `<th>Adet</th><th>Fiyat</th><th>Toplam</th>`;
                else headerRow2 += `<th>Adet</th><th>Satış F.</th><th>Ort. Alış F.</th><th>Birim Kâr</th><th>Toplam Kâr</th>`;
            });
            headerRow2 += '</tr>';
        } else {
            headerRow2 = '';
        }
       
        tableHTML += headerRow1 + headerRow2 + `</thead><tbody>`;

        const genelToplamlar = new Map();
        const sortedCariler = Array.from(reportData.values()).sort((a,b) => a.cariAdi.localeCompare(b.cariAdi));

        sortedCariler.forEach(cariData => {
            tableHTML += `<tr><td>${cariData.cariAdi}</td>`;
            sortedYemList.forEach(yemId => {
                const yemSatis = cariData.yemler.get(yemId);
                if (yemSatis) {
                    const ortSatisFiyati = yemSatis.toplamSatis / yemSatis.adet;
                    const alisFiyati = ortalamaMaliyetMap.get(yemId) || 0;
                    const birimKar = ortSatisFiyati - alisFiyati;

                    if (reportType === 'adet') tableHTML += `<td>${yemSatis.adet}</td>`;
                    else if (reportType === 'satis') tableHTML += `<td>${yemSatis.adet}</td><td>${formatCurrency(ortSatisFiyati)}</td><td>${formatCurrency(yemSatis.toplamSatis)}</td>`;
                    else tableHTML += `<td>${yemSatis.adet}</td><td>${formatCurrency(ortSatisFiyati)}</td><td>${formatCurrency(alisFiyati)}</td><td style="color:green;">${formatCurrency(birimKar)}</td><td style="color:green; font-weight:bold;">${formatCurrency(yemSatis.toplamKar)}</td>`;

                    if (!genelToplamlar.has(yemId)) genelToplamlar.set(yemId, { adet: 0, toplamSatis: 0, toplamKar: 0 });
                    const toplam = genelToplamlar.get(yemId);
                    toplam.adet += yemSatis.adet;
                    toplam.toplamSatis += yemSatis.toplamSatis;
                    toplam.toplamKar += yemSatis.toplamKar;
                } else {
                    let colSpan = (reportType === 'adet') ? 1 : (reportType === 'satis' ? 3 : 5);
                    for (let i = 0; i < colSpan; i++) tableHTML += `<td>-</td>`;
                }
            });
            let musteriToplam = cariData.musteriToplamAdet;
            if(reportType === 'satis') musteriToplam = formatCurrency(cariData.musteriToplamSatis);
            if(reportType === 'karlilik') musteriToplam = formatCurrency(cariData.musteriToplamKar);
            tableHTML += `<td style="font-weight:bold;">${musteriToplam}</td></tr>`;
        });
        
        tableHTML += `</tbody><tfoot><tr class="report-totals-row"><td><strong>Genel Toplam</strong></td>`;
        let sonGenelToplam = 0;
        sortedYemList.forEach(yemId => {
            const toplam = genelToplamlar.get(yemId);
            if (toplam) {
                if (reportType === 'adet') { tableHTML += `<td><strong>${toplam.adet}</strong></td>`; sonGenelToplam += toplam.adet; }
                else if (reportType === 'satis') { tableHTML += `<td><strong>${toplam.adet}</strong></td><td></td><td><strong>${formatCurrency(toplam.toplamSatis)}</strong></td>`; sonGenelToplam += toplam.toplamSatis; }
                else { tableHTML += `<td><strong>${toplam.adet}</strong></td><td></td><td></td><td></td><td><strong style="color:green;">${formatCurrency(toplam.toplamKar)}</strong></td>`; sonGenelToplam += toplam.toplamKar; }
            } else {
                let colSpan = (reportType === 'adet') ? 1 : (reportType === 'satis' ? 3 : 5);
                for (let i = 0; i < colSpan; i++) tableHTML += `<td></td>`;
            }
        });
        tableHTML += `<td><strong>${(reportType === 'adet') ? sonGenelToplam : formatCurrency(sonGenelToplam)}</strong></td></tr>`;
        tableHTML += `</tfoot></table>`;

        raporAlani.innerHTML = tableHTML;
        toggleReportButtons('yemRaporu', true);
    } catch (error) {
        console.error("Yem raporu oluşturulurken hata:", error);
        raporAlani.innerHTML = `<p style="color:red; font-weight:bold;">RAPOR OLUŞTURULAMADI!<br>Hata Detayı: ${error.message}</p>`;
    }
}

async function renderTankListesi() {
    const listBody = document.getElementById('tankListesiBody');
    if (!listBody) return;
    listBody.innerHTML = '<tr><td colspan="5">Yükleniyor...</td></tr>';
    
    const snapshot = await db.collection('tanklar').orderBy('ad').get();
    if (snapshot.empty) {
        listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Tanımlı tank bulunmuyor.</td></tr>';
        return;
    }

    let rows = '';
    snapshot.forEach(doc => {
        const tank = doc.data();
        const dolulukOrani = (tank.mevcutLitre / tank.kapasite) * 100;
        rows += `
            <tr>
                <td>${tank.ad}</td>
                <td>${tank.kapasite.toLocaleString('tr-TR')} Lt</td>
                <td>${tank.mevcutLitre.toLocaleString('tr-TR', {maximumFractionDigits: 2})} Lt</td>
                <td>
                    <div class="progress-bar-container" style="height:20px;">
                        <div class="progress-bar" style="width: ${dolulukOrani.toFixed(2)}%; background-color:#3498db; color:white; text-align:center; font-size:11px; line-height:20px;">
                            % ${dolulukOrani.toFixed(1)}
                        </div>
                    </div>
                </td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editTank('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteTank('${doc.id}')">Sil</button>
                </td>
            </tr>
        `;
    });
    listBody.innerHTML = rows;
}

function resetTankForm() {
    document.getElementById('tankForm').reset();
    document.getElementById('tankEditId').value = '';
    document.getElementById('tankFormBaslik').textContent = 'Yeni Tank Tanımla';
    document.getElementById('tankKaydetBtn').textContent = 'Kaydet';
    document.getElementById('tankFormTemizleBtn').style.display = 'none';
}

async function handleTankKaydet(event) {
    event.preventDefault();
    const editId = document.getElementById('tankEditId').value;
    const formData = {
        ad: document.getElementById('tankAdi').value,
        kapasite: parseFloat(document.getElementById('tankKapasite').value) || 0,
    };

    try {
        if (editId) {
            await db.collection('tanklar').doc(editId).update(formData);
        } else {
            formData.mevcutLitre = 0; // Yeni tank boş başlar
            await db.collection('tanklar').add(formData);
        }
        resetTankForm();
        renderTankListesi();
        renderDashboardTanks();
    } catch (error) {
        console.error("Tank kaydedilirken hata:", error);
        alert("Tank kaydedilirken bir hata oluştu.");
    }
}

async function editTank(id) {
    const doc = await db.collection('tanklar').doc(id).get();
    if (!doc.exists) return;
    const tank = doc.data();
    
    document.getElementById('tankEditId').value = id;
    document.getElementById('tankAdi').value = tank.ad;
    document.getElementById('tankKapasite').value = tank.kapasite;

    document.getElementById('tankFormBaslik').textContent = 'Tank Bilgilerini Düzenle';
    document.getElementById('tankKaydetBtn').textContent = 'Güncelle';
    document.getElementById('tankFormTemizleBtn').style.display = 'inline-block';
}

async function deleteTank(id) {
    const doc = await db.collection('tanklar').doc(id).get();
    if(doc.data().mevcutLitre > 0) {
        alert("İçinde süt bulunan bir tankı silemezsiniz. Lütfen önce tankı boşaltın.");
        return;
    }
    if (confirm("Bu tankı silmek istediğinizden emin misiniz?")) {
        await db.collection('tanklar').doc(id).delete();
        renderTankListesi();
        renderDashboardTanks();
    }
}

// --- TANKTAN AKTARIM FONKSİYONLARI ---

async function populateTankSelect(selectElement) {
     if(!selectElement) return;
     selectElement.innerHTML = '<option value="">Yükleniyor...</option>';
     const snapshot = await db.collection('tanklar').orderBy('ad').get();
     if(snapshot.empty) {
         selectElement.innerHTML = '<option value="">Tanımlı tank yok</option>';
         return;
     }
     selectElement.innerHTML = '<option value="">Tank Seçiniz...</option>';
     window.tankDataMap = new Map();
     snapshot.forEach(doc => {
        const tank = doc.data();
        window.tankDataMap.set(doc.id, tank);
        selectElement.innerHTML += `<option value="${doc.id}">${tank.ad}</option>`;
     });
}

async function handleTankAktarim(event) {
    event.preventDefault();
    const form = document.getElementById('tankAktarimForm');
    const editId = document.getElementById('aktarimEditId').value;

    const kaynakTankId = document.getElementById('aktarimKaynakTank').value;
    const hedefCariId = document.getElementById('aktarimHedefCari').value;
    const aktarimMiktar = parseFloat(document.getElementById('aktarimMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('aktarimFiyat').value);
    const tarih = document.getElementById('aktarimTarih').value;

    if (!kaynakTankId || !hedefCariId || !aktarimMiktar || !birimFiyat || !tarih || aktarimMiktar <= 0) {
        alert("Lütfen tüm alanları doğru bir şekilde doldurun.");
        return;
    }

    const tankRef = db.collection('tanklar').doc(kaynakTankId);
    
    // Düzenleme Modu
    if (editId) {
        const aktarimRef = db.collection('sut_alimlari').doc(editId);
        try {
            await db.runTransaction(async (transaction) => {
                const aktarimDoc = await transaction.get(aktarimRef);
                if (!aktarimDoc.exists) throw "Düzenlenecek kayıt bulunamadı.";

                const eskiMiktar = aktarimDoc.data().toplam;
                const miktarFarki = eskiMiktar - aktarimMiktar; 

                const guncelVeri = {
                    tarih: tarih,
                    cariId: hedefCariId,
                    cariAdi: document.getElementById('aktarimHedefCari').options[document.getElementById('aktarimHedefCari').selectedIndex].text,
                    toplam: aktarimMiktar,
                    fiyat: birimFiyat,
                    toplamTutar: aktarimMiktar * birimFiyat,
                    aciklama: `${document.getElementById('aktarimKaynakTank').options[document.getElementById('aktarimKaynakTank').selectedIndex].text} tankından aktarıldı.`
                };

                transaction.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(miktarFarki) });
                transaction.update(aktarimRef, guncelVeri);
            });
            alert("Aktarım başarıyla güncellendi!");
            resetAktarimForm();
            renderAktarimGecmisi();
            renderDashboardTanks();

        } catch (error) {
            console.error("Aktarım güncellenirken hata:", error);
            alert("Güncelleme sırasında bir hata oluştu: " + error);
        }

    } 
    // Yeni Kayıt Modu
    else {
        try {
            await db.runTransaction(async (transaction) => {
                const tankDoc = await transaction.get(tankRef);
                if (!tankDoc.exists) throw "Kaynak tank bulunamadı!";

                const mevcutLitre = tankDoc.data().mevcutLitre;
                if (mevcutLitre < aktarimMiktar) {
                    throw `Yetersiz süt! Tankta sadece ${mevcutLitre.toFixed(2)} Lt süt var.`;
                }

                const sutAlimRef = db.collection('sut_alimlari').doc();
                const hedefCariAdi = document.getElementById('aktarimHedefCari').options[document.getElementById('aktarimHedefCari').selectedIndex].text;
                
                transaction.set(sutAlimRef, {
                    tarih: tarih,
                    cariId: hedefCariId,
                    cariAdi: hedefCariAdi,
                    sabah: 0,
                    aksam: 0,
                    toplam: aktarimMiktar,
                    fiyat: birimFiyat,
                    toplamTutar: aktarimMiktar * birimFiyat,
                    aciklama: `${tankDoc.data().ad} tankından aktarıldı.`,
                    islemKaynagi: 'tank-aktarim',
                    kayitZamani: new Date(), // <-- YENİ EKLENDİ: İşlem anının saati kaydediliyor.
                    sahipId: sahipId
                });

                transaction.update(tankRef, {
                    mevcutLitre: firebase.firestore.FieldValue.increment(-aktarimMiktar)
                });
            });

            alert("Aktarım başarıyla tamamlandı!");
            resetAktarimForm();
            renderDashboardTanks();
            renderAktarimGecmisi();

        } catch (error) {
            console.error("Tank aktarımı sırasında hata:", error);
            alert("Aktarım sırasında bir hata oluştu: " + error);
        }
    }
}


async function renderAktarimGecmisi() {
    const listBody = document.getElementById('aktarimGecmisiBody');
    if (!listBody) return;
    listBody.innerHTML = `<tr><td colspan="7">Yükleniyor...</td></tr>`;

    try {
        const carilerSnapshot = await db.collection('cariler').where('sahipId', '==', sahipId).get();
        const cariMap = new Map();
        carilerSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));

        const snapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('islemKaynagi', '==', 'tank-aktarim')
            .orderBy('tarih', 'desc')
            .limit(20)
            .get();
        
        if (snapshot.empty) {
            listBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">Kayıtlı tank aktarımı bulunmuyor.</td></tr>`;
            return;
        }

        let rows = '';
        snapshot.forEach(doc => {
            const alim = doc.data();
            const kaynakTank = alim.aciklama ? alim.aciklama.split(' ')[0] : 'Bilinmiyor';
            const hedefCariAdi = cariMap.get(alim.cariId) || alim.cariAdi || 'Bilinmeyen Cari';

            // YENİ: Saati alıp formatlıyoruz.
            let saat = '';
            // Firestore'dan gelen tarih objesini kontrol edip saate çeviriyoruz.
            if (alim.kayitZamani && typeof alim.kayitZamani.toDate === 'function') {
                saat = alim.kayitZamani.toDate().toLocaleTimeString('tr-TR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // YENİ: HTML'e saat bilgisi ekleniyor.
            rows += `<tr>
                <td>${formatDate(alim.tarih)} <br> <small style="color: #555;">${saat}</small></td>
                <td>${kaynakTank}</td>
                <td>${hedefCariAdi}</td>
                <td>${alim.toplam.toFixed(2)}</td>
                <td>${formatCurrency(alim.fiyat)}</td>
                <td>${formatCurrency(alim.toplamTutar)}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editAktarim('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteAktarim('${doc.id}', '${kaynakTank}', ${alim.toplam})">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;

    } catch(error) {
        console.error("Aktarım geçmişi yüklenirken hata:", error);
        listBody.innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">Geçmiş yüklenemedi. Veritabanı dizini gerekebilir.</td></tr>`;
    }
}

// YENİ FONKSİYON: Aktarım düzenleme formunu doldurur.
async function editAktarim(id) {
    try {
        const doc = await db.collection('sut_alimlari').doc(id).get();
        if (!doc.exists) {
            alert("Düzenlenecek aktarım kaydı bulunamadı.");
            return;
        }
        const alim = doc.data();

        // Formu doldur
        document.getElementById('aktarimEditId').value = id;
        document.getElementById('aktarimTarih').value = alim.tarih;
        document.getElementById('aktarimHedefCari').value = alim.cariId;
        document.getElementById('aktarimMiktar').value = alim.toplam;
        document.getElementById('aktarimFiyat').value = alim.fiyat;
        
        // Kaynak tankı seçili hale getir (bu kısım biraz dolaylı)
        const kaynakTankAdi = alim.aciklama ? alim.aciklama.split(' ')[0] : '';
        const tankSelect = document.getElementById('aktarimKaynakTank');
        Array.from(tankSelect.options).forEach(option => {
            if (option.text === kaynakTankAdi) {
                option.selected = true;
                tankSelect.dispatchEvent(new Event('change')); // Miktarı güncellemek için
            }
        });
        
        // Butonları düzenleme moduna geçir
        document.getElementById('aktarimKaydetBtn').textContent = 'Güncelle';
        document.getElementById('aktarimFormTemizleBtn').style.display = 'inline-block';
        document.getElementById('tankAktarimForm').scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        console.error("Aktarım düzenleme için getirilirken hata:", error);
        alert("Kayıt getirilirken bir hata oluştu.");
    }
}

// YENİ FONKSİYON: Aktarım formunu sıfırlar ve düzenleme modundan çıkar.
function resetAktarimForm() {
    document.getElementById('tankAktarimForm').reset();
    document.getElementById('aktarimEditId').value = '';
    document.getElementById('kaynakTankMiktar').textContent = '0.00 Lt';
    document.getElementById('aktarimKaydetBtn').textContent = 'Aktarımı Tamamla';
    document.getElementById('aktarimFormTemizleBtn').style.display = 'none';
}



async function deleteAktarim(sutAlimId, tankAdi, miktar) {
    if (!confirm(`${tankAdi} tankından yapılan ${miktar} Lt'lik aktarımı silmek istediğinizden emin misiniz? Bu işlem sütü tanka geri ekleyecektir.`)) {
        return;
    }

    try {
        const tankQuery = await db.collection('tanklar')
            .where('sahipId', '==', sahipId)
            .where('ad', '==', tankAdi)
            .limit(1).get();

        if (tankQuery.empty) {
            throw new Error(`'${tankAdi}' adında bir tank bulunamadı.`);
        }

        const tankRef = tankQuery.docs[0].ref;
        const sutAlimRef = db.collection('sut_alimlari').doc(sutAlimId);
        
        const batch = db.batch();
        // Sütü tanka geri ekle
        batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(miktar) });
        // Aktarım kaydını sil
        batch.delete(sutAlimRef);

        await batch.commit();
        alert("Aktarım kaydı silindi ve süt miktarı tanka iade edildi.");
        renderAktarimGecmisi(); // Listeyi yenile
        renderDashboardTanks(); // Paneli yenile

    } catch (error) {
        console.error("Aktarım silinirken hata:", error);
        alert("Hata: " + error.message);
    }
}

// --- BİTİŞ: YENİ FONKSİYONLAR ---

// --- DASHBOARD TANK GRAFİĞİ FONKSİYONU ---
async function renderDashboardTanks() {
    const container = document.getElementById('dashboardTanklar');
    if (!container) return;

    // Önceki dinleyiciyi durdur
    if (dashboardTankListener) {
        dashboardTankListener();
    }

    const query = db.collection('tanklar').where('sahipId', '==', sahipId).orderBy('ad');

    dashboardTankListener = query.onSnapshot(snapshot => {
        if (snapshot.empty) {
            container.innerHTML = '<p>Tanımlı tank bulunmuyor.</p>';
            return;
        }
        let html = '';
        snapshot.forEach(doc => {
            const tank = doc.data();
            const dolulukOrani = tank.kapasite > 0 ? (tank.mevcutLitre / tank.kapasite) * 100 : 0;
            const barClass = dolulukOrani > 95 ? 'tank-bar full' : 'tank-bar';
            html += `
                <div class="tank-item">
                    <div class="tank-item-header">
                        <span>${tank.ad}</span>
                        <span>${tank.mevcutLitre.toLocaleString('tr-TR', {maximumFractionDigits:1})} / ${tank.kapasite.toLocaleString('tr-TR')} Lt</span>
                    </div>
                    <div class="tank-bar-wrapper">
                        <div class="${barClass}" style="width: ${dolulukOrani.toFixed(2)}%;">
                            %${dolulukOrani.toFixed(1)}
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }, error => {
        console.error("Dashboard tankları dinlenirken hata:", error);
        container.innerHTML = '<p style="color:red;">Tank verileri yüklenemedi.</p>';
    });
}

async function handleHesapOzetiRaporuOlustur() {
    toggleReportButtons('hesapOzeti', false);
    const cariId = document.getElementById('raporCariSecimi').value;
    const ayYil = document.getElementById('raporTarihAraligi').value;
    const raporBaslik = document.getElementById('raporBaslik');
    const raporDetayAlani = document.getElementById('raporDetayAlani');
    const currentUser = auth.currentUser;

    if (!currentUser || !cariId || !ayYil) {
        alert("Lütfen cari ve ay seçimi yapın.");
        return;
    }

    const cariAdi = document.getElementById('raporCariSecimi').options[document.getElementById('raporCariSecimi').selectedIndex].text;
    const [year, month] = ayYil.split('-');
    
    raporBaslik.textContent = `${cariAdi} - ${formatMonthYear(ayYil)} Hesap Özeti`;
    raporDetayAlani.innerHTML = '<p>Rapor oluşturuluyor, lütfen bekleyin...</p>';
    document.getElementById('hesap-ozeti-export-area').innerHTML = '';

    try {
        const intYear = parseInt(year, 10);
        const intMonth = parseInt(month, 10);
        const startDate = `${year}-${month}-01`;
        const ayGunSayisi = new Date(intYear, intMonth, 0).getDate();
        const endDate = `${year}-${month}-${String(ayGunSayisi).padStart(2, '0')}`;
        const devirTarihiObj = new Date(intYear, intMonth - 1, 0);
        const devirYil = devirTarihiObj.getFullYear();
        const devirAy = String(devirTarihiObj.getMonth() + 1).padStart(2, '0');
        const devirGun = String(devirTarihiObj.getDate()).padStart(2, '0');
        const devirTarihiStr = `${devirYil}-${devirAy}-${devirGun}`;
        
        const createQuery = (collection, isDevir) => {
            let q = db.collection(collection).where('sahipId', '==', sahipId).where('cariId', '==', cariId);
            q = isDevir ? q.where('tarih', '<=', devirTarihiStr) : q.where('tarih', '>=', startDate).where('tarih', '<=', endDate);
            return q.get();
        };
        
        const [devirSut, devirYemSatis, devirOdeme, aySut, ayYemSatis, ayOdeme, yemlerSnapshot] = await Promise.all([
            createQuery('sut_alimlari', true), 
            createQuery('yem_satislari', true), 
            createQuery('odemeVeTahsilatlar', true),
            createQuery('sut_alimlari', false), 
            createQuery('yem_satislari', false), 
            createQuery('odemeVeTahsilatlar', false),
            db.collection('yemler').where('sahipId', '==', sahipId).get()
        ]);
        
        const yemMap = new Map(yemlerSnapshot.docs.map(doc => [doc.id, doc.data()]));
        
        let devredenAlacak = 0, devredenBorc = 0;
        devirSut.forEach(doc => devredenAlacak += doc.data().toplamTutar);
        devirYemSatis.forEach(doc => devredenBorc += doc.data().toplamTutar);
        devirOdeme.forEach(doc => { 
            const data = doc.data();
            if (data.islemTuru === 'odeme' || data.islemTuru === 'alacak') devredenAlacak += data.tutar;
            else if (data.islemTuru === 'tahsilat' || data.islemTuru === 'borc') devredenBorc += data.tutar;
        });
        const devredenBakiye = devredenAlacak - devredenBorc;

        let toplamSutDegeri = 0, sutDetayHTML = '', toplamSabah = 0, toplamAksam = 0, toplamLitre = 0;
        if (!aySut.empty) {
            aySut.forEach(doc => {
                const alim = doc.data();
                toplamSabah += alim.sabah || 0;
                toplamAksam += alim.aksam || 0;
                toplamLitre += alim.toplam || 0;
                toplamSutDegeri += alim.toplamTutar || 0;
            });
            const ortalamaFiyat = toplamLitre > 0 ? (toplamSutDegeri / toplamLitre) : 0;
            sutDetayHTML = `<table class="summary-table"><thead><tr><th>Toplam Akşam</th><th>Toplam Sabah</th><th>Toplam Litre</th><th>Ort. Fiyat</th><th>Toplam Tutar</th></tr></thead><tbody><tr><td>${toplamAksam.toFixed(2)} Lt</td><td>${toplamSabah.toFixed(2)} Lt</td><td>${toplamLitre.toFixed(2)} Lt</td><td>${formatCurrency(ortalamaFiyat)}</td><td>${formatCurrency(toplamSutDegeri)}</td></tr></tbody></table>`;
        }

        // GÜNCELLEME 1: Yem satışları için toplam miktar ve tutar hesaplaması
        let toplamYemSatisTutari = 0, toplamYemSatisMiktari = 0, yemSatisDetayHTML = '';
        const yemSatisOzet = {};
        if (!ayYemSatis.empty) {
            ayYemSatis.forEach(doc => {
                const satis = doc.data();
                toplamYemSatisTutari += satis.toplamTutar;
                toplamYemSatisMiktari += satis.miktar; // Toplam miktar burada toplanıyor
                const yemAdi = yemMap.get(satis.yemId)?.ad || 'Bilinmeyen Yem';
                if (!yemSatisOzet[yemAdi]) {
                    yemSatisOzet[yemAdi] = { miktar: 0, tutar: 0 };
                }
                yemSatisOzet[yemAdi].miktar += satis.miktar;
                yemSatisOzet[yemAdi].tutar += satis.toplamTutar;
            });
            yemSatisDetayHTML = '<table class="summary-table"><thead><tr><th>Yem Adı</th><th>Miktar</th><th>Ort. Birim Fiyat</th><th>Tutar</th></tr></thead><tbody>';
            for (const yemAdi in yemSatisOzet) {
                const ozet = yemSatisOzet[yemAdi];
                const ortalamaBirimFiyat = ozet.miktar > 0 ? (ozet.tutar / ozet.miktar) : 0;
                yemSatisDetayHTML += `<tr><td>${yemAdi}</td><td>${ozet.miktar}</td><td>${formatCurrency(ortalamaBirimFiyat)}</td><td>${formatCurrency(ozet.tutar)}</td></tr>`;
            }
            // Tabloya alt toplam (footer) ekleniyor
            const genelOrtYemFiyati = toplamYemSatisMiktari > 0 ? (toplamYemSatisTutari / toplamYemSatisMiktari) : 0;
            yemSatisDetayHTML += `</tbody><tfoot><tr class="report-totals-row"><td><strong>TOPLAM</strong></td><td><strong>${toplamYemSatisMiktari}</strong></td><td><strong>${formatCurrency(genelOrtYemFiyati)}</strong></td><td><strong>${formatCurrency(toplamYemSatisTutari)}</strong></td></tr></tfoot></table>`;
        }

        let toplamOdemeTutari = 0, odemeDetayHTML = '';
        let toplamTahsilatTutari = 0, tahsilatDetayHTML = '';
        const odemeDetaylari = [], tahsilatDetaylari = [];
        if(!ayOdeme.empty) {
            ayOdeme.docs.sort((a,b) => a.data().tarih.localeCompare(b.data().tarih)).forEach(doc => {
                const islem = doc.data();
                if (islem.islemTuru === 'odeme') {
                    toplamOdemeTutari += islem.tutar;
                    odemeDetaylari.push(islem);
                } else if (islem.islemTuru === 'tahsilat') {
                    toplamTahsilatTutari += islem.tutar;
                    tahsilatDetaylari.push(islem);
                }
            });
            
            if(odemeDetaylari.length > 0) {
                odemeDetayHTML = '<table class="summary-table"><thead><tr><th>Tarih</th><th>Ödeme Türü</th><th>Açıklama</th><th>Tutar</th></tr></thead><tbody>';
                odemeDetaylari.forEach(islem => {
                    odemeDetayHTML += `<tr><td>${formatDate(islem.tarih)}</td><td>${islem.odemeTuru || '-'}</td><td>${islem.aciklama}</td><td>${formatCurrency(islem.tutar)}</td></tr>`;
                });
                // Ödeme (yeni adıyla Tahsilat) tablosuna alt toplam (footer) ekleniyor
                odemeDetayHTML += `</tbody><tfoot><tr class="report-totals-row"><td colspan="3"><strong>TOPLAM</strong></td><td><strong>${formatCurrency(toplamOdemeTutari)}</strong></td></tr></tfoot></table>`;
            }
            
            if(tahsilatDetaylari.length > 0) {
                tahsilatDetayHTML = '<table class="summary-table"><thead><tr><th>Tarih</th><th>Ödeme Türü</th><th>Açıklama</th><th>Tutar</th></tr></thead><tbody>';
                tahsilatDetaylari.forEach(islem => {
                    tahsilatDetayHTML += `<tr><td>${formatDate(islem.tarih)}</td><td>${islem.odemeTuru || '-'}</td><td>${islem.aciklama}</td><td>${formatCurrency(islem.tutar)}</td></tr>`;
                });
                // Tahsilat (yeni adıyla Ödeme) tablosuna alt toplam (footer) ekleniyor
                tahsilatDetayHTML += `</tbody><tfoot><tr class="report-totals-row"><td colspan="3"><strong>TOPLAM</strong></td><td><strong>${formatCurrency(toplamTahsilatTutari)}</strong></td></tr></tfoot></table>`;
            }
        }

        // GÜNCELLEME 2: Ara toplamlar için hesaplamalar
        const araToplamAlacak = toplamSutDegeri + toplamOdemeTutari;
        const araToplamBorc = toplamYemSatisTutari + toplamTahsilatTutari;

        const cariAyBakiye = araToplamAlacak - araToplamBorc;
        const donemSonuBakiye = devredenBakiye + cariAyBakiye;

        let reportHTML = `
            <div class="report-block"><h5>Önceki Dönemden Devir</h5><p class="block-total"><strong>${formatCurrency(devredenBakiye)} (${devredenBakiye >= 0 ? 'Cari Alacaklı' : 'Cari Borçlu'})</strong></p></div>
            <div class="report-block"><h5>Cari Ay Süt Alımları</h5>${sutDetayHTML || '<p>Bu ay süt alımı yok.</p>'}</div>
            <div class="report-block"><h5>Cari Ay Yem Satışları</h5>${yemSatisDetayHTML || '<p>Bu ay yem satışı yok.</p>'}</div>
            <div class="report-block"><h5>Cari Ay Yapılan Tahsilatlar</h5>${odemeDetayHTML || '<p>Bu ay tahsilat yapılmamış.</p>'}</div>
            <div class="report-block"><h5>Cari Ay Yapılan Ödemeler</h5>${tahsilatDetayHTML || '<p>Bu ay ödeme yapılmamış.</p>'}</div>
            
            <div class="report-block final-summary">
                <h5>DÖNEM SONU HESAPLAMASI</h5>
                <p><span>Önceki Aydan Devir:</span> <span>${formatCurrency(devredenBakiye)}</span></p>
                <hr style="border-style: dashed; margin: 10px 0;">
                
                <p><span>+ Cari Ay Süt Alımları:</span> <span style="color:green;">+ ${formatCurrency(toplamSutDegeri)}</span></p>
                <p><span>+ Cari Ay Yapılan Tahsilatlar:</span> <span style="color:green;">+ ${formatCurrency(toplamOdemeTutari)}</span></p>
                <p style="border-top: 1px solid #ccc; padding-top: 5px; margin-top:5px;"><strong>Ara Toplam (Alacak):</strong> <strong style="color:green;">${formatCurrency(araToplamAlacak)}</strong></p>
                
                <p style="margin-top: 15px;"><span>- Cari Ay Yem Satışları:</span> <span style="color:red;">- ${formatCurrency(toplamYemSatisTutari)}</span></p>
                <p><span>- Cari Ay Yapılan Ödemeler:</span> <span style="color:red;">- ${formatCurrency(toplamTahsilatTutari)}</span></p>
                <p style="border-top: 1px solid #ccc; padding-top: 5px; margin-top:5px;"><strong>Ara Toplam (Borç):</strong> <strong style="color:red;">- ${formatCurrency(araToplamBorc)}</strong></p>
                
                <hr>
                <p><strong>CARİ AY BAKİYESİ:</strong> <strong>${formatCurrency(cariAyBakiye)}</strong></p>
                <p><strong>DÖNEM SONU NET BAKİYE:</strong> <strong>${formatCurrency(donemSonuBakiye)} (${donemSonuBakiye >= 0 ? 'Cari Alacaklı' : 'Cari Borçlu'})</strong></p>
            </div>
        `;
        raporDetayAlani.innerHTML = reportHTML;
        
        // ... (Excel export alanı da benzer şekilde güncellenmeli)
        document.getElementById('hesap-ozeti-export-area').innerHTML = ''; // Excel export şimdilik devre dışı bırakıldı.

        toggleReportButtons('hesapOzeti', true);

    } catch (error) {
        console.error("Hesap özeti raporu oluşturulurken hata:", error);
        raporDetayAlani.innerHTML = `<p style="color:red; font-weight:bold;">RAPOR OLUŞTURULAMADI!<br>Hata Detayı: ${error.message}.</p>`;
    }
}

function toggleReportButtons(reportPrefix, show) {
    const displayStyle = show ? 'inline-block' : 'none';
    const pdfBtn = document.getElementById(`${reportPrefix}PdfBtn`);
    const xlsxBtn = document.getElementById(`${reportPrefix}XlsxBtn`);
    const printBtn = document.getElementById(`${reportPrefix}YazdirBtn`); // Yazdır butonunu da dahil edelim

    if (pdfBtn) pdfBtn.style.display = displayStyle;
    if (xlsxBtn) xlsxBtn.style.display = displayStyle;
    if (printBtn) printBtn.style.display = displayStyle;
}



function handleCariListeYazdir() {
    handleYazdir('cari-yonetimi');
}


function handleYazdir(sectionId) {
    const sectionToPrint = document.getElementById(sectionId);
    if (!sectionToPrint) return;

    // --- YENİ: Dinamik Stil Oluşturma ---
    // Hangi raporun yazdırıldığına bakarak sayfa yönünü belirle
    let pageOrientation = 'portrait'; // Varsayılan dikey
    if (sectionId === 'dinamik-sut-raporu') {
        pageOrientation = 'landscape'; // Sadece karne için yatay
    }

    // Yazdırmaya özel stil etiketini oluştur
    const printStyle = `
        @page {
            size: A4 ${pageOrientation};
            margin: 1.2cm;
        }
    `;
    
    const styleEl = document.createElement('style');
    styleEl.id = 'print-style-override'; // Sonradan silebilmek için ID ver
    styleEl.innerHTML = printStyle;
    document.head.appendChild(styleEl);
    // --- BİTİŞ ---

    const bodyElement = document.body;
    bodyElement.classList.add('print-active');
    sectionToPrint.classList.add('print-section-active');
    
    // Tarayıcının yazdırma penceresini aç
    window.print();
}




window.onafterprint = () => {
    const bodyElement = document.body;
    bodyElement.classList.remove('print-active');
    document.querySelectorAll('.print-section-active').forEach(el => {
        el.classList.remove('print-section-active');
    });

    // --- YENİ: Yazdırma işlemi bitince eklediğimiz özel stili kaldır ---
    const overrideStyle = document.getElementById('print-style-override');
    if (overrideStyle) {
        overrideStyle.remove();
    }
    // --- BİTİŞ ---
};

</script>
<script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>

</script>
</body>
</html>
