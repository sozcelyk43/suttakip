
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ¼t Takip ProgramÄ± - Tam SÃ¼rÃ¼m</title>
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="/suttakip/manifest.json">
    <link rel="icon" href="https://raw.githubusercontent.com/sozcelyk43/suttakip/refs/heads/main/favicon.ico" type="image/x-icon" />
</head>
<body>
<div class="sidebar">
        <img src="logo.png" alt="Uygulama Logosu" class="sidebar-logo">
        <nav id="sidebarNav">
            <ul>
		<li class="quick-entry-link"><a href="hizli-giris.html" target="_blank">âš¡ HÄ±zlÄ± SÃ¼t GiriÅŸi</a></li>
		<li class="special-module-link"><a href="mustahsil.html">ğŸ’¼ Mali MÃ¼ÅŸavir</a></li>
                <li><a href="#dashboard" class="nav-link">ğŸ“ Kontrol Paneli</a></li>
                <li><a href="#cari-yonetimi" class="nav-link">ğŸ‘¥ Cari YÃ¶netimi</a></li>
                <li><a href="#sut-alimi" class="nav-link">ğŸ¥› GÃ¼nlÃ¼k SÃ¼t AlÄ±mÄ±</a></li>
                <li><a href="#yem-stok-yonetimi" class="nav-link">ğŸ“¦ Stok YÃ¶netimi</a></li>
                <li><a href="#yem-satisi" class="nav-link">ğŸŒ¾ Yem SatÄ±ÅŸÄ±</a></li>
                <li><a href="#tahsilat-ve-odemeler" class="nav-link">ğŸ’³ Tahsilat ve Ã–demeler</a></li>
                <li><a href="#hesap-ozeti" class="nav-link">ğŸ“Š Cari Hesap Ã–zeti</a></li>
                <li><a href="#sut-alim-raporu" class="nav-link">ğŸ—“ï¸ AylÄ±k SÃ¼t Raporu</a></li>
                <li><a href="#dinamik-sut-raporu" class="nav-link">ğŸ“‹ Dinamik SÃ¼t Karnesi</a></li>
                <li><a href="#aylik-yem-raporu" class="nav-link">ğŸ“ˆ AylÄ±k Yem Raporu</a></li>
                <li><a href="#hareket-dokumu" class="nav-link">ğŸ“‹ Hareket DÃ¶kÃ¼mÃ¼</a></li>
                <li><a href="#ayarlar" class="nav-link">âš™ï¸ Ayarlar</a></li>
		<li class="dont-calisan">
    <div class="module-switcher" style="margin: 15px 10px;">
        <label for="moduleSwitchSelect">Panel DeÄŸiÅŸtir</label>
        <select id="moduleSwitchSelect" style="width: 100%;">
            <option value="index.html" selected>ğŸ“’ Hesap Defteri</option>
            <option value="mustahsil.html">ğŸ’¼ Mali MÃ¼ÅŸavir Paneli</option>
        </select>
    </div>
</li>
               <li class="logout-link"><a href="#" id="logoutButton"><div>ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</div><div id="logoutUserEmail"></div> </a></li>
            </ul>
        </nav>
</div>

<div class="main-content"><button id="menuToggleBtn" class="menu-toggle-btn dont-print">â˜°</button>
<section id="dashboard" class="module-section">
            <div class="module-header"><h2>ğŸ“ Kontrol Paneli</h2></div>
            <div class="container">
                <h3>Genel Durum</h3>

                <div class="dashboard-grid">
                    <div class="stat-card"><h4>â˜€ï¸ BugÃ¼nkÃ¼ Sabah SÃ¼tÃ¼</h4><p><span id="dashSabahSut">0.00</span> Lt</p><small id="sabahSutTarih" style="font-weight: bold;"></small></div>
                    <div class="stat-card"><h4>ğŸŒ™ BugÃ¼nkÃ¼ AkÅŸam SÃ¼tÃ¼</h4><p><span id="dashAksamSut">0.00</span> Lt</p><small id="aksamSutTarih" style="font-weight: bold;"></small></div>
                    <div class="stat-card"><h4>ğŸ“ˆ BugÃ¼nkÃ¼ Toplam SÃ¼t</h4><p><span id="dashToplamSut">0.00</span> Lt</p>
				<small id="toplamSutTarihAraligi" style="display: block; font-weight: bold;"></small><small id="dunKarsilastirma">(DÃ¼ne gÃ¶re...)</small></div>
                    <div class="stat-card"><h4>ğŸ‘¥ Aktif MÃ¼ÅŸteri SayÄ±sÄ±</h4><p><span id="dashAktifMusteri">0</span></p></div>
	            <div class="stat-card" id="bakiyeDurumKarti"><h4>ğŸ’° Toplam Bakiye</h4><p><span id="dashToplamBakiye">0,00</span></p>
				<small id="bakiyeDurumUyarisi" style="font-weight: bold;"></small></div>
                   <div class="stat-card" style="border-left: 5px solid #3498db; grid-column: span 1;"><h4>Bu Ayki SÃ¼t Ãœretimi</h4><p style="font-size: 2.2em; color: #2980b9;">
				<span id="dashBuAykiToplamSut">0</span> Lt</p><small>(<span id="aylikGunOrtalamasi">0</span> Lt/GÃ¼n Ort.)</small></div>
                   <div class="stat-card" style="border-left: 5px solid #1abc9c; grid-column: span 1;"><h4>Ãœretimin Parasal DeÄŸeri</h4><p style="font-size: 2.2em; color: #16a085;">
				<span id="dashBuAykiSutDegeri">0,00</span></p><small>(Potansiyel Gelir)</small></div>
                   <div class="stat-card" style="border-left: 5px solid #f39c12;"><h4>ğŸ“¦ TanÄ±mlÄ± Yem SayÄ±sÄ±</h4><p style="font-size: 2.2em; color: #d35400;">
				<span id="dashYemSayisi">0</span></p><small>(Toplam Ã‡eÅŸit)</small></div>                </div>

                <div class="balance-bars">
                    <div class="balance-bar-item">
                        <div class="balance-bar-header">
                            <span>Toplam Alacak (MÃ¼ÅŸteri Borcu)</span>
                            <strong id="dashToplamAlacak">0,00 â‚º</strong>
                        </div>
                        <div class="progress-bar-container"><div id="alacakBar" class="progress-bar alacak" style="width: 0%;"></div></div>
                    </div>
                    
		<div class="balance-bar-item">
                        <div class="balance-bar-header">
                            <span>Toplam BorÃ§ (MÃ¼ÅŸteri AlacaÄŸÄ±)</span>
                            <strong id="dashToplamBorc">0,00 â‚º</strong>
                        </div>
                        <div class="progress-bar-container"><div id="borcBar" class="progress-bar borc" style="width: 0%;"></div></div>
                    </div>
                </div>

                <div class="charts-container-vertical">
                <div class="chart-card"><h3>BugÃ¼nkÃ¼ SÃ¼t AlÄ±m DaÄŸÄ±lÄ±mÄ± (Kategori BazlÄ±)</h3><div class="chart-wrapper"><canvas id="gunlukSutGrafik"></canvas></div></div>
                <div class="chart-card"><h3>AylÄ±k SÃ¼t DaÄŸÄ±lÄ±mÄ± (Kategori BazlÄ±)</h3><div class="chart-filters"><input type="month" id="aylikChartAySecimi"><button id="aylikChartGosterBtn" class="btn btn-sm">GrafiÄŸi GÃ¶ster</button></div><div class="chart-wrapper"><canvas id="aylikSutGrafik"></canvas></div></div>
            </div>
        </div>
    </section> 

			
<section id="cari-yonetimi" class="module-section hidden-section">
    <div class="module-header">
        <h2>ğŸ‘¥ Cari YÃ¶netimi</h2>
    </div>
    <div class="container">
        <div class="form-section">
            <h3><span id="cariFormBaslik">Yeni Cari Kart</span></h3>
            <form id="cariForm" action="#">
    <input type="hidden" id="cariEditId">
    
    <div class="form-layout-columns">
        <div class="form-column">
            <fieldset>
                <legend>Temel Cari Bilgileri</legend>
                <div class="form-grid">
                    <div class="form-group"><label for="cariKodu">Cari Kodu:</label><input type="text" id="cariKodu" placeholder="Ã–rn: C001"></div>
                    <div class="form-group"><label for="cariAdiSoyadi">AdÄ± SoyadÄ± / Firma AdÄ±:</label><input type="text" id="cariAdiSoyadi"></div>
                    <div class="form-group"><label for="cariKategori">Kategori/KÃ¶y:</label><select id="cariKategori"><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="cariRotaSirasi">Rota SÄ±rasÄ±:</label><input type="number" id="cariRotaSirasi" placeholder="SÄ±ralama iÃ§in sayÄ±"></div>
                    <div class="form-group"><label for="cariDurum">Durum:</label><select id="cariDurum"><option value="aktif">Aktif</option><option value="pasif">Pasif</option></select></div>
                    <div class="form-group"><label for="cariTipi">Cari Tipi:</label><select id="cariTipi"><option value="sut_ve_yem">SÃ¼t ve Yem</option><option value="sadece_sut">Sadece SÃ¼t</option><option value="sadece_yem">Sadece Yem</option></select></div>
                    <div class="form-group" style="grid-column: span 2;"><label>Cari Grubu:</label><div class="checkbox-group" style="padding-top:10px;"><label for="grupUretici"><input type="checkbox" id="grupUretici" value="Ã¼retici"> Ãœretici</label><label for="grupTedarikci"><input type="checkbox" id="grupTedarikci" value="tedarikÃ§i"> TedarikÃ§i</label><label for="grupSutAlici"><input type="checkbox" id="grupSutAlici" value="sÃ¼t alÄ±cÄ±"> SÃ¼t AlÄ±cÄ±</label></div></div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Ä°letiÅŸim Bilgileri</legend>
                <div class="form-grid">
                    <div class="form-group"><label for="cariTelefon">Telefon:</label><input type="tel" id="cariTelefon"></div>
                    <div class="form-group"><label for="cariEposta">E-posta:</label><input type="email" id="cariEposta"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="cariAdres">Adres:</label><textarea id="cariAdres" rows="3"></textarea></div>
                </div>
            </fieldset>
        </div>

        <div class="form-column">
            <fieldset>
                <legend>Finansal Bilgiler</legend>
                <div class="form-grid">
                    <div class="form-group"><label for="cariAcilisBakiye">AÃ§Ä±lÄ±ÅŸ Bakiyesi:</label><input type="number" id="cariAcilisBakiye" placeholder="Ã–rn: 500" step="0.01"></div>
                    <div class="form-group"><label for="cariAcilisBakiyeTuru">Bakiye TÃ¼rÃ¼:</label><select id="cariAcilisBakiyeTuru"><option value="yok">Yok</option><option value="borc">Cari BorÃ§lu</option><option value="alacak">Cari AlacaklÄ±</option></select></div>
                    <div class="form-group"><label for="cariBankaAdi">Banka AdÄ±:</label><input type="text" id="cariBankaAdi"></div>
                    <div class="form-group"><label for="cariIban">IBAN:</label><input type="text" id="cariIban"></div>
                    <div class="form-group"><label for="cariVergiDairesi">Vergi Dairesi:</label><input type="text" id="cariVergiDairesi"></div>
                    <div class="form-group"><label for="cariVergiNo">Vergi No / T.C.:</label><input type="text" id="cariVergiNo"></div>
                </div>
            </fieldset>

            <fieldset>
                <legend>e-MÃ¼stahsil Parametreleri</legend>
                <div class="form-grid">
                    <div class="form-group"><label for="paramStopajOrani">Stopaj OranÄ± (%)</label><input type="number" id="paramStopajOrani" value="4" step="0.1" class="form-control"></div>
                    <div class="form-group"><label for="paramBorsaTescilOrani">Borsa Tescil OranÄ± (%)</label><input type="number" id="paramBorsaTescilOrani" placeholder="Ã–rn: 0.1" step="0.01" class="form-control"></div>
                    <div class="form-group" style="grid-column: span 2;"><div class="checkbox-group" style="padding-top: 15px;"><label for="paramBorsaTescili"><input type="checkbox" id="paramBorsaTescili"> Ãœreticinin Borsa Tescili Var</label><label for="paramSgkKesintisi"><input type="checkbox" id="paramSgkKesintisi" checked> SGK Kesintisi Uygula (%2)</label></div></div>
                </div>
            </fieldset>

             <fieldset>
                <legend>Notlar</legend>
                <div class="form-group">
                    <label for="cariNotlar" style="display:none;">Ã–zel Notlar</label>
                    <textarea id="cariNotlar" rows="3" placeholder="Bu cari ile ilgili Ã¶zel notlarÄ±nÄ±zÄ± buraya ekleyebilirsiniz..."></textarea>
                </div>
            </fieldset>
        </div>
    </div>

    <div class="form-buttons-container">
        <button type="submit" class="btn btn-primary" id="cariKaydetBtn">Kaydet</button>
        <button type="button" class="btn" id="cariFormTemizleBtn" style="display:none;">Yeni KayÄ±t Formu</button>
    </div>
</form>
        </div>

        <div id="cari-list-printable-area" class="printable-content format-a4">
            <h1 class="print-only print-title" style="text-align: center; display: none;">Cari Listesi</h1>
            <div class="list-section">
                <div class="dont-print" style="padding: 15px; border: 1px solid #ddd; margin-bottom: 20px; border-radius: 8px; background-color: #f9f9f9;">
                    <label for="cariTarihFiltresi" style="font-weight: bold; display: block; margin-bottom: 8px;">Tarihsel Bakiye Raporu:</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="date" id="cariTarihFiltresi" style="flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 38px;">
                        <button type="button" class="btn btn-primary" id="cariTarihselRaporBtn" style="height: 38px; padding: 0 20px;">Raporla</button>
                    </div>
                    <small style="display: block; margin-top: 8px; color: #666; font-size: 12px;">Belirli bir tarih itibarÄ±yla bakiye durumunu gÃ¶rmek iÃ§in bir tarih seÃ§ip 'Raporla' butonuna basÄ±n. BoÅŸ bÄ±rakÄ±rsanÄ±z gÃ¼ncel durumu gÃ¶sterir.</small>
                </div>
                <div id="cariRotaSirasiUyari" style="display: none;"></div>
                <h3>Cari Listesi (<span id="raporTarihEtiketi">GÃ¼ncel Durum</span>)</h3>
                <div class="form-grid dont-print" style="grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; align-items: end; margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 8px;">
                    <div class="form-group"><label for="cariSearchInput">Cari Ara:</label><input type="text" id="cariSearchInput" class="form-control" placeholder="Aramak iÃ§in cari adÄ± veya kodu yazÄ±n..." autocomplete="off"></div>
                    <div class="form-group"><label for="cariKategoriFiltre">Kategori:</label><select id="cariKategoriFiltre"><option value="">TÃ¼m Kategoriler</option></select></div>
                    <div class="form-group"><label for="cariGrupFiltre">Grup:</label><select id="cariGrupFiltre"><option value="">TÃ¼m Gruplar</option><option value="Ã¼retici">Ãœretici</option><option value="tedarikÃ§i">TedarikÃ§i</option><option value="sÃ¼t alÄ±cÄ±">SÃ¼t AlÄ±cÄ±</option></select></div>
                    <div class="form-group"><label for="cariDurumFiltre">Durum:</label><select id="cariDurumFiltre"><option value="">TÃ¼m Durumlar</option><option value="aktif">Aktif</option><option value="pasif">Pasif</option></select></div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Kod</th>
                            <th>Ad/Firma</th>
                            <th>Kategori</th>
                            <th>Cari Grubu</th>
                            <th>Rota SÄ±rasÄ±</th>
                            <th>Durum</th>
                            <th>Telefon</th>
                            <th>BorÃ§</th>
                            <th>Alacak</th>
                            <th>Bakiye</th>
                            <th class="dont-print">Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="cariListesiBody"></tbody>
                    <tfoot id="cariListesiFooter"></tfoot>
                </table>
            </div>
        </div>
        <button type="button" class="btn btn-secondary dont-print" id="cariListesiYazdirBtn" style="margin-top: 20px;">Listeyi YazdÄ±r</button>
    </div>
</section>

        <section id="sut-alimi" class="module-section hidden-section">
    <div class="module-header"><h2>ğŸ¥› GÃ¼nlÃ¼k SÃ¼t AlÄ±mÄ±</h2></div>
    <div class="container">
        <div class="form-section">
            <h3>GiriÅŸ Filtreleri</h3>
          <div class="form-grid" id="sutGirisFiltreler" style="grid-template-columns: 1fr 1fr;">
    <div class="form-group">
        <label for="topluGirisTarih">GiriÅŸ Tarihi:</label>
        <input type="date" id="topluGirisTarih" required>
    </div>
    <div class="form-group">
        <label for="topluGirisKategori">Kategori/KÃ¶y SeÃ§in:</label>
        <select id="topluGirisKategori" required><option value="">TÃ¼m Kategoriler</option></select>
    </div>
</div>
        </div>
        <div class="list-section">
            <h3>GÃ¼nlÃ¼k SÃ¼t GiriÅŸi</h3>
            <div id="topluSutGirisTablosuAlani"></div>
            <p id="topluGirisTedarikciYokMesaji" style="text-align:center; display:none;">Bu kriterlere uygun, sÃ¼t giriÅŸi bekleyen cari bulunmuyor.</p>
        </div>
        <hr style="margin: 40px 0;">
        <div id="sutDuzenleFormAlani" style="display:none; margin-bottom: 20px;">
            <h4>SÃ¼t AlÄ±mÄ±nÄ± DÃ¼zenle</h4>
            <form id="sutDuzenleForm" class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto auto;">
                <input type="hidden" id="sutDuzenleId">
                <div class="form-group"><label>AkÅŸam (Lt)</label><input type="number" id="sutDuzenleAksam" class="sut-input" step="0.1" min="0"></div>
                <div class="form-group"><label>Sabah (Lt)</label><input type="number" id="sutDuzenleSabah" class="sut-input" step="0.1" min="0"></div>
                <div class="form-group"><label>Fiyat</label><input type="number" id="sutDuzenleFiyat" class="sut-input" step="0.01" min="0"></div>
                <button type="submit" class="btn btn-primary" style="height: 45px; align-self: end;">GÃ¼ncelle</button>
                <button type="button" class="btn" style="height: 45px; align-self: end;" onclick="closeSutDuzenleForm()">Ä°ptal</button>
            </form>
                </div>
        <div class="list-section">
            <h3>SÃ¼t AlÄ±m GeÃ§miÅŸi (SeÃ§ili Tarih: <span id="gecmisTarihSpan"></span>)</h3>
            <table>
                <thead id="sutAlimGecmisiHeader"></thead>
                <tbody id="sutAlimGecmisiBody"></tbody>
                <tfoot id="sutAlimGecmisiFooter"></tfoot>
            </table>
        </div>
    </div>
</section>
        
        <section id="yem-stok-yonetimi" class="module-section hidden-section">
    <div class="module-header"><h2>ğŸ“¦ Stok YÃ¶netimi</h2></div>
    <div class="container">
       <div class="form-section"><h3><span id="yemTanimFormBaslik">Yeni Yem TanÄ±mla</span></h3><form id="yemTanimForm" action="#"><input type="hidden" id="yemTanimEditId"><div class="form-grid">
           <div class="form-group"><label for="yemKodu">Kod:</label><input type="text" id="yemKodu" required></div>
           <div class="form-group"><label for="yemAdi">Ad:</label><input type="text" id="yemAdi" required></div>
           <div class="form-group"><label for="yemKategorisi">Kategori:</label><select id="yemKategorisi"><option value="buyukbas">BÃ¼yÃ¼kbaÅŸ</option><option value="kucukbas">KÃ¼Ã§Ã¼kbaÅŸ</option></select></div>
           <div class="form-group"><label for="yemBirimi">Birim:</label><input type="text" id="yemBirimi" value="Ã‡uval"></div>
          
           <div class="form-group"><label for="yemSatisFiyati">SatÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemSatisFiyati" step="0.01"></div>
       </div><button type="submit" class="btn btn-primary" id="yemTanimKaydetBtn">Kaydet</button><button type="button" class="btn" id="yemTanimFormTemizleBtn" style="display:none;">Yeni</button></form></div>
       <div class="list-section"><h3>TanÄ±mlÄ± Yemler & Stok</h3><table><thead><tr><th>Kod</th><th>Ad</th><th>Kategori</th><th>Birim</th><th>AlÄ±ÅŸ F.</th><th>SatÄ±ÅŸ F.</th><th>Stok</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="yemStokListesiBody"></tbody></table></div>
       <hr>
       <div class="form-section"><h3><span id="yemAlisFormBaslik">Yeni Yem AlÄ±ÅŸÄ±</span></h3><form id="yemAlisForm" action="#"><input type="hidden" id="yemAlisEditId"><div class="form-grid">
           <div class="form-group"><label for="yemAlisTarih">Tarih:</label><input type="date" id="yemAlisTarih" required></div>
           <div class="form-group"><label for="yemSecimiAlis">Yem:</label><select id="yemSecimiAlis" required><option value="">SeÃ§iniz...</option></select></div>
           <div class="form-group"><label for="yemAlisMiktar">Miktar:</label><input type="number" id="yemAlisMiktar" step="1" required></div>
           <div class="form-group"><label for="yemAlisTedarikci">Cari:</label><select id="yemAlisTedarikci"><option value="">SeÃ§iniz...</option></select></div>
           <div class="form-group"><label for="yemAlisBirimFiyati">AlÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemAlisBirimFiyati" step="0.01" required></div>
           <div class="form-group"><label for="yemAlisToplamTutar">Toplam Tutar:</label><input type="text" id="yemAlisToplamTutar" readonly></div>
       </div><button type="submit" class="btn btn-primary" id="yemAlisKaydetBtn">AlÄ±ÅŸÄ± Kaydet</button><button type="button" class="btn" id="yemAlisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
       <div class="list-section"><h3>Yem AlÄ±ÅŸ Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Yem</th><th>Miktar</th><th>Cari</th><th>AlÄ±ÅŸ F.</th><th>Tutar</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="yemAlisHareketListesiBody"></tbody></table></div>
        
        <hr style="margin: 40px 0;">

        <div class="form-section">
            <h3>Stok SayÄ±m GiriÅŸi</h3>
            <p>Fiziksel olarak saydÄ±ÄŸÄ±nÄ±z yem miktarÄ±nÄ± girerek sistemdeki stoÄŸu gÃ¼ncelleyin.</p>
            <form id="stokSayimForm" action="#">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label for="sayimTarihi">SayÄ±m Tarihi:</label>
                        <input type="date" id="sayimTarihi" required>
                    </div>
                    <div class="form-group">
                        <label for="sayimYemSecimi">SayÄ±mÄ± YapÄ±lan Yem:</label>
                        <select id="sayimYemSecimi" required>
                            <option value="">Yem SeÃ§iniz...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sayimMevcutStok">Sistemdeki Stok:</label>
                        <input type="number" id="sayimMevcutStok" readonly style="background-color: #e9ecef;">
                    </div>
                    <div class="form-group">
                        <label for="sayimFizikselStok">SayÄ±lan Miktar (Fiziksel):</label>
                        <input type="number" id="sayimFizikselStok" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="sayimFarki">Fark:</label>
                        <input type="text" id="sayimFarki" readonly style="background-color: #e9ecef; font-weight: bold;">
                    </div>
                    <div class="form-group" style="grid-column: span 3;">
                        <label for="sayimNotu">AÃ§Ä±klama / Not:</label>
                        <textarea id="sayimNotu" rows="2" placeholder="Ã–rn: Fire, hatalÄ± giriÅŸ dÃ¼zeltmesi..."></textarea>
                    </div>
                </div>
                <button type="submit" class="btn btn-warning" id="stokSayimKaydetBtn">SayÄ±mÄ± Kaydet ve StoÄŸu GÃ¼ncelle</button>
            </form>
        </div>
    
        <div class="list-section" style="margin-top: 20px;">
            <h3>Stok SayÄ±m Hareketleri</h3>
<table>
    <thead>
        <tr>
            <th>Tarih</th>
            <th>Yem AdÄ±</th>
            <th>Ã–nceki Stok</th>
            <th>SayÄ±lan Miktar</th>
            <th>Fark</th>
            <th>AÃ§Ä±klama</th>
            <th class="dont-print">Ä°ÅŸlemler</th> </tr>
    </thead>
    <tbody id="stokSayimGecmisiBody"></tbody>
</table>
        </div>
        </div>
</section>
        
<section id="yem-satisi" class="module-section hidden-section">
    <div class="module-header"><h2>ğŸŒ¾ Toplu Yem SatÄ±ÅŸÄ±</h2></div>

    <div class="container">
        <div class="form-section">
            <h3>Toplu SatÄ±ÅŸ Bilgileri</h3>

            <div id="toplu-satis-formu">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="topluSatisTarih">SatÄ±ÅŸ Tarihi:</label>
                        <input type="date" id="topluSatisTarih" required>
                    </div>

<div class="form-group" style="position: relative;">
    <label for="yemSatisCariAraInput">Cari Ara:</label>
    <input type="text" id="yemSatisCariAraInput" placeholder="Ad veya firma adÄ± yazÄ±n..." required>
    <input type="hidden" id="topluSatisCari"> <div id="cariOneriListesi" class="autocomplete-box"></div>
</div>
                </div>

                <div id="yemSatisSatirlari"></div>
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <button type="button" class="btn" id="yemSatirEkleBtn">âœš Yeni Yem SatÄ±rÄ± Ekle</button>
                    <div style="text-align: right;">
                        <strong>Genel Toplam: <span id="genelToplamTutar" style="font-size: 1.5em; color: #2c3e50;">0,00Â â‚º</span></strong>
                    </div>
                </div>

                <hr style="margin: 20px 0;">

                <button type="button" class="btn btn-primary btn-lg" id="tumSatislariKaydetBtn"
                        style="width: 100%; padding: 15px; font-size: 1.2em;">
                    TÃœMÂ SATIÅLARIÂ KAYDET
                </button>
            </div>
        </div>

        <hr>

        <div class="list-section">
            <h3>Son Yem SatÄ±ÅŸ Hareketleri</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Alan Cari</th>
                        <th>Yem</th>
                        <th>Miktar</th>
                        <th>Fiyat</th>
                        <th>Tutar</th>
                        <th class="dont-print">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody id="yemSatisListesiBody"></tbody>
            </table>
        </div>
    </div>
</section>

        
        <section id="tahsilat-ve-odemeler" class="module-section hidden-section">
            <div class="module-header"><h2>ğŸ’³ Tahsilat ve Ã–demeler</h2></div>
            <div class="container">
                 <div class="form-section"><h3><span id="odemeFormBaslik">Yeni Hareket GiriÅŸi</span></h3>

<form id="odemeForm" action="#">
    <input type="hidden" id="odemeEditId">
    <div class="form-grid tahsilat-form-grid">

        <div class="form-group" style="grid-column: 1 / -1; position: relative;">
            <label for="odemeCariAramaInput">Cari:</label>
            <input type="text" id="odemeCariAramaInput" class="form-control" placeholder="Aramak iÃ§in yazÄ±n..." autocomplete="off">
            <div id="odemeCariSuggestions" class="autocomplete-box"></div>
            <small id="cariBakiyeBilgisi" style="display: block; margin-top: 5px; font-weight: bold;"></small>
        </div>
        <div class="form-group" style="display: none;">
            <select id="odemeYapilanTedarikci" required><option value="">SeÃ§iniz...</option></select>
        </div>

        <div class="form-group">
            <label for="islemTuru">Ä°ÅŸlem TÃ¼rÃ¼:</label>
            <select id="islemTuru" required>
                <option value="odeme">Tahsilat</option>
                <option value="tahsilat">Ã–deme</option>
            </select>
        </div>

        <div class="form-group">
            <label for="odemeTarih">Tarih:</label>
            <input type="date" id="odemeTarih" required>
        </div>

        <div class="form-group">
            <label for="odemeTuru">Ã–deme TÃ¼rÃ¼:</label>
            <select id="odemeTuru" required>
                <option value="Kasa">Kasa</option>
                <option value="Banka">Banka</option>
                <option value="Pos">Pos</option>
                <option value="Ã‡ek">Ã‡ek</option>
                <option value="Senet">Senet</option>
            </select>
        </div>

        <div class="form-group">
            <label for="odemeTutari">Tutar (TL):</label>
            <input type="number" id="odemeTutari" step="0.01" required>
        </div>
        
        <div class="form-group" style="grid-column: 1 / -1;">
            <label for="odemeAciklama">AÃ§Ä±klama:</label>
            <textarea id="odemeAciklama" rows="2"></textarea>
        </div>

    </div>
    <button type="submit" class="btn btn-primary" id="odemeKaydetBtn">Kaydet</button>
    <button type="button" class="btn" id="odemeFormTemizleBtn" style="display:none;">Yeni KayÄ±t</button>
</form>

</div>
                 <div class="list-section"><h3>Ä°ÅŸlem Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Cari</th><th>Ä°ÅŸlem TÃ¼rÃ¼</th><th>Tutar</th><th>AÃ§Ä±klama</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="odemeListesiBody"></tbody></table></div>
            </div>
        </section>
        
        <section id="hesap-ozeti" class="module-section hidden-section">
    <div class="module-header dont-print"><h2>ğŸ“Š Cari Hesap Ã–zeti</h2></div>
    <div class="container">
        <div class="report-section">
            <h3 class="dont-print">Cari Hesap Ã–zeti</h3>
            
          <div class="form-grid dont-print" style="grid-template-columns: 2fr 2fr 1fr auto; align-items: end; gap: 10px;">
<div class="form-group" style="position: relative;">
    <label for="raporCariAramaInput">Cari Ara:</label>
    <input type="text" id="raporCariAramaInput" placeholder="Aramak iÃ§in yazÄ±n..." autocomplete="off">
    <div id="raporCariSuggestions" class="autocomplete-box"></div>
</div>
<div class="form-group" style="display: none;"> 
    <label for="raporCariSecimi">SonuÃ§lar</label>
    <select id="raporCariSecimi">
        <option value="">TÃ¼mÃ¼...</option>
    </select>
</div>
    <div class="form-group">
        <label for="raporTarihAraligi">Ay</label>
        <input type="month" id="raporTarihAraligi">
    </div>
    <button type="button" class="btn btn-primary" id="raporOlusturBtn" style="height:45px;">Rapor OluÅŸtur</button>
</div>
            <hr class="dont-print">
            <div id="report-content-to-print" class="printable-content format-a5">
                <h1 class="print-only print-title">SÃ¼t Takip ProgramÄ± - Cari Hesap Ã–zeti</h1>
                <h4 id="raporBaslik" style="text-align:center;">LÃ¼tfen Rapor Kriterlerini SeÃ§in</h4>
                <div id="raporDetayAlani"></div>
            </div>

            <div id="hesap-ozeti-export-area" style="display: none;"></div>
            <button type="button" class="btn btn-secondary dont-print" id="raporYazdirBtn" style="margin-top:20px;">Ã–zeti YazdÄ±r</button>
            <button type="button" class="btn btn-danger dont-print" id="hesapOzetiPdfBtn" style="margin-top:20px;">PDF Ä°ndir</button>
            <button type="button" class="btn btn-success dont-print" id="hesapOzetiXlsxBtn" style="margin-top:20px;">Excel Ä°ndir</button>
        </div>
    </div>
</section>
        
<section id="sut-alim-raporu" class="module-section hidden-section">
    <div class="module-header dont-print"><h2>ğŸ—“ï¸ AylÄ±k SÃ¼t Raporu</h2></div>
    <div class="container">
        <div class="report-section">
            <h3>DetaylÄ± SÃ¼t AlÄ±m Raporu</h3>
            <div class="form-grid dont-print" style="grid-template-columns: 1fr 2fr 1fr auto; align-items: end; gap: 10px;">
    <div class="form-group" style="position: relative;">
    <label for="sutRaporuCariAramaInput">Cari SeÃ§in:</label>
    <input type="text" id="sutRaporuCariAramaInput" class="form-control" placeholder="Ãœretici adÄ± yazarak arayÄ±n..." autocomplete="off">
    <div id="sutRaporuCariSuggestions" class="autocomplete-box"></div>
</div>
<div class="form-group" style="display: none;">
    <select id="sutRaporuTedarikciSecimi"><option value="">SeÃ§iniz...</option></select>
</div>
    <div class="form-group">
        <label>Tarih AralÄ±ÄŸÄ± SeÃ§in:</label>
        <div style="display: flex; gap: 10px;">
            <input type="date" id="sutRaporuBaslangicTarihi" style="flex: 1;">
            <input type="date" id="sutRaporuBitisTarihi" style="flex: 1;">
        </div>
    </div>
    <div class="form-group">
        <label for="sutRaporuKategoriSecimi">Kategori:</label>
        <select id="sutRaporuKategoriSecimi"><option value="">TÃ¼mÃ¼</option></select>
    </div>
    <div style="display: flex; gap: 10px;">
        <button type="button" class="btn btn-primary" id="sutRaporuOlusturBtn" style="height:45px; flex-grow: 1;">GÃ¶ster</button>
        <button type="button" class="btn btn-info" id="sutRaporuKategoriGosterBtn" style="height:45px; flex-grow: 1;">Kategori</button>
        <button type="button" class="btn btn-info" id="sutRaporuTumunuGosterBtn" style="height:45px; flex-grow: 1;">Toplu</button>
    </div>
</div>

<hr class="dont-print">
            
            <div id="sutAlimRaporAlani" class="printable-content format-a5">
                <h1 class="print-only print-title">SÃ¼t Takip ProgramÄ± - AylÄ±k SÃ¼t AlÄ±m Detay Raporu</h1>
                <h4 id="sutRaporuBaslik" style="text-align:center;">LÃ¼tfen Rapor Kriterlerini SeÃ§in</h4>
                <div id="sutRaporuDetayAlani"></div>
            </div>

            <div id="sut-raporu-export-area" style="display: none;"></div>
            <button type="button" class="btn btn-secondary dont-print" id="sutRaporuYazdirBtn" style="margin-top:20px;">Raporu YazdÄ±r</button>
            <button type="button" class="btn btn-danger dont-print" id="sutRaporuPdfBtn" style="margin-top:20px;">PDF Ä°ndir</button>
            <button type="button" class="btn btn-success dont-print" id="sutRaporuXlsxBtn" style="margin-top:20px;">Excel Ä°ndir</button>
        </div>
    </div>
</section>
        
       <section id="aylik-yem-raporu" class="module-section hidden-section">
    <div class="module-header"><h2>ğŸ“ˆ AylÄ±k Yem SatÄ±ÅŸ RaporlarÄ±</h2></div>
    <div class="container">
        <div class="report-section">
           <h3>Yem SatÄ±ÅŸ Analizi</h3>
<div class="form-grid dont-print yem-raporu-filtre-kapsayici">    <div class="form-group">
        <label for="yemRaporuAySecimi">Ay SeÃ§in:</label>
        <input type="month" id="yemRaporuAySecimi">
    </div>
    
    <div class="form-group">
        <label for="yemRaporuKoySecimi">KÃ¶y Filtrele:</label>
        <select id="yemRaporuKoySecimi">
            <option value="">TÃ¼m KÃ¶yler</option>
        </select>
    </div>
    <button type="button" class="btn btn-info" id="yemAdetRaporuBtn" style="height:45px;">Adet BazlÄ± Rapor</button>
    <button type="button" class="btn btn-primary" id="yemDetayliSatisRaporuBtn" style="height:45px;">SatÄ±ÅŸ Raporu (Tutar)</button>
    <button type="button" class="btn btn-success" id="yemMusteriKarRaporuBtn" style="height:45px;">KÃ¢rlÄ±lÄ±k Raporu</button>
</div>
           <hr class="dont-print">
           <div id="yemRaporuAlani" class="printable-content format-a4" style="overflow-x: auto;">
        


</div>
           <button type="button" class="btn btn-secondary dont-print" id="yemRaporuYazdirBtn" style="margin-top:20px;">Raporu YazdÄ±r</button>
           <button type="button" class="btn btn-danger dont-print" id="yemRaporuPdfBtn" style="margin-top:20px;">PDF Ä°ndir</button>
           <button type="button" class="btn btn-success dont-print" id="yemRaporuXlsxBtn" style="margin-top:20px;">Excel Ä°ndir</button>
        </div>
    </div>
</section>
   
<section id="dinamik-sut-raporu" class="module-section hidden-section">
    <div class="module-header"><h2>ğŸ“‹ Dinamik SÃ¼t Karnesi</h2></div>
    <div class="container">
        <div class="report-section">
            <div class="form-grid dont-print" style="grid-template-columns: 1fr 1fr auto; align-items: end; gap: 10px;">
    <div class="form-group">
        <label for="karneRaporuPeriyotSecimi">DÃ¶nem SeÃ§in:</label>
        <select id="karneRaporuPeriyotSecimi"></select>
    </div>
    <div class="form-group">
        <label for="karneRaporuKategoriSecimi">Kategori/KÃ¶y SeÃ§in:</label>
        <select id="karneRaporuKategoriSecimi"></select>
    </div>
    <button type="button" class="btn btn-primary" id="karneRaporuOlusturBtn" style="height:45px;">Karneyi OluÅŸtur</button>
</div>
            <hr class="dont-print">
            
            <div id="dinamikRaporContainer" class="printable-content format-a3">
                <p style="text-align:center;">Raporu oluÅŸturmak iÃ§in lÃ¼tfen yukarÄ±dan ay ve kategori seÃ§in.</p>
            </div>
<div class="report-buttons-footer dont-print" style="text-align: right; margin-top: 20px;">
    <button type="button" class="btn btn-secondary" id="karneYazdirBtn">ğŸ–¨ï¸ YazdÄ±r</button>
    <button type="button" class="btn btn-danger" id="karnePdfBtn">ğŸ“„ PDF Ä°ndir</button>
    <button type="button" class="btn btn-success" id="karneXlsxBtn">ğŸ“Š Excel Ä°ndir</button>
</div>
        </div>
    </div>
</section>

<section id="hareket-dokumu" class="module-section hidden-section">
    <div class="module-header">
        <h2>ğŸ“‹ DetaylÄ± Hareket DÃ¶kÃ¼mÃ¼</h2>
    </div>
    <div class="container">
        <div class="form-section dont-print" style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h3>Filtreler</h3>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr auto; align-items: end;">
                <div class="form-group">
                    <label for="hd-baslangic-tarihi">BaÅŸlangÄ±Ã§ Tarihi:</label>
                    <input type="date" id="hd-baslangic-tarihi">
                </div>
                <div class="form-group">
                    <label for="hd-bitis-tarihi">BitiÅŸ Tarihi:</label>
                    <input type="date" id="hd-bitis-tarihi">
                </div>
                <div class="form-group">
                    <label for="hd-islem-turu">Ä°ÅŸlem TÃ¼rÃ¼:</label>
                    <select id="hd-islem-turu">
                        <option value="tumu">TÃ¼mÃ¼</option>
                        <option value="sut_alimi">SÃ¼t AlÄ±mÄ±</option>
                        <option value="yem_satisi">Yem SatÄ±ÅŸÄ±</option>
                        <option value="yem_alisi">Yem AlÄ±ÅŸÄ±</option>
                        <option value="odeme">Ã–deme (Bize Gelen)</option>
                        <option value="tahsilat">Tahsilat (Bizden Ã‡Ä±kan)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hd-cari-secimi">Cari:</label>
                    <select id="hd-cari-secimi">
                        <option value="tumu">TÃ¼mÃ¼</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary" id="hareketFiltreleBtn" style="height: 45px;">Filtrele</button>
            </div>
        </div>

        <div class="list-section">
            <h3>TÃ¼m Ä°ÅŸlem GeÃ§miÅŸi (En Yeni Ãœstte)</h3>
            <div id="hareketDokumuContainer">
                <p style="text-align: center;">LÃ¼tfen filtreleme kriterlerini seÃ§ip 'Filtrele' butonuna basÄ±n.</p>
                </div>
        </div>
    </div>
</section>
        
<section id="ayarlar" class="module-section hidden-section">
    <div class="module-header">
        <h2>âš™ï¸ Ayarlar</h2>
    </div>
    <div class="container">

        <div class="settings-card">
            <h3>Genel TanÄ±mlar ve Parametreler</h3>
            <div class="settings-grid">
                <div class="settings-group">
                    <h4>VarsayÄ±lan SÃ¼t FiyatÄ±</h4>
                    <form id="ayarlarForm">
                        <div class="form-group">
                            <label for="varsayilanSutFiyati">Fiyat (TL/Lt):</label>
                            <input type="number" id="varsayilanSutFiyati" step="0.01">
                        </div>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </form>
                </div>
                <div class="settings-group">
                    <h4>Cari Kategori/KÃ¶y TanÄ±mlarÄ±</h4>
                    <form id="cariKategoriForm" action="#">
                        <div class="form-grid" style="grid-template-columns: 1fr auto; align-items:end;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="yeniCariKategoriAdi">Yeni Ad:</label>
                                <input type="text" id="yeniCariKategoriAdi" required>
                            </div>
                            <button type="submit" class="btn" style="height:45px;">Ekle</button>
                        </div>
                    </form>
                    <div class="list-section" style="margin-top:20px;">
                        <h5>TanÄ±mlÄ± Kategoriler/KÃ¶yler</h5>
                        <ul id="cariKategoriListesiUl"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-card">
            <h3>Firma Bilgileri (Makbuzlar Ä°Ã§in)</h3>
            <form id="firmaBilgileriForm">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group" style="grid-column: span 2;"><label for="firmaUnvani">Firma UnvanÄ±:</label><input type="text" id="firmaUnvani" disabled></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="firmaAdresi">Adres:</label><textarea id="firmaAdresi" rows="2" disabled></textarea></div>
                    <div class="form-group"><label for="firmaVergiDairesi">Vergi Dairesi:</label><input type="text" id="firmaVergiDairesi" disabled></div>
                    <div class="form-group"><label for="firmaVkn">Vergi/TC Kimlik No:</label><input type="text" id="firmaVkn" disabled></div>
                    <div class="form-group"><label for="firmaTicSicilNo">Ticaret Sicil No:</label><input type="text" id="firmaTicSicilNo" disabled></div>
                    <div class="form-group"><label for="firmaTelefon">Telefon:</label><input type="tel" id="firmaTelefon" disabled></div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn" id="firmaDuzenleBtn">DÃ¼zenle</button>
                    <button type="submit" class="btn btn-primary" id="firmaKaydetBtn" style="display:none;">DeÄŸiÅŸiklikleri Kaydet</button>
                </div>
            </form>
        </div>

        <div class="settings-card">
            <h3>GÃ¼venlik AyarlarÄ±</h3>
            <form id="sifreDegistirForm">
                <div class="form-group"><label for="eskiSifre">Eski Åifre:</label><input type="password" id="eskiSifre" required></div>
                <div class="form-group"><label for="yeniSifre">Yeni Åifre:</label><input type="password" id="yeniSifre" required></div>
                <div class="form-group"><label for="yeniSifreTekrar">Yeni Åifre (Tekrar):</label><input type="password" id="yeniSifreTekrar" required></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Åifreyi GÃ¼ncelle</button>
            </form>
        </div>

        <div class="settings-card dont-calisan">
            <h3>KullanÄ±cÄ± YÃ¶netimi</h3>
            <form id="kullaniciForm">
                <input type="hidden" id="kullaniciEditId">
                <div class="form-grid">
                    <div class="form-group"><label for="kullaniciAdi">KullanÄ±cÄ± E-posta:</label><input type="email" id="kullaniciAdi" required></div>
                    <div class="form-group"><label for="kullaniciSifre">Åifre:</label><input type="password" id="kullaniciSifre" required></div>
                </div>
                <button type="submit" class="btn" id="kullaniciKaydetBtn">Ã‡alÄ±ÅŸan Ekle</button>
            </form>
            <div class="list-section" style="margin-top:20px;">
                <h4>KullanÄ±cÄ± Listesi</h4>
                <table>
                    <thead><tr><th>KullanÄ±cÄ± AdÄ±</th><th>Rol</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead>
                    <tbody id="kullaniciListesiBody"></tbody>
                </table>
            </div>
        </div>

    </div>
</section>


</section>
</div> 

<script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, reauthenticateWithCredential, EmailAuthProvider, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { 
    getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, 
    query, where, orderBy, limit, runTransaction, increment, onSnapshot, FieldPath, writeBatch, documentId
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
        authDomain: "sut-takip-projem.firebaseapp.com",
        projectId: "sut-takip-projem",
        storageBucket: "sut-takip-projem.appspot.com",
        messagingSenderId: "512756958486",
        appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
        measurementId: "G-LYLT9WFVNK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast-message');
        if (!toast) return;
        toast.textContent = message;
        toast.style.backgroundColor = isError ? '#e74c3c' : '#28a745';
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function showCustomConfirm(message, onConfirm, title = "Ä°ÅŸlem OnayÄ±") {
        const overlay = document.getElementById('custom-confirm-overlay');
        const titleEl = document.getElementById('custom-confirm-title');
        const messageEl = document.getElementById('custom-confirm-message');
        const yesBtn = document.getElementById('custom-confirm-yes');
        const cancelBtn = document.getElementById('custom-confirm-cancel');
        
        titleEl.textContent = title;
        messageEl.textContent = message;

        const cleanup = () => {
            overlay.classList.remove('show');
            yesBtn.replaceWith(yesBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        };

        document.getElementById('custom-confirm-yes').onclick = () => {
            onConfirm();
            cleanup();
        };
        
        document.getElementById('custom-confirm-cancel').onclick = cleanup;
        overlay.classList.add('show');
    }

    function showCustomPrompt(message, onConfirm, title = "Onay Gerekiyor") {
        const overlay = document.getElementById('custom-prompt-overlay');
        const titleEl = document.getElementById('custom-prompt-title');
        const messageEl = document.getElementById('custom-prompt-message');
        const inputEl = document.getElementById('custom-prompt-input');
        const okBtn = document.getElementById('custom-prompt-ok');
        const cancelBtn = document.getElementById('custom-prompt-cancel');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        inputEl.value = '';

        const cleanup = () => {
            overlay.classList.remove('show');
            okBtn.replaceWith(okBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        };

        document.getElementById('custom-prompt-ok').onclick = () => {
            onConfirm(inputEl.value);
            cleanup();
        };
        
        document.getElementById('custom-prompt-cancel').onclick = cleanup;
        overlay.classList.add('show');
    }
	
    let selectedMmCariId = '';
    let cachedHareketler = [];
    let cachedDateRange = '';
    let currentUserRole = '';
    let currentUserId = '';
    let sahipId = '';
    let globalSettings = { defaultMilkPrice: 15.50 };
    let editingCariId = null, editingYemTanimId = null, editingYemAlisId = null, editingYemSatisId = null, editingOdemeId = null;
    let gunlukSutunChartInstance = null;
    let aylikSutunChartInstance = null;
	let isGunlukChartRendering = false; 	
	let isAylikChartRendering = false; 
    let raporCariSecimiOrjinalSecenekler = [];
    let sutAlimGecmisiListener = null; 
    let topluGirisListener = null;   
    let hareketDokumuListener = null; 
    let lastVisibleHareket = null;
    let firstVisibleHareketStack = [];
    let hareketPageCount = 1;
    let isAppInitialized = false;
    const globalCache = new Map();
    const CACHE_TTL_SECONDS = 300;

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.error('Service Worker registration failed: ', err));
        });
    }

    Chart.register(ChartDataLabels);

onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById('logoutUserEmail').textContent = user.email;
        currentUserId = user.uid;
        try {
            const userDocRef = doc(db, 'kullanicilar', user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const userData = userDocSnap.data();
                currentUserRole = userData.rol;
                sahipId = userData.sahipId || user.uid;

                if (currentUserRole === 'admin') {
                    if (sessionStorage.getItem('panelSecildi')) {
                        uygulamayiBaslat();
                    } else {
                        document.getElementById('secim-modal-overlay').classList.add('show');
                    }
                } else {
                    const targetPage = currentUserRole === 'calisan' ? 'hizli-giris.html' : 'musteri_portali.html';
                    window.location.href = targetPage;
                }
            } else { handleLogout(); }
        } catch (error) { handleLogout(); }
    } else {
        window.location.href = 'login.html';
    }
});

document.getElementById('secim-sut-takibi-btn')?.addEventListener('click', () => {
    sessionStorage.setItem('panelSecildi', 'true'); // SeÃ§im yapÄ±ldÄ±ÄŸÄ±nÄ± kaydet
    document.getElementById('secim-modal-overlay').classList.remove('show');
    uygulamayiBaslat(); // UygulamayÄ± baÅŸlat
});

document.getElementById('secim-mustahsil-merkezi-btn')?.addEventListener('click', () => {
    sessionStorage.setItem('panelSecildi', 'true'); // SeÃ§im yapÄ±ldÄ±ÄŸÄ±nÄ± kaydet
    window.location.href = 'mustahsil.html';
});

async function uygulamayiBaslat() {
    if (window.isAppInitialized) { return; }
    window.isAppInitialized = true;
    
    await getSettings();
    await loadInitialData();

    const sidebarNav = document.getElementById('sidebarNav');
document.getElementById('moduleSwitchSelect')?.addEventListener('change', function() {
        if (this.value) window.location.href = this.value;
    });

    const moduleSections = document.querySelectorAll('.main-content .module-section');
    const logoutButton = document.getElementById('logoutButton');
    const cariForm = document.getElementById('cariForm');
    const cariFormTemizleBtn = document.getElementById('cariFormTemizleBtn');
    const yemTanimForm = document.getElementById('yemTanimForm');
    const yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
    const yemAlisForm = document.getElementById('yemAlisForm');
    const yemAlisFormTemizleBtn = document.getElementById('yemAlisFormTemizleBtn');
    const odemeForm = document.getElementById('odemeForm');
    const odemeFormTemizleBtn = document.getElementById('odemeFormTemizleBtn');
    const ayarlarForm = document.getElementById('ayarlarForm');
    const cariKategoriForm = document.getElementById('cariKategoriForm');
    const kullaniciForm = document.getElementById('kullaniciForm');
    const sifreDegistirForm = document.getElementById('sifreDegistirForm');
    const cariKategoriFiltre = document.getElementById('cariKategoriFiltre');
    const cariListesiYazdirBtn = document.getElementById('cariListesiYazdirBtn');
    const topluGirisTarihInput = document.getElementById('topluGirisTarih');
    const topluGirisKategoriSelect = document.getElementById('topluGirisKategori');
    const sutDuzenleForm = document.getElementById('sutDuzenleForm');
    const odemeCariSecimi = document.getElementById('odemeYapilanTedarikci');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const sidebar = document.querySelector('.sidebar');
    const cariSuggestionBox = document.getElementById('cariSearchSuggestions');
    
    window.editCari = editCari;
    window.deleteCari = deleteCari;
    window.sutMiktarGuncelle = sutMiktarGuncelle;
    window.handleTopluSutKaydet = handleTopluSutKaydet;
    window.editYemTanimi = editYemTanimi;
    window.deleteYemTanimi = deleteYemTanimi;
    window.editYemAlisi = editYemAlisi;
    window.deleteYemAlisi = deleteYemAlisi;
    window.removeYemSatisRow = removeYemSatisRow;
    window.editOdeme = editOdeme;
    window.deleteOdeme = deleteOdeme;
    window.closeSutDuzenleForm = closeSutDuzenleForm;
    window.editSutAlimi = editSutAlimi;
    window.deleteSutAlimi = deleteSutAlimi;
    window.editYemSatisi = editYemSatisi;
    window.deleteYemSatisi = deleteYemSatisi;
    window.deleteStokSayimi = deleteStokSayimi;

    const odemeCariAramaInput = document.getElementById('odemeCariAramaInput');
    if (odemeCariAramaInput) {
        const suggestionsBox = document.getElementById('odemeCariSuggestions');
        const cariSelect = document.getElementById('odemeYapilanTedarikci');
        let debounceTimer; 
        odemeCariAramaInput.addEventListener('input', function() {
            clearTimeout(debounceTimer); 
            const queryText = this.value.toLowerCase();
            suggestionsBox.innerHTML = '';
            suggestionsBox.style.display = 'none';
            if (queryText.length < 2) {cariSelect.value = "";cariSelect.dispatchEvent(new Event('change'));return;}
            debounceTimer = setTimeout(async () => {
                const matches = [];
                window.cariDataMap.forEach((cari, id) => {
                    if (cari.adiSoyadi && cari.adiSoyadi.toLowerCase().includes(queryText)) {matches.push({ id: id, adi: cari.adiSoyadi });}});
    
                if (matches.length > 0) {
                    const bakiyePromises = matches.map(match => calculateCariBakiyeDetayli(match.id));
                    const bakiyeler = await Promise.all(bakiyePromises);
                    suggestionsBox.innerHTML = ''; 
                    suggestionsBox.style.display = 'block';

                    matches.slice(0, 10).forEach((match, index) => {
                        const bakiyeDetay = bakiyeler[index];
                        const bakiye = bakiyeDetay.bakiye;
                        const bakiyeMiktar = new Intl.NumberFormat('tr-TR').format(Math.abs(bakiye));
                        const bakiyeDurum = bakiye >= 0 ? 'AlacaklÄ±' : 'BorÃ§lu';
                        const bakiyeRenk = bakiye >= 0 ? 'green' : 'red';
                        const etiketText = `(${bakiyeMiktar} tl ${bakiyeDurum})`;
                        const div = document.createElement('div');
                        div.innerHTML = `${match.adi} <span style="color: ${bakiyeRenk}; font-weight: bold; float: right;">${etiketText}</span>`;
                        div.addEventListener('click', () => {
                            odemeCariAramaInput.value = match.adi;
                            cariSelect.value = match.id;
                            cariSelect.dispatchEvent(new Event('change')); 
                            suggestionsBox.style.display = 'none';
                        });
                        suggestionsBox.appendChild(div);
                    });
                }
            }, 400); 
        });
        odemeCariAramaInput.addEventListener('blur', function() {setTimeout(() => {suggestionsBox.style.display = 'none';}, 200);});
    }
    
    const cariAraInput = document.getElementById('yemSatisCariAraInput');
    const cariIdHidden = document.getElementById('topluSatisCari');
    const oneriKutusu = document.getElementById('cariOneriListesi');

    if (cariAraInput) {
        cariAraInput.addEventListener('input', function () {
            const arama = this.value.toLowerCase();
            const eslesenler = [];
            window.cariDataMap.forEach((cari, id) => {
                if (cari.adiSoyadi?.toLowerCase().includes(arama)) {eslesenler.push({ id, ad: cari.adiSoyadi });}
            });

            oneriKutusu.innerHTML = "";
            eslesenler.slice(0, 10).forEach(cari => {
                const div = document.createElement('div');
                div.textContent = cari.ad;
                div.addEventListener('click', () => {
                    cariAraInput.value = cari.ad;
                    cariIdHidden.value = cari.id;
                    oneriKutusu.innerHTML = "";
                });
                oneriKutusu.appendChild(div);
            });
        });
        cariAraInput.addEventListener('blur', function () {
            setTimeout(() => oneriKutusu.innerHTML = "", 150);
        });
    }

    if (menuToggleBtn && sidebar) {
        menuToggleBtn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
        sidebar.addEventListener('click', (event) => {
            if (window.innerWidth <= 1024 && event.target.closest('a.nav-link')) {
                sidebar.classList.add('collapsed');
            }
        });
    }

    applyRolePermissions();
    loadAndRenderAllData();
    updateMonthlyStats();

    sidebarNav.addEventListener('click', async function (event) {
        const link = event.target.closest('a.nav-link');
        if (!link || link.id === 'logoutButton') return;
        event.preventDefault();
        
        sidebarNav.querySelectorAll('a.nav-link').forEach(lnk => lnk.classList.remove('active'));
        link.classList.add('active');

        const targetId = link.getAttribute('href').substring(1);
        moduleSections.forEach(section => { section.style.display = 'none'; });
        const activeSection = document.getElementById(targetId);
        
        if (activeSection) {
            activeSection.style.display = 'block';
            activeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        if (targetId === 'dashboard') {
            updateDashboardStats();
            updateMonthlyStats();
        }
        
        if (targetId === 'cari-yonetimi') {
            populateCariKategoriFiltre();
            renderCariListesi();
            populateCariKategoriSelect(document.getElementById('cariKategori'));
            generateNextCariKodu();
        }
        
        if (targetId === 'mustahsil-merkezi') {
            const baslangicInput = document.getElementById('mm-batch-baslangic');
            const bitisInput = document.getElementById('mm-batch-bitis');
           populateCariKategoriSelect(document.getElementById('mm-batch-kategori'), "TÃ¼m Kategoriler");

            if (baslangicInput && bitisInput && (!baslangicInput.value || !bitisInput.value)) {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const formatForInput = (date) => date.toISOString().split('T')[0];
                baslangicInput.value = formatForInput(firstDayOfMonth);
                bitisInput.value = formatForInput(today);
            }
        }
        
        if (targetId === 'sut-alimi') {
            if (topluGirisTarihInput) topluGirisTarihInput.value = getTodayForInput();
            populateCariKategoriSelect(topluGirisKategoriSelect);
            renderTopluSutGirisFormu();
            renderSutAlimGecmisi();
        }
        
        if (targetId === 'yem-stok-yonetimi') {
            populateCariSelect(document.getElementById('yemAlisTedarikci'), 'tedarikÃ§i');
            populateYemSelect(document.getElementById('yemSecimiAlis'));
            populateYemSelect(document.getElementById('sayimYemSecimi'));
            renderStokSayimGecmisi();
            renderYemAlisHareketleri();
            renderYemStokListesi();
        }
        
        if (targetId === 'yem-satisi') {
            if (document.getElementById('yemSatisSatirlari').childElementCount === 0) {
                addYemSatisRow();
            }
            renderYemSatisListesi();
        }
    
        if (targetId === 'tahsilat-ve-odemeler') {
            populateCariSelect(document.getElementById('odemeYapilanTedarikci'));
            renderOdemeListesi();
        }
        
        if (targetId === 'hesap-ozeti') {
            populateCariSelect(document.getElementById('raporCariSecimi'));
            if (!document.getElementById('raporTarihAraligi').value) {
                document.getElementById('raporTarihAraligi').value = getMonthYearForInput();
            }
        }
        
        if (targetId === 'sut-alim-raporu') {
            populateCariSelect(document.getElementById('sutRaporuTedarikciSecimi'), 'Ã¼retici');
            populateCariKategoriSelect(document.getElementById('sutRaporuKategoriSecimi'), "TÃ¼mÃ¼");
            const baslangicTarihiInput = document.getElementById('sutRaporuBaslangicTarihi');
            const bitisTarihiInput = document.getElementById('sutRaporuBitisTarihi');
            if (baslangicTarihiInput && !baslangicTarihiInput.value && bitisTarihiInput && !bitisTarihiInput.value) {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const formatForInput = (date) => date.toISOString().split('T')[0];
                baslangicTarihiInput.value = formatForInput(firstDayOfMonth);
                bitisTarihiInput.value = formatForInput(today);
            }
        }
        
        if (targetId === 'aylik-yem-raporu') {
            if (!document.getElementById('yemRaporuAySecimi').value) {
                document.getElementById('yemRaporuAySecimi').value = getMonthYearForInput();
            }
            populateCariKategoriSelect(document.getElementById('yemRaporuKoySecimi'), 'TÃ¼m KÃ¶yler');
        }
        
        if (targetId === 'dinamik-sut-raporu') {
            populatePeriodSelect();
            populateCariKategoriSelect(document.getElementById('karneRaporuKategoriSecimi'), "TÃ¼m Kategoriler");
        }
        
        if (targetId === 'hareket-dokumu') {
            populateCariSelect(document.getElementById('hd-cari-secimi'), null, "TÃ¼m Cariler");
            const baslangicInput = document.getElementById('hd-baslangic-tarihi');
            const bitisInput = document.getElementById('hd-bitis-tarihi');
            if (cachedHareketler.length === 0) {
                const today = new Date();
                const ayinIlkGunu = new Date(today.getFullYear(), today.getMonth(), 1);
                const formatForInput = (date) => date.toISOString().split('T')[0];
                baslangicInput.value = formatForInput(ayinIlkGunu);
                bitisInput.value = formatForInput(today);
                fetchAndDisplayHareketler();
            } else {
                displayHareketler(cachedHareketler);
            }
        }
        
        if (targetId === 'ayarlar') { 
    renderCariKategoriListesi(); 
    getSettings();
    if (currentUserRole === 'admin') { 
        renderKullaniciListesi(); 
    } 
}
    });

    logoutButton.addEventListener('click', handleLogout);
    cariForm.addEventListener('submit', handleCariKaydet);
    yemTanimForm.addEventListener('submit', handleYemTanimKaydet);
    yemAlisForm.addEventListener('submit', handleYemAlisKaydet);
    odemeForm.addEventListener('submit', handleOdemeKaydet);
    ayarlarForm.addEventListener('submit', handleAyarlarKaydet);
    document.getElementById('firmaBilgileriForm')?.addEventListener('submit', handleAyarlarKaydet);
    cariKategoriForm.addEventListener('submit', handleCariKategoriEkle);
    if(kullaniciForm) kullaniciForm.addEventListener('submit', handleKullaniciKaydet);
    sifreDegistirForm.addEventListener('submit', handleSifreDegistir);
    if(sutDuzenleForm) sutDuzenleForm.addEventListener('submit', handleSutAlimiGuncelle);
    if(cariFormTemizleBtn) cariFormTemizleBtn.addEventListener('click', resetCariForm);
    if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.addEventListener('click', resetYemTanimForm);
    if(yemAlisFormTemizleBtn) yemAlisFormTemizleBtn.addEventListener('click', resetYemAlisForm);
    if(odemeFormTemizleBtn) odemeFormTemizleBtn.addEventListener('click', resetOdemeForm);
    cariKategoriFiltre.addEventListener('change', renderCariListesi);
    document.getElementById('cariTarihselRaporBtn')?.addEventListener('click', renderCariListesi);
    topluGirisTarihInput?.addEventListener('change', () => { renderTopluSutGirisFormu(); renderSutAlimGecmisi(); });
    topluGirisKategoriSelect?.addEventListener('change', renderTopluSutGirisFormu);
    document.getElementById('aylikChartGosterBtn')?.addEventListener('click', renderAylikSutunGrafik);
    if(odemeCariSecimi) { odemeCariSecimi.addEventListener('change', async (event) => {}); }
    
    const raporCariAramaInput = document.getElementById('raporCariAramaInput');
    if (raporCariAramaInput) {
        const suggestionsBox = document.getElementById('raporCariSuggestions');
        const cariSelect = document.getElementById('raporCariSecimi');
        raporCariAramaInput.addEventListener('input', function() {
            const queryText = this.value.toLowerCase();
            suggestionsBox.innerHTML = ''; 
            suggestionsBox.style.display = 'none';
            if (queryText.length < 2) { return; }
            const matches = [];
            window.cariDataMap.forEach((cari, id) => {
                if (cari.adiSoyadi && cari.adiSoyadi.toLowerCase().includes(queryText)) {
                    matches.push({ id: id, adi: cari.adiSoyadi });
                }
            });
            if (matches.length > 0) {
                suggestionsBox.style.display = 'block';
                matches.slice(0, 10).forEach(match => { 
                    const div = document.createElement('div');
                    div.textContent = match.adi;
                    div.addEventListener('click', () => {
                        raporCariAramaInput.value = match.adi; 
                        cariSelect.value = match.id; 
                        suggestionsBox.innerHTML = ''; 
                        suggestionsBox.style.display = 'none';
                    });
                    suggestionsBox.appendChild(div);
                });
            }
        });
        raporCariAramaInput.addEventListener('blur', function() { setTimeout(() => { suggestionsBox.style.display = 'none'; }, 200); });
    }

    const sutRaporuCariAramaInput = document.getElementById('sutRaporuCariAramaInput');
    if (sutRaporuCariAramaInput) {
        const suggestionsBox = document.getElementById('sutRaporuCariSuggestions');
        const cariSelect = document.getElementById('sutRaporuTedarikciSecimi');
        sutRaporuCariAramaInput.addEventListener('input', function() {
            const queryText = this.value.toLowerCase();
            suggestionsBox.innerHTML = '';
            suggestionsBox.style.display = 'none';
            if (queryText.length < 2) { cariSelect.value = ""; return; }
            const matches = [];
            window.cariDataMap.forEach((cari, id) => {
                if (cari.adiSoyadi && cari.cariGrup && cari.cariGrup.includes('Ã¼retici') && cari.adiSoyadi.toLowerCase().includes(queryText)) {
                    matches.push({ id: id, adi: cari.adiSoyadi });
                }
            });
            if (matches.length > 0) {
                suggestionsBox.style.display = 'block';
                matches.slice(0, 10).forEach(match => {
                    const div = document.createElement('div');
                    div.textContent = match.adi;
                    div.addEventListener('click', () => {
                        sutRaporuCariAramaInput.value = match.adi; 
                        cariSelect.value = match.id; 
                        suggestionsBox.innerHTML = '';
                        suggestionsBox.style.display = 'none';
                    });
                    suggestionsBox.appendChild(div);
                });
            }
        });
        sutRaporuCariAramaInput.addEventListener('blur', function() { setTimeout(() => { suggestionsBox.style.display = 'none'; }, 200); });
    }
    
    document.getElementById('raporOlusturBtn')?.addEventListener('click', handleHesapOzetiRaporuOlustur);
    document.getElementById('sutRaporuOlusturBtn')?.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: false}));
    document.getElementById('sutRaporuTumunuGosterBtn')?.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: true, kategori: false}));
    document.getElementById('sutRaporuKategoriGosterBtn')?.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: true}));
    document.getElementById('yemAdetRaporuBtn')?.addEventListener('click', () => handleYemPivotRaporu('adet'));
    document.getElementById('yemDetayliSatisRaporuBtn')?.addEventListener('click', () => handleYemPivotRaporu('satis'));
    document.getElementById('yemMusteriKarRaporuBtn')?.addEventListener('click', () => handleYemPivotRaporu('karlilik'));
    document.getElementById('karneRaporuOlusturBtn')?.addEventListener('click', handleDinamikSutRaporu);
    document.getElementById('hareketFiltreleBtn')?.addEventListener('click', fetchAndDisplayHareketler);
    document.getElementById('cariDurumFiltre')?.addEventListener('change', renderCariListesi);
    document.getElementById('cariGrupFiltre')?.addEventListener('change', renderCariListesi);
    document.getElementById('yemSatirEkleBtn')?.addEventListener('click', addYemSatisRow);
    document.getElementById('stokSayimForm')?.addEventListener('submit', handleStokSayimKaydet);
    document.getElementById('sayimYemSecimi')?.addEventListener('change', updateSayimForm);
    document.getElementById('sayimFizikselStok')?.addEventListener('input', updateSayimForm);
    cariListesiYazdirBtn?.addEventListener('click', () => handleYazdir('cari-list-printable-area'));
    document.getElementById('raporYazdirBtn')?.addEventListener('click', () => handleYazdir('report-content-to-print'));
    document.getElementById('sutRaporuYazdirBtn')?.addEventListener('click', () => handleYazdir('sutAlimRaporAlani'));
    document.getElementById('yemRaporuYazdirBtn')?.addEventListener('click', () => handleYazdir('yemRaporuAlani', 'landscape'));
    document.getElementById('karneYazdirBtn')?.addEventListener('click', () => handleYazdir('dinamikRaporContainer', 'landscape'));
    document.getElementById('karnePdfBtn')?.addEventListener('click', () => exportTableToPdf('dinamikRaporContainer', 'sut_karnesi', 'karnePdfBtn'));
    document.getElementById('karneXlsxBtn')?.addEventListener('click', () => exportTableToExcel('dinamikRaporContainer', 'sut_karnesi'));
    document.getElementById('hesapOzetiPdfBtn')?.addEventListener('click', () => exportTableToPdf('report-content-to-print', 'hesap_ozeti', 'hesapOzetiPdfBtn'));
    document.getElementById('hesapOzetiXlsxBtn')?.addEventListener('click', () => exportTableToExcel('hesap-ozeti-export-area', 'hesap_ozeti'));
    document.getElementById('sutRaporuPdfBtn')?.addEventListener('click', () => exportTableToPdf('sutAlimRaporAlani', 'sut_alim_raporu', 'sutRaporuPdfBtn'));
    document.getElementById('sutRaporuXlsxBtn')?.addEventListener('click', () => exportTableToExcel('sut-raporu-export-area', 'sut_alim_raporu'));
    document.getElementById('yemRaporuPdfBtn')?.addEventListener('click', () => exportTableToPdf('yemRaporuAlani', 'yem_raporu', 'yemRaporuPdfBtn'));
    document.getElementById('yemRaporuXlsxBtn')?.addEventListener('click', () => exportTableToExcel('yemRaporuAlani', 'yem_raporu'));
    document.getElementById('yemAlisMiktar').addEventListener('input', () => hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar'));
    document.getElementById('yemAlisBirimFiyati').addEventListener('input', () => hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar'));
    document.getElementById('firmaDuzenleBtn')?.addEventListener('click', () => toggleFirmaBilgileriEdit(true));
    const dashboardLink = document.querySelector('#sidebarNav a[href="#dashboard"]');
    if (dashboardLink && !dashboardLink.classList.contains('active')) {dashboardLink.click();}}

async function loadInitialData() {
    try {
        const carilerQuery = query(collection(db, 'cariler'), where("sahipId", "==", sahipId));
        const yemlerQuery = query(collection(db, 'yemler'), where("sahipId", "==", sahipId));
        const [carilerSnapshot, yemlerSnapshot] = await Promise.all([
            getDocs(carilerQuery),
            getDocs(yemlerQuery)
        ]);
        window.cariDataMap = new Map();
        carilerSnapshot.forEach(doc => {
            window.cariDataMap.set(doc.id, doc.data());
        });
        window.yemDataMap = new Map();
        yemlerSnapshot.forEach(doc => {
            window.yemDataMap.set(doc.id, doc.data());
        });

    } catch (error) {
        console.error("BaÅŸlangÄ±Ã§ verileri yÃ¼klenirken kritik hata:", error);
        showToast("Uygulama baÅŸlatÄ±lamadÄ±: Gerekli veriler yÃ¼klenemedi.", true);
    }
}

async function loadAndRenderAllData() {
        try { await renderCariListesi(); } catch (e) { console.warn("Cari listesi yÃ¼klenemedi.", e); }
        try { await renderYemStokListesi(); } catch (e) { console.warn("Yem stoku yÃ¼klenemedi.", e); }
        try { await renderOdemeListesi(); } catch (e) { console.warn("Ã–deme listesi yÃ¼klenemedi.", e); }
        try { await renderCariKategoriListesi(); } catch (e) { console.warn("Cari kategori listesi yÃ¼klenemedi.", e); }
        try { await populateCariKategoriFiltre(); } catch (e) { console.warn("Cari kategori filtresi doldurulamadÄ±.", e); }
        try { await populateCariKategoriSelect(document.getElementById('topluGirisKategori')); } catch (e) { console.warn("Toplu giriÅŸ kategorisi doldurulamadÄ±.", e); }
        try { await updateDashboardStats(); } catch (e) { console.warn("Panel istatistikleri gÃ¼ncellenemedi.", e); }
    }

    function formatDateTime(timestamp) {
        if (!timestamp) return 'Zaman Yok';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        if (isNaN(date.getTime())) return 'GeÃ§ersiz Tarih';
        const dateOptions = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const timeOptions = { hour: '2-digit', minute: '2-digit' };
        return `${date.toLocaleDateString('tr-TR', dateOptions)} ${date.toLocaleTimeString('tr-TR', timeOptions)}`;
    }

    function generateId() {
        const tempRef = doc(collection(db, '_temp'));
        return tempRef.id;
    }

    function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('tr-TR'); }
    function getTodayForInput() { return new Date().toISOString().split('T')[0]; }
    function formatMonthYear(ayYil) { if (!ayYil) return ''; const [year, month] = ayYil.split('-'); const date = new Date(year, month - 1); return date.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });}
    function getMonthYearForInput() { const d = new Date(); return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;}
    function formatCurrency(number) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(number); }
    function setEditingMode(formBaslikEl, kaydetBtnEl, temizleBtnEl, editIdVar, formType) { if(!formBaslikEl || !kaydetBtnEl) return; formBaslikEl.textContent = editIdVar ? `${formType} Bilgilerini DÃ¼zenle` : `Yeni ${formType} KaydÄ±`; kaydetBtnEl.textContent = editIdVar ? 'GÃ¼ncelle' : 'Kaydet'; if (temizleBtnEl) temizleBtnEl.style.display = editIdVar ? 'inline-block' : 'none'; }
    
    function applyRolePermissions() {
        const bodyElement = document.body;
        bodyElement.className = `role-${currentUserRole}`;
        const calisanAllowed = ['#dashboard', '#sut-alimi', '#yem-satisi', '#cari-yonetimi'];
        const activeLink = document.querySelector('#sidebarNav a.nav-link.active');
        const activeHref = activeLink ? activeLink.getAttribute('href') : '#dashboard';
        if (currentUserRole === 'calisan' && !calisanAllowed.includes(activeHref)) {
            document.querySelector('#sidebarNav a.nav-link[href="#dashboard"]').click();
        }
    }

    function handleLogout() {
        signOut(auth).then(() => { window.location.href = 'login.html'; }).catch(error => console.error("Logout error", error));
    }

async function handleMmVeriGetir() {
    const cariId = selectedMmCariId;
    const baslangicTarihi = document.getElementById('mm-baslangic-tarihi').value;
    const bitisTarihi = document.getElementById('mm-bitis-tarihi').value;
    const tableBody = document.getElementById('mm-hareket-tablosu-body');

    if (!cariId || !baslangicTarihi || !bitisTarihi) {
        return showToast("LÃ¼tfen cari, baÅŸlangÄ±Ã§ ve bitiÅŸ tarihlerini seÃ§in.", true);}

    tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">SÃ¼t verileri toplanÄ±yor...</td></tr>`;

    try {
        const sutQuery = query(collection(db, 'sut_alimlari'),
            where('sahipId', '==', sahipId),
            where('cariId', '==', cariId),
            where('tarih', '>=', baslangicTarihi),
            where('tarih', '<=', bitisTarihi)
        );
        const sutAlimlariSnap = await getDocs(sutQuery);

        if (sutAlimlariSnap.empty) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">Bu tarih aralÄ±ÄŸÄ±nda sÃ¼t alÄ±mÄ± bulunamadÄ±.</td></tr>`;
            // Ã–zet alanÄ±nÄ± sÄ±fÄ±rla
            document.getElementById('mm-toplam-alacak').textContent = formatCurrency(0);
            document.getElementById('mm-net-tutar').textContent = formatCurrency(0);
            return;
        }

        let toplamAksam = 0;
        let toplamSabah = 0;
        let toplamLitre = 0;
        let toplamBrutTutar = 0;

        sutAlimlariSnap.forEach(doc => {
            const data = doc.data();
            toplamAksam += data.aksam || 0;
            toplamSabah += data.sabah || 0;
            toplamLitre += data.toplam || 0;
            toplamBrutTutar += data.toplamTutar || 0;
        });

        const ortalamaFiyat = toplamLitre > 0 ? (toplamBrutTutar / toplamLitre) : 0;
        
        tableBody.innerHTML = `
            <tr>
                <td style="text-align:right;">${toplamAksam.toFixed(2)}</td>
                <td style="text-align:right;">${toplamSabah.toFixed(2)}</td>
                <td style="text-align:right; font-weight:bold;">${toplamLitre.toFixed(2)}</td>
                <td style="text-align:right;">${formatCurrency(ortalamaFiyat)}</td>
                <td style="text-align:right; font-weight:bold; color:green;">${formatCurrency(toplamBrutTutar)}</td>
            </tr>
        `;

        document.getElementById('mm-devir-bakiye').textContent = "0,00 â‚º"; // Devir bu ekranda gÃ¶sterilmiyor
        document.getElementById('mm-toplam-alacak').textContent = formatCurrency(toplamBrutTutar);
        document.getElementById('mm-toplam-borc').textContent = "0,00 â‚º";
        document.getElementById('mm-net-tutar').textContent = formatCurrency(toplamBrutTutar);
        
    } catch (error) {
        console.error("MÃ¼stahsil sÃ¼t verileri getirilirken hata:", error);
        showToast("Veriler getirilirken bir hata oluÅŸtu: " + error.message, true);
    }
}

function toggleFirmaBilgileriEdit(isEditing) {
    const form = document.getElementById('firmaBilgileriForm');
    const inputs = form.querySelectorAll('input, textarea');
    const duzenleBtn = document.getElementById('firmaDuzenleBtn');
    const kaydetBtn = document.getElementById('firmaKaydetBtn');

    inputs.forEach(input => input.disabled = !isEditing);
    duzenleBtn.style.display = isEditing ? 'none' : 'inline-block';
    kaydetBtn.style.display = isEditing ? 'inline-block' : 'none';
}

function showMakbuzOnayEkrani() {
    const brutTutarStr = document.getElementById('mm-net-tutar').textContent;
    const brutTutar = parseFloat(brutTutarStr.replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0;

    if (brutTutar <= 0) {
        return showToast("Makbuz oluÅŸturmak iÃ§in pozitif bir tutar olmalÄ±dÄ±r.", true);
    }

    const cariAdi = document.getElementById('mmCariArama').value;
    const kesintiler = calculateDeductions(brutTutar);

    document.getElementById('onay-cari-adi').textContent = cariAdi;
    document.getElementById('onay-brut-tutar').textContent = formatCurrency(kesintiler.brutTutar);
    document.getElementById('onay-gv').textContent = `(-) ${formatCurrency(kesintiler.gelirVergisiTevkifati)}`;
    document.getElementById('onay-sgk').textContent = `(-) ${formatCurrency(kesintiler.sgkTevkifati)}`;
    document.getElementById('onay-borsa').textContent = `(-) ${formatCurrency(kesintiler.borsaTescilUcreti)}`;
    document.getElementById('onay-net-tutar').textContent = formatCurrency(kesintiler.netTutar);

    const overlay = document.getElementById('makbuz-onay-modal-overlay');
    const confirmBtn = document.getElementById('makbuz-onay-confirm');
    const cancelBtn = document.getElementById('makbuz-onay-cancel');

    const confirmClickHandler = () => {
        handleMakbuzOlustur(); // AsÄ±l makbuz oluÅŸturma fonksiyonu burada Ã§aÄŸrÄ±lÄ±r
        overlay.classList.remove('show');
        confirmBtn.replaceWith(confirmBtn.cloneNode(true)); // listener'Ä± temizle
    };
    
    confirmBtn.onclick = confirmClickHandler;
    cancelBtn.onclick = () => overlay.classList.remove('show');
    overlay.classList.add('show');
}

function recalculateMmTotals() {
    const tableBody = document.getElementById('mm-hareket-tablosu-body');
    const devirBakiyeStr = document.getElementById('mm-devir-bakiye').textContent || '0';
    const devredenBakiye = parseFloat(devirBakiyeStr.replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0;

    let donemToplamAlacak = 0;
    let donemToplamBorc = 0;

    tableBody.querySelectorAll('tr').forEach(row => {
        if (row.classList.contains('editable-row')) {
            const miktar = parseFloat(row.querySelector('.mm-input-miktar')?.value) || 0;
            const fiyat = parseFloat(row.querySelector('.mm-input-fiyat')?.value) || 0;
            const tutar = miktar * fiyat;
            const tur = row.dataset.tur;

            const borcTd = row.querySelector('.col-borc');
            const alacakTd = row.querySelector('.col-alacak');

            if (tur === 'yem' || tur === 'odeme_borc') {
                borcTd.textContent = formatCurrency(tutar);
                alacakTd.textContent = '';
                donemToplamBorc += tutar;
            } else if (tur === 'sut' || tur === 'odeme_alacak') {
                alacakTd.textContent = formatCurrency(tutar);
                borcTd.textContent = '';
                donemToplamAlacak += tutar;
            }
        } else { // Sabit, veritabanÄ±ndan gelen satÄ±rlar
            const borcText = row.cells[5].textContent;
            const alacakText = row.cells[6].textContent;
            donemToplamBorc += parseFloat(borcText.replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0;
            donemToplamAlacak += parseFloat(alacakText.replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0;
        }
    });

    document.getElementById('mm-toplam-alacak').textContent = formatCurrency(donemToplamAlacak);
    document.getElementById('mm-toplam-borc').textContent = formatCurrency(donemToplamBorc);

    const netTutar = devredenBakiye + donemToplamAlacak - donemToplamBorc;
    const netTutarElement = document.getElementById('mm-net-tutar');
    netTutarElement.textContent = `${formatCurrency(netTutar)} (${netTutar >= 0 ? 'Cari AlacaklÄ±' : 'Cari BorÃ§lu'})`;
    netTutarElement.style.color = netTutar >= 0 ? 'green' : 'red';
}



function createMmEditableRow(type) {
    const tableBody = document.getElementById('mm-hareket-tablosu-body');
    if (tableBody.rows.length === 1 && tableBody.rows[0].cells.length === 1) {
        tableBody.innerHTML = '';
    }

    const newRow = tableBody.insertRow();
    newRow.className = 'editable-row'; // Bu class'Ä± hesaplama iÃ§in kullanacaÄŸÄ±z

    let contentHTML = '';
    const today = getTodayForInput();

    if (type === 'sut') {
        newRow.dataset.tur = 'sut';
        contentHTML = `
            <td><input type="date" class="form-control" value="${today}"></td>
            <td>SÃ¼t AlÄ±mÄ± (Manuel)</td>
            <td><input type="text" class="form-control" placeholder="AÃ§Ä±klama (Ã¶rn: Sabah SÃ¼tÃ¼)"></td>
            <td><input type="number" class="form-control mm-input-miktar" placeholder="Litre" step="0.1" oninput="recalculateMmTotals()"></td>
            <td><input type="number" class="form-control mm-input-fiyat" placeholder="Fiyat" step="0.01" value="${globalSettings.defaultMilkPrice || ''}" oninput="recalculateMmTotals()"></td>
            <td class="col-borc" style="text-align:right;"></td>
            <td class="col-alacak" style="text-align:right;"></td>
            <td class="dont-print"><button class="btn btn-delete btn-sm" onclick="this.closest('tr').remove(); recalculateMmTotals();">X</button></td>
        `;
    } else if (type === 'yem') {
        newRow.dataset.tur = 'yem';
        let yemOptions = '<option value="">Yem SeÃ§iniz...</option>';
        window.yemDataMap.forEach((yem, id) => {
            yemOptions += `<option value="${id}" data-fiyat="${yem.satisFiyati || 0}">${yem.ad} (Stok: ${yem.stokMiktari || 0})</option>`;
        });

        contentHTML = `
            <td><input type="date" class="form-control" value="${today}"></td>
            <td>Yem SatÄ±ÅŸÄ± (Manuel)</td>
            <td>
                <select class="form-control mm-select-yem" onchange="this.closest('tr').querySelector('.mm-input-fiyat').value = this.options[this.selectedIndex].dataset.fiyat; recalculateMmTotals();">
                    ${yemOptions}
                </select>
            </td>
            <td><input type="number" class="form-control mm-input-miktar" placeholder="Adet" step="1" oninput="recalculateMmTotals()"></td>
            <td><input type="number" class="form-control mm-input-fiyat" placeholder="Fiyat" step="0.01" oninput="recalculateMmTotals()"></td>
            <td class="col-borc" style="text-align:right;"></td>
            <td class="col-alacak" style="text-align:right;"></td>
            <td class="dont-print"><button class="btn btn-delete btn-sm" onclick="this.closest('tr').remove(); recalculateMmTotals();">X</button></td>
        `;
    } else if (type === 'odeme') {
        newRow.dataset.tur = 'odeme_alacak';
        contentHTML = `
            <td><input type="date" class="form-control" value="${today}"></td>
            <td>
                <select class="form-control" onchange="this.closest('tr').dataset.tur = this.value; recalculateMmTotals();">
                    <option value="odeme_alacak">Tahsilat (Para GiriÅŸi)</option>
                    <option value="odeme_borc">Ã–deme (Para Ã‡Ä±kÄ±ÅŸÄ±)</option>
                </select>
            </td>
            <td><input type="text" class="form-control" placeholder="AÃ§Ä±klama (Ã¶rn: Nakit Ã–deme)"></td>
            <td><input type="number" class="form-control mm-input-miktar" value="1" readonly style="display:none;"></td> <td><input type="number" class="form-control mm-input-fiyat" placeholder="Tutar" step="0.01" oninput="recalculateMmTotals()"></td>
            <td class="col-borc" style="text-align:right;"></td>
            <td class="col-alacak" style="text-align:right;"></td>
            <td class="dont-print"><button class="btn btn-delete btn-sm" onclick="this.closest('tr').remove(); recalculateMmTotals();">X</button></td>
        `;
    }

    newRow.innerHTML = contentHTML;
    recalculateMmTotals(); // Ekledikten sonra toplamlarÄ± bir kez daha hesapla
}

async function getSettings() {
    const settingsRef = doc(db, 'ayarlar', sahipId);
    try {
        const docSnap = await getDoc(settingsRef);
        if (docSnap.exists()) {
            globalSettings = docSnap.data();

            const sutFiyatiInput = document.getElementById('varsayilanSutFiyati');
            if (sutFiyatiInput) {
                sutFiyatiInput.value = (globalSettings.defaultMilkPrice || 0).toFixed(2);
            }

            const firmaProfili = globalSettings.firmaProfili || {};
            document.getElementById('firmaUnvani').value = firmaProfili.unvan || '';
            document.getElementById('firmaAdresi').value = firmaProfili.adres || '';
            document.getElementById('firmaVergiDairesi').value = firmaProfili.vergiDairesi || '';
            document.getElementById('firmaVkn').value = firmaProfili.vkn || '';
            document.getElementById('firmaTicSicilNo').value = firmaProfili.ticSicilNo || '';
            document.getElementById('firmaTelefon').value = firmaProfili.telefon || '';
            
        } else {
            globalSettings = { defaultMilkPrice: 0, firmaProfili: null };
        }

    } catch(e) { 
        console.error("Ayarlar alÄ±nÄ±rken hata: ", e);
        showToast("Ayarlar yÃ¼klenirken bir hata oluÅŸtu.", true);
    } finally {
        toggleFirmaBilgileriEdit(false);
    }
}

function populatePeriodSelect() {
        const selectEl = document.getElementById('karneRaporuPeriyotSecimi');
        if (!selectEl) return;
        const now = new Date();
        const ayIsimleri = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
        let optionsHTML = '';
        for (let i = 0; i < 6; i++) {
            let date = new Date(now.getFullYear(), now.getMonth() - i, 1);
            let year = date.getFullYear();
            let month = date.getMonth();
            let monthStr = String(month + 1).padStart(2, '0');
            let monthName = ayIsimleri[month];
            let lastDay = new Date(year, month + 1, 0).getDate();
            optionsHTML += `<option value="${year}-${monthStr}-2">${monthName} ${year} - 2. YarÄ± (16-${lastDay})</option>`;
            optionsHTML += `<option value="${year}-${monthStr}-1">${monthName} ${year} - 1. YarÄ± (1-15)</option>`;
        }
        selectEl.innerHTML = optionsHTML;
    }

 async function handleAyarlarKaydet(event) {
    event.preventDefault();
    const formId = event.target.id;
    try {
        if (formId === 'ayarlarForm') {
        } else if (formId === 'firmaBilgileriForm') {
            const firmaProfili = {
                unvan: document.getElementById('firmaUnvani').value,
                adres: document.getElementById('firmaAdresi').value,
                vergiDairesi: document.getElementById('firmaVergiDairesi').value,
                vkn: document.getElementById('firmaVkn').value,
                ticSicilNo: document.getElementById('firmaTicSicilNo').value,
                telefon: document.getElementById('firmaTelefon').value,
            };
            await setDoc(doc(db, 'ayarlar', sahipId), { firmaProfili }, { merge: true });
            globalSettings.firmaProfili = firmaProfili;
            showToast('Firma bilgileri kaydedildi.');
            toggleFirmaBilgileriEdit(false);
        }
    } catch (error) { /* ... */ }
}

    async function handleSifreDegistir(event) {
        event.preventDefault();
        const eskiSifre = document.getElementById('eskiSifre').value;
        const yeniSifre = document.getElementById('yeniSifre').value;
        const yeniSifreTekrar = document.getElementById('yeniSifreTekrar').value;
        if(!yeniSifre || yeniSifre.length < 6) { showToast("Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r!", true); return; }
        if(yeniSifre !== yeniSifreTekrar) { showToast("Yeni ÅŸifreler uyuÅŸmuyor!", true); return; }
        const user = auth.currentUser;
        if (!user) { showToast("LÃ¼tfen giriÅŸ yapÄ±n.", true); return; }
        const credential = EmailAuthProvider.credential(user.email, eskiSifre);
        try {
            await reauthenticateWithCredential(user, credential);
            await updatePassword(user, yeniSifre);
            showToast("Åifreniz baÅŸarÄ±yla gÃ¼ncellendi!");
            document.getElementById('sifreDegistirForm').reset();
        } catch (error) {
            console.error("Åifre gÃ¼ncelleme hatasÄ±:", error);
            showToast("Eski ÅŸifre hatalÄ± veya bir sorun oluÅŸtu.", true);
        }
    }
    
    async function updateMonthlyStats() {
    try {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const ayinIlkGunu = new Date(year, month, 1);
        const yyyy = ayinIlkGunu.getFullYear();
        const mm = String(ayinIlkGunu.getMonth() + 1).padStart(2, '0');
        const startDateStr = `${yyyy}-${mm}-01`;
        const ayinSonGunu = new Date(year, month + 1, 0);
        const dd_end = String(ayinSonGunu.getDate()).padStart(2, '0');
        const endDateStr = `${yyyy}-${mm}-${dd_end}`;

        const q = query(
            collection(db, 'sut_alimlari'),
            where("sahipId", "==", sahipId),
            where("tarih", ">=", startDateStr),
            where("tarih", "<=", endDateStr)
        );
        const thisMonthSutSnapshot = await getDocs(q);

        let buAykiToplamSut = 0;
        let buAykiToplamDeger = 0;
        thisMonthSutSnapshot.forEach(doc => {
            const alim = doc.data();
            if (alim.islemKaynagi !== 'tank-aktarim') {
                buAykiToplamSut += alim.toplam || 0;
                buAykiToplamDeger += alim.toplamTutar || 0;
            }
        });
        const bugunAyinKaci = now.getDate();
        const gunlukOrtalama = (buAykiToplamSut > 0) ? (buAykiToplamSut / bugunAyinKaci) : 0;
        document.getElementById('dashBuAykiToplamSut').textContent = Math.floor(buAykiToplamSut);
        document.getElementById('dashBuAykiSutDegeri').textContent = formatCurrency(buAykiToplamDeger);
        document.getElementById('aylikGunOrtalamasi').textContent = gunlukOrtalama.toFixed(1);
    } catch(e) {
        console.error("AylÄ±k sÃ¼t istatistikleri alÄ±nÄ±rken hata:", e);
        document.getElementById('dashBuAykiToplamSut').textContent = 'Hata';
        document.getElementById('dashBuAykiSutDegeri').textContent = 'Hata';
    }
}

async function updateDashboardStats() {
    const cacheKey = `dashboard_stats_main`;
    const now = Date.now();
    if (globalCache.has(cacheKey)) {
        const cachedItem = globalCache.get(cacheKey);
        if (now - cachedItem.timestamp < CACHE_TTL_SECONDS * 1000) {
            return;
        }
    }
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        const formatForDB = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const todayStr = formatForDB(today);
        const yesterdayStr = formatForDB(yesterday);
        const formatForDisplay = (date) => {
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
        };
        const todayLabel = formatForDisplay(today);
        const todaySutPromise = getDocs(query(collection(db, 'sut_alimlari'), where("sahipId", "==", sahipId), where("tarih", "==", todayStr)));
        const yesterdaySutPromise = getDocs(query(collection(db, 'sut_alimlari'), where("sahipId", "==", sahipId), where("tarih", "==", yesterdayStr)));
        const carilerPromise = getDocs(query(collection(db, 'cariler'), where("sahipId", "==", sahipId), where("durum", "==", "aktif")));
        const yemlerPromise = getDocs(query(collection(db, 'yemler'), where("sahipId", "==", sahipId)));

        const [todaySnapshot, yesterdaySnapshot, carilerSnapshot, yemlerSnapshot] = await Promise.all([
            todaySutPromise,
            yesterdaySutPromise,
            carilerPromise,
            yemlerPromise
        ]);
        const getSutData = (snapshot) => {
            if (snapshot.empty) return { sabah: 0, aksam: 0 };
            let totalSabah = 0, totalAksam = 0;
            snapshot.forEach(doc => {
                totalSabah += doc.data().sabah || 0;
                totalAksam += doc.data().aksam || 0;
            });
            return { sabah: totalSabah, aksam: totalAksam };
        };
        const todayData = getSutData(todaySnapshot);
        const yesterdayData = getSutData(yesterdaySnapshot);
        const bugunkuToplamSut = todayData.sabah + todayData.aksam;
        const dunkuToplamSut = yesterdayData.sabah + yesterdayData.aksam;
        const fark = bugunkuToplamSut - dunkuToplamSut;
        const karsilastirmaEl = document.getElementById('dunKarsilastirma');
        if (fark > 0) {
            karsilastirmaEl.textContent = `(DÃ¼ne gÃ¶re +${fark.toFixed(2)} Lt)`;
            karsilastirmaEl.style.color = 'green';
        } else if (fark < 0) {
            karsilastirmaEl.textContent = `(DÃ¼ne gÃ¶re ${fark.toFixed(2)} Lt)`;
            karsilastirmaEl.style.color = 'red';
        } else {
            karsilastirmaEl.textContent = '(DÃ¼ne gÃ¶re deÄŸiÅŸiklik yok)';
            karsilastirmaEl.style.color = '#7f8c8d';
        }
        document.getElementById('dashToplamSut').textContent = bugunkuToplamSut.toFixed(2);
        document.getElementById('dashSabahSut').textContent = todayData.sabah.toFixed(2);
        document.getElementById('dashAksamSut').textContent = todayData.aksam.toFixed(2);
        document.getElementById('dashAktifMusteri').textContent = carilerSnapshot.size;
        document.getElementById('sabahSutTarih').textContent = `(${todayLabel})`;
        document.getElementById('aksamSutTarih').textContent = `(${todayLabel})`;
        document.getElementById('toplamSutTarihAraligi').textContent = `${todayLabel} ToplamÄ±`;
        document.getElementById('dashYemSayisi').textContent = yemlerSnapshot.size;

    } catch (e) { console.error("Dashboard gÃ¼nlÃ¼k istatistikleri alÄ±nÄ±rken hata", e); }
    try {
        const allCarilerSnapshot = await getDocs(query(collection(db, 'cariler'), where("sahipId", "==", sahipId), where("cariGrup", "array-contains", "Ã¼retici")));
        
        let toplamMusteriBorcu = 0;
        let toplamMusteriAlacagi = 0;
        if (!allCarilerSnapshot.empty) {
            const bakiyePromises = allCarilerSnapshot.docs.map(doc => calculateCariBakiyeDetayli(doc.id));
            const tumBakiyeler = await Promise.all(bakiyePromises);
            tumBakiyeler.forEach(bakiyeDetay => {
                if (bakiyeDetay.bakiye > 0) {
                    toplamMusteriAlacagi += bakiyeDetay.bakiye;
                } else {
                    toplamMusteriBorcu += Math.abs(bakiyeDetay.bakiye);
                }
            });
        }
        document.getElementById('dashToplamAlacak').textContent = formatCurrency(toplamMusteriBorcu);
        document.getElementById('dashToplamBorc').textContent = formatCurrency(toplamMusteriAlacagi);
        const toplamBakiye = toplamMusteriAlacagi - toplamMusteriBorcu;
        const toplamBakiyeSpan = document.getElementById('dashToplamBakiye');
        const bakiyeUyariSpan = document.getElementById('bakiyeDurumUyarisi');
        const bakiyeKarti = document.getElementById('bakiyeDurumKarti');
        toplamBakiyeSpan.textContent = formatCurrency(toplamBakiye);
        if (toplamBakiye < 0) {
            bakiyeUyariSpan.textContent = "Genel Bakiye BorÃ§lu!";
            bakiyeUyariSpan.style.color = 'red';
            toplamBakiyeSpan.style.color = 'red';
            bakiyeKarti.style.borderColor = 'red';
        } else {
            bakiyeUyariSpan.textContent = "Genel Bakiye AlacaklÄ±";
            bakiyeUyariSpan.style.color = 'green';
            toplamBakiyeSpan.style.color = 'green';
            bakiyeKarti.style.borderColor = '#ddd';
        }
        const total = toplamMusteriBorcu + toplamMusteriAlacagi;
        const alacakYuzde = total > 0 ? (toplamMusteriBorcu / total) * 100 : 0;
        const borcYuzde = total > 0 ? (toplamMusteriAlacagi / total) * 100 : 0;
        document.getElementById('alacakBar').style.width = alacakYuzde + '%';
        document.getElementById('borcBar').style.width = borcYuzde + '%';
    } catch (e) { console.error("Dashboard bakiye toplamlarÄ± alÄ±nÄ±rken hata", e); }
    try {
        if (typeof renderGunlukSutGrafik === 'function') await renderGunlukSutGrafik();
        const aylikChartInput = document.getElementById('aylikChartAySecimi');
        if (aylikChartInput && !aylikChartInput.value) {
            aylikChartInput.value = getMonthYearForInput();
        }
        if (typeof renderAylikSutunGrafik === 'function') await renderAylikSutunGrafik();
    } catch(e) { console.error("Kontrol paneli grafikleri oluÅŸturulurken hata", e); }
    
    globalCache.set(cacheKey, { data: true, timestamp: now });
}


async function handleCariKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) {
        showToast("LÃ¼tfen giriÅŸ yapÄ±n.", true);
        return;
    }

    const editingId = document.getElementById('cariEditId').value;
    const secilenGruplar = [];
    if (document.getElementById('grupUretici').checked) secilenGruplar.push('Ã¼retici');
    if (document.getElementById('grupTedarikci').checked) secilenGruplar.push('tedarikÃ§i');
    if (document.getElementById('grupSutAlici').checked) secilenGruplar.push('sÃ¼t alÄ±cÄ±');
    const rotaSirasiInput = document.getElementById('cariRotaSirasi').value;
    const yeniRotaSirasi = rotaSirasiInput ? parseInt(rotaSirasiInput, 10) : null;

    const formData = {
    kodu: document.getElementById('cariKodu').value,
    rotaSirasi: yeniRotaSirasi,
    adiSoyadi: document.getElementById('cariAdiSoyadi').value,
    kategori: document.getElementById('cariKategori').value,
    durum: document.getElementById('cariDurum').value,
    cariTipi: document.getElementById('cariTipi').value,
    cariGrup: secilenGruplar,
    telefon: document.getElementById('cariTelefon').value,
    eposta: document.getElementById('cariEposta').value,
    adres: document.getElementById('cariAdres').value,
    bankaAdi: document.getElementById('cariBankaAdi').value,
    iban: document.getElementById('cariIban').value,
    vergiDairesi: document.getElementById('cariVergiDairesi').value,
    vergiNo: document.getElementById('cariVergiNo').value,
    notlar: document.getElementById('cariNotlar').value,
    sahipId: sahipId,
    eMustahsilParams: {
        borsaTesciliVar: document.getElementById('paramBorsaTescili').checked,
        sgkKesintisiUygula: document.getElementById('paramSgkKesintisi').checked,
        stopajOrani: parseFloat(document.getElementById('paramStopajOrani').value) || 0,
        borsaTescilOrani: parseFloat(document.getElementById('paramBorsaTescilOrani').value) || 0
    }
};

    try {
        const batch = writeBatch(db);
        let eskiRotaSirasi = null;

        if (editingId) {
            const cariRef = doc(db, 'cariler', editingId);
            const cariDoc = await getDoc(cariRef);
            if (!cariDoc.exists()) throw new Error("DÃ¼zenlenecek cari bulunamadÄ±!");
            eskiRotaSirasi = cariDoc.data().rotaSirasi;
        }

        if (eskiRotaSirasi !== yeniRotaSirasi) {
            if (yeniRotaSirasi && eskiRotaSirasi) {
                 if (yeniRotaSirasi > eskiRotaSirasi) { // AÅŸaÄŸÄ± kaydÄ±rma (2 -> 5)
                    const q = query(collection(db, 'cariler'), where('sahipId', '==', sahipId), where('rotaSirasi', '>', eskiRotaSirasi), where('rotaSirasi', '<=', yeniRotaSirasi));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(d => batch.update(d.ref, { rotaSirasi: d.data().rotaSirasi - 1 }));
                } else { // YukarÄ± kaydÄ±rma (5 -> 2)
                    const q = query(collection(db, 'cariler'), where('sahipId', '==', sahipId), where('rotaSirasi', '>=', yeniRotaSirasi), where('rotaSirasi', '<', eskiRotaSirasi));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(d => batch.update(d.ref, { rotaSirasi: d.data().rotaSirasi + 1 }));
                }
            }
            else if (yeniRotaSirasi) {
                const q = query(collection(db, 'cariler'), where('sahipId', '==', sahipId), where('rotaSirasi', '>=', yeniRotaSirasi));
                const snapshot = await getDocs(q);
                snapshot.forEach(d => batch.update(d.ref, { rotaSirasi: d.data().rotaSirasi + 1 }));
            }
            else if (eskiRotaSirasi) {
                 const q = query(collection(db, 'cariler'), where('sahipId', '==', sahipId), where('rotaSirasi', '>', eskiRotaSirasi));
                 const snapshot = await getDocs(q);
                 snapshot.forEach(d => batch.update(d.ref, { rotaSirasi: d.data().rotaSirasi - 1 }));
            }
        }
        
        await batch.commit();
        await runTransaction(db, async (transaction) => {
            let cariIdForBakiye;

            if (editingId) {
                cariIdForBakiye = editingId;
                const cariRef = doc(db, 'cariler', editingId);
                transaction.update(cariRef, formData);

                const acilisBakiyeQuery = query(collection(db, 'odemeVeTahsilatlar'), where('cariId', '==', editingId), where('aciklama', '==', 'AÃ§Ä±lÄ±ÅŸ Bakiyesi'));
                const acilisBakiyeSnapshot = await getDocs(acilisBakiyeQuery);
                acilisBakiyeSnapshot.forEach(docToDelete => {
                    transaction.delete(docToDelete.ref);
                });

            } else { // Yeni kayÄ±t
                const newCariRef = doc(collection(db, 'cariler'));
                transaction.set(newCariRef, formData);
                cariIdForBakiye = newCariRef.id;
            }

            const acilisBakiye = parseFloat(document.getElementById('cariAcilisBakiye').value) || 0;
            const bakiyeTuru = document.getElementById('cariAcilisBakiyeTuru').value;
            if (acilisBakiye > 0 && bakiyeTuru !== 'yok') {
                const bakiyeData = {
                    aciklama: "AÃ§Ä±lÄ±ÅŸ Bakiyesi",
                    cariId: cariIdForBakiye,
                    islemTuru: bakiyeTuru,
                    sahipId: sahipId,
                    tarih: new Date(1990, 0, 1).toISOString().split('T')[0],
                    tutar: acilisBakiye,
                    odemeTuru: 'Sistem'
                };
                const odemeRef = doc(collection(db, 'odemeVeTahsilatlar'));
                transaction.set(odemeRef, bakiyeData);
            }
        });

        resetCariForm();
        await renderCariListesi();
        showToast('Cari baÅŸarÄ±yla kaydedildi!');

    } catch (error) {
        console.error("Cari kaydedilirken hata: ", error);
        showToast("Cari kaydedilirken bir hata oluÅŸtu: " + error.message, true);
    }
}



async function renderCariListesi() {
    const cariListesiBody     = document.getElementById('cariListesiBody');
    const cariListesiFooter   = document.getElementById('cariListesiFooter');
    const tarihFiltresiEl     = document.getElementById('cariTarihFiltresi');
    const searchTermEl        = document.getElementById('cariSearchInput');
    const kategoriEl          = document.getElementById('cariKategoriFiltre');
    const durumEl             = document.getElementById('cariDurumFiltre');
    const grupEl              = document.getElementById('cariGrupFiltre');
    const raporTarihEtiketiEl = document.getElementById('raporTarihEtiketi');
    const tarihFiltresi = tarihFiltresiEl ? tarihFiltresiEl.value : '';
    const searchTerm    = searchTermEl    ? searchTermEl.value.toLowerCase() : '';
    const kategori      = kategoriEl      ? kategoriEl.value : '';
    const durum         = durumEl         ? durumEl.value : '';
    const grup          = grupEl          ? grupEl.value : '';

    if (raporTarihEtiketiEl) {
        raporTarihEtiketiEl.textContent = tarihFiltresi
            ? `${formatDate(tarihFiltresi)} Tarihi Ä°tibarÄ±yla`
            : 'GÃ¼ncel Durum';
    }

    if (cariListesiBody) {
        cariListesiBody.innerHTML = '<tr><td colspan="11" style="text-align:center;">Veriler yÃ¼kleniyor ve hesaplanÄ±yor...</td></tr>';
    }
    if (cariListesiFooter) {
        cariListesiFooter.innerHTML = '';
    }

    try {
        const cariConstraints = [ where('sahipId', '==', sahipId) ];
        if (kategori) cariConstraints.push(where('kategori','==',kategori));
        if (durum)    cariConstraints.push(where('durum','==',durum));
        if (grup)     cariConstraints.push(where('cariGrup','array-contains',grup));

        const carilerQuery = query(
            collection(db, 'cariler'),
            ...cariConstraints,
            orderBy('rotaSirasi','asc'),
            limit(200)
        );

        const hareketConstraints = [ where('sahipId','==',sahipId) ];
        if (tarihFiltresi) hareketConstraints.push(where('tarih','<=',tarihFiltresi));

        const sutQuery      = query(collection(db,'sut_alimlari'),       ...hareketConstraints);
        const yemSatisQuery = query(collection(db,'yem_satislari'),      ...hareketConstraints);
        const odemeQuery    = query(collection(db,'odemeVeTahsilatlar'), ...hareketConstraints);
        const yemAlimQuery  = query(collection(db,'yem_alimlari'),       ...hareketConstraints);

        const [
            carilerSnapshot,
            sutSnapshot,
            yemSatisSnapshot,
            odemeSnapshot,
            yemAlimSnapshot
        ] = await Promise.all([
            getDocs(carilerQuery),
            getDocs(sutQuery),
            getDocs(yemSatisQuery),
            getDocs(odemeQuery),
            getDocs(yemAlimQuery)
        ]);

        const bakiyeMap = new Map();
        carilerSnapshot.forEach(docSnap => {
            bakiyeMap.set(docSnap.id, { data: docSnap.data(), borc: 0, alacak: 0 });
        });

        sutSnapshot.forEach(d => {
            const v = d.data();
            if (bakiyeMap.has(v.cariId)) bakiyeMap.get(v.cariId).alacak += v.toplamTutar || 0;
        });
        yemAlimSnapshot.forEach(d => {
            const v = d.data();
            if (bakiyeMap.has(v.cariId)) bakiyeMap.get(v.cariId).alacak += v.toplamTutar || 0;
        });
        yemSatisSnapshot.forEach(d => {
            const v = d.data();
            if (bakiyeMap.has(v.cariId)) bakiyeMap.get(v.cariId).borc += v.toplamTutar || 0;
        });
        odemeSnapshot.forEach(d => {
            const v = d.data();
            if (bakiyeMap.has(v.cariId)) {
                const entry = bakiyeMap.get(v.cariId);
                if (v.islemTuru === 'odeme' || v.islemTuru === 'alacak') entry.alacak += v.tutar || 0;
                else if (v.islemTuru === 'tahsilat' || v.islemTuru === 'borc') entry.borc += v.tutar || 0;
            }
        });

        let cariler = Array.from(bakiyeMap.entries());
        if (searchTerm) {
            cariler = cariler.filter(([id,item]) => {
                const c = item.data;
                return c.kodu?.toLowerCase().includes(searchTerm)
                    || c.adiSoyadi?.toLowerCase().includes(searchTerm);
            });
        }
        cariler.sort((a,b) => {
            const ra = a[1].data.rotaSirasi || 9999;
            const rb = b[1].data.rotaSirasi || 9999;
            if (ra !== rb) return ra - rb;
            return (a[1].data.adiSoyadi||'').localeCompare(b[1].data.adiSoyadi||'', 'tr');
        });

        if (cariler.length === 0) {
            if (cariListesiBody) {
                cariListesiBody.innerHTML = '<tr><td colspan="11" style="text-align:center;">Filtreye uygun cari bulunmuyor.</td></tr>';
            }
            return;
        }

        let rowsHTML = '';
        let toplamBorc = 0, toplamAlacak = 0;
        let detayAlacak = 0, detayBorc = 0;

        cariler.forEach(([id,item]) => {
            const c = item.data;
            const borc   = item.borc;
            const alacak = item.alacak;
            const bakiye = alacak - borc;

            toplamBorc   += borc;
            toplamAlacak += alacak;
            if (bakiye >= 0) detayAlacak += bakiye;
            else detayBorc += Math.abs(bakiye);

            const durumStyle  = c.durum === 'aktif' ? 'color:green;' : 'color:red;';
            const bakiyeStyle = bakiye >= 0      ? 'color:green;' : 'color:red;';
            const bakiyeText  = `${formatCurrency(bakiye)} ${bakiye>=0? '(A)':'(B)'}`;

            rowsHTML += `
              <tr>
                <td>${c.kodu       ?? ''}</td>
                <td>${c.adiSoyadi  ?? ''}</td>
                <td>${c.kategori   ?? ''}</td>
                <td>${c.cariGrup? c.cariGrup.join(', '): 'â€”'}</td>
                <td>${c.rotaSirasi ?? ''}</td>
                <td style="${durumStyle}">${c.durum==='aktif'?'Aktif':'Pasif'}</td>
                <td>${c.telefon    ?? ''}</td>
                <td>${formatCurrency(borc)}</td>
                <td>${formatCurrency(alacak)}</td>
                <td style="${bakiyeStyle}">${bakiyeText}</td>
                <td class="dont-print" style="white-space:nowrap;">
                  <button class="btn btn-edit btn-sm"   onclick="editCari('${id}')">DÃ¼zenle</button>
                  <button class="btn btn-delete btn-sm" onclick="deleteCari('${id}')">Sil</button>
                </td>
              </tr>`;
        });

        const netBakiye = toplamAlacak - toplamBorc;
        const netStyle  = netBakiye >= 0 ? 'color:green;' : 'color:red;';

        const footerHTML = `
          <tr style="background:#f8f9fa;font-weight:bold;">
            <td colspan="7">GENEL TOPLAM</td>
            <td>${formatCurrency(toplamBorc)}</td>
            <td>${formatCurrency(toplamAlacak)}</td>
            <td style="${netStyle}">${formatCurrency(netBakiye)}</td>
            <td class="dont-print"></td>
          </tr>
          <tr style="background:#f8f9fa;">
            <td colspan="9" style="text-align:right;"><strong>Bakiye (AlacaklÄ± MÃ¼ÅŸteriler):</strong></td>
            <td style="color:green;font-weight:bold;">${formatCurrency(detayAlacak)}</td>
            <td class="dont-print"></td>
          </tr>
          <tr style="background:#f8f9fa;">
            <td colspan="9" style="text-align:right;"><strong>Bakiye (BorÃ§lu MÃ¼ÅŸteriler):</strong></td>
            <td style="color:red;font-weight:bold;">${formatCurrency(detayBorc)}</td>
            <td class="dont-print"></td>
          </tr>`;

        // Son olarak DOM gÃ¼ncellemesi
        if (cariListesiBody)   cariListesiBody.innerHTML   = rowsHTML;
        if (cariListesiFooter) cariListesiFooter.innerHTML = footerHTML;

    } catch (error) {
        console.error("Cariler listelenirken hata:", error);
        if (cariListesiBody) {
            cariListesiBody.innerHTML =
              `<tr><td colspan="11" style="color:red; text-align:center;">
                 Liste yÃ¼klenirken hata oluÅŸtu: ${error.message}
               </td></tr>`;
        }
    }
}

async function updateSayimForm() {
        const yemId = document.getElementById('sayimYemSecimi').value;
        const mevcutStokInput = document.getElementById('sayimMevcutStok');
        const fizikselStokInput = document.getElementById('sayimFizikselStok');
        const farkInput = document.getElementById('sayimFarki');
        if (!yemId) {
            mevcutStokInput.value = '';
            fizikselStokInput.value = '';
            farkInput.value = '';
            return;
        }
        const yemData = window.yemDataMap.get(yemId);
        const mevcutStok = yemData ? yemData.stokMiktari || 0 : 0;
        mevcutStokInput.value = mevcutStok;
        const fizikselStok = parseFloat(fizikselStokInput.value) || 0;
        const fark = fizikselStok - mevcutStok;
        farkInput.value = `${fark > 0 ? '+' : ''}${fark}`;
        farkInput.style.color = fark < 0 ? 'red' : 'green';
    }

async function handleStokSayimKaydet(event) {
        event.preventDefault();
        const tarih = document.getElementById('sayimTarihi').value;
        const yemId = document.getElementById('sayimYemSecimi').value;
        const fizikselStok = parseFloat(document.getElementById('sayimFizikselStok').value);
        const not = document.getElementById('sayimNotu').value;
        if (!tarih || !yemId || isNaN(fizikselStok) || fizikselStok < 0) {
            showToast("LÃ¼tfen tarih, yem ve geÃ§erli bir sayÄ±m miktarÄ± girin.", true);
            return;
        }
        const yemRef = doc(db, 'yemler', yemId);
        const sayimHareketRef = doc(collection(db, 'stok_sayim_hareketleri'));
        try {
            await runTransaction(db, async (transaction) => {
                const yemDoc = await transaction.get(yemRef);
                if (!yemDoc.exists()) {
                    throw new Error("SayÄ±mÄ± yapÄ±lacak yem bulunamadÄ±!");
                }
                const yemData = yemDoc.data();
                const mevcutStok = yemData.stokMiktari || 0;
                const fark = fizikselStok - mevcutStok;
                transaction.update(yemRef, { stokMiktari: fizikselStok });
                transaction.set(sayimHareketRef, {
                    sahipId: sahipId,
                    tarih: tarih,
                    yemId: yemId,
                    yemAdi: yemData.ad,
                    mevcutStok: mevcutStok,
                    fizikselStok: fizikselStok,
                    fark: fark,
                    not: not,
                    kayitZamani: new Date()
                });
            });
            showToast("Stok sayÄ±mÄ± baÅŸarÄ±yla kaydedildi ve yem stoÄŸu gÃ¼ncellendi!");
            document.getElementById('stokSayimForm').reset();
            await Promise.all([
                renderYemStokListesi(), 
                renderStokSayimGecmisi(),
                populateYemSelect(document.getElementById('sayimYemSecimi'))
            ]);
        } catch (error) {
            console.error("Stok sayÄ±mÄ± kaydedilirken hata:", error);
            showToast("Hata: " + error.message, true);
        }
    }


async function renderStokSayimGecmisi() {
    const listBody = document.getElementById('stokSayimGecmisiBody');
    if (!listBody) return;
    listBody.innerHTML = '<tr><td colspan="7">YÃ¼kleniyor...</td></tr>'; // Colspan 7 oldu
    try {
        const q = query(collection(db, 'stok_sayim_hareketleri'), where('sahipId', '==', sahipId), orderBy('kayitZamani', 'desc'), limit(10));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">KayÄ±tlÄ± stok sayÄ±m hareketi bulunmuyor.</td></tr>'; // Colspan 7 oldu
            return;
        }
        let rows = '';
        snapshot.forEach(docSnap => {
            const sayim = docSnap.data();
            const farkStyle = sayim.fark < 0 ? 'color:red;' : 'color:green;';
            const farkText = `${sayim.fark > 0 ? '+' : ''}${sayim.fark}`;
            rows += `<tr>
                <td>${formatDate(sayim.tarih)}</td>
                <td>${sayim.yemAdi}</td>
                <td>${sayim.mevcutStok}</td>
                <td>${sayim.fizikselStok}</td>
                <td style="${farkStyle}; font-weight:bold;">${farkText}</td>
                <td>${sayim.not || ''}</td>
                <td class="dont-print">
                    <button class="btn btn-delete btn-sm" onclick="deleteStokSayimi('${docSnap.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;
    } catch (error) {
        console.error("Stok sayÄ±m geÃ§miÅŸi yÃ¼klenirken hata:", error);
        listBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">GeÃ§miÅŸ yÃ¼klenemedi.</td></tr>'; // Colspan 7 oldu
    }
}

async function deleteStokSayimi(sayimId) {
    if (!sayimId) return;

    showCustomConfirm("Bu stok sayÄ±m kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem, ilgili yemin stoÄŸunu sayÄ±m Ã¶ncesi miktara geri dÃ¶ndÃ¼recektir. Bu iÅŸlem geri alÄ±namaz!", async () => {
        const sayimRef = doc(db, 'stok_sayim_hareketleri', sayimId);
        
        try {
            await runTransaction(db, async (transaction) => {
                const sayimDoc = await transaction.get(sayimRef);
                if (!sayimDoc.exists()) {
                    throw new Error("Silinecek sayÄ±m kaydÄ± bulunamadÄ±.");
                }
                const sayimData = sayimDoc.data();
                const yemRef = doc(db, 'yemler', sayimData.yemId);
                const yemDoc = await transaction.get(yemRef);
                
                if (!yemDoc.exists()) {
                    transaction.delete(sayimRef);
                    return;
                }
                
                const mevcutYemStok = yemDoc.data().stokMiktari;
                if(mevcutYemStok !== sayimData.fizikselStok) {
                    throw new Error("Bu sayÄ±mdan sonra baÅŸka stok hareketleri olmuÅŸ. Veri tutarlÄ±lÄ±ÄŸÄ± iÃ§in silme iÅŸlemi iptal edildi. Ã–nce sonraki hareketleri geri almalÄ±sÄ±nÄ±z.");
                }

                transaction.update(yemRef, { stokMiktari: sayimData.mevcutStok });
                transaction.delete(sayimRef);
            });

            showToast("Stok sayÄ±mÄ± baÅŸarÄ±yla silindi ve stok geri alÄ±ndÄ±.");
            await renderYemStokListesi();
            await renderStokSayimGecmisi();

        } catch (error) {
            console.error("Stok sayÄ±mÄ± silinirken hata:", error);
            showToast("Hata: " + error.message, true);
        }
    });
}



function generateRandomColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            const r = Math.floor(Math.random() * 200);
            const g = Math.floor(Math.random() * 200);
            const b = Math.floor(Math.random() * 200);
            colors.push(`rgba(${r}, ${g}, ${b}, 0.8)`);
        }
        return colors;
    }

async function renderGunlukSutGrafik() {
    if (isGunlukChartRendering) return; // EÄŸer zaten Ã§iziliyorsa, tekrar baÅŸlatma
    isGunlukChartRendering = true;      // Kilidi aktif et

    try {
        const currentUser = auth.currentUser;
        if (!currentUser) return;
        
        const ctx = document.getElementById('gunlukSutGrafik').getContext('2d');
        if (gunlukSutunChartInstance) {
            gunlukSutunChartInstance.destroy();
        }
        
        const tarihStr = getTodayForInput();
        const qAlimlar = query(collection(db, 'sut_alimlari'), where('sahipId', '==', sahipId), where('tarih', '==', tarihStr));
        const alimlarSnapshot = await getDocs(qAlimlar);

        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        if (alimlarSnapshot.empty) {
            ctx.font = "16px Segoe UI"; ctx.fillStyle = "#666"; ctx.textAlign = "center";
            ctx.fillText("BugÃ¼n iÃ§in sÃ¼t alÄ±m verisi bulunmuyor.", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        const qCariler = query(collection(db, 'cariler'), where('sahipId', '==', sahipId), where('cariGrup', 'array-contains', 'Ã¼retici'));
        const carilerSnapshot = await getDocs(qCariler);
        const kategoriMap = new Map();
        carilerSnapshot.forEach(docSnap => {
            kategoriMap.set(docSnap.id, docSnap.data().kategori || 'BelirtilmemiÅŸ');
        });

        const dataByKategori = {};
        alimlarSnapshot.forEach(docSnap => {
            const alim = docSnap.data();
            if (alim.islemKaynagi === 'tank-aktarim') return;
            const kategori = kategoriMap.get(alim.cariId) || 'TanÄ±msÄ±z/DiÄŸer';
            if (!dataByKategori[kategori]) { dataByKategori[kategori] = 0; }
            dataByKategori[kategori] += parseFloat(alim.toplam || 0);
        });

        const labels = Object.keys(dataByKategori);
        const data = Object.values(dataByKategori);
        
        let backgroundColors = [];
        if (data.length > 0) {
            const maxValue = Math.max(...data);
            const minValue = Math.min(...data.filter(val => val > 0));
            backgroundColors = data.map(value => {
                if (value === maxValue) return 'rgba(40, 167, 69, 0.7)';
                else if (value === minValue) return 'rgba(220, 53, 69, 0.7)';
                else return 'rgba(255, 193, 7, 0.7)';
            });
        }
        const maxValueForScale = data.length > 0 ? Math.max(...data) : 0;
        const chartMax = maxValueForScale > 0 ? maxValueForScale * 1.15 : 100;
        
        gunlukSutunChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Toplam SÃ¼t (Lt)', data, backgroundColor: backgroundColors, borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', formatter: (value) => value.toFixed(1) + ' Lt', color: '#333', font: { weight: 'bold' } } }, scales: { y: { beginAtZero: true, max: chartMax } } } });
    
    } catch(error) { 
        console.error("GÃ¼nlÃ¼k sÃ¼t grafiÄŸi oluÅŸturulurken hata:", error); 
    } finally {
        isGunlukChartRendering = false; // Ä°ÅŸlem bitince kilidi serbest bÄ±rak
    }
}

async function renderAylikSutunGrafik() {
    if (isAylikChartRendering) return; // EÄŸer zaten Ã§iziliyorsa, tekrar baÅŸlatma
    isAylikChartRendering = true;      // Kilidi aktif et

    try {
        const ayYil = document.getElementById('aylikChartAySecimi').value;
        const ctx = document.getElementById('aylikSutGrafik').getContext('2d');
        if (aylikSutunChartInstance) {
            aylikSutunChartInstance.destroy();
        }

        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        if (!ayYil) {
            ctx.font = "16px Segoe UI"; ctx.fillStyle = "#666"; ctx.textAlign = "center";
            ctx.fillText("LÃ¼tfen bir ay seÃ§ip 'GrafiÄŸi GÃ¶ster' butonuna basÄ±n.", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        const currentUser = auth.currentUser;
        if (!currentUser) return;
        
        ctx.font = "16px Segoe UI"; ctx.fillStyle = "#666"; ctx.textAlign = "center";
        ctx.fillText("Grafik oluÅŸturuluyor...", ctx.canvas.width / 2, ctx.canvas.height / 2);

        const [year, month] = ayYil.split('-');
        const startDateStr = `${year}-${month}-01`;
        const endDate = new Date(year, month, 0);
        const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
        
        const qAlimlar = query(collection(db, 'sut_alimlari'), where('sahipId', '==', sahipId), where('tarih', '>=', startDateStr), where('tarih', '<=', endDateStr));
        const alimlarSnapshot = await getDocs(qAlimlar);
        
        if (alimlarSnapshot.empty) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillText("Bu ayda sÃ¼t alÄ±mÄ± yok.", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return; 
        }

        const qCariler = query(collection(db, 'cariler'), where('sahipId', '==', sahipId), where('cariGrup', 'array-contains', 'Ã¼retici'));
        const carilerSnapshot = await getDocs(qCariler);
        const kategoriMap = new Map();
        carilerSnapshot.forEach(docSnap => {
            kategoriMap.set(docSnap.id, docSnap.data().kategori || 'BelirtilmemiÅŸ');
        });

        const dataByKategori = {};
        alimlarSnapshot.forEach(docSnap => {
            const alim = docSnap.data();
            if (alim.islemKaynagi === 'tank-aktarim') return;
            const kategori = kategoriMap.get(alim.cariId) || 'TanÄ±msÄ±z/DiÄŸer';
            if (!dataByKategori[kategori]) { dataByKategori[kategori] = 0; }
            dataByKategori[kategori] += parseFloat(alim.toplam || 0);
        });

        const sortedDataArray = Object.entries(dataByKategori).sort((a, b) => b[1] - a[1]);
        const labels = sortedDataArray.map(item => item[0]);
        const data = sortedDataArray.map(item => item[1]);
        
        let backgroundColors = [];
        if (data.length > 0) {
            const maxValue = data[0]; 
            const minValue = data[data.length - 1]; 
            backgroundColors = data.map(value => {
                if (value === maxValue) return 'rgba(40, 167, 69, 0.7)';
                else if (value === minValue) return 'rgba(220, 53, 69, 0.7)';
                else return 'rgba(255, 193, 7, 0.7)';
            });
        }
        
        const maxValueForScale = data.length > 0 ? data[0] : 0;
        const chartMax = maxValueForScale > 0 ? maxValueForScale * 1.15 : 100;
        
        aylikSutunChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Toplam SÃ¼t (Lt)', data, backgroundColor: backgroundColors, borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', formatter: (value) => value.toFixed(0) + ' Lt', color: '#333', font: { weight: 'bold' } } }, scales: { y: { beginAtZero: true, max: chartMax } } } });

    } catch (error) { 
        console.error("AylÄ±k sÃ¼t grafiÄŸi oluÅŸturulurken hata:", error); 
    } finally {
        isAylikChartRendering = false; // Ä°ÅŸlem bitince kilidi serbest bÄ±rak
    }
}
    
async function editCari(id) {
    try {
        const docRef = doc(db, 'cariler', id);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return;
        const cari = docSnap.data() || {};

        editingCariId = id;
        document.getElementById('cariEditId').value       = id;
        document.getElementById('cariKodu').value         = cari.kodu            ?? '';
        document.getElementById('cariRotaSirasi').value   = cari.rotaSirasi != null ? cari.rotaSirasi : '';
        document.getElementById('cariAdiSoyadi').value    = cari.adiSoyadi       ?? '';
        document.getElementById('cariKategori').value     = cari.kategori        ?? '';
        document.getElementById('grupUretici').checked   = false;
        document.getElementById('grupTedarikci').checked = false;
        document.getElementById('grupSutAlici').checked  = false;

        if (Array.isArray(cari.cariGrup)) {
            cari.cariGrup.forEach(grup => {
                if (grup === 'Ã¼retici')    document.getElementById('grupUretici').checked   = true;
                if (grup === 'tedarikÃ§i')  document.getElementById('grupTedarikci').checked = true;
                if (grup === 'sÃ¼t alÄ±cÄ±')  document.getElementById('grupSutAlici').checked  = true;
            });
        }

        document.getElementById('cariDurum').value            = cari.durum       ?? 'aktif';
        document.getElementById('cariTipi').value             = cari.cariTipi    ?? 'sut_ve_yem';
        document.getElementById('cariTelefon').value          = cari.telefon     ?? '';
        document.getElementById('cariAcilisBakiye').disabled  = false;
        document.getElementById('cariAcilisBakiyeTuru').disabled = false;
        
        const acilisBakiyeQuery = query(
            collection(db, 'odemeVeTahsilatlar'),
            where('cariId', '==', id),
            where('aciklama', '==', 'AÃ§Ä±lÄ±ÅŸ Bakiyesi'),
            limit(1)
        );
        const acilisBakiyeSnapshot = await getDocs(acilisBakiyeQuery);

        if (!acilisBakiyeSnapshot.empty) {
            const acilisBakiyeDoc = acilisBakiyeSnapshot.docs[0].data() || {};
            document.getElementById('cariAcilisBakiye').value     = acilisBakiyeDoc.tutar     ?? '';
            document.getElementById('cariAcilisBakiyeTuru').value = acilisBakiyeDoc.islemTuru ?? 'yok';
        } else {
            document.getElementById('cariAcilisBakiye').value     = '';
            document.getElementById('cariAcilisBakiyeTuru').value = 'yok';
        }

        const params = cari.eMustahsilParams || {}; // EÄŸer parametre yoksa boÅŸ nesne ata
        document.getElementById('paramBorsaTescili').checked = params.borsaTesciliVar || false;
        document.getElementById('paramSgkKesintisi').checked = params.sgkKesintisiUygula !== false; 
        document.getElementById('paramStopajOrani').value = params.stopajOrani != null ? params.stopajOrani : 4;
        document.getElementById('paramBorsaTescilOrani').value = params.borsaTescilOrani != null ? params.borsaTescilOrani : '';
        setEditingMode(            
            document.getElementById('cariFormBaslik'),            
            document.getElementById('cariKaydetBtn'),            
            document.getElementById('cariFormTemizleBtn'),            
            id,            
            'Cari'        
        );        
       document.getElementById('cariFormBaslik').scrollIntoView({ behavior: 'smooth' });

    } catch (e) {
        console.error("Cari bilgileri yÃ¼klenirken hata:", e);
    }
}


async function deleteCari(id) {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        showToast("LÃ¼tfen giriÅŸ yapÄ±n.", true);
        return;
    }
    try {
        const cariRef = doc(db, 'cariler', id);
        const cariDoc = await getDoc(cariRef);
        if (!cariDoc.exists()) {
            showToast("Silinecek cari bulunamadÄ±!", true);
            return;
        }
        const cariData = cariDoc.data();
        const cariAdi = cariData.adiSoyadi;
        const cariKodu = cariData.kodu || '';

        const ilkOnayMesaji = `'${cariAdi}' isimli cariyi ve bu cariye ait TÃœM kayÄ±tlarÄ± kalÄ±cÄ± olarak silmek Ã¼zeresiniz. Bu iÅŸlem geri alÄ±namaz! Devam etmek istediÄŸinizden emin misiniz?`;

        showCustomConfirm(ilkOnayMesaji, () => {
            const ikinciOnayMesaji = `SON UYARI! Silme iÅŸlemini onaylamak iÃ§in lÃ¼tfen carinin kodunu (${cariKodu}) aÅŸaÄŸÄ±daki kutucuÄŸa tam olarak yazÄ±n.`;

            showCustomPrompt(ikinciOnayMesaji, async (kullaniciGirdisi) => {
                if (kullaniciGirdisi.trim() !== cariKodu) {
                    showToast("Girilen cari kodu yanlÄ±ÅŸ! Silme iÅŸlemi iptal edildi.", true);
                    return;
                }
                const silinenRotaSirasi = cariData.rotaSirasi;
                const hareketler = ['sut_alimlari', 'yem_alimlari', 'yem_satislari', 'odemeVeTahsilatlar'];
                const hareketSnapshots = [];
                for (const koleksiyon of hareketler) {
                    const q = query(collection(db, koleksiyon), where('cariId', '==', id), where('sahipId', '==', sahipId));
                    hareketSnapshots.push(await getDocs(q));
                }
                let carilerToUpdateSnapshot = null;
                if (silinenRotaSirasi) {
                    const q_rota = query(collection(db, 'cariler'), where('sahipId', '==', sahipId), where('rotaSirasi', '>', silinenRotaSirasi));
                    carilerToUpdateSnapshot = await getDocs(q_rota);
                }
                await runTransaction(db, async (transaction) => {
                    hareketSnapshots.forEach(snapshot => snapshot.forEach(doc => transaction.delete(doc.ref)));
                    if (carilerToUpdateSnapshot) {
                        carilerToUpdateSnapshot.forEach(doc => transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi - 1 }));
                    }
                    transaction.delete(cariRef);
                });
                await renderCariListesi();
                showToast(`'${cariAdi}' isimli cari ve tÃ¼m hareketleri baÅŸarÄ±yla silindi.`);
            }, "ğŸ›‘ SON UYARI!");
        }, "âš ï¸ DÄ°KKAT!");
    } catch (error) {
        console.error("Cari silinirken hata:", error);
        showToast("Cari silinirken bir hata oluÅŸtu: " + error, true);
    }
}

function resetCariForm(){ 
    document.getElementById('cariForm').reset(); 
    editingCariId = null; 
    document.getElementById('cariEditId').value = ''; 
    setEditingMode(document.getElementById('cariFormBaslik'), document.getElementById('cariKaydetBtn'), document.getElementById('cariFormTemizleBtn'), null, 'Cari Kart');
    generateNextCariKodu(); 
}
async function handleCariKategoriEkle(event) {
    event.preventDefault();
    const yeniCariKategoriAdiInput = document.getElementById('yeniCariKategoriAdi');
    const yeniAd = yeniCariKategoriAdiInput.value.trim();
    const currentUser = auth.currentUser;
    if (!currentUser) { showToast("LÃ¼tfen giriÅŸ yapÄ±n.", true); return; }
    if (yeniAd === '') { showToast('Kategori/KÃ¶y adÄ± boÅŸ olamaz.', true); return; }
    try {
        await addDoc(collection(db, 'cari_kategorileri'), { ad: yeniAd, sahipId: sahipId });
        await Promise.all([
            renderCariKategoriListesi(),
            populateCariKategoriSelect(document.getElementById('cariKategori')),
            populateCariKategoriFiltre(),
            populateCariKategoriSelect(document.getElementById('topluGirisKategori'))
        ]);
        yeniCariKategoriAdiInput.value = '';
    } catch (error) {
        console.error("Kategori eklenirken hata: ", error);
        showToast("Kategori eklenemedi. Konsolu kontrol edin.", true);
    }
}
async function renderCariKategoriListesi() {
    const cariKategoriListesiUl = document.getElementById('cariKategoriListesiUl');
    const currentUser = auth.currentUser;
    if (!cariKategoriListesiUl || !currentUser) return;
    try {
        const q = query(collection(db, 'cari_kategorileri'), where("sahipId", "==", sahipId), orderBy('ad'));
        const snapshot = await getDocs(q);
        const kategoriler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        cariKategoriListesiUl.innerHTML = ''; 
        if (kategoriler.length === 0) { cariKategoriListesiUl.innerHTML = '<li>TanÄ±mlÄ± kategori/kÃ¶y bulunmuyor.</li>'; return; } 
        kategoriler.forEach(kat => { const li = document.createElement('li'); li.textContent = kat.ad; const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Sil';  deleteBtn.classList.add('btn', 'btn-delete', 'btn-sm', 'dont-print'); deleteBtn.onclick = () => deleteCariKategori(kat.id); li.appendChild(deleteBtn);  cariKategoriListesiUl.appendChild(li); });
    } catch(error) { console.error("Kategoriler listelenirken hata:", error); }
}

async function deleteCariKategori(id) {
    try {
        const kategoriRef = doc(db, 'cari_kategorileri', id);
        const kategoriDoc = await getDoc(kategoriRef);
        if (!kategoriDoc.exists()) {
            showToast("Silinecek kategori bulunamadÄ±.", true);
            return;
        }
        const kategoriAdi = kategoriDoc.data().ad;

        const carilerQuery = query(
            collection(db, 'cariler'),
            where('sahipId', '==', sahipId),
            where('kategori', '==', kategoriAdi),
            limit(1)
        );
        const carilerSnapshot = await getDocs(carilerQuery);

        if (!carilerSnapshot.empty) {
            showToast(`"${kategoriAdi}" kategorisi, bir veya daha fazla cari tarafÄ±ndan kullanÄ±ldÄ±ÄŸÄ± iÃ§in silinemez.`, true);
            return;
        }

        const onayMesaji = `"${kategoriAdi}" kategorisini/kÃ¶yÃ¼nÃ¼ kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?`;
        
        showCustomConfirm(onayMesaji, async () => {
            try {
                await deleteDoc(doc(db, 'cari_kategorileri', id));
                showToast(`"${kategoriAdi}" kategorisi baÅŸarÄ±yla silindi.`);
                
                await Promise.all([
                    renderCariKategoriListesi(),
                    populateCariKategoriSelect(document.getElementById('cariKategori')),
                    populateCariKategoriFiltre(),
                    populateCariKategoriSelect(document.getElementById('topluGirisKategori'))
                ]);

            } catch (error) {
                console.error("Kategori silinirken hata:", error);
                showToast("Kategori silinirken bir hata oluÅŸtu.", true);
            }
        });

    } catch (error) {
        console.error("Kategori silme Ã¶n kontrolÃ¼ sÄ±rasÄ±nda hata:", error);
        showToast("Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu.", true);
    }
}

async function populateCariKategoriFiltre() {
    const selectElement = document.getElementById('cariKategoriFiltre');
    const yemRaporuKoySecimi = document.getElementById('yemRaporuKoySecimi');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const q = query(collection(db, 'cari_kategorileri'), where("sahipId", "==", sahipId), orderBy('ad'));
        const snapshot = await getDocs(q);
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value;
        selectElement.innerHTML = `<option value="">TÃ¼m Kategoriler</option>`;
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); });
        selectElement.value = currentValue;
    } catch(error) { console.error("Kategori filtresi yÃ¼klenirken hata:", error); }
}

async function populateCariKategoriSelect(selectElement, defaultOptionText = "SeÃ§iniz...") {
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const q = query(collection(db, 'cari_kategorileri'), where("sahipId", "==", sahipId), orderBy('ad'));
        const snapshot = await getDocs(q);
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value;
        selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); });
        if (kategoriler.some(kat => kat.ad === currentValue)) { selectElement.value = currentValue; }
    } catch(error) { console.error("Kategori seÃ§imi yÃ¼klenirken hata:", error); }
}
async function populateCariSelect(selectElement, filterGroup = null, defaultText = "SeÃ§iniz...") {
    if (!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    selectElement.innerHTML = `<option value="">YÃ¼kleniyor...</option>`;

    const constraints = [
        where("sahipId", "==", sahipId),
        where("durum", "==", "aktif")
    ];
    if (filterGroup) {
        constraints.push(where('cariGrup', 'array-contains', filterGroup));
    }
    constraints.push(orderBy('adiSoyadi'));

    const q = query(collection(db, 'cariler'), ...constraints);

    try {
        const snapshot = await getDocs(q);
        const currentValue = selectElement.value;
        if (snapshot.empty) {
            selectElement.innerHTML = `<option value="">TanÄ±mlÄ± cari bulunamadÄ±.</option>`;
            return;
        }
        selectElement.innerHTML = `<option value="">${defaultText}</option>`;
        const cariler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        cariler.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = c.adiSoyadi;
            selectElement.appendChild(option);
        });
        if (cariler.some(c => c.id === currentValue)) {
            selectElement.value = currentValue;
        }
    } catch (error) {
        console.error("Cariler yÃ¼klenirken hata:", error);
        selectElement.innerHTML = `<option value="">Hata oluÅŸtu!</option>`;
    }
    if (selectElement.id === 'raporCariSecimi') {
        raporCariSecimiOrjinalSecenekler = Array.from(selectElement.options);
    }
}

async function populateYemSelect(selectElement, defaultText = "Yem SeÃ§iniz...") {
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const q = query(collection(db, 'yemler'), where("sahipId", "==", sahipId), orderBy('ad'));
        const snapshot = await getDocs(q);
        const yemler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        window.yemDataMap = new Map();
        yemler.forEach(y => window.yemDataMap.set(y.id, y));
        selectElement.innerHTML = ''; 
        const firstOption = document.createElement('option'); firstOption.value = ""; firstOption.textContent = defaultText; selectElement.appendChild(firstOption);
        yemler.forEach(y => {
            const option = document.createElement('option');
            option.value = y.id;
            option.textContent = `${y.ad} (${y.kod}) - Stok: ${y.stokMiktari || 0} ${y.birim}`;
            selectElement.appendChild(option);
        });
    } catch (error) {
        console.error("Yem seÃ§imi yÃ¼klenirken hata:", error);
    }
}

async function handleKullaniciKaydet(event) {
    event.preventDefault();
    showToast("Bu Ã¶zellik gÃ¼venlik nedeniyle doÄŸrudan yeni kullanÄ±cÄ± oluÅŸturmaz. LÃ¼tfen Ã¶nce Firebase Authentication panelinden kullanÄ±cÄ±yÄ± e-posta/ÅŸifre ile oluÅŸturun, ardÄ±ndan bu panelden o kullanÄ±cÄ±ya ait bir profil (rol atamasÄ±) oluÅŸturabilirsiniz.");
}

async function deleteKullanici(id) {
    showCustomConfirm("KullanÄ±cÄ±yÄ± silmek istiyor musunuz?", async () => {
        try {
            await deleteDoc(doc(db, 'kullanicilar', id));
            showToast("KullanÄ±cÄ± baÅŸarÄ±yla silindi.");
            await renderKullaniciListesi();
        } catch (error) {
            console.error("KullanÄ±cÄ± silinirken hata:", error);
            showToast("KullanÄ±cÄ± silinirken bir hata oluÅŸtu.", true);
        }
    });
}

async function renderKullaniciListesi() {
    const kullaniciListesiBody = document.getElementById('kullaniciListesiBody');
    const currentUser = auth.currentUser;
    if (!kullaniciListesiBody || !currentUser) return;
    try {
        const q = query(collection(db, 'kullanicilar'), where("sahipId", "==", sahipId));
        const snapshot = await getDocs(q);
        kullaniciListesiBody.innerHTML = '';
        snapshot.forEach(docSnap => {
            const user = docSnap.data();
            if (user.rol === 'admin') return;
            const row = kullaniciListesiBody.insertRow();
            row.innerHTML = `<td>${user.kullaniciAdi}</td><td>Ã‡alÄ±ÅŸan</td><td class="dont-print"><button class="btn btn-delete btn-sm" onclick="deleteKullanici('${docSnap.id}')">Sil</button></td>`;
        });
    } catch (error) { console.error("KullanÄ±cÄ±lar listelenirken hata", error); }
}

async function editYemAlisi(id) {
    try {
        const docRef = doc(db, 'yem_alimlari', id);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
            showToast("DÃ¼zenlenecek kayÄ±t bulunamadÄ±.", true);
            return;
        }
        const data = docSnap.data();

        editingYemAlisId = id;
        document.getElementById('yemAlisEditId').value = id;
        document.getElementById('yemAlisTarih').value = data.tarih;
        document.getElementById('yemSecimiAlis').value = data.yemId;
        document.getElementById('yemAlisMiktar').value = data.miktar;
        document.getElementById('yemAlisTedarikci').value = data.cariId;
        document.getElementById('yemAlisBirimFiyati').value = data.alisFiyati;
        hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar');
        setEditingMode(document.getElementById('yemAlisFormBaslik'), document.getElementById('yemAlisKaydetBtn'), document.getElementById('yemAlisFormTemizleBtn'), id, 'Yem AlÄ±ÅŸÄ±');
        document.getElementById('yemAlisForm').scrollIntoView();
    } catch (error) {
        console.error("Yem alÄ±ÅŸÄ± dÃ¼zenleme iÃ§in getirilirken hata:", error);
    }
}

async function handleYemTanimKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { showToast("LÃ¼tfen giriÅŸ yapÄ±n.", true); return; }

    const formData = {
        kod: document.getElementById('yemKodu').value,
        ad: document.getElementById('yemAdi').value,
        kategori: document.getElementById('yemKategorisi').value,
        birim: document.getElementById('yemBirimi').value,
        satisFiyati: parseFloat(document.getElementById('yemSatisFiyati').value) || 0,
        sahipId: sahipId
    };

    try {
        const editingYemTanimId = document.getElementById('yemTanimEditId').value;
        if (editingYemTanimId) {
            const yemRef = doc(db, 'yemler', editingYemTanimId);
            await setDoc(yemRef, formData, { merge: true });
            showToast("Yem tanÄ±mÄ± gÃ¼ncellendi.");
        } else {
            formData.stokMiktari = 0;
            await addDoc(collection(db, 'yemler'), formData);
            showToast("Yem tanÄ±mÄ± kaydedildi.");
        }
        resetYemTanimForm();
        await renderYemStokListesi();
    } catch (error) {
        console.error("Yem tanÄ±mÄ± kaydedilirken hata:", error);
        showToast("Yem tanÄ±mÄ± kaydedilirken bir hata oluÅŸtu.", true);
    }
}

function resetYemTanimForm() {
    const yemTanimForm = document.getElementById('yemTanimForm');
    const yemTanimFormBaslik = document.getElementById('yemTanimFormBaslik');
    const yemTanimKaydetBtn = document.getElementById('yemTanimKaydetBtn');
    const yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
    yemTanimForm.reset();
    editingYemTanimId = null;
    document.getElementById('yemTanimEditId').value = '';
    if(yemTanimFormBaslik) yemTanimFormBaslik.textContent = 'Yeni Yem TanÄ±mla';
    if(yemTanimKaydetBtn) yemTanimKaydetBtn.textContent = 'Kaydet';
    if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.style.display = 'none';
}

async function renderYemStokListesi() {
    const yemStokListesiBody = document.getElementById('yemStokListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const q = query(collection(db, 'yemler'), where('sahipId', '==', sahipId), orderBy('ad'));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
            yemStokListesiBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">TanÄ±mlÄ± yem bulunmuyor.</td></tr>';
            return;
        }
        let rows = '';
        snapshot.forEach(docSnap => {
            const yem = docSnap.data();
            rows += `<tr>
                <td>${yem.kod || ''}</td>
                <td>${yem.ad || ''}</td>
                <td>${yem.kategori || ''}</td>
                <td>${yem.birim || ''}</td>
                <td>${formatCurrency(yem.alisFiyati || 0)}</td>
                <td>${formatCurrency(yem.satisFiyati || 0)}</td>
                <td>${yem.stokMiktari || 0}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemTanimi('${docSnap.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemTanimi('${docSnap.id}')">Sil</button>
                </td>
            </tr>`;
        });
        yemStokListesiBody.innerHTML = rows;
    } catch (error) { console.error("Yem stok listesi yÃ¼klenirken hata:", error); }
}

async function loadAllYemlerToCache() {
    window.yemDataMap = new Map();
    try {
        const q = query(collection(db, 'yemler'), where("sahipId", "==", sahipId));
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
            window.yemDataMap.set(doc.id, doc.data());
        });
    } catch (error) {
        console.error("Yem Ã¶nbelleÄŸi yÃ¼klenirken hata:", error);
    }
}

async function loadAllCarilerToCache() {
    window.cariDataMap = new Map();
    try {
        const q = query(collection(db, 'cariler'), where("sahipId", "==", sahipId));
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
            window.cariDataMap.set(doc.id, doc.data());
        });
    } catch (error) {
        console.error("Cari Ã¶nbelleÄŸi yÃ¼klenirken hata:", error);
    }
}

async function handleYemAlisKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) {
        showToast("LÃ¼tfen giriÅŸ yapÄ±n.", true);
        return;
    }

    const miktar = parseInt(document.getElementById('yemAlisMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('yemAlisBirimFiyati').value);
    const yemId = document.getElementById('yemSecimiAlis').value;

    if (!yemId || isNaN(miktar) || miktar < 0 || isNaN(birimFiyat)) {
        showToast("LÃ¼tfen yem, miktar ve fiyat alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doldurun.", true);
        return;
    }

    const formData = {
        tarih: document.getElementById('yemAlisTarih').value,
        yemId: yemId,
        miktar: miktar,
        cariId: document.getElementById('yemAlisTedarikci').value || '',
        alisFiyati: birimFiyat,
        toplamTutar: miktar * birimFiyat,
        sahipId: sahipId
    };

    const yemRef = doc(db, 'yemler', yemId);

    if (editingYemAlisId) {
        const alisRef = doc(db, 'yem_alimlari', editingYemAlisId);
        try {
            await runTransaction(db, async (transaction) => {
                const eskiAlisDoc = await transaction.get(alisRef);
                if (!eskiAlisDoc.exists()) throw "DÃ¼zenlenecek kayÄ±t bulunamadÄ±.";
                
                const eskiMiktar = eskiAlisDoc.data().miktar;
                if (eskiAlisDoc.data().yemId !== yemId) throw "Yem tÃ¼rÃ¼ dÃ¼zenleme sÄ±rasÄ±nda deÄŸiÅŸtirilemez. LÃ¼tfen kaydÄ± silip yeniden oluÅŸturun.";
                
                const stokFarki = miktar - eskiMiktar;
                transaction.update(yemRef, { stokMiktari: increment(stokFarki) });
                transaction.update(alisRef, formData);
            });

            showToast("Yem alÄ±ÅŸÄ± baÅŸarÄ±yla gÃ¼ncellendi.");
            resetYemAlisForm();
            await Promise.all([renderYemStokListesi(), renderYemAlisHareketleri()]);

        } catch (error) {
            console.error("Yem alÄ±ÅŸÄ± gÃ¼ncellenirken hata:", error);
            showToast("Hata: " + error, true);
        }
    } else {
        try {
            await runTransaction(db, async (transaction) => {
                const yemAlimRef = doc(collection(db, 'yem_alimlari'));
                transaction.set(yemAlimRef, formData);
                transaction.update(yemRef, { stokMiktari: increment(miktar) });
            });

            showToast("Yem alÄ±ÅŸÄ± baÅŸarÄ±yla kaydedildi.");
            resetYemAlisForm();
            await Promise.all([renderYemStokListesi(), renderYemAlisHareketleri()]);
        } catch (error) {
            console.error("Yem alÄ±ÅŸÄ± kaydedilirken hata:", error);
            showToast("Yem alÄ±ÅŸÄ± kaydedilirken bir hata oluÅŸtu.", true);
        }
    }
}

async function deleteYemTanimi(id) {
    const message = "Bu yem tanÄ±mÄ±nÄ± silmek istediÄŸinizden emin misiniz? EÄŸer bu yem ile ilgili bir alÄ±ÅŸ veya satÄ±ÅŸ yapÄ±ldÄ±ysa, silme iÅŸlemi engellenecektir.";
    showCustomConfirm(message, async () => {
        try {
            const alisQuery = query(collection(db, 'yem_alimlari'), where('yemId', '==', id), limit(1));
            const satisQuery = query(collection(db, 'yem_satislari'), where('yemId', '==', id), limit(1));

            const [alisSnapshot, satisSnapshot] = await Promise.all([
                getDocs(alisQuery),
                getDocs(satisQuery)
            ]);
            
            if (!alisSnapshot.empty || !satisSnapshot.empty) {
                showToast("Bu yem ile ilgili hareketleri bulunduÄŸu iÃ§in silemezsiniz.", true);
                return;
            }
            
            await deleteDoc(doc(db, 'yemler', id));
            showToast("Yem tanÄ±mÄ± silindi.");
            await renderYemStokListesi();
            
        } catch (error) {
            console.error("Yem tanÄ±mÄ± silinirken hata:", error);
            showToast("Yem tanÄ±mÄ± silinirken bir hata oluÅŸtu.", true);
        }
    }); 
}


async function editYemTanimi(id) {
    try {
        const docRef = doc(db, 'yemler', id);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) { 
            showToast("DÃ¼zenlenecek yem bulunamadÄ±.", true); 
            return; 
        }
        const yem = docSnap.data();
        document.getElementById('yemTanimEditId').value = id;
        document.getElementById('yemKodu').value = yem.kod;
        document.getElementById('yemAdi').value = yem.ad;
        document.getElementById('yemKategorisi').value = yem.kategori;
        document.getElementById('yemBirimi').value = yem.birim;
        document.getElementById('yemSatisFiyati').value = yem.satisFiyati;
        setEditingMode(document.getElementById('yemTanimFormBaslik'), document.getElementById('yemTanimKaydetBtn'), document.getElementById('yemTanimFormTemizleBtn'), id, 'Yem TanÄ±mÄ±');
        document.getElementById('yemTanimForm').scrollIntoView();
    } catch (error) { console.error("Yem tanÄ±mÄ± dÃ¼zenlenirken hata:", error); }
}

function resetYemAlisForm() {
    document.getElementById('yemAlisForm').reset();
    editingYemAlisId = null;
    document.getElementById('yemAlisEditId').value = '';
    setEditingMode(document.getElementById('yemAlisFormBaslik'), document.getElementById('yemAlisKaydetBtn'), document.getElementById('yemAlisFormTemizleBtn'), null, 'Yeni Yem AlÄ±ÅŸÄ±');
}

async function renderYemAlisHareketleri() {
    const listBody = document.getElementById('yemAlisHareketListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const q = query(
            collection(db, 'yem_alimlari'), 
            where('sahipId', '==', sahipId), 
            orderBy('tarih', 'desc'), 
            limit(20)
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Yem alÄ±m hareketi bulunmuyor.</td></tr>';
            return;
        }
        
        const yemIds = new Set(snapshot.docs.map(doc => doc.data().yemId));
        const cariIds = new Set(snapshot.docs.filter(doc => doc.data().cariId).map(doc => doc.data().cariId));
        const yemMap = new Map();
        const cariMap = new Map();

        if (yemIds.size > 0) {
    const yemQuery = query(collection(db, 'yemler'), where(documentId(), 'in', Array.from(yemIds)));
            const yemSnapshot = await getDocs(yemQuery);
            yemSnapshot.forEach(doc => yemMap.set(doc.id, doc.data().ad));
        }
        if (cariIds.size > 0) {
    const cariQuery = query(collection(db, 'cariler'), where(documentId(), 'in', Array.from(cariIds)));
            const cariSnapshot = await getDocs(cariQuery);
            cariSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));
        }

        let rows = '';
        snapshot.forEach(doc => {
            const alim = doc.data();
            const yemAdi = yemMap.get(alim.yemId) || 'Bilinmiyor';
            const cariAdi = alim.cariId ? cariMap.get(alim.cariId) : 'PeÅŸin AlÄ±ÅŸ';
            rows += `<tr>
                <td>${formatDate(alim.tarih)}</td>
                <td>${yemAdi}</td>
                <td>${alim.miktar}</td>
                <td>${cariAdi}</td>
                <td>${formatCurrency(alim.alisFiyati)}</td>
                <td>${formatCurrency(alim.toplamTutar)}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemAlisi('${doc.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemAlisi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;
    } catch(e) { console.error("Yem alÄ±ÅŸ hareketleri yÃ¼klenirken hata:", e); }
}

async function editOdeme(id) {
    try {
        const docRef = doc(db, 'odemeVeTahsilatlar', id);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
            showToast("KayÄ±t bulunamadÄ±.", true);
            return;
        }
        const data = docSnap.data();
        document.getElementById('odemeEditId').value = id;
        document.getElementById('islemTuru').value = data.islemTuru;
        document.getElementById('odemeTarih').value = data.tarih;
        document.getElementById('odemeYapilanTedarikci').value = data.cariId;
        document.getElementById('odemeTuru').value = data.odemeTuru;
        document.getElementById('odemeTutari').value = data.tutar;
        document.getElementById('odemeAciklama').value = data.aciklama;
        const cariBilgisi = window.cariDataMap.get(data.cariId);
        if (cariBilgisi) {
            document.getElementById('odemeCariAramaInput').value = cariBilgisi.adiSoyadi;
        } else {
            document.getElementById('odemeCariAramaInput').value = 'Cari BulunamadÄ±';
        }
        document.getElementById('odemeFormBaslik').textContent = 'Hareket DÃ¼zenle';
        document.getElementById('odemeKaydetBtn').textContent = 'GÃ¼ncelle';
        document.getElementById('odemeFormTemizleBtn').style.display = 'inline-block';
        const cariSelect = document.getElementById('odemeYapilanTedarikci');
        cariSelect.dispatchEvent(new Event('change'));
        document.getElementById('odemeFormBaslik').scrollIntoView({ behavior: 'smooth', block: 'center' });
    } catch (error) {
        console.error("Ã–deme dÃ¼zenleme iÃ§in getirilirken hata:", error);
        showToast("KayÄ±t bilgileri yÃ¼klenirken bir hata oluÅŸtu.", true);
    }
}

async function deleteOdeme(id) {
    showCustomConfirm("Bu iÅŸlem hareketini silmek istediÄŸinizden emin misiniz?", async () => {
        try {
            await deleteDoc(doc(db, 'odemeVeTahsilatlar', id));
            showToast("Ä°ÅŸlem baÅŸarÄ±yla silindi.");
            await renderOdemeListesi();
        } catch (error) {
            console.error("Ã–deme silinirken hata:", error);
            showToast("Ä°ÅŸlem silinirken bir hata oluÅŸtu.", true);
        }
    });
}

function closeSutDuzenleForm() {
    document.getElementById('sutDuzenleFormAlani').style.display = 'none';
    document.getElementById('sutDuzenleForm').reset();
}

function toggleLoading(button, isLoading) {
    if (!button) return;
    if (isLoading) {
        button.disabled = true;
        button.classList.add('is-loading');
        const spinner = document.createElement('span');
        spinner.className = 'loader-spinner';
        button.appendChild(spinner);
    } else {
        button.disabled = false;
        button.classList.remove('is-loading');
        const spinner = button.querySelector('.loader-spinner');
        if (spinner) {
            spinner.remove();
        }
    }
}

function displayHareketler(hareketListesi) {
    const container = document.getElementById('hareketDokumuContainer');
    const islemTuruFiltre = document.getElementById('hd-islem-turu').value;
    const cariIdFiltre = document.getElementById('hd-cari-secimi').value;
    let filtrelenmisListe = [...hareketListesi];
    if (cariIdFiltre && cariIdFiltre !== 'tumu') { filtrelenmisListe = filtrelenmisListe.filter(item => item.cariId === cariIdFiltre); }
    if (islemTuruFiltre && islemTuruFiltre !== 'tumu') { filtrelenmisListe = filtrelenmisListe.filter(item => item.tip === islemTuruFiltre); }
    if (filtrelenmisListe.length === 0) { container.innerHTML = '<p style="text-align: center;">SeÃ§tiÄŸiniz kriterlere uygun hiÃ§bir hareket bulunamadÄ±.</p>'; return; }
    let tableHTML = `<table class="report-table"><thead><tr><th>Tarih</th><th>Cari AdÄ±</th><th>Ä°ÅŸlem TÃ¼rÃ¼</th><th>AÃ§Ä±klama</th><th>Tutar</th></tr></thead><tbody>`;
    let genelToplam = 0;
    filtrelenmisListe.forEach(item => {
        genelToplam += item.tutar || 0;
        tableHTML += `<tr><td>${formatDate(item.tarih)}</td><td>${item.cariAdi}</td><td>${item.islemTuru}</td><td>${item.aciklama}</td><td style="color: ${item.tutar >= 0 ? 'green' : 'red'}; text-align: right;">${formatCurrency(item.tutar)}</td></tr>`;
    });
    tableHTML += `</tbody><tfoot><tr class="report-totals-row"><td colspan="4" style="text-align: right; font-weight: bold;">Filtre ToplamÄ±:</td><td style="font-weight: bold; text-align: right;">${formatCurrency(genelToplam)}</td></tr></tfoot></table>`;
    container.innerHTML = tableHTML;
}

async function fetchAndDisplayHareketler() {
    const container = document.getElementById('hareketDokumuContainer');
    container.innerHTML = '<p style="text-align: center; font-size: 1.2em;">Hareketler yÃ¼kleniyor, lÃ¼tfen bekleyin...</p>';
    const startDate = document.getElementById('hd-baslangic-tarihi').value;
    const endDate = document.getElementById('hd-bitis-tarihi').value;
    const newDateRange = `${startDate}_${endDate}`;
    if (cachedHareketler.length > 0 && cachedDateRange === newDateRange) {
        displayHareketler(cachedHareketler);
        return;
    }
    try {
        const koleksiyonlar = ['sut_alimlari', 'yem_satislari', 'yem_alimlari', 'odemeVeTahsilatlar'];
        const sorguPromises = koleksiyonlar.map(koleksiyon => {
            const constraints = [where('sahipId', '==', sahipId)];
            if (startDate) constraints.push(where('tarih', '>=', startDate));
            if (endDate) constraints.push(where('tarih', '<=', endDate));
            const q = query(collection(db, koleksiyon), ...constraints);
            return getDocs(q);
        });

        const [sutAlimlari, yemSatislari, yemAlimlari, odemeler] = await Promise.all(sorguPromises);
        let birlesikListe = [];
        sutAlimlari.forEach(doc => {
            const data = doc.data();
            birlesikListe.push({ tarih: data.tarih, cariId: data.cariId, cariAdi: window.cariDataMap.get(data.cariId)?.adiSoyadi || 'Bilinmiyor', islemTuru: 'SÃ¼t AlÄ±mÄ±', aciklama: `${data.toplam.toFixed(2)} Lt`, tutar: data.toplamTutar, tip: 'sut_alimi' });
        });
        yemSatislari.forEach(doc => {
            const data = doc.data();
            birlesikListe.push({ tarih: data.tarih, cariId: data.cariId, cariAdi: window.cariDataMap.get(data.cariId)?.adiSoyadi || 'Bilinmiyor', islemTuru: 'Yem SatÄ±ÅŸÄ±', aciklama: `${data.miktar} Adet - ${window.yemDataMap.get(data.yemId)?.ad || ''}`, tutar: data.toplamTutar, tip: 'yem_satisi' });
        });
        yemAlimlari.forEach(doc => {
            const data = doc.data();
            birlesikListe.push({ tarih: data.tarih, cariId: data.cariId, cariAdi: window.cariDataMap.get(data.cariId)?.adiSoyadi || 'PeÅŸin', islemTuru: 'Yem AlÄ±ÅŸÄ±', aciklama: `${data.miktar} Adet - ${window.yemDataMap.get(data.yemId)?.ad || ''}`, tutar: -data.toplamTutar, tip: 'yem_alisi' });
        });
        odemeler.forEach(doc => {
            const data = doc.data();
            let islem, tutar, tip;
            if (data.islemTuru === 'odeme') { islem = 'Ã–deme AlÄ±ndÄ±'; tutar = data.tutar; tip = 'odeme'; }
            else { islem = 'Tahsilat YapÄ±ldÄ±'; tutar = -data.tutar; tip = 'tahsilat'; }
            birlesikListe.push({ tarih: data.tarih, cariId: data.cariId, cariAdi: window.cariDataMap.get(data.cariId)?.adiSoyadi || 'Bilinmiyor', islemTuru: islem, aciklama: data.aciklama || data.odemeTuru, tutar: tutar, tip: tip });
        });
        birlesikListe.sort((a, b) => new Date(b.tarih) - new Date(a.tarih));
        cachedHareketler = birlesikListe;
        cachedDateRange = newDateRange;
        displayHareketler(cachedHareketler);
    } catch (error) {
        container.innerHTML = `<p style="text-align: center; color: red;">Hareketler yÃ¼klenirken bir hata oluÅŸtu: ${error.message}</p>`;
        console.error("DetaylÄ± hareket dÃ¶kÃ¼mÃ¼ alÄ±nÄ±rken KRÄ°TÄ°K HATA:", error);
    }
}

async function deleteSutAlimi(id) {
    showCustomConfirm("Bu sÃ¼t alÄ±m kaydÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!", async () => {
        try {
            await deleteDoc(doc(db, 'sut_alimlari', id));
            showToast("KayÄ±t baÅŸarÄ±yla silindi.");
            await renderSutAlimGecmisi();
            await renderTopluSutGirisFormu();
            await updateDashboardStats();
        } catch (error) {
            console.error("SÃ¼t alÄ±mÄ± silinirken hata:", error);
            showToast("Silme iÅŸlemi sÄ±rasÄ±nda bir hata oluÅŸtu: " + error.message, true);
        }
    });
}

async function handleSutAlimiGuncelle(event) {
    event.preventDefault();
    const id = document.getElementById('sutDuzenleId').value;
    const sabah = parseFloat(document.getElementById('sutDuzenleSabah').value) || 0;
    const aksam = parseFloat(document.getElementById('sutDuzenleAksam').value) || 0;
    const fiyat = parseFloat(document.getElementById('sutDuzenleFiyat').value) || 0;
    const toplam = sabah + aksam;

    const guncelVeri = {
        sabah: sabah,
        aksam: aksam,
        fiyat: fiyat,
        toplam: toplam,
        toplamTutar: toplam * fiyat
    };

    try {
        await updateDoc(doc(db, 'sut_alimlari', id), guncelVeri);
        closeSutDuzenleForm();
        await renderSutAlimGecmisi();
    } catch (error) { console.error("SÃ¼t alÄ±mÄ± gÃ¼ncellenirken hata:", error); }
}

async function editSutAlimi(id) {
    const formAlani = document.getElementById('sutDuzenleFormAlani');
    try {
        const docRef = doc(db, 'sut_alimlari', id);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) return;
        const data = docSnap.data();
        document.getElementById('sutDuzenleId').value = id;
        document.getElementById('sutDuzenleSabah').value = data.sabah;
        document.getElementById('sutDuzenleAksam').value = data.aksam;
        document.getElementById('sutDuzenleFiyat').value = data.fiyat;
        formAlani.style.display = 'block';
        formAlani.scrollIntoView({ behavior: 'smooth' });
    } catch (error) { console.error("SÃ¼t alÄ±mÄ± dÃ¼zenleme iÃ§in getirilirken hata:", error); }
}

async function handleYemSatisUpdate() {
    const satisRef = doc(db, 'yem_satislari', editingYemSatisId);
    const yeniMiktar = parseInt(document.getElementById('yemSatisMiktar').value);
    const yeniFiyat = parseFloat(document.getElementById('yemSatisBirimFiyati').value);
    if (isNaN(yeniMiktar) || isNaN(yeniFiyat) || yeniMiktar <= 0) {
        showToast("LÃ¼tfen miktar ve fiyat alanlarÄ±nÄ± geÃ§erli bir ÅŸekilde doldurun.", true);
        return;
    }

    try {
        await runTransaction(db, async (transaction) => {
            const satisDoc = await transaction.get(satisRef);
            if (!satisDoc.exists()) { throw new Error("GÃ¼ncellenecek satÄ±ÅŸ kaydÄ± bulunamadÄ±. SayfayÄ± yenileyip tekrar deneyin."); }
            const satisData = satisDoc.data();
            const eskiMiktar = satisData.miktar;
            const yemId = satisData.yemId;
            const yemRef = doc(db, 'yemler', yemId);
            const yemDoc = await transaction.get(yemRef);
            if (!yemDoc.exists()) { throw new Error("Stokta bu yem bulunamadÄ±! Yem silinmiÅŸ olabilir, bu nedenle satÄ±ÅŸ gÃ¼ncellenemiyor."); }
            const miktarFarki = eskiMiktar - yeniMiktar;
            const guncelVeri = {
                tarih: document.getElementById('yemSatisTarih').value,
                miktar: yeniMiktar,
                satisFiyati: yeniFiyat,
                toplamTutar: yeniMiktar * yeniFiyat
            };

            transaction.update(yemRef, { stokMiktari: increment(miktarFarki) });
            transaction.update(satisRef, guncelVeri);
        });

        showToast("Yem satÄ±ÅŸÄ± baÅŸarÄ±yla gÃ¼ncellendi.");
        resetYemSatisForm();
        await renderYemStokListesi();
        await renderYemSatisListesi();

    } catch (error) {
        console.error("Yem satÄ±ÅŸÄ± gÃ¼ncellenirken KRÄ°TÄ°K HATA:", error);
        showToast("GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu! Hata: " + error.message, true);
    }
}

async function handleYemSatisKaydet(event) {
    event.preventDefault();
    if (editingYemSatisId) {
        await handleYemSatisUpdate();
    } else {
        const currentUser = auth.currentUser;
        if (!currentUser) { showToast("LÃ¼tfen giriÅŸ yapÄ±n.", true); return; }
        const miktar = parseInt(document.getElementById('yemSatisMiktar').value);
        const birimFiyat = parseFloat(document.getElementById('yemSatisBirimFiyati').value);
        const yemId = document.getElementById('yemSecimiSatis').value;
        const cariId = document.getElementById('yemAlanTedarikci').value;
        if (!yemId || isNaN(miktar) || miktar < 0 || isNaN(birimFiyat)) { showToast("LÃ¼tfen yem, miktar ve fiyat alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doldurun.", true); return; }
        
        const yemRef = doc(db, 'yemler', yemId);
        
        try {
            await runTransaction(db, async (transaction) => {
                const yemDoc = await transaction.get(yemRef);
                if (!yemDoc.exists()) { throw "SatÄ±lmak istenen yem veritabanÄ±nda bulunamadÄ±."; }
                const anlikStok = yemDoc.data().stokMiktari || 0;
                if (anlikStok < miktar) { throw `Yetersiz stok! AnlÄ±k stok: ${anlikStok}`; }
                
                const formData = {
                    tarih: document.getElementById('yemSatisTarih').value,
                    yemId: yemId,
                    cariId: cariId,
                    miktar: miktar,
                    satisFiyati: birimFiyat,
                    toplamTutar: miktar * birimFiyat,
                    sahipId: sahipId
                };
                
                const yemSatisRef = doc(collection(db, 'yem_satislari'));
                transaction.set(yemSatisRef, formData);
                transaction.update(yemRef, { stokMiktari: increment(-miktar) });
            });
            resetYemSatisForm();
            await renderYemStokListesi();
            await renderYemSatisListesi();
        } catch (error) {
            console.error("Yem satÄ±ÅŸÄ± kaydedilirken hata:", error);
            showToast("Yem satÄ±ÅŸÄ± kaydedilemedi: " + error, true);
        }
    }
}

function resetYemSatisForm() {
    document.getElementById('yemSatisForm').reset();
    editingYemSatisId = null;
    document.getElementById('yemSatisEditId').value = '';
    setEditingMode(document.getElementById('yemSatisFormBaslik'), document.getElementById('yemSatisKaydetBtn'), document.getElementById('yemSatisFormTemizleBtn'), null, 'Yeni Yem SatÄ±ÅŸÄ±');
    document.getElementById('yemAlanTedarikci').disabled = false;
    document.getElementById('yemSecimiSatis').disabled = false;
}

async function calculateCariBakiyeDetayli(cariId, endDate = null) {
    const cacheKey = `bakiye_${cariId}_${endDate || 'guncel'}`;
    const now = Date.now();

    if (globalCache.has(cacheKey)) {
        const cachedItem = globalCache.get(cacheKey);
        if (now - cachedItem.timestamp < CACHE_TTL_SECONDS * 1000) {
            return cachedItem.data;
        }
    }

    let alacak = 0, borc = 0;
    const currentUser = auth.currentUser;
    if (!currentUser) return { alacak: 0, borc: 0, bakiye: 0 };

    try {
        const createQuery = (collectionName) => {
            const constraints = [where('sahipId', '==', sahipId), where('cariId', '==', cariId)];
            if (endDate) {
                constraints.push(where('tarih', '<=', endDate));
            }
            const q = query(collection(db, collectionName), ...constraints);
            return getDocs(q);
        };

        const sutQuery = createQuery('sut_alimlari');
        const yemSatisQuery = createQuery('yem_satislari');
        const odemeQuery = createQuery('odemeVeTahsilatlar');
        const yemAlimQuery = createQuery('yem_alimlari');

        const [sutSnapshot, yemSatisSnapshot, odemeSnapshot, yemAlimSnapshot] = await Promise.all([
            sutQuery, yemSatisQuery, odemeQuery, yemAlimQuery
        ]);

        sutSnapshot.forEach(doc => {
            const alim = doc.data();
            if (alim.islemKaynagi === 'tank-aktarim') {
                borc += alim.toplamTutar || 0;
            } else {
                alacak += alim.toplamTutar || 0;
            }
        });

        yemAlimSnapshot.forEach(doc => alacak += doc.data().toplamTutar);
        yemSatisSnapshot.forEach(doc => borc += doc.data().toplamTutar);
        odemeSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.islemTuru === 'odeme' || data.islemTuru === 'alacak') alacak += data.tutar;
            else if (data.islemTuru === 'tahsilat' || data.islemTuru === 'borc') borc += data.tutar;
        });
        const result = { alacak, borc, bakiye: alacak - borc };
        globalCache.set(cacheKey, { data: result, timestamp: now });
        return result;
    } catch (error) {
        console.error(`Bakiye hesaplanÄ±rken hata (Cari ID: ${cariId}):`, error);
        return { alacak: 0, borc: 0, bakiye: 0 };
    }
}

async function handleOdemeKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) {
        showToast("LÃ¼tfen giriÅŸ yapÄ±n.", true);
        return;
    }
    const editingId = document.getElementById('odemeEditId').value;
    const tutar = parseFloat(document.getElementById('odemeTutari').value);
    const cariId = document.getElementById('odemeYapilanTedarikci').value;
    if (!cariId || isNaN(tutar) || tutar <= 0) {
        showToast("LÃ¼tfen cari ve tutar alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doldurun.", true);
        return;
    }
    const formData = {
        tarih: document.getElementById('odemeTarih').value,
        cariId: cariId,
        islemTuru: document.getElementById('islemTuru').value,
        odemeTuru: document.getElementById('odemeTuru').value,
        tutar: tutar,
        aciklama: document.getElementById('odemeAciklama').value.trim(),
        sahipId: sahipId
    };
    try {
        if (editingId) {
            await setDoc(doc(db, 'odemeVeTahsilatlar', editingId), formData, { merge: true });
        } else {
            await addDoc(collection(db, 'odemeVeTahsilatlar'), formData);
        }
        resetOdemeForm();
        await renderOdemeListesi();
    } catch (error) {
        console.error("Ã–deme/Tahsilat kaydedilirken hata:", error);
        showToast("Ä°ÅŸlem kaydedilirken bir hata oluÅŸtu.");
    }
}

function resetOdemeForm() {
    document.getElementById('odemeForm').reset();
    editingOdemeId = null;
    document.getElementById('odemeEditId').value = '';
    setEditingMode(document.getElementById('odemeFormBaslik'), document.getElementById('odemeKaydetBtn'), document.getElementById('odemeFormTemizleBtn'), null, 'Yeni Hareket GiriÅŸi');
}

async function renderOdemeListesi() {
    const listBody = document.getElementById('odemeListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    const thead = listBody.parentElement.querySelector('thead');
    if (thead) {
        thead.innerHTML = `
            <tr>
                <th>Tarih</th><th>Cari</th><th>Ä°ÅŸlem TÃ¼rÃ¼</th><th>Ã–deme TÃ¼rÃ¼</th><th>Tutar</th><th>AÃ§Ä±klama</th><th class="dont-print">Ä°ÅŸlemler</th></tr>`;
    }
    try {
        const q = query(
            collection(db, 'odemeVeTahsilatlar'),
            where('sahipId', '==', sahipId),
            orderBy('tarih', 'desc')
        );
        const snapshot = await getDocs(q);
        
        if(snapshot.empty){
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Ä°ÅŸlem hareketi bulunmuyor.</td></tr>';
            return;
        }
    
        let rows = '';
        snapshot.forEach(doc => {
            const islem = doc.data();
            const cariAdi = window.cariDataMap.get(islem.cariId)?.adiSoyadi || 'Bilinmiyor';
            
            let islemTuruText = islem.islemTuru;
            if(islem.islemTuru === 'odeme') islemTuruText = 'Tahsilat';
            if(islem.islemTuru === 'tahsilat') islemTuruText = 'Ã–deme'; 
            if(islem.islemTuru === 'borc') islemTuruText = 'AÃ§Ä±lÄ±ÅŸ Borcu';
            if(islem.islemTuru === 'alacak') islemTuruText = 'AÃ§Ä±lÄ±ÅŸ AlacaÄŸÄ±';

            rows += `<tr>
                <td>${formatDate(islem.tarih)}</td>
                <td>${cariAdi}</td>
                <td>${islemTuruText}</td>
                <td>${islem.odemeTuru || '-'}</td>
                <td>${formatCurrency(islem.tutar)}</td>
                <td>${islem.aciklama}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editOdeme('${doc.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteOdeme('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;

    } catch (e) { 
        console.error("Ã–deme listesi yÃ¼klenirken hata:", e);
        listBody.innerHTML = '<tr><td colspan="7" style="color: red; text-align:center;">Ã–deme listesi yÃ¼klenirken bir hata oluÅŸtu.</td></tr>';
    }
}

async function generateNextCariKodu() {
    try {
        const q = query(collection(db, 'cariler'), where('sahipId', '==', sahipId));
        const carilerSnapshot = await getDocs(q);
        let maxNumber = 0;
        
        carilerSnapshot.forEach(doc => {
            const kodu = doc.data().kodu;
            if (kodu && kodu.toUpperCase().startsWith('C')) {
                const numberPart = parseInt(kodu.substring(1), 10);
                if (!isNaN(numberPart) && numberPart > maxNumber) {
                    maxNumber = numberPart;
                }
            }
        });
        const nextNumber = maxNumber + 1;
        const yeniKod = "C" + String(nextNumber).padStart(3, '0');
        document.getElementById('cariKodu').value = yeniKod;

    } catch (error) {
        console.error("Otomatik cari kodu oluÅŸturulurken hata:", error);
        document.getElementById('cariKodu').value = '';
    }
}
async function deleteYemSatisi(id) {
    showCustomConfirm("Bu yem satÄ±ÅŸÄ±nÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem, satÄ±lan yemi stoÄŸa geri ekleyecektir.", async () => {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            showToast("Ä°ÅŸlem iÃ§in lÃ¼tfen giriÅŸ yapÄ±n.", true);
            return;
        }

        const satisRef = doc(db, 'yem_satislari', id);

        try {
            const satisDoc = await getDoc(satisRef);
            if (!satisDoc.exists()) {
                throw new Error("Silinecek satÄ±ÅŸ kaydÄ± bulunamadÄ±.");
            }
            const satisData = satisDoc.data();
            const yemRef = doc(db, 'yemler', satisData.yemId);
            const batch = writeBatch(db);
            batch.delete(satisRef);
            batch.update(yemRef, { 
                stokMiktari: increment(satisData.miktar) 
            });
            await batch.commit();
            showToast("Yem satÄ±ÅŸÄ± silindi ve stok gÃ¼ncellendi.");
            await renderYemSatisListesi();
            await renderYemStokListesi();
        } catch (error) { 
            console.error("Yem satÄ±ÅŸÄ± silinirken hata:", error); 
            showToast("Hata: " + error.message, true); 
        }
    });
}

        
async function renderTopluSutGirisFormu() {
    const tarih = document.getElementById('topluGirisTarih').value;
    const kategori = document.getElementById('topluGirisKategori').value;
    const container = document.getElementById('topluSutGirisTablosuAlani');
    const yokMesaji = document.getElementById('topluGirisTedarikciYokMesaji');
    const currentUser = auth.currentUser;

    if (topluGirisListener) {
        topluGirisListener(); 
    }

    if (!currentUser || !tarih || !kategori) {
        container.innerHTML = '';
        yokMesaji.style.display = 'block';
        yokMesaji.textContent = 'LÃ¼tfen tarih ve kategori seÃ§imi yapÄ±n.';
        return;
    }
    const carilerQuery = query(
        collection(db, 'cariler'),
        where('sahipId', '==', sahipId),
        where('kategori', '==', kategori),
        where('durum', '==', 'aktif'),
        where('cariGrup', 'array-contains', 'Ã¼retici'),
        where('cariTipi', '!=', 'sadece_yem'),
        orderBy('cariTipi'),
        orderBy('rotaSirasi')
    );

    const sutAlimlariQuery = query(
        collection(db, 'sut_alimlari'),
        where('sahipId', '==', sahipId),
        where('tarih', '==', tarih)
    );
    topluGirisListener = onSnapshot(carilerQuery, async (carilerSnapshot) => {
        const tumCariler = carilerSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const sutAlimSnapshot = await getDocs(sutAlimlariQuery);
        const kayitliCariIdleri = new Set(sutAlimSnapshot.docs.map(doc => doc.data().cariId));
        const gosterilecekCariler = tumCariler.filter(cari => !kayitliCariIdleri.has(cari.id));

        if (gosterilecekCariler.length === 0) {
            container.innerHTML = '';
            yokMesaji.style.display = 'block';
            yokMesaji.textContent = 'Bu kriterlere uygun, sÃ¼t giriÅŸi bekleyen cari bulunmuyor.';
            return;
        }
        yokMesaji.style.display = 'none';
        let tableHTML = `<table><thead><tr><th>Cari AdÄ±</th><th>AkÅŸam (Lt)</th><th>Sabah (Lt)</th><th>Toplam (Lt)</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody>`;
        const defaultFiyat = (globalSettings.defaultMilkPrice || 15.50).toFixed(2);
        gosterilecekCariler.forEach(cari => {
            const escapedCariAdi = cari.adiSoyadi.replace(/'/g, "\\'").replace(/"/g, '\\"');
            tableHTML += `<tr id="satir-${cari.id}"><td>${cari.adiSoyadi} (${cari.kategori || 'BelirtilmemiÅŸ'})</td><td><input type="number" id="aksam-${cari.id}" class="sut-input" step="0.1" min="0" oninput="sutMiktarGuncelle('${cari.id}')"></td><td><input type="number" id="sabah-${cari.id}" class="sut-input" step="0.1" min="0" oninput="sutMiktarGuncelle('${cari.id}')"></td><td><span id="toplam-lt-${cari.id}">0.00</span></td><td><input type="number" id="fiyat-${cari.id}" class="sut-input" step="0.01" min="0" value="${defaultFiyat}" oninput="sutMiktarGuncelle('${cari.id}')"></td><td><span id="toplam-tutar-${cari.id}">0,00 â‚º</span></td><td class="dont-print"><button id="kaydet-btn-${cari.id}" class="btn btn-primary btn-sm" onclick="handleTopluSutKaydet('${cari.id}', '${escapedCariAdi}', '${tarih}')">Kaydet</button></td></tr>`;
        });
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;

    }, (error) => {
        console.error("Toplu sÃ¼t giriÅŸi iÃ§in cariler dinlenirken hata:", error);
    });
}

function sutMiktarGuncelle(cariId) {
    const sabah = parseFloat(document.getElementById(`sabah-${cariId}`).value) || 0;
    const aksam = parseFloat(document.getElementById(`aksam-${cariId}`).value) || 0;
    const fiyat = parseFloat(document.getElementById(`fiyat-${cariId}`).value) || 0;
    const toplamLt = sabah + aksam;
    const toplamTutar = toplamLt * fiyat;
    document.getElementById(`toplam-lt-${cariId}`).textContent = toplamLt.toFixed(2);
    document.getElementById(`toplam-tutar-${cariId}`).textContent = formatCurrency(toplamTutar);
}
async function handleTopluSutKaydet(cariId, cariAdi, tarih) {
    const sabahInput = document.getElementById(`sabah-${cariId}`);
    const aksamInput = document.getElementById(`aksam-${cariId}`);
    const fiyatInput = document.getElementById(`fiyat-${cariId}`);
    const sabahMiktar = parseFloat(String(sabahInput.value).replace(',', '.')) || 0;
    const aksamMiktar = parseFloat(String(aksamInput.value).replace(',', '.')) || 0;
    const birimFiyat = parseFloat(String(fiyatInput.value).replace(',', '.')) || globalSettings.defaultMilkPrice || 0;

    const bugunkuToplamMiktar = sabahMiktar + aksamMiktar;
    if (bugunkuToplamMiktar <= 0) {
        showToast("LÃ¼tfen en az bir miktar girin.", true);
        return;
    }
    const proceedWithSave = async () => {
        const satir = document.getElementById(`satir-${cariId}`);
        if(satir) satir.querySelector('button').disabled = true;
        const sutAlimData = {
            tarih: tarih,
            cariId: cariId,
            cariAdi: cariAdi,
            sabah: sabahMiktar,
            aksam: aksamMiktar,
            toplam: bugunkuToplamMiktar,
            fiyat: birimFiyat,
            toplamTutar: bugunkuToplamMiktar * birimFiyat,
            sahipId: sahipId
        };

        try {
            await addDoc(collection(db, "sut_alimlari"), sutAlimData);
            if (satir) satir.style.display = 'none';
            await renderSutAlimGecmisi();
        } catch (error) {
            console.error("Toplu sÃ¼t alÄ±mÄ± kaydedilirken hata:", error);
            showToast("KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu: " + error.message, true);
            if(satir) satir.querySelector('button').disabled = false;
        }
    };

    try {
        const today = new Date(tarih);
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        const q = query(
            collection(db, 'sut_alimlari'),
            where('sahipId', '==', sahipId),
            where('cariId', '==', cariId),
            where('tarih', '==', yesterdayStr),
            limit(1)
        );
        const dunkuSutSnapshot = await getDocs(q);

        if (!dunkuSutSnapshot.empty) {
            const dunkuToplamMiktar = dunkuSutSnapshot.docs[0].data().toplam;
            const farkYuzdesi = Math.abs((bugunkuToplamMiktar - dunkuToplamMiktar) / dunkuToplamMiktar) * 100;

            if (farkYuzdesi > 20) {
                const durum = bugunkuToplamMiktar > dunkuToplamMiktar ? 'daha fazla' : 'daha az';
                const message = `âš ï¸ DÄ°KKAT! \n\nBugÃ¼n girilen miktar (${bugunkuToplamMiktar.toFixed(1)} Lt), dÃ¼n girilen miktardan (${dunkuToplamMiktar.toFixed(1)} Lt) Ã¶nemli Ã¶lÃ§Ã¼de ${durum}.\n\nBu miktar doÄŸru mu? Kaydetmek iÃ§in 'Evet'e basÄ±n.`;
                showCustomConfirm(message, proceedWithSave);
            } else {
                await proceedWithSave();
            }
        } else {
            await proceedWithSave();
        }
    } catch (error) {
        console.error("Ã–nceki gÃ¼n kontrolÃ¼ sÄ±rasÄ±nda hata:", error);
        await proceedWithSave();
    }
}


function calculateKarneTotals() {
    let aksamGenelToplam = 0, sabahGenelToplam = 0;
    document.querySelectorAll('#sut-rapor-tablosu input.aksam').forEach(input => aksamGenelToplam += Number(input.value) || 0);
    document.querySelectorAll('#sut-rapor-tablosu input.sabah').forEach(input => sabahGenelToplam += Number(input.value) || 0);
    const aksamToplamEl = document.getElementById('aksam-genel-toplam');
    const sabahToplamEl = document.getElementById('sabah-genel-toplam');
    const genelToplamEl = document.getElementById('genel-toplam');
    if(aksamToplamEl) aksamToplamEl.textContent = aksamGenelToplam.toFixed(2);
    if(sabahToplamEl) sabahToplamEl.textContent = sabahGenelToplam.toFixed(2);
    if(genelToplamEl) genelToplamEl.textContent = (aksamGenelToplam + sabahGenelToplam).toFixed(2);
}

function hesaplaToplamTutar(miktarInputId, fiyatInputId, toplamInputId) {
    const miktarInput = document.getElementById(miktarInputId);
    const fiyatInput = document.getElementById(fiyatInputId);
    const toplamInput = document.getElementById(toplamInputId);
    const miktar = parseFloat(miktarInput.value) || 0;
    const fiyat = parseFloat(fiyatInput.value) || 0;
    toplamInput.value = formatCurrency(miktar * fiyat);
}

async function renderSutAlimGecmisi() {
    const tarih = document.getElementById('topluGirisTarih').value;
    const gecmisTarihSpan = document.getElementById('gecmisTarihSpan');
    const header = document.getElementById('sutAlimGecmisiHeader');
    const body = document.getElementById('sutAlimGecmisiBody');
    const footer = document.getElementById('sutAlimGecmisiFooter');
    const currentUser = auth.currentUser;
    if (sutAlimGecmisiListener) {sutAlimGecmisiListener();}

    if (!currentUser || !tarih) {header.innerHTML = '';body.innerHTML = '';footer.innerHTML = '';return;}

    gecmisTarihSpan.textContent = formatDate(tarih);
    header.innerHTML = `<tr><th>Ãœretici</th><th>AkÅŸam (Lt)</th><th>Sabah (Lt)</th><th>Toplam</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">Ä°ÅŸlemler</th></tr>`;
    body.innerHTML = '<tr><td colspan="7">YÃ¼kleniyor...</td></tr>';
    footer.innerHTML = '';

    const q = query(
        collection(db, 'sut_alimlari'),
        where('sahipId', '==', sahipId),
        where('tarih', '==', tarih),
        orderBy('cariAdi')
    );

    sutAlimGecmisiListener = onSnapshot(q, snapshot => {
        const ureticiAlimlari = snapshot.docs.filter(doc => doc.data().islemKaynagi !== 'tank-aktarim');
        if (ureticiAlimlari.length === 0) {
            body.innerHTML = '<tr><td colspan="7" style="text-align:center;">Bu tarih iÃ§in Ã¼retici sÃ¼t alÄ±m kaydÄ± bulunmuyor.</td></tr>';
            footer.innerHTML = '';
            return;
        }
        const groupedData = new Map();
        ureticiAlimlari.forEach(doc => {
            const alim = doc.data();
            const docId = doc.id; 

            if (!groupedData.has(alim.cariId)) {
                groupedData.set(alim.cariId, {
                    cariAdi: alim.cariAdi,
                    sabah: 0,
                    aksam: 0,
                    toplam: 0,
                    toplamTutar: 0,
                    fiyat: 0,
                    docIds: []
                });
            }
            
            const cariData = groupedData.get(alim.cariId);
            cariData.sabah += alim.sabah || 0;
            cariData.aksam += alim.aksam || 0;
            cariData.toplam += alim.toplam || 0;
            cariData.toplamTutar += alim.toplamTutar || 0;
            cariData.docIds.push(docId);
        });

        let bodyHTML = '';
        let genelToplamAksam = 0, genelToplamSabah = 0, genelToplamLitre = 0, genelToplamTutar = 0;

        groupedData.forEach((data, cariId) => {
            const ortalamaFiyat = data.toplam > 0 ? (data.toplamTutar / data.toplam) : 0;
            
            genelToplamAksam += data.aksam;
            genelToplamSabah += data.sabah;
            genelToplamLitre += data.toplam;
            genelToplamTutar += data.toplamTutar;

            const sonKayitId = data.docIds[data.docIds.length - 1];

            bodyHTML += `<tr>
                <td>${data.cariAdi}</td>
                <td>${data.aksam.toFixed(2)}</td>
                <td>${data.sabah.toFixed(2)}</td>
                <td><strong>${data.toplam.toFixed(2)}</strong></td>
                <td>${formatCurrency(ortalamaFiyat)}</td>
                <td><strong>${formatCurrency(data.toplamTutar)}</strong></td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editSutAlimi('${sonKayitId}')" title="Bu satÄ±rdaki son giriÅŸi dÃ¼zenler.">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteSutAlimi('${sonKayitId}')" title="Bu satÄ±rdaki son giriÅŸi siler.">Sil</button>
                </td>
            </tr>`;
        });
        
        body.innerHTML = bodyHTML;

        const genelOrtalamaFiyat = genelToplamLitre > 0 ? (genelToplamTutar / genelToplamLitre) : 0;
        footer.innerHTML = `
            <tr style="background-color: #f0f0f0; font-weight: bold;">
                <td><strong>GÃœNLÃœK TOPLAM</strong></td>
                <td><strong>${genelToplamAksam.toFixed(2)}</strong></td>
                <td><strong>${genelToplamSabah.toFixed(2)}</strong></td>
                <td><strong>${genelToplamLitre.toFixed(2)}</strong></td>
                <td><strong>${formatCurrency(genelOrtalamaFiyat)}</strong></td>
                <td><strong>${formatCurrency(genelToplamTutar)}</strong></td>
                <td class="dont-print"></td>
            </tr>`;

    }, error => {
        console.error("SÃ¼t alÄ±m geÃ§miÅŸi dinlenirken hata:", error);
        body.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">GeÃ§miÅŸ yÃ¼klenirken bir hata oluÅŸtu.</td></tr>';
    });
}
 
async function deleteYemAlisi(id) {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        showToast("LÃ¼tfen giriÅŸ yapÄ±n.", true);
        return;
    }
    showCustomConfirm("Bu yem alÄ±ÅŸÄ±nÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem, alÄ±nan yemi stoktan dÃ¼ÅŸecektir.", async () => {
        try {
            await runTransaction(db, async (transaction) => {
                const alisRef = doc(db, 'yem_alimlari', id);
                const alisDoc = await transaction.get(alisRef);
                if (!alisDoc.exists()) {
                    throw "Silinecek alÄ±ÅŸ kaydÄ± bulunamadÄ±.";
                }
                const alisData = alisDoc.data();
                const yemRef = doc(db, 'yemler', alisData.yemId);
                
                transaction.delete(alisRef);
                transaction.update(yemRef, { stokMiktari: increment(-alisData.miktar) });
            });

            showToast("Yem alÄ±ÅŸÄ± silindi ve stok gÃ¼ncellendi.");
            await renderYemAlisHareketleri();
            await renderYemStokListesi();
        } catch (error) {
            console.error("Yem alÄ±ÅŸÄ± silinirken hata:", error);
            showToast("Hata: " + error, true);
        }
    });
}

async function handleSutAlimRaporuOlustur(options) {
    toggleReportButtons('sutRaporu', false);
    
    const cariId = document.getElementById('sutRaporuTedarikciSecimi').value;
    const startDateStr = document.getElementById('sutRaporuBaslangicTarihi').value;
    const endDateStr = document.getElementById('sutRaporuBitisTarihi').value;
    const kategori = document.getElementById('sutRaporuKategoriSecimi').value;
    const raporBaslik = document.getElementById('sutRaporuBaslik');
    const sutRaporuDetayAlani = document.getElementById('sutRaporuDetayAlani');

    if (!startDateStr || !endDateStr) {
        showToast("Rapor oluÅŸturmak iÃ§in lÃ¼tfen baÅŸlangÄ±Ã§ ve bitiÅŸ tarihlerini seÃ§in.", true);
        return;
    }

    if (!options.tumu && !options.kategori && !cariId) {
        showToast("LÃ¼tfen bir cari seÃ§in veya 'Kategori' ya da 'Toplu' raporu seÃ§in.", true);
        return;
    }

    sutRaporuDetayAlani.innerHTML = '<p>Rapor oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';
    document.getElementById('sut-raporu-export-area').innerHTML = '';

    try {
        const base_constraints = [
            where('sahipId', '==', sahipId),
            where('tarih', '>=', startDateStr),
            where('tarih', '<=', endDateStr)
        ];

        let tableHTML = '';
        const raporTarihEtiketi = `${formatDate(startDateStr)} - ${formatDate(endDateStr)}`;

        if (!options.tumu && !options.kategori) {
            const cariAdi = document.getElementById('sutRaporuTedarikciSecimi').options[document.getElementById('sutRaporuTedarikciSecimi').selectedIndex].text;
            raporBaslik.textContent = `${cariAdi} - ${raporTarihEtiketi} SÃ¼t DetaylarÄ±`;
            
            const final_constraints = [...base_constraints, where('cariId', '==', cariId), orderBy('tarih')];
            const finalQuery = query(collection(db, 'sut_alimlari'), ...final_constraints);
            const snapshot = await getDocs(finalQuery);

            if (snapshot.empty) {
                tableHTML = '<p>SeÃ§ili cari iÃ§in bu tarih aralÄ±ÄŸÄ±nda sÃ¼t alÄ±m kaydÄ± bulunamadÄ±.</p>';
            } else {
                const gunlukVeri = new Map();
                snapshot.forEach(doc => {
                    const alim = doc.data();
                    if (!gunlukVeri.has(alim.tarih)) {
                        gunlukVeri.set(alim.tarih, { tarih: alim.tarih, sabah: 0, aksam: 0, toplam: 0, toplamTutar: 0 });
                    }
                    const gun = gunlukVeri.get(alim.tarih);
                    gun.sabah += alim.sabah || 0;
                    gun.aksam += alim.aksam || 0;
                    gun.toplam += alim.toplam || 0;
                    gun.toplamTutar += alim.toplamTutar || 0;
                });
                
                tableHTML = `<table class="report-table"><thead><tr><th>Tarih</th><th>AkÅŸam</th><th>Sabah</th><th>Toplam (Lt)</th><th>Ort. Fiyat</th><th>Tutar</th></tr></thead><tbody>`;
                let toplamSabah = 0, toplamAksam = 0, toplamLitre = 0, toplamTutar = 0;
                
                gunlukVeri.forEach(alim => {
                    const ortalamaFiyat = alim.toplam > 0 ? alim.toplamTutar / alim.toplam : 0;
                    toplamSabah += alim.sabah;
                    toplamAksam += alim.aksam;
                    toplamLitre += alim.toplam;
                    toplamTutar += alim.toplamTutar;
                    tableHTML += `<tr><td>${formatDate(alim.tarih)}</td><td>${alim.aksam.toFixed(2)}</td><td>${alim.sabah.toFixed(2)}</td><td>${alim.toplam.toFixed(2)}</td><td>${formatCurrency(ortalamaFiyat)}</td><td>${formatCurrency(alim.toplamTutar)}</td></tr>`;
                });

                const genelOrtalamaFiyat = toplamLitre > 0 ? (toplamTutar / toplamLitre) : 0;
                tableHTML += `</tbody><tfoot><tr class="report-totals-row"><td><strong>TOPLAM</strong></td><td><strong>${toplamAksam.toFixed(2)}</strong></td><td><strong>${toplamSabah.toFixed(2)}</strong></td><td><strong>${toplamLitre.toFixed(2)}</strong></td><td><strong>${formatCurrency(genelOrtalamaFiyat)}</strong></td><td><strong>${formatCurrency(toplamTutar)}</strong></td></tr></tfoot></table>`;
            }
        } 
        else {
            if(options.kategori && kategori) {
                raporBaslik.textContent = `${kategori} Kategorisi - ${raporTarihEtiketi} Ã–zet Raporu`;
            } else {
                raporBaslik.textContent = `TÃ¼m Ãœreticiler - ${raporTarihEtiketi} Ã–zet Raporu`;
            }

            const allCarilerQuery = query(
                collection(db, 'cariler'),
                where('sahipId', '==', sahipId),
                where('cariGrup', 'array-contains', 'Ã¼retici')
            );
            const allCarilerSnapshot = await getDocs(allCarilerQuery);
            const allProducers = new Map(allCarilerSnapshot.docs.map(doc => [doc.id, doc.data()]));
            
            const alimlarQuery = query(collection(db, 'sut_alimlari'), ...base_constraints);
            let alimlarSnapshot = await getDocs(alimlarQuery);
            let alimlar = alimlarSnapshot.docs.map(doc => doc.data()).filter(alim => allProducers.has(alim.cariId));

            if (options.kategori && kategori) {
                alimlar = alimlar.filter(alim => allProducers.get(alim.cariId)?.kategori === kategori);
            }
            
            if (alimlar.length === 0) {
                tableHTML = '<p>SeÃ§ili kriterlere uygun Ã¼retici sÃ¼t alÄ±m kaydÄ± bulunamadÄ±.</p>';
            } else {
                const raporData = {};
                alimlar.forEach(alim => {
                    if (!raporData[alim.cariId]) {
                        const producerInfo = allProducers.get(alim.cariId);
                        raporData[alim.cariId] = { 
                            cariAdi: producerInfo?.adiSoyadi || 'SilinmiÅŸ Cari',
                            rotaSirasi: producerInfo?.rotaSirasi || 9999,
                            toplamSabah: 0, 
                            toplamAksam: 0, 
                            toplamLitre: 0, 
                            toplamTutar: 0 
                        };
                    }
                    const ozet = raporData[alim.cariId];
                    ozet.toplamSabah += alim.sabah || 0;
                    ozet.toplamAksam += alim.aksam || 0;
                    ozet.toplamLitre += alim.toplam || 0;
                    ozet.toplamTutar += alim.toplamTutar || 0;
                });

                tableHTML = `<table class="report-table"><thead><tr><th>Cari AdÄ±</th><th>Toplam AkÅŸam</th><th>Toplam Sabah</th><th>Toplam Litre</th><th>Ortalama Fiyat</th><th>Toplam Tutar</th></tr></thead><tbody>`;
                
                let genelToplamAksam = 0, genelToplamSabah = 0, genelToplamLitre = 0, genelToplamTutar = 0;

                Object.values(raporData).sort((a,b) => a.rotaSirasi - b.rotaSirasi).forEach(data => {
                    const ortalamaFiyat = data.toplamLitre > 0 ? (data.toplamTutar / data.toplamLitre) : 0;
                    tableHTML += `<tr><td>${data.cariAdi}</td><td>${data.toplamAksam.toFixed(2)}</td><td>${data.toplamSabah.toFixed(2)}</td><td><strong>${data.toplamLitre.toFixed(2)}</strong></td><td>${formatCurrency(ortalamaFiyat)}</td><td><strong>${formatCurrency(data.toplamTutar)}</strong></td></tr>`;
                
                    genelToplamAksam += data.toplamAksam;
                    genelToplamSabah += data.toplamSabah;
                    genelToplamLitre += data.toplamLitre;
                    genelToplamTutar += data.toplamTutar;
                });
                
                const genelOrtalamaFiyat = genelToplamLitre > 0 ? (genelToplamTutar / genelToplamLitre) : 0;

                tableHTML += `</tbody>
                              <tfoot>
                                  <tr class="report-totals-row">
                                      <td><strong>GENEL TOPLAM</strong></td>
                                      <td><strong>${genelToplamAksam.toFixed(2)}</strong></td>
                                      <td><strong>${genelToplamSabah.toFixed(2)}</strong></td>
                                      <td><strong>${genelToplamLitre.toFixed(2)}</strong></td>
                                      <td><strong>${formatCurrency(genelOrtalamaFiyat)}</strong></td>
                                      <td><strong>${formatCurrency(genelToplamTutar)}</strong></td>
                                  </tr>
                              </tfoot>
                            </table>`;
            }
        }
        
        sutRaporuDetayAlani.innerHTML = tableHTML;
        document.getElementById('sut-raporu-export-area').innerHTML = tableHTML;
        toggleReportButtons('sutRaporu', true);
        
    } catch (error) {
        console.error("SÃ¼t AlÄ±m Raporu oluÅŸturulurken hata:", error);
        sutRaporuDetayAlani.innerHTML = `<p style="color:red; font-weight:bold;">RAPOR OLUÅTURULAMADI!<br>Hata DetayÄ±: ${error.message}</p>`;
        document.getElementById('sut-raporu-export-area').innerHTML = '';
    }
}

async function exportSutRaporuToExcel() {
    console.log("Ã–zel AylÄ±k SÃ¼t Raporu Excel dÄ±ÅŸa aktarma iÅŸlemi baÅŸlatÄ±ldÄ±.");
    const ayYil = document.getElementById('sutRaporuAySecimi').value;
    const cariId = document.getElementById('sutRaporuTedarikciSecimi').value;
    const kategori = document.getElementById('sutRaporuKategoriSecimi').value;
    const raporButonlari = document.querySelectorAll('#sutRaporuOlusturBtn, #sutRaporuKategoriGosterBtn, #sutRaporuTumunuGosterBtn');
    let options = {tumu: false, kategori: false};
    if (document.activeElement.id === 'sutRaporuKategoriGosterBtn') options.kategori = true;
    if (document.activeElement.id === 'sutRaporuTumunuGosterBtn') options.tumu = true;


    if (!ayYil) {
        showToast("DÄ±ÅŸa aktarmadan Ã¶nce lÃ¼tfen bir rapor oluÅŸturun.", true);
        return;
    }

    try {
        const [year, month] = ayYil.split('-');
        const startDateStr = `${year}-${month}-01`;
        const endDate = new Date(year, parseInt(month, 10), 0);
        const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;

        const base_constraints = [
            where('sahipId', '==', sahipId),
            where('tarih', '>=', startDateStr),
            where('tarih', '<=', endDateStr)
        ];
        
        let dataForExcel = [];
        let sheetTitle = "Aylik Sut Raporu";

        if (!options.tumu && !options.kategori) {
            if (!cariId) { showToast("LÃ¼tfen bir cari seÃ§in.", true); return; }
            const cariAdi = document.getElementById('sutRaporuTedarikciSecimi').options[document.getElementById('sutRaporuTedarikciSecimi').selectedIndex].text;
            sheetTitle = cariAdi;
            
            const final_constraints = [...base_constraints, where('cariId', '==', cariId), orderBy('tarih')];
            const q = query(collection(db, 'sut_alimlari'), ...final_constraints);
            const snapshot = await getDocs(q);

            if (snapshot.empty) { showToast("DÄ±ÅŸa aktarÄ±lacak veri bulunamadÄ±.", true); return; }

            let toplamLitre = 0, toplamTutar = 0;
            dataForExcel = snapshot.docs.map(doc => {
                const alim = doc.data();
                toplamLitre += alim.toplam || 0;
                toplamTutar += alim.toplamTutar || 0;
                return {
                    "Tarih": formatDate(alim.tarih),
                    "AkÅŸam (Lt)": (alim.aksam || 0).toFixed(2),
                    "Sabah (Lt)": (alim.sabah || 0).toFixed(2),
                    "Toplam (Lt)": (alim.toplam || 0).toFixed(2),
                    "Fiyat (â‚º)": (alim.fiyat || 0).toFixed(2),
                    "Tutar (â‚º)": (alim.toplamTutar || 0).toFixed(2)
                };
            });
            dataForExcel.push({});
            dataForExcel.push({ "Tarih": "AYLIK TOPLAM", "Toplam (Lt)": toplamLitre.toFixed(2), "Tutar (â‚º)": toplamTutar.toFixed(2) });

        } else {
             showToast("Toplu ve Kategori raporlarÄ± iÃ§in Excel dÄ±ÅŸa aktarma henÃ¼z tamamlanmadÄ±.", true); return;
        }

        const worksheet = XLSX.utils.json_to_sheet(dataForExcel);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, sheetTitle);
        XLSX.writeFile(workbook, "Aylik_Sut_Raporu.xlsx");

    } catch (error) {
        console.error("Excel oluÅŸturulurken hata oluÅŸtu:", error);
        showToast("Excel dosyasÄ± oluÅŸturulurken bir hata oluÅŸtu.", true);
    }
}
async function handleDinamikSutRaporu() {
    const periodValue = document.getElementById('karneRaporuPeriyotSecimi').value;
    const kategori = document.getElementById('karneRaporuKategoriSecimi').value;
    const container = document.getElementById('dinamikRaporContainer');

    if (!periodValue) {
        showToast("LÃ¼tfen bir dÃ¶nem seÃ§in.", true);
        return;
    }
    container.innerHTML = `<p style="text-align:center; font-size:1.2em;">Rapor oluÅŸturuluyor...</p>`;

    const [year, month, periodPart] = periodValue.split('-');
    const intYear = parseInt(year, 10);
    const intMonth = parseInt(month, 10);

    let baslangicGunu, bitisGunu, startDateStr, endDateStr;
    const formatForDB = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

    if (periodPart === '1') {
        baslangicGunu = 1;
        bitisGunu = 15;
    } else {
        baslangicGunu = 16;
        bitisGunu = new Date(intYear, intMonth, 0).getDate();
    }
    
    startDateStr = formatForDB(new Date(intYear, intMonth - 1, baslangicGunu));
    endDateStr = formatForDB(new Date(intYear, intMonth - 1, bitisGunu));

    try {
        const producersQuery = query(
            collection(db, 'cariler'),
            where('sahipId', '==', sahipId),
            where('cariGrup', 'array-contains', 'Ã¼retici')
        );

        const milkQuery = query(
            collection(db, 'sut_alimlari'),
            where('sahipId', '==', sahipId),
            where('tarih', '>=', startDateStr),
            where('tarih', '<=', endDateStr)
        );

        const [allProducersSnapshot, milkSnapshot] = await Promise.all([
            getDocs(producersQuery),
            getDocs(milkQuery)
        ]);
        
        const allProducers = allProducersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        let producers = kategori ? allProducers.filter(p => p.kategori && p.kategori.trim().toLowerCase() === kategori.trim().toLowerCase()) : allProducers;

        if (producers.length === 0) {
            container.innerHTML = '<p style="text-align:center;">Bu kriterlere uygun Ã¼retici bulunamadÄ±.</p>';
            return;
        }

        producers.sort((a, b) => (a.rotaSirasi || 9999) - (b.rotaSirasi || 9999));
        
        const toNumber = (val) => {
            if (val === null || val === undefined) return 0;
            if (typeof val === 'number') return val;
            if (typeof val === 'string') {
                return parseFloat(val.replace(',', '.')) || 0;
            }
            return 0;
        };

        const milkData = new Map();
        milkSnapshot.forEach(doc => {
            const alim = doc.data();
            const key = `${alim.cariId}_${alim.tarih}`;
            if (milkData.has(key)) {
                const mevcutKayit = milkData.get(key);
                mevcutKayit.sabah += toNumber(alim.sabah);
                mevcutKayit.aksam += toNumber(alim.aksam);
                mevcutKayit.toplam += toNumber(alim.toplam);
            } else {
                milkData.set(key, { sabah: toNumber(alim.sabah), aksam: toNumber(alim.aksam), toplam: toNumber(alim.toplam) });
            }
        });
        
        const ayIsimleri = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
        const raporKategoriAdi = kategori ? `${kategori} -` : 'TÃ¼m Kategoriler -';
        const reportTitleText = `${raporKategoriAdi} ${ayIsimleri[intMonth - 1]} ${intYear} / ${periodPart}. YarÄ± SÃ¼t Karnesi`;
        let tableHTML = `<div class="dinamik-rapor-header dont-print"><h1>${reportTitleText}</h1></div><div class="table-wrapper"><table id="sut-rapor-tablosu"><thead><tr class="gunler"></tr><tr class="vakit"></tr></thead><tbody></tbody><tfoot></tfoot></table></div>`;
        container.innerHTML = tableHTML;
        
        const tableHeadGunler = container.querySelector('thead tr.gunler');
        const tableHeadVakit = container.querySelector('thead tr.vakit');
        const tableBody = container.querySelector('tbody');
        tableHeadGunler.innerHTML = '<th rowspan="2" class="uretici-listesi">ÃœRETÄ°CÄ° LÄ°STESÄ°</th>';
        tableHeadVakit.innerHTML = '';
        for (let i = baslangicGunu; i <= bitisGunu; i++) {
            tableHeadGunler.innerHTML += `<th colspan="2">${i}</th>`;
            tableHeadVakit.innerHTML += `<th class="vakit-baslik">A</th><th class="vakit-baslik">S</th>`;
        }
        
        tableBody.innerHTML = '';
        producers.forEach(producer => {
            let rowHTML = `<td class="uretici-listesi">${producer.adiSoyadi}</td>`;
            for (let i = baslangicGunu; i <= bitisGunu; i++) {
                const day = String(i).padStart(2, '0');
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${day}`;
                const key = `${producer.id}_${dateStr}`;
                const data = milkData.get(key) || { sabah: 0, aksam: 0, toplam: 0 };
                const formatLitre = (val) => Number(val || 0).toFixed(1);
                let aksamLitre = formatLitre(data.aksam);
                let sabahLitre = formatLitre(data.sabah);
                if (toNumber(data.aksam) === 0 && toNumber(data.sabah) === 0 && toNumber(data.toplam) > 0) {
                    sabahLitre = formatLitre(data.toplam); 
                }
                rowHTML += `<td>${aksamLitre}</td><td>${sabahLitre}</td>`;
            }
            tableBody.innerHTML += `<tr>${rowHTML}</tr>`;
        });
        
        const dailyTotals = new Map();
        for (let i = baslangicGunu; i <= bitisGunu; i++) { dailyTotals.set(i, { sabah: 0, aksam: 0 }); }
        producers.forEach(producer => {
            for (let i = baslangicGunu; i <= bitisGunu; i++) {
                const day = String(i).padStart(2, '0');
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${day}`;
                const key = `${producer.id}_${dateStr}`;
                if (milkData.has(key)) {
                    const alim = milkData.get(key);
                    const totals = dailyTotals.get(i);
                    let sabahDegeri = alim.sabah;
                    let aksamDegeri = alim.aksam;
                    if (sabahDegeri === 0 && aksamDegeri === 0 && alim.toplam > 0) {
                        sabahDegeri = alim.toplam;
                    }
                    totals.sabah += sabahDegeri;
                    totals.aksam += aksamDegeri;
                }
            }
        });

        const tfoot = container.querySelector('tfoot');
        let footerHTML = '<tr><td class="uretici-listesi"><strong>GÃœNLÃœK TOPLAM</strong></td>';
        for (let i = baslangicGunu; i <= bitisGunu; i++) {
            const totalsForDay = dailyTotals.get(i) || { sabah: 0, aksam: 0 };
            
            const formatLitre = (val) => Number(val || 0).toFixed(1);
            footerHTML += `<td><strong>${formatLitre(totalsForDay.aksam)}</strong></td>`;
            footerHTML += `<td><strong>${formatLitre(totalsForDay.sabah)}</strong></td>`;
        }
        footerHTML += '</tr>';
        tfoot.innerHTML = footerHTML;

    } catch(error) {
        console.error("Dinamik rapor oluÅŸturulurken hata:", error);
        container.innerHTML = `<p style="color:red; text-align:center;">Rapor oluÅŸturulurken bir hata oluÅŸtu: ${error.message}</p>`;
    }
}

async function handleYemPivotRaporu(reportType) {
    const raporAlani = document.getElementById('yemRaporuAlani');
    toggleReportButtons('yemRaporu', false);
    const ayYil = document.getElementById('yemRaporuAySecimi').value;
    const currentUser = auth.currentUser;

    if (!currentUser || !ayYil) {
        showToast("LÃ¼tfen bir ay seÃ§in.", true);
        raporAlani.innerHTML = '';
        return;
    }

    raporAlani.innerHTML = '<p>Rapor oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';

    try {
        const [year, month] = ayYil.split('-');
        const startDateStr = `${year}-${month}-01`;
        const endDate = new Date(year, month, 0);
        const endDateStr = endDate.toISOString().split('T')[0];

        const satisQuery = query(collection(db, 'yem_satislari'), where('sahipId', '==', sahipId), where('tarih', '>=', startDateStr), where('tarih', '<=', endDateStr));
        const yemlerQuery = query(collection(db, 'yemler'), where('sahipId', '==', sahipId));
        const carilerQuery = query(collection(db, 'cariler'), where('sahipId', '==', sahipId));
        const yemAlimlariQuery = query(collection(db, 'yem_alimlari'), where('sahipId', '==', sahipId), orderBy('tarih'));

        const [satisSnapshot, yemlerSnapshot, carilerSnapshot, yemAlimlariSnapshot] = await Promise.all([
            getDocs(satisQuery),
            getDocs(yemlerQuery),
            getDocs(carilerQuery),
            getDocs(yemAlimlariQuery)
        ]);

        if (satisSnapshot.empty) {
            raporAlani.innerHTML = '<h4>Bu ay iÃ§in yem satÄ±ÅŸÄ± bulunmuyor.</h4>';
            toggleReportButtons('yemRaporu', true);
            return;
        }

        const yemMap = new Map(yemlerSnapshot.docs.map(doc => [doc.id, doc.data()]));
        const cariMap = new Map(carilerSnapshot.docs.map(doc => [doc.id, doc.data()]));
        
        const ortalamaMaliyetMap = new Map();
        if (reportType === 'karlilik') {
            const maliyetMap = new Map();
            yemAlimlariSnapshot.forEach(doc => {
                const alim = doc.data();
                if (!maliyetMap.has(alim.yemId)) maliyetMap.set(alim.yemId, { toplamTutar: 0, toplamMiktar: 0 });
                const yemMaliyet = maliyetMap.get(alim.yemId);
                yemMaliyet.toplamTutar += alim.toplamTutar;
                yemMaliyet.toplamMiktar += alim.miktar;
            });
            maliyetMap.forEach((value, key) => {
                if (value.toplamMiktar > 0) ortalamaMaliyetMap.set(key, value.toplamTutar / value.toplamMiktar);
            });
        }
        const secilenKoy = document.getElementById('yemRaporuKoySecimi').value;

        const reportData = new Map();
        const yemlerInReport = new Set();
        satisSnapshot.forEach(doc => {
            const satis = doc.data();
            const cariInfo = cariMap.get(satis.cariId);
            if (!cariInfo) return;
            if (secilenKoy && cariInfo.kategori !== secilenKoy) {
                return;
            }
            yemlerInReport.add(satis.yemId);

            if (!reportData.has(satis.cariId)) {
                reportData.set(satis.cariId, {
                    cariAdi: cariInfo.adiSoyadi || 'Bilinmeyen Cari',
                    kategori: cariInfo.kategori || '-',
                    yemler: new Map(),
                    musteriToplamSatis: 0,
                    musteriToplamKar: 0,
                    musteriToplamAdet: 0
                });
            }
            
            const cariData = reportData.get(satis.cariId);

            if (!cariData.yemler.has(satis.yemId)) {
                cariData.yemler.set(satis.yemId, { adet: 0, toplamSatis: 0, toplamKar: 0 });
            }

            const yemData = cariData.yemler.get(satis.yemId);
            yemData.adet += satis.miktar;
            yemData.toplamSatis += satis.toplamTutar;
            
            const maliyet = ortalamaMaliyetMap.get(satis.yemId) || 0;
            const satisKar = (satis.satisFiyati - maliyet) * satis.miktar;
            yemData.toplamKar += satisKar;
            
            cariData.musteriToplamSatis += satis.toplamTutar;
            cariData.musteriToplamKar += satisKar;
            cariData.musteriToplamAdet += satis.miktar;
        });

        const sortedYemList = Array.from(yemlerInReport).sort((a, b) => (yemMap.get(a)?.ad || '').localeCompare(yemMap.get(b)?.ad || ''));
        
        let reportTitle = '';
        if (reportType === 'adet') reportTitle = 'Adet BazlÄ± Yem SatÄ±ÅŸ Raporu';
        else if (reportType === 'satis') reportTitle = 'DetaylÄ± Yem SatÄ±ÅŸ Raporu (Tutar)';
        else reportTitle = 'MÃ¼ÅŸteri BazlÄ± Yem KÃ¢rlÄ±lÄ±k Raporu';

        let tableHTML = `<h3 class="print-only print-title" style="text-align:center;">${reportTitle} - ${formatMonthYear(ayYil)}</h3>`;
        tableHTML += `<table class="report-table"><thead>`;
        
        const rowSpan = reportType === 'adet' ? '1' : '2';
        let headerRow1 = `<tr><th rowspan="${rowSpan}" style="vertical-align: middle;">MÃ¼ÅŸteri AdÄ±</th><th rowspan="${rowSpan}" style="vertical-align: middle;">KÃ¶y</th>`;
        
        sortedYemList.forEach(yemId => {
            const yemAdi = yemMap.get(yemId)?.ad || 'Bilinmeyen';
            let colSpan = (reportType === 'adet') ? 1 : (reportType === 'satis' ? 3 : 5);
            headerRow1 += `<th colspan="${colSpan}" style="text-align: center;">${yemAdi}</th>`;
        });
        
        let lastColTitle = (reportType === 'adet') ? 'Ãœretici Toplam (Adet)' : (reportType === 'satis' ? 'MÃ¼ÅŸteri ToplamÄ±' : 'MÃ¼ÅŸteri Toplam KÃ¢rÄ±');
        headerRow1 += `<th rowspan="${rowSpan}" style="vertical-align: middle;">${lastColTitle}</th></tr>`;
        
        let headerRow2 = '<tr>';
        if(reportType !== 'adet') {
             sortedYemList.forEach(() => {
                if (reportType === 'satis') headerRow2 += `<th>Adet</th><th>Fiyat</th><th>Toplam</th>`;
                else headerRow2 += `<th>Adet</th><th>SatÄ±ÅŸ F.</th><th>Ort. AlÄ±ÅŸ F.</th><th>Birim KÃ¢r</th><th>Toplam KÃ¢r</th>`;
            });
            headerRow2 += '</tr>';
        } else {
            headerRow2 = '';
        }
       
        tableHTML += headerRow1 + headerRow2 + `</thead><tbody>`;

        const genelToplamlar = new Map();
        const sortedCariler = Array.from(reportData.values()).sort((a,b) => a.cariAdi.localeCompare(b.cariAdi));

        sortedCariler.forEach(cariData => {
            tableHTML += `<tr><td>${cariData.cariAdi}</td><td>${cariData.kategori}</td>`;
            sortedYemList.forEach(yemId => {
                const yemSatis = cariData.yemler.get(yemId);
                if (yemSatis) {
                    const ortSatisFiyati = yemSatis.adet > 0 ? yemSatis.toplamSatis / yemSatis.adet : 0;
                    const alisFiyati = ortalamaMaliyetMap.get(yemId) || 0;
                    const birimKar = ortSatisFiyati - alisFiyati;

                    if (reportType === 'adet') tableHTML += `<td>${yemSatis.adet}</td>`;
                    else if (reportType === 'satis') tableHTML += `<td>${yemSatis.adet}</td><td>${formatCurrency(ortSatisFiyati)}</td><td>${formatCurrency(yemSatis.toplamSatis)}</td>`;
                    else tableHTML += `<td>${yemSatis.adet}</td><td>${formatCurrency(ortSatisFiyati)}</td><td>${formatCurrency(alisFiyati)}</td><td style="color:green;">${formatCurrency(birimKar)}</td><td style="color:green; font-weight:bold;">${formatCurrency(yemSatis.toplamKar)}</td>`;

                    if (!genelToplamlar.has(yemId)) genelToplamlar.set(yemId, { adet: 0, toplamSatis: 0, toplamKar: 0 });
                    const toplam = genelToplamlar.get(yemId);
                    toplam.adet += yemSatis.adet;
                    toplam.toplamSatis += yemSatis.toplamSatis;
                    toplam.toplamKar += yemSatis.toplamKar;
                } else {
                    let colSpan = (reportType === 'adet') ? 1 : (reportType === 'satis' ? 3 : 5);
                    for(let i = 0; i < colSpan; i++) tableHTML += `<td>-</td>`;
                }
            });
            let musteriToplam = cariData.musteriToplamAdet;
            if(reportType === 'satis') musteriToplam = formatCurrency(cariData.musteriToplamSatis);
            if(reportType === 'karlilik') musteriToplam = formatCurrency(cariData.musteriToplamKar);
            tableHTML += `<td style="font-weight:bold;">${musteriToplam}</td></tr>`;
        });
        
        tableHTML += `</tbody><tfoot><tr class="report-totals-row"><td colspan="2"><strong>Genel Toplam</strong></td>`;
        let sonGenelToplam = 0;
        sortedYemList.forEach(yemId => {
            const toplam = genelToplamlar.get(yemId);
            if (toplam) {
                if (reportType === 'adet') { tableHTML += `<td><strong>${toplam.adet}</strong></td>`; sonGenelToplam += toplam.adet; }
                else if (reportType === 'satis') { tableHTML += `<td><strong>${toplam.adet}</strong></td><td></td><td><strong>${formatCurrency(toplam.toplamSatis)}</strong></td>`; sonGenelToplam += toplam.toplamSatis; }
                else { tableHTML += `<td><strong>${toplam.adet}</strong></td><td></td><td></td><td></td><td><strong style="color:green;">${formatCurrency(toplam.toplamKar)}</strong></td>`; sonGenelToplam += toplam.toplamKar; }
            } else {
                let colSpan = (reportType === 'adet') ? 1 : (reportType === 'satis' ? 3 : 5);
                for(let i = 0; i < colSpan; i++) tableHTML += `<td></td>`;
            }
        });
        tableHTML += `<td><strong>${(reportType === 'adet') ? sonGenelToplam : formatCurrency(sonGenelToplam)}</strong></td></tr>`;
        tableHTML += `</tfoot></table>`;

        raporAlani.innerHTML = tableHTML;
        toggleReportButtons('yemRaporu', true);
    } catch (error) {
        console.error("Yem raporu oluÅŸturulurken hata:", error);
        raporAlani.innerHTML = `<p style="color:red; font-weight:bold;">RAPOR OLUÅTURULAMADI!<br>Hata DetayÄ±: ${error.message}</p>`;
    }
}
async function handleHesapOzetiRaporuOlustur() {
    toggleReportButtons('hesapOzeti', false);
    const cariId = document.getElementById('raporCariSecimi').value;
    const ayYil = document.getElementById('raporTarihAraligi').value;
    const raporBaslik = document.getElementById('raporBaslik');
    const raporDetayAlani = document.getElementById('raporDetayAlani');
    const currentUser = auth.currentUser;

    if (!currentUser || !cariId || !ayYil) { showToast("LÃ¼tfen cari ve ay seÃ§imi yapÄ±n.", true); return; }

    const cariAdi = document.getElementById('raporCariSecimi').options[document.getElementById('raporCariSecimi').selectedIndex].text;
    const [year, month] = ayYil.split('-');
    raporBaslik.textContent = `${cariAdi} - ${formatMonthYear(ayYil)} Hesap Ã–zeti`;
    raporDetayAlani.innerHTML = '<p>Rapor oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';
    document.getElementById('hesap-ozeti-export-area').innerHTML = '';

    try {
        const intYear = parseInt(year, 10);
        const intMonth = parseInt(month, 10);
        const startDate = `${year}-${month}-01`;
        const ayGunSayisi = new Date(intYear, intMonth, 0).getDate();
        const endDate = `${year}-${month}-${String(ayGunSayisi).padStart(2, '0')}`;
        const devirTarihiObj = new Date(intYear, intMonth - 1, 0);
        const devirYil = devirTarihiObj.getFullYear();
        const devirAy = String(devirTarihiObj.getMonth() + 1).padStart(2, '0');
        const devirGun = String(devirTarihiObj.getDate()).padStart(2, '0');
        const devirTarihiStr = `${devirYil}-${devirAy}-${devirGun}`;
        
        const createQuery = (collectionName, isDevir) => {
            const constraints = [where('sahipId', '==', sahipId), where('cariId', '==', cariId)];
            if (isDevir) {
                constraints.push(where('tarih', '<=', devirTarihiStr));
            } else {
                constraints.push(where('tarih', '>=', startDate), where('tarih', '<=', endDate));
            }
            return getDocs(query(collection(db, collectionName), ...constraints));
        };
        
        const yemlerQuery = query(collection(db, 'yemler'), where('sahipId', '==', sahipId));
        
        const [devirSut, devirYemSatis, devirOdeme, aySut, ayYemSatis, ayOdeme, yemlerSnapshot] = await Promise.all([
            createQuery('sut_alimlari', true),
            createQuery('yem_satislari', true),
            createQuery('odemeVeTahsilatlar', true),
            createQuery('sut_alimlari', false),
            createQuery('yem_satislari', false),
            createQuery('odemeVeTahsilatlar', false),
            getDocs(yemlerQuery)
        ]);
        
        const yemMap = new Map(yemlerSnapshot.docs.map(doc => [doc.id, doc.data()]));
        
        let devredenAlacak = 0, devredenBorc = 0;
        devirSut.forEach(doc => devredenAlacak += Number(doc.data().toplamTutar || 0));
        devirYemSatis.forEach(doc => devredenBorc += Number(doc.data().toplamTutar || 0));
        devirOdeme.forEach(doc => {
            const data = doc.data();
            if (data.islemTuru === 'odeme' || data.islemTuru === 'alacak') devredenAlacak += Number(data.tutar || 0);
            else if (data.islemTuru === 'tahsilat' || data.islemTuru === 'borc') devredenBorc += Number(data.tutar || 0);
        });
        const devredenBakiye = devredenAlacak - devredenBorc;

        let toplamSutDegeri = 0, sutDetayHTML = '', toplamSabah = 0, toplamAksam = 0, toplamLitre = 0;
        if (!aySut.empty) {
            aySut.forEach(doc => {
                const alim = doc.data();
                toplamSabah += Number(alim.sabah || 0);
                toplamAksam += Number(alim.aksam || 0);
                toplamLitre += Number(alim.toplam || 0);
                toplamSutDegeri += Number(alim.toplamTutar || 0);
            });
            const ortalamaFiyat = toplamLitre > 0 ? (toplamSutDegeri / toplamLitre) : 0;
            sutDetayHTML = `<table class="summary-table"><thead><tr><th>Toplam AkÅŸam</th><th>Toplam Sabah</th><th>Toplam Litre</th><th>Ort. Fiyat</th><th>Toplam Tutar</th></tr></thead><tbody><tr><td>${toplamAksam.toFixed(2)} Lt</td><td>${toplamSabah.toFixed(2)} Lt</td><td>${toplamLitre.toFixed(2)} Lt</td><td>${formatCurrency(ortalamaFiyat)}</td><td>${formatCurrency(toplamSutDegeri)}</td></tr></tbody></table>`;
        }

        let toplamYemSatisTutari = 0, toplamYemSatisMiktari = 0, yemSatisDetayHTML = '';
        const yemSatisOzet = {};
        if (!ayYemSatis.empty) {
            ayYemSatis.forEach(doc => {
                const satis = doc.data();
                toplamYemSatisTutari += Number(satis.toplamTutar || 0);
                toplamYemSatisMiktari += Number(satis.miktar || 0);
                const yemAdi = yemMap.get(satis.yemId)?.ad || 'Bilinmeyen Yem';
                if (!yemSatisOzet[yemAdi]) {
                    yemSatisOzet[yemAdi] = { miktar: 0, tutar: 0 };
                }
                yemSatisOzet[yemAdi].miktar += Number(satis.miktar || 0);
                yemSatisOzet[yemAdi].tutar += Number(satis.toplamTutar || 0);
            });
            yemSatisDetayHTML = '<table class="summary-table"><thead><tr><th>Yem AdÄ±</th><th>Miktar</th><th>Ort. Birim Fiyat</th><th>Tutar</th></tr></thead><tbody>';
            for (const yemAdi in yemSatisOzet) {
                const ozet = yemSatisOzet[yemAdi];
                const ortalamaBirimFiyat = ozet.miktar > 0 ? (ozet.tutar / ozet.miktar) : 0;
                yemSatisDetayHTML += `<tr><td>${yemAdi}</td><td>${ozet.miktar}</td><td>${formatCurrency(ortalamaBirimFiyat)}</td><td>${formatCurrency(ozet.tutar)}</td></tr>`;
            }
            yemSatisDetayHTML += `</tbody><tfoot><tr class="report-totals-row"><td><strong>TOPLAM</strong></td><td><strong>${toplamYemSatisMiktari}</strong></td><td></td><td><strong>${formatCurrency(toplamYemSatisTutari)}</strong></td></tr></tfoot></table>`;
        }

        let toplamOdemeTutari = 0, odemeDetayHTML = '';
        let toplamTahsilatTutari = 0, tahsilatDetayHTML = '';
        const odemeDetaylari = [], tahsilatDetaylari = [];
        if(!ayOdeme.empty) {
            ayOdeme.docs.sort((a,b) => a.data().tarih.localeCompare(b.data().tarih)).forEach(doc => {
                const islem = doc.data();
                if (islem.islemTuru === 'odeme') {
                    toplamOdemeTutari += Number(islem.tutar || 0);
                    odemeDetaylari.push(islem);
                } else if (islem.islemTuru === 'tahsilat') {
                    toplamTahsilatTutari += Number(islem.tutar || 0);
                    tahsilatDetaylari.push(islem);
                }
            });
            
            if(odemeDetaylari.length > 0) {
                odemeDetayHTML = '<table class="summary-table"><thead><tr><th>Tarih</th><th>Ã–deme TÃ¼rÃ¼</th><th>AÃ§Ä±klama</th><th>Tutar</th></tr></thead><tbody>';
                odemeDetaylari.forEach(islem => {
                    odemeDetayHTML += `<tr><td>${formatDate(islem.tarih)}</td><td>${islem.odemeTuru || '-'}</td><td>${islem.aciklama}</td><td>${formatCurrency(islem.tutar)}</td></tr>`;
                });
                odemeDetayHTML += `</tbody><tfoot><tr class="report-totals-row"><td colspan="3"><strong>TOPLAM</strong></td><td><strong>${formatCurrency(toplamOdemeTutari)}</strong></td></tr></tfoot></table>`;
            }
            
            if(tahsilatDetaylari.length > 0) {
                tahsilatDetayHTML = '<table class="summary-table"><thead><tr><th>Tarih</th><th>Ã–deme TÃ¼rÃ¼</th><th>AÃ§Ä±klama</th><th>Tutar</th></tr></thead><tbody>';
                tahsilatDetaylari.forEach(islem => {
                    tahsilatDetayHTML += `<tr><td>${formatDate(islem.tarih)}</td><td>${islem.odemeTuru || '-'}</td><td>${islem.aciklama}</td><td>${formatCurrency(islem.tutar)}</td></tr>`;
                });
                tahsilatDetayHTML += `</tbody><tfoot><tr class="report-totals-row"><td colspan="3"><strong>TOPLAM</strong></td><td><strong>${formatCurrency(toplamTahsilatTutari)}</strong></td></tr></tfoot></table>`;
            }
        }

        const araToplamAlacak = toplamSutDegeri + toplamOdemeTutari;
        const araToplamBorc = toplamYemSatisTutari + toplamTahsilatTutari;
        const cariAyBakiye = araToplamAlacak - araToplamBorc;
        const donemSonuBakiye = devredenBakiye + cariAyBakiye;

        let reportHTML = `
            <div class="report-block"><h5>Ã–nceki DÃ¶nemden Devir</h5><p class="block-total"><strong>${formatCurrency(devredenBakiye)} (${devredenBakiye >= 0 ? 'Cari AlacaklÄ±' : 'Cari BorÃ§lu'})</strong></p></div>
            <div class="report-block"><h5>Cari Ay SÃ¼t AlÄ±mlarÄ±</h5>${sutDetayHTML || '<p>Bu ay sÃ¼t alÄ±mÄ± yok.</p>'}</div>
            <div class="report-block"><h5>Cari Ay Yem SatÄ±ÅŸlarÄ±</h5>${yemSatisDetayHTML || '<p>Bu ay yem satÄ±ÅŸÄ± yok.</p>'}</div>
            <div class="report-block"><h5>Cari Ay YapÄ±lan Tahsilatlar (MÃ¼ÅŸteriden Gelen)</h5>${odemeDetayHTML || '<p>Bu ay tahsilat yapÄ±lmamÄ±ÅŸ.</p>'}</div>
            <div class="report-block"><h5>Cari Ay YapÄ±lan Ã–demeler (MÃ¼ÅŸteriye Giden)</h5>${tahsilatDetayHTML || '<p>Bu ay Ã¶deme yapÄ±lmamÄ±ÅŸ.</p>'}</div>
            <div class="report-block final-summary">
                <h5>DÃ–NEM SONU HESAPLAMASI</h5>
                <p><span>Ã–nceki Aydan Devir:</span> <span>${formatCurrency(devredenBakiye)} (${devredenBakiye >= 0 ? 'Cari AlacaklÄ±' : 'Cari BorÃ§lu'})</span></p>
                <hr style="border-style: dashed; margin: 10px 0;">
                <p><span>+ Cari Ay SÃ¼t AlÄ±mlarÄ±:</span> <span style="color:green;">+ ${formatCurrency(toplamSutDegeri)}</span></p>
                <p><span>+ Cari Ay YapÄ±lan Tahsilatlar:</span> <span style="color:green;">+ ${formatCurrency(toplamOdemeTutari)}</span></p>
                <p style="border-top: 1px solid #ccc; padding-top: 5px; margin-top:5px;"><strong>Ara Toplam (Alacak):</strong> <strong style="color:green;">${formatCurrency(araToplamAlacak)}</strong></p>
                <p style="margin-top: 15px;"><span>- Cari Ay Yem SatÄ±ÅŸlarÄ±:</span> <span style="color:red;">- ${formatCurrency(toplamYemSatisTutari)}</span></p>
                <p><span>- Cari Ay YapÄ±lan Ã–demeler:</span> <span style="color:red;">- ${formatCurrency(toplamTahsilatTutari)}</span></p>
                <p style="border-top: 1px solid #ccc; padding-top: 5px; margin-top:5px;"><strong>Ara Toplam (BorÃ§):</strong> <strong style="color:red;">- ${formatCurrency(araToplamBorc)}</strong></p>
                <hr>
                <p><strong>CARÄ° AY BAKÄ°YESÄ°:</strong> <strong>${formatCurrency(cariAyBakiye)}</strong></p>
                <p><strong>DÃ–NEM SONU NET BAKÄ°YE:</strong> <strong>${formatCurrency(donemSonuBakiye)} (${donemSonuBakiye >= 0 ? 'Cari AlacaklÄ±' : 'Cari BorÃ§lu'})</strong></p>
            </div>
        `;
        raporDetayAlani.innerHTML = reportHTML;
        
        document.getElementById('hesap-ozeti-export-area').innerHTML = reportHTML;
        toggleReportButtons('hesapOzeti', true);

    } catch (error) {
        console.error("Hesap Ã¶zeti raporu oluÅŸturulurken hata:", error);
        raporDetayAlani.innerHTML = `<p style="color:red; font-weight:bold;">RAPOR OLUÅTURULAMADI!<br>Hata DetayÄ±: ${error.message}.</p>`;
    }
}

function toggleReportButtons(reportPrefix, show) {
    const displayStyle = show ? 'inline-block' : 'none';
    const pdfBtn = document.getElementById(`${reportPrefix}PdfBtn`);
    const xlsxBtn = document.getElementById(`${reportPrefix}XlsxBtn`);
    const printBtn = document.getElementById(`${reportPrefix}YazdirBtn`);

    if (pdfBtn) pdfBtn.style.display = displayStyle;
    if (xlsxBtn) xlsxBtn.style.display = displayStyle;
    if (printBtn) printBtn.style.display = displayStyle;
}

async function addYemSatisRow() {
    const container = document.getElementById('yemSatisSatirlari');
    const satirId = `satir-${Date.now()}`;
    const satirDiv = document.createElement('div');
    satirDiv.className = 'form-grid yem-satis-satiri';
    satirDiv.id = satirId;
    satirDiv.style.cssText = 'grid-template-columns: 3fr 1fr 1fr 1fr auto; padding: 10px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 5px; align-items: end;';

    satirDiv.innerHTML = `
        <div class="form-group">
            <label>Yem:</label>
            <select class="yem-secimi" required><option value="">SeÃ§iniz...</option></select>
        </div>
        <div class="form-group">
            <label>Miktar:</label>
            <input type="number" class="yem-miktari" step="1" min="1" required>
        </div>
        <div class="form-group">
            <label>SatÄ±ÅŸ FiyatÄ± (Birim):</label>
            <input type="number" class="yem-fiyati" step="0.01" required>
        </div>
        <div class="form-group">
            <label>Ara Toplam:</label>
            <input type="text" class="ara-toplam" readonly style="font-weight: bold; text-align: right;">
        </div>
        <button type="button" class="btn btn-delete btn-sm" onclick="removeYemSatisRow('${satirId}')">Sil</button>
    `;

    container.appendChild(satirDiv);
    const yeniSelect = satirDiv.querySelector('.yem-secimi');
    await populateYemSelect(yeniSelect);
    yeniSelect.addEventListener('change', (e) => updateSatisSatiri(e.target));
    satirDiv.querySelector('.yem-miktari').addEventListener('input', (e) => updateSatisSatiri(e.target));
    satirDiv.querySelector('.yem-fiyati').addEventListener('input', (e) => updateSatisSatiri(e.target));
    return satirDiv;
}

function removeYemSatisRow(satirId) {
    document.getElementById(satirId)?.remove();
    updateGenelToplam();
}

function updateSatisSatiri(element) {
    const satir = element.closest('.yem-satis-satiri');
    const yemSelect = satir.querySelector('.yem-secimi');
    const miktarInput = satir.querySelector('.yem-miktari');
    const fiyatInput = satir.querySelector('.yem-fiyati');
    const araToplamInput = satir.querySelector('.ara-toplam');
    const yemId = yemSelect.value;
    const miktar = parseFloat(miktarInput.value) || 0;
    if (element.classList.contains('yem-secimi') && yemId && window.yemDataMap.has(yemId)) {
        fiyatInput.value = window.yemDataMap.get(yemId).satisFiyati || 0;
    }

    const fiyat = parseFloat(fiyatInput.value) || 0;
    const araToplam = miktar * fiyat;
    araToplamInput.value = formatCurrency(araToplam);
    updateGenelToplam();
}

function updateGenelToplam() {
    let genelToplam = 0;
    document.querySelectorAll('.yem-satis-satiri .ara-toplam').forEach(input => {
        const value = parseFloat(input.value.replace(/[^0-9,-]+/g, "").replace(",", ".")) || 0;
        genelToplam += value;
    });
    document.getElementById('genelToplamTutar').textContent = formatCurrency(genelToplam);
}

async function renderYemSatisListesi() {
    const listBody = document.getElementById('yemSatisListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">YÃ¼kleniyor...</td></tr>';

    try {
        const q = query(
            collection(db, 'yem_satislari'),
            where('sahipId', '==', sahipId),
            orderBy('tarih', 'desc')
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Yem satÄ±ÅŸ hareketi bulunmuyor.</td></tr>';
            return;
        }

        const tumKayitlar = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));

        tumKayitlar.sort((a, b) => {
            if (a.data.tarih > b.data.tarih) return -1;
            if (a.data.tarih < b.data.tarih) return 1;

            const timeA = a.data.kayitZamani?.toDate() || new Date(0);
            const timeB = b.data.kayitZamani?.toDate() || new Date(0);
            return timeB - timeA;
        });

        let rows = '';
        tumKayitlar.forEach(kayit => {
            const satis = kayit.data;
            const yemAdi = window.yemDataMap.get(satis.yemId)?.ad || 'Bilinmiyor';
            const cariAdi = window.cariDataMap.get(satis.cariId)?.adiSoyadi || 'Bilinmiyor';
            
            let tarihSaat = '-';
            if (satis.tarih) {
                tarihSaat = formatDate(satis.tarih);
            }
            if (satis.kayitZamani?.toDate) {
                const time = satis.kayitZamani.toDate().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                tarihSaat = (tarihSaat !== '-') ? `${tarihSaat} ${time}` : formatDateTime(satis.kayitZamani);
            }

            rows += `<tr>
                <td>${tarihSaat}</td>
                <td>${cariAdi}</td>
                <td>${yemAdi}</td>
                <td>${satis.miktar ?? '-'}</td>
                <td>${formatCurrency(satis.satisFiyati)}</td>
                <td>${formatCurrency(satis.toplamTutar)}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemSatisi('${kayit.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemSatisi('${kayit.id}')">Sil</button>
                </td>
            </tr>`;
        });

        listBody.innerHTML = rows;

    } catch (e) {
        console.error("Yem satÄ±ÅŸ hareketleri yÃ¼klenirken hata:", e);
        listBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">Liste yÃ¼klenirken bir hata oluÅŸtu.</td></tr>`;
    }
}
async function editYemSatisi(id) {
    try {
        const docRef = doc(db, 'yem_satislari', id);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
            showToast("DÃ¼zenlenecek kayÄ±t bulunamadÄ±.", true);
            return;
        }
        const data = docSnap.data();
        const formContainer = document.getElementById('toplu-satis-formu');
        const satirContainer = document.getElementById('yemSatisSatirlari');
        
        satirContainer.innerHTML = '';
        editingYemSatisId = id;
        document.getElementById('topluSatisTarih').value = data.tarih;
        document.getElementById('topluSatisCari').value = data.cariId;
        const cariBilgisi = window.cariDataMap.get(data.cariId);
        document.getElementById('yemSatisCariAraInput').value = cariBilgisi ? cariBilgisi.adiSoyadi : 'Cari BulunamadÄ±';
        document.getElementById('topluSatisCari').disabled = false;
        document.getElementById('yemSatisCariAraInput').disabled = false;
        document.getElementById('topluSatisTarih').disabled = false;
        const yeniSatir = await addYemSatisRow();
        const yemSelect = yeniSatir.querySelector('.yem-secimi');
        yemSelect.value = data.yemId;
        yeniSatir.querySelector('.yem-miktari').value = data.miktar;
        yeniSatir.querySelector('.yem-fiyati').value = data.satisFiyati;
        yemSelect.disabled = false;
        updateSatisSatiri(yemSelect);
        const anaKaydetBtn = document.getElementById('tumSatislariKaydetBtn');
        anaKaydetBtn.textContent = 'BÄ°LGÄ°LERÄ° GÃœNCELLE';
        const satirEkleBtn = document.getElementById('yemSatirEkleBtn');
        satirEkleBtn.style.display = 'none';
        let iptalBtn = document.getElementById('guncellemeIptalBtn');
        if (!iptalBtn) {
            iptalBtn = document.createElement('button');
            iptalBtn.id = 'guncellemeIptalBtn';
            iptalBtn.textContent = 'Ä°ptal Et';
            iptalBtn.className = 'btn';
            iptalBtn.type = 'button';
            iptalBtn.onclick = resetTopluSatisFormu;
            anaKaydetBtn.parentNode.insertBefore(iptalBtn, anaKaydetBtn.nextSibling);
        }
        iptalBtn.style.display = 'inline-block';
        formContainer.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error("Yem satÄ±ÅŸÄ± dÃ¼zenleme iÃ§in getirilirken hata:", error);
        showToast("KayÄ±t dÃ¼zenleme iÃ§in yÃ¼klenirken bir hata oluÅŸtu.", true);
    }
}

async function handleTopluYemSatisKaydet() {
    const tarihInput = document.getElementById('topluSatisTarih');
    const cariInput = document.getElementById('topluSatisCari');
    const formTarih = tarihInput.value;
    const formCari = cariInput.value;
    if (!formTarih || !formCari) return showToast("LÃ¼tfen SatÄ±ÅŸ Tarihi ve Cari seÃ§iniz!", true);

    if (editingYemSatisId) {
        const satisRef = doc(db, 'yem_satislari', editingYemSatisId);
        const satir = document.querySelector('#yemSatisSatirlari .yem-satis-satiri');
        if (!satir) return showToast("GÃ¼ncellenecek satÄ±r bulunamadÄ±.", true);
        const yeniMiktar = parseInt(satir.querySelector('.yem-miktari').value);
        const yeniFiyat = parseFloat(satir.querySelector('.yem-fiyati').value);
        if (isNaN(yeniMiktar) || yeniMiktar <= 0 || isNaN(yeniFiyat)) return showToast("Miktar/Fiyat geÃ§ersiz.", true);

        try {
            await runTransaction(db, async (trx) => {
                const satisDoc = await trx.get(satisRef);
                if (!satisDoc.exists()) throw "KayÄ±t bulunamadÄ±.";
                const eskiMiktar = satisDoc.data().miktar;
                const yemId = satisDoc.data().yemId;
                const yemRef = doc(db, 'yemler', yemId);
                trx.update(yemRef, { stokMiktari: increment(eskiMiktar - yeniMiktar) });
                trx.update(satisRef, {
                    tarih: formTarih,
                    cariId: formCari,
                    miktar: yeniMiktar,
                    satisFiyati: yeniFiyat,
                    toplamTutar: yeniMiktar * yeniFiyat,
                    kayitZamani: new Date()
                });
            });
            showToast("SatÄ±ÅŸ gÃ¼ncellendi.");
            resetTopluSatisFormu();
            await renderYemSatisListesi();
            await renderYemStokListesi();
        } catch (e) {
            console.error(e);
            showToast("KayÄ±t hatasÄ±: " + e, true);
        }
        return;
    }

    const satirlar = document.querySelectorAll('.yem-satis-satiri');
    if (satirlar.length === 0) return showToast("En az bir satÄ±r ekleyin.", true);
    const batch = writeBatch(db);
    const now = new Date();
    const satislar = [];
    
    for (const satir of satirlar) {
        const yemId = satir.querySelector('.yem-secimi').value;
        const miktar = parseInt(satir.querySelector('.yem-miktari').value);
        const satisFiyati = parseFloat(satir.querySelector('.yem-fiyati').value);
        if (!yemId || isNaN(miktar) || miktar <= 0 || isNaN(satisFiyati)) return showToast("SatÄ±r bilgileri eksik.", true);
        
        const stokVeri = window.yemDataMap.get(yemId);
        if (!stokVeri || (stokVeri.stokMiktari || 0) < miktar) return showToast(`Yetersiz stok: ${stokVeri?.ad}`, true);

        const yemRef = doc(db, 'yemler', yemId);
        const satisRef = doc(collection(db, 'yem_satislari'));

        batch.set(satisRef, {
            sahipId: sahipId,
            tarih: formTarih,
            kayitZamani: new Date(`${formTarih}T${now.toTimeString().split(' ')[0]}`),
            cariId: formCari,
            yemId: yemId,
            miktar: miktar,
            satisFiyati: satisFiyati,
            toplamTutar: miktar * satisFiyati
        });
        batch.update(yemRef, { stokMiktari: increment(-miktar) });
        satislar.push({}); // Sadece sayÄ±m iÃ§in
    }
    
    try {
        await batch.commit();
        showToast(`${satislar.length} satÄ±r kaydedildi.`);
        resetTopluSatisFormu();
        await renderYemSatisListesi();
        await loadAllYemlerToCache();
    } catch (e) {
        console.error(e);
        showToast("KayÄ±t hatasÄ±: " + e, true);
    }
}

function resetTopluSatisFormu() {
    editingYemSatisId = null; 
    document.getElementById('topluSatisCari').disabled = false;
    document.getElementById('topluSatisTarih').disabled = false;
    document.getElementById('yemSatisCariAraInput').disabled = false;
    document.getElementById('topluSatisCari').value = '';
    document.getElementById('yemSatisCariAraInput').value = '';
    document.getElementById('yemSatisSatirlari').innerHTML = '';
    addYemSatisRow(); 
    updateGenelToplam();
    document.getElementById('tumSatislariKaydetBtn').textContent = 'TÃœM SATIÅLARI KAYDET';
    document.getElementById('yemSatirEkleBtn').style.display = 'inline-block';
    const iptalBtn = document.getElementById('guncellemeIptalBtn');
    if (iptalBtn) iptalBtn.style.display = 'none';
}

function exportTableToExcel(containerId, fileName = 'rapor') {
    const container = document.getElementById(containerId);
    if (!container) return showToast('DÄ±ÅŸa aktarÄ±lacak alan bulunamadÄ±.', true); 
    const table = container.querySelector('table');
    if (!table) return showToast('DÄ±ÅŸa aktarÄ±lacak tablo bulunamadÄ±.', true);
    
    const wb = XLSX.utils.table_to_book(table, { sheet: "Rapor" });
    if (typeof Android !== "undefined" && Android.saveFile) {
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
        Android.saveFile(wbout, `${fileName}.xlsx`);
    } else {
        XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString('tr-TR')}.xlsx`);
    }
}

async function exportTableToPdf(containerId, fileName = 'rapor', buttonId) {
    const container = document.getElementById(containerId);
    if (!container || container.innerHTML.trim().length < 20) {
        return showToast('PDF oluÅŸturmak iÃ§in Ã¶nce bir rapor oluÅŸturun.', true);
    }
    const pdfButton = document.getElementById(buttonId);
    const originalButtonText = pdfButton?.textContent;
    if (pdfButton) {
        pdfButton.textContent = "OluÅŸturuluyor...";
        pdfButton.disabled = true;
    }
    document.body.classList.add('pdf-generating');
    const sourceSection = container.closest('.module-section');
    if (sourceSection) {
        sourceSection.classList.add('pdf-source-section');
    }
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: (containerId === 'dinamikRaporContainer' ? 'landscape' : 'portrait'),
            unit: 'mm',
            format: 'a4'
        });
        const canvas = await html2canvas(container, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff'
        });
        const imgData = canvas.toDataURL('image/png');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = doc.internal.pageSize.getHeight();
        const imgWidth = pdfWidth - 20;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 15;
        doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= (pdfHeight - 25);

        while (heightLeft > 0) {
            position = heightLeft - imgHeight;
            doc.addPage();
            doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;
        }

        if (typeof Android !== "undefined" && Android.saveFile) {
            const base64Data = doc.output('datauristring').split(',')[1];
            Android.saveFile(base64Data, `${fileName}.pdf`);
        } else {
            doc.save(`${fileName}_${new Date().toLocaleDateString('tr-TR')}.pdf`);
        }

    } catch (error) {
        console.error("PDF oluÅŸturulurken hata:", error);
        showToast("PDF oluÅŸturulurken bir hata oluÅŸtu.", true);
    } finally {
        if (pdfButton) {
            pdfButton.textContent = originalButtonText;
            pdfButton.disabled = false;
        }
        document.body.classList.remove('pdf-generating');
        if (sourceSection) {
            sourceSection.classList.remove('pdf-source-section');
        }
    }
}

function handleYazdir(elementId, orientation = 'portrait') {
    const printElement = document.getElementById(elementId);
    if (!printElement) {
        console.error("YazdÄ±rÄ±lacak alan bulunamadÄ±:", elementId);
        return;
    }
    const contentToPrint = printElement.cloneNode(true);
    contentToPrint.querySelectorAll('.dont-print, .list-header-with-filter').forEach(el => el.remove());

    const printStyles = `
        @page {
            size: A4 ${orientation};
            margin: 1cm;
        }
        body { 
            font-family: Arial, Helvetica, sans-serif;
            font-size: 8pt;
            line-height: 1.2;
            -webkit-print-color-adjust: exact;
        }
        h1 { font-size: 10pt; font-weight: normal; color: #666; margin-bottom: 2px; text-align: center; }
        h4 { font-size: 14pt; font-weight: bold; color: #000; margin-bottom: 15px; text-align: center; }
        h5 { text-align: left; margin: 15px 0 8px 0; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
        h3 { font-size: 12pt; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th, td { border: 1px solid #666; padding: 3px 4px; text-align: left; }
        th { font-weight: bold; background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .final-summary p { display: flex; margin: 4px 0; padding: 3px 0; border-bottom: 1px dotted #999; }
        .final-summary p:last-of-type { border-bottom: none; font-size: 1.1em; font-weight: bold; }
        .final-summary span:last-child, .final-summary strong:last-child { margin-left: auto; padding-left: 20px; }
    `;

    const finalHtml = `<!DOCTYPE html><html><head><title>YazdÄ±r</title><style>${printStyles}</style></head><body>${contentToPrint.innerHTML}</body></html>`;

    if (typeof Android !== "undefined" && Android.print) {
        Android.print(finalHtml);
    } else {
        const iframe = document.createElement('iframe');
        iframe.id = 'print-iframe';
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
        const iframeDoc = iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(finalHtml);
        iframeDoc.close();
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
        setTimeout(() => { document.body.removeChild(iframe); }, 1000);
    }
}

</script>

<div id="toast-message" class="toast-message"></div>

<div id="custom-confirm-overlay" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <h3 id="custom-confirm-title">Ä°ÅŸlem OnayÄ±</h3>
        <p id="custom-confirm-message">Bu iÅŸlemi yapmak istediÄŸinizden emin misiniz?</p>
        <div class="custom-modal-buttons">
            <button id="custom-confirm-cancel" class="btn">HayÄ±r</button>
            <button id="custom-confirm-yes" class="btn btn-danger">Evet</button>
        </div>
    </div>
</div>

<div id="custom-prompt-overlay" class="custom-modal-overlay">
    <div class="custom-modal-box">
        <h3 id="custom-prompt-title">Onay Gerekiyor</h3>
        <p id="custom-prompt-message">LÃ¼tfen onay metnini girin.</p>
        <input type="text" id="custom-prompt-input" class="form-control" style="margin-top: 10px;">
        <div class="custom-modal-buttons">
            <button id="custom-prompt-cancel" class="btn">Ä°ptal</button>
            <button id="custom-prompt-ok" class="btn btn-primary">Onayla</button>
        </div>
    </div>
</div>
<div id="makbuz-onay-modal-overlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="max-width: 500px;">
        <h3 id="makbuz-onay-title">Makbuz Ã–nizleme ve Onay</h3>
        <div id="makbuz-onay-icerik" style="line-height: 1.8;">
            <p><strong>MÃ¼stahsil (SatÄ±cÄ±):</strong> <span id="onay-cari-adi"></span></p>
            <hr>
            <p>BrÃ¼t SÃ¼t TutarÄ±: <strong style="float:right;" id="onay-brut-tutar"></strong></p>
            <p style="color:#d9534f;">Gelir Vergisi TevkifatÄ± (%2): <strong style="float:right;" id="onay-gv"></strong></p>
            <p style="color:#d9534f;">SGK TevkifatÄ± (%2): <strong style="float:right;" id="onay-sgk"></strong></p>
            <p style="color:#d9534f;">Borsa Tescil Ãœcreti (%0.2): <strong style="float:right;" id="onay-borsa"></strong></p>
            <hr>
            <p style="font-size: 1.2em;"><strong>Ã–DENECEK NET TUTAR:</strong> <strong style="float:right; font-size: 1.3em;" id="onay-net-tutar"></strong></p>
        </div>
        <div class="custom-modal-buttons">
            <button id="makbuz-onay-cancel" class="btn">Ä°ptal</button>
            <button id="makbuz-onay-confirm" class="btn btn-danger">Onayla ve Makbuzu OluÅŸtur</button>
        </div>
    </div>
</div>

<div id="secim-modal-overlay" class="custom-modal-overlay">
    <div class="custom-modal-box" style="text-align: center;">
        <img src="logo.png" alt="Logo" style="width: 100px; margin-bottom: 20px;">
        <h3 id="custom-confirm-title">LÃ¼tfen Bir ModÃ¼l SeÃ§in</h3>
        <p id="custom-confirm-message">Hangi iÅŸlem merkezine devam etmek istersiniz?</p>
        <div class="custom-modal-buttons" style="flex-direction: column; gap: 15px;">
            <button id="secim-sut-takibi-btn" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 1.1em;">ğŸ“’ Hesap Defteri</button>
<button id="secim-mustahsil-merkezi-btn" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.1em;">ğŸ’¼ Mali MÃ¼ÅŸavir Paneli</button>
        </div>
    </div>
</div>


</body>
</html>
