<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Müşteri Portalı ve Hayvan Takibi</title>
    <meta name="theme-color" content="#2c3e50" />
    <link rel="icon" href="https://raw.githubusercontent.com/sozcelyk43/suttakip/refs/heads/main/favicon.ico" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
    body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;line-height: 1.6;margin: 0;padding: 0;background-color: #f4f7f9;color: #333; font-size: 16px;}
    a.btn {display: flex;flex-direction: column;justify-content: center;align-items: center;text-decoration: none;
	font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
    .main-content {padding: 20px;background-color: #ecf0f1;}
    .container {background-color: #fff;padding: 25px;border-radius: 8px;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);}

    /* --- GÜNCELLENEN BAŞLIK STİLLERİ --- */
    .module-header {
        display: flex;
        align-items: center;
        gap: 20px; /* Logo ve metin arası boşluk */
        background-color: #2c3e50;
        color: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .header-logo {
        flex: 1; /* Alanın 1/3'ünü kapla */
        max-width: 120px; /* Logonun çok büyümesini engelle */
        height: auto; /* Oranı koru */
        object-fit: contain;
        border-radius: 8px;
    }
    .header-text {
        flex: 2; /* Alanın 2/3'ünü kapla */
        text-align: left;
    }
    .module-header h2, .module-header h3 {
        margin: 0;
        line-height: 1.3;
    }
    /* --- BİTİŞ --- */

    .filter-buttons {display: grid;grid-template-columns: 1fr;gap: 10px;margin-bottom: 20px;}
    .filter-row {display: grid;gap: 10px;}
    .filter-row.two-items {grid-template-columns: 1fr 1fr;}
    .filter-row.three-items {grid-template-columns: 1fr 1fr 1fr;}
    .btn {display: inline-block;background-color: #3498db;color: #fff;padding: 12px;text-align: center;border: none;
	border-radius: 6px;cursor: pointer;font-size: 1em;transition: background-color 0.2s;text-transform: uppercase; line-height: 1.2;}
    .btn:hover {background-color: #2980b9;}
    .btn-danger {background-color: #e74c3c;}
    .btn-danger:hover {background-color: #c0392b;}
    .btn-secondary {color: #fff;background-color: #95a5a6;}
    .btn-secondary:hover {background-color: #7f8c8d;}
    .btn-success {background-color: #2ecc71;}
    .btn-success:hover {background-color: #27ae60;}
    .btn-small { padding: 5px 10px; font-size: 0.8em; text-transform: none;}
    .btn-warning { background-color: #f39c12; }
    .btn-warning:hover { background-color: #e67e22; }
    .report-toggle-container {display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px;}
    .btn-toggle {flex: 1; background-color: #bdc3c7; color: #2c3e50; font-weight: normal;}
    .btn-toggle.active {background-color: #3498db; color: #fff; font-weight: bold;}
    table {width: 100%;border-collapse: collapse;margin-top: 10px;font-size: 1em;}
    th, td {padding: 12px 10px;border: 1px solid #ecf0f1;text-align: center;word-break: break-word; vertical-align: middle;}
    th {background-color: #f8f9fa;font-weight: 600;color: #495057;}
    tbody tr:nth-child(odd) {background-color: #ffffff;}
    tbody tr:nth-child(even) {background-color: #f2f6fa;}
    tbody tr:hover {background-color: #f0f8ff;}
    tfoot tr {background-color: #e9ecef;font-weight: bold;color: #2c3e50;}
    select.form-control, input.form-control, textarea.form-control {width: 100%; padding: 10px; border: 1px solid #ccc; 
	border-radius: 4px; box-sizing: border-box; font-size: 1em; 		background-color: #fff;}
    .form-group {margin-bottom: 15px;}
    .form-group label {display: block;margin-bottom: 5px;font-weight: bold; color: #34495e;}
    .form-section {border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-top: 20px; background-color: #fdfdfd;}
    .form-section h2 {border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; color: #2c3e50; margin-top: 0;}
    #logoutUserEmail {font-size: 0.75em;text-transform: lowercase;color: #ecf0f1; margin-top: 2px;}
    .alert-message {display: none; color: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: center; font-weight: bold;}
    .alert-message.error {background-color: #c0392b;}
    .alert-message.success {background-color: #27ae60;}
    .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; 
	background-color: rgba(0,0,0,0.5);}
    .sticky-birth-alert { background-color: #c0392b;color: white;padding: 15px; text-align: center; font-weight: bold; font-size: 1.1em;
    margin-bottom: 10px;border-radius: 0 0 8px 8px;position: sticky;top: 0;z-index: 1001;display: flex;justify-content: space-between;align-items: center;}
    .alert-close-btn {    color: white;    font-size: 24px;    font-weight: bold;    cursor: pointer;    padding-left: 20px;     line-height: 1;}
    .alert-close-btn:hover {    opacity: 0.8;}
    .modal-content {background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;}
    .close-button {color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;}
    
    @media (max-width: 768px) {         
        .container {padding: 15px;border-radius: 0;}        
		.main-content {padding: 0;}
        .module-header {
            border-radius: 0;
            flex-direction: column; /* MOBİLDE ALT ALTA SIRALA */
            text-align: center;   /* MOBİLDE ORTALA */
            gap: 15px;
        }
        .header-text {
            text-align: center; /* METNİ DE ORTALA */
        }
		.filter-row.three-items { display: flex; gap: 10px; flex: 1;}
		table {font-size: 0.85em;}
        th, td {padding: 8px 3px;}    
    }

    @media screen and (max-width: 768px) {    
        #hayvanTakipContainer table,     #hayvanTakipContainer thead,     #hayvanTakipContainer tbody, 
        #hayvanTakipContainer th,     #hayvanTakipContainer td,     #hayvanTakipContainer tr {        display: block;    }
        #hayvanTakipContainer thead tr {        position: absolute;        top: -9999px;        left: -9999px;    }
        #hayvanTakipContainer tr {        border: 1px solid #ccc;        border-radius: 8px;        margin-bottom: 15px;        background-color: #fff;    }
        #hayvanTakipContainer td {        border: none;        border-bottom: 1px solid #eee;        position: relative;        padding-left: 50%; 
        text-align: right;padding-top: 5px;padding-bottom: 5px;display: flex;justify-content: space-between;align-items: center;    }
        #hayvanTakipContainer td:before {        content: attr(data-label);        position: absolute;        left: 10px;        width: 45%;        padding-right: 10px;
        white-space: nowrap;        text-align: left;        font-weight: bold;        color: #2c3e50;    }
        #hayvanTakipContainer td[data-label="İşlemler"] .btn {    flex: 1;}
        #hayvanTakipContainer td[data-label="İşlemler"] {display: flex;justify-content: center;gap: 10px;padding: 15px 10px;border-bottom: none;}
        #hayvanTakipContainer td[data-label="İşlemler"]:before {content: "";}
    }
    #hayvanTakipContainer td[data-label="Küpe No"] {background-color: #e69138;color: white;font-weight: bold;border-top-left-radius: 8px;border-top-right-radius: 8px;}
    #hayvanTakipContainer td[data-label="Küpe No"]::before {    color: white;    font-weight: normal; }
</style>
</head>

<body>
    <div id="sticky-alert-container"></div>

    <div class="main-content">
        <div class="module-header">
            <img src="logo.png" alt="Logo" class="header-logo">
            <div class="header-text">
                <h2>MÜŞTERİ PANELİ</h2>
                <h3>Hoş Geldiniz, <span id="musteriAdi">...</span></h3>
            </div>
        </div>

        <div class="container">
            <div id="portal-message" class="alert-message"></div>
            <div class="filter-buttons">
                <div class="filter-row two-items">
                    <a href="sifre_degistir.html" class="btn btn-secondary">Şifre Değiştir</a>
                    <a href="#" id="logoutButton" class="btn btn-danger"><div>Çıkış Yap</div><div id="logoutUserEmail"></div></a>
                </div>
                  <div class="filter-row three-items">
    			<button id="yeniHayvanBtn" class="btn">Yeni Hayvan Ekle</button>
    			<button id="yeniTohumlamaBtn" class="btn btn-warning">Yeni Tohumlama Ekle</button>
    			<button id="yeniDogumBtn" class="btn btn-success">Yeni Doğum Ekle</button>
		  </div>
                <hr>
                <div class="filter-row three-items">
                    <select id="ayFiltresi" class="form-control"></select>
                    <select id="yilFiltresi" class="form-control"></select>
                    <button id="raporGosterBtn" class="btn">Raporları Göster</button>
                </div>
            </div>

            <div id="raporlarSection" style="display:none;">
                <div id="reportToggleButtons" class="report-toggle-container">
                    <button id="hayvanTakipBtn" class="btn btn-toggle">Hayvan Takip Raporu</button>
                    <button id="sutRaporuBtn" class="btn btn-toggle">Süt Raporu</button>
                    <button id="yemRaporuBtn" class="btn btn-toggle">Yem Raporu</button>
                </div>
                <div id="hayvanTakipContainer" style="display: none;">
    	<table><thead><tr><th>Küpe No</th><th>Irk</th><th>Gebelik Durumu</th><th>Son Tohumlama Tarihi</th><th>Tahmini Doğum Tarihi</th><th>Kalan Gün</th><th>İşlemler</th></tr></thead>
        <tbody id="hayvanListesiBody"></tbody>
    </table>
<div class="load-more-container" style="text-align: center; margin-top: 20px;">
        <button id="loadMoreBtn" class="btn" style="display:none;">Daha Fazla Yükle</button>
    </div>
</div>
                <div id="sutRaporuContainer" style="display:none;">
                    <table>
                        <thead><tr><th>Tarih</th><th>Akşam (lt)</th><th>Sabah (lt)</th><th>Toplam (lt)</th></tr></thead>
                        <tbody id="sutListesiBody"></tbody>
                        <tfoot id="sutListesiFooter"></tfoot>
                    </table>
                </div>
                <div id="yemRaporuContainer" style="display: none;"></div>
            </div>

          
<section id="yeniHayvanSection" class="form-section" style="display: none;">
    <h2>Yeni Hayvan Kaydı Ekle</h2>
    <form id="yeniHayvanForm">
        <div class="form-group">
            <label for="yeni-hayvan-kupe">Küpe Numarası</label>
            <input type="text" id="yeni-hayvan-kupe" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="yeni-hayvan-irk">Irk</label>
            <select id="yeni-hayvan-irk" class="form-control">
                <option value="Angus">Angus</option>
                <option value="Charolais (Şarole)">Charolais (Şarole)</option>
                <option value="Hereford">Hereford</option>
                <option value="Holstein">Holstein</option>
                <option value="Jersey">Jersey</option>
                <option value="Limousin (Limuzin)">Limousin (Limuzin)</option>
                <option value="Montofon (Esmer)">Montofon (Esmer)</option>
                <option value="Simental (Fleckvieh)">Simental (Fleckvieh)</option>
                <option value="Diğer">Diğer</option>
            </select>
        </div>

          <div class="form-group">
            <label for="yeni-hayvan-cinsiyet">Cinsiyet</label>
            <select id="yeni-hayvan-cinsiyet" class="form-control">
                <option value="Dişi">Dişi</option>
                <option value="Erkek">Erkek</option>
            </select>
        </div>

        <div class="form-group">
            <label for="yeni-hayvan-rumuz">Rumuz (Lakap)</label>
            <input type="text" id="yeni-hayvan-rumuz" class="form-control" placeholder="Örn: Sarıkız, Paşa...">
        </div>
        <div class="form-group">
            <label for="yeni-hayvan-dogum-tarihi">Doğum Tarihi</label>
            <input type="date" id="yeni-hayvan-dogum-tarihi" class="form-control" required>
        </div>

        <div class="form-group">
            <label for="yeni-hayvan-gebelik-durumu">Gebelik Durumu</label>
            <select id="yeni-hayvan-gebelik-durumu" class="form-control">
                <option value="Boş" selected>Boş</option>
                <option value="Gebe">Gebe</option>
            </select>
        </div>
        <button type="submit" class="btn">Hayvanı Kaydet</button>
    </form>
</section>

<section id="yeniTohumlamaSection" class="form-section" style="display: none;">
    <h2>Yeni Tohumlama Kaydı Ekle</h2>
    <form id="yeniTohumlamaForm">
        <div class="form-group">
		<label for="tohumlama-hayvan-kupe">Hayvan Küpe Numarası</label>
		<select id="tohumlama-hayvan-kupe" class="form-control" required></select></div>
        <div class="form-group"><label for="tohumlama-tarihi">Tohumlama Tarihi</label><input type="date" id="tohumlama-tarihi" class="form-control" required></div>
        <div class="form-group">
            <label for="tohumlama-tipi">Tohumlama Tipi</label>
            <select id="tohumlama-tipi" class="form-control">
                <option value="Suni Tohumlama">Suni Tohumlama</option>
                <option value="Doğal Aşım">Doğal Aşım</option>
            </select>
        </div>
        <div class="form-group"><label for="boga-sperma-kodu">Boğa / Sperma Kodu</label><input type="text" id="boga-sperma-kodu" class="form-control"></div>
        <div class="form-group">
            <label for="tohumlama-notlari">Tohumlama Notları</label>
            <textarea id="tohumlama-notlari" class="form-control" rows="3" placeholder="Kısa notlar..."></textarea>
        </div>
        <button type="submit" class="btn btn-warning">Tohumlama Kaydını Oluştur</button>
    </form>
</section>



<section id="yeniDogumSection" class="form-section" style="display: none;">
    <h2>Yeni Doğum Kaydı Ekle</h2>
    <form id="yeniDogumForm">
        <div class="form-group">
            <label for="anne-kupe">Anne Küpe Numarası</label>
            <select id="anne-kupe" class="form-control" required></select>
        </div>
        <div class="form-group">
            <label for="dogum-tarihi-saati">Doğum Tarihi ve Saati</label>
            <input type="datetime-local" id="dogum-tarihi-saati" class="form-control" required>
        </div>
        <div class="form-group">
            <label for="yavru-sayisi">Yavru Sayısı</label>
            <input type="number" id="yavru-sayisi" class="form-control" value="1" min="1">
        </div>
        <div class="form-group">
            <label for="dogum-sekli">Doğum Şekli</label>
            <select id="dogum-sekli" class="form-control">
                <option value="Normal">Normal</option>
                <option value="Zor">Zor</option>
                <option value="Sezaryen">Sezaryen</option>
            </select>
        </div>
<div id="yavruBilgileriContainer">
    </div>
        <div class="form-group">
            <label for="dogum-notlari">Doğum Notları</label>
            <textarea id="dogum-notlari" class="form-control" rows="3" placeholder="Annenin veya yavrunun sağlık durumu, doğum süreci vb. hakkında notlar..."></textarea>
        </div>
        <button type="submit" class="btn btn-success">Doğum Kaydını Tamamla</button>
    </form>
</section>
</div>
</div>
    
    <div id="editHayvanModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Hayvan Bilgilerini Düzenle</h2>
            <form id="editHayvanForm">
                <input type="hidden" id="edit-hayvan-id">
                <div class="form-group">
                    <label for="edit-hayvan-kupe">Küpe Numarası</label>
                    <input type="text" id="edit-hayvan-kupe" class="form-control" required>
                </div>

<div class="form-group">
    <label for="edit-hayvan-rumuz">Rumuz (Lakap)</label>
    <input type="text" id="edit-hayvan-rumuz" class="form-control">
</div>



<div class="form-group">
    <label for="edit-hayvan-cinsiyet">Cinsiyet</label>
    <select id="edit-hayvan-cinsiyet" class="form-control">
        <option value="Erkek">Erkek</option>
        <option value="Dişi">Dişi</option>
    </select>
</div>
               <div class="form-group">
    <label for="edit-hayvan-irk">Irk</label>
    <select id="edit-hayvan-irk" class="form-control">
        <option value="Angus">Angus</option>
        <option value="Charolais (Şarole)">Charolais (Şarole)</option>
        <option value="Hereford">Hereford</option>
        <option value="Holstein">Holstein</option>
        <option value="Jersey">Jersey</option>
        <option value="Limousin (Limuzin)">Limousin (Limuzin)</option>
        <option value="Montofon (Esmer)">Montofon (Esmer)</option>
        <option value="Simental (Fleckvieh)">Simental (Fleckvieh)</option>
        <option value="Diğer">Diğer</option>
    </select>
</div>
                <div class="form-group">
                    <label for="edit-hayvan-dogum-tarihi">Doğum Tarihi</label>
                    <input type="date" id="edit-hayvan-dogum-tarihi" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-hayvan-gebelik-durumu">Gebelik Durumu</label>
                    <select id="edit-hayvan-gebelik-durumu" class="form-control">
                        <option value="Boş">Boş</option>
                        <option value="Gebe">Gebe</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="edit-son-tohumlama-tarihi">Son Tohumlama Tarihi (Gebe ise)</label>
                    <input type="date" id="edit-son-tohumlama-tarihi" class="form-control">
                </div>
                <button type="submit" class="btn">Değişiklikleri Kaydet</button>
            </form>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, where, query, orderBy, limit, startAfter, runTransaction, deleteField, documentId } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
        authDomain: "sut-takip-projem.firebaseapp.com",
        projectId: "sut-takip-projem",
        storageBucket: "sut-takip-projem.appspot.com",
        messagingSenderId: "512756958486",
        appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
        measurementId: "G-LYLT9WFVNK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userCariId = null;
    let userSahipId = null;
    let lastVisibleDoc = null;
    const PAGE_SIZE = 25;

    const portalMessage = document.getElementById('portal-message');
    const raporlarSection = document.getElementById('raporlarSection');
    const yeniHayvanSection = document.getElementById('yeniHayvanSection');
    const yeniTohumlamaSection = document.getElementById('yeniTohumlamaSection');
    const yeniDogumSection = document.getElementById('yeniDogumSection');
    const editModal = document.getElementById('editHayvanModal');

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            try {
                const userDocRef = doc(db, 'kullanicilar', user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    showPortalMessage("Kullanıcı profiliniz bulunamadı. Lütfen yönetici ile iletişime geçin.", "error");
                    signOut(auth);
                    return;
                }

                const userRole = userDoc.data().rol;
                if (userRole === 'admin') {
                    window.location.href = 'index.html';
                    return;
                } else if (userRole === 'calisan') {
                    window.location.href = 'hizli-giris.html';
                    return;
                }

                const carilerRef = collection(db, 'cariler');
                const q = query(carilerRef, where('authUID', '==', user.uid), limit(1));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const cariDoc = snapshot.docs[0];
                    const cariData = cariDoc.data();
                    userCariId = cariDoc.id;
                    userSahipId = cariData.sahipId;
                    document.getElementById('musteriAdi').textContent = cariData.adiSoyadi;
                    document.getElementById('logoutUserEmail').textContent = user.email;

                    if (!userSahipId) {
                        showPortalMessage("Müşteri profili hatası.", "error");
                        return;
                    }
                    setupPage();
                } else {
                    showPortalMessage("Bu hesaba bağlı müşteri kartı bulunamadı.", "error");
                }
            } catch (error) {
                console.error("Kullanıcı doğrulanırken hata:", error);
                showPortalMessage("Bilgiler yüklenirken bir hata oluştu.", "error");
            }
        } else {
            window.location.href = 'login.html';
        }
    });

    function showPortalMessage(message, type = 'error') {
        const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 10000, // 3000'den 10000'e değiştirildi (10 saniye)
    timerProgressBar: true,
    didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer);
        toast.addEventListener('mouseleave', Swal.resumeTimer);
    }
});

        Toast.fire({
            icon: type,
            title: message
        });
    }

    function showSection(sectionToShow) {
        const dynamicAlerts = document.querySelectorAll('[data-alert-id]');
        dynamicAlerts.forEach(alert => alert.remove());
        raporlarSection.style.display = 'none';
        yeniHayvanSection.style.display = 'none';
        yeniTohumlamaSection.style.display = 'none';
        yeniDogumSection.style.display = 'none';
        if (sectionToShow) sectionToShow.style.display = 'block';
    }

    function setupPage() {
        refreshAllData();
        document.getElementById('yeniHayvanBtn').addEventListener('click', () => showSection(yeniHayvanSection));
        document.getElementById('yeniTohumlamaBtn').addEventListener('click', () => showSection(yeniTohumlamaSection));
        document.getElementById('yeniDogumBtn').addEventListener('click', () => showSection(yeniDogumSection));
        
        document.getElementById('raporGosterBtn').addEventListener('click', () => {
            showSection(raporlarSection);
            const ayYil = `${document.getElementById('yilFiltresi').value}-${document.getElementById('ayFiltresi').value}`;
            fetchSutHareketleri(ayYil);
            fetchYemHareketleri(ayYil);
            fetchHayvanTakipVerileri(false);
            document.getElementById('hayvanTakipBtn').click();
        });

        document.getElementById('loadMoreBtn').addEventListener('click', () => {
            fetchHayvanTakipVerileri(true);
        });

        const aySelect = document.getElementById('ayFiltresi');
        const yilSelect = document.getElementById('yilFiltresi');
        const now = new Date();
        const ayIsimleri = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        ayIsimleri.forEach((ay, index) => {
            aySelect.add(new Option(ay, String(index + 1).padStart(2, '0')));
        });
        aySelect.value = String(now.getMonth() + 1).padStart(2, '0');
        for (let yil = now.getFullYear() + 1; yil >= 2000; yil--) {
            yilSelect.add(new Option(yil, yil));
        }
        yilSelect.value = now.getFullYear();

        document.getElementById('yavru-sayisi').addEventListener('input', (e) => {
            const yavruSayisi = parseInt(e.target.value) || 0;
            const container = document.getElementById('yavruBilgileriContainer');
            container.innerHTML = '';

            for (let i = 1; i <= yavruSayisi; i++) {
                const yavruHtml = `
                    <div style="border: 1px solid #eee; padding: 15px; border-radius: 5px; margin-bottom:15px;">
                        <strong>${i}. Yavru Bilgileri</strong>
                        <div class="form-group" style="margin-top:10px;"><label for="yavru-kupe-${i}">Yavru Küpe No:</label><input type="text" id="yavru-kupe-${i}" class="form-control" placeholder="Örn: TR34055" required></div>
                        <div class="form-group"><label for="yavru-cinsiyet-${i}">Cinsiyet:</label><select id="yavru-cinsiyet-${i}" class="form-control"><option value="Dişi">Dişi</option><option value="Erkek">Erkek</option></select></div>
                        <div class="form-group"><label for="yavru-agirlik-${i}">Doğum Ağırlığı (kg):</label><input type="text" id="yavru-agirlik-${i}" class="form-control" placeholder="Örn: 42.5"></div>
                    </div>`;
                container.innerHTML += yavruHtml;
            }
        });
        document.getElementById('yavru-sayisi').dispatchEvent(new Event('input'));

        const toggleButtons = {
            hayvanTakipBtn: document.getElementById('hayvanTakipContainer'),
            sutRaporuBtn: document.getElementById('sutRaporuContainer'),
            yemRaporuBtn: document.getElementById('yemRaporuContainer')
        };
        Object.keys(toggleButtons).forEach(btnId => {
            document.getElementById(btnId).addEventListener('click', (e) => {
                Object.values(toggleButtons).forEach(c => c.style.display = 'none');
                Object.keys(toggleButtons).forEach(b => document.getElementById(b).classList.remove('active'));
                toggleButtons[btnId].style.display = 'block';
                e.target.classList.add('active');
            });
        });

        document.getElementById('yeniHayvanForm').addEventListener('submit', handleHayvanKayitSubmit);
        document.getElementById('yeniTohumlamaForm').addEventListener('submit', handleTohumlamaSubmit);
        document.getElementById('yeniDogumForm').addEventListener('submit', handleDogumSubmit);
        document.getElementById('editHayvanForm').addEventListener('submit', handleUpdateHayvan);
        document.getElementById('hayvanListesiBody').addEventListener('click', handleTableActions);
        document.querySelector('.close-button').addEventListener('click', () => editModal.style.display = "none");
        window.addEventListener('click', (event) => {
            if (event.target == editModal) {
                editModal.style.display = "none";
            }
        });
    }

    async function refreshAllData() {
        await populateHayvanlarSelects();
        await fetchHayvanTakipVerileri();
        await checkUpcomingBirths();
    }

    async function handleHayvanKayitSubmit(event) {
        event.preventDefault();
        const kupeNo = document.getElementById('yeni-hayvan-kupe').value;
        const dogumTarihi = document.getElementById('yeni-hayvan-dogum-tarihi').value;
        if (!kupeNo || !dogumTarihi) {
            showPortalMessage("Küpe Numarası ve Doğum Tarihi zorunludur.", "error");
            return;
        }

        try {
            const hayvanlarRef = collection(db, 'hayvanlar');
            await addDoc(hayvanlarRef, {
    kupeNo: kupeNo,
    irk: document.getElementById('yeni-hayvan-irk').value,
    cinsiyet: document.getElementById('yeni-hayvan-cinsiyet').value,
    rumuz: document.getElementById('yeni-hayvan-rumuz').value || null, // EKLENDİ
    dogumTarihi: dogumTarihi,
    gebəlikDurumu: document.getElementById('yeni-hayvan-gebelik-durumu').value,
    sahipId: userSahipId,
    cariId: userCariId
});
            showPortalMessage("Hayvan başarıyla kaydedildi.", "success");
            event.target.reset();
            refreshAllData();
        } catch (error) {
            showPortalMessage("Hayvan kaydedilirken hata oluştu.", "error");
        }
    }

    function handleTableActions(event) {
        const target = event.target;
        const hayvanId = target.dataset.id;

        if (target.classList.contains('btn-delete')) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: "Bu hayvanı kalıcı olarak silmek üzeresiniz. Bu işlem geri alınamaz!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Evet, sil!',
                cancelButtonText: 'İptal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await deleteDoc(doc(db, 'hayvanlar', hayvanId));
                        showPortalMessage("Hayvan başarıyla silindi.", "success");
                        refreshAllData();
                    } catch (e) {
                        console.error(e);
                        showPortalMessage("Silme işlemi sırasında bir hata oluştu.", "error");
                    }
                }
            });
        } else if (target.classList.contains('btn-edit')) {
            const docRef = doc(db, 'hayvanlar', hayvanId);
            getDoc(docRef).then(docSnap => {
                if (docSnap.exists()) {
                    const hayvan = docSnap.data();
                    document.getElementById('edit-hayvan-id').value = docSnap.id;
                    document.getElementById('edit-hayvan-kupe').value = hayvan.kupeNo || '';
document.getElementById('edit-hayvan-rumuz').value = hayvan.rumuz || '';
                    document.getElementById('edit-hayvan-irk').value = hayvan.irk || '';
                    document.getElementById('edit-hayvan-cinsiyet').value = hayvan.cinsiyet || 'Dişi';
                    document.getElementById('edit-hayvan-dogum-tarihi').value = hayvan.dogumTarihi || '';
                    document.getElementById('edit-hayvan-gebelik-durumu').value = hayvan.gebəlikDurumu || 'Boş';
                    document.getElementById('edit-son-tohumlama-tarihi').value = hayvan.sonTohumlamaTarihi || '';
                    editModal.style.display = 'block';
                }
            });
        }
    }

    async function handleUpdateHayvan(event) {
        event.preventDefault();
        const hayvanId = document.getElementById('edit-hayvan-id').value;
        const tohumlamaTarihi = document.getElementById('edit-son-tohumlama-tarihi').value;
        let tahminiDogumTarihi = null;
        if (tohumlamaTarihi) {
            const tohumlamaDate = new Date(tohumlamaTarihi);
            const tahminiDogumDate = new Date(tohumlamaDate.setDate(tohumlamaDate.getDate() + 283));
            tahminiDogumTarihi = tahminiDogumDate.toISOString().split('T')[0];
        }

        const dataToUpdate = {
            kupeNo: document.getElementById('edit-hayvan-kupe').value,
rumuz: document.getElementById('edit-hayvan-rumuz').value || null,
            irk: document.getElementById('edit-hayvan-irk').value,
            cinsiyet: document.getElementById('edit-hayvan-cinsiyet').value,
            dogumTarihi: document.getElementById('edit-hayvan-dogum-tarihi').value,
            gebəlikDurumu: document.getElementById('edit-hayvan-gebelik-durumu').value,
            sonTohumlamaTarihi: tohumlamaTarihi || deleteField(),
            tahminiDogumTarihi: tahminiDogumTarihi || deleteField()
        };

        try {
            const docRef = doc(db, 'hayvanlar', hayvanId);
            await updateDoc(docRef, dataToUpdate);
            showPortalMessage("Hayvan bilgileri güncellendi.", "success");
            editModal.style.display = "none";
            refreshAllData();
        } catch (error) {
            showPortalMessage("Güncelleme başarısız.", "error");
        }
    }

    document.getElementById('logoutButton').addEventListener('click', (e) => {
        e.preventDefault();
        signOut(auth).then(() => window.location.href = 'login.html');
    });

    function formatSayi(sayi) {
        if (typeof sayi !== 'number') sayi = 0;
        return (sayi % 1 === 0) ? sayi.toString() : sayi.toFixed(2).replace('.', ',');
    }

    async function populateHayvanlarSelects() {
    const tohumlamaSelect = document.getElementById('tohumlama-hayvan-kupe');
    const dogumSelect = document.getElementById('anne-kupe');
    tohumlamaSelect.innerHTML = '<option value="">Tohumlanacak hayvanı seçin...</option>';
    dogumSelect.innerHTML = '<option value="">Doğum yapan anneyi seçin...</option>';

    try {
        const hayvanlarRef = collection(db, 'hayvanlar');
        const q = query(hayvanlarRef, 
                        where('sahipId', '==', userSahipId), 
                        where('cariId', '==', userCariId), 
                        orderBy('kupeNo'));
        
        const snapshot = await getDocs(q);

        if (snapshot.empty) return;

        snapshot.forEach(doc => {
            const hayvan = doc.data();
            // Menüde rumuz bilgisini de göstererek daha kullanışlı hale getirelim
            const optionText = `${hayvan.kupeNo} (${hayvan.rumuz || 'Rumuz Yok'}) - ${hayvan.gebəlikDurumu || 'Boş'}`;
            const option = new Option(optionText, doc.id);
            
            if (hayvan.cinsiyet === 'Dişi' && hayvan.gebəlikDurumu !== 'Gebe') {
                tohumlamaSelect.add(option.cloneNode(true));
            }
            if (hayvan.gebəlikDurumu === 'Gebe') {
                dogumSelect.add(option.cloneNode(true));
            }
        });
    } catch (error) {
        console.error("Hayvan select menüleri doldurulurken hata:", error);
        showPortalMessage("Menüler için hayvan listesi yüklenemedi.", "error");
    }
}

    async function handleTohumlamaSubmit(event) {
        event.preventDefault();
        const hayvanId = document.getElementById('tohumlama-hayvan-kupe').value;
        const tohumlamaTarihi = document.getElementById('tohumlama-tarihi').value;
        if (!hayvanId || !tohumlamaTarihi) {
            showPortalMessage("Hayvan ve tohumlama tarihini seçin.", "error");
            return;
        }
        const tohumlamaDate = new Date(tohumlamaTarihi);
        const tahminiDogumDate = new Date(tohumlamaDate.setDate(tohumlamaDate.getDate() + 283));
        const tahminiDogumTarihi = tahminiDogumDate.toISOString().split('T')[0];
        try {
            const hayvanRef = doc(db, 'hayvanlar', hayvanId);
            await updateDoc(hayvanRef, {
                gebəlikDurumu: 'Gebe',
                sonTohumlamaTarihi: tohumlamaTarihi,
                tahminiDogumTarihi: tahminiDogumTarihi
            });
            
            const tohumlamaKayitlariRef = collection(db, 'tohumlama_kayitlari');
            await addDoc(tohumlamaKayitlariRef, {
                sahipId: userSahipId,
                cariId: userCariId,
                hayvanId: hayvanId,
                tarih: tohumlamaTarihi,
                tip: document.getElementById('tohumlama-tipi').value,
                bogaKodu: document.getElementById('boga-sperma-kodu').value,
                notlar: document.getElementById('tohumlama-notlari').value
            });

            showPortalMessage("Tohumlama başarıyla kaydedildi.", "success");
            event.target.reset();
            refreshAllData();
        } catch (error) {
            showPortalMessage("Kayıt sırasında bir hata oluştu.", "error");
        }
    }

    async function handleDogumSubmit(event) {
        event.preventDefault();
        const anneId = document.getElementById('anne-kupe').value;
        const dogumTarihiSaati = document.getElementById('dogum-tarihi-saati').value;
        const yavruSayisi = parseInt(document.getElementById('yavru-sayisi').value) || 0;

        if (!anneId || !dogumTarihiSaati || yavruSayisi === 0) {
            showPortalMessage("Anne, Doğum Tarihi ve Yavru Sayısı alanları zorunludur.", "error");
            return;
        }

        for (let i = 1; i <= yavruSayisi; i++) {
            if (!document.getElementById(`yavru-kupe-${i}`).value) {
                showPortalMessage(`${i}. yavrunun küpe numarası boş bırakılamaz.`, "error");
                return;
            }
        }
        
        const dogumTarihi = dogumTarihiSaati.split('T')[0];
        const anneRef = doc(db, 'hayvanlar', anneId);

        try {
            await runTransaction(db, async (transaction) => {
                transaction.update(anneRef, {
                    gebəlikDurumu: 'Boş',
                    sonTohumlamaTarihi: deleteField(),
                    tahminiDogumTarihi: deleteField()
                });

                for (let i = 1; i <= yavruSayisi; i++) {
                    const yavruKupeNo = document.getElementById(`yavru-kupe-${i}`).value;
                    const yeniYavruRef = doc(collection(db, 'hayvanlar'));

                    transaction.set(yeniYavruRef, {
                        kupeNo: yavruKupeNo,
                        cinsiyet: document.getElementById(`yavru-cinsiyet-${i}`).value,
                        dogumAgirligi: document.getElementById(`yavru-agirlik-${i}`).value || null,
                        dogumTarihi: dogumTarihi,
                        anneId: anneId,
                        sahipId: userSahipId,
                        cariId: userCariId,
                        gebəlikDurumu: 'Boş',
                        irk: 'Bilinmiyor'
                    });

                    const dogumKaydiRef = doc(collection(db, 'dogum_kayitlari'));
                    transaction.set(dogumKaydiRef, {
                        anneId: anneId,
                        yavruId: yeniYavruRef.id,
                        yavruKupeNo: yavruKupeNo,
                        tarih: dogumTarihiSaati,
                        yavruSayisi: yavruSayisi,
                        dogumSekli: document.getElementById('dogum-sekli').value,
                        notlar: document.getElementById('dogum-notlari').value,
                        sahipId: userSahipId,
                        cariId: userCariId,
                    });
                }
            });
            showPortalMessage("Doğum kaydı ve yavrular başarıyla oluşturuldu.", "success");
            event.target.reset();
            document.getElementById('yavru-sayisi').dispatchEvent(new Event('input'));
            refreshAllData();
        } catch (error) {
            showPortalMessage("Kayıt sırasında bir hata oluştu: " + error.message, "error");
        }
    }

async function fetchHayvanTakipVerileri(isLoadMore = false) {
    const listBody = document.getElementById('hayvanListesiBody');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    if (!isLoadMore) {
        lastVisibleDoc = null;
        // Yeni sütunlar eklendiği için colspan 9 olmalı
        listBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Hayvan verileri yükleniyor...</td></tr>`;
    }

    try {
        const hayvanlarRef = collection(db, 'hayvanlar');
        let q;

        if (isLoadMore && lastVisibleDoc) {
            q = query(hayvanlarRef,
                where('sahipId', '==', userSahipId),
                where('cariId', '==', userCariId),
                orderBy('tahminiDogumTarihi', 'asc'), // SIRALAMA DÜZELTİLDİ
                startAfter(lastVisibleDoc),
                limit(PAGE_SIZE));
        } else {
            q = query(hayvanlarRef,
                where('sahipId', '==', userSahipId),
                where('cariId', '==', userCariId),
                orderBy('tahminiDogumTarihi', 'asc'), // SIRALAMA DÜZELTİLDİ
                limit(PAGE_SIZE));
        }

        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty && !isLoadMore) {
            // Yeni sütunlar eklendiği için colspan 9 olmalı
            listBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Kayıtlı hayvan bulunmuyor.</td></tr>`;
            loadMoreBtn.style.display = 'none';
            return;
        }

        if (!isLoadMore) {
            listBody.innerHTML = '';
        }

        let rows = '';
        querySnapshot.forEach(doc => {
            const hayvan = doc.data();
            let kalanGun = '-';
            let tahminiDogumTarihiStr = '-';
            const sonTohumlamaTarihiStr = hayvan.sonTohumlamaTarihi ? new Date(hayvan.sonTohumlamaTarihi + 'T00:00:00').toLocaleDateString('tr-TR') : '-';
            if (hayvan.gebəlikDurumu === 'Gebe' && hayvan.tahminiDogumTarihi) {
                const tahminiDogumTarihi = new Date(hayvan.tahminiDogumTarihi);
                kalanGun = Math.ceil((tahminiDogumTarihi - new Date()) / (1000 * 60 * 60 * 24));
                tahminiDogumTarihiStr = tahminiDogumTarihi.toLocaleDateString('tr-TR');
            }
            rows += `<tr>
                <td data-label="Küpe No"><strong>${hayvan.kupeNo}</strong></td>
                <td data-label="Irk">${hayvan.irk || '-'}</td>
                <td data-label="Cinsiyet">${hayvan.cinsiyet || '-'}</td>
                <td data-label="Rumuz">${hayvan.rumuz || '-'}</td>
                <td data-label="Gebelik Durumu">${hayvan.gebəlikDurumu || '-'}</td>
                <td data-label="Son Tohumlama">${sonTohumlamaTarihiStr}</td>
                <td data-label="Tahmini Doğum">${tahminiDogumTarihiStr}</td>
                <td data-label="Kalan Gün">${kalanGun}</td>
                <td data-label="İşlemler">
                    <button class="btn btn-secondary btn-small btn-edit" data-id="${doc.id}">Düzenle</button>
                    <button class="btn btn-danger btn-small btn-delete" data-id="${doc.id}">Sil</button>
                </td>
            </tr>`;
        });

        listBody.innerHTML += rows;
        lastVisibleDoc = querySnapshot.docs[querySnapshot.docs.length - 1];

        if (querySnapshot.docs.length < PAGE_SIZE) {
            loadMoreBtn.style.display = 'none';
        } else {
            loadMoreBtn.style.display = 'inline-block';
        }

    } catch (error) {
        console.error("Hayvan verileri yüklenirken hata:", error);
        // Yeni sütunlar eklendiği için colspan 9 olmalı
        listBody.innerHTML = `<tr><td colspan="9" style="text-align:center; color:red;">Veriler yüklenemedi.</td></tr>`;
    }
}


async function checkUpcomingBirths() {
    try {
        const hayvanlarRef = collection(db, 'hayvanlar');
        const q = query(hayvanlarRef, where('sahipId', '==', userSahipId), where('cariId', '==', userCariId), where('gebəlikDurumu', '==', 'Gebe'));
        const snapshot = await getDocs(q);

        if (snapshot.empty) return;

        const upcomingBirthsMessages = [];

        snapshot.forEach(doc => {
            const hayvan = doc.data();
            if (hayvan.tahminiDogumTarihi) {
                const tahminiDogum = new Date(hayvan.tahminiDogumTarihi + 'T00:00:00');
                const bugun = new Date();
                bugun.setHours(0, 0, 0, 0);

                const kalanGun = Math.ceil((tahminiDogum - bugun) / (1000 * 60 * 60 * 24));

                if (kalanGun >= 0 && kalanGun <= 15) {
                    let messageText = '';
                    if (kalanGun > 0) {
                        messageText = `<b>${hayvan.kupeNo}</b> küpeli hayvanın doğumuna <b>${kalanGun} gün</b> kaldı!`;
                    } else {
                        messageText = `<b>${hayvan.kupeNo}</b> küpeli hayvanın <b>bugün</b> doğum yapması bekleniyor!`;
                    }
                    upcomingBirthsMessages.push(messageText);
                }
            }
        });

        if (upcomingBirthsMessages.length > 0) {
            const notificationTitle = upcomingBirthsMessages.length > 1 ?
                'Yaklaşan Doğumlar Var!' :
                'Yaklaşan Bir Doğum Var!';
            
            const notificationHtml = `<ul style="text-align: left; list-style-position: inside; margin: 0; padding: 0;">
                ${upcomingBirthsMessages.map(msg => `<li>${msg}</li>`).join('')}
            </ul>`;

            Swal.fire({
                icon: 'warning',
                title: notificationTitle,
                html: notificationHtml,
                timer: 15000,
                timerProgressBar: true,
            });
        }
    } catch (error) {
        console.error("Doğum kontrolü sırasında hata: ", error);
    }
}
    async function fetchSutHareketleri(ayYil) {
        const [year, month] = ayYil.split('-');
        const listBody = document.getElementById('sutListesiBody');
        listBody.innerHTML = `<tr><td colspan="4">Yükleniyor...</td></tr>`;
        document.getElementById('sutListesiFooter').innerHTML = '';
        try {
            const sutAlimlariRef = collection(db, 'sut_alimlari');
            const q = query(sutAlimlariRef,
                where('sahipId', '==', userSahipId),
                where('cariId', '==', userCariId),
                where('tarih', '>=', `${year}-${month}-01`),
                where('tarih', '<=', `${year}-${month}-31`),
                orderBy('tarih', 'asc'));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                listBody.innerHTML = `<tr><td colspan="4">Bu dönem için kayıt yok.</td></tr>`;
                return;
            }
            const gunlukVeri = new Map();
            snapshot.forEach(doc => {
                const alim = doc.data();
                if (!gunlukVeri.has(alim.tarih)) {
                    gunlukVeri.set(alim.tarih, {
                        aksam: 0,
                        sabah: 0,
                        toplam: 0
                    });
                }
                const gun = gunlukVeri.get(alim.tarih);
                gun.aksam += alim.aksam || 0;
                gun.sabah += alim.sabah || 0;
                gun.toplam += alim.toplam || 0;
            });
            let rows = '',
                donemToplamLitre = 0;
            Array.from(gunlukVeri.keys()).sort().forEach(tarih => {
                const data = gunlukVeri.get(tarih);
                donemToplamLitre += data.toplam;
                rows += `<tr><td>${new Date(tarih + 'T00:00:00').toLocaleDateString('tr-TR')}</td><td>${formatSayi(data.aksam)}</td><td>${formatSayi(data.sabah)}</td><td><strong>${formatSayi(data.toplam)}</strong></td></tr>`;
            });
            listBody.innerHTML = rows;
            document.getElementById('sutListesiFooter').innerHTML = `<tr><td colspan="3"><strong>DÖNEM TOPLAMI</strong></td><td><strong>${formatSayi(donemToplamLitre)}</strong></td></tr>`;
        } catch (error) {
            listBody.innerHTML = `<tr><td colspan="4" style="color:red;">Veriler yüklenemedi.</td></tr>`;
        }
    }

    async function fetchYemHareketleri(ayYil) {
        const yemRaporuContainer = document.getElementById('yemRaporuContainer');
        yemRaporuContainer.innerHTML = `<p>Yükleniyor...</p>`;
        const [year, month] = ayYil.split('-');
        try {
            const yemSatislariRef = collection(db, 'yem_satislari');
            const q = query(yemSatislariRef,
                where('sahipId', '==', userSahipId),
                where('cariId', '==', userCariId),
                where('tarih', '>=', `${year}-${month}-01`),
                where('tarih', '<=', `${year}-${month}-31`));
            const satisSnapshot = await getDocs(q);

            if (satisSnapshot.empty) {
                yemRaporuContainer.innerHTML = `<p>Bu dönem için kayıt yok.</p>`;
                return;
            }
            const yemOzet = new Map();
            satisSnapshot.forEach(doc => {
                const satis = doc.data();
                yemOzet.set(satis.yemId, (yemOzet.get(satis.yemId) || 0) + satis.miktar);
            });
            if (yemOzet.size === 0) {
                yemRaporuContainer.innerHTML = `<p>Bu dönem için kayıt yok.</p>`;
                return;
            }

            const yemlerRef = collection(db, 'yemler');
            const yemlerQuery = query(yemlerRef, where(documentId(), 'in', Array.from(yemOzet.keys())));
            const yemlerSnapshot = await getDocs(yemlerQuery);

            const yemIsimleri = new Map();
            yemlerSnapshot.forEach(doc => yemIsimleri.set(doc.id, doc.data().ad || 'Bilinmeyen'));
            let tableHTML = `<table><thead><tr><th>Yem Adı</th><th>Toplam Miktar</th></tr></thead><tbody>`;
            let toplamYemMiktari = 0;
            yemOzet.forEach((miktar, yemId) => {
                toplamYemMiktari += miktar;
                tableHTML += `<tr><td>${yemIsimleri.get(yemId)}</td><td><strong>${miktar}</strong></td></tr>`;
            });
            tableHTML += `</tbody><tfoot><tr><td><strong>TOPLAM</strong></td><td><strong>${toplamYemMiktari}</strong></td></tr></tfoot></table>`;
            yemRaporuContainer.innerHTML = tableHTML;
        } catch (error) {
            yemRaporuContainer.innerHTML = `<p style="color:red;">Yem verileri yüklenemedi.</p>`;
        }
    }
</script>

</body>
</html>