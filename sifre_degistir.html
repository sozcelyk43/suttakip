<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Şifre Değiştir</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;line-height: 1.6;margin: 0;padding: 0;background-color: #f4f7f9;color: #333; font-size: 16px;}
        .main-content {padding: 20px;max-width: 600px; margin: 50px auto;}
        .container {background-color: #fff;padding: 25px;border-radius: 8px;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);}
        .module-header {background-color: #2c3e50;color: #fff;padding: 20px;border-radius: 8px;margin-bottom: 20px; text-align: center;}
        .module-header h2 {margin: 0;}
        .form-group {margin-bottom: 15px;}
        .form-group label {display: block;margin-bottom: 5px;font-weight: bold; color: #34495e;}
        input[type="password"], input[type="text"] {width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em;}
        .btn {display: inline-block; text-decoration: none; background-color: #3498db;color: #fff;padding: 12px 20px;text-align: center;border: none;
	    border-radius: 6px;cursor: pointer;font-size: 1em;transition: background-color 0.2s;text-transform: uppercase; line-height: 1.2;}
        .btn:hover {background-color: #2980b9;}
        .btn-secondary {background-color: #95a5a6;}
        .btn-secondary:hover {background-color: #7f8c8d;}
        .button-group { margin-top: 20px; display: flex; gap: 10px; justify-content: space-between; }
        .button-group .btn { flex-grow: 1; }
        @media (max-width: 768px) {
            .main-content {padding: 0; margin: 0;}
            .container {padding: 20px; border-radius:0;}
            .module-header {border-radius:0;}
        }
    </style>
</head>
<body>
    <div class="main-content">
         <div class="module-header">
             <h2>Şifrenizi Güncelleyin</h2>
         </div>
         <div class="container">
             <form id="sifreDegistirForm">
                <div class="form-group">
                    <label for="yeniSifre">Yeni Şifre:</label>
                    <input type="password" id="yeniSifre" required placeholder="En az 6 karakter olmalı">
                </div>
                <div class="form-group">
                    <label for="yeniSifreTekrar">Yeni Şifre (Tekrar):</label>
                    <input type="password" id="yeniSifreTekrar" required>
                </div>
                <hr style="border-top: 1px solid #eee; border-bottom: 0; margin: 25px 0;">
                <div class="form-group">
                    <label for="eskiSifre">Mevcut (Eski) Şifreniz:</label>
                    <input type="password" id="eskiSifre" required placeholder="Değişikliği doğrulamak için gerekli">
                </div>
                <div class="button-group">
                     <a href="musteri_portali.html" class="btn btn-secondary">Geri Dön</a>
                     <button type="submit" class="btn">Şifreyi Güncelle</button>
                </div>
             </form>
         </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
            authDomain: "sut-takip-projem.firebaseapp.com",
            projectId: "sut-takip-projem",
            storageBucket: "sut-takip-projem.appspot.com",
            messagingSenderId: "512756958486",
            appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
            measurementId: "G-LYLT9WFVNK"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        
        // Kullanıcı giriş yapmamışsa login sayfasına yönlendir
        onAuthStateChanged(auth, user => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        const sifreDegistirForm = document.getElementById('sifreDegistirForm');
        sifreDegistirForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const eskiSifre = document.getElementById('eskiSifre').value;
            const yeniSifre = document.getElementById('yeniSifre').value;
            const yeniSifreTekrar = document.getElementById('yeniSifreTekrar').value;

            // 4. GÜNCELLEME: Modern SweetAlert2 ile hata ve başarı bildirimleri
            if (yeniSifre.length < 6) {
                Swal.fire({ icon: 'error', title: 'Hata', text: 'Yeni şifre en az 6 karakter olmalıdır!' });
                return;
            }
            if (yeniSifre !== yeniSifreTekrar) {
                Swal.fire({ icon: 'error', title: 'Hata', text: 'Girdiğiniz yeni şifreler birbiriyle uyuşmuyor!' });
                return;
            }
            if (!eskiSifre) {
                 Swal.fire({ icon: 'error', title: 'Hata', text: 'Lütfen değişikliği onaylamak için mevcut şifrenizi girin.' });
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                Swal.fire({ icon: 'error', title: 'Oturum Hatası', text: 'Kullanıcı bulunamadı. Lütfen tekrar giriş yapın.' });
                return;
            }

            // Firebase'in güvenlik gereği, şifre değiştirmeden önce kullanıcının kimliğini yeniden doğrulaması gerekir.
            const credential = EmailAuthProvider.credential(user.email, eskiSifre);

            try {
                // Önce kimliği yeniden doğrula
                await reauthenticateWithCredential(user, credential);
                
                // Kimlik doğrulama başarılıysa şifreyi güncelle
                await updatePassword(user, yeniSifre);

                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı!',
                    text: 'Şifreniz başarıyla güncellendi. Güvenlik nedeniyle çıkış yapılıyor, lütfen yeni şifrenizle tekrar giriş yapın.',
                    timer: 5000,
                    timerProgressBar: true,
                    willClose: () => {
                        signOut(auth).then(() => {
                            window.location.href = 'login.html';
                        });
                    }
                });

            } catch (error) {
                console.error("Şifre güncelleme hatası:", error);
                if (error.code === 'auth/wrong-password') {
                    Swal.fire({ icon: 'error', title: 'Hata', text: 'Girdiğiniz mevcut (eski) şifre hatalı!' });
                } else {
                    Swal.fire({ icon: 'error', title: 'Beklenmedik Hata', text: 'Şifre güncellenirken bir hata oluştu. Lütfen tekrar deneyin.' });
                }
            }
        });
    </script>
</body>
</html>