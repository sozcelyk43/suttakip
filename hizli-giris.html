<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gelişmiş Süt Girişi</title>
<style>
        :root {
        --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
        --danger-color: #dc3545; --warning-color: #ffc107; --light-color: #f8f9fa;
        --dark-color: #343a40; --border-color: #dee2e6; --white-color: #fff;        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: var(--light-color); 
	color: var(--dark-color); }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
	header {
    background-color: #2c3e50;
    color: white;
    padding: 16px 20px;
    text-align: center;
    border-bottom-left-radius: 15px;
    border-bottom-right-radius: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}	border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
	display: flex; justify-content: space-between; align-items: center;}
        header h1 {
    margin: 0;
    font-size: 1.4em;
    flex-grow: 1;
    text-align: left;
    white-space: nowrap;
}
        main { padding: 20px 0; }
#logoutButton {
    background-color: #dc3545; /* Bootstrap kırmızı tonu */
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.95em;
    font-weight: 600;
    transition: background-color 0.2s ease;
}

#logoutButton:hover {
    background-color: #b02a37;
}

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 1.1em; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; 
	box-sizing: border-box; }
        .time-selection { display: flex; gap: 10px; }
        .time-selection input[type="radio"] { display: none; }
        .time-selection label { flex: 1; text-align: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; 	font-weight: 600; }
        .time-selection input:not(:checked) + label { background-color: #f8f9fa; border: 1px solid #dee2e6; color: #6c757d; }
        .time-selection input:not(:checked) + label:hover { background-color: #e9ecef; border-color: #adb5bd; }
        .time-selection input:checked + label { color: white; font-weight: 700; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border: 2px solid rgba(0,0,0,0.1); }
        .time-selection input[id="aksam"]:checked + label { background-color: #ff8c00; }
        .time-selection input[id="sabah"]:checked + label { background-color: #28a745; }
        #producer-panel, #history-section { background-color: var(--white-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); 
		box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 25px; }
        #current-producer-name { font-size: 1.5em; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; text-align: center; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; } /* Değişiklik: Skip butonu için ayarlandı */
        .btn { padding: 15px; font-size: 1.1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        #session-summary { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 1.1em; }
        #history-list { list-style: none; padding: 0; margin: 0; }
        .history-item:nth-child(odd) { background-color: #f1f1f1; }
        .history-item:nth-child(even) { background-color: #ffffff; }
	.history-item {display: flex;align-items: center;gap: 10px;padding: 10px 8px;border-bottom: 1px solid #444; }
	.history-item-main {flex-grow: 1;min-width: 0; }
	.history-item-main .producer-name {font-weight: 600;font-size: 1em;display: block; }
	.history-item-details {flex-shrink: 0;text-align: right;font-size: 0.9em;line-height: 1.4;}
	.history-item-actions {    flex-shrink: 0;    display: flex;    align-items: center;}
	.inline-edit-form {    display: flex;    align-items: center;    gap: 8px;    margin-top: 6px;}
	.btn-inline-save, .btn-inline-cancel {    padding: 4px 8px;    font-size: 1em;    cursor: pointer;}
        .btn-icon {background: none; border: none; font-size: 1.3em; margin: 0 4px; cursor: pointer;padding: 4px; border-radius: 6px; transition: 
		background-color 0.2s; vertical-align: 	middle; }
        .btn-icon:hover { background-color: #e2e6ea; }
        .btn-delete { color: var(--danger-color); }
        #cancel-edit-btn { display: none; margin-top: 10px; width: 100%; background-color: var(--danger-color); color: var(--white-color); }
        .toast-message { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 12px 20px; border-radius: 8px; 
		box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 1000; font-size: 1.1em; font-weight: 500; display: none; opacity: 0; transition: opacity 0.5s ease; }
        .toast-message.show { display: block; opacity: 1; }
	.history-producer-name {flex-shrink: 1;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: inline-block;max-width: 150px;vertical-align: middle; }
	.action-buttons {position: -webkit-sticky;position: sticky;bottom: 0;z-index: 10;background-color: var(--light-color);padding-top: 10px;padding-bottom: 10px;
        	border-top: 1px solid var(--border-color);}

.btn-inline-save {
    background-color: var(--success-color);
    color: white;
}

.btn-inline-cancel {
    background-color: var(--danger-color);
    color: white;
}
.edit-full-box {
    width: 100%;
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-sizing: border-box;
}

.edit--icons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.1em;
    gap: 8px;
}

.edit-producer-name {
    color: var(--primary-color);
    font-weight: 700;
    font-size: 1em;
    flex-grow: 1;
}

.edit-summary {
    display: flex;
    justify-content: space-between;
    font-size: 1em;
}

.edit-full-input {
    width: 100%;
    padding: 10px;
    font-size: 1em;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-sizing: border-box;
}

.edit-full-actions {
    display: flex;
    gap: 10px;
    width: 100%;
}

.edit-full-actions button {
    flex: 1;
    padding: 12px;
    font-size: 1em;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

.btn-inline-save {
    background-color: var(--success-color);
    color: white;
}

.btn-inline-cancel {
    background-color: var(--danger-color);
    color: white;
}

/* YENİ EKLENEN STİLLER BAŞLANGIÇ */
.quantity-wrapper {
    position: relative;
    margin-bottom: 15px;
}

#quantity {
    background-color: var(--white-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    width: 100%;
    height: 80px;
    padding: 10px 120px 10px 20px;
    font-size: 2.8em;
    font-weight: bold;
    text-align: right;
    color: var(--dark-color);
    box-sizing: border-box;
}

.quantity-wrapper::after {
    content: 'Litre';
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    color: #aaa;
    font-size: 1.5em;
    font-weight: normal;
}

#keypad-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.keypad-btn {
    padding: 15px; /* <--- Yüksekliği azaltmak için değeri düşürdük */
    font-size: 1.6em; /* <--- Yazı boyutunu da orantılı olarak biraz azalttık */
    font-weight: 600;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background-color: #fff;
    cursor: pointer;
    transition: background-color 0.2s;
    user-select: none;
}

.keypad-btn:active {
    background-color: #e9ecef;
}

.keypad-btn.action {
    background-color: var(--warning-color);
    color: var(--dark-color);
    font-weight: bold;
}


/* YENİ EKLENEN ÖZEL UYARI PENCERESİ STİLLERİ */
.custom-alert-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    display: none; /* Başlangıçta gizli */
    justify-content: center;
    align-items: center;
    padding: 15px;
    box-sizing: border-box;
}

.custom-alert-box {
    background-color: var(--white-color);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 100%;
    max-width: 400px;
    text-align: center;
    transform: scale(0.9);
    transition: transform 0.2s ease-out;
}

.custom-alert-overlay.show .custom-alert-box {
    transform: scale(1);
}

#custom-alert-message {
    font-size: 1.2em;
    color: var(--dark-color);
    margin-top: 0;
    margin-bottom: 20px;
    line-height: 1.5;
    white-space: pre-wrap; /* \n karakterlerinin çalışması için */
}

.custom-alert-buttons {
    display: flex;
    justify-content: space-around;
    gap: 15px;
}

.custom-alert-buttons button {
    flex-grow: 1;
}
/* YENİ EKLENEN ROTA AKTİF STİLLERİ */
main.route-active .form-group[data-step="1"] {
    display: none;
}

/* Kategori seçimi ve Değiştir butonunu yan yana getirmek için */
.category-selection-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
}

.category-selection-wrapper select {
    flex-grow: 1; /* Seçim kutusunun boşluğu doldurmasını sağlar */
}

/* Değiştir butonunun stili */
#resetRouteBtn {
    display: none; /* Başlangıçta gizli */
    padding: 10px 16px;
    background-color: var(--secondary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    flex-shrink: 0; /* Küçülmesini engeller */
    transition: background-color 0.2s;
}

#resetRouteBtn:hover {
    background-color: var(--dark-color);
}

/* Ana gövdede .route-active class'ı varken butonu göster */
main.route-active #resetRouteBtn {
    display: inline-block;
}
/* Dropdown'daki ismi başlık gibi göstermek için yeni stil */
#producer-select {
    font-weight: 700; /* Yazıyı kalın yapar ('bold' ile aynı) */
    font-size: 1.3em; /* Yazıyı biraz büyütür */
    text-align: center; /* İsmi ortalar */
color: var(--danger-color);
}


</style>
</head>
<body>
    <div id="toast-message" class="toast-message"></div>
    <div class="container">
        <header>
            <h1>Süt Giriş</h1>
            <button id="logoutButton">Çıkış</button>
        </header>
        <main>
    <form id="setup-form" onsubmit="return false;">
        <input type="hidden" id="editingSutAlimId">
        <div class="form-group" data-step="1">
            <label for="collection-date">Süt Alım Tarihi</label>
            <input type="date" id="collection-date" name="collection-date">
        </div>
        <div class="form-group" data-step="1">
            <label for="unit-price">Süt Birim Fiyatı (₺)</label>
            <input type="number" id="unit-price" name="unit-price" step="0.01">
        </div>
        <div class="form-group">
    <label for="category">
        Kategori/Köy (Rota)
    </label>
    <div class="category-selection-wrapper">
        <select id="category" name="category"></select>
        <button type="button" id="resetRouteBtn">Değiştir</button>
    </div>
</div>
        <div class="form-group">
    <label>Zaman</label>
    <div class="time-selection">
        <input type="radio" id="aksam" name="time" value="aksam" checked><label for="aksam">AKŞAM</label>
        <input type="radio" id="sabah" name="time" value="sabah"><label for="sabah">SABAH</label>
    </div>
    
<div style="text-align: right; margin-top: 10px; padding-right: 5px;">
    <span id="gunlukGenelToplamGosterge" style="color: var(--primary-color); font-weight: bold; font-size: 1.1em;"></span>
</div>



</div>
    </form>

    <div id="producer-panel" style="display: none;">
    <h2 id="current-producer-name" style="display: none;">Üretici Adı</h2>
        <div class="form-group">
    <label for="producer-select" style="text-align: center;">Rota Dışı Seçim / Üretici Atlama</label>
    <select id="producer-select" name="producer-select"></select>
</div>
        <div class="quantity-wrapper">
            <input type="text" id="quantity" name="quantity" readonly>
        </div>
        <div id="keypad-container">
            <button type="button" class="keypad-btn">1</button>
            <button type="button" class="keypad-btn">2</button>
            <button type="button" class="keypad-btn">3</button>
            <button type="button" class="keypad-btn">4</button>
            <button type="button" class="keypad-btn">5</button>
            <button type="button" class="keypad-btn">6</button>
            <button type="button" class="keypad-btn">7</button>
            <button type="button" class="keypad-btn">8</button>
            <button type="button" class="keypad-btn">9</button>
            <button type="button" class="keypad-btn action">Sil</button>
            <button type="button" class="keypad-btn">0</button>
            <button type="button" class="keypad-btn">.</button>
        </div>
        <div class="form-group" style="display: none;">
            <label for="notes">Açıklama</label>
            <textarea id="notes" name="notes" rows="3"></textarea>
        </div>
        <div class="action-buttons">
            <button type="button" id="skip-btn" class="btn btn-secondary">PAS GEÇ</button>
            <button type="button" id="save-btn" class="btn btn-success">KAYDET</button>
            <button type="button" id="cancel-edit-btn" class="btn btn-danger" style="grid-column: 1 / -1;">İptal</button>
        </div>
    </div>

    <section id="history-section" style="display: none;">
        <h2>Süt Alım Geçmişi (Bu Oturum)</h2>
        <div id="session-summary"></div>
        <ul id="history-list"></ul>
    </section>
</main>


    </div>
	
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
                authDomain: "sut-takip-projem.firebaseapp.com",
                projectId: "sut-takip-projem",
                storageBucket: "sut-takip-projem.appspot.com",
                messagingSenderId: "512756958486",
                appId: "1:512756958486:web:13cceb6835e2c575e9fc37"
            };
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- YARDIMCI FONKSİYONLAR ---
        function showCustomConfirm(message, onConfirm, onCancel) {
            const overlay = document.getElementById('custom-alert-overlay');
            const messageP = document.getElementById('custom-alert-message');
            const confirmBtn = document.getElementById('custom-alert-confirm');
            const cancelBtn = document.getElementById('custom-alert-cancel');

            messageP.innerText = message;
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('show'), 10);

            const close = () => {
                overlay.classList.remove('show');
                setTimeout(() => {
                    overlay.style.display = 'none';
                    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                }, 200);
            };

            document.getElementById('custom-alert-confirm').addEventListener('click', () => {
                close();
                if (onConfirm) onConfirm();
            }, { once: true });

            document.getElementById('custom-alert-cancel').addEventListener('click', () => {
                close();
                if (onCancel) onCancel();
            }, { once: true });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.style.backgroundColor = isError ? 'var(--danger-color)' : 'var(--success-color)';
            
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        // --- YARDIMCI FONKSİYONLAR BİTİŞ ---

        let fullHistoryForDate = [];
        let allProducersMap = new Map();
        let sahipId = '';
        let currentUserRole = '';
        let routeProducers = [], collectionHistory = [];
        let currentProducerIndex = 0;
        let editingEntry = null;

        const collectionDateInput = document.getElementById('collection-date');
        const unitPriceInput = document.getElementById('unit-price');
        const categorySelect = document.getElementById('category');
        const producerPanel = document.getElementById('producer-panel');
        const currentProducerName = document.getElementById('current-producer-name');
        const producerSelect = document.getElementById('producer-select');
        const quantityInput = document.getElementById('quantity');
        const notesInput = document.getElementById('notes');
        const saveBtn = document.getElementById('save-btn');
        const skipBtn = document.getElementById('skip-btn');
        const historySection = document.getElementById('history-section');
        const historyList = document.getElementById('history-list');
        const sessionSummary = document.getElementById('session-summary');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editingSutAlimIdInput = document.getElementById('editingSutAlimId');
        const gunlukGenelToplamGosterge = document.getElementById('gunlukGenelToplamGosterge');
        const keypadContainer = document.getElementById('keypad-container');
	 


        auth.onAuthStateChanged(user => {
            if (user) {
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && user.email) {
                    logoutButton.innerHTML = `🚪 Çıkış Yap<br><small style="font-weight:normal; font-size:0.8em;">${user.email}</small>`;
                }
                db.collection('kullanicilar').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        sahipId = userData.sahipId || user.uid;
                        currentUserRole = userData.rol;
                        initializeApp();
                    } else {
                        showToast("Kullanıcı profili bulunamadı.", true);
                        auth.signOut();
                    }
                });
            } else { window.location.href = 'login.html'; }
        });

        keypadContainer.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') return;
            const key = e.target.textContent;
            if (key === 'Sil') {
                quantityInput.value = quantityInput.value.slice(0, -1);
            } else if (key === '.') {
                if (!quantityInput.value.includes('.')) { quantityInput.value += '.'; }
            } else {
                quantityInput.value += key;
            }
        });

        async function initializeApp() {
            collectionDateInput.value = new Date().toISOString().split('T')[0];
            const settings = await getSettings();
            unitPriceInput.value = settings.defaultMilkPrice ? settings.defaultMilkPrice.toFixed(2) : "15.50";
            const producersSnapshot = await db.collection('cariler').where('sahipId', '==', sahipId).get();
            producersSnapshot.forEach(doc => allProducersMap.set(doc.id, doc.data()));
            
            await populateCategories();
            await fetchAndRenderHistory(collectionDateInput.value);
            await showDailyGrandTotal();

            collectionDateInput.addEventListener('change', async () => {
                await fetchAndRenderHistory(collectionDateInput.value);
                await showDailyGrandTotal();
                if (categorySelect.value) { startRoute(); }
            });

const resetRouteBtn = document.getElementById('resetRouteBtn');
if (resetRouteBtn) {
    resetRouteBtn.addEventListener('click', () => {
        categorySelect.value = ''; // Dropdown'ı sıfırla
        startRoute(); // Arayüzü başlangıç durumuna getirmek için tetikle
    });
}
            categorySelect.addEventListener('change', startRoute);
            producerSelect.addEventListener('change', jumpToProducer);
            saveBtn.addEventListener('click', handleSave);
            skipBtn.addEventListener('click', handleSkip);
            cancelEditBtn.addEventListener('click', cancelEditMode);
            const inputsToTriggerRoute = [...document.querySelectorAll('input[name="time"]')];
            inputsToTriggerRoute.forEach(el => {
                el.addEventListener('change', () => { 
                    if (categorySelect.value) { startRoute(); } 
                    else { filterAndRenderHistory(); }
                });
            });
        } 
       
        async function getSettings() {
            if (!sahipId) return {};
            try {
                const doc = await db.collection('ayarlar').doc(sahipId).get();
                return doc.exists ? doc.data() : {};
            } catch (e) { console.error("Ayarlar alınamadı:", e); return {}; }
        }

        function filterAndRenderHistory() {
            const selectedCategory = categorySelect.value;
            let historyToRender = fullHistoryForDate;

            if (selectedCategory) {
                historyToRender = fullHistoryForDate.filter(entry => {
                    const producer = allProducersMap.get(entry.cariId);
                    return producer && producer.kategori === selectedCategory;
                });
            }
            renderHistory(historyToRender);
        }

        function getDayDifference(dateStr) {
            const today = new Date();
            const entryDate = new Date(dateStr);
            today.setHours(0, 0, 0, 0);
            entryDate.setHours(0, 0, 0, 0);
            return Math.ceil((today - entryDate) / (1000 * 60 * 60 * 24));
        }

        async function handleSaveAndNext() {
            const quantity = parseFloat(String(quantityInput.value).replace(',', '.')) || 0;
            if (isNaN(quantity) || quantity < 0) {
                showToast('Lütfen geçerli bir miktar girin.', true);
                return;
            }
            // `checkPreviousDayDifference` artık callback ile çalışıyor
            checkPreviousDayDifference(() => {
                saveMilkEntry(quantity, notesInput.value);
            });
        }

function handleSkip() {
    const producerName = routeProducers[currentProducerIndex]?.adiSoyadi || 'Bu üretici';
    
    // Uyarı mesajını yeni duruma göre güncelledik
    const message = `'${producerName}' için işlem seçin:\n\n"TAMAM" derseniz: 'Süt Yok' olarak (0 Lt) kaydedilir.\n\n"İPTAL" derseniz: Kişi listenin sonuna ertelenir.`;
    
    showCustomConfirm(message,
        () => {
            // "Tamam"a basılınca eskisi gibi 0 Lt kaydeder
            saveMilkEntry(0, "Süt yok");
        },
        () => {
            // "İptal"e basılınca artık yeni fonksiyonu çağırır
            skipAndMoveToEnd();
        }
    );
}

        function populateCategories() {
            db.collection('cari_kategorileri').where('sahipId', '==', sahipId).orderBy('ad').get()
                .then(snapshot => {
                    categorySelect.innerHTML = '<option value="">Rota Seçiniz...</option>';
                    snapshot.forEach(doc => {
                        categorySelect.innerHTML += `<option value="${doc.data().ad}">${doc.data().ad}</option>`;
                    });
                }).catch(e => {
                    console.error("Kategoriler yüklenirken hata:", e);
                    categorySelect.innerHTML = '<option value="" disabled selected>Hata: Rotalar yüklenemedi</option>';
                });
        }

async function startRoute() {
    filterAndRenderHistory();
    const category = categorySelect.value;
    const mainElement = document.querySelector('main');

    // Sadece bir class ekleyip çıkararak arayüzü yönetiyoruz
    if (category) {
        mainElement.classList.add('route-active');
    } else {
        mainElement.classList.remove('route-active');
        producerPanel.style.display = 'none';
        return;
    }

    try {
        const producersSnapshot = await db.collection('cariler')
            .where('sahipId', '==', sahipId)
            .where('kategori', '==', category)
            .where('durum', '==', 'aktif')
            .where('cariGrup', 'array-contains', 'üretici')
            .orderBy('rotaSirasi').get();

        // Artık document'ta arama yapıyoruz çünkü butonların yeri hiç değişmiyor
        const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
        
        const savedProducerIds = new Set(
            fullHistoryForDate
                .filter(entry => typeof entry[zamanDilimi] !== 'undefined' && entry[zamanDilimi] !== null)
                .map(entry => entry.cariId)
        );

        routeProducers = producersSnapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(p => !savedProducerIds.has(p.id));

        currentProducerIndex = 0;
        populateProducerSelect();
        
        if (routeProducers.length > 0) {
            producerPanel.style.display = 'block';
            displayCurrentProducer();
        } else {
            producerPanel.style.display = 'none';
            showToast("Bu rota için tüm girişler tamamlandı.");
        }

    } catch (error) { 
        console.error("Rota başlatılırken hata:", error); 
        showToast("Rota başlatılamadı!", true);
    }
}     



// YENİ EKLENDİ - Üreticiyi listenin sonuna taşıyan fonksiyon
function skipAndMoveToEnd() {
    // Listede 1 veya daha az kişi varsa bir şey yapma
    if (routeProducers.length <= 1) return;

    // Mevcut üreticiyi al
    const skippedProducer = routeProducers[currentProducerIndex];
    
    // Mevcut konumundan kaldır
    routeProducers.splice(currentProducerIndex, 1);
    
    // Listenin sonuna ekle
    routeProducers.push(skippedProducer);
    
    // Dropdown listesini yeni sıraya göre güncelle
    populateProducerSelect();
    
    // Eğer listenin sonundaki elemanı atladıysak, indeksi başa al
    if (currentProducerIndex >= routeProducers.length) {
        currentProducerIndex = 0;
    }

    // Bir sonraki (yeni sıradaki) üreticiyi göster
    displayCurrentProducer();
}



 async function saveMilkEntry(quantity, notes) {
            const unitPrice = parseFloat(String(unitPriceInput.value).replace(',', '.')) || 0;
            const alimTarihi = collectionDateInput.value;
            const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
            const currentProducer = routeProducers[currentProducerIndex];

            if (!currentProducer) {
                showToast("Hata: İşlem yapılacak geçerli bir üretici bulunamadı.", true);
                return;
            }
            if (isNaN(unitPrice) || !alimTarihi) {
                showToast('Lütfen Fiyat ve Tarih seçimlerini doğru yapın.', true);
                return;
            }
            saveBtn.disabled = true;
            skipBtn.disabled = true;

            try {
                const sutAlimQuery = db.collection('sut_alimlari').where('sahipId', '==', sahipId).where('cariId', '==', currentProducer.id).where('tarih', '==', alimTarihi);
                const existingSutAlimSnapshot = await sutAlimQuery.get();
                const batch = db.batch();

                if (existingSutAlimSnapshot.empty) {
                    const sutAlimRef = db.collection('sut_alimlari').doc();
                    let newData = {
                        tarih: alimTarihi, cariId: currentProducer.id, cariAdi: currentProducer.adiSoyadi,
                        fiyat: unitPrice, sahipId: sahipId, aciklama: `Hızlı giriş ile eklendi. Not: ${notes || ''}`
                    };
                    newData[zamanDilimi] = quantity;
                    newData.toplam = quantity;
                    newData.toplamTutar = quantity * unitPrice;
                    batch.set(sutAlimRef, newData);
                } else {
                    const sutAlimRef = existingSutAlimSnapshot.docs[0].ref;
                    const existingData = existingSutAlimSnapshot.docs[0].data() || {};
                    const updatePayload = {
                        fiyat: unitPrice,
                        aciklama: `Hızlı giriş ile güncellendi. Not: ${notes || ''}`
                    };
                    updatePayload[zamanDilimi] = quantity;
                    const sabahMiktari = (zamanDilimi === 'sabah') ? quantity : (existingData.sabah || 0);
                    const aksamMiktari = (zamanDilimi === 'aksam') ? quantity : (existingData.aksam || 0);
                    updatePayload.toplam = sabahMiktari + aksamMiktari;
                    updatePayload.toplamTutar = updatePayload.toplam * unitPrice;
                    batch.update(sutAlimRef, updatePayload);
                }
                
                await batch.commit();
                await fetchAndRenderHistory(alimTarihi);
                await showDailyGrandTotal();
                showToast(`✅ ${currentProducer.adiSoyadi} için ${quantity} Lt kaydedildi.`);
                advanceToNextProducer();
                
            } catch (error) {
                console.error("Kayıt Hatası:", error);
                showToast("Veri kaydedilirken bir hata oluştu: " + error.message, true);
            } finally {
                saveBtn.disabled = false;
                skipBtn.disabled = false;
            }
        }

        async function fetchAndRenderHistory(date) {
            if (!date) return;
            fullHistoryForDate = []; 
            historySection.style.display = 'none';
            historyList.innerHTML = '';

            try {
                const existingEntriesSnapshot = await db.collection('sut_alimlari')
                    .where('sahipId', '==', sahipId)
                    .where('tarih', '==', date)
                    .get();
                fullHistoryForDate = existingEntriesSnapshot.docs.map(doc => ({ ...doc.data(), sutAlimId: doc.id }));
                filterAndRenderHistory();
            } catch (error) {
                console.error("Geçmiş verileri alınırken bir hata oluştu:", error);
            }
        }

        function displayCurrentProducer() {
            if (currentProducerIndex >= routeProducers.length) {
                producerPanel.style.display = 'none';
                showToast(`${categorySelect.options[categorySelect.selectedIndex].text} rotası tamamlandı!`);
                return;
            }
            const producer = routeProducers[currentProducerIndex];
            currentProducerName.textContent = producer.adiSoyadi;
            producerSelect.value = currentProducerIndex;
            quantityInput.value = '';
            notesInput.value = '';
        }

        async function showDailyGrandTotal() {
            const displayElement = document.getElementById('gunlukGenelToplamGosterge');
            const date = collectionDateInput.value;
            if (!date) {
                displayElement.textContent = '';
                return;
            }
            displayElement.textContent = 'Hesaplanıyor...';

            try {
                const snapshot = await db.collection('sut_alimlari')
                    .where('sahipId', '==', sahipId)
                    .where('tarih', '==', date)
                    .get();

                let genelToplam = 0;
                const toNumber = (val) => parseFloat(String(val || 0).replace(',', '.')) || 0;

                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        genelToplam += toNumber(data.sabah) + toNumber(data.aksam);
                    });
                }
                displayElement.textContent = `Mevcut: ${genelToplam.toFixed(1)} Lt`;
            } catch (error) {
                console.error("Günlük genel toplam alınırken hata:", error);
                displayElement.textContent = 'Hata!';
            }
        }
       
        function populateProducerSelect() {
            producerSelect.innerHTML = '';
            routeProducers.forEach((producer, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${producer.adiSoyadi}`;
                producerSelect.appendChild(option);
            });
        }

        function jumpToProducer() {
            currentProducerIndex = parseInt(this.value);
            displayCurrentProducer();
        }

        function renderHistory(dataToRender) {
            if (!historySection || !historyList || !sessionSummary || !dataToRender || dataToRender.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            const zaman = document.querySelector('input[name="time"]:checked').value;
            historySection.style.display = 'block';
            historyList.innerHTML = '';
            let sessionTotalMilk = 0;
            let sessionTotalAmount = 0;
            const sortedData = [...dataToRender].sort((a, b) => {
                const orderA = allProducersMap.get(a.cariId)?.rotaSirasi || 999;
                const orderB = allProducersMap.get(b.cariId)?.rotaSirasi || 999;
                return orderA - orderB;
            });

            sortedData.forEach(item => {
                const isSabah = zaman === 'sabah';
                const miktar = isSabah ? item.sabah : item.aksam;
                if (miktar !== undefined && miktar !== null) {
                    const birimFiyat = item.fiyat || 0;
                    const kayitTutari = miktar * birimFiyat;
                    sessionTotalMilk += miktar;
                    sessionTotalAmount += kayitTutari;
                    const zamanLabel = isSabah ? 'S' : 'A';
                    historyList.innerHTML += `
                        <li class="history-item">
                            <div class="history-item-main"><span class="producer-name">${item.cariAdi}</span></div>
                            <div class="history-item-details">
                                <span>${zamanLabel}: ${miktar.toFixed(1)} Lt</span><br>
                                <strong style="color: var(--success-color);">${kayitTutari.toFixed(2)} ₺</strong>
                            </div>
                            <div class="history-item-actions">
                                <button class="btn-icon" onclick="editHistoryItem('${item.sutAlimId}', '${zaman}')" title="Düzenle">✏️</button>
                                <button class="btn-icon btn-delete" onclick="deleteHistoryItem('${item.sutAlimId}', '${zaman}')" title="Sil">🗑️</button>
                            </div>
                        </li>`;
                }
            });
            sessionSummary.innerHTML = `<strong>${zaman === 'sabah' ? 'Sabah' : 'Akşam'} Toplam Süt:</strong> ${sessionTotalMilk.toFixed(1)} Lt | <strong>Toplam Tutar:</strong> ${sessionTotalAmount.toFixed(2)} ₺`;
            if (historyList.children.length === 0) { historySection.style.display = 'none'; }
        }

        async function deleteHistoryItem(sutAlimId, zaman) {
            if (!zaman) { showToast("Silme işleminde hata: Zaman dilimi belirtilmedi.", true); return; }
            const entryToDelete = fullHistoryForDate.find(item => item.sutAlimId === sutAlimId);
            if (!entryToDelete) { showToast("Silinecek kayıt bulunamadı.", true); return; }
            if (currentUserRole !== 'admin' && getDayDifference(entryToDelete.tarih) > 2) {
                showToast("Bu kaydı silme yetkiniz yok.", true); return;
            }
            const zamanAdi = zaman === 'sabah' ? 'sabah' : 'akşam';
            const message = `'${entryToDelete.cariAdi}' için girilen ${zamanAdi} süt kaydını kalıcı olarak silmek istediğinizden emin misiniz?`;

            showCustomConfirm(message, async () => {
                saveBtn.disabled = true;
                skipBtn.disabled = true;
                try {
                    const alimTarihi = entryToDelete.tarih;
                    const sutAlimRef = db.collection('sut_alimlari').doc(sutAlimId);
                    const digerZaman = (zaman === 'sabah') ? 'aksam' : 'sabah';
                    if (entryToDelete[digerZaman] === undefined || entryToDelete[digerZaman] === null) {
                        await sutAlimRef.delete();
                        showToast("Günün tek kaydı olduğu için tümüyle silindi.");
                    } else {
                        const updatePayload = {
                            [zaman]: firebase.firestore.FieldValue.delete(),
                            toplam: entryToDelete[digerZaman] || 0,
                            toplamTutar: (entryToDelete[digerZaman] || 0) * (entryToDelete.fiyat || 0)
                        };
                        await sutAlimRef.update(updatePayload);
                        showToast(`'${entryToDelete.cariAdi}' için ${zamanAdi} kaydı silindi.`);
                    }
                    await fetchAndRenderHistory(alimTarihi);
                    await showDailyGrandTotal();
                    if (categorySelect.value) { await startRoute(); }
                } catch (error) {
                    console.error("Silme hatası:", error);
                    showToast("Hata: Kayıt silinemedi!", true);
                } finally {
                    saveBtn.disabled = false;
                    skipBtn.disabled = false;
                }
            });
        }

        function handleSave() {
            if (editingSutAlimIdInput.value) { handleUpdate(); } 
            else { handleSaveAndNext(); }
        }

        function setEditMode(entry, zamanDilimi) {
            producerPanel.style.display = 'block';
            editingEntry = entry;
            editingSutAlimIdInput.value = entry.sutAlimId;
            document.getElementById(zamanDilimi).checked = true;
            currentProducerName.textContent = `DÜZENLE: ${entry.cariAdi}`;
            quantityInput.value = (zamanDilimi === 'sabah' ? (entry.sabah || 0) : (entry.aksam || 0));
            notesInput.value = entry.not || '';
            unitPriceInput.value = (entry.fiyat || 0).toFixed(2);
            producerSelect.style.display = 'none';
            categorySelect.disabled = true;
            skipBtn.style.display = 'none';
            saveBtn.textContent = 'Güncelle';
            saveBtn.className = 'btn btn-warning';
            saveBtn.style.gridColumn = '1 / -1';
            cancelEditBtn.style.display = 'block';
            producerPanel.scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEditMode() {
            editingEntry = null;
            editingSutAlimIdInput.value = '';
            producerSelect.style.display = 'block';
            categorySelect.disabled = false;
            skipBtn.style.display = 'block';
            saveBtn.textContent = 'KAYDET';
            saveBtn.className = 'btn btn-success';
            saveBtn.style.gridColumn = '';
            cancelEditBtn.style.display = 'none';
            if(routeProducers.length > 0 && currentProducerIndex < routeProducers.length) {
                 displayCurrentProducer();
            } else {
                 producerPanel.style.display = 'none';
            }
        }

        async function handleUpdate() {
            if (!editingEntry) return;
            const yeniMiktar = parseFloat(String(quantityInput.value).replace(',', '.')) || 0;
            if (isNaN(yeniMiktar) || yeniMiktar < 0) return;
            
            checkPreviousDayDifference(() => {
                executeUpdate(yeniMiktar);
            });
        }
        
        async function executeUpdate(yeniMiktar) {
            saveBtn.disabled = true;
            const yeniBirimFiyat = parseFloat(unitPriceInput.value);
            const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
            const sutAlimId = editingSutAlimIdInput.value;
            const alimTarihi = collectionDateInput.value;
            const sutAlimRef = db.collection('sut_alimlari').doc(sutAlimId);

            try {
                const mevcutVeri = editingEntry;
                const guncelleme = {
                    fiyat: yeniBirimFiyat,
                    not: notesInput.value,
                    [zamanDilimi]: yeniMiktar
                };
                const sabahDegeri = zamanDilimi === 'sabah' ? yeniMiktar : (mevcutVeri.sabah || 0);
                const aksamDegeri = zamanDilimi === 'aksam' ? yeniMiktar : (mevcutVeri.aksam || 0);
                guncelleme.toplam = sabahDegeri + aksamDegeri;
                guncelleme.toplamTutar = guncelleme.toplam * yeniBirimFiyat;

                await sutAlimRef.update(guncelleme);
                await fetchAndRenderHistory(alimTarihi);
                await showDailyGrandTotal();
                showToast(`'${mevcutVeri.cariAdi}' kaydı güncellendi.`);
                cancelEditMode();
                if (categorySelect.value) { await startRoute(); }
            } catch (error) {
                showToast("Güncelleme sırasında bir hata oluştu: " + error.message, true);
                console.error("Update Error:", error);
            } finally {
                saveBtn.disabled = false;
            }
        }

        async function getPreviousDayQuantity(producerId, currentDateStr, timeSlot) {
            try {
                const currentDate = new Date(currentDateStr);
                currentDate.setDate(currentDate.getDate() - 1);
                const previousDateStr = currentDate.toISOString().split('T')[0];
                const query = db.collection('sut_alimlari')
                    .where('sahipId', '==', sahipId)
                    .where('cariId', '==', producerId)
                    .where('tarih', '==', previousDateStr);
                const snapshot = await query.get();
                if (snapshot.empty) return null;
                const data = snapshot.docs[0].data();
                return data[timeSlot] !== undefined ? data[timeSlot] : null;
            } catch (error) {
                console.error("Önceki gün verisi alınırken hata:", error);
                return null;
            }
        }

        async function checkPreviousDayDifference(onSuccess) {
            const currentQuantity = parseFloat(String(quantityInput.value).replace(',', '.')) || 0;
            if (currentQuantity <= 0) {
                onSuccess(); // Miktar 0 veya daha azsa kontrol etmeden devam et
                return;
            }

            const producerToCheck = editingEntry ? { id: editingEntry.cariId } : routeProducers[currentProducerIndex];
            if (!producerToCheck) { onSuccess(); return; }

            const timeSlot = document.querySelector('input[name="time"]:checked').value;
            const currentDateStr = collectionDateInput.value;
            const previousQuantity = await getPreviousDayQuantity(producerToCheck.id, currentDateStr, timeSlot);

            if (previousQuantity === null || previousQuantity <= 0) {
                onSuccess(); // Önceki gün verisi yoksa veya 0 ise kontrol etmeden devam et
                return;
            }

            const difference = Math.abs(currentQuantity - previousQuantity);
            const percentageChange = (difference / previousQuantity) * 100;

            if (percentageChange > 35) {
                const message = `DİKKAT!\n\nGirilen miktar (${currentQuantity.toFixed(1)} Lt), dünkü miktara (${previousQuantity.toFixed(1)} Lt) göre %${percentageChange.toFixed(0)} oranında farklı.\n\nYine de bu şekilde kaydetmek istiyor musunuz?`;
                showCustomConfirm(message, onSuccess); // Onaylanırsa onSuccess callback'ini çalıştır.
            } else {
                onSuccess(); // Fark %35'in altındaysa direkt devam et
            }
        }

        function advanceToNextProducer() {
            routeProducers.splice(currentProducerIndex, 1);
            populateProducerSelect();
            if (currentProducerIndex >= routeProducers.length) {
                currentProducerIndex = 0;
            }
            displayCurrentProducer();
        }

        function scrollToActivePanel() {
            setTimeout(() => {
                document.getElementById('producer-panel')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function editHistoryItem(sutAlimId, zaman) {
            const entry = fullHistoryForDate.find(item => item.sutAlimId === sutAlimId);
            if (!entry) return;
            if (editingSutAlimIdInput.value) { cancelEditMode(); }
            setEditMode(entry, zaman);
        }
</script>

<div id="custom-alert-overlay" class="custom-alert-overlay">
    <div class="custom-alert-box">
        <p id="custom-alert-message"></p>
        <div class="custom-alert-buttons">
            <button id="custom-alert-cancel" class="btn btn-secondary">İptal</button>
            <button id="custom-alert-confirm" class="btn btn-success">Tamam</button>
        </div>
    </div>
</div>
</body>
</html>