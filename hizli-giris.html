<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gelişmiş Süt Girişi</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --white-color: #fff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: var(--light-color); color: var(--dark-color); }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        header { background-color: var(--primary-color); color: var(--white-color); padding: 20px 15px; text-align: center; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.8em; }
        main { padding: 20px 0; }
        #status-panel { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 500; text-align: center; border: 1px solid; }
        #status-panel.info { background-color: #cce5ff; color: #004085; border-color: #b8daff; }
        #status-panel.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 1.1em; }
        .form-group select, .form-group input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .time-selection { display: flex; gap: 10px; }
        .time-selection input[type="radio"] { display: none; }
        .time-selection label { flex: 1; text-align: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; font-weight: 500; }
        .time-selection input[type="radio"]:checked + label { background-color: var(--primary-color); color: var(--white-color); border-color: var(--primary-color); }
        #producer-panel, #history-section { background-color: var(--white-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 25px; }
        #current-producer-name { font-size: 1.5em; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; text-align: center; }
        .action-buttons { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-top: 25px; }
        .btn { padding: 15px; font-size: 1.1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: opacity 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:active { opacity: 0.8; }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
        #session-summary { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        #session-summary p { margin: 5px 0; font-size: 1.1em; }
        #session-summary span { font-weight: 700; color: var(--primary-color); }
        #history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { background-color: var(--white-color); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .history-item-info { font-size: 1.1em; font-weight: 600; flex-grow: 1; }
        .history-item-details { text-align: right; }
        .history-item-details span { display: block; }
        .history-item-details .price { font-weight: 700; color: var(--success-color); }
        .history-item .edit-btn { background-color: var(--warning-color); color: var(--dark-color); padding: 8px 12px; font-size: 0.9em; flex-shrink: 0; border: none; border-radius: 6px; cursor: pointer;}
        .producer-list-table { width: 100%; border-collapse: collapse; }
        .producer-item { transition: opacity 0.5s ease; }
        .producer-list-table td { padding: 8px 5px; border-bottom: 1px solid #f0f2f5; vertical-align: middle; }
        .producer-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .input-cell { width: 1px; }
        .input-group { display: flex; align-items: center; }
        .input-group input { width: 70px; text-align: right; margin-right: 5px; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; }
        .input-group span { color: #606770; }
        .button-cell { width: 1px; }
        .save-btn-row { padding: 10px 15px; font-size: 0.9rem; font-weight: bold; color: white; background-color: #2ecc71; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; }
        .save-btn-row:disabled { background-color: #95a5a6; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Gelişmiş Süt Girişi</h1>
        </header>
        <main>
            <div id="status-panel">Durum kontrol ediliyor...</div>
            <div id="main-content" style="display: none;">
                 <form id="setup-form" onsubmit="return false;">
                     <div class="form-group"><label for="collection-date">Süt Alım Tarihi</label><input type="date" id="collection-date" name="collection-date"></div>
                     <div class="form-group"><label for="unit-price">Süt Birim Fiyatı (₺)</label><input type="number" id="unit-price" name="unit-price" placeholder="Örn: 15.50" step="0.01"></div>
                     <div class="form-group"><label>Zaman</label><div class="time-selection"><input type="radio" id="aksam" name="time" value="akşam" checked><label for="aksam">AKŞAM</label><input type="radio" id="sabah" name="time" value="sabah"><label for="sabah">SABAH</label></div></div>
                     <div class="form-group"><label for="tank">Tank Seçimi</label><select id="tank" name="tank"></select></div>
                     <div class="form-group"><label for="category">Kategori/Köy (Rota)</label><select id="category" name="category"></select></div>
                </form>
                <div id="producer-panel" style="display: none;">
                     <h2 id="current-producer-name">Üretici Adı</h2>
                     <div class="form-group"><label for="producer-select">Rota Dışı Seçim / Üretici Atlama</label><select id="producer-select" name="producer-select"></select></div>
                     <div class="form-group"><label for="quantity">Miktar (Litre)</label><input type="number" id="quantity" name="quantity" placeholder="Örn: 15.5" step="0.1" inputmode="decimal"></div>
                     <div class="form-group"><label for="notes">Açıklama</label><textarea id="notes" name="notes" rows="3" placeholder="Varsa notunuzu girin..."></textarea></div>
                     <div class="action-buttons"><button type="button" id="skip-btn" class="btn btn-secondary">Pas Geç</button><button type="button" id="save-btn" class="btn btn-success">Kaydet ve Sonraki</button></div>
                </div>
                <section id="history-section" style="display: none;">
                     <h2>Süt Alım Geçmişi (Bu Oturum)</h2><div id="session-summary"></div><ul id="history-list"></ul>
                </section>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
        authDomain: "sut-takip-projem.firebaseapp.com",
        projectId: "sut-takip-projem",
        storageBucket: "sut-takip-projem.appspot.com",
        messagingSenderId: "512756958486",
        appId: "1:512756958486:web:13cceb6835e2c575e9fc37"
    };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Değişkenleri global olarak tanımla
let sahipId = '';
let routeProducers = [];
let currentProducerIndex = 0;
let collectionHistory = [];
let appInitialized = false;

// DOM elementlerini global olarak tanımla
let statusPanel, mainContent, collectionDateInput, unitPriceInput, tankSelect, categorySelect, producerPanel, currentProducerName, producerSelect, quantityInput, notesInput, saveBtn, skipBtn, historySection, historyList, sessionSummary;

// updateStatus fonksiyonunu global olarak tanımla
function updateStatus(message, isError = false) {
    if (statusPanel) {
        statusPanel.textContent = message;
        statusPanel.className = isError ? 'error' : 'info';
        statusPanel.style.display = 'block';
    }
}

// Sayfa tamamen yüklendiğinde tüm işlemleri başlat
document.addEventListener('DOMContentLoaded', () => {
    statusPanel = document.getElementById('status-panel');
    mainContent = document.getElementById('main-content');

    auth.onAuthStateChanged(user => {
        if (user) {
            updateStatus('Oturum doğrulandı. Kullanıcı profili aranıyor...');
            db.collection('kullanicilar').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists && doc.data().sahipId) {
                        sahipId = doc.data().sahipId;
                        if (!appInitialized) {
                            mainContent.style.display = 'block';
                            initializeApp();
                            appInitialized = true;
                        }
                    } else {
                        updateStatus('HATA: Kullanıcı profilinizde, hangi ana hesaba bağlı olduğunuzu gösteren "sahipId" alanı bulunamadı. Lütfen yöneticinizle iletişime geçerek çalışan hesabınıza "sahipId" alanı eklemesini isteyin.', true);
                    }
                })
                .catch(err => {
                    console.error("Kullanıcı verisi alınırken hata:", err);
                    updateStatus('HATA: Kullanıcı profilinize erişilemedi. Güvenlik kurallarınızı veya internet bağlantınızı kontrol edin.', true);
                });
        } else {
            window.location.href = 'login.html';
        }
    });
});

async function initializeApp() {
    // Template yüklendikten sonra elementleri ata
    collectionDateInput = document.getElementById('collection-date');
    unitPriceInput = document.getElementById('unit-price');
    tankSelect = document.getElementById('tank');
    categorySelect = document.getElementById('category');
    producerPanel = document.getElementById('producer-panel');
    currentProducerName = document.getElementById('current-producer-name');
    producerSelect = document.getElementById('producer-select');
    quantityInput = document.getElementById('quantity');
    notesInput = document.getElementById('notes');
    saveBtn = document.getElementById('save-btn');
    skipBtn = document.getElementById('skip-btn');
    historySection = document.getElementById('history-section');
    historyList = document.getElementById('history-list');
    sessionSummary = document.getElementById('session-summary');

    // Tarihi bugüne ayarla
    collectionDateInput.value = new Date().toISOString().split('T')[0];

    updateStatus('Ayarlar ve başlangıç verileri yükleniyor...');
    const settings = await getSettings();
    unitPriceInput.value = settings.defaultMilkPrice ? settings.defaultMilkPrice.toFixed(2) : "15.50";

    await Promise.all([populateTanks(), populateCategories()]);
    updateStatus('Uygulama hazır.');
    setTimeout(() => { if (statusPanel) statusPanel.style.display = 'none'; }, 2000);

    categorySelect.addEventListener('change', startRoute);
    producerSelect.addEventListener('change', jumpToProducer);
    saveBtn.addEventListener('click', handleSaveAndNext);
    skipBtn.addEventListener('click', handleSkip);

    [collectionDateInput, ...document.querySelectorAll('input[name="time"]')].forEach(el => {
        el.addEventListener('change', () => {
            if (categorySelect.value) {
                startRoute();
            }
        });
    });
}


    async function getSettings() {
        if (!sahipId) return {};
        try {
            const doc = await db.collection('ayarlar').doc(sahipId).get();
            return doc.exists ? doc.data() : {};
        } catch (e) { console.error("Ayarlar alınamadı:", e); return {}; }
    }

    function getSessionKey(category) {
        const date = collectionDateInput.value;
        const time = document.querySelector('input[name="time"]:checked').value;
        return `session_${sahipId}_${date}_${time}_${category || 'none'}`;
    }
    
    async function startRoute() {
        const category = categorySelect.value;
        producerPanel.style.display = 'none';
        historySection.style.display = 'none';
        collectionHistory = [];
        renderHistory();

        if (!category) { return; }

        updateStatus('Rota verileri yükleniyor...', false);
        const sessionKey = getSessionKey(category);
        
        const alimTarihi = collectionDateInput.value;
        const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
        
        const existingEntriesSnapshot = await db.collection('tank_hareketleri').where('sahipId', '==', sahipId).where('alim_tarihi', '==', alimTarihi).where('zaman_dilimi', '==', zamanDilimi).get();
        collectionHistory = existingEntriesSnapshot.docs.map(doc => doc.data());
        renderHistory();

        const savedProducerIds = new Set(collectionHistory.map(entry => entry.ureticiId));

        const snapshot = await db.collection('cariler').where('sahipId', '==', sahipId).where('kategori', '==', category).where('durum', '==', 'aktif').where('cariGrup', '==', 'üretici').orderBy('rotaSirasi').get();
        
        const savedRouteOrder = JSON.parse(sessionStorage.getItem(sessionKey));
        let producersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        routeProducers = producersData.filter(producer => !savedProducerIds.has(producer.id));
        
        if (savedRouteOrder) {
            routeProducers.sort((a, b) => {
                const indexA = savedRouteOrder.findIndex(p => p.id === a.id);
                const indexB = savedRouteOrder.findIndex(p => p.id === b.id);
                if (indexA === -1 && indexB === -1) return 0;
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        }
        
        if (routeProducers.length === 0) {
            updateStatus("Bu rota için tüm girişler tamamlanmış veya işlenecek üretici yok.", false);
            setTimeout(() => { if (statusPanel.textContent === "Bu rota için tüm girişler tamamlanmış veya işlenecek üretici yok.") statusPanel.style.display = 'none'; }, 2000);
            return;
        }
        
        sessionStorage.setItem(sessionKey, JSON.stringify(routeProducers.map(p => ({id: p.id}))));
        currentProducerIndex = 0;
        populateProducerSelect();
        displayCurrentProducer();
        producerPanel.style.display = 'block';
        statusPanel.style.display = 'none';
    }
    
    function displayCurrentProducer() {
        if (currentProducerIndex >= routeProducers.length) {
            alert(`${categorySelect.options[categorySelect.selectedIndex].text} rotası tamamlandı!`);
            producerPanel.style.display = 'none';
            return;
        }
        const producer = routeProducers[currentProducerIndex];
        currentProducerName.textContent = producer.adiSoyadi;
        producerSelect.value = currentProducerIndex;
        quantityInput.value = '';
        notesInput.value = '';
        quantityInput.focus();
    }

    function populateProducerSelect() {
        producerSelect.innerHTML = '';
        routeProducers.forEach((producer, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${producer.rotaSirasi || ''}. ${producer.adiSoyadi}`;
            producerSelect.appendChild(option);
        });
    }

    function jumpToProducer() {
        const selectedIndex = parseInt(this.value);
        if (!isNaN(selectedIndex) && selectedIndex < routeProducers.length) {
            currentProducerIndex = selectedIndex;
            displayCurrentProducer();
        }
    }
    
    function goToNextProducer(isSave = false) {
        const sessionKey = getSessionKey(categorySelect.value);
        if (isSave) {
            routeProducers.splice(currentProducerIndex, 1);
        } else {
            const producerToMove = routeProducers.splice(currentProducerIndex, 1)[0];
            routeProducers.push(producerToMove);
        }
        
        if (currentProducerIndex >= routeProducers.length && routeProducers.length > 0) {
            currentProducerIndex = 0;
        }
        
        sessionStorage.setItem(sessionKey, JSON.stringify(routeProducers.map(p => ({id: p.id}))));
        populateProducerSelect();
        displayCurrentProducer();
    }

    async function handleSaveAndNext() {
        if (currentProducerIndex >= routeProducers.length) return;
        
        const unitPrice = parseFloat(unitPriceInput.value);
        const quantity = parseFloat(quantityInput.value);
        const tankId = tankSelect.value;
        const alimTarihi = collectionDateInput.value;
        const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
        const currentProducer = routeProducers[currentProducerIndex];

        if (!unitPrice || !quantity || !tankId || quantity <= 0 || !alimTarihi) {
            alert('Lütfen Fiyat, Miktar, Tarih ve Tank seçimlerini doğru yapın.'); return;
        }
        
        saveBtn.disabled = true;
        skipBtn.disabled = true;
        
        const totalPrice = (quantity * unitPrice);
        const movementRef = db.collection('tank_hareketleri').doc();
        const sutAlimRef = db.collection('sut_alimlari').doc();
        const tankRef = db.collection('tanklar').doc(tankId);
        
        const entryData = {
            movementId: movementRef.id, ureticiId: currentProducer.id, ureticiAdi: currentProducer.adiSoyadi,
            sahipId: sahipId, calisanId: auth.currentUser.uid, tankId: tankId, alim_tarihi: alimTarihi,
            zaman_dilimi: zamanDilimi, miktar: quantity, birim_fiyat: unitPrice,
            toplam_tutar: totalPrice, not: notesInput.value, kayitZamani: new Date()
        };

        const batch = db.batch();
        batch.set(movementRef, entryData);
        batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(quantity) });
        batch.set(sutAlimRef, {
            tarih: alimTarihi, cariId: currentProducer.id, cariAdi: currentProducer.adiSoyadi,
            sabah: zamanDilimi === 'sabah' ? quantity : 0, aksam: zamanDilimi === 'akşam' ? quantity : 0,
            toplam: quantity, fiyat: unitPrice, toplamTutar: totalPrice,
            aciklama: `Hızlı giriş ile eklendi. Not: ${notesInput.value}`, sahipId: sahipId
        });

        try {
            await batch.commit();
            collectionHistory.push(entryData);
            renderHistory();
            goToNextProducer(true);
        } catch (error) {
            console.error("Kayıt hatası:", error);
            alert("Veri kaydedilirken bir hata oluştu: " + error.message);
        } finally {
            saveBtn.disabled = false;
            skipBtn.disabled = false;
        }
    }

    function handleSkip() {
        goToNextProducer(false);
    }

    function renderHistory() {
        if (!historySection || !historyList || !sessionSummary) return;
        if (collectionHistory.length === 0) { historySection.style.display = 'none'; return; }
        historySection.style.display = 'block';
        historyList.innerHTML = '';
        let totalMilk = 0;
        let totalValue = 0;

        collectionHistory.sort((a,b) => b.kayitZamani.seconds - a.kayitZamani.seconds).forEach(item => {
            const listItem = document.createElement('li');
            listItem.className = 'history-item';
            listItem.innerHTML = `
                <div class="history-item-info">${item.ureticiAdi}</div>
                <div class="history-item-details">
                    <span>${item.miktar.toFixed(1)} Litre</span>
                    <span class="price">${item.toplam_tutar.toFixed(2)} ₺</span>
                </div>
                <button class="btn edit-btn" onclick="editHistoryItem('${item.movementId}')">Düzenle</button>
            `;
            historyList.appendChild(listItem);
            totalMilk += item.miktar;
            totalValue += item.toplam_tutar;
        });

        sessionSummary.innerHTML = `<p>Toplam Süt (Bu Oturum): <span>${totalMilk.toFixed(1)} Litre</span></p><p>Toplam Tutar (Bu Oturum): <span>${totalValue.toFixed(2)} ₺</span></p>`;
    }
    
    async function editHistoryItem(movementId) {
        const entryToEdit = collectionHistory.find(item => item.movementId === movementId);
        if (!entryToEdit) { alert("Düzenlenecek kayıt oturum geçmişinde bulunamadı."); return; }
        if (!confirm(`'${entryToEdit.ureticiAdi}' için girilen ${entryToEdit.miktar} Lt süt kaydını düzenlemek üzeresiniz. Bu işlem orijinal kaydı silecek ve tanktan/cari hesaptan düşecektir. Onaylıyor musunuz?`)) return;
        
        saveBtn.disabled = true;
        skipBtn.disabled = true;

        const tankRef = db.collection('tanklar').doc(entryToEdit.tankId);
        const movementRef = db.collection('tank_hareketleri').doc(entryToEdit.movementId);
        
        const sutAlimSnapshot = await db.collection('sut_alimlari').where('sahipId', '==', sahipId).where('cariId', '==', entryToEdit.ureticiId).where('tarih', '==', entryToEdit.alim_tarihi).where('toplam', '==', entryToEdit.miktar).limit(1).get();
        
        const batch = db.batch();
        batch.update(tankRef, { mevcutLitre: firebase.firestore.FieldValue.increment(-entryToEdit.miktar) });
        batch.delete(movementRef);
        if (!sutAlimSnapshot.empty) {
            batch.delete(sutAlimSnapshot.docs[0].ref);
        }

        try {
            await batch.commit();
            alert("Kayıt silindi. Liste güncelleniyor...");
            startRoute();
        } catch(error) {
            console.error("Düzenleme hatası (geri alma):", error);
            alert("Kayıt geri alınırken bir hata oluştu: " + error.message);
        } finally {
            saveBtn.disabled = false;
            skipBtn.disabled = false;
        }
    }

    async function populateTanks() {
        const tankSelect = document.getElementById('tank');
        updateStatus("Tanklar yükleniyor...", false);
        if (!sahipId) { return; }
        try {
            const snapshot = await db.collection('tanklar').where('sahipId', '==', sahipId).orderBy('ad').get();
            if (snapshot.empty) {
                tankSelect.innerHTML = '<option value="" disabled selected>Tanımlı tank bulunamadı!</option>';
                return;
            }
            tankSelect.innerHTML = '';
            snapshot.forEach(doc => {
                const tank = doc.data();
                tankSelect.innerHTML += `<option value="${doc.id}">${tank.ad} (${tank.kapasite} Lt)</option>`;
            });
        } catch (e) {
            updateStatus("Tanklar yüklenirken bir hata oluştu. Güvenlik kurallarınızı kontrol edin.", true);
            console.error("Tank populate error:", e);
        }
    }
    async function populateCategories() {
        const categorySelect = document.getElementById('category');
        updateStatus("Kategoriler yükleniyor...", false);
        if (!sahipId) { return; }
        try {
            const snapshot = await db.collection('cari_kategorileri').where('sahipId', '==', sahipId).orderBy('ad').get();
            categorySelect.innerHTML = '<option value="">Rota Seçiniz...</option>';
            snapshot.forEach(doc => {
                categorySelect.innerHTML += `<option value="${doc.data().ad}">${doc.data().ad}</option>`;
            });
        } catch (e) {
            updateStatus("Kategoriler yüklenirken bir hata oluştu. Güvenlik kurallarınızı kontrol edin.", true);
            console.error("Category populate error:", e);
        }
    }

</script>
</body>
</html>
