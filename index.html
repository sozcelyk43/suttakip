<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Süt Takip Programı - Tam Sürüm</title>
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
</head>
<body>
    <div class="sidebar">
        <img src="logo.png" alt="Uygulama Logosu" class="sidebar-logo">
        <nav id="sidebarNav">
            <ul>
                <li><a href="#dashboard" class="nav-link active">📝 Kontrol Paneli</a></li>
                <li><a href="#cari-yonetimi" class="nav-link">👥 Cari Yönetimi</a></li>
                <li><a href="#sut-alimi" class="nav-link">🥛 Günlük Süt Alımı</a></li>
                <li><a href="#yem-stok-yonetimi" class="nav-link">📦 Yem Stok Yönetimi</a></li>
                <li><a href="#yem-satisi" class="nav-link">🌾 Yem Satışı</a></li>
                <li><a href="#tahsilat-ve-odemeler" class="nav-link">💳 Tahsilat ve Ödemeler</a></li>
                <li><a href="#hesap-ozeti" class="nav-link">📊 Cari Hesap Özeti</a></li>
                <li><a href="#sut-alim-raporu" class="nav-link">🗓️ Aylık Süt Raporu</a></li>
                <li><a href="#aylik-yem-raporu" class="nav-link">📈 Aylık Yem Raporu</a></li>
                <li><a href="#hareket-dokumu" class="nav-link">📋 Hareket Dökümü</a></li>

                <li><a href="#ayarlar" class="nav-link">⚙️ Ayarlar</a></li>
                <li class="logout-link">
                    <a href="#" id="logoutButton">🚪 Çıkış Yap</a>
                </li>
            </ul>
        </nav>
    </div>

    <div class="main-content">
        <section id="dashboard" class="module-section">
            <div class="module-header"><h2>📝 Kontrol Paneli</h2></div>
            <div class="container">
               <h3>Genel Durum</h3>
<div class="dashboard-grid">
    <div class="stat-card"><h4>Bugünkü Sabah Sütü</h4><p><span id="dashSabahSut">0.00</span> Lt</p></div>
    <div class="stat-card"><h4>Bugünkü Akşam Sütü</h4><p><span id="dashAksamSut">0.00</span> Lt</p></div>
    <div class="stat-card">
    <h4>Bugünkü Toplam Süt</h4>
    <p><span id="dashToplamSut">0.00</span> Lt</p>
</div>
    <div class="charts-container" style="margin-top: 30px;">
    <div class="chart-card">
        <h3>Son 7 Günlük Süt Alımı (Litre)</h3>
        <canvas id="gunlukSutChart"></canvas>
    </div>
    <div class="chart-card">
        <h3>Bu Ayın Günlere Göre Süt Alımı (Litre)</h3>
        <canvas id="aylikSutChart"></canvas>
    </div>
</div>
    <div class="stat-card"><h4>Aktif Müşteri Sayısı</h4><p><span id="dashAktifMusteri">0</span></p></div>
    <div class="stat-card alacak"><h4>Toplam Alacak</h4><p><span id="dashToplamAlacak">0,00 ₺</span></p></div>
    <div class="stat-card borc"><h4>Toplam Borç</h4><p><span id="dashToplamBorc">0,00 ₺</span></p></div>
    <div class="stat-card">
    <h4>Toplam Bakiye</h4>
    <p><span id="dashToplamBakiye">0,00 ₺</span></p>
</div>
</div>
                 
            </div>
        </section>
        
        <section id="cari-yonetimi" class="module-section">
            <div class="module-header">
                <h2>👥 Cari Yönetimi</h2>
                
            </div>
            <div class="container">
                <div class="form-section"><h3><span id="cariFormBaslik">Yeni Cari Kart</span></h3><form id="cariForm" action="#"><input type="hidden" id="cariEditId"><div class="form-grid">
                    <div class="form-group"><label for="cariKodu">Cari Kodu:</label><input type="text" id="cariKodu" placeholder="Örn: C001"></div>
                    <div class="form-group"><label for="cariAdiSoyadi">Adı Soyadı / Firma Adı:</label><input type="text" id="cariAdiSoyadi" required></div>
                    <div class="form-group"><label for="cariKategori">Kategori/Köy:</label><select id="cariKategori" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group">
    <label for="cariAcilisBakiye">Açılış Bakiyesi:</label>
    <input type="number" id="cariAcilisBakiye" placeholder="Örn: 500" step="0.01">
</div>
<div class="form-group">
    <label for="cariAcilisBakiyeTuru">Bakiye Türü:</label>
    <select id="cariAcilisBakiyeTuru">
        <option value="yok">Yok</option>
        <option value="borc">Cari Borçlu</option>
        <option value="alacak">Cari Alacaklı</option>
    </select>
</div>
                    <div class="form-group"><label for="cariDurum">Durum:</label><select id="cariDurum"><option value="aktif">Aktif</option><option value="pasif">Pasif</option></select></div>
                   <div class="form-group">
    <label for="cariTipi">Cari Tipi:</label>
    <select id="cariTipi">
        <option value="sut_ve_yem">Süt ve Yem</option>
        <option value="sadece_sut">Sadece Süt</option>
        <option value="sadece_yem">Sadece Yem</option>
    </select>
</div>
                    <div class="form-group"><label for="cariTelefon">Telefon:</label><input type="tel" id="cariTelefon"></div>
                    <div class="form-group"><label for="cariEposta">E-posta:</label><input type="email" id="cariEposta"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="cariAdres">Adres:</label><textarea id="cariAdres"></textarea></div>
                    <div class="form-group"><label for="cariBankaAdi">Banka Adı:</label><input type="text" id="cariBankaAdi"></div>
                    <div class="form-group"><label for="cariIban">IBAN:</label><input type="text" id="cariIban"></div>
                    <div class="form-group"><label for="cariVergiDairesi">Vergi Dairesi:</label><input type="text" id="cariVergiDairesi"></div>
                    <div class="form-group"><label for="cariVergiNo">Vergi No / T.C.:</label><input type="text" id="cariVergiNo"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="cariNotlar">Özel Notlar:</label><textarea id="cariNotlar"></textarea></div>
                </div><button type="submit" class="btn btn-primary" id="cariKaydetBtn">Kaydet</button><button type="button" class="btn dont-calisan" id="cariFormTemizleBtn" style="display:none;">Yeni Kayıt</button></form></div>
                
                <div id="cari-list-printable-area" class="dont-calisan">
                    <h3 class="print-only print-title" id="cariListeRaporBaslik">Cari Listesi Raporu</h3>
                    <div class="list-section">
                        <div class="list-header-with-filter">
                            <h3>Cari Listesi</h3>
        <div class="search-container dont-calisan"> <input type="text" id="cariSearchInput" placeholder="Cari Ara..." aria-label="Cari Arama Kutusu"> </div>
                            
                            <select id="cariKategoriFiltre">
                                <option value="">Tüm Kategoriler</option>
                            </select>
                        </div>
                        <table>
<thead>
    <tr>
        <th>Kod</th>
        <th>Ad/Firma</th>
        <th>Kategori</th>
        <th>Durum</th>
        <th>Telefon</th>
        <th>Borç</th>
        <th>Alınan</th>
        <th>Bakiye</th>
        <th class="dont-print">İşlemler</th>
    </tr>
</thead>                 <tbody id="cariListesiBody"></tbody>
                            <tfoot id="cariListesiFooter"></tfoot>
                        </table>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary dont-print dont-calisan" id="cariListesiYazdirBtn" style="margin-top: 20px;">Listeyi Yazdır</button>
            </div>
        </section>

        <section id="sut-alimi" class="module-section hidden-section">
            <div class="module-header"><h2>🥛 Günlük Süt Alımı</h2></div>
            <div class="container">
                <div class="form-section">
                    <h3>Giriş Filtreleri</h3>
                    <div class="form-grid" id="sutGirisFiltreler" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group"><label for="topluGirisTarih">Giriş Tarihi:</label><input type="date" id="topluGirisTarih" required></div>
                        <div class="form-group"><label for="topluGirisKategori">Kategori/Köy Seçin:</label><select id="topluGirisKategori" required><option value="">Tüm Kategoriler</option></select></div>
                    </div>
                </div>
                <div class="list-section">
                    <h3>Günlük Süt Girişi</h3>
                    <div id="topluSutGirisTablosuAlani"></div>
                    <p id="topluGirisTedarikciYokMesaji" style="text-align:center; display:none;">Bu kategoride süt girişi beklenen aktif cari bulunmuyor.</p>
                </div>
                <hr style="margin: 40px 0;">
                <div class="list-section">
                    <div id="sutDuzenleFormAlani" style="display:none; margin-bottom: 20px;">
    <h4>Süt Alımını Düzenle</h4>
    <form id="sutDuzenleForm" class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto auto;">
        <input type="hidden" id="sutDuzenleId">
        <div class="form-group">
            <label>Sabah (Lt)</label>
            <input type="number" id="sutDuzenleSabah" class="sut-input" step="0.1" min="0">
        </div>
        <div class="form-group">
            <label>Akşam (Lt)</label>
            <input type="number" id="sutDuzenleAksam" class="sut-input" step="0.1" min="0">
        </div>
        <div class="form-group">
            <label>Fiyat</label>
            <input type="number" id="sutDuzenleFiyat" class="sut-input" step="0.01" min="0">
        </div>
        <button type="submit" class="btn btn-primary" style="height: 45px; align-self: end;">Güncelle</button>
        <button type="button" class="btn" style="height: 45px; align-self: end;" onclick="closeSutDuzenleForm()">İptal</button>
    </form>
</div>
                    <h3>Süt Alım Geçmişi (Seçili Tarih: <span id="gecmisTarihSpan"></span>)</h3>
                    <table>
                        <thead id="sutAlimGecmisiHeader"></thead>
                        <tbody id="sutAlimGecmisiBody"></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section id="yem-stok-yonetimi" class="module-section hidden-section">
             <div class="module-header"><h2>📦 Yem Stok Yönetimi</h2></div>
             <div class="container">
                <div class="form-section"><h3><span id="yemTanimFormBaslik">Yeni Yem Tanımla</span></h3><form id="yemTanimForm" action="#"><input type="hidden" id="yemTanimEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemKodu">Kod:</label><input type="text" id="yemKodu" required></div>
                    <div class="form-group"><label for="yemAdi">Ad:</label><input type="text" id="yemAdi" required></div>
                    <div class="form-group"><label for="yemKategorisi">Kategori:</label><select id="yemKategorisi"><option value="buyukbas">Büyükbaş</option><option value="kucukbas">Küçükbaş</option></select></div>
                    <div class="form-group"><label for="yemBirimi">Birim:</label><input type="text" id="yemBirimi" value="Çuval"></div>
                    <div class="form-group"><label for="yemAlisFiyati">Alış Fiyatı:</label><input type="number" id="yemAlisFiyati" step="0.01"></div>
                    <div class="form-group"><label for="yemSatisFiyati">Satış Fiyatı:</label><input type="number" id="yemSatisFiyati" step="0.01"></div>
                </div><button type="submit" class="btn btn-primary" id="yemTanimKaydetBtn">Kaydet</button><button type="button" class="btn" id="yemTanimFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Tanımlı Yemler & Stok</h3><table><thead><tr><th>Kod</th><th>Ad</th><th>Kategori</th><th>Birim</th><th>Alış F.</th><th>Satış F.</th><th>Stok</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="yemStokListesiBody"></tbody></table></div>
                <hr>
                <div class="form-section"><h3><span id="yemAlisFormBaslik">Yeni Yem Alışı</span></h3><form id="yemAlisForm" action="#"><input type="hidden" id="yemAlisEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemAlisTarih">Tarih:</label><input type="date" id="yemAlisTarih" required></div>
                    <div class="form-group"><label for="yemSecimiAlis">Yem:</label><select id="yemSecimiAlis" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemAlisMiktar">Miktar:</label><input type="number" id="yemAlisMiktar" step="1" required></div>
                    <div class="form-group"><label for="yemAlisTedarikci">Cari:</label><select id="yemAlisTedarikci"><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemAlisBirimFiyati">Alış Fiyatı:</label><input type="number" id="yemAlisBirimFiyati" step="0.01" required></div>
                    <div class="form-group"><label for="yemAlisToplamTutar">Toplam Tutar:</label><input type="text" id="yemAlisToplamTutar" readonly></div>
                </div><button type="submit" class="btn btn-primary" id="yemAlisKaydetBtn">Alışı Kaydet</button><button type="button" class="btn" id="yemAlisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Yem Alış Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Yem</th><th>Miktar</th><th>Cari</th><th>Alış F.</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="yemAlisHareketListesiBody"></tbody></table></div>
             </div>
        </section>
        <section id="yem-satisi" class="module-section hidden-section">
             <div class="module-header"><h2>🌾 Yem Satışı</h2></div>
             <div class="container">
                <div class="form-section"><h3><span id="yemSatisFormBaslik">Yeni Yem Satışı</span></h3><form id="yemSatisForm" action="#"><input type="hidden" id="yemSatisEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemSatisTarih">Tarih:</label><input type="date" id="yemSatisTarih" required></div>
                    <div class="form-group"><label for="yemAlanTedarikci">Alan Cari:</label><select id="yemAlanTedarikci" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemSecimiSatis">Yem:</label><select id="yemSecimiSatis" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="yemSatisMiktar">Miktar:</label><input type="number" id="yemSatisMiktar" step="1" required></div>
                    <div class="form-group"><label for="yemSatisBirimFiyati">Satış Fiyatı:</label><input type="number" id="yemSatisBirimFiyati" step="0.01" required></div>
                    <div class="form-group"><label for="yemSatisToplamTutar">Toplam Tutar:</label><input type="text" id="yemSatisToplamTutar" readonly></div>
                </div><button type="submit" class="btn btn-primary" id="yemSatisKaydetBtn">Satışı Kaydet</button><button type="button" class="btn" id="yemSatisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Yem Satış Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Alan Cari</th><th>Yem</th><th>Miktar</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="yemSatisListesiBody"></tbody></table></div>
             </div>
        </section>
        <section id="tahsilat-ve-odemeler" class="module-section hidden-section">
            <div class="module-header"><h2>💳 Tahsilat ve Ödemeler</h2></div>
            <div class="container">
                 <div class="form-section"><h3><span id="odemeFormBaslik">Yeni Hareket Girişi</span></h3><form id="odemeForm" action="#"><input type="hidden" id="odemeEditId"><div class="form-grid">
                    <div class="form-group"><label for="islemTuru">İşlem Türü:</label><select id="islemTuru" required><option value="odeme">Ödeme</option><option value="tahsilat">Tahsilat</option></select></div>
                    <div class="form-group"><label for="odemeTarih">Tarih:</label><input type="date" id="odemeTarih" required></div>
                    <div class="form-group"><label for="odemeYapilanTedarikci">Cari:</label><select id="odemeYapilanTedarikci" required><option value="">Seçiniz...</option></select></div>
                    <div class="form-group"><label for="odemeTutari">Tutar (TL):</label><input type="number" id="odemeTutari" step="0.01" required></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="odemeAciklama">Açıklama:</label><textarea id="odemeAciklama" rows="2"></textarea></div>
                 </div><button type="submit" class="btn btn-primary" id="odemeKaydetBtn">Kaydet</button><button type="button" class="btn" id="odemeFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                 <div class="list-section"><h3>İşlem Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Cari</th><th>İşlem Türü</th><th>Tutar</th><th>Açıklama</th><th class="dont-print">İşlemler</th></tr></thead><tbody id="odemeListesiBody"></tbody></table></div>
            </div>
        </section>
        <section id="hesap-ozeti" class="module-section">
            <div class="module-header dont-print"><h2>📊 Cari Hesap Özeti</h2></div>
            <div class="container">
                <div class="report-section">
                    <h3 class="dont-print">Cari Hesap Özeti</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: 1fr 1fr auto; align-items: end;">
                        <div class="form-group"><label for="raporCariSecimi">Cari Seçin:</label><select id="raporCariSecimi"><option value="">Seçiniz...</option></select></div>
                        <div class="form-group"><label for="raporTarihAraligi">Ay:</label><input type="month" id="raporTarihAraligi"></div>
                        <button type="button" class="btn btn-primary" id="raporOlusturBtn" style="height:45px;">Rapor Oluştur</button>
                    </div> <hr class="dont-print">
                    <div id="report-content-to-print" class="printable-content format-a5">
                        <h1 class="print-only print-title">Süt Takip Programı - Cari Hesap Özeti</h1>
                        <h4 id="raporBaslik" style="text-align:center;">Lütfen Rapor Kriterlerini Seçin</h4>
                        <div id="raporDetayAlani"></div>
                    </div>
                    <button type="button" class="btn btn-secondary dont-print" id="raporYazdirBtn" style="margin-top:20px;">Özeti Yazdır</button>
                </div>
            </div>
        </section>
        <section id="sut-alim-raporu" class="module-section">
             <div class="module-header dont-print"><h2>🗓️ Aylık Süt Raporu</h2></div>
            <div class="container">
                 <div class="report-section">
                    <h3>Detaylı Süt Alım Raporu</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: repeat(4, 1fr); align-items: end; gap: 10px;">
                        <div class="form-group"><label for="sutRaporuTedarikciSecimi">Cari Seçin:</label><select id="sutRaporuTedarikciSecimi"><option value="">Seçiniz...</option></select></div>
                        <div class="form-group"><label for="sutRaporuAySecimi">Ay:</label><input type="month" id="sutRaporuAySecimi"></div>
                        <div class="form-group"><label for="sutRaporuKategoriSecimi">Kategori:</label><select id="sutRaporuKategoriSecimi"><option value="">Tümü</option></select></div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-primary" id="sutRaporuOlusturBtn" style="height:45px; flex-grow: 1;">Göster</button>
                            <button type="button" class="btn btn-info" id="sutRaporuKategoriGosterBtn" style="height:45px; flex-grow: 1;">Kategori</button>
                            <button type="button" class="btn btn-info" id="sutRaporuTumunuGosterBtn" style="height:45px; flex-grow: 1;">Toplu</button>
                        </div>
                    </div> <hr class="dont-print">
                    <div id="sutAlimRaporAlani" class="printable-content format-a5">
                        <h1 class="print-only print-title">Süt Takip Programı - Aylık Süt Alım Detay Raporu</h1>
                        <h4 id="sutRaporuBaslik" style="text-align:center;">Lütfen Rapor Kriterlerini Seçin</h4>
                        <div id="sutRaporuDetayAlani"></div>
                    </div>
                    <button type="button" class="btn btn-secondary dont-print" id="sutRaporuYazdirBtn" style="margin-top:20px;">Raporu Yazdır</button>
                 </div>
            </div>
        </section>
        <section id="aylik-yem-raporu" class="module-section">
             <div class="module-header"><h2>📈 Aylık Yem Raporu</h2></div>
             <div class="container">
                 <div class="report-section">
                    <h3>Aylık Yem Satış Kârlılık Raporu</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: 1fr auto; align-items: end;">
                        <div class="form-group">
                            <label for="yemRaporuAySecimi">Ay Seçin:</label>
                            <input type="month" id="yemRaporuAySecimi">
                        </div>
                        <button type="button" class="btn btn-primary" id="yemRaporuOlusturBtn" style="height:45px;">Raporu Göster</button>
                    </div>
                    <hr class="dont-print">
                    <div id="yemRaporuAlani" class="printable-content format-a4">
                    </div>
                    <button type="button" class="btn btn-secondary dont-print" id="yemRaporuYazdirBtn" style="margin-top:20px;">Raporu Yazdır</button>
                 </div>
             </div>
        </section>
        <section id="ayarlar" class="module-section hidden-section">
             <div class="module-header"><h2>⚙️ Ayarlar</h2></div>
             <div class="container">
                <div class="ayarlar-ust-bolum">
                    <div class="settings-section">
                        <h3>Genel Ayarlar</h3>
                        <form id="ayarlarForm">
                            <div class="form-group">
                                <label for="varsayilanSutFiyati">Varsayılan Süt Fiyatı (TL/Lt):</label>
                                <input type="number" id="varsayilanSutFiyati" step="0.01">
                            </div>
                            <button type="submit" class="btn btn-primary">Kaydet</button>
                        </form>
                    </div>
                    <div class="settings-section">
                        <h3>Şifre Değiştir</h3>
                        <form id="sifreDegistirForm">
                            <div class="form-group"><label for="eskiSifre">Eski Şifre:</label><input type="password" id="eskiSifre" required></div>
                            <div class="form-group"><label for="yeniSifre">Yeni Şifre:</label><input type="password" id="yeniSifre" required></div>
                            <div class="form-group"><label for="yeniSifreTekrar">Yeni Şifre (Tekrar):</label><input type="password" id="yeniSifreTekrar" required></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Güncelle</button>
                        </form>
                    </div>
                </div>
                <hr>
                <div class="settings-section">
                    <h3>Cari Kategori/Köy Tanımları</h3>
                    <form id="cariKategoriForm" action="#">
                        <div class="form-grid" style="grid-template-columns: 1fr auto; align-items:end;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="yeniCariKategoriAdi">Yeni Ad:</label>
                                <input type="text" id="yeniCariKategoriAdi" required>
                            </div>
                            <button type="submit" class="btn" style="height:45px;">Ekle</button>
                        </div>
                    </form>
                    <div class="list-section" style="margin-top:20px;">
                        <h4>Tanımlı Kategoriler/Köyler</h4>
                        <ul id="cariKategoriListesiUl"></ul>
                    </div>
                </div>
                <hr class="dont-calisan">
                <div class="settings-section dont-calisan">
                    <h3>Kullanıcı Yönetimi</h3>
                    <form id="kullaniciForm">
                        <input type="hidden" id="kullaniciEditId">
                        <div class="form-grid">
                            <div class="form-group"><label for="kullaniciAdi">Kullanıcı E-posta:</label><input type="email" id="kullaniciAdi" required></div>
                            <div class="form-group"><label for="kullaniciSifre">Şifre:</label><input type="password" id="kullaniciSifre" required></div>
                        </div>
                        <button type="submit" class="btn" id="kullaniciKaydetBtn">Çalışan Ekle</button>
                    </form>
                    <div class="list-section">
                        <h4>Kullanıcı Listesi</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Kullanıcı Adı</th>
                                    <th>Rol</th>
                                    <th class="dont-print">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="kullaniciListesiBody"></tbody>
                        </table>
                    </div>
                </div>
             </div>
        </section>

        <section id="hareket-dokumu" class="module-section hidden-section">
            <div class="module-header"><h2>📋 Hareket Dökümü</h2></div>
            <div class="container">
                <div class="list-section">
                    <h3>Tüm İşlem Geçmişi (En Yeni Üstte)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Cari Adı</th>
                                <th>İşlem Türü</th>
                                <th>Açıklama</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="hareketDokumuBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
    </div> 
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
// --- START: TAM VE DÜZELTİLMİŞ JAVASCRIPT KODU ---

const firebaseConfig = {
    apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
    authDomain: "sut-takip-projem.firebaseapp.com",
    projectId: "sut-takip-projem",
    storageBucket: "sut-takip-projem.appspot.com", // Düzeltildi
    messagingSenderId: "512756958486",
    appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
    measurementId: "G-LYLT9WFVNK"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- Global Değişkenler ---
let currentUserRole = '';
let currentUserId = '';
let globalSettings = { defaultMilkPrice: 15.00 };
let editingCariId = null, editingYemTanimId = null, editingYemAlisId = null, editingYemSatisId = null, editingOdemeId = null;

// --- Service Worker ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('Service Worker registered.'))
            .catch(err => console.error('Service Worker registration failed: ', err));
    });
}

// --- OTURUM YÖNETİMİ ---
auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUserId = user.uid;
        try {
            const userDoc = await db.collection('kullanicilar').doc(currentUserId).get();
            if (userDoc.exists) {
                currentUserRole = userDoc.data().rol;
                initializeApp();
            } else {
                alert("Giriş başarılı ancak kullanıcı rol bilgisi veritabanında bulunamadı. Lütfen yöneticinizle iletişime geçin.");
                handleLogout();
            }
        } catch (error) {
            console.error("Kullanıcı rolü alınırken kritik bir hata oluştu.", error);
            alert("Veritabanına erişirken bir sorun oluştu. Lütfen internet bağlantınızı, Firebase proje ayarlarınızı ve güvenlik kurallarınızı kontrol edin.");
            handleLogout();
        }
    } else {
        window.location.href = 'login.html';
    }
});

// --- UYGULAMA BAŞLATMA ---
function initializeApp() {
    const sidebarNav = document.getElementById('sidebarNav');
    const moduleSections = document.querySelectorAll('.main-content .module-section');
    const logoutButton = document.getElementById('logoutButton');
    const cariForm = document.getElementById('cariForm');
    const cariFormTemizleBtn = document.getElementById('cariFormTemizleBtn');
    const yemTanimForm = document.getElementById('yemTanimForm');
    const yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
    const yemAlisForm = document.getElementById('yemAlisForm');
    const yemAlisFormTemizleBtn = document.getElementById('yemAlisFormTemizleBtn');
    const yemSatisForm = document.getElementById('yemSatisForm'); document.getElementById('yemSecimiSatis').addEventListener('change', (event) => {
    const yemId = event.target.value;
    const fiyatInput = document.getElementById('yemSatisBirimFiyati');
    if (yemId && window.yemDataMap && window.yemDataMap.has(yemId)) {
        fiyatInput.value = window.yemDataMap.get(yemId).satisFiyati || 0;
    } else {
        fiyatInput.value = '';
    }
    // Toplam tutarı yeniden hesapla
    hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar');
});
    const yemSatisFormTemizleBtn = document.getElementById('yemSatisFormTemizleBtn');
    const odemeForm = document.getElementById('odemeForm');
    const odemeFormTemizleBtn = document.getElementById('odemeFormTemizleBtn');
    const ayarlarForm = document.getElementById('ayarlarForm');
    const cariKategoriForm = document.getElementById('cariKategoriForm');
    const kullaniciForm = document.getElementById('kullaniciForm');
    const sifreDegistirForm = document.getElementById('sifreDegistirForm');
    const cariSearchInput = document.getElementById('cariSearchInput');
    const cariKategoriFiltre = document.getElementById('cariKategoriFiltre');
    const cariListesiYazdirBtn = document.getElementById('cariListesiYazdirBtn');
    const topluGirisTarihInput = document.getElementById('topluGirisTarih');
    const topluGirisKategoriSelect = document.getElementById('topluGirisKategori');
    const raporOlusturBtn = document.getElementById('raporOlusturBtn');
    const raporYazdirBtn = document.getElementById('raporYazdirBtn');
    const sutRaporuOlusturBtn = document.getElementById('sutRaporuOlusturBtn');
    const sutRaporuTumunuGosterBtn = document.getElementById('sutRaporuTumunuGosterBtn');
    const sutRaporuKategoriGosterBtn = document.getElementById('sutRaporuKategoriGosterBtn');
    const sutRaporuYazdirBtn = document.getElementById('sutRaporuYazdirBtn');
    const yemRaporuOlusturBtn = document.getElementById('yemRaporuOlusturBtn');
    const yemRaporuYazdirBtn = document.getElementById('yemRaporuYazdirBtn');

    applyRolePermissions();
    loadAndRenderAllData();
    
    sidebarNav.addEventListener('click', function(event) {
        const link = event.target.closest('a.nav-link');
        if (!link || link.id === 'logoutButton') return;
        event.preventDefault();
        
        sidebarNav.querySelectorAll('a.nav-link').forEach(lnk => lnk.classList.remove('active'));
        link.classList.add('active');
        
        const targetId = link.getAttribute('href').substring(1);
        moduleSections.forEach(section => { section.style.display = 'none'; });
        const activeSection = document.getElementById(targetId);
        if(activeSection) activeSection.style.display = 'block';
        
        if (targetId === 'dashboard') { updateDashboardStats(); }
        if (targetId === 'cari-yonetimi') { populateCariKategoriFiltre(); renderCariListesi(); populateCariKategoriSelect(document.getElementById('cariKategori')); }
        if (targetId === 'sut-alimi') { if(topluGirisTarihInput) topluGirisTarihInput.value = getTodayForInput(); populateCariKategoriSelect(topluGirisKategori); renderTopluSutGirisFormu(); renderSutAlimGecmisi(); }
        if (targetId === 'yem-stok-yonetimi') { populateCariSelect(document.getElementById('yemAlisTedarikci')); populateYemSelect(document.getElementById('yemSecimiAlis')); renderYemAlisHareketleri(); renderYemStokListesi(); }
        if (targetId === 'yem-satisi') { populateCariSelect(document.getElementById('yemAlanTedarikci')); populateYemSelect(document.getElementById('yemSecimiSatis')); renderYemSatisListesi(); }
        if (targetId === 'tahsilat-ve-odemeler') { populateCariSelect(document.getElementById('odemeYapilanTedarikci')); renderOdemeListesi(); }
        if (targetId === 'hesap-ozeti'){ populateCariSelect(document.getElementById('raporCariSecimi')); if(!document.getElementById('raporTarihAraligi').value) document.getElementById('raporTarihAraligi').value = getMonthYearForInput(); }
        if (targetId === 'sut-alim-raporu'){ populateCariSelect(document.getElementById('sutRaporuTedarikciSecimi')); populateCariKategoriSelect(document.getElementById('sutRaporuKategoriSecimi'), "Tümü"); if(!document.getElementById('sutRaporuAySecimi').value) document.getElementById('sutRaporuAySecimi').value = getMonthYearForInput(); }
        if (targetId === 'aylik-yem-raporu'){ if(!document.getElementById('yemRaporuAySecimi').value) document.getElementById('yemRaporuAySecimi').value = getMonthYearForInput(); }
        if (targetId === 'ayarlar') { populateCariKategoriSelect(document.getElementById('cariKategori')); renderCariKategoriListesi(); getSettings(); renderKullaniciListesi(); }
        if (targetId === 'hareket-dokumu') {    renderHareketDokumu();}
    });
    
    logoutButton.addEventListener('click', handleLogout);
document.getElementById('yemAlisMiktar').addEventListener('input', () => hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar'));
    document.getElementById('yemAlisBirimFiyati').addEventListener('input', () => hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar'));
document.getElementById('sutDuzenleForm').addEventListener('submit', handleSutAlimiGuncelle);

    document.getElementById('yemSatisMiktar').addEventListener('input', () => hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar'));
    document.getElementById('yemSatisBirimFiyati').addEventListener('input', () => hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar'));
    cariForm.addEventListener('submit', handleCariKaydet);
    if(cariFormTemizleBtn) cariFormTemizleBtn.addEventListener('click', resetCariForm);
    yemTanimForm.addEventListener('submit', handleYemTanimKaydet);
    if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.addEventListener('click', resetYemTanimForm);
    yemAlisForm.addEventListener('submit', handleYemAlisKaydet);
    if(yemAlisFormTemizleBtn) yemAlisFormTemizleBtn.addEventListener('click', resetYemAlisForm);
    yemSatisForm.addEventListener('submit', handleYemSatisKaydet);
    if(yemSatisFormTemizleBtn) yemSatisFormTemizleBtn.addEventListener('click', resetYemSatisForm);
    odemeForm.addEventListener('submit', handleOdemeKaydet);
    if(odemeFormTemizleBtn) odemeFormTemizleBtn.addEventListener('click', resetOdemeForm);
    ayarlarForm.addEventListener('submit', handleAyarlarKaydet);
    cariKategoriForm.addEventListener('submit', handleCariKategoriEkle);
    if(kullaniciForm) kullaniciForm.addEventListener('submit', handleKullaniciKaydet);
    sifreDegistirForm.addEventListener('submit', handleSifreDegistir);

    cariSearchInput.addEventListener('input', renderCariListesi);
    cariKategoriFiltre.addEventListener('change', renderCariListesi);
    cariListesiYazdirBtn.addEventListener('click', handleCariListeYazdir);
    topluGirisTarihInput.addEventListener('change', () => { renderTopluSutGirisFormu(); renderSutAlimGecmisi(); });
    topluGirisKategoriSelect.addEventListener('change', renderTopluSutGirisFormu);

    raporOlusturBtn.addEventListener('click', handleHesapOzetiRaporuOlustur);
    raporYazdirBtn.addEventListener('click', () => handleYazdir('hesap-ozeti'));
    sutRaporuOlusturBtn.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: false}));
    sutRaporuTumunuGosterBtn.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: true, kategori: false}));
    sutRaporuKategoriGosterBtn.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: true}));
    sutRaporuYazdirBtn.addEventListener('click', () => handleYazdir('sut-alim-raporu'));
    yemRaporuOlusturBtn.addEventListener('click', handleYemKarRaporuOlustur);
    yemRaporuYazdirBtn.addEventListener('click', () => handleYazdir('aylik-yem-raporu'));
}

async function loadAndRenderAllData() {
    console.log("Veri yükleme fonksiyonları kontrollü bir şekilde başlatılıyor...");
    try { await renderCariListesi(); } catch (e) { console.warn("Cari listesi yüklenemedi (koleksiyon henüz oluşturulmamış veya index eksik olabilir).", e); }
    try { await renderYemStokListesi(); } catch (e) { console.warn("Yem stoku yüklenemedi (koleksiyon henüz oluşturulmamış veya index eksik olabilir).", e); }
    try { await renderOdemeListesi(); } catch (e) { console.warn("Ödeme listesi yüklenemedi (koleksiyon henüz oluşturulmamış veya index eksik olabilir).", e); }
    try { await renderCariKategoriListesi(); } catch (e) { console.warn("Cari kategori listesi yüklenemedi (koleksiyon henüz oluşturulmamış veya index eksik olabilir).", e); }
    try { await populateCariKategoriFiltre(); } catch (e) { console.warn("Cari kategori filtresi doldurulamadı.", e); }
    try { await populateCariKategoriSelect(document.getElementById('topluGirisKategori')); } catch (e) { console.warn("Toplu giriş kategorisi doldurulamadı.", e); }
    try { await updateDashboardStats(); } catch (e) { console.warn("Panel istatistikleri güncellenemedi.", e); }
    console.log("Veri yükleme denemeleri tamamlandı. Arayüz şimdi kullanılabilir olmalı.");
}

// --- YARDIMCI FONKSİYONLAR ---
function generateId() { return db.collection('_').doc().id; }
function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('tr-TR'); }
function getTodayForInput() { return new Date().toISOString().split('T')[0]; }
function formatMonthYear(ayYil) {
    if (!ayYil) return '';
    const [year, month] = ayYil.split('-');
    const date = new Date(year, month - 1);
    return date.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
}
function getMonthYearForInput() { const d = new Date(); return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;}
function formatCurrency(number) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(number); }
function setEditingMode(formBaslikEl, kaydetBtnEl, temizleBtnEl, editIdVar, formType) { if(!formBaslikEl || !kaydetBtnEl) return; formBaslikEl.textContent = editIdVar ? `${formType} Bilgilerini Düzenle` : `Yeni ${formType} Kaydı`; kaydetBtnEl.textContent = editIdVar ? 'Güncelle' : 'Kaydet'; if (temizleBtnEl) temizleBtnEl.style.display = editIdVar ? 'inline-block' : 'none'; }
function applyRolePermissions() {
    const bodyElement = document.body;
    bodyElement.className = `role-${currentUserRole}`;
    const calisanAllowed = ['#dashboard', '#sut-alimi', '#yem-satisi', '#cari-yonetimi'];
    const activeLink = document.querySelector('#sidebarNav a.nav-link.active');
    const activeHref = activeLink ? activeLink.getAttribute('href') : '#dashboard';
    if (currentUserRole === 'calisan' && !calisanAllowed.includes(activeHref)) {
        document.querySelector('#sidebarNav a.nav-link[href="#dashboard"]').click();
    }
}
function handleLogout() { auth.signOut().then(() => { window.location.href = 'login.html'; }).catch(error => console.error("Logout error", error)); }

// --- AYARLAR FONKSİYONLARI ---
async function getSettings() {
    const varsayilanSutFiyatiInput = document.getElementById('varsayilanSutFiyati');
    const currentUser = auth.currentUser;
    if (!currentUser) {
        console.error("getSettings çağrıldı ancak aktif bir kullanıcı oturumu bulunamadı.");
        return;
    }
    const settingsRef = db.collection('ayarlar').doc(currentUser.uid);
    try {
        const doc = await settingsRef.get();
        if (doc.exists) {
            globalSettings = doc.data();
        }
        if (globalSettings && globalSettings.defaultMilkPrice) {
            varsayilanSutFiyatiInput.value = globalSettings.defaultMilkPrice.toFixed(2);
        } else {
            varsayilanSutFiyatiInput.value = (15.00).toFixed(2);
        }
    } catch(e) { console.error("Ayarlar alınırken hata: ", e); }
}

async function handleAyarlarKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }
    const varsayilanSutFiyatiInput = document.getElementById('varsayilanSutFiyati');
    const yeniFiyat = parseFloat(varsayilanSutFiyatiInput.value);
    if (!isNaN(yeniFiyat) && yeniFiyat >= 0) {
        try {
            await db.collection('ayarlar').doc(currentUser.uid).set({ defaultMilkPrice: yeniFiyat, sahipId: currentUser.uid }, { merge: true });
            globalSettings.defaultMilkPrice = yeniFiyat;
            alert('Genel ayarlar kaydedildi.');
        } catch (error) {
            console.error("Ayarlar kaydedilirken hata:", error);
            alert("Ayarlar kaydedilemedi.");
        }
    } else {
        alert('Lütfen geçerli bir süt fiyatı giriniz.');
    }
}

async function handleSifreDegistir(event) {
    event.preventDefault();
    const eskiSifre = document.getElementById('eskiSifre').value;
    const yeniSifre = document.getElementById('yeniSifre').value;
    const yeniSifreTekrar = document.getElementById('yeniSifreTekrar').value;

    if(!yeniSifre || yeniSifre.length < 6) { alert("Yeni şifre en az 6 karakter olmalıdır!"); return; }
    if(yeniSifre !== yeniSifreTekrar) { alert("Yeni şifreler uyuşmuyor!"); return; }

    const user = auth.currentUser;
    if (!user) { alert("Lütfen giriş yapın."); return; }
    const credential = firebase.auth.EmailAuthProvider.credential(user.email, eskiSifre);

    try {
        await user.reauthenticateWithCredential(credential);
        await user.updatePassword(yeniSifre);
        alert("Şifreniz başarıyla güncellendi!");
        document.getElementById('sifreDegistirForm').reset();
    } catch (error) {
        console.error("Şifre güncelleme hatası:", error);
        alert("Eski şifre hatalı veya bir sorun oluştu.");
    }
}



// --- DASHBOARD FONKSİYONLARI ---
async function updateDashboardStats() {
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    const todayStr = getTodayForInput();

    // Süt ve Aktif Müşteri İstatistikleri
    try {
        const sutSnapshot = await db.collection('sut_alimlari').where("sahipId", "==", currentUser.uid).where("tarih", "==", todayStr).get();
        let sabahToplam = 0, aksamToplam = 0;
        sutSnapshot.forEach(doc => {
            sabahToplam += doc.data().sabah || 0;
            aksamToplam += doc.data().aksam || 0;
        });
        const gunlukToplamSut = sabahToplam + aksamToplam;
        document.getElementById('dashToplamSut').textContent = gunlukToplamSut.toFixed(2);
        document.getElementById('dashSabahSut').textContent = sabahToplam.toFixed(2);
        document.getElementById('dashAksamSut').textContent = aksamToplam.toFixed(2);
        
        const carilerSnapshot = await db.collection('cariler').where("sahipId", "==", currentUser.uid).where("durum", "==", "aktif").get();
        document.getElementById('dashAktifMusteri').textContent = carilerSnapshot.size;
    } catch (e) { console.error("Dashboard temel istatistikleri alınırken hata", e); }
    
    // Bakiye Toplamları
    try {
        const allCarilerSnapshot = await db.collection('cariler').where("sahipId", "==", currentUser.uid).get();
        let toplamGenelAlacak = 0; // İşletmenin alacağı (Müşterilerin borcu)
        let toplamGenelBorc = 0;   // İşletmenin borcu (Müşterilerin alacağı)
        
        if(!allCarilerSnapshot.empty) {
            const bakiyePromises = allCarilerSnapshot.docs.map(doc => calculateCariBakiyeDetayli(doc.id));
            const tumBakiyeler = await Promise.all(bakiyePromises);
            
            tumBakiyeler.forEach(bakiyeDetay => {
                if (bakiyeDetay.bakiye > 0) {
                    toplamGenelBorc += bakiyeDetay.bakiye;
                } else {
                    toplamGenelAlacak += Math.abs(bakiyeDetay.bakiye);
                }
            });
        }
        
        const toplamBakiye = toplamGenelAlacak - toplamGenelBorc;
        document.getElementById('dashToplamAlacak').textContent = formatCurrency(toplamGenelAlacak);
        document.getElementById('dashToplamBorc').textContent = formatCurrency(toplamGenelBorc);
        document.getElementById('dashToplamBakiye').textContent = formatCurrency(toplamBakiye);

        // Bakiye kartına renk ver
        const bakiyeKarti = document.getElementById('dashToplamBakiye').closest('.stat-card');
        bakiyeKarti.classList.remove('alacak', 'borc');
        if (toplamBakiye >= 0) {
            bakiyeKarti.classList.add('alacak');
        } else {
            bakiyeKarti.classList.add('borc');
        }

    } catch (e) { console.error("Dashboard bakiye toplamları alınırken hata", e); }

    // Grafik fonksiyonlarını çağır
    try {
        if (typeof renderGunlukSutGrafik === 'function') renderGunlukSutGrafik();
        if (typeof renderAylikSutGrafik === 'function') renderAylikSutGrafik();
    } catch(e) { console.error("Grafikler oluşturulurken hata", e); }
}

// --- CARİ YÖNETİMİ FONKSİYONLARI ---
async function handleCariKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }
    
    const formData = {
        kodu: document.getElementById('cariKodu').value,
        adiSoyadi: document.getElementById('cariAdiSoyadi').value,
        kategori: document.getElementById('cariKategori').value,
        durum: document.getElementById('cariDurum').value,
        cariTipi: document.getElementById('cariTipi').value, // YENİ EKLENDİ
        telefon: document.getElementById('cariTelefon').value,
        eposta: document.getElementById('cariEposta').value,
        adres: document.getElementById('cariAdres').value,
        bankaAdi: document.getElementById('cariBankaAdi').value,
        iban: document.getElementById('cariIban').value,
        vergiDairesi: document.getElementById('cariVergiDairesi').value,
        vergiNo: document.getElementById('cariVergiNo').value,
        notlar: document.getElementById('cariNotlar').value,
        sahipId: currentUser.uid
    };

    try {
        if (editingCariId) {
            await db.collection('cariler').doc(editingCariId).set(formData, { merge: true });
        } else {
            await db.collection('cariler').add(formData);
        }
        resetCariForm();
        await renderCariListesi();
    } catch(error) { console.error("Hata: ", error); alert("Cari kaydedilirken bir hata oluştu."); }
}
async function renderCariListesi() {
    const cariListesiBody = document.getElementById('cariListesiBody');
    const cariListesiFooter = document.getElementById('cariListesiFooter');
    const cariSearchInput = document.getElementById('cariSearchInput');
    const cariKategoriFiltre = document.getElementById('cariKategoriFiltre');
    const searchTerm = cariSearchInput.value.toLowerCase();
    const kategori = cariKategoriFiltre.value;
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    let query = db.collection('cariler').where("sahipId", "==", currentUser.uid);
    if (kategori) {
        query = query.where("kategori", "==", kategori);
    }
    try {
        const snapshot = await query.orderBy('adiSoyadi').get();
        let cariler = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (searchTerm) {
            cariler = cariler.filter(c => c.kodu?.toLowerCase().includes(searchTerm) || c.adiSoyadi?.toLowerCase().includes(searchTerm));
        }
        
        cariListesiBody.innerHTML = '';
        cariListesiFooter.innerHTML = '';
        
        if (cariler.length === 0) {
            cariListesiBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Kayıtlı cari bulunmuyor.</td></tr>';
            return;
        }

        const bakiyePromises = cariler.map(c => calculateCariBakiyeDetayli(c.id));
        const bakiyeler = await Promise.all(bakiyePromises);
        
        let genelToplamAlacak = 0;
        let genelToplamBorc = 0;

        cariler.forEach((c, index) => {
            const row = cariListesiBody.insertRow();
            const bakiyeDetay = bakiyeler[index];
            if (bakiyeDetay) {
                genelToplamAlacak += bakiyeDetay.alacak;
                genelToplamBorc += bakiyeDetay.borc;
                
                const bakiye = bakiyeDetay.bakiye;
                const durumText = c.durum === 'aktif' ? 'Aktif' : 'Pasif';
                const durumStyle = c.durum === 'aktif' ? 'color:green;' : 'color:red;';
                const bakiyeStyle = bakiye >= 0 ? 'color:green;' : 'color:red;';
                // DEĞİŞİKLİK 1: Bakiye metni (A) ve (B) olarak kısaltıldı.
                const bakiyeText = `${formatCurrency(bakiye)} ${bakiye >= 0 ? '(A)' : '(B)'}`;
                
                // DEĞİŞİKLİK 2: Sütun sırası (Borç, Alınan olarak) güncellendi.
                row.innerHTML = `
                    <td>${c.kodu || ''}</td>
                    <td>${c.adiSoyadi || ''}</td>
                    <td>${c.kategori || ''}</td>
                    <td style="${durumStyle}">${durumText}</td>
                    <td>${c.telefon || ''}</td>
                    <td>${formatCurrency(bakiyeDetay.borc)}</td>
                    <td>${formatCurrency(bakiyeDetay.alacak)}</td>
                    <td style="${bakiyeStyle}">${bakiyeText}</td>
                    <td class="dont-print">
                        <button class="btn btn-edit btn-sm" onclick="editCari('${c.id}')">Düzenle</button>
                        <button class="btn btn-delete btn-sm" onclick="deleteCari('${c.id}')">Sil</button>
                    </td>`;
            }
        });

        const footerRow = cariListesiFooter.insertRow();
        const toplamBakiye = genelToplamAlacak - genelToplamBorc;
        const toplamBakiyeStyle = toplamBakiye >= 0 ? 'color:green;' : 'color:red;';
        const etiket = kategori ? `Kategori Toplamı` : 'Genel Toplam';
        
        // DEĞİŞİKLİK 3: Alt toplamların sırası güncellendi
        footerRow.innerHTML = `
            <td colspan="5"><strong>${etiket}</strong></td>
            <td><strong>${formatCurrency(genelToplamBorc)}</strong></td>
            <td><strong>${formatCurrency(genelToplamAlacak)}</strong></td>
            <td style="${toplamBakiyeStyle}"><strong>${formatCurrency(toplamBakiye)}</strong></td>
            <td class="dont-print"></td>`;

    } catch (error) {
        console.error("Cariler listelenirken hata", error);
        cariListesiBody.innerHTML = '<tr><td colspan="9" style="color:red; text-align:center;">Liste yüklenirken bir hata oluştu. Firestore index\'i gerekebilir.</td></tr>';
    }
}

        let gunlukChartInstance = null;
let aylikChartInstance = null;

async function renderGunlukSutGrafik() {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    const labels = [];
    const data = [];
    
    // Son 7 günün verisini çek
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const tarihStr = d.toISOString().split('T')[0];
        labels.push(d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }));
        
        const snapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', currentUser.uid)
            .where('tarih', '==', tarihStr)
            .get();
        
        let gunlukToplam = 0;
        snapshot.forEach(doc => {
            gunlukToplam += doc.data().toplam;
        });
        data.push(gunlukToplam);
    }

    const ctx = document.getElementById('gunlukSutChart').getContext('2d');
    if(gunlukChartInstance) {
        gunlukChartInstance.destroy(); // Önceki grafiği temizle
    }
    gunlukChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Toplam Süt (Lt)',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });
}

async function renderAylikSutGrafik() {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const startDateStr = new Date(year, month, 1).toISOString().split('T')[0];
    const endDateStr = new Date(year, month, daysInMonth).toISOString().split('T')[0];

    const snapshot = await db.collection('sut_alimlari')
        .where('sahipId', '==', currentUser.uid)
        .where('tarih', '>=', startDateStr)
        .where('tarih', '<=', endDateStr)
        .get();

    const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
    const data = Array(daysInMonth).fill(0);

    snapshot.forEach(doc => {
        const alim = doc.data();
        const gunIndex = new Date(alim.tarih).getUTCDate() - 1;
        if(gunIndex >= 0 && gunIndex < daysInMonth) {
            data[gunIndex] += alim.toplam;
        }
    });

    const ctx = document.getElementById('aylikSutChart').getContext('2d');
    if(aylikChartInstance) {
        aylikChartInstance.destroy();
    }
    aylikChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Toplam Süt (Lt)',
                data: data,
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });
}
async function editCari(id) { 
    try {
        const doc = await db.collection('cariler').doc(id).get();
        if (!doc.exists) return;
        const cari = doc.data();

        const cariKoduInput = document.getElementById('cariKodu');
        cariKoduInput.readOnly = false;
        
        editingCariId = id; 
        document.getElementById('cariEditId').value = id; 
        document.getElementById('cariKodu').value = cari.kodu || ''; 
        document.getElementById('cariAdiSoyadi').value = cari.adiSoyadi || ''; 
        document.getElementById('cariKategori').value = cari.kategori || ''; 
        document.getElementById('cariDurum').value = cari.durum || 'aktif';
        document.getElementById('cariTipi').value = cari.cariTipi || 'sut_ve_yem'; // YENİ EKLENDİ
        document.getElementById('cariTelefon').value = cari.telefon || ''; 
        document.getElementById('cariEposta').value = cari.eposta || ''; 
        document.getElementById('cariAdres').value = cari.adres || ''; 
        document.getElementById('cariBankaAdi').value = cari.bankaAdi || ''; 
        document.getElementById('cariIban').value = cari.iban || ''; 
        document.getElementById('cariVergiDairesi').value = cari.vergiDairesi || ''; 
        document.getElementById('cariVergiNo').value = cari.vergiNo || ''; 
        document.getElementById('cariNotlar').value = cari.notlar || ''; 
        setEditingMode(document.getElementById('cariFormBaslik'), document.getElementById('cariKaydetBtn'), document.getElementById('cariFormTemizleBtn'), editingCariId, 'Cari Kart');
        document.getElementById('cariForm').scrollIntoView();
    } catch (error) {
        console.error("Cari düzenleme için getirilirken hata:", error);
    }
}
async function deleteCari(id) { 
    if (confirm('Bu cariyi ve ilgili tüm hareketlerini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
        const currentUser = auth.currentUser;
        if (!currentUser) return;
        const batch = db.batch();
        batch.delete(db.collection('cariler').doc(id));
        const hareketler = ['sut_alimlari', 'yem_alimlari', 'yem_satislari', 'odemeVeTahsilatlar'];
        try {
            for(const koleksiyon of hareketler) {
                const snapshot = await db.collection(koleksiyon).where('cariId', '==', id).where('sahipId', '==', currentUser.uid).get();
                snapshot.forEach(doc => batch.delete(doc.ref));
            }
            await batch.commit();
            await renderCariListesi();
        } catch(error) {
            console.error("Cari silinirken hata:", error);
            alert("İlişkili hareketler silinirken bir hata oluştu.");
        }
    }
}
function resetCariForm(){ 
    document.getElementById('cariForm').reset(); 
    editingCariId = null; 
    document.getElementById('cariEditId').value = ''; 
    setEditingMode(document.getElementById('cariFormBaslik'), document.getElementById('cariKaydetBtn'), document.getElementById('cariFormTemizleBtn'), null, 'Cari Kart');
}
async function handleCariKategoriEkle(event) {
    event.preventDefault();
    const yeniCariKategoriAdiInput = document.getElementById('yeniCariKategoriAdi');
    const yeniAd = yeniCariKategoriAdiInput.value.trim();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }
    if (yeniAd === '') { alert('Kategori/Köy adı boş olamaz.'); return; }
    try {
        await db.collection('cari_kategorileri').add({ ad: yeniAd, sahipId: currentUser.uid });
        await Promise.all([
          renderCariKategoriListesi(),
          populateCariKategoriSelect(document.getElementById('cariKategori')),
          populateCariKategoriFiltre(),
          populateCariKategoriSelect(document.getElementById('topluGirisKategori'))
        ]);
        yeniCariKategoriAdiInput.value = '';
    } catch (error) {
        console.error("Kategori eklenirken hata: ", error);
        alert("Kategori eklenemedi. Konsolu kontrol edin.");
    }
}
async function renderCariKategoriListesi() {
    const cariKategoriListesiUl = document.getElementById('cariKategoriListesiUl');
    const currentUser = auth.currentUser;
    if (!cariKategoriListesiUl || !currentUser) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", currentUser.uid).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        cariKategoriListesiUl.innerHTML = ''; 
        if (kategoriler.length === 0) { cariKategoriListesiUl.innerHTML = '<li>Tanımlı kategori/köy bulunmuyor.</li>'; return; } 
        kategoriler.forEach(kat => { const li = document.createElement('li'); li.textContent = kat.ad; const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Sil'; deleteBtn.classList.add('btn', 'btn-delete', 'btn-sm', 'dont-print'); deleteBtn.onclick = () => deleteCariKategori(kat.id); li.appendChild(deleteBtn); cariKategoriListesiUl.appendChild(li); });
    } catch(error) { console.error("Kategoriler listelenirken hata:", error); }
}
async function deleteCariKategori(id) { 
    if (confirm('Bu kategoriyi/köyü silmek istediğinizden emin misiniz?')) { 
        try {
            await db.collection('cari_kategorileri').doc(id).delete(); 
            await Promise.all([renderCariKategoriListesi(), populateCariKategoriSelect(document.getElementById('cariKategori')), populateCariKategoriFiltre(), populateCariKategoriSelect(document.getElementById('topluGirisKategori'))]);
        } catch(error) { console.error("Kategori silinirken hata:", error); }
    }
}

// --- POPULATE (DOLDURMA) FONKSİYONLARI ---
async function populateCariKategoriFiltre() { 
    const selectElement = document.getElementById('cariKategoriFiltre');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", currentUser.uid).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value; 
        selectElement.innerHTML = `<option value="">Tüm Kategoriler</option>`; 
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); 
        selectElement.value = currentValue; 
    } catch(error) { console.error("Kategori filtresi yüklenirken hata:", error); }
}
async function populateCariKategoriSelect(selectElement, defaultOptionText = "Seçiniz...") { 
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", currentUser.uid).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value; 
        selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`; 
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); 
        if (kategoriler.some(kat => kat.ad === currentValue)) { selectElement.value = currentValue; }
    } catch(error) { console.error("Kategori seçimi yüklenirken hata:", error); }
}
async function populateCariSelect(selectElement, defaultText = "Seçiniz...") { 
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('cariler').where("sahipId", "==", currentUser.uid).where("durum", "==", "aktif").orderBy('adiSoyadi').get();
        const cariler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const currentValue = selectElement.value; 
        selectElement.innerHTML = ''; 
        const firstOption = document.createElement('option'); firstOption.value = ""; firstOption.textContent = defaultText; selectElement.appendChild(firstOption); 
        cariler.forEach(c => { const option = document.createElement('option'); option.value = c.id; option.textContent = `${c.adiSoyadi} (${c.kodu || 'Kodsuz'})`; selectElement.appendChild(option); }); 
        if (cariler.some(c => c.id === currentValue)) { selectElement.value = currentValue; }
    } catch(error) { console.error("Cari seçimi yüklenirken hata:", error); }
}
async function populateYemSelect(selectElement, defaultText = "Yem Seçiniz...") {
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yemler').where("sahipId", "==", currentUser.uid).orderBy('ad').get();
        const yemler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        window.yemDataMap = new Map(); // Fiyatları saklamak için global bir map
        yemler.forEach(y => window.yemDataMap.set(y.id, y));

        selectElement.innerHTML = ''; 
        const firstOption = document.createElement('option'); firstOption.value = ""; firstOption.textContent = defaultText; selectElement.appendChild(firstOption);
        yemler.forEach(y => {
            const option = document.createElement('option');
            option.value = y.id;
            option.textContent = `${y.ad} (${y.kod}) - Stok: ${y.stokMiktari || 0} ${y.birim}`;
            selectElement.appendChild(option);
        });
    } catch (error) {
        console.error("Yem seçimi yüklenirken hata:", error);
    }
}

// --- KULLANICI YÖNETİMİ ---
async function handleKullaniciKaydet(event) {
    event.preventDefault();
    alert("Bu özellik güvenlik nedeniyle doğrudan yeni kullanıcı oluşturmaz. Lütfen önce Firebase Authentication panelinden kullanıcıyı e-posta/şifre ile oluşturun, ardından bu panelden o kullanıcıya ait bir profil (rol ataması) oluşturabilirsiniz.");
}
async function deleteKullanici(id) {
    if(confirm("Kullanıcıyı silmek istiyor musunuz?")) {
        try {
            await db.collection('kullanicilar').doc(id).delete();
            await renderKullaniciListesi();
        } catch (error) {
            console.error("Kullanıcı silinirken hata:", error);
        }
    }
}
async function renderKullaniciListesi() {
    const kullaniciListesiBody = document.getElementById('kullaniciListesiBody');
    const currentUser = auth.currentUser;
    if(!kullaniciListesiBody || !currentUser) return;
    try {
        const snapshot = await db.collection('kullanicilar').where("sahipId", "==", currentUser.uid).get();
        kullaniciListesiBody.innerHTML = '';
        snapshot.forEach(doc => {
            const user = doc.data();
            if(user.rol === 'admin') return;
            const row = kullaniciListesiBody.insertRow();
            row.innerHTML = `<td>${user.kullaniciAdi}</td><td>Çalışan</td><td class="dont-print"><button class="btn btn-delete btn-sm" onclick="deleteKullanici('${doc.id}')">Sil</button></td>`;
        });
    } catch(error) { console.error("Kullanıcılar listelenirken hata", error); }
}

// --- YEM YÖNETİMİ ---

// Yem Alış Hareketleri için Düzenleme
async function editYemAlisi(id) {
    try {
        const doc = await db.collection('yem_alimlari').doc(id).get();
        if (!doc.exists) {
            alert("Düzenlenecek kayıt bulunamadı.");
            return;
        }
        const data = doc.data();
        
        editingYemAlisId = id; // Global düzenleme ID'sini ayarla
        document.getElementById('yemAlisEditId').value = id;
        document.getElementById('yemAlisTarih').value = data.tarih;
        document.getElementById('yemSecimiAlis').value = data.yemId;
        document.getElementById('yemAlisMiktar').value = data.miktar;
        document.getElementById('yemAlisTedarikci').value = data.cariId;
        document.getElementById('yemAlisBirimFiyati').value = data.alisFiyati;
        hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar');

        setEditingMode(document.getElementById('yemAlisFormBaslik'), document.getElementById('yemAlisKaydetBtn'), document.getElementById('yemAlisFormTemizleBtn'), id, 'Yem Alışı');
        document.getElementById('yemAlisForm').scrollIntoView();
    } catch (error) {
        console.error("Yem alışı düzenleme için getirilirken hata:", error);
    }
}
// Yem Satış Hareketleri için Düzenleme
async function editYemSatisi(id) {
    try {
        const doc = await db.collection('yem_satislari').doc(id).get();
        if (!doc.exists) { alert("Düzenlenecek kayıt bulunamadı."); return; }
        const data = doc.data();

        document.getElementById('yemSatisEditId').value = id;
        document.getElementById('yemSatisTarih').value = data.tarih;
        document.getElementById('yemAlanTedarikci').value = data.cariId;
        document.getElementById('yemSecimiSatis').value = data.yemId;
        document.getElementById('yemSatisMiktar').value = data.miktar;
        document.getElementById('yemSatisBirimFiyati').value = data.satisFiyati;
        hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar');

        setEditingMode(document.getElementById('yemSatisFormBaslik'), document.getElementById('yemSatisKaydetBtn'), document.getElementById('yemSatisFormTemizleBtn'), id, 'Yem Satışı');
        document.getElementById('yemSatisForm').scrollIntoView();
        alert("Stokları etkileyen bu kaydı düzenlemek şu an için desteklenmemektedir. Lütfen kaydı silip yeniden oluşturun.");
    } catch (error) {
        console.error("Yem satışı düzenleme için getirilirken hata:", error);
    }
}






async function handleYemTanimKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }
    const formData = {
        kod: document.getElementById('yemKodu').value,
        ad: document.getElementById('yemAdi').value,
        kategori: document.getElementById('yemKategorisi').value,
        birim: document.getElementById('yemBirimi').value,
        alisFiyati: parseFloat(document.getElementById('yemAlisFiyati').value) || 0,
        satisFiyati: parseFloat(document.getElementById('yemSatisFiyati').value) || 0,
        sahipId: currentUser.uid
    };
    try {
        if (editingYemTanimId) {
            await db.collection('yemler').doc(editingYemTanimId).set(formData, { merge: true }); // merge:true stokMiktarını korur
            alert("Yem tanımı güncellendi.");
        } else {
            formData.stokMiktari = 0; // Yeni tanımda stok 0'dır.
            await db.collection('yemler').add(formData);
            alert("Yem tanımı kaydedildi.");
        }
        resetYemTanimForm();
        await renderYemStokListesi();
    } catch (error) {
        console.error("Yem tanımı kaydedilirken hata:", error);
        alert("Yem tanımı kaydedilirken bir hata oluştu.");
    }
}





function resetYemTanimForm() {
    const yemTanimForm = document.getElementById('yemTanimForm');
    const yemTanimFormBaslik = document.getElementById('yemTanimFormBaslik');
    const yemTanimKaydetBtn = document.getElementById('yemTanimKaydetBtn');
    const yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
    yemTanimForm.reset();
    editingYemTanimId = null;
    document.getElementById('yemTanimEditId').value = '';
    if(yemTanimFormBaslik) yemTanimFormBaslik.textContent = 'Yeni Yem Tanımla';
    if(yemTanimKaydetBtn) yemTanimKaydetBtn.textContent = 'Kaydet';
    if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.style.display = 'none';
}

async function renderYemStokListesi() {
    const yemStokListesiBody = document.getElementById('yemStokListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yemler').where('sahipId', '==', currentUser.uid).orderBy('ad').get();
        if (snapshot.empty) {
            yemStokListesiBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Tanımlı yem bulunmuyor.</td></tr>';
            return;
        }
        let rows = '';
        snapshot.forEach(doc => {
            const yem = doc.data();
            rows += `<tr>
                <td>${yem.kod || ''}</td>
                <td>${yem.ad || ''}</td>
                <td>${yem.kategori || ''}</td>
                <td>${yem.birim || ''}</td>
                <td>${formatCurrency(yem.alisFiyati || 0)}</td>
                <td>${formatCurrency(yem.satisFiyati || 0)}</td>
                <td>${yem.stokMiktari || 0}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemTanimi('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemTanimi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        yemStokListesiBody.innerHTML = rows;
    } catch (error) { console.error("Yem stok listesi yüklenirken hata:", error); }
}

// --- YEM ALIŞ-SATIŞ ---
async function handleYemAlisKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }

    const miktar = parseInt(document.getElementById('yemAlisMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('yemAlisBirimFiyati').value);
    const yemId = document.getElementById('yemSecimiAlis').value;
    
    if (!yemId || isNaN(miktar) || miktar < 0 || isNaN(birimFiyat)) {
        alert("Lütfen yem, miktar ve fiyat alanlarını doğru bir şekilde doldurun.");
        return;
    }

    const formData = {
        tarih: document.getElementById('yemAlisTarih').value,
        yemId: yemId,
        miktar: miktar,
        cariId: document.getElementById('yemAlisTedarikci').value || '',
        alisFiyati: birimFiyat,
        toplamTutar: miktar * birimFiyat,
        sahipId: currentUser.uid
    };

    // DÜZENLEME MANTIĞI
    if (editingYemAlisId) {
        const alisRef = db.collection('yem_alimlari').doc(editingYemAlisId);
        const yemRef = db.collection('yemler').doc(yemId);

        try {
            await db.runTransaction(async (transaction) => {
                const eskiAlisDoc = await transaction.get(alisRef);
                if (!eskiAlisDoc.exists) {
                    throw "Düzenlenecek kayıt bulunamadı.";
                }
                
                const eskiMiktar = eskiAlisDoc.data().miktar;
                // Eğer yem türü değiştiyse bu durum çok karmaşıklaşır, bu yüzden şimdilik engelliyoruz.
                if (eskiAlisDoc.data().yemId !== yemId) {
                    throw "Yem türü düzenleme sırasında değiştirilemez. Lütfen kaydı silip yeniden oluşturun.";
                }

                const stokFarki = miktar - eskiMiktar; // Yeni ve eski miktar arasındaki fark

                transaction.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(stokFarki) });
                transaction.update(alisRef, formData);
            });
            
            alert("Yem alışı başarıyla güncellendi.");
            resetYemAlisForm();
            await renderYemStokListesi();
            await renderYemAlisHareketleri();

        } catch (error) {
            console.error("Yem alışı güncellenirken hata:", error);
            alert("Hata: " + error);
        }
    } 
    // YENİ KAYIT MANTIĞI
    else {
        try {
            const batch = db.batch();
            const yemAlimRef = db.collection('yem_alimlari').doc();
            batch.set(yemAlimRef, formData);
            const yemRef = db.collection('yemler').doc(yemId);
            batch.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(miktar) });
            await batch.commit();
            
            resetYemAlisForm();
            await renderYemStokListesi();
            await renderYemAlisHareketleri();
        } catch (error) {
            console.error("Yem alışı kaydedilirken hata:", error);
            alert("Yem alışı kaydedilirken bir hata oluştu.");
        }
    }
}
async function deleteYemTanimi(id) {
    if (!confirm("Bu yem tanımını silmek istediğinizden emin misiniz? Eğer bu yem ile ilgili bir alış veya satış yapıldıysa, silme işlemi engellenecektir.")) return;
    try {
        // Bu yemin kullanılıp kullanılmadığını kontrol et
        const alisSnapshot = await db.collection('yem_alimlari').where('yemId', '==', id).limit(1).get();
        const satisSnapshot = await db.collection('yem_satislari').where('yemId', '==', id).limit(1).get();
        if (!alisSnapshot.empty || !satisSnapshot.empty) {
            alert("Bu yem ile ilgili alış veya satış hareketleri bulunduğu için silemezsiniz.");
            return;
        }
        await db.collection('yemler').doc(id).delete();
        alert("Yem tanımı silindi.");
        await renderYemStokListesi();
    } catch (error) {
        console.error("Yem tanımı silinirken hata:", error);
        alert("Yem tanımı silinirken bir hata oluştu.");
    }
}

async function editYemTanimi(id) {
    try {
        const doc = await db.collection('yemler').doc(id).get();
        if (!doc.exists) { alert("Düzenlenecek yem bulunamadı."); return; }
        const yem = doc.data();
        
        editingYemTanimId = id;
        document.getElementById('yemTanimEditId').value = id;
        document.getElementById('yemKodu').value = yem.kod;
        document.getElementById('yemAdi').value = yem.ad;
        document.getElementById('yemKategorisi').value = yem.kategori;
        document.getElementById('yemBirimi').value = yem.birim;
        document.getElementById('yemAlisFiyati').value = yem.alisFiyati;
        document.getElementById('yemSatisFiyati').value = yem.satisFiyati;
        
        setEditingMode(document.getElementById('yemTanimFormBaslik'), document.getElementById('yemTanimKaydetBtn'), document.getElementById('yemTanimFormTemizleBtn'), id, 'Yem Tanımı');
        document.getElementById('yemTanimForm').scrollIntoView();
    } catch (error) { console.error("Yem tanımı düzenlenirken hata:", error); }
}


function resetYemAlisForm() {
    document.getElementById('yemAlisForm').reset();
    editingYemAlisId = null;
    document.getElementById('yemAlisEditId').value = '';
    setEditingMode(document.getElementById('yemAlisFormBaslik'), document.getElementById('yemAlisKaydetBtn'), document.getElementById('yemAlisFormTemizleBtn'), null, 'Yeni Yem Alışı');
}

   async function renderYemAlisHareketleri() {
    const listBody = document.getElementById('yemAlisHareketListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yem_alimlari').where('sahipId', '==', currentUser.uid).orderBy('tarih', 'desc').limit(20).get();
        if (snapshot.empty) {
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Yem alım hareketi bulunmuyor.</td></tr>';
            return;
        }
        
        // Performans için yem ve cari isimlerini toplu çek
        const yemIds = new Set();
        const cariIds = new Set();
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            yemIds.add(data.yemId);
            if (data.cariId) { // Sadece dolu olan cariId'leri ekle
                cariIds.add(data.cariId);
            }
        });

        const yemMap = new Map();
        const cariMap = new Map();

        // Yem ve Cari bilgilerini getirecek sorguları hazırla
        const yemPromise = yemIds.size > 0 ? db.collection('yemler').where(firebase.firestore.FieldPath.documentId(), 'in', Array.from(yemIds)).get() : Promise.resolve({ docs: [] });
        const cariPromise = cariIds.size > 0 ? db.collection('cariler').where(firebase.firestore.FieldPath.documentId(), 'in', Array.from(cariIds)).get() : Promise.resolve({ docs: [] });

        const [yemSnapshot, cariSnapshot] = await Promise.all([yemPromise, cariPromise]);
        
        yemSnapshot.forEach(doc => yemMap.set(doc.id, doc.data().ad));
        cariSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));
        
        let rows = '';
        snapshot.forEach(doc => {
            const alim = doc.data();
            const yemAdi = yemMap.get(alim.yemId) || 'Bilinmiyor';
            // DÜZELTME: Cari ID yerine, haritadan (map) bulunan cari adını yazdırıyoruz.
            const cariAdi = alim.cariId ? cariMap.get(alim.cariId) : 'Peşin Alış';

            rows += `<tr>
                <td>${formatDate(alim.tarih)}</td>
                <td>${yemAdi}</td>
                <td>${alim.miktar}</td>
                <td>${cariAdi}</td>
                <td>${formatCurrency(alim.alisFiyati)}</td>
                <td>${formatCurrency(alim.toplamTutar)}</td>
                <td class="dont-print">
                    <button class="btn btn-delete btn-sm" onclick="deleteYemAlisi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;
    } catch(e) { console.error("Yem alış hareketleri yüklenirken hata:", e); }
}
async function editOdeme(id) {
    try {
        const doc = await db.collection('odemeVeTahsilatlar').doc(id).get();
        if (!doc.exists) {
            alert("Düzenlenecek kayıt bulunamadı.");
            return;
        }
        const data = doc.data();
        
        document.getElementById('odemeEditId').value = id;
        document.getElementById('islemTuru').value = data.islemTuru;
        document.getElementById('odemeTarih').value = data.tarih;
        document.getElementById('odemeYapilanTedarikci').value = data.cariId;
        document.getElementById('odemeTutari').value = data.tutar;
        document.getElementById('odemeAciklama').value = data.aciklama;
        
        setEditingMode(document.getElementById('odemeFormBaslik'), document.getElementById('odemeKaydetBtn'), document.getElementById('odemeFormTemizleBtn'), id, 'Hareket Girişi');
        document.getElementById('odemeForm').scrollIntoView();

    } catch (error) {
        console.error("Ödeme düzenleme için getirilirken hata:", error);
    }
}

// Ödeme/Tahsilat kaydını siler
async function deleteOdeme(id) {
    if (confirm("Bu işlem hareketini silmek istediğinizden emin misiniz?")) {
        try {
            await db.collection('odemeVeTahsilatlar').doc(id).delete();
            await renderOdemeListesi(); // Listeyi yenile
        } catch (error) {
            console.error("Ödeme silinirken hata:", error);
            alert("İşlem silinirken bir hata oluştu.");
        }
    }
}

function closeSutDuzenleForm() {
    document.getElementById('sutDuzenleFormAlani').style.display = 'none';
    document.getElementById('sutDuzenleForm').reset();
}

// YENİ FONKSİYON
async function renderHareketDokumu() {
    const listBody = document.getElementById('hareketDokumuBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Yükleniyor...</td></tr>';

    try {
        let tumHareketler = [];

        // Veri kaynaklarını ve nasıl işleneceklerini tanımla
        const kaynaklar = [
            { koleksiyon: 'sut_alimlari', tur: 'Süt Alımı', aciklamaEk: 'Lt', tutarAlan: 'toplamTutar' },
            { koleksiyon: 'yem_satislari', tur: 'Yem Satışı', aciklamaEk: 'Adet', tutarAlan: 'toplamTutar' },
            { koleksiyon: 'odemeVeTahsilatlar', tur: 'islemTuru', aciklamaEk: '', tutarAlan: 'tutar' }
        ];

        // Tüm carilerin isimlerini almak için bir harita oluştur
        const carilerSnapshot = await db.collection('cariler').where('sahipId', '==', currentUser.uid).get();
        const cariMap = new Map();
        carilerSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));

        // Tüm veri kaynaklarından verileri çek
        const sorguPromise_leri = kaynaklar.map(kaynak => 
            db.collection(kaynak.koleksiyon).where('sahipId', '==', currentUser.uid).get()
        );
        const sonuclar = await Promise.all(sorguPromise_leri);

        // Verileri standart bir formata dönüştür
        sonuclar.forEach((snapshot, index) => {
            const kaynak = kaynaklar[index];
            snapshot.forEach(doc => {
                const data = doc.data();
                let islemTuru = kaynak.tur;
                if(kaynak.tur === 'islemTuru') {
                    islemTuru = data.islemTuru === 'odeme' ? 'Ödeme' : 'Tahsilat';
                }
                
                let aciklama = data.aciklama || '';
                if(kaynak.koleksiyon === 'sut_alimlari') aciklama = `${data.toplam.toFixed(2)} ${kaynak.aciklamaEk}`;
                if(kaynak.koleksiyon === 'yem_satislari') aciklama = `${data.miktar} ${kaynak.aciklamaEk}`;

                tumHareketler.push({
                    tarih: data.tarih,
                    cariAdi: cariMap.get(data.cariId) || 'İlişkisiz Cari',
                    islemTuru: islemTuru,
                    aciklama: aciklama,
                    tutar: data[kaynak.tutarAlan]
                });
            });
        });

        // Tüm hareketleri tarihe göre en yeniden eskiye sırala
        tumHareketler.sort((a, b) => new Date(b.tarih) - new Date(a.tarih));

        if (tumHareketler.length === 0) {
            listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Hiç işlem hareketi bulunmuyor.</td></tr>';
            return;
        }

        // HTML tablosunu oluştur
        listBody.innerHTML = tumHareketler.map(h => `
            <tr>
                <td>${formatDate(h.tarih)}</td>
                <td>${h.cariAdi}</td>
                <td>${h.islemTuru}</td>
                <td>${h.aciklama}</td>
                <td>${formatCurrency(h.tutar)}</td>
            </tr>
        `).join('');

    } catch (error) {
        console.error("Hareket dökümü oluşturulurken hata:", error);
        listBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Rapor yüklenirken bir hata oluştu.</td></tr>';
    }
}
async function deleteSutAlimi(id) {
    if (confirm("Bu süt alım kaydını silmek istediğinizden emin misiniz?")) {
        try {
            await db.collection('sut_alimlari').doc(id).delete();
            await renderSutAlimGecmisi();
            await renderTopluSutGirisFormu();
        } catch (error) {
            console.error("Süt alımı silinirken hata:", error);
        }
    }
}

async function handleSutAlimiGuncelle(event) {
    event.preventDefault();
    const id = document.getElementById('sutDuzenleId').value;
    const sabah = parseFloat(document.getElementById('sutDuzenleSabah').value) || 0;
    const aksam = parseFloat(document.getElementById('sutDuzenleAksam').value) || 0;
    const fiyat = parseFloat(document.getElementById('sutDuzenleFiyat').value) || 0;
    const toplam = sabah + aksam;

    const guncelVeri = {
        sabah: sabah,
        aksam: aksam,
        fiyat: fiyat,
        toplam: toplam,
        toplamTutar: toplam * fiyat
    };

    try {
        await db.collection('sut_alimlari').doc(id).update(guncelVeri);
        closeSutDuzenleForm();
        await renderSutAlimGecmisi();
    } catch (error) { console.error("Süt alımı güncellenirken hata:", error); }
}


async function editSutAlimi(id) {
    const formAlani = document.getElementById('sutDuzenleFormAlani');
    try {
        const doc = await db.collection('sut_alimlari').doc(id).get();
        if (!doc.exists) return;
        const data = doc.data();
        
        document.getElementById('sutDuzenleId').value = id;
        document.getElementById('sutDuzenleSabah').value = data.sabah;
        document.getElementById('sutDuzenleAksam').value = data.aksam;
        document.getElementById('sutDuzenleFiyat').value = data.fiyat;
        
        formAlani.style.display = 'block';
        formAlani.scrollIntoView({behavior: 'smooth'});
    } catch (error) { console.error("Süt alımı düzenleme için getirilirken hata:", error); }
}

async function handleYemSatisKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }
    
    if (editingYemSatisId) {
        alert("Stokları etkileyen satış işlemleri düzenlenemez. Lütfen kaydı silip doğru bir şekilde yeniden oluşturun.");
        resetYemSatisForm();
        return;
    }

    const miktar = parseInt(document.getElementById('yemSatisMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('yemSatisBirimFiyati').value);
    const yemId = document.getElementById('yemSecimiSatis').value;
    const cariId = document.getElementById('yemAlanTedarikci').value;
    if (!yemId || !cariId || isNaN(miktar) || miktar <= 0 || isNaN(birimFiyat)) {
        alert("Lütfen cari, yem, miktar ve fiyat alanlarını doğru bir şekilde doldurun."); return;
    }
    const yemRef = db.collection('yemler').doc(yemId);
    const yemSatisRef = db.collection('yem_satislari').doc();
    try {
        await db.runTransaction(async (transaction) => {
            const yemDoc = await transaction.get(yemRef);
            if (!yemDoc.exists) { throw "Satılmak istenen yem veritabanında bulunamadı."; }
            const anlikStok = yemDoc.data().stokMiktari || 0;
            if (anlikStok < miktar) { throw `Yetersiz stok! Anlık stok: ${anlikStok}`; }
            const formData = {
                tarih: document.getElementById('yemSatisTarih').value, yemId: yemId, cariId: cariId, 
                miktar: miktar, satisFiyati: birimFiyat, toplamTutar: miktar * birimFiyat, sahipId: currentUser.uid
            };
            transaction.set(yemSatisRef, formData);
            transaction.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(-miktar) });
        });
        resetYemSatisForm();
        await renderYemStokListesi();
        await renderYemSatisListesi();
    } catch (error) {
        console.error("Yem satışı kaydedilirken hata:", error);
        alert("Yem satışı kaydedilemedi: " + error);
    }
}





function resetYemSatisForm() {
    document.getElementById('yemSatisForm').reset();
    editingYemSatisId = null;
    document.getElementById('yemSatisEditId').value = '';
    setEditingMode(document.getElementById('yemSatisFormBaslik'), document.getElementById('yemSatisKaydetBtn'), document.getElementById('yemSatisFormTemizleBtn'), null, 'Yeni Yem Satışı');
}
async function calculateCariBakiyeDetayli(cariId) {
    let alacak = 0; // İşletmenin cariye borcu (Süt alımı, Cari Alacaklı Bakiye)
    let borc = 0;   // Cariyenin işletmeye borcu (Yem satışı, Cari Borçlu Bakiye)

    const currentUser = auth.currentUser;
    if (!currentUser) return { alacak: 0, borc: 0, bakiye: 0 };

    try {
        const sutQuery = db.collection('sut_alimlari').where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId).get();
        const yemQuery = db.collection('yem_satislari').where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId).get();
        const odemeQuery = db.collection('odemeVeTahsilatlar').where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId).get();

        const [sutSnapshot, yemSnapshot, odemeSnapshot] = await Promise.all([
            sutQuery, yemQuery, odemeQuery
        ]);

        sutSnapshot.forEach(doc => alacak += doc.data().toplamTutar);
        yemSnapshot.forEach(doc => borc += doc.data().toplamTutar);
        
        odemeSnapshot.forEach(doc => {
            const data = doc.data();
            // Cari Alacaklı ise -> İşletmenin borcu artar (alacak)
            if (data.islemTuru === 'odeme') { 
                alacak += data.tutar;
            } 
            // Cari Borçlu ise -> İşletmenin alacağı artar (borç)
            else if (data.islemTuru === 'tahsilat') {
                borc += data.tutar;
            }
        });

        // Bakiye > 0 ise İşletme Borçlu, Cari Alacaklı
        // Bakiye < 0 ise İşletme Alacaklı, Cari Borçlu
        return { alacak, borc, bakiye: alacak - borc };

    } catch (error) {
        console.error(`Bakiye hesaplanırken hata (Cari ID: ${cariId}):`, error);
        return { alacak: 0, borc: 0, bakiye: 0 };
    }
}

        
async function renderYemSatisListesi() {
    const listBody = document.getElementById('yemSatisListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yem_satislari').where('sahipId', '==', currentUser.uid).orderBy('tarih', 'desc').limit(20).get();
        if (snapshot.empty) { listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Yem satış hareketi bulunmuyor.</td></tr>'; return; }
        
        const yemIds = [...new Set(snapshot.docs.map(doc => doc.data().yemId))];
        const cariIds = [...new Set(snapshot.docs.map(doc => doc.data().cariId))];
        const yemMap = new Map();
        const cariMap = new Map();
        if (yemIds.length > 0) {
            const yemSnapshot = await db.collection('yemler').where(firebase.firestore.FieldPath.documentId(), 'in', yemIds).get();
            yemSnapshot.forEach(doc => yemMap.set(doc.id, doc.data().ad));
        }
        if (cariIds.length > 0) {
            const cariSnapshot = await db.collection('cariler').where(firebase.firestore.FieldPath.documentId(), 'in', cariIds).get();
            cariSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));
        }
        
        let rows = '';
        snapshot.forEach(doc => {
            const satis = doc.data();
            const yemAdi = yemMap.get(satis.yemId) || 'Bilinmiyor';
            const cariAdi = cariMap.get(satis.cariId) || 'Bilinmiyor';
            rows += `<tr>
                <td>${formatDate(satis.tarih)}</td><td>${cariAdi}</td><td>${yemAdi}</td><td>${satis.miktar}</td>
                <td>${formatCurrency(satis.satisFiyati)}</td><td>${formatCurrency(satis.toplamTutar)}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemSatisi('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemSatisi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;
    } catch(e) { console.error("Yem satış hareketleri yüklenirken hata:", e); }
}




async function handleOdemeKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("Lütfen giriş yapın."); return; }
    const tutar = parseFloat(document.getElementById('odemeTutari').value);
    const cariId = document.getElementById('odemeYapilanTedarikci').value;
    if (!cariId || isNaN(tutar) || tutar <= 0) {
        alert("Lütfen cari ve tutar alanlarını doğru bir şekilde doldurun.");
        return;
    }
    const formData = {
        tarih: document.getElementById('odemeTarih').value,
        cariId: cariId,
        islemTuru: document.getElementById('islemTuru').value,
        tutar: tutar,
        aciklama: document.getElementById('odemeAciklama').value.trim(),
        sahipId: currentUser.uid
    };
    try {
        if (editingOdemeId) {
            await db.collection('odemeVeTahsilatlar').doc(editingOdemeId).set(formData, { merge: true });
        } else {
            await db.collection('odemeVeTahsilatlar').add(formData);
        }
        resetOdemeForm();
        await renderOdemeListesi();
    } catch (error) {
        console.error("Ödeme/Tahsilat kaydedilirken hata:", error);
        alert("İşlem kaydedilirken bir hata oluştu.");
    }
}
function resetOdemeForm() {
    document.getElementById('odemeForm').reset();
    editingOdemeId = null;
    document.getElementById('odemeEditId').value = '';
    setEditingMode(document.getElementById('odemeFormBaslik'), document.getElementById('odemeKaydetBtn'), document.getElementById('odemeFormTemizleBtn'), null, 'Yeni Hareket Girişi');
}
async function renderOdemeListesi() {
    const listBody = document.getElementById('odemeListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('odemeVeTahsilatlar').where('sahipId', '==', currentUser.uid).orderBy('tarih', 'desc').limit(30).get();
        if(snapshot.empty){
            listBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">İşlem hareketi bulunmuyor.</td></tr>';
            return;
        }
        const cariIds = [...new Set(snapshot.docs.map(doc => doc.data().cariId))];
        const cariMap = new Map();
        if (cariIds.length > 0) {
            const cariSnapshot = await db.collection('cariler').where(firebase.firestore.FieldPath.documentId(), 'in', cariIds).get();
            cariSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));
        }

        let rows = '';
        snapshot.forEach(doc => {
            const islem = doc.data();
            const cariAdi = cariMap.get(islem.cariId) || 'Bilinmiyor';
            const islemTuruText = islem.islemTuru === 'odeme' ? 'Ödeme' : 'Tahsilat';
            rows += `<tr>
                <td>${formatDate(islem.tarih)}</td>
                <td>${cariAdi}</td>
                <td>${islemTuruText}</td>
                <td>${formatCurrency(islem.tutar)}</td>
                <td>${islem.aciklama}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editOdeme('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteOdeme('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;
    } catch (e) { console.error("Ödeme listesi yüklenirken hata:", e); }
}

async function deleteYemSatisi(id) {
    if (confirm("Bu yem satışını silmek istediğinizden emin misiniz? Bu işlem, satılan yemi stoğa geri ekleyecektir.")) {
        const currentUser = auth.currentUser;
        if (!currentUser) return;

        const satisRef = db.collection('yem_satislari').doc(id);
        try {
            const satisDoc = await satisRef.get();
            if (!satisDoc.exists) {
                throw "Silinecek satış kaydı bulunamadı.";
            }
            const satisData = satisDoc.data();
            const yemRef = db.collection('yemler').doc(satisData.yemId);

            const batch = db.batch();
            // Satış kaydını sil
            batch.delete(satisRef);
            // Stoğu geri ekle
            batch.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(satisData.miktar) });
            
            await batch.commit();
            alert("Yem satışı silindi ve stok güncellendi.");

            await renderYemSatisListesi();
            await renderYemStokListesi();

        } catch (error) {
            console.error("Yem satışı silinirken hata:", error);
            alert("Hata: " + error);
        }
    }
}

        
// --- SÜT ALIM FONKSİYONLARI ---
async function renderTopluSutGirisFormu() {
    const tarih = document.getElementById('topluGirisTarih').value;
    const kategori = document.getElementById('topluGirisKategori').value;
    const container = document.getElementById('topluSutGirisTablosuAlani');
    const yokMesaji = document.getElementById('topluGirisTedarikciYokMesaji');
    const currentUser = auth.currentUser;
    if (!currentUser || !tarih) {
        container.innerHTML = '<p style="text-align:center;">Lütfen bir tarih seçin.</p>';
        yokMesaji.style.display = 'none';
        return;
    }

    try {
        const sutAlimSnapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', currentUser.uid)
            .where('tarih', '==', tarih)
            .get();
        const kayitliCariIdleri = new Set(sutAlimSnapshot.docs.map(doc => doc.data().cariId));

        let query = db.collection('cariler')
            .where('sahipId', '==', currentUser.uid)
            .where('durum', '==', 'aktif')
            .where('cariTipi', 'in', ['sut_ve_yem', 'sadece_sut']);

        if (kategori) {
            query = query.where('kategori', '==', kategori);
        }
        
        // DEĞİŞİKLİK: Sıralama önce kategoriye, sonra ada göre yapıldı.
        const carilerSnapshot = await query.orderBy('kategori').orderBy('adiSoyadi').get();
        
        const gosterilecekCariler = carilerSnapshot.docs.filter(doc => !kayitliCariIdleri.has(doc.id));

        if (gosterilecekCariler.length === 0) {
            container.innerHTML = '';
            yokMesaji.textContent = 'Bu kriterlere uygun, süt girişi bekleyen cari bulunmuyor.';
            yokMesaji.style.display = 'block';
            return;
        }
        yokMesaji.style.display = 'none';
        
        let tableHTML = `<table><thead><tr><th>Cari Adı</th><th>Akşam (Lt)</th><th>Sabah (Lt)</th><th>Toplam (Lt)</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr></thead><tbody>`;

        const defaultFiyat = (globalSettings.defaultMilkPrice || 15.00).toFixed(2);
        gosterilecekCariler.forEach(doc => {
            const cari = { id: doc.id, ...doc.data() };
            const escapedCariAdi = cari.adiSoyadi.replace(/'/g, "\\'").replace(/"/g, '\\"');
            tableHTML += `<tr id="satir-${cari.id}">
                <td>${cari.adiSoyadi} (${cari.kategori || 'Belirtilmemiş'})</td>
                <td><input type="number" id="aksam-${cari.id}" class="sut-input" step="0.1" min="0" oninput="sutMiktarGuncelle('${cari.id}')"></td>
                <td><input type="number" id="sabah-${cari.id}" class="sut-input" step="0.1" min="0" oninput="sutMiktarGuncelle('${cari.id}')"></td>
                <td><span id="toplam-lt-${cari.id}">0.00</span></td>
                <td><input type="number" id="fiyat-${cari.id}" class="sut-input" step="0.01" min="0" value="${defaultFiyat}" oninput="sutMiktarGuncelle('${cari.id}')"></td>
                <td><span id="toplam-tutar-${cari.id}">0,00 ₺</span></td>
                <td class="dont-print"><button id="kaydet-btn-${cari.id}" class="btn btn-primary btn-sm" onclick="handleTopluSutKaydet('${cari.id}', '${escapedCariAdi}', '${tarih}')">Kaydet</button></td>
            </tr>`;
        });
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;

    } catch (error) {
        console.error("Süt girişi için cariler getirilirken hata:", error);
        if (error.code === 'failed-precondition') {
             container.innerHTML = '<p style="text-align:center; color: red;"><b>Veritabanı Hatası:</b> Bu sorgu için bir dizin (index) oluşturmanız gerekiyor.<br>Lütfen tarayıcı konsolundaki (F12) hatayı kontrol edin ve index oluşturma linkine tıklayın.</p>';
        } else {
             container.innerHTML = '<p style="text-align:center; color: red;">Tedarikçiler yüklenirken bir hata oluştu.</p>';
        }
    }
}
function sutMiktarGuncelle(cariId) {
    const sabah = parseFloat(document.getElementById(`sabah-${cariId}`).value) || 0;
    const aksam = parseFloat(document.getElementById(`aksam-${cariId}`).value) || 0;
    const fiyat = parseFloat(document.getElementById(`fiyat-${cariId}`).value) || 0;
    const toplamLt = sabah + aksam;
    const toplamTutar = toplamLt * fiyat;
    document.getElementById(`toplam-lt-${cariId}`).textContent = toplamLt.toFixed(2);
    document.getElementById(`toplam-tutar-${cariId}`).textContent = formatCurrency(toplamTutar);
}

async function handleTopluSutKaydet(cariId, cariAdi, tarih) {
    const sabahInput = document.getElementById(`sabah-${cariId}`);
    const aksamInput = document.getElementById(`aksam-${cariId}`);
    const satir = document.getElementById(`satir-${cariId}`);
    const currentUser = auth.currentUser;

    const sabahMiktar = parseFloat(sabahInput.value) || 0;
    const aksamMiktar = parseFloat(aksamInput.value) || 0;
    const toplamMiktar = sabahMiktar + aksamMiktar;

    if (toplamMiktar <= 0) { return; }

    const sutAlimData = {
        tarih: tarih, cariId: cariId, cariAdi: cariAdi,
        sabah: sabahMiktar, aksam: aksamMiktar, toplam: toplamMiktar,
        fiyat: globalSettings.defaultMilkPrice || 0,
        toplamTutar: toplamMiktar * (globalSettings.defaultMilkPrice || 0),
        sahipId: currentUser.uid
    };

    try {
        await db.collection("sut_alimlari").add(sutAlimData);
        if (satir) satir.style.display = 'none';
        await renderSutAlimGecmisi();
    } catch (error) {
        console.error("Süt alımı kaydedilirken hata:", error);
    }
}

function hesaplaToplamTutar(miktarInputId, fiyatInputId, toplamInputId) {
    const miktarInput = document.getElementById(miktarInputId);
    const fiyatInput = document.getElementById(fiyatInputId);
    const toplamInput = document.getElementById(toplamInputId);

    const miktar = parseFloat(miktarInput.value) || 0;
    const fiyat = parseFloat(fiyatInput.value) || 0;
    toplamInput.value = formatCurrency(miktar * fiyat);
}

async function renderSutAlimGecmisi() {
    const tarih = document.getElementById('topluGirisTarih').value;
    const gecmisTarihSpan = document.getElementById('gecmisTarihSpan');
    const header = document.getElementById('sutAlimGecmisiHeader');
    const body = document.getElementById('sutAlimGecmisiBody');
    const currentUser = auth.currentUser;
    if (!currentUser || !tarih) { header.innerHTML = ''; body.innerHTML = ''; return; }

    gecmisTarihSpan.textContent = formatDate(tarih);
    
    // DEĞİŞİKLİK: Başlık sırası güncellendi (Akşam, Sabah oldu)
    header.innerHTML = `<tr><th>Cari Adı</th><th>Akşam (Lt)</th><th>Sabah (Lt)</th><th>Toplam</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">İşlemler</th></tr>`;
    body.innerHTML = '<tr><td colspan="7">Yükleniyor...</td></tr>';

    try {
        const snapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', currentUser.uid).where('tarih', '==', tarih).orderBy('cariAdi').get();

        if (snapshot.empty) { body.innerHTML = '<tr><td colspan="7" style="text-align:center;">Bu tarih için süt alım kaydı bulunmuyor.</td></tr>'; return; }

        let bodyHTML = '';
        snapshot.forEach(doc => {
            const alim = doc.data();
            
            // DEĞİŞİKLİK: Veri sırası güncellendi (Akşam, Sabah oldu)
            bodyHTML += `<tr>
                <td>${alim.cariAdi}</td>
                <td>${alim.aksam.toFixed(2)}</td>
                <td>${alim.sabah.toFixed(2)}</td>
                <td><strong>${alim.toplam.toFixed(2)}</strong></td>
                <td>${formatCurrency(alim.fiyat)}</td>
                <td><strong>${formatCurrency(alim.toplamTutar)}</strong></td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editSutAlimi('${doc.id}')">Düzenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteSutAlimi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        body.innerHTML = bodyHTML;
    } catch (error) {
        console.error("Süt alım geçmişi yüklenirken hata:", error);
        body.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Geçmiş yüklenirken bir hata oluştu.</td></tr>';
    }
}

// --- RAPORLAMA FONKSİYONLARI ---

async function handleHesapOzetiRaporuOlustur() {
    const cariId = document.getElementById('raporCariSecimi').value;
    const ayYil = document.getElementById('raporTarihAraligi').value;
    const raporBaslik = document.getElementById('raporBaslik');
    const raporDetayAlani = document.getElementById('raporDetayAlani');
    const currentUser = auth.currentUser;

    if (!currentUser || !cariId || !ayYil) {
        alert("Lütfen cari ve ay seçimi yapın.");
        raporDetayAlani.innerHTML = '';
        raporBaslik.textContent = 'Lütfen Rapor Kriterlerini Seçin';
        return;
    }

    const cariAdi = document.getElementById('raporCariSecimi').options[document.getElementById('raporCariSecimi').selectedIndex].text;
    const [year, month] = ayYil.split('-');
    
    raporBaslik.textContent = `${cariAdi} - ${formatMonthYear(ayYil)} Hesap Özeti`;
    raporDetayAlani.innerHTML = '<p>Rapor oluşturuluyor, lütfen bekleyin...</p>';

    try {
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0);
        const oncekiAyEndDate = new Date(year, month - 1, 0);
        
        const startDateStr = startDate.toISOString().split('T')[0];
        const endDateStr = endDate.toISOString().split('T')[0];
        const devirTarihiStr = oncekiAyEndDate.toISOString().split('T')[0];
        
        // --- Veri Çekme İşlemleri ---
        const devirSutPromise = db.collection('sut_alimlari').where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId).where('tarih', '<=', devirTarihiStr).get();
        const devirYemPromise = db.collection('yem_satislari').where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId).where('tarih', '<=', devirTarihiStr).get();
        const devirOdemePromise = db.collection('odemeVeTahsilatlar').where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId).where('tarih', '<=', devirTarihiStr).get();
        
        const aySutPromise = db.collection('sut_alimlari').where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get();
        const ayYemPromise = db.collection('yem_satislari').where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get();
        const ayOdemePromise = db.collection('odemeVeTahsilatlar').where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get();

        const [devirSut, devirYem, devirOdeme, aySut, ayYem, ayOdeme] = await Promise.all([
            devirSutPromise, devirYemPromise, devirOdemePromise,
            aySutPromise, ayYemPromise, ayOdemePromise
        ]);

        // --- Hesaplamalar ---
        let devredenBakiye = 0;
        devirSut.forEach(doc => devredenBakiye += doc.data().toplamTutar);
        devirYem.forEach(doc => devredenBakiye -= doc.data().toplamTutar);
        devirOdeme.forEach(doc => { devredenBakiye += (doc.data().islemTuru === 'tahsilat' ? doc.data().tutar : -doc.data().tutar); });

        let toplamSutMiktari = 0, toplamSutDegeri = 0;
        aySut.forEach(doc => {
            toplamSutMiktari += doc.data().toplam;
            toplamSutDegeri += doc.data().toplamTutar;
        });
        const ortalamaSutFiyati = toplamSutMiktari > 0 ? (toplamSutDegeri / toplamSutMiktari) : 0;
        
        let toplamYemSatisTutari = 0;
        ayYem.forEach(doc => toplamYemSatisTutari += doc.data().toplamTutar);

        let toplamOdemeTutari = 0;
        let toplamTahsilatTutari = 0;
        ayOdeme.forEach(doc => {
            if (doc.data().islemTuru === 'odeme') toplamOdemeTutari += doc.data().tutar;
            else toplamTahsilatTutari += doc.data().tutar;
        });

        const donemSonuBakiye = devredenBakiye + toplamSutDegeri - toplamYemSatisTutari - toplamOdemeTutari + toplamTahsilatTutari;

        // --- HTML Oluşturma (Özet Formatında) ---
        let reportHTML = `
            <div class="report-block">
                <span>Önceki Aydan Devreden Bakiye: <strong>${formatCurrency(devredenBakiye)} (${devredenBakiye >= 0 ? 'Alacaklı' : 'Borçlu'})</strong></span>
            </div>
            
            <div class="report-block">
                <h5>Süt Alımları (Carinin Alacağı)</h5>
                <table class="summary-table">
                    <tr><th>Aylık Toplam Süt Miktarı</th><th>Ortalama Birim Fiyat</th><th>Aylık Toplam Değer</th></tr>
                    <tr><td>${toplamSutMiktari.toFixed(2)} Lt</td><td>${formatCurrency(ortalamaSutFiyati)}/Lt</td><td>${formatCurrency(toplamSutDegeri)}</td></tr>
                </table>
            </div>

            <div class="report-block">
                <h5>Yem Satışları (Carinin Borcu)</h5>
                <p class="block-total">Aylık Toplam Yem Satış Tutarı: <strong>${formatCurrency(toplamYemSatisTutari)}</strong></p>
            </div>

            <div class="report-block">
                <h5>Yapılan Ödemeler (Carinin Alacağını Azaltan)</h5>
                <p class="block-total">Aylık Toplam Ödeme Tutarı: <strong>${formatCurrency(toplamOdemeTutari)}</strong></p>
            </div>
            
            <div class="report-block">
                <h5>Yapılan Tahsilatlar (Carinin Borcunu Azaltan)</h5>
                <p class="block-total">Aylık Toplam Tahsilat Tutarı: <strong>${formatCurrency(toplamTahsilatTutari)}</strong></p>
            </div>

            <div class="report-block final-summary">
                <h5>DÖNEM SONU HESAPLAMASI</h5>
                <p><span>Önceki Aydan Devir:</span> <span>${formatCurrency(devredenBakiye)}</span></p>
                <p><span>+ Cari Ay Süt Alımları:</span> <span>${formatCurrency(toplamSutDegeri)}</span></p>
                <p><span>- Cari Ay Yem Satışları:</span> <span>${formatCurrency(toplamYemSatisTutari)}</span></p>
                <p><span>- Cari Ay Yapılan Ödemeler:</span> <span>${formatCurrency(toplamOdemeTutari)}</span></p>
                <p><span>+ Cari Ay Yapılan Tahsilatlar:</span> <span>${formatCurrency(toplamTahsilatTutari)}</span></p>
                <hr>
                <p><strong>DÖNEM SONU NET BAKİYE:</strong> <strong>${formatCurrency(donemSonuBakiye)} (${donemSonuBakiye >= 0 ? 'Cari Alacaklı' : 'Cari Borçlu'})</strong></p>
            </div>
        `;
        raporDetayAlani.innerHTML = reportHTML;

    } catch (error) {
        console.error("Hesap özeti raporu oluşturulurken hata:", error);
        raporDetayAlani.innerHTML = `<p style="color:red;">Rapor oluşturulurken bir hata oluştu.</p>`;
    }
}
        
        async function handleSutAlimRaporuOlustur(options) {
    const cariId = document.getElementById('sutRaporuTedarikciSecimi').value;
    const ayYil = document.getElementById('sutRaporuAySecimi').value;
    const kategori = document.getElementById('sutRaporuKategoriSecimi').value;
    const raporBaslik = document.getElementById('sutRaporuBaslik');
    const raporDetayAlani = document.getElementById('sutRaporuDetayAlani');
    const currentUser = auth.currentUser;

    if (!currentUser || !ayYil) {
        alert("Rapor oluşturmak için lütfen bir ay seçin.");
        return;
    }

    if (!options.tumu && !options.kategori && !cariId) {
        alert("Lütfen bir cari seçin veya 'Kategori' ya da 'Toplu' raporu seçin.");
        return;
    }
    if (options.kategori && !kategori) {
        alert("Kategori raporu için lütfen bir kategori seçin.");
        return;
    }
    
    raporDetayAlani.innerHTML = '<p>Rapor oluşturuluyor, lütfen bekleyin...</p>';

    const [year, month] = ayYil.split('-');
    const startDateStr = `${year}-${month}-01`;
    const endDate = new Date(year, month, 0);
    const endDateStr = endDate.toISOString().split('T')[0];

    try {
        let baseQuery = db.collection('sut_alimlari')
            .where('sahipId', '==', currentUser.uid)
            .where('tarih', '>=', startDateStr)
            .where('tarih', '<=', endDateStr);

        // --- TEK CARİ DETAY RAPORU ---
        if (!options.tumu && !options.kategori) {
            const cariAdi = document.getElementById('sutRaporuTedarikciSecimi').options[document.getElementById('sutRaporuTedarikciSecimi').selectedIndex].text;
            raporBaslik.textContent = `${formatMonthYear(ayYil)} - ${cariAdi} Aylık Süt Detayları`;
            const snapshot = await baseQuery.where('cariId', '==', cariId).orderBy('tarih').get();

            if (snapshot.empty) {
                raporDetayAlani.innerHTML = '<p>Seçili cari için bu ayda süt alım kaydı bulunamadı.</p>';
                return;
            }

            let tableHTML = `<table class="report-table"><thead><tr><th>Tarih</th><th>Sabah</th><th>Akşam</th><th>Toplam (Lt)</th><th>Fiyat</th><th>Tutar</th></tr></thead><tbody>`;
            let toplamSabah = 0, toplamAksam = 0, toplamLitre = 0, toplamTutar = 0;

            snapshot.forEach(doc => {
                const alim = doc.data();
                toplamSabah += alim.sabah;
                toplamAksam += alim.aksam;
                toplamLitre += alim.toplam;
                toplamTutar += alim.toplamTutar;
                tableHTML += `<tr><td>${formatDate(alim.tarih)}</td><td>${alim.sabah.toFixed(2)}</td><td>${alim.aksam.toFixed(2)}</td><td>${alim.toplam.toFixed(2)}</td><td>${formatCurrency(alim.fiyat)}</td><td>${formatCurrency(alim.toplamTutar)}</td></tr>`;
            });

            const ortalamaFiyat = toplamLitre > 0 ? (toplamTutar / toplamLitre) : 0;
            // DÜZELTME: Inline style yerine class verildi
            tableHTML += `</tbody><tfoot><tr class="report-totals-row">
                            <td>AYLIK TOPLAM</td>
                            <td>${toplamSabah.toFixed(2)}</td>
                            <td>${toplamAksam.toFixed(2)}</td>
                            <td>${toplamLitre.toFixed(2)}</td>
                            <td>${formatCurrency(ortalamaFiyat)}</td>
                            <td>${formatCurrency(toplamTutar)}</td>
                         </tr></tfoot></table>`;
            raporDetayAlani.innerHTML = tableHTML;
        } 
        // --- KATEGORİ VEYA TOPLU ÖZET RAPORU ---
        else {
            if(options.kategori) {
                raporBaslik.textContent = `${kategori} Kategorisi - ${formatMonthYear(ayYil)} Aylık Özet`;
            } else {
                raporBaslik.textContent = `Tüm Cariler - ${formatMonthYear(ayYil)} Aylık Özet`;
            }

            let alimlarSnapshot = await baseQuery.get();
            let alimlar = alimlarSnapshot.docs.map(doc => doc.data());

            if (options.kategori) {
                const cariSnapshot = await db.collection('cariler').where('sahipId', '==', currentUser.uid).where('kategori', '==', kategori).get();
                const cariIdsInKategori = cariSnapshot.docs.map(doc => doc.id);
                alimlar = alimlar.filter(alim => cariIdsInKategori.includes(alim.cariId));
            }
            
            if (alimlar.length === 0) {
                raporDetayAlani.innerHTML = '<p>Seçili kriterlere uygun süt alım kaydı bulunamadı.</p>';
                return;
            }

            const raporData = {};
            alimlar.forEach(alim => {
                if (!raporData[alim.cariId]) {
                    raporData[alim.cariId] = { cariAdi: alim.cariAdi, toplamSabah: 0, toplamAksam: 0, toplamLitre: 0, toplamTutar: 0 };
                }
                raporData[alim.cariId].toplamSabah += alim.sabah;
                raporData[alim.cariId].toplamAksam += alim.aksam;
                raporData[alim.cariId].toplamLitre += alim.toplam;
                raporData[alim.cariId].toplamTutar += alim.toplamTutar;
            });

            let tableHTML = `<table class="report-table"><thead><tr><th>Cari Adı</th><th>Toplam Sabah</th><th>Toplam Akşam</th><th>Toplam Litre</th><th>Ortalama Fiyat</th><th>Toplam Tutar</th></tr></thead><tbody>`;
            let genelToplamSabah = 0, genelToplamAksam = 0, genelToplamLitre = 0, genelToplamTutar = 0;

            Object.values(raporData).sort((a,b) => a.cariAdi.localeCompare(b.cariAdi)).forEach(data => {
                const ortalamaFiyat = data.toplamLitre > 0 ? (data.toplamTutar / data.toplamLitre) : 0;
                tableHTML += `<tr><td>${data.cariAdi}</td><td>${data.toplamSabah.toFixed(2)}</td><td>${data.toplamAksam.toFixed(2)}</td><td><strong>${data.toplamLitre.toFixed(2)}</strong></td><td>${formatCurrency(ortalamaFiyat)}</td><td><strong>${formatCurrency(data.toplamTutar)}</strong></td></tr>`;
                genelToplamSabah += data.toplamSabah;
                genelToplamAksam += data.toplamAksam;
                genelToplamLitre += data.toplamLitre;
                genelToplamTutar += data.toplamTutar;
            });
            
            const genelOrtalamaFiyat = genelToplamLitre > 0 ? (genelToplamTutar / genelToplamLitre) : 0;
            // DÜZELTME: Inline style yerine class verildi
            tableHTML += `</tbody><tfoot><tr class="report-totals-row">
                            <td>GENEL TOPLAM</td>
                            <td>${genelToplamSabah.toFixed(2)}</td>
                            <td>${genelToplamAksam.toFixed(2)}</td>
                            <td>${genelToplamLitre.toFixed(2)}</td>
                            <td>${formatCurrency(genelOrtalamaFiyat)}</td>
                            <td>${formatCurrency(genelToplamTutar)}</td>
                         </tr></tfoot></table>`;
            raporDetayAlani.innerHTML = tableHTML;
        }
    } catch (error) {
        console.error("Aylık Süt Raporu oluşturulurken hata:", error);
        raporDetayAlani.innerHTML = `<p style="color:red;">Rapor oluşturulurken bir hata oluştu. Lütfen konsolu (F12) kontrol edin, bir veritabanı dizini (index) gerekebilir.</p>`;
    }
}

        async function deleteYemAlisi(id) {
    if (confirm("Bu yem alışını silmek istediğinizden emin misiniz? Bu işlem, alınan yemi stoktan düşecektir.")) {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert("Lütfen giriş yapın.");
            return;
        }

        const alisRef = db.collection('yem_alimlari').doc(id);
        try {
            const alisDoc = await alisRef.get();
            if (!alisDoc.exists) {
                throw "Silinecek alış kaydı bulunamadı.";
            }
            const alisData = alisDoc.data();
            const yemRef = db.collection('yemler').doc(alisData.yemId);

            // Hem alış kaydını silmek hem de stoğu güncellemek için toplu işlem kullan
            const batch = db.batch();
            
            // 1. Alış kaydını sil
            batch.delete(alisRef);
            // 2. Stoğu azalt (alınan miktarın negatifini ekleyerek)
            batch.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(-alisData.miktar) });
            
            await batch.commit();
            alert("Yem alışı silindi ve stok güncellendi.");

            // Listeleri yenile
            await renderYemAlisHareketleri();
            await renderYemStokListesi();

        } catch (error) {
            console.error("Yem alışı silinirken hata:", error);
            alert("Hata: " + error);
        }
    }
}

        async function handleYemKarRaporuOlustur() {
    const ayYil = document.getElementById('yemRaporuAySecimi').value;
    const raporAlani = document.getElementById('yemRaporuAlani');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    if (!ayYil) { alert("Lütfen bir ay seçin."); raporAlani.innerHTML = ''; return; }

    const [year, month] = ayYil.split('-');
    const startDateStr = `${year}-${month}-01`;
    const endDate = new Date(year, month, 0);
    const endDateStr = endDate.toISOString().split('T')[0];

    raporAlani.innerHTML = '<p>Rapor oluşturuluyor, lütfen bekleyin...</p>';

    try {
        const satisSnapshot = await db.collection('yem_satislari').where('sahipId', '==', currentUser.uid).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get();
        if (satisSnapshot.empty) { raporAlani.innerHTML = '<h4>Bu ay için yem satışı bulunmuyor.</h4>'; return; }

        const yemlerSnapshot = await db.collection('yemler').where('sahipId', '==', currentUser.uid).get();
        const yemlerMap = new Map();
        yemlerSnapshot.forEach(doc => { yemlerMap.set(doc.id, doc.data()); });

        const raporVerisi = {};
        satisSnapshot.forEach(doc => {
            const satis = doc.data();
            const yemDetay = yemlerMap.get(satis.yemId);
            const yemAdi = yemDetay ? yemDetay.ad : 'Bilinmeyen Yem';
            const maliyet = yemDetay ? (yemDetay.alisFiyati || 0) : 0;
            if (!raporVerisi[satis.yemId]) {
                raporVerisi[satis.yemId] = {
                    ad: yemAdi, toplamMiktar: 0, toplamSatisTutar: 0,
                    toplamMaliyet: 0, toplamKar: 0
                };
            }
            const satisKar = (satis.satisFiyati - maliyet) * satis.miktar;
            raporVerisi[satis.yemId].toplamMiktar += satis.miktar;
            raporVerisi[satis.yemId].toplamSatisTutar += satis.toplamTutar;
            raporVerisi[satis.yemId].toplamMaliyet += maliyet * satis.miktar;
            raporVerisi[satis.yemId].toplamKar += satisKar;
        });

        let genelToplamSatis = 0, genelToplamMaliyet = 0, genelToplamKar = 0;
        let tableHTML = `<h3 class="print-only print-title">Aylık Yem Satış Kârlılık Raporu - ${formatMonthYear(ayYil)}</h3><table class="report-table"><thead><tr><th>Yem Adı</th><th>Satılan Miktar (Birim)</th><th>Toplam Satış Tutarı</th><th>Toplam Maliyet</th><th>Toplam Kâr</th></tr></thead><tbody>`;

        for (const yemId in raporVerisi) {
            const veri = raporVerisi[yemId];
            genelToplamSatis += veri.toplamSatisTutar;
            genelToplamMaliyet += veri.toplamMaliyet;
            genelToplamKar += veri.toplamKar;
            tableHTML += `<tr><td>${veri.ad}</td><td>${veri.toplamMiktar}</td><td>${formatCurrency(veri.toplamSatisTutar)}</td><td>${formatCurrency(veri.toplamMaliyet)}</td><td>${formatCurrency(veri.toplamKar)}</td></tr>`;
        }

        // DÜZELTME: Toplamlar satırına class="report-totals-row" eklendi.
        tableHTML += `</tbody><tfoot><tr class="report-totals-row">
                        <td><strong>GENEL TOPLAM</strong></td>
                        <td></td>
                        <td><strong>${formatCurrency(genelToplamSatis)}</strong></td>
                        <td><strong>${formatCurrency(genelToplamMaliyet)}</strong></td>
                        <td><strong>${formatCurrency(genelToplamKar)}</strong></td>
                    </tr></tfoot></table>`;
        raporAlani.innerHTML = tableHTML;

    } catch (error) {
        console.error("Yem kârlılık raporu oluşturulurken hata:", error);
        raporAlani.innerHTML = `<p style="color:red;">Rapor oluşturulurken bir hata oluştu. Firestore index'i gerekebilir.</p>`;
    }
}


function handleCariListeYazdir() {
    const kategoriFiltreElement = document.getElementById('cariKategoriFiltre');
    const seciliKategoriText = kategoriFiltreElement.options[kategoriFiltreElement.selectedIndex].text;
    document.getElementById('cariListeRaporBaslik').textContent = `${seciliKategoriText} Cari Listesi`;
    handleYazdir('cari-yonetimi');
}

function handleYazdir(sectionId) {
    const sectionToPrint = document.getElementById(sectionId);
    if (!sectionToPrint) return;
    let reportContent = sectionToPrint.querySelector('.printable-content, #cari-list-printable-area, #yemRaporuAlani');
    if(!reportContent && sectionId === 'cari-yonetimi') {
        reportContent = document.getElementById('cari-list-printable-area');
    }
    if (sectionId !== 'cari-yonetimi' && (!reportContent || reportContent.innerText.trim() === '' || reportContent.innerText.includes("Lütfen Rapor Kriterlerini Seçin"))) {
        alert("Lütfen önce bir rapor oluşturun.");
        return;
    }
    const bodyElement = document.body;
    bodyElement.classList.add('print-active');
    sectionToPrint.classList.add('print-section-active');
    const pageFormatClass = reportContent.classList.contains('format-a5') ? 'format-a5' : 'format-a4';
    bodyElement.classList.add(pageFormatClass);
    window.print();
}

window.onafterprint = () => {
    const bodyElement = document.body;
    bodyElement.classList.remove('print-active', 'format-a4', 'format-a5');
    document.querySelectorAll('.print-section-active').forEach(el => {
        el.classList.remove('print-section-active');
    });
};
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
// --- END: TAM VE DÜZELTİLMİŞ JAVASCRIPT KODU ---
</script>
</body>
</html>
