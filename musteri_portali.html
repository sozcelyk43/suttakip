<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Müşteri Süt Hareketleri</title>
  <meta name="theme-color" content="#2c3e50" />
<style>
    body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;line-height: 1.6;margin: 0;padding: 0;background-color: #f4f7f9;color: #333;}
    a.btn {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-decoration: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .main-content {padding: 20px;background-color: #ecf0f1;}
    .container {background-color: #fff;padding: 25px;border-radius: 8px;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);    }
    .module-header {background-color: #2c3e50;color: #fff;text-align: center;padding: 25px;border-radius: 8px;margin-bottom: 20px;}
    .module-header h2, .module-header h3 {margin: 0;}


.filter-buttons {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filter-row {
      display: grid;
      gap: 10px;
    }
    /* İsteğe göre: 2'li ve 3'lü grup için yan yana dizilim */
    .filter-row.two-items { grid-template-columns: 1fr 1fr; }
    .filter-row.three-items { grid-template-columns: 1fr 1fr 1fr; }

    .btn {display: inline-block;background-color: #3498db;color: #fff;padding: 12px;text-align: center;border: none;border-radius: 6px;
    	cursor: pointer;font-size: 1em;transition: background-color 0.2s;text-transform: uppercase; line-height: 1.2;}
    .btn:hover { background-color: #2980b9; }
    .btn-danger { background-color: #e74c3c; }
    .btn-danger:hover { background-color: #c0392b; }
    .btn-secondary {  color: #fff;  background-color: #95a5a6;}
    .btn-secondary:hover { background-color: #7f8c8d; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.90em; /* Font boyutu küçültüldü */
    }
    th, td {
      padding: 12px 10px; /* Padding ayarlandı */
      border: 1px solid #ecf0f1;
      text-align: center;
      word-break: break-word;
    }

    th {background-color: #f8f9fa;font-weight: 600;color: #495057;}
    tbody tr:nth-child(odd) {background-color: #ffffff;}
    tbody tr:nth-child(even) {background-color: #f2f6fa;}
    tbody tr:hover { background-color: #f0f8ff; }
    tfoot tr {background-color: #e9ecef;font-weight: bold;color: #2c3e50;}

    select.form-control {padding: 12px;border-radius: 6px;border: 1px solid #ccc;font-size: 1em;background-color: #fff;}
    #logoutUserEmail {font-size: 0.75em;text-transform: lowercase;color: #ecf0f1; margin-top: 2px;}

    @media (max-width: 768px) {
      .container {padding: 15px;border-radius: 0;}
      .main-content {padding: 0;}
      .module-header {border-radius: 0;}
      /* Responsive Table Adjustments */
      table {font-size: 0.82em;}
      th, td {padding: 10px 4px;}
    }
     
</style>
</head>
<body>
  <div class="main-content">
    <div class="module-header">
      <h2>Müşteri Süt Hareketleri</h2>
      <h3>Hoş Geldiniz, <span id="musteriAdi">...</span></h3>
    </div>
    <div class="container">

<div class="filter-buttons">
        <div class="filter-row two-items">
          <a href="sifre_degistir.html" class="btn btn-secondary">Şifre Değiştir</a>
          <a href="#" id="logoutButton" class="btn btn-danger">
            <div>Çıkış Yap</div>
            <div id="logoutUserEmail"></div>
          </a>
        </div>
        <div class="filter-row three-items">
          <select id="ayFiltresi" class="form-control"></select>
          <select id="yilFiltresi" class="form-control"></select>
          <button id="raporGosterBtn" class="btn">Göster</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Tarih</th>
            <th>Akşam (lt)</th>
            <th>Sabah (lt)</th>
            <th>Toplam (lt)</th>
          </tr>
        </thead>
        <tbody id="sutListesiBody">
          <tr><td colspan="4">Lütfen bir ay seçin.</td></tr>
        </tbody>
        <tfoot id="sutListesiFooter"></tfoot>
      </table>

    </div>
  </div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
        authDomain: "sut-takip-projem.firebaseapp.com",
        projectId: "sut-takip-projem",
        storageBucket: "sut-takip-projem.appspot.com",
        messagingSenderId: "512756958486",
        appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
        measurementId: "G-LYLT9WFVNK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DÜZELTME: Hem cariId hem de sahipId'yi saklamak için değişkenler eklendi.
    let userCariId = null;
    let userSahipId = null;

    auth.onAuthStateChanged(user => {
        if (user) {
            const userEmailDiv = document.getElementById('logoutUserEmail');
            if (userEmailDiv) {
                userEmailDiv.textContent = user.email;
            }

            db.collection('cariler').where('authUID', '==', user.uid).limit(1).get()
            .then(snapshot => {
                if (!snapshot.empty) {
                    const cariDoc = snapshot.docs[0];
                    const cariData = cariDoc.data();

                    // DÜZELTME: Hem cariId hem de sahipId alınıyor.
                    userCariId = cariDoc.id;
                    userSahipId = cariData.sahipId;
                    
                    document.getElementById('musteriAdi').textContent = cariData.adiSoyadi;

                    // DÜZELTME: sahipId kontrolü eklendi.
                    if (!userSahipId) {
                        alert("Müşteri profilinizde bir hata var (sahipId eksik). Lütfen işletme ile iletişime geçin.");
                        handleLogout();
                        return;
                    }
                    
                    const aySelect = document.getElementById('ayFiltresi');
                    const yilSelect = document.getElementById('yilFiltresi');
                    const gosterBtn = document.getElementById('raporGosterBtn');
                    const now = new Date();

                    const ayIsimleri = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
                    ayIsimleri.forEach((ay, index) => {
                        const option = document.createElement('option');
                        option.value = String(index + 1).padStart(2, '0');
                        option.textContent = ay;
                        aySelect.appendChild(option);
                    });
                    aySelect.value = String(now.getMonth() + 1).padStart(2, '0');

                    for (let yil = 2050; yil >= 2000; yil--) {
                        const option = document.createElement('option');
                        option.value = yil;
                        option.textContent = yil;
                        yilSelect.appendChild(option);
                    }
                    yilSelect.value = now.getFullYear();

                    gosterBtn.addEventListener('click', () => {
                        const secilenAy = aySelect.value;
                        const secilenYil = yilSelect.value;
                        if (secilenAy && secilenYil && userCariId) {
                            const ayYil = `${secilenYil}-${secilenAy}`;
                            fetchSutHareketleri(ayYil);
                        }
                    });

                    // Sayfa ilk yüklendiğinde verileri getir
                    gosterBtn.click();
                } else {
                    alert("Bu hesaba bağlı bir müşteri kartı bulunamadı.");
                    handleLogout();
                }
            })
            .catch(error => {
                console.error("Müşteri bilgileri alınırken hata oluştu:", error);
                alert("Müşteri bilgileri alınırken bir hata oluştu. Lütfen daha sonra tekrar deneyin.");
                handleLogout();
            });

        } else {
           window.location.href = 'login.html';
        }
    });

    const logoutButton = document.getElementById('logoutButton');
    logoutButton.addEventListener('click', (event) => {
        event.preventDefault();
        handleLogout();
    });


function formatSayi(sayi) {
        if (typeof sayi !== 'number') sayi = 0;
        if (sayi % 1 === 0) {
            return sayi.toString();
        } else {
            return sayi.toFixed(2).replace('.', ','); // Ondalık ayracı virgül yap
        }
    }

    function handleLogout() {
        auth.signOut().then(() => {
            window.location.href = 'login.html';
        }).catch(error => console.error("Çıkış hatası:", error));
    }

function formatPara(sayi) {
      return sayi.toLocaleString('tr-TR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }


async function fetchSutHareketleri(ayYil) {
    const [year, month] = ayYil.split('-');
    const startDate = `${year}-${month}-01`;

    // --- DÜZELTİLMİŞ TARİH HESAPLAMA BAŞLANGICI ---
    // Önceki hatalı satır:
    // const endDate = new Date(year, month, 0).toISOString().split('T')[0];

    // DÜZELTİLMİŞ, SAAT DİLİMİNDEN ETKİLENMEYEN GÜVENİLİR YÖNTEM:
    const endDateObj = new Date(parseInt(year, 10), parseInt(month, 10), 0);
    const endYear = endDateObj.getFullYear();
    const endMonth = String(endDateObj.getMonth() + 1).padStart(2, '0');
    const endDay = String(endDateObj.getDate()).padStart(2, '0');
    const endDate = `${endYear}-${endMonth}-${endDay}`;
    // --- DÜZELTİLMİŞ TARİH HESAPLAMA SONU ---
    
    const listBody = document.getElementById('sutListesiBody');
    const listFooter = document.getElementById('sutListesiFooter');
    listBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Veriler yükleniyor...</td></tr>`;
    listFooter.innerHTML = '';
    
    try {
        const snapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', userSahipId) 
            .where('cariId', '==', userCariId)
            .where('tarih', '>=', startDate)
            .where('tarih', '<=', endDate)
            .orderBy('tarih', 'asc') // Sıralamayı küçükten büyüğe değiştirdik, daha doğal bir görünüm için.
            .get();

        if (snapshot.empty) {
            listBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Bu dönem için süt kaydı bulunmuyor.</td></tr>`;
            return;
        }

        const gunlukVeri = new Map();

        snapshot.forEach(doc => {
            const alim = doc.data();
            const tarih = alim.tarih;
            
            if (!gunlukVeri.has(tarih)) {
                gunlukVeri.set(tarih, { aksam: 0, sabah: 0, toplam: 0 });
            }

            const gun = gunlukVeri.get(tarih);
            gun.aksam += alim.aksam || 0;
            gun.sabah += alim.sabah || 0;
            gun.toplam += alim.toplam || 0;
        });

const siraliGunler = Array.from(gunlukVeri.keys()).sort().reverse();

        let rows = '';
        let donemToplamAksam = 0;
        let donemToplamSabah = 0;
        let donemToplamLitre = 0;
	const dateOptions = {day: 'numeric',month: 'long',year: 'numeric'};
        siraliGunler.forEach(tarih => {
            const data = gunlukVeri.get(tarih);
            donemToplamAksam += data.aksam;
            donemToplamSabah += data.sabah;
            donemToplamLitre += data.toplam;

            rows += `
            <tr>
                <td>${new Date(tarih + 'T00:00:00').toLocaleDateString('tr-TR', dateOptions)}</td>
                <td>${formatSayi(data.aksam)}</td>
                <td>${formatSayi(data.sabah)}</td>
                <td><strong>${formatSayi(data.toplam)}</strong></td>
            </tr>
            `;
        });
        
        listBody.innerHTML = rows;
        const footerRow = `
            <tr class="report-totals-row">
                <td><strong>DÖNEM TOPLAMI</strong></td>
                <td><strong>${formatSayi(donemToplamAksam)}</strong></td>
                <td><strong>${formatSayi(donemToplamSabah)}</strong></td>
                <td><strong>${formatSayi(donemToplamLitre)}</strong></td>
            </tr>
        `;
        listFooter.innerHTML = footerRow;

    } catch (error) {
        console.error("Süt hareketleri alınırken hata: ", error);
        listBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Veriler yüklenemedi.</td></tr>`;
    }
}



</script>
</body>
</html>