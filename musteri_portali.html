<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Müşteri Portalı ve Hayvan Takibi</title>
    <meta name="theme-color" content="#2c3e50" />
<style>
    body {font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;line-height: 1.6;margin: 0;padding: 0;background-color: #f4f7f9;color: #333; font-size: 16px;}
    a.btn {display: flex;flex-direction: column;justify-content: center;align-items: center;text-decoration: none;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
    .main-content {padding: 20px;background-color: #ecf0f1;}
    .container {background-color: #fff;padding: 25px;border-radius: 8px;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);}
    .module-header {background-color: #2c3e50;color: #fff;text-align: center;padding: 25px;border-radius: 8px;margin-bottom: 20px;}
    .module-header h2, .module-header h3 {margin: 0;}
    .filter-buttons {display: grid;grid-template-columns: 1fr;gap: 10px;margin-bottom: 20px;}
    .filter-row {display: grid;gap: 10px;}
    .filter-row.two-items {grid-template-columns: 1fr 1fr;}
    .filter-row.three-items {grid-template-columns: 1fr 1fr 1fr;}
    .btn {display: inline-block;background-color: #3498db;color: #fff;padding: 12px;text-align: center;border: none;border-radius: 6px;cursor: pointer;font-size: 1em;transition: background-color 0.2s;text-transform: uppercase; line-height: 1.2;}
    .btn:hover {background-color: #2980b9;}
    .btn-danger {background-color: #e74c3c;}
    .btn-danger:hover {background-color: #c0392b;}
    .btn-secondary {color: #fff;background-color: #95a5a6;}
    .btn-secondary:hover {background-color: #7f8c8d;}
    .btn-success {background-color: #2ecc71;}
    .btn-success:hover {background-color: #27ae60;}
    .btn-small { padding: 5px 10px; font-size: 0.8em; text-transform: none;}
    .report-toggle-container {display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px;}
    .btn-toggle {flex: 1; background-color: #bdc3c7; color: #2c3e50; font-weight: normal;}
    .btn-toggle.active {background-color: #3498db; color: #fff; font-weight: bold;}
    table {width: 100%;border-collapse: collapse;margin-top: 10px;font-size: 1em;}
    th, td {padding: 12px 10px;border: 1px solid #ecf0f1;text-align: center;word-break: break-word; vertical-align: middle;}
    th {background-color: #f8f9fa;font-weight: 600;color: #495057;}
    tbody tr:nth-child(odd) {background-color: #ffffff;}
    tbody tr:nth-child(even) {background-color: #f2f6fa;}
    tbody tr:hover {background-color: #f0f8ff;}
    tfoot tr {background-color: #e9ecef;font-weight: bold;color: #2c3e50;}
    select.form-control, input.form-control, textarea.form-control {width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; background-color: #fff;}
    .form-group {margin-bottom: 15px;}
    .form-group label {display: block;margin-bottom: 5px;font-weight: bold; color: #34495e;}
    .form-section {border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-top: 20px; background-color: #fdfdfd;}
    .form-section h2 {border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; color: #2c3e50; margin-top: 0;}
    #logoutUserEmail {font-size: 0.75em;text-transform: lowercase;color: #ecf0f1; margin-top: 2px;}
    .alert-message {display: none; color: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: center; font-weight: bold;}
    .alert-message.error {background-color: #c0392b;}
    .alert-message.success {background-color: #27ae60;}
    .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);}
    .modal-content {background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px;}
    .close-button {color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;}

    @media (max-width: 768px) {
        .container {padding: 15px;border-radius: 0;}
        .main-content {padding: 0;}
        .module-header {border-radius: 0;}
        .filter-row.three-items {grid-template-columns: 1fr;}
        table {font-size: 0.85em;}
        th, td {padding: 8px 3px;}
    }
</style>
</head>
<body>
    <div class="main-content">
        <div class="module-header">
            <h2>Müşteri Portalı ve Hayvan Takip Sistemi</h2>
            <h3>Hoş Geldiniz, <span id="musteriAdi">...</span></h3>
        </div>
        <div class="container">
            <div id="portal-message" class="alert-message"></div>
            <div class="filter-buttons">
                <div class="filter-row two-items">
                    <a href="sifre_degistir.html" class="btn btn-secondary">Şifre Değiştir</a>
                    <a href="#" id="logoutButton" class="btn btn-danger"><div>Çıkış Yap</div><div id="logoutUserEmail"></div></a>
                </div>
                 <div class="filter-row three-items">
                    <button id="yeniHayvanBtn" class="btn btn-success">Yeni Hayvan Ekle</button>
                    <button id="yeniTohumlamaBtn" class="btn btn-success">Yeni Tohumlama Ekle</button>
                    <button id="yeniDogumBtn" class="btn btn-success">Yeni Doğum Ekle</button>
                </div>
                <hr>
                <div class="filter-row three-items">
                    <select id="ayFiltresi" class="form-control"></select>
                    <select id="yilFiltresi" class="form-control"></select>
                    <button id="raporGosterBtn" class="btn">Raporları Göster</button>
                </div>
            </div>

            <div id="raporlarSection" style="display:none;">
                <div id="reportToggleButtons" class="report-toggle-container">
                    <button id="hayvanTakipBtn" class="btn btn-toggle">Hayvan Takip Raporu</button>
                    <button id="sutRaporuBtn" class="btn btn-toggle">Süt Raporu</button>
                    <button id="yemRaporuBtn" class="btn btn-toggle">Yem Raporu</button>
                </div>
                <div id="hayvanTakipContainer" style="display: none;">
                    <table>
                        <thead><tr><th>Küpe No</th><th>Irk</th><th>Gebelik Durumu</th><th>Kalan Gün</th><th>İşlemler</th></tr></thead>
                        <tbody id="hayvanListesiBody"></tbody>
                    </table>
                </div>
                <div id="sutRaporuContainer" style="display:none;">
                    <table>
                        <thead><tr><th>Tarih</th><th>Akşam (lt)</th><th>Sabah (lt)</th><th>Toplam (lt)</th></tr></thead>
                        <tbody id="sutListesiBody"></tbody>
                        <tfoot id="sutListesiFooter"></tfoot>
                    </table>
                </div>
                <div id="yemRaporuContainer" style="display: none;"></div>
            </div>

            <section id="yeniHayvanSection" class="form-section" style="display: none;">
                <h2>Yeni Hayvan Kaydı Ekle</h2>
                <form id="yeniHayvanForm">
                    <div class="form-group">
                        <label for="yeni-hayvan-kupe">Küpe Numarası</label>
                        <input type="text" id="yeni-hayvan-kupe" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="yeni-hayvan-irk">Irk</label>
                        <input type="text" id="yeni-hayvan-irk" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="yeni-hayvan-dogum-tarihi">Doğum Tarihi</label>
                        <input type="date" id="yeni-hayvan-dogum-tarihi" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="yeni-hayvan-gebelik-durumu">Gebelik Durumu</label>
                        <select id="yeni-hayvan-gebelik-durumu" class="form-control">
                            <option value="Boş" selected>Boş</option>
                            <option value="Gebe">Gebe</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">Hayvanı Kaydet</button>
                </form>
            </section>

            <section id="yeniTohumlamaSection" class="form-section" style="display: none;">
                <h2>Yeni Tohumlama Kaydı Ekle</h2>
                <form id="yeniTohumlamaForm">
                    <div class="form-group"><label for="tohumlama-hayvan-kupe">Hayvan Küpe Numarası</label><select id="tohumlama-hayvan-kupe" class="form-control" required></select></div>
                    <div class="form-group"><label for="tohumlama-tarihi">Tohumlama Tarihi</label><input type="date" id="tohumlama-tarihi" class="form-control" required></div>
                    <div class="form-group"><label for="boga-sperma-kodu">Boğa / Sperma Kodu</label><input type="text" id="boga-sperma-kodu" class="form-control"></div>
                    <button type="submit" class="btn">Tohumlama Kaydını Oluştur</button>
                </form>
            </section>

            <section id="yeniDogumSection" class="form-section" style="display: none;">
                <h2>Yeni Doğum Kaydı Ekle</h2>
                <form id="yeniDogumForm">
                    <div class="form-group"><label for="anne-kupe">Anne Küpe Numarası</label><select id="anne-kupe" class="form-control" required></select></div>
                    <div class="form-group"><label for="dogum-tarihi">Doğum Tarihi</label><input type="date" id="dogum-tarihi" class="form-control" required></div>
                    <div class="form-group"><label for="yavru-kupe-1">Yeni Yavru Küpe No:</label><input type="text" id="yavru-kupe-1" class="form-control" required></div>
                     <div class="form-group"><label for="yavru-irk-1">Yavru Irkı:</label><input type="text" id="yavru-irk-1" class="form-control"></div>
                    <div class="form-group"><label for="yavru-cinsiyet-1">Cinsiyet:</label><select id="yavru-cinsiyet-1" class="form-control"><option value="Dişi">Dişi</option><option value="Erkek">Erkek</option></select></div>
                    <button type="submit" class="btn">Doğum Kaydını Tamamla</button>
                </form>
            </section>
        </div>
    </div>
    
    <div id="editHayvanModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Hayvan Bilgilerini Düzenle</h2>
            <form id="editHayvanForm">
                <input type="hidden" id="edit-hayvan-id">
                <div class="form-group">
                    <label for="edit-hayvan-kupe">Küpe Numarası</label>
                    <input type="text" id="edit-hayvan-kupe" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-hayvan-irk">Irk</label>
                    <input type="text" id="edit-hayvan-irk" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-hayvan-dogum-tarihi">Doğum Tarihi</label>
                    <input type="date" id="edit-hayvan-dogum-tarihi" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-hayvan-gebelik-durumu">Gebelik Durumu</label>
                    <select id="edit-hayvan-gebelik-durumu" class="form-control">
                        <option value="Boş">Boş</option>
                        <option value="Gebe">Gebe</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="edit-son-tohumlama-tarihi">Son Tohumlama Tarihi (Gebe ise)</label>
                    <input type="date" id="edit-son-tohumlama-tarihi" class="form-control">
                </div>
                <button type="submit" class="btn">Değişiklikleri Kaydet</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
        authDomain: "sut-takip-projem.firebaseapp.com",
        projectId: "sut-takip-projem",
        storageBucket: "sut-takip-projem.appspot.com",
        messagingSenderId: "512756958486",
        appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
        measurementId: "G-LYLT9WFVNK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let userCariId = null;
    let userSahipId = null;

    const portalMessage = document.getElementById('portal-message');
    const raporlarSection = document.getElementById('raporlarSection');
    const yeniHayvanSection = document.getElementById('yeniHayvanSection');
    const yeniTohumlamaSection = document.getElementById('yeniTohumlamaSection');
    const yeniDogumSection = document.getElementById('yeniDogumSection');
    const editModal = document.getElementById('editHayvanModal');

    auth.onAuthStateChanged(user => {
        if (user) {
            db.collection('cariler').where('authUID', '==', user.uid).limit(1).get().then(snapshot => {
                if (!snapshot.empty) {
                    const cariDoc = snapshot.docs[0];
                    userCariId = cariDoc.id;
                    userSahipId = cariDoc.data().sahipId;
                    document.getElementById('musteriAdi').textContent = cariDoc.data().adiSoyadi;
                    document.getElementById('logoutUserEmail').textContent = user.email;
                    if (!userSahipId) {
                        showPortalMessage("Müşteri profili hatası.", "error");
                        return;
                    }
                    setupPage();
                } else { showPortalMessage("Bu hesaba bağlı müşteri kartı bulunamadı.", "error"); }
            }).catch(error => showPortalMessage("Bilgiler yüklenirken hata oluştu.", "error"));
        } else { window.location.href = 'login.html'; }
    });
    
    function showPortalMessage(message, type = 'error') {
        portalMessage.textContent = message;
        portalMessage.className = `alert-message ${type}`;
        portalMessage.style.display = 'block';
        setTimeout(() => { portalMessage.style.display = 'none'; }, 4000);
    }

    function showSection(sectionToShow) {
        raporlarSection.style.display = 'none';
        yeniHayvanSection.style.display = 'none';
        yeniTohumlamaSection.style.display = 'none';
        yeniDogumSection.style.display = 'none';
        if(sectionToShow) sectionToShow.style.display = 'block';
    }
    
    function setupPage() {
        refreshAllData();
        document.getElementById('yeniHayvanBtn').addEventListener('click', () => showSection(yeniHayvanSection));
        document.getElementById('yeniTohumlamaBtn').addEventListener('click', () => showSection(yeniTohumlamaSection));
        document.getElementById('yeniDogumBtn').addEventListener('click', () => showSection(yeniDogumSection));
        document.getElementById('raporGosterBtn').addEventListener('click', () => {
             showSection(raporlarSection);
             const ayYil = `${document.getElementById('yilFiltresi').value}-${document.getElementById('ayFiltresi').value}`;
             fetchSutHareketleri(ayYil);
             fetchYemHareketleri(ayYil);
             fetchHayvanTakipVerileri();
             document.getElementById('hayvanTakipBtn').click();
        });
        const aySelect = document.getElementById('ayFiltresi');
        const yilSelect = document.getElementById('yilFiltresi');
        const now = new Date();
        const ayIsimleri = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
        ayIsimleri.forEach((ay, index) => { aySelect.add(new Option(ay, String(index + 1).padStart(2, '0'))); });
        aySelect.value = String(now.getMonth() + 1).padStart(2, '0');
        for (let yil = now.getFullYear() + 1; yil >= 2000; yil--) { yilSelect.add(new Option(yil, yil));}
        yilSelect.value = now.getFullYear();

        const toggleButtons = {
            hayvanTakipBtn: document.getElementById('hayvanTakipContainer'),
            sutRaporuBtn: document.getElementById('sutRaporuContainer'),
            yemRaporuBtn: document.getElementById('yemRaporuContainer')
        };
        Object.keys(toggleButtons).forEach(btnId => {
            document.getElementById(btnId).addEventListener('click', (e) => {
                Object.values(toggleButtons).forEach(c => c.style.display = 'none');
                Object.keys(toggleButtons).forEach(b => document.getElementById(b).classList.remove('active'));
                toggleButtons[btnId].style.display = 'block';
                e.target.classList.add('active');
            });
        });
        
        document.getElementById('yeniHayvanForm').addEventListener('submit', handleHayvanKayitSubmit);
        document.getElementById('yeniTohumlamaForm').addEventListener('submit', handleTohumlamaSubmit);
        document.getElementById('yeniDogumForm').addEventListener('submit', handleDogumSubmit);
        document.getElementById('editHayvanForm').addEventListener('submit', handleUpdateHayvan);
        document.getElementById('hayvanListesiBody').addEventListener('click', handleTableActions);
        document.querySelector('.close-button').addEventListener('click', () => editModal.style.display = "none");
        window.addEventListener('click', (event) => { if (event.target == editModal) { editModal.style.display = "none"; }});
    }

    async function refreshAllData(){
        await populateHayvanlarSelects();
        await fetchHayvanTakipVerileri();
    }

    async function populateHayvanlarSelects() { /* ... unchanged ... */ }
    async function handleHayvanKayitSubmit(event) {
        event.preventDefault();
        const kupeNo = document.getElementById('yeni-hayvan-kupe').value;
        const dogumTarihi = document.getElementById('yeni-hayvan-dogum-tarihi').value;
        if (!kupeNo || !dogumTarihi) { showPortalMessage("Küpe Numarası ve Doğum Tarihi zorunludur.", "error"); return; }
        
        try {
            await db.collection('hayvanlar').add({
                kupeNo: kupeNo,
                irk: document.getElementById('yeni-hayvan-irk').value,
                dogumTarihi: dogumTarihi,
                gebəlikDurumu: document.getElementById('yeni-hayvan-gebelik-durumu').value,
                sahipId: userSahipId,
                cariId: userCariId
            });
            showPortalMessage("Hayvan başarıyla kaydedildi.", "success");
            event.target.reset();
            refreshAllData();
        } catch (error) { showPortalMessage("Hayvan kaydedilirken hata oluştu.", "error");}
    }
    async function handleTohumlamaSubmit(event) { /* ... unchanged ... */ }
    async function handleDogumSubmit(event) { /* ... unchanged ... */ }

    function handleTableActions(event) {
        const target = event.target;
        const hayvanId = target.dataset.id;
        if (target.classList.contains('btn-delete')) {
            if (confirm("Bu hayvanı kalıcı olarak silmek istediğinizden emin misiniz?")) {
                db.collection('hayvanlar').doc(hayvanId).delete()
                  .then(() => { showPortalMessage("Hayvan silindi.", "success"); refreshAllData(); })
                  .catch(e => showPortalMessage("Silme işlemi başarısız.", "error"));
            }
        }
        if (target.classList.contains('btn-edit')) {
            db.collection('hayvanlar').doc(hayvanId).get().then(doc => {
                if (doc.exists) {
                    const hayvan = doc.data();
                    document.getElementById('edit-hayvan-id').value = doc.id;
                    document.getElementById('edit-hayvan-kupe').value = hayvan.kupeNo || '';
                    document.getElementById('edit-hayvan-irk').value = hayvan.irk || '';
                    document.getElementById('edit-hayvan-dogum-tarihi').value = hayvan.dogumTarihi || '';
                    document.getElementById('edit-hayvan-gebelik-durumu').value = hayvan.gebəlikDurumu || 'Boş';
                    document.getElementById('edit-son-tohumlama-tarihi').value = hayvan.sonTohumlamaTarihi || '';
                    editModal.style.display = 'block';
                }
            });
        }
    }

    async function handleUpdateHayvan(event) {
        event.preventDefault();
        const hayvanId = document.getElementById('edit-hayvan-id').value;
        const tohumlamaTarihi = document.getElementById('edit-son-tohumlama-tarihi').value;
        let tahminiDogumTarihi = null;
        if(tohumlamaTarihi){
            const tohumlamaDate = new Date(tohumlamaTarihi);
            const tahminiDogumDate = new Date(tohumlamaDate.setDate(tohumlamaDate.getDate() + 283));
            tahminiDogumTarihi = tahminiDogumDate.toISOString().split('T')[0];
        }

        const dataToUpdate = {
            kupeNo: document.getElementById('edit-hayvan-kupe').value,
            irk: document.getElementById('edit-hayvan-irk').value,
            dogumTarihi: document.getElementById('edit-hayvan-dogum-tarihi').value,
            gebəlikDurumu: document.getElementById('edit-hayvan-gebelik-durumu').value,
            sonTohumlamaTarihi: tohumlamaTarihi || firebase.firestore.FieldValue.delete(),
            tahminiDogumTarihi: tahminiDogumTarihi || firebase.firestore.FieldValue.delete()
        };

        try {
            await db.collection('hayvanlar').doc(hayvanId).update(dataToUpdate);
            showPortalMessage("Hayvan bilgileri güncellendi.", "success");
            editModal.style.display = "none";
            refreshAllData();
        } catch(error) { showPortalMessage("Güncelleme başarısız.", "error");}
    }

    document.getElementById('logoutButton').addEventListener('click', (e) => { e.preventDefault(); auth.signOut().then(() => window.location.href = 'login.html'); });
    function formatSayi(sayi) { if (typeof sayi !== 'number') sayi = 0; return (sayi % 1 === 0) ? sayi.toString() : sayi.toFixed(2).replace('.', ','); }
    
    // Unchanged functions are copied below for completeness
    async function populateHayvanlarSelects() {
        const tohumlamaSelect = document.getElementById('tohumlama-hayvan-kupe');
        const dogumSelect = document.getElementById('anne-kupe');
        tohumlamaSelect.innerHTML = '<option value="">Tohumlanacak hayvanı seçin...</option>';
        dogumSelect.innerHTML = '<option value="">Doğum yapan anneyi seçin...</option>';
        const snapshot = await db.collection('hayvanlar').where('sahipId', '==', userSahipId).where('cariId', '==', userCariId).orderBy('kupeNo').get();
        if (snapshot.empty) return;
        snapshot.forEach(doc => {
            const hayvan = doc.data();
            const option = new Option(`${hayvan.kupeNo} (${hayvan.gebəlikDurumu || 'Boş'})`, doc.id);
            if (hayvan.gebəlikDurumu !== 'Gebe') { tohumlamaSelect.add(option.cloneNode(true)); }
            if (hayvan.gebəlikDurumu === 'Gebe') { dogumSelect.add(option.cloneNode(true)); }
        });
    }
    async function handleTohumlamaSubmit(event) {
        event.preventDefault();
        const hayvanId = document.getElementById('tohumlama-hayvan-kupe').value;
        const tohumlamaTarihi = document.getElementById('tohumlama-tarihi').value;
        if (!hayvanId || !tohumlamaTarihi) { showPortalMessage("Hayvan ve tohumlama tarihini seçin.", "error"); return; }
        const tohumlamaDate = new Date(tohumlamaTarihi);
        const tahminiDogumDate = new Date(tohumlamaDate.setDate(tohumlamaDate.getDate() + 283));
        const tahminiDogumTarihi = tahminiDogumDate.toISOString().split('T')[0];
        try {
            await db.collection('hayvanlar').doc(hayvanId).update({ gebəlikDurumu: 'Gebe', sonTohumlamaTarihi: tohumlamaTarihi, tahminiDogumTarihi: tahminiDogumTarihi });
            showPortalMessage("Tohumlama başarıyla kaydedildi.", "success");
            event.target.reset();
            refreshAllData();
        } catch (error) { showPortalMessage("Kayıt sırasında bir hata oluştu.", "error"); }
    }
    async function handleDogumSubmit(event) {
        event.preventDefault();
        const anneId = document.getElementById('anne-kupe').value;
        const yavruKupeNo = document.getElementById('yavru-kupe-1').value;
        const dogumTarihi = document.getElementById('dogum-tarihi').value;
        if (!anneId || !yavruKupeNo || !dogumTarihi) { showPortalMessage("Anne, yavru küpe no ve doğum tarihini girin.", "error"); return; }
        try {
            const anneRef = db.collection('hayvanlar').doc(anneId);
            await db.runTransaction(async (t) => {
                await t.update(anneRef, { gebəlikDurumu: 'Boş', sonTohumlamaTarihi: firebase.firestore.FieldValue.delete(), tahminiDogumTarihi: firebase.firestore.FieldValue.delete() });
                const yeniYavruRef = db.collection('hayvanlar').doc();
                await t.set(yeniYavruRef, { kupeNo: yavruKupeNo, irk: document.getElementById('yavru-irk-1').value, cinsiyet: document.getElementById('yavru-cinsiyet-1').value, dogumTarihi: dogumTarihi, anneId: anneId, sahipId: userSahipId, cariId: userCariId, gebəlikDurumu: 'Boş'});
            });
            showPortalMessage("Doğum kaydı başarıyla oluşturuldu.", "success");
            event.target.reset();
            refreshAllData();
        } catch (error) { showPortalMessage("Kayıt sırasında bir hata oluştu: " + error, "error"); }
    }
    async function fetchHayvanTakipVerileri() {
        const listBody = document.getElementById('hayvanListesiBody');
        listBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Hayvan verileri yükleniyor...</td></tr>`;
        try {
            const snapshot = await db.collection('hayvanlar').where('sahipId', '==', userSahipId).where('cariId', '==', userCariId).orderBy('kupeNo', 'asc').get();
            if (snapshot.empty) { listBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Kayıtlı hayvan bulunmuyor.</td></tr>`; return; }
            let rows = '';
            snapshot.forEach(doc => {
                const hayvan = doc.data();
                let kalanGun = '-';
                if (hayvan.gebəlikDurumu === 'Gebe' && hayvan.tahminiDogumTarihi) {
                    const farkMs = new Date(hayvan.tahminiDogumTarihi) - new Date();
                    kalanGun = Math.ceil(farkMs / (1000 * 60 * 60 * 24));
                }
                rows += `<tr>
                    <td><strong>${hayvan.kupeNo}</strong></td><td>${hayvan.irk || '-'}</td>
                    <td>${hayvan.gebəlikDurumu || '-'}</td><td>${kalanGun}</td>
                    <td><button class="btn btn-secondary btn-small btn-edit" data-id="${doc.id}">Düzenle</button> <button class="btn btn-danger btn-small btn-delete" data-id="${doc.id}">Sil</button></td></tr>`;
            });
            listBody.innerHTML = rows;
        } catch (error) { listBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Veriler yüklenemedi.</td></tr>`; }
    }
    async function fetchSutHareketleri(ayYil) {
        const [year, month] = ayYil.split('-');
        const listBody = document.getElementById('sutListesiBody');
        listBody.innerHTML = `<tr><td colspan="4">Yükleniyor...</td></tr>`;
        document.getElementById('sutListesiFooter').innerHTML = '';
        try {
            const snapshot = await db.collection('sut_alimlari').where('sahipId', '==', userSahipId).where('cariId', '==', userCariId).where('tarih', '>=', `${year}-${month}-01`).where('tarih', '<=', `${year}-${month}-31`).orderBy('tarih', 'asc').get();
            if (snapshot.empty) { listBody.innerHTML = `<tr><td colspan="4">Bu dönem için kayıt yok.</td></tr>`; return; }
            const gunlukVeri = new Map();
            snapshot.forEach(doc => {
                const alim = doc.data();
                if (!gunlukVeri.has(alim.tarih)) { gunlukVeri.set(alim.tarih, { aksam: 0, sabah: 0, toplam: 0 }); }
                const gun = gunlukVeri.get(alim.tarih);
                gun.aksam += alim.aksam || 0; gun.sabah += alim.sabah || 0; gun.toplam += alim.toplam || 0;
            });
            let rows = '', donemToplamLitre = 0;
            Array.from(gunlukVeri.keys()).sort().forEach(tarih => {
                const data = gunlukVeri.get(tarih);
                donemToplamLitre += data.toplam;
                rows += `<tr><td>${new Date(tarih + 'T00:00:00').toLocaleDateString('tr-TR')}</td><td>${formatSayi(data.aksam)}</td><td>${formatSayi(data.sabah)}</td><td><strong>${formatSayi(data.toplam)}</strong></td></tr>`;
            });
            listBody.innerHTML = rows;
            document.getElementById('sutListesiFooter').innerHTML = `<tr><td colspan="3"><strong>DÖNEM TOPLAMI</strong></td><td><strong>${formatSayi(donemToplamLitre)}</strong></td></tr>`;
        } catch (error) { listBody.innerHTML = `<tr><td colspan="4" style="color:red;">Veriler yüklenemedi.</td></tr>`; }
    }
    async function fetchYemHareketleri(ayYil) {
        const yemRaporuContainer = document.getElementById('yemRaporuContainer');
        yemRaporuContainer.innerHTML = `<p>Yükleniyor...</p>`;
        const [year, month] = ayYil.split('-');
        try {
            const satisSnapshot = await db.collection('yem_satislari').where('sahipId', '==', userSahipId).where('cariId', '==', userCariId).where('tarih', '>=', `${year}-${month}-01`).where('tarih', '<=', `${year}-${month}-31`).get();
            if (satisSnapshot.empty) { yemRaporuContainer.innerHTML = `<p>Bu dönem için kayıt yok.</p>`; return; }
            const yemOzet = new Map();
            satisSnapshot.forEach(doc => {
                const satis = doc.data();
                yemOzet.set(satis.yemId, (yemOzet.get(satis.yemId) || 0) + satis.miktar);
            });
            if (yemOzet.size === 0) { yemRaporuContainer.innerHTML = `<p>Bu dönem için kayıt yok.</p>`; return; }
            const yemlerSnapshot = await db.collection('yemler').where(firebase.firestore.FieldPath.documentId(), 'in', Array.from(yemOzet.keys())).get();
            const yemIsimleri = new Map();
            yemlerSnapshot.forEach(doc => yemIsimleri.set(doc.id, doc.data().ad || 'Bilinmeyen'));
            let tableHTML = `<table><thead><tr><th>Yem Adı</th><th>Toplam Miktar</th></tr></thead><tbody>`;
            let toplamYemMiktari = 0;
            yemOzet.forEach((miktar, yemId) => {
                toplamYemMiktari += miktar;
                tableHTML += `<tr><td>${yemIsimleri.get(yemId)}</td><td><strong>${miktar}</strong></td></tr>`;
            });
            tableHTML += `</tbody><tfoot><tr><td><strong>TOPLAM</strong></td><td><strong>${toplamYemMiktari}</strong></td></tr></tfoot></table>`;
            yemRaporuContainer.innerHTML = tableHTML;
        } catch (error) { yemRaporuContainer.innerHTML = `<p style="color:red;">Yem verileri yüklenemedi.</p>`; }
    }
    </script>
</body>
</html>