<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÃ¼t Takip ProgramÄ± - Tam SÃ¼rÃ¼m</title>
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#2c3e50">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
</head>
<body>
    <div class="sidebar">
        <img src="logo.png" alt="Uygulama Logosu" class="sidebar-logo">
        <h1>SÃ¼t Takip ProgramÄ±</h1>
        <nav id="sidebarNav">
            <ul>
<li class="quick-entry-link">
            <a href="hizli-giris.html" target="_blank">âš¡ HÄ±zlÄ± SÃ¼t GiriÅŸi</a>
        </li>
                <li><a href="#dashboard" class="nav-link active">ğŸ“ Kontrol Paneli</a></li>
                <li><a href="#cari-yonetimi" class="nav-link">ğŸ‘¥ Cari YÃ¶netimi</a></li>
                <li><a href="#sut-alimi" class="nav-link">ğŸ¥› GÃ¼nlÃ¼k SÃ¼t AlÄ±mÄ±</a></li>
                <li><a href="#yem-stok-yonetimi" class="nav-link">ğŸ“¦ Yem Stok YÃ¶netimi</a></li>
                <li><a href="#yem-satisi" class="nav-link">ğŸŒ¾ Yem SatÄ±ÅŸÄ±</a></li>
                <li><a href="#tahsilat-ve-odemeler" class="nav-link">ğŸ’³ Tahsilat ve Ã–demeler</a></li>
                <li><a href="#hesap-ozeti" class="nav-link">ğŸ“Š Cari Hesap Ã–zeti</a></li>
                <li><a href="#sut-alim-raporu" class="nav-link">ğŸ—“ï¸ AylÄ±k SÃ¼t Raporu</a></li>
                <li><a href="#aylik-yem-raporu" class="nav-link">ğŸ“ˆ AylÄ±k Yem Raporu</a></li>
                <li><a href="#hareket-dokumu" class="nav-link">ğŸ“‹ Hareket DÃ¶kÃ¼mÃ¼</a></li>
<li><a href="#tank-yonetimi" class="nav-link">ğŸ’§ Tank YÃ¶netimi</a></li>
<li><a href="#tank-aktarim" class="nav-link">â†’ Tanktan AktarÄ±m</a></li>
                <li><a href="#ayarlar" class="nav-link">âš™ï¸ Ayarlar</a></li>
                <li class="logout-link">
                    <a href="#" id="logoutButton">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
                </li>
            </ul>
        </nav>
    </div>

    <div class="main-content">
<button id="menuToggleBtn" class="menu-toggle-btn dont-print">â˜°</button>

        <section id="dashboard" class="module-section">
            <div class="module-header"><h2>ğŸ“ Kontrol Paneli</h2></div>
            <div class="container">
                <h3>Genel Durum</h3>

                <div class="dashboard-grid">
                    <div class="stat-card"><h4>â˜€ï¸ BugÃ¼nkÃ¼ Sabah SÃ¼tÃ¼</h4><p><span id="dashSabahSut">0.00</span> Lt</p></div>
                    <div class="stat-card"><h4>ğŸŒ™ BugÃ¼nkÃ¼ AkÅŸam SÃ¼tÃ¼</h4><p><span id="dashAksamSut">0.00</span> Lt</p></div>
                    <div class="stat-card">
                        <h4>ğŸ“ˆ BugÃ¼nkÃ¼ Toplam SÃ¼t</h4>
                        <p><span id="dashToplamSut">0.00</span> Lt</p>
                        <small id="dunKarsilastirma">(DÃ¼ne gÃ¶re...)</small>
                    </div>
                    <div class="stat-card"><h4>ğŸ‘¥ Aktif MÃ¼ÅŸteri SayÄ±sÄ±</h4><p><span id="dashAktifMusteri">0</span></p></div>


		<div class="stat-card" id="bakiyeDurumKarti">
                        <h4>ğŸ’° Toplam Bakiye</h4>
                        <p><span id="dashToplamBakiye">0,00</span> â‚º</p>
                        <small id="bakiyeDurumUyarisi" style="font-weight: bold;"></small>
                    </div>

                   <div class="stat-card" style="border-left: 5px solid #3498db; grid-column: span 1;">
                        <h4>Bu Ayki SÃ¼t Ãœretimi</h4>
                        <p style="font-size: 2.2em; color: #2980b9;"><span id="dashBuAykiToplamSut">0</span> Lt</p>
                        <small>(<span id="aylikGunOrtalamasi">0</span> Lt/GÃ¼n Ort.)</small>
                    </div>

                    <div class="stat-card" style="border-left: 5px solid #1abc9c; grid-column: span 1;">
                        <h4>Ãœretimin Parasal DeÄŸeri</h4>
                        <p style="font-size: 2.2em; color: #16a085;"><span id="dashBuAykiSutDegeri">0,00</span> â‚º</p>
                        <small>(Potansiyel Gelir)</small>
                    </div>
                 


                </div>
                <div class="balance-bars">
                    <div class="balance-bar-item">
                        <div class="balance-bar-header">
                            <span>Toplam Alacak (MÃ¼ÅŸteri Borcu)</span>
                            <strong id="dashToplamAlacak">0,00 â‚º</strong>
                        </div>
                        <div class="progress-bar-container"><div id="alacakBar" class="progress-bar alacak" style="width: 0%;"></div></div>
                    </div>
                    <div class="balance-bar-item">
                        <div class="balance-bar-header">
                            <span>Toplam BorÃ§ (MÃ¼ÅŸteri AlacaÄŸÄ±)</span>
                            <strong id="dashToplamBorc">0,00 â‚º</strong>
                        </div>
                        <div class="progress-bar-container"><div id="borcBar" class="progress-bar borc" style="width: 0%;"></div></div>
                    </div>
                </div>

                <div class="charts-container-vertical">
                    <div class="chart-card">
                        <h3>BugÃ¼nkÃ¼ SÃ¼t AlÄ±m DaÄŸÄ±lÄ±mÄ± (Kategori BazlÄ±)</h3>
                        <div class="chart-wrapper">
                            <canvas id="gunlukSutGrafik"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
    <h3>AylÄ±k SÃ¼t DaÄŸÄ±lÄ±mÄ± (Kategori BazlÄ±)</h3>
    <div class="chart-filters">
        <input type="month" id="aylikChartAySecimi">
        <button id="aylikChartGosterBtn" class="btn btn-sm">GrafiÄŸi GÃ¶ster</button>
    </div>
    <div class="chart-wrapper">
        <canvas id="aylikSutGrafik"></canvas>
    </div>
</div>

<div class="tank-dashboard-container">
    <h3>Tank Doluluk OranlarÄ±</h3>
    <div id="dashboardTanklar">
        </div>
</div>

                </div>
            </div>
        </section>

       <section id="cari-yonetimi" class="module-section hidden-section">
    <div class="module-header"><h2>ğŸ‘¥ Cari YÃ¶netimi</h2></div>
    <div class="container">
        <div class="form-section">
            <h3><span id="cariFormBaslik">Yeni Cari Kart</span></h3>
            <form id="cariForm" action="#">
                <input type="hidden" id="cariEditId">
                <div class="form-grid">
                    <div class="form-group"><label for="cariKodu">Cari Kodu:</label><input type="text" id="cariKodu" placeholder="Ã–rn: C001"></div>
                    <div class="form-group"><label for="cariRotaSirasi">Rota SÄ±rasÄ±:</label><input type="number" id="cariRotaSirasi" placeholder="Ã–rn: 1, 2, 3..."></div>
                    <div class="form-group"><label for="cariAdiSoyadi">AdÄ± SoyadÄ± / Firma AdÄ±:</label><input type="text" id="cariAdiSoyadi" required></div>
                    <div class="form-group"><label for="cariKategori">Kategori/KÃ¶y:</label><select id="cariKategori" required><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="cariDurum">Durum:</label><select id="cariDurum"><option value="aktif">Aktif</option><option value="pasif">Pasif</option></select></div>
                    <div class="form-group"><label for="cariTipi">Cari Tipi:</label><select id="cariTipi"><option value="sut_ve_yem">SÃ¼t ve Yem</option><option value="sadece_sut">Sadece SÃ¼t</option><option value="sadece_yem">Sadece Yem</option></select></div>
                    <div class="form-group"><label for="cariAcilisBakiye">AÃ§Ä±lÄ±ÅŸ Bakiyesi:</label><input type="number" id="cariAcilisBakiye" placeholder="Ã–rn: 500" step="0.01"></div>
                    <div class="form-group"><label for="cariAcilisBakiyeTuru">Bakiye TÃ¼rÃ¼:</label><select id="cariAcilisBakiyeTuru"><option value="yok">Yok</option><option value="borc">Cari BorÃ§lu</option><option value="alacak">Cari AlacaklÄ±</option></select></div>
                    <div class="form-group"><label for="cariTelefon">Telefon:</label><input type="tel" id="cariTelefon"></div>
                    <div class="form-group"><label for="cariEposta">E-posta:</label><input type="email" id="cariEposta"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="cariAdres">Adres:</label><textarea id="cariAdres"></textarea></div>
                    <div class="form-group"><label for="cariBankaAdi">Banka AdÄ±:</label><input type="text" id="cariBankaAdi"></div>
                    <div class="form-group"><label for="cariIban">IBAN:</label><input type="text" id="cariIban"></div>
                    <div class="form-group"><label for="cariVergiDairesi">Vergi Dairesi:</label><input type="text" id="cariVergiDairesi"></div>
                    <div class="form-group"><label for="cariVergiNo">Vergi No / T.C.:</label><input type="text" id="cariVergiNo"></div>
                    <div class="form-group" style="grid-column: span 2;"><label for="cariNotlar">Ã–zel Notlar:</label><textarea id="cariNotlar"></textarea></div>
                </div>
                <button type="submit" class="btn btn-primary" id="cariKaydetBtn">Kaydet</button>
                <button type="button" class="btn" id="cariFormTemizleBtn" style="display:none;">Yeni KayÄ±t</button>
            </form>
        </div>

        <div id="cari-list-printable-area" class="printable-content format-a4">
            <h1 class="print-only print-title" style="text-align: center; display: none;">Cari Listesi</h1>
            <div class="list-section">

                <div class="form-grid dont-print" style="grid-template-columns: 1fr auto; align-items: end; gap: 10px; padding: 10px; border: 1px solid #ddd; margin-bottom: 15px; border-radius: 5px;">
                    <div class="form-group">
                        <label for="cariTarihFiltresi"><strong>Tarihsel Bakiye Raporu:</strong></label>
                        <input type="date" id="cariTarihFiltresi">
                        <small>Belirli bir tarih itibarÄ±yla bakiye durumunu gÃ¶rmek iÃ§in bir tarih seÃ§ip 'Raporla' butonuna basÄ±n. BoÅŸ bÄ±rakÄ±rsanÄ±z gÃ¼ncel durumu gÃ¶sterir.</small>
                    </div>
                    <button type="button" class="btn btn-primary" id="cariTarihselRaporBtn" style="height:45px;">Raporla</button>
                </div>

                <div id="cariRotaSirasiUyari" style="display: none;"></div>

                <div class="list-header-with-filter">
                    <h3>Cari Listesi (<span id="raporTarihEtiketi">GÃ¼ncel Durum</span>)</h3>
                    <div class="search-container"><input type="text" id="cariSearchInput" placeholder="Cari Ara..." aria-label="Cari Arama Kutusu"></div>
                    <select id="cariKategoriFiltre"><option value="">TÃ¼m Kategoriler</option></select>
                </div>

                <table>
                    <thead><tr><th>Kod</th><th>Ad/Firma</th><th>Kategori</th><th>Rota SÄ±rasÄ±</th><th>Durum</th><th>Telefon</th><th>BorÃ§</th><th>Alacak</th><th>Bakiye</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead>
                    <tbody id="cariListesiBody"></tbody>
                    <tfoot id="cariListesiFooter"></tfoot>
                </table>

            </div>
        </div>
        <button type="button" class="btn btn-secondary dont-print" id="cariListesiYazdirBtn" style="margin-top: 20px;">Listeyi YazdÄ±r</button>
    </div>
</section>
        <section id="sut-alimi" class="module-section hidden-section">
    <div class="module-header"><h2>ğŸ¥› GÃ¼nlÃ¼k SÃ¼t AlÄ±mÄ±</h2></div>
    <div class="container">
        <div class="form-section">
            <h3>GiriÅŸ Filtreleri</h3>
            <div class="form-grid" id="sutGirisFiltreler" style="grid-template-columns: 1fr 1fr;">
                <div class="form-group">
                    <label for="topluGirisTarih">GiriÅŸ Tarihi:</label>
                    <input type="date" id="topluGirisTarih" required>
                    <small style="display: block; margin-top: 5px; font-style: italic;">
                        Not: SeÃ§eceÄŸiniz tarih, **akÅŸam sÃ¼tÃ¼nÃ¼n** alÄ±ndÄ±ÄŸÄ± gÃ¼n olmalÄ±dÄ±r.
                    </small>
                </div>
                <div class="form-group">
                    <label for="topluGirisKategori">Kategori/KÃ¶y SeÃ§in:</label>
                    <select id="topluGirisKategori" required><option value="">TÃ¼m Kategoriler</option></select>
                </div>
            </div>
        </div>
        <div class="list-section">
            <h3>GÃ¼nlÃ¼k SÃ¼t GiriÅŸi</h3>
            <div id="topluSutGirisTablosuAlani"></div>
            <p id="topluGirisTedarikciYokMesaji" style="text-align:center; display:none;">Bu kriterlere uygun, sÃ¼t giriÅŸi bekleyen cari bulunmuyor.</p>
        </div>
        <hr style="margin: 40px 0;">
        <div id="sutDuzenleFormAlani" style="display:none; margin-bottom: 20px;">
            <h4>SÃ¼t AlÄ±mÄ±nÄ± DÃ¼zenle</h4>
            <form id="sutDuzenleForm" class="form-grid" style="grid-template-columns: 1fr 1fr 1fr auto auto;">
                <input type="hidden" id="sutDuzenleId">
                <div class="form-group"><label>AkÅŸam (Lt)</label><input type="number" id="sutDuzenleAksam" class="sut-input" step="0.1" min="0"></div>
                <div class="form-group"><label>Sabah (Lt)</label><input type="number" id="sutDuzenleSabah" class="sut-input" step="0.1" min="0"></div>
                <div class="form-group"><label>Fiyat</label><input type="number" id="sutDuzenleFiyat" class="sut-input" step="0.01" min="0"></div>
                <button type="submit" class="btn btn-primary" style="height: 45px; align-self: end;">GÃ¼ncelle</button>
                <button type="button" class="btn" style="height: 45px; align-self: end;" onclick="closeSutDuzenleForm()">Ä°ptal</button>
            </form>
                </div>
        <div class="list-section">
            <h3>SÃ¼t AlÄ±m GeÃ§miÅŸi (SeÃ§ili Tarih: <span id="gecmisTarihSpan"></span>)</h3>
            <table>
                <thead id="sutAlimGecmisiHeader"></thead>
                <tbody id="sutAlimGecmisiBody"></tbody>
                <tfoot id="sutAlimGecmisiFooter"></tfoot>
            </table>
        </div>
    </div>
</section>
        
        <section id="yem-stok-yonetimi" class="module-section hidden-section">
            <div class="module-header"><h2>ğŸ“¦ Yem Stok YÃ¶netimi</h2></div>
            <div class="container">
               <div class="form-section"><h3><span id="yemTanimFormBaslik">Yeni Yem TanÄ±mla</span></h3><form id="yemTanimForm" action="#"><input type="hidden" id="yemTanimEditId"><div class="form-grid">
                   <div class="form-group"><label for="yemKodu">Kod:</label><input type="text" id="yemKodu" required></div>
                   <div class="form-group"><label for="yemAdi">Ad:</label><input type="text" id="yemAdi" required></div>
                   <div class="form-group"><label for="yemKategorisi">Kategori:</label><select id="yemKategorisi"><option value="buyukbas">BÃ¼yÃ¼kbaÅŸ</option><option value="kucukbas">KÃ¼Ã§Ã¼kbaÅŸ</option></select></div>
                   <div class="form-group"><label for="yemBirimi">Birim:</label><input type="text" id="yemBirimi" value="Ã‡uval"></div>
                   <div class="form-group"><label for="yemAlisFiyati">AlÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemAlisFiyati" step="0.01"></div>
                   <div class="form-group"><label for="yemSatisFiyati">SatÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemSatisFiyati" step="0.01"></div>
               </div><button type="submit" class="btn btn-primary" id="yemTanimKaydetBtn">Kaydet</button><button type="button" class="btn" id="yemTanimFormTemizleBtn" style="display:none;">Yeni</button></form></div>
               <div class="list-section"><h3>TanÄ±mlÄ± Yemler & Stok</h3><table><thead><tr><th>Kod</th><th>Ad</th><th>Kategori</th><th>Birim</th><th>AlÄ±ÅŸ F.</th><th>SatÄ±ÅŸ F.</th><th>Stok</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="yemStokListesiBody"></tbody></table></div>
               <hr>
               <div class="form-section"><h3><span id="yemAlisFormBaslik">Yeni Yem AlÄ±ÅŸÄ±</span></h3><form id="yemAlisForm" action="#"><input type="hidden" id="yemAlisEditId"><div class="form-grid">
                   <div class="form-group"><label for="yemAlisTarih">Tarih:</label><input type="date" id="yemAlisTarih" required></div>
                   <div class="form-group"><label for="yemSecimiAlis">Yem:</label><select id="yemSecimiAlis" required><option value="">SeÃ§iniz...</option></select></div>
                   <div class="form-group"><label for="yemAlisMiktar">Miktar:</label><input type="number" id="yemAlisMiktar" step="1" required></div>
                   <div class="form-group"><label for="yemAlisTedarikci">Cari:</label><select id="yemAlisTedarikci"><option value="">SeÃ§iniz...</option></select></div>
                   <div class="form-group"><label for="yemAlisBirimFiyati">AlÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemAlisBirimFiyati" step="0.01" required></div>
                   <div class="form-group"><label for="yemAlisToplamTutar">Toplam Tutar:</label><input type="text" id="yemAlisToplamTutar" readonly></div>
               </div><button type="submit" class="btn btn-primary" id="yemAlisKaydetBtn">AlÄ±ÅŸÄ± Kaydet</button><button type="button" class="btn" id="yemAlisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
               <div class="list-section"><h3>Yem AlÄ±ÅŸ Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Yem</th><th>Miktar</th><th>Cari</th><th>AlÄ±ÅŸ F.</th><th>Tutar</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="yemAlisHareketListesiBody"></tbody></table></div>
            </div>
        </section>
        
        <section id="yem-satisi" class="module-section hidden-section">
             <div class="module-header"><h2>ğŸŒ¾ Yem SatÄ±ÅŸÄ±</h2></div>
             <div class="container">
                <div class="form-section"><h3><span id="yemSatisFormBaslik">Yeni Yem SatÄ±ÅŸÄ±</span></h3><form id="yemSatisForm" action="#"><input type="hidden" id="yemSatisEditId"><div class="form-grid">
                    <div class="form-group"><label for="yemSatisTarih">Tarih:</label><input type="date" id="yemSatisTarih" required></div>
                    <div class="form-group"><label for="yemAlanTedarikci">Alan Cari:</label><select id="yemAlanTedarikci" required><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="yemSecimiSatis">Yem:</label><select id="yemSecimiSatis" required><option value="">SeÃ§iniz...</option></select></div>
                    <div class="form-group"><label for="yemSatisMiktar">Miktar:</label><input type="number" id="yemSatisMiktar" step="1" required></div>
                    <div class="form-group"><label for="yemSatisBirimFiyati">SatÄ±ÅŸ FiyatÄ±:</label><input type="number" id="yemSatisBirimFiyati" step="0.01" required></div>
                    <div class="form-group"><label for="yemSatisToplamTutar">Toplam Tutar:</label><input type="text" id="yemSatisToplamTutar" readonly></div>
                </div><button type="submit" class="btn btn-primary" id="yemSatisKaydetBtn">SatÄ±ÅŸÄ± Kaydet</button><button type="button" class="btn" id="yemSatisFormTemizleBtn" style="display:none;">Yeni</button></form></div>
                <div class="list-section"><h3>Yem SatÄ±ÅŸ Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Alan Cari</th><th>Yem</th><th>Miktar</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="yemSatisListesiBody"></tbody></table></div>
             </div>
        </section>
        
        <section id="tahsilat-ve-odemeler" class="module-section hidden-section">
            <div class="module-header"><h2>ğŸ’³ Tahsilat ve Ã–demeler</h2></div>
            <div class="container">
                 <div class="form-section"><h3><span id="odemeFormBaslik">Yeni Hareket GiriÅŸi</span></h3>

		<form id="odemeForm" action="#">
    <input type="hidden" id="odemeEditId">
    <div class="form-grid">
        <div class="form-group"><label for="islemTuru">Ä°ÅŸlem TÃ¼rÃ¼:</label><select id="islemTuru" required><option value="odeme">Ã–deme</option><option value="tahsilat">Tahsilat</option></select></div>
        <div class="form-group"><label for="odemeTarih">Tarih:</label><input type="date" id="odemeTarih" required></div>
        <div class="form-group">
            <label for="odemeYapilanTedarikci">Cari:</label>
            <select id="odemeYapilanTedarikci" required><option value="">SeÃ§iniz...</option></select>
            <small id="cariBakiyeBilgisi" style="display: block; margin-top: 5px; font-weight: bold;"></small>
        </div>
        
        <div class="form-group">
            <label for="odemeTuru">Ã–deme TÃ¼rÃ¼:</label>
            <select id="odemeTuru" required>
                <option value="Kasa">Kasa</option>
                <option value="Banka">Banka</option>
                <option value="Pos">Pos</option>
                <option value="Ã‡ek">Ã‡ek</option>
                <option value="Senet">Senet</option>
            </select>
        </div>

        <div class="form-group"><label for="odemeTutari">Tutar (TL):</label><input type="number" id="odemeTutari" step="0.01" required></div>
        
        <div class="form-group" style="grid-column: span 3;"><label for="odemeAciklama">AÃ§Ä±klama:</label><textarea id="odemeAciklama" rows="2"></textarea></div>
    </div>
    <button type="submit" class="btn btn-primary" id="odemeKaydetBtn">Kaydet</button>
    <button type="button" class="btn" id="odemeFormTemizleBtn" style="display:none;">Yeni</button>
</form>

</div>
                 <div class="list-section"><h3>Ä°ÅŸlem Hareketleri</h3><table><thead><tr><th>Tarih</th><th>Cari</th><th>Ä°ÅŸlem TÃ¼rÃ¼</th><th>Tutar</th><th>AÃ§Ä±klama</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody id="odemeListesiBody"></tbody></table></div>
            </div>
        </section>
        
        <section id="hesap-ozeti" class="module-section hidden-section">
            <div class="module-header dont-print"><h2>ğŸ“Š Cari Hesap Ã–zeti</h2></div>
            <div class="container">
                <div class="report-section">
                    <h3 class="dont-print">Cari Hesap Ã–zeti</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: 1fr 1fr auto; align-items: end;">
                        <div class="form-group"><label for="raporCariSecimi">Cari SeÃ§in:</label><select id="raporCariSecimi"><option value="">SeÃ§iniz...</option></select></div>
                        <div class="form-group"><label for="raporTarihAraligi">Ay:</label><input type="month" id="raporTarihAraligi"></div>
                        <button type="button" class="btn btn-primary" id="raporOlusturBtn" style="height:45px;">Rapor OluÅŸtur</button>
                    </div> <hr class="dont-print">
                    <div id="report-content-to-print" class="printable-content format-a5">
                        <h1 class="print-only print-title">SÃ¼t Takip ProgramÄ± - Cari Hesap Ã–zeti</h1>
                        <h4 id="raporBaslik" style="text-align:center;">LÃ¼tfen Rapor Kriterlerini SeÃ§in</h4>
                        <div id="raporDetayAlani"></div>
                    </div>
                    <button type="button" class="btn btn-secondary dont-print" id="raporYazdirBtn" style="margin-top:20px;">Ã–zeti YazdÄ±r</button>
<button type="button" class="btn btn-danger dont-print" id="hesapOzetiPdfBtn" style="margin-top:20px;">PDF Ä°ndir</button>
<button type="button" class="btn btn-success dont-print" id="hesapOzetiXlsxBtn" style="margin-top:20px;">Excel Ä°ndir</button>
                </div>
            </div>
        </section>
        
        <section id="sut-alim-raporu" class="module-section hidden-section">
             <div class="module-header dont-print"><h2>ğŸ—“ï¸ AylÄ±k SÃ¼t Raporu</h2></div>
            <div class="container">
                 <div class="report-section">
                    <h3>DetaylÄ± SÃ¼t AlÄ±m Raporu</h3>
                    <div class="form-grid dont-print" style="grid-template-columns: repeat(4, 1fr); align-items: end; gap: 10px;">
                        <div class="form-group"><label for="sutRaporuTedarikciSecimi">Cari SeÃ§in:</label><select id="sutRaporuTedarikciSecimi"><option value="">SeÃ§iniz...</option></select></div>
                        <div class="form-group"><label for="sutRaporuAySecimi">Ay:</label><input type="month" id="sutRaporuAySecimi"></div>
                        <div class="form-group"><label for="sutRaporuKategoriSecimi">Kategori:</label><select id="sutRaporuKategoriSecimi"><option value="">TÃ¼mÃ¼</option></select></div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-primary" id="sutRaporuOlusturBtn" style="height:45px; flex-grow: 1;">GÃ¶ster</button>
                            <button type="button" class="btn btn-info" id="sutRaporuKategoriGosterBtn" style="height:45px; flex-grow: 1;">Kategori</button>
                            <button type="button" class="btn btn-info" id="sutRaporuTumunuGosterBtn" style="height:45px; flex-grow: 1;">Toplu</button>
                        </div>
                    </div> <hr class="dont-print">
                    <div id="sutAlimRaporAlani" class="printable-content format-a5">
                        <h1 class="print-only print-title">SÃ¼t Takip ProgramÄ± - AylÄ±k SÃ¼t AlÄ±m Detay Raporu</h1>
                        <h4 id="sutRaporuBaslik" style="text-align:center;">LÃ¼tfen Rapor Kriterlerini SeÃ§in</h4>
                        <div id="sutRaporuDetayAlani"></div>
                    </div>
                    <button type="button" class="btn btn-secondary dont-print" id="sutRaporuYazdirBtn" style="margin-top:20px;">Raporu YazdÄ±r</button>
<button type="button" class="btn btn-danger dont-print" id="sutRaporuPdfBtn" style="margin-top:20px;">PDF Ä°ndir</button>
<button type="button" class="btn btn-success dont-print" id="sutRaporuXlsxBtn" style="margin-top:20px;">Excel Ä°ndir</button>
                 </div>
            </div>
        </section>
        
       <section id="aylik-yem-raporu" class="module-section hidden-section">
    <div class="module-header"><h2>ğŸ“ˆ AylÄ±k Yem SatÄ±ÅŸ RaporlarÄ±</h2></div>
    <div class="container">
        <div class="report-section">
           <h3>Yem SatÄ±ÅŸ Analizi</h3>
           <div class="form-grid dont-print" style="grid-template-columns: 1fr auto auto; align-items: end; gap: 10px;">
               <div class="form-group">
                   <label for="yemRaporuAySecimi">Ay SeÃ§in:</label>
                   <input type="month" id="yemRaporuAySecimi">
               </div>
               <button type="button" class="btn btn-primary" id="yemDetayliSatisRaporuBtn" style="height:45px;">DetaylÄ± SatÄ±ÅŸ Raporu</button>
               <button type="button" class="btn btn-info" id="yemMusteriKarRaporuBtn" style="height:45px;">MÃ¼ÅŸteri KÃ¢rlÄ±lÄ±k Raporu</button>
           </div>
           <hr class="dont-print">
           <div id="yemRaporuAlani" class="printable-content format-a4" style="overflow-x: auto;">
               </div>
           <button type="button" class="btn btn-secondary dont-print" id="yemRaporuYazdirBtn" style="margin-top:20px;">Raporu YazdÄ±r</button>
           <button type="button" class="btn btn-danger dont-print" id="yemRaporuPdfBtn" style="margin-top:20px;">PDF Ä°ndir</button>
           <button type="button" class="btn btn-success dont-print" id="yemRaporuXlsxBtn" style="margin-top:20px;">Excel Ä°ndir</button>
        </div>
    </div>
</section>
        
        <section id="hareket-dokumu" class="module-section hidden-section">
            <div class="module-header"><h2>ğŸ“‹ Hareket DÃ¶kÃ¼mÃ¼</h2></div>
            <div class="container">
                <div class="list-section">
                    <h3>TÃ¼m Ä°ÅŸlem GeÃ§miÅŸi (En Yeni Ãœstte)</h3>
                    <table>
                        <thead><tr><th>Tarih</th><th>Cari AdÄ±</th><th>Ä°ÅŸlem TÃ¼rÃ¼</th><th>AÃ§Ä±klama</th><th>Tutar</th></tr></thead>
                        <tbody id="hareketDokumuBody"></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section id="ayarlar" class="module-section hidden-section">
    <div class="module-header"><h2>âš™ï¸ Ayarlar</h2></div>
    <div class="container">
        <div class="ayarlar-ust-bolum">
            <div class="settings-section">
                <h3>Genel Ayarlar</h3>
                <form id="ayarlarForm">
                    <div class="form-group">
                        <label for="varsayilanSutFiyati">VarsayÄ±lan SÃ¼t FiyatÄ± (TL/Lt):</label>
                        <input type="number" id="varsayilanSutFiyati" step="0.01">
                    </div>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </form>
            </div>
            <div class="settings-section">
                <h3>Åifre DeÄŸiÅŸtir</h3>
                <form id="sifreDegistirForm">
                    <div class="form-group"><label for="eskiSifre">Eski Åifre:</label><input type="password" id="eskiSifre" required></div>
                    <div class="form-group"><label for="yeniSifre">Yeni Åifre:</label><input type="password" id="yeniSifre" required></div>
                    <div class="form-group"><label for="yeniSifreTekrar">Yeni Åifre (Tekrar):</label><input type="password" id="yeniSifreTekrar" required></div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">GÃ¼ncelle</button>
                </form>
            </div>
        </div>
        <hr>
        <div class="settings-section">
            <h3>Cari Kategori/KÃ¶y TanÄ±mlarÄ±</h3>
            <form id="cariKategoriForm" action="#">
                <div class="form-grid" style="grid-template-columns: 1fr auto; align-items:end;">
                    <div class="form-group" style="margin-bottom:0;">
                        <label for="yeniCariKategoriAdi">Yeni Ad:</label>
                        <input type="text" id="yeniCariKategoriAdi" required>
                    </div>
                    <button type="submit" class="btn" style="height:45px;">Ekle</button>
                </div>
            </form>
            <div class="list-section" style="margin-top:20px;">
                <h4>TanÄ±mlÄ± Kategoriler/KÃ¶yler</h4>
                <ul id="cariKategoriListesiUl"></ul>
            </div>
        </div>
        <hr class="dont-calisan">
        <div class="settings-section dont-calisan">
            <h3>KullanÄ±cÄ± YÃ¶netimi</h3>
            <form id="kullaniciForm">
                <input type="hidden" id="kullaniciEditId">
                <div class="form-grid">
                    <div class="form-group"><label for="kullaniciAdi">KullanÄ±cÄ± E-posta:</label><input type="email" id="kullaniciAdi" required></div>
                    <div class="form-group"><label for="kullaniciSifre">Åifre:</label><input type="password" id="kullaniciSifre" required></div>
                </div>
                <button type="submit" class="btn" id="kullaniciKaydetBtn">Ã‡alÄ±ÅŸan Ekle</button>
            </form>
            <div class="list-section">
                <h4>KullanÄ±cÄ± Listesi</h4>
                <table>
                    <thead><tr><th>KullanÄ±cÄ± AdÄ±</th><th>Rol</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead>
                    <tbody id="kullaniciListesiBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<section id="tank-yonetimi" class="module-section hidden-section">
    <div class="module-header"><h2>ğŸ’§ Tank YÃ¶netimi</h2></div>
    <div class="container">
        <div class="form-section">
            <h3><span id="tankFormBaslik">Yeni Tank TanÄ±mla</span></h3>
            <form id="tankForm">
                <input type="hidden" id="tankEditId">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr auto;">
                    <div class="form-group">
                        <label for="tankAdi">Tank AdÄ±:</label>
                        <input type="text" id="tankAdi" required placeholder="Ã–rn: Ana Tank 1">
                    </div>
                    <div class="form-group">
                        <label for="tankKapasite">Kapasite (Litre):</label>
                        <input type="number" id="tankKapasite" required placeholder="Ã–rn: 5000">
                    </div>
                    <div style="align-self: end;">
                        <button type="submit" class="btn btn-primary" id="tankKaydetBtn">Kaydet</button>
                        <button type="button" class="btn" id="tankFormTemizleBtn" style="display:none;">Yeni</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="list-section">
            <h3>TanÄ±mlÄ± Tanklar</h3>
            <table>
                <thead>
                    <tr>
                        <th>Tank AdÄ±</th>
                        <th>Kapasite</th>
                        <th>Mevcut Miktar</th>
                        <th>Doluluk OranÄ±</th>
                        <th class="dont-print">Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody id="tankListesiBody"></tbody>
            </table>
        </div>
    </div>
</section>

<section id="tank-aktarim" class="module-section hidden-section">
    <div class="module-header"><h2>â†’ Tanktan Cari'ye AktarÄ±m</h2></div>
    <div class="container">
        <div class="form-section">
            <h3>Tanktan SÃ¼t AktarÄ±mÄ±</h3>
            <form id="tankAktarimForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="aktarimKaynakTank">Kaynak Tank:</label>
                        <select id="aktarimKaynakTank" required></select>
                        <small>Mevcut Miktar: <strong id="kaynakTankMiktar">0.00 Lt</strong></small>
                    </div>
                    <div class="form-group">
                        <label for="aktarimHedefCari">Hedef Cari (SÃ¼tÃ¼n SatÄ±ldÄ±ÄŸÄ± Firma):</label>
                        <select id="aktarimHedefCari" required></select>
                    </div>
                    <div class="form-group">
                        <label for="aktarimMiktar">AktarÄ±lacak Miktar (Litre):</label>
                        <input type="number" id="aktarimMiktar" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="aktarimFiyat">Birim Fiyat (TL/Litre):</label>
                        <input type="number" id="aktarimFiyat" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="aktarimTarih">Ä°ÅŸlem Tarihi:</label>
                        <input type="date" id="aktarimTarih" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">AktarÄ±mÄ± Tamamla</button>
            </form>
        </div>
    </div>
</section>
        </section>

    </div> 
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // TÃœM JAVASCRIPT KODU BURAYA GELECEK

const firebaseConfig = {
    apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
    authDomain: "sut-takip-projem.firebaseapp.com",
    projectId: "sut-takip-projem",
    storageBucket: "sut-takip-projem.appspot.com",
    messagingSenderId: "512756958486",
    appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
    measurementId: "G-LYLT9WFVNK"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUserRole = '';
let currentUserId = '';
let globalSettings = { defaultMilkPrice: 15.50 };
let editingCariId = null, editingYemTanimId = null, editingYemAlisId = null, editingYemSatisId = null, editingOdemeId = null;
let gunlukSutunChartInstance = null;
let aylikSutunChartInstance = null;

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(err => console.error('Service Worker registration failed: ', err));
    });
}

Chart.register(ChartDataLabels);

auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUserId = user.uid;
        try {
            const userDoc = await db.collection('kullanicilar').doc(currentUserId).get();
            if (userDoc.exists) {
                currentUserRole = userDoc.data().rol;
                initializeApp();
            } else {
                alert("GiriÅŸ baÅŸarÄ±lÄ± ancak kullanÄ±cÄ± rol bilgisi veritabanÄ±nda bulunamadÄ±. LÃ¼tfen yÃ¶neticinizle iletiÅŸime geÃ§in.");
                handleLogout();
            }
        } catch (error) {
            console.error("KullanÄ±cÄ± rolÃ¼ alÄ±nÄ±rken kritik bir hata oluÅŸtu.", error);
            alert("VeritabanÄ±na eriÅŸirken bir sorun oluÅŸtu. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ±, Firebase proje ayarlarÄ±nÄ±zÄ± ve gÃ¼venlik kurallarÄ±nÄ±zÄ± kontrol edin.");
            handleLogout();
        }
    } else {
        window.location.href = 'login.html';
    }
});

// --- LÃœTFEN MEVCUT initializeApp FONKSÄ°YONUNUZU BU KOD Ä°LE TAMAMEN DEÄÄ°ÅTÄ°RÄ°N ---
function initializeApp() {
    // Element tanÄ±mlamalarÄ±
    const sidebarNav = document.getElementById('sidebarNav');
    const moduleSections = document.querySelectorAll('.main-content .module-section');
    const logoutButton = document.getElementById('logoutButton');
    const cariForm = document.getElementById('cariForm');
    const cariFormTemizleBtn = document.getElementById('cariFormTemizleBtn');
    const yemTanimForm = document.getElementById('yemTanimForm');
    const yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
    const yemAlisForm = document.getElementById('yemAlisForm');
    const yemAlisFormTemizleBtn = document.getElementById('yemAlisFormTemizleBtn');
    const yemSatisForm = document.getElementById('yemSatisForm');
    const yemSatisFormTemizleBtn = document.getElementById('yemSatisFormTemizleBtn');
    const odemeForm = document.getElementById('odemeForm');
    const odemeFormTemizleBtn = document.getElementById('odemeFormTemizleBtn');
    const ayarlarForm = document.getElementById('ayarlarForm');
    const cariKategoriForm = document.getElementById('cariKategoriForm');
    const kullaniciForm = document.getElementById('kullaniciForm');
    const sifreDegistirForm = document.getElementById('sifreDegistirForm');
    const cariSearchInput = document.getElementById('cariSearchInput');
    const cariKategoriFiltre = document.getElementById('cariKategoriFiltre');
    const cariListesiYazdirBtn = document.getElementById('cariListesiYazdirBtn');
    const topluGirisTarihInput = document.getElementById('topluGirisTarih');
    const topluGirisKategoriSelect = document.getElementById('topluGirisKategori');
    const sutDuzenleForm = document.getElementById('sutDuzenleForm');
    const odemeCariSecimi = document.getElementById('odemeYapilanTedarikci');
if(odemeCariSecimi) {
    odemeCariSecimi.addEventListener('change', async (event) => {
        const cariId = event.target.value;
        const bakiyeBilgiAlani = document.getElementById('cariBakiyeBilgisi');
        
        if (!cariId) {
            bakiyeBilgiAlani.textContent = '';
            return;
        }

        try {
            bakiyeBilgiAlani.textContent = 'Bakiye hesaplanÄ±yor...';
            const bakiyeDetay = await calculateCariBakiyeDetayli(cariId);
            const bakiye = bakiyeDetay.bakiye;
            
            if (bakiye < 0) {
                bakiyeBilgiAlani.textContent = `Bakiye: ${formatCurrency(bakiye)} (Cari BorÃ§lu)`;
                bakiyeBilgiAlani.style.color = 'red';
            } else {
                bakiyeBilgiAlani.textContent = `Bakiye: ${formatCurrency(bakiye)} (Cari AlacaklÄ±)`;
                bakiyeBilgiAlani.style.color = 'green';
            }
        } catch (error) {
            console.error("Bakiye bilgisi alÄ±nÄ±rken hata:", error);
            bakiyeBilgiAlani.textContent = 'Bakiye alÄ±namadÄ±.';
            bakiyeBilgiAlani.style.color = 'black';
        }
    });
}
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const sidebar = document.querySelector('.sidebar');
    // GÃœNCELLEME: Yeni tank yÃ¶netimi elemanlarÄ± eklendi
    const tankForm = document.getElementById('tankForm');
    const tankFormTemizleBtn = document.getElementById('tankFormTemizleBtn');
    const tankAktarimForm = document.getElementById('tankAktarimForm');
    const aktarimKaynakTankSelect = document.getElementById('aktarimKaynakTank');

    // MenÃ¼ toggle butonu
    if (menuToggleBtn && sidebar) {
        menuToggleBtn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
        sidebar.addEventListener('click', (event) => {
            if (window.innerWidth <= 1024 && event.target.closest('a.nav-link')) {
                sidebar.classList.add('collapsed');
            }
        });
    }

    // Rol izinlerini ve baÅŸlangÄ±Ã§ verilerini yÃ¼kle
    applyRolePermissions();
    loadAndRenderAllData();
    
    // Sol menÃ¼ navigasyon
    sidebarNav.addEventListener('click', function(event) {
        const link = event.target.closest('a.nav-link');
        if (!link || link.id === 'logoutButton') return;
        event.preventDefault();
        
        sidebarNav.querySelectorAll('a.nav-link').forEach(lnk => lnk.classList.remove('active'));
        link.classList.add('active');
        
        const targetId = link.getAttribute('href').substring(1);
        moduleSections.forEach(section => { section.style.display = 'none'; });
        const activeSection = document.getElementById(targetId);
        if(activeSection) activeSection.style.display = 'block';
        
        // Sekme bazlÄ± veri yÃ¼kleme ve hazÄ±rlÄ±k iÅŸlemleri
        if (targetId === 'dashboard') { updateDashboardStats(); }
        if (targetId === 'cari-yonetimi') { populateCariKategoriFiltre(); renderCariListesi(); populateCariKategoriSelect(document.getElementById('cariKategori')); }
        if (targetId === 'sut-alimi') { if(topluGirisTarihInput) topluGirisTarihInput.value = getTodayForInput(); populateCariKategoriSelect(topluGirisKategori); renderTopluSutGirisFormu(); renderSutAlimGecmisi(); }
        if (targetId === 'yem-stok-yonetimi') { populateCariSelect(document.getElementById('yemAlisTedarikci')); populateYemSelect(document.getElementById('yemSecimiAlis')); renderYemAlisHareketleri(); renderYemStokListesi(); }
        if (targetId === 'yem-satisi') { populateCariSelect(document.getElementById('yemAlanTedarikci')); populateYemSelect(document.getElementById('yemSecimiSatis')); renderYemSatisListesi(); }
        if (targetId === 'tahsilat-ve-odemeler') { populateCariSelect(document.getElementById('odemeYapilanTedarikci')); renderOdemeListesi(); }
        if (targetId === 'hesap-ozeti'){ populateCariSelect(document.getElementById('raporCariSecimi')); if(!document.getElementById('raporTarihAraligi').value) document.getElementById('raporTarihAraligi').value = getMonthYearForInput(); }
        if (targetId === 'sut-alim-raporu'){ populateCariSelect(document.getElementById('sutRaporuTedarikciSecimi')); populateCariKategoriSelect(document.getElementById('sutRaporuKategoriSecimi'), "TÃ¼mÃ¼"); if(!document.getElementById('sutRaporuAySecimi').value) document.getElementById('sutRaporuAySecimi').value = getMonthYearForInput(); }
        if (targetId === 'aylik-yem-raporu'){ if(!document.getElementById('yemRaporuAySecimi').value) document.getElementById('yemRaporuAySecimi').value = getMonthYearForInput(); }
        if (targetId === 'hareket-dokumu') { renderHareketDokumu(); }
        if (targetId === 'ayarlar') { populateCariKategoriSelect(document.getElementById('cariKategori')); renderCariKategoriListesi(); getSettings(); renderKullaniciListesi(); }
        // GÃœNCELLEME: Yeni tank sekmeleri iÃ§in veri yÃ¼kleme
        if (targetId === 'tank-yonetimi') { renderTankListesi(); }
        if (targetId === 'tank-aktarim') { 
            populateTankSelect(document.getElementById('aktarimKaynakTank'));
            populateCariSelect(document.getElementById('aktarimHedefCari'));
            if(document.getElementById('aktarimTarih')) document.getElementById('aktarimTarih').value = getTodayForInput();
        }
    });
    
    // Ã‡Ä±kÄ±ÅŸ ve Form GÃ¶nderme OlaylarÄ±
    logoutButton.addEventListener('click', handleLogout);
    cariForm.addEventListener('submit', handleCariKaydet);
    yemTanimForm.addEventListener('submit', handleYemTanimKaydet);
    yemAlisForm.addEventListener('submit', handleYemAlisKaydet);
    yemSatisForm.addEventListener('submit', handleYemSatisKaydet);
    odemeForm.addEventListener('submit', handleOdemeKaydet);
    ayarlarForm.addEventListener('submit', handleAyarlarKaydet);
    cariKategoriForm.addEventListener('submit', handleCariKategoriEkle);
    if(kullaniciForm) kullaniciForm.addEventListener('submit', handleKullaniciKaydet);
    sifreDegistirForm.addEventListener('submit', handleSifreDegistir);
    if(sutDuzenleForm) sutDuzenleForm.addEventListener('submit', handleSutAlimiGuncelle);
    // GÃœNCELLEME: Yeni tank form olay dinleyicileri
    tankForm.addEventListener('submit', handleTankKaydet);
    tankAktarimForm.addEventListener('submit', handleTankAktarim);

    // Form Temizleme OlaylarÄ±
    if(cariFormTemizleBtn) cariFormTemizleBtn.addEventListener('click', resetCariForm);
    if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.addEventListener('click', resetYemTanimForm);
    if(yemAlisFormTemizleBtn) yemAlisFormTemizleBtn.addEventListener('click', resetYemAlisForm);
    if(yemSatisFormTemizleBtn) yemSatisFormTemizleBtn.addEventListener('click', resetYemSatisForm);
    if(odemeFormTemizleBtn) odemeFormTemizleBtn.addEventListener('click', resetOdemeForm);
    if(tankFormTemizleBtn) tankFormTemizleBtn.addEventListener('click', resetTankForm); // GÃœNCELLEME
    
    // Filtreleme ve Dinamik DeÄŸiÅŸiklik OlaylarÄ±
    cariSearchInput.addEventListener('input', renderCariListesi);
    cariKategoriFiltre.addEventListener('change', renderCariListesi);
    document.getElementById('cariTarihselRaporBtn')?.addEventListener('click', renderCariListesi);
    topluGirisTarihInput?.addEventListener('change', () => { renderTopluSutGirisFormu(); renderSutAlimGecmisi(); });
    topluGirisKategoriSelect?.addEventListener('change', renderTopluSutGirisFormu);
    document.getElementById('aylikChartGosterBtn')?.addEventListener('click', renderAylikSutunGrafik);
    if(odemeCariSecimi) odemeCariSecimi.addEventListener('change', async (event) => { /* ... bakiye gÃ¶sterme kodu ... */ });
    
    // GÃœNCELLEME: Tank seÃ§imi deÄŸiÅŸikliÄŸini dinleme
    aktarimKaynakTankSelect?.addEventListener('change', (event) => {
        const tankId = event.target.value;
        const miktarGosterge = document.getElementById('kaynakTankMiktar');
        if (tankId && window.tankDataMap && window.tankDataMap.has(tankId)) {
            const mevcutLitre = window.tankDataMap.get(tankId).mevcutLitre;
            miktarGosterge.textContent = `${mevcutLitre.toFixed(2)} Lt`;
        } else {
            miktarGosterge.textContent = '0.00 Lt';
        }
    });

    // Rapor OluÅŸturma OlaylarÄ±
    document.getElementById('raporOlusturBtn')?.addEventListener('click', handleHesapOzetiRaporuOlustur);
    document.getElementById('sutRaporuOlusturBtn')?.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: false}));
    document.getElementById('sutRaporuTumunuGosterBtn')?.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: true, kategori: false}));
    document.getElementById('sutRaporuKategoriGosterBtn')?.addEventListener('click', () => handleSutAlimRaporuOlustur({tumu: false, kategori: true}));
    document.getElementById('yemDetayliSatisRaporuBtn')?.addEventListener('click', () => handleYemPivotRaporu('satis'));
    document.getElementById('yemMusteriKarRaporuBtn')?.addEventListener('click', () => handleYemPivotRaporu('karlilik'));

    // YazdÄ±rma ve DÄ±ÅŸa Aktarma OlaylarÄ±
    cariListesiYazdirBtn?.addEventListener('click', () => handleYazdir('cari-yonetimi'));
    document.getElementById('raporYazdirBtn')?.addEventListener('click', () => handleYazdir('hesap-ozeti'));
    document.getElementById('sutRaporuYazdirBtn')?.addEventListener('click', () => handleYazdir('sut-alim-raporu'));
    document.getElementById('yemRaporuYazdirBtn')?.addEventListener('click', () => handleYazdir('aylik-yem-raporu'));
    
    document.getElementById('hesapOzetiPdfBtn')?.addEventListener('click', () => exportTableToPdf('raporDetayAlani', 'hesap_ozeti', 'Cari Hesap Ã–zeti'));
    document.getElementById('hesapOzetiXlsxBtn')?.addEventListener('click', () => exportTableToExcel('raporDetayAlani', 'hesap_ozeti'));
    document.getElementById('sutRaporuPdfBtn')?.addEventListener('click', () => exportTableToPdf('sutRaporuDetayAlani', 'sut_alim_raporu', 'AylÄ±k SÃ¼t AlÄ±m Raporu'));
    document.getElementById('sutRaporuXlsxBtn')?.addEventListener('click', () => exportTableToExcel('sutRaporuDetayAlani', 'sut_alim_raporu'));
    document.getElementById('yemRaporuPdfBtn')?.addEventListener('click', () => exportTableToPdf('yemRaporuAlani', 'yem_raporu', 'AylÄ±k Yem Raporu'));
    document.getElementById('yemRaporuXlsxBtn')?.addEventListener('click', () => exportTableToExcel('yemRaporuAlani', 'yem_raporu'));

    // Otomatik Tutar Hesaplama OlaylarÄ±
    document.getElementById('yemAlisMiktar').addEventListener('input', () => hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar'));
    document.getElementById('yemAlisBirimFiyati').addEventListener('input', () => hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar'));
    document.getElementById('yemSatisMiktar').addEventListener('input', () => hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar'));
    document.getElementById('yemSatisBirimFiyati').addEventListener('input', () => hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar'));
    document.getElementById('yemSecimiSatis').addEventListener('change', (event) => {
        const yemId = event.target.value;
        const fiyatInput = document.getElementById('yemSatisBirimFiyati');
        if (yemId && window.yemDataMap && window.yemDataMap.has(yemId)) {
            fiyatInput.value = window.yemDataMap.get(yemId).satisFiyati || 0;
        } else {
            fiyatInput.value = '';
        }
        hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar');
    });
}

async function loadAndRenderAllData() {
    console.log("Veri yÃ¼kleme fonksiyonlarÄ± kontrollÃ¼ bir ÅŸekilde baÅŸlatÄ±lÄ±yor...");
    try { await renderCariListesi(); } catch (e) { console.warn("Cari listesi yÃ¼klenemedi.", e); }
    try { await renderYemStokListesi(); } catch (e) { console.warn("Yem stoku yÃ¼klenemedi.", e); }
    try { await renderOdemeListesi(); } catch (e) { console.warn("Ã–deme listesi yÃ¼klenemedi.", e); }
    try { await renderCariKategoriListesi(); } catch (e) { console.warn("Cari kategori listesi yÃ¼klenemedi.", e); }
    try { await populateCariKategoriFiltre(); } catch (e) { console.warn("Cari kategori filtresi doldurulamadÄ±.", e); }
    try { await populateCariKategoriSelect(document.getElementById('topluGirisKategori')); } catch (e) { console.warn("Toplu giriÅŸ kategorisi doldurulamadÄ±.", e); }
    try { await updateDashboardStats(); } catch (e) { console.warn("Panel istatistikleri gÃ¼ncellenemedi.", e); }
    console.log("Veri yÃ¼kleme denemeleri tamamlandÄ±.");
}

function generateId() { return db.collection('_').doc().id; }
function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); const userTimezoneOffset = date.getTimezoneOffset() * 60000; return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('tr-TR'); }
function getTodayForInput() { return new Date().toISOString().split('T')[0]; }
function formatMonthYear(ayYil) {
    if (!ayYil) return '';
    const [year, month] = ayYil.split('-');
    const date = new Date(year, month - 1);
    return date.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' });
}
function getMonthYearForInput() { const d = new Date(); return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;}
function formatCurrency(number) { return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(number); }
function setEditingMode(formBaslikEl, kaydetBtnEl, temizleBtnEl, editIdVar, formType) { if(!formBaslikEl || !kaydetBtnEl) return; formBaslikEl.textContent = editIdVar ? `${formType} Bilgilerini DÃ¼zenle` : `Yeni ${formType} KaydÄ±`; kaydetBtnEl.textContent = editIdVar ? 'GÃ¼ncelle' : 'Kaydet'; if (temizleBtnEl) temizleBtnEl.style.display = editIdVar ? 'inline-block' : 'none'; }
function applyRolePermissions() {
    const bodyElement = document.body;
    bodyElement.className = `role-${currentUserRole}`;
    const calisanAllowed = ['#dashboard', '#sut-alimi', '#yem-satisi', '#cari-yonetimi'];
    const activeLink = document.querySelector('#sidebarNav a.nav-link.active');
    const activeHref = activeLink ? activeLink.getAttribute('href') : '#dashboard';
    if (currentUserRole === 'calisan' && !calisanAllowed.includes(activeHref)) {
        document.querySelector('#sidebarNav a.nav-link[href="#dashboard"]').click();
    }
}
function handleLogout() { auth.signOut().then(() => { window.location.href = 'login.html'; }).catch(error => console.error("Logout error", error)); }

async function getSettings() {
    const varsayilanSutFiyatiInput = document.getElementById('varsayilanSutFiyati');
    const currentUser = auth.currentUser;
    if (!currentUser) {
        console.error("getSettings Ã§aÄŸrÄ±ldÄ± ancak aktif bir kullanÄ±cÄ± oturumu bulunamadÄ±.");
        return;
    }
    const settingsRef = db.collection('ayarlar').doc(currentUser.uid);
    try {
        const doc = await settingsRef.get();
        if (doc.exists) {
            globalSettings = doc.data();
        }
        if (globalSettings && globalSettings.defaultMilkPrice) {
            varsayilanSutFiyatiInput.value = globalSettings.defaultMilkPrice.toFixed(2);
        } else {
            varsayilanSutFiyatiInput.value = (15.50).toFixed(2);
        }
    } catch(e) { console.error("Ayarlar alÄ±nÄ±rken hata: ", e); }
}

async function handleAyarlarKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("LÃ¼tfen giriÅŸ yapÄ±n."); return; }
    const varsayilanSutFiyatiInput = document.getElementById('varsayilanSutFiyati');
    const yeniFiyat = parseFloat(varsayilanSutFiyatiInput.value);
    
    if (!isNaN(yeniFiyat) && yeniFiyat >= 0) {
        try {
            // AyarlarÄ± veritabanÄ±na kaydet
            await db.collection('ayarlar').doc(currentUser.uid).set({ defaultMilkPrice: yeniFiyat, sahipId: currentUser.uid }, { merge: true });
            // Global ayar deÄŸiÅŸkenini gÃ¼ncelle
            globalSettings.defaultMilkPrice = yeniFiyat;
            alert('Genel ayarlar kaydedildi.');

            // --- YENÄ° EKLENEN KOD ---
            // EÄŸer "GÃ¼nlÃ¼k SÃ¼t AlÄ±mÄ±" sekmesi o anda aÃ§Ä±ksa, yeni fiyatÄ± yansÄ±tmak iÃ§in listeyi yenile.
            const sutAlimiSekmesi = document.getElementById('sut-alimi');
            if (sutAlimiSekmesi && sutAlimiSekmesi.style.display === 'block') {
                await renderTopluSutGirisFormu();
                console.log('SÃ¼t alÄ±m formu yeni fiyatla gÃ¼ncellendi.');
            }
            // --- YENÄ° KOD SONU ---

        } catch (error) {
            console.error("Ayarlar kaydedilirken hata:", error);
            alert("Ayarlar kaydedilemedi.");
        }
    } else {
        alert('LÃ¼tfen geÃ§erli bir sÃ¼t fiyatÄ± giriniz.');
    }
}


async function handleSifreDegistir(event) {
    event.preventDefault();
    const eskiSifre = document.getElementById('eskiSifre').value;
    const yeniSifre = document.getElementById('yeniSifre').value;
    const yeniSifreTekrar = document.getElementById('yeniSifreTekrar').value;

    if(!yeniSifre || yeniSifre.length < 6) { alert("Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r!"); return; }
    if(yeniSifre !== yeniSifreTekrar) { alert("Yeni ÅŸifreler uyuÅŸmuyor!"); return; }

    const user = auth.currentUser;
    if (!user) { alert("LÃ¼tfen giriÅŸ yapÄ±n."); return; }
    const credential = firebase.auth.EmailAuthProvider.credential(user.email, eskiSifre);

    try {
        await user.reauthenticateWithCredential(credential);
        await user.updatePassword(yeniSifre);
        alert("Åifreniz baÅŸarÄ±yla gÃ¼ncellendi!");
        document.getElementById('sifreDegistirForm').reset();
    } catch (error) {
        console.error("Åifre gÃ¼ncelleme hatasÄ±:", error);
        alert("Eski ÅŸifre hatalÄ± veya bir sorun oluÅŸtu.");
    }
}

// Ä°LGÄ°LÄ° FONKSÄ°YON
async function updateDashboardStats() {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    // --- SÃ¼t ve MÃ¼ÅŸteri Ä°statistikleri ---
    try {
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);
        
        const todayStr = today.toISOString().split('T')[0];
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        const todaySutPromise = db.collection('sut_alimlari').where("sahipId", "==", currentUser.uid).where("tarih", "==", todayStr).get();
        const yesterdaySutPromise = db.collection('sut_alimlari').where("sahipId", "==", currentUser.uid).where("tarih", "==", yesterdayStr).get();
        const carilerPromise = db.collection('cariler').where("sahipId", "==", currentUser.uid).where("durum", "==", "aktif").get();

        const [sutSnapshot, dunkuSutSnapshot, carilerSnapshot] = await Promise.all([todaySutPromise, yesterdaySutPromise, carilerPromise]);
        
        let sabahToplam = 0, aksamToplam = 0;
        sutSnapshot.forEach(doc => {
            sabahToplam += doc.data().sabah || 0;
            aksamToplam += doc.data().aksam || 0;
        });
        const gunlukToplamSut = sabahToplam + aksamToplam;

        let dunkuToplamSut = 0;
        dunkuSutSnapshot.forEach(doc => { dunkuToplamSut += doc.data().toplam || 0; });
        
        const fark = gunlukToplamSut - dunkuToplamSut;
        const karsilastirmaEl = document.getElementById('dunKarsilastirma');
        if (fark > 0) {
            karsilastirmaEl.textContent = `(DÃ¼ne gÃ¶re +${fark.toFixed(2)} Lt)`;
            karsilastirmaEl.style.color = 'green';
        } else if (fark < 0) {
            karsilastirmaEl.textContent = `(DÃ¼ne gÃ¶re ${fark.toFixed(2)} Lt)`;
            karsilastirmaEl.style.color = 'red';
        } else {
            karsilastirmaEl.textContent = '(DÃ¼ne gÃ¶re deÄŸiÅŸiklik yok)';
            karsilastirmaEl.style.color = '#7f8c8d';
        }

        document.getElementById('dashToplamSut').textContent = gunlukToplamSut.toFixed(2);
        document.getElementById('dashSabahSut').textContent = sabahToplam.toFixed(2);
        document.getElementById('dashAksamSut').textContent = aksamToplam.toFixed(2);
        document.getElementById('dashAktifMusteri').textContent = carilerSnapshot.size;

    } catch (e) { console.error("Dashboard gÃ¼nlÃ¼k istatistikleri alÄ±nÄ±rken hata", e); }
    
    // --- Bakiye ToplamlarÄ± ve Ä°lerleme Ã‡ubuklarÄ± ---
    try {
        const allCarilerSnapshot = await db.collection('cariler').where("sahipId", "==", currentUser.uid).get();
        let toplamMusteriBorcu = 0;
        let toplamMusteriAlacagi = 0;
        
        if(!allCarilerSnapshot.empty) {
            const bakiyePromises = allCarilerSnapshot.docs.map(doc => calculateCariBakiyeDetayli(doc.id));
            const tumBakiyeler = await Promise.all(bakiyePromises);
            tumBakiyeler.forEach(bakiyeDetay => {
                if (bakiyeDetay.bakiye > 0) {
                    toplamMusteriAlacagi += bakiyeDetay.bakiye;
                } else {
                    toplamMusteriBorcu += Math.abs(bakiyeDetay.bakiye);
                }
            });
        }
        
        document.getElementById('dashToplamAlacak').textContent = formatCurrency(toplamMusteriBorcu);
        document.getElementById('dashToplamBorc').textContent = formatCurrency(toplamMusteriAlacagi);

       const toplamBakiye = toplamMusteriAlacagi - toplamMusteriBorcu;
        const toplamBakiyeSpan = document.getElementById('dashToplamBakiye');
        const bakiyeUyariSpan = document.getElementById('bakiyeDurumUyarisi');
        const bakiyeKarti = document.getElementById('bakiyeDurumKarti');

        toplamBakiyeSpan.textContent = formatCurrency(toplamBakiye);
        
        if (toplamBakiye < 0) {
            bakiyeUyariSpan.textContent = "Genel Bakiye BorÃ§lu!";
            bakiyeUyariSpan.style.color = 'red';
            toplamBakiyeSpan.style.color = 'red';
            bakiyeKarti.style.borderColor = 'red';
        } else {
            bakiyeUyariSpan.textContent = "Genel Bakiye AlacaklÄ±";
            bakiyeUyariSpan.style.color = 'green';
            toplamBakiyeSpan.style.color = 'green';
            bakiyeKarti.style.borderColor = '#ddd';
        }

        const total = toplamMusteriBorcu + toplamMusteriAlacagi;
        const alacakYuzde = total > 0 ? (toplamMusteriBorcu / total) * 100 : 0;
        const borcYuzde = total > 0 ? (toplamMusteriAlacagi / total) * 100 : 0;
        document.getElementById('alacakBar').style.width = alacakYuzde + '%';
        document.getElementById('borcBar').style.width = borcYuzde + '%';

    } catch (e) { console.error("Dashboard bakiye toplamlarÄ± alÄ±nÄ±rken hata", e); }
    
    // --- GÃœNCELLEME: Dashboard aÃ§Ä±ldÄ±ÄŸÄ±nda tank grafikleri ve diÄŸer grafikler yÃ¼klenir ---
    try {
        if (typeof renderGunlukSutGrafik === 'function') await renderGunlukSutGrafik();
        if (typeof renderDashboardTanks === 'function') await renderDashboardTanks(); // TANK GRAFÄ°ÄÄ° Ã‡AÄIRILIYOR
        const aylikChartInput = document.getElementById('aylikChartAySecimi');
        if (aylikChartInput && !aylikChartInput.value) {
            aylikChartInput.value = getMonthYearForInput();
        }
        if (typeof renderAylikSutunGrafik === 'function') await renderAylikSutunGrafik();
    } catch(e) { console.error("Kontrol paneli grafikleri oluÅŸturulurken hata", e); }
}
// --- CARÄ° YÃ–NETÄ°MÄ° FONKSÄ°YONLARI ---
async function handleCariKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("LÃ¼tfen giriÅŸ yapÄ±n."); return; }

    const cariAdi = document.getElementById('cariAdiSoyadi').value;
    if (!cariAdi) { alert("AdÄ± SoyadÄ± / Firma AdÄ± alanÄ± zorunludur."); return; }

    const rotaSirasiInput = document.getElementById('cariRotaSirasi').value;
    const yeniRotaSirasi = rotaSirasiInput ? parseInt(rotaSirasiInput, 10) : null;

    const formData = {
        kodu: document.getElementById('cariKodu').value,
        rotaSirasi: yeniRotaSirasi,
        adiSoyadi: cariAdi,
        kategori: document.getElementById('cariKategori').value,
        durum: document.getElementById('cariDurum').value,
        cariTipi: document.getElementById('cariTipi').value,
        telefon: document.getElementById('cariTelefon').value,
        eposta: document.getElementById('cariEposta').value,
        adres: document.getElementById('cariAdres').value,
        bankaAdi: document.getElementById('cariBankaAdi').value,
        iban: document.getElementById('cariIban').value,
        vergiDairesi: document.getElementById('cariVergiDairesi').value,
        vergiNo: document.getElementById('cariVergiNo').value,
        notlar: document.getElementById('cariNotlar').value,
        sahipId: currentUser.uid
    };

    try {
        // DÃœZENLEME MODU
        if (editingCariId) {
            const cariRef = db.collection('cariler').doc(editingCariId);

            await db.runTransaction(async (transaction) => {
                const cariDoc = await transaction.get(cariRef);
                if (!cariDoc.exists) throw "DÃ¼zenlenecek cari bulunamadÄ±!";
                
                const eskiRotaSirasi = cariDoc.data().rotaSirasi;

                // Rota sÄ±rasÄ± deÄŸiÅŸmediyse veya null ise, sadece gÃ¼ncelle ve Ã§Ä±k
                if (eskiRotaSirasi === yeniRotaSirasi) {
                    transaction.set(cariRef, formData, { merge: true });
                    return;
                }

                // --- Rota SÄ±rasÄ± DeÄŸiÅŸim MantÄ±ÄŸÄ± ---

                // 1. Durum: Eski sÄ±radan daha bÃ¼yÃ¼k bir sÄ±raya geÃ§me (Ã¶rn: 3 -> 5)
                // Aradaki (4, 5) sÄ±ralarÄ± birer azaltÄ±lmalÄ±.
                if (yeniRotaSirasi > eskiRotaSirasi) {
                    const carilerToUpdateQuery = db.collection('cariler')
                        .where('sahipId', '==', currentUser.uid)
                        .where('rotaSirasi', '>', eskiRotaSirasi)
                        .where('rotaSirasi', '<=', yeniRotaSirasi);
                    const snapshot = await carilerToUpdateQuery.get();
                    snapshot.forEach(doc => {
                        transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi - 1 });
                    });
                }
                // 2. Durum: Eski sÄ±radan daha kÃ¼Ã§Ã¼k bir sÄ±raya geÃ§me (Ã¶rn: 5 -> 3)
                // Aradaki (3, 4) sÄ±ralarÄ± birer artÄ±rÄ±lmalÄ±.
                else if (yeniRotaSirasi < eskiRotaSirasi) {
                    const carilerToUpdateQuery = db.collection('cariler')
                        .where('sahipId', '==', currentUser.uid)
                        .where('rotaSirasi', '>=', yeniRotaSirasi)
                        .where('rotaSirasi', '<', eskiRotaSirasi);
                    const snapshot = await carilerToUpdateQuery.get();
                    snapshot.forEach(doc => {
                        transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi + 1 });
                    });
                }

                // Son olarak, dÃ¼zenlenen cariyi yeni sÄ±rasÄ±yla gÃ¼ncelle
                transaction.set(cariRef, formData, { merge: true });
            });

        } 
        // YENÄ° KAYIT MODU
        else {
             await db.runTransaction(async (transaction) => {
                 // EÄŸer yeni kayda bir rota sÄ±rasÄ± verilmiÅŸse, o sÄ±radan sonrakileri 1 artÄ±r
                if (yeniRotaSirasi) {
                     const carilerToUpdateQuery = db.collection('cariler')
                        .where('sahipId', '==', currentUser.uid)
                        .where('rotaSirasi', '>=', yeniRotaSirasi);
                    const snapshot = await carilerToUpdateQuery.get();
                     snapshot.forEach(doc => {
                        transaction.update(doc.ref, { rotaSirasi: doc.data().rotaSirasi + 1 });
                    });
                }
                
                // Yeni cariyi ekle
                const newCariRef = db.collection('cariler').doc();
                transaction.set(newCariRef, formData);

                // AÃ§Ä±lÄ±ÅŸ bakiyesini de transaction iÃ§inde hallet
                const acilisBakiye = parseFloat(document.getElementById('cariAcilisBakiye').value) || 0;
                const bakiyeTuru = document.getElementById('cariAcilisBakiyeTuru').value;
                if (acilisBakiye > 0 && bakiyeTuru !== 'yok') {
                    const bakiyeData = {
                        aciklama: "AÃ§Ä±lÄ±ÅŸ Bakiyesi", cariId: newCariRef.id,
                        islemTuru: bakiyeTuru === 'borc' ? 'tahsilat' : 'odeme', // Bakiye tÃ¼rÃ¼ne gÃ¶re iÅŸlem tÃ¼rÃ¼ ayarÄ±
                        sahipId: currentUser.uid,
                        tarih: new Date(1990, 0, 1).toISOString().split('T')[0],
                        tutar: acilisBakiye
                    };
                    const odemeRef = db.collection('odemeVeTahsilatlar').doc();
                    transaction.set(odemeRef, bakiyeData);
                }
             });
        }
        
        resetCariForm();
        await renderCariListesi();

    } catch (error) {
        console.error("Cari kaydedilirken hata: ", error);
        alert("Cari kaydedilirken bir hata oluÅŸtu: " + error.message);
    }
}
  
// -- AÃ‡IKLAMA: Rota sÄ±rasÄ± tekrarÄ± kontrolÃ¼ eklendi --
async function renderCariListesi() {
    const cariListesiBody = document.getElementById('cariListesiBody');
    const cariListesiFooter = document.getElementById('cariListesiFooter');
    const cariSearchInput = document.getElementById('cariSearchInput');
    const cariKategoriFiltre = document.getElementById('cariKategoriFiltre');
    const uyariDiv = document.getElementById('cariRotaSirasiUyari');
    const searchTerm = cariSearchInput.value.toLowerCase();
    const kategori = cariKategoriFiltre.value;
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    // --- GÃœNCELLEME: Tarih filtresinden deÄŸeri oku ---
    const tarihFiltresi = document.getElementById('cariTarihFiltresi').value;
    const raporTarihEtiketi = document.getElementById('raporTarihEtiketi');
    raporTarihEtiketi.textContent = tarihFiltresi ? `${formatDate(tarihFiltresi)} Tarihi Ä°tibarÄ±yla` : 'GÃ¼ncel Durum';

    let query = db.collection('cariler').where("sahipId", "==", currentUser.uid);
    if (kategori) {
        query = query.where("kategori", "==", kategori);
    }
    query = query.orderBy('rotaSirasi').orderBy('adiSoyadi');

    try {
        const snapshot = await query.get();
        let cariler = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const rotaSiraCounts = {};
        cariler.forEach(cari => {
            const sira = cari.rotaSirasi;
            if (sira && sira > 0) rotaSiraCounts[sira] = (rotaSiraCounts[sira] || 0) + 1;
        });
        const duplicates = Object.keys(rotaSiraCounts).filter(sira => rotaSiraCounts[sira] > 1);
        if (duplicates.length > 0) {
            uyariDiv.innerHTML = `<strong>âš ï¸ UyarÄ±:</strong> AÅŸaÄŸÄ±daki rota sÄ±ralarÄ± birden fazla cari iÃ§in kullanÄ±lmÄ±ÅŸ: <strong>${duplicates.join(', ')}</strong>. LÃ¼tfen bu carileri dÃ¼zenleyerek her cariye benzersiz bir rota sÄ±rasÄ± atayÄ±n.`;
            uyariDiv.style.display = 'block';
        } else {
            uyariDiv.style.display = 'none';
        }

        if (searchTerm) {
            cariler = cariler.filter(c => c.kodu?.toLowerCase().includes(searchTerm) || c.adiSoyadi?.toLowerCase().includes(searchTerm));
        }
        
        cariListesiBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Bakiyeler hesaplanÄ±yor...</td></tr>';
        
        // --- GÃœNCELLEME: Bakiye hesaplamasÄ±na tarih filtresini gÃ¶nder ---
        const bakiyePromises = cariler.map(c => calculateCariBakiyeDetayli(c.id, tarihFiltresi));
        const bakiyeler = await Promise.all(bakiyePromises);
        
        cariListesiBody.innerHTML = '';
        cariListesiFooter.innerHTML = '';
        if (cariler.length === 0) {
            cariListesiBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">KayÄ±tlÄ± cari bulunmuyor.</td></tr>';
            return;
        }

        let genelToplamAlacak = 0, genelToplamBorc = 0;
        cariler.forEach((c, index) => {
            const row = cariListesiBody.insertRow();
            const bakiyeDetay = bakiyeler[index];
            if (bakiyeDetay) {
                genelToplamAlacak += bakiyeDetay.alacak;
                genelToplamBorc += bakiyeDetay.borc;
                const bakiye = bakiyeDetay.bakiye;
                const durumText = c.durum === 'aktif' ? 'Aktif' : 'Pasif';
                const durumStyle = c.durum === 'aktif' ? 'color:green;' : 'color:red;';
                const bakiyeStyle = bakiye >= 0 ? 'color:green;' : 'color:red;';
                const bakiyeText = `${formatCurrency(bakiye)} ${bakiye >= 0 ? '(A)' : '(B)'}`;
                row.innerHTML = `<td>${c.kodu || ''}</td><td>${c.adiSoyadi || ''}</td><td>${c.kategori || ''}</td><td style="${duplicates.includes(String(c.rotaSirasi)) ? 'background-color:#fff3cd; color:red; font-weight:bold;' : ''}">${c.rotaSirasi || ''}</td><td style="${durumStyle}">${durumText}</td><td>${c.telefon || ''}</td><td>${formatCurrency(bakiyeDetay.borc)}</td><td>${formatCurrency(bakiyeDetay.alacak)}</td><td style="${bakiyeStyle}">${bakiyeText}</td><td class="dont-print"><button class="btn btn-edit btn-sm" onclick="editCari('${c.id}')">DÃ¼zenle</button><button class="btn btn-delete btn-sm" onclick="deleteCari('${c.id}')">Sil</button></td>`;
            }
        });
        const footerRow = cariListesiFooter.insertRow();
        const toplamBakiye = genelToplamAlacak - genelToplamBorc;
        const toplamBakiyeStyle = toplamBakiye >= 0 ? 'color:green;' : 'color:red;';
        const etiket = kategori ? `Kategori ToplamÄ±` : 'Genel Toplam';
        footerRow.innerHTML = `<td colspan="6"><strong>${etiket}</strong></td><td><strong>${formatCurrency(genelToplamBorc)}</strong></td><td><strong>${formatCurrency(genelToplamAlacak)}</strong></td><td style="${toplamBakiyeStyle}"><strong>${formatCurrency(toplamBakiye)}</strong></td><td class="dont-print"></td>`;
    } catch (error) {
        console.error("Cariler listelenirken hata", error);
        cariListesiBody.innerHTML = '<tr><td colspan="10" style="color:red; text-align:center;">Liste yÃ¼klenirken bir hata oluÅŸtu. Firestore index\'i gerekebilir.</td></tr>';
    }
}



function exportTableToExcel(containerId, fileName = 'rapor') {
    const container = document.getElementById(containerId);
    if (!container) {
        alert('Rapor konteyneri bulunamadÄ±.');
        return;
    }
    const table = container.querySelector('table'); // Tabloyu konteyner iÃ§inde ara
    if (!table) {
        alert('Rapor iÃ§eriÄŸi bulunamadÄ±, lÃ¼tfen Ã¶nce bir rapor oluÅŸturun.');
        return;
    }

    const tableClone = table.cloneNode(true);
    Array.from(tableClone.querySelectorAll('.dont-print')).forEach(el => el.remove());

    const wb = XLSX.utils.table_to_book(tableClone, {sheet:"Rapor"});
    XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString('tr-TR')}.xlsx`);
}

function exportTableToExcel(containerId, fileName = 'rapor') {
    const container = document.getElementById(containerId);
    if (!container) {
        alert('Rapor konteyneri bulunamadÄ±. LÃ¼tfen tekrar deneyin.');
        console.error(`Konteyner bulunamadÄ±: #${containerId}`);
        return;
    }
    const table = container.querySelector('table');
    if (!table) {
        alert('Rapor iÃ§eriÄŸinde indirilecek bir tablo bulunamadÄ±.');
        console.error(`Tablo bulunamadÄ±: #${containerId}`);
        return;
    }

    const tableClone = table.cloneNode(true);
    Array.from(tableClone.querySelectorAll('.dont-print')).forEach(el => el.remove());

    const wb = XLSX.utils.table_to_book(tableClone, {sheet:"Rapor"});
    XLSX.writeFile(wb, `${fileName}_${new Date().toLocaleDateString('tr-TR')}.xlsx`);
}


// --- BU FONKSÄ°YONU GÃœNCELLEYÄ°N ---
async function exportTableToPdf(containerId, fileName = 'rapor', title = 'Rapor') {
    const container = document.getElementById(containerId);
    if (!container || container.innerHTML.trim() === '') {
        alert('PDF oluÅŸturmak iÃ§in Ã¶nce bir rapor oluÅŸturun.');
        return;
    }

    if (containerId === 'raporDetayAlani') {
        const pdfButton = document.getElementById('hesapOzetiPdfBtn');
        const originalButtonText = pdfButton.textContent;
        pdfButton.textContent = "PDF OluÅŸturuluyor...";
        pdfButton.disabled = true;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        const usableWidth = pdfWidth - (margin * 2);
        let y = margin;

        const reportTitle = document.getElementById('raporBaslik').innerText;
        
        // --- YENÄ° EKLENEN BÃ–LÃœM: TÃ¼rkÃ§e karakter sorununu Ã§Ã¶zmek iÃ§in ---
        const sanitizedTitle = reportTitle
            .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
            .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
            .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
            .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
            .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
            .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c');
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');

        // GeniÅŸlik hesaplamasÄ± ve yazdÄ±rma iÅŸlemi temizlenmiÅŸ baÅŸlÄ±k ile yapÄ±lÄ±r.
        const textWidth = doc.getTextWidth(sanitizedTitle);
        const textX = (pdfWidth - textWidth) / 2;
        doc.text(sanitizedTitle, textX, y);
        
        y += 15; 

        const blocks = container.querySelectorAll('.report-block');

        for (const block of blocks) {
            const canvas = await html2canvas(block, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                willReadFrequently: true
            });
            
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const imgHeight = (canvas.height * usableWidth) / canvas.width;

            if (y + imgHeight > doc.internal.pageSize.getHeight() - margin) {
                doc.addPage();
                y = margin;
            }
            
            doc.addImage(imgData, 'JPEG', margin, y, usableWidth, imgHeight);
            y += imgHeight + 5;
        }

        doc.save(`${fileName}_${new Date().toLocaleDateString('tr-TR')}.pdf`);
        pdfButton.textContent = originalButtonText;
        pdfButton.disabled = false;

    } 
    else {
        // DiÄŸer basit tablo raporlarÄ± iÃ§in kod aynÄ± kalÄ±r...
        const tableElement = container.querySelector('table');
        if (!tableElement) {
            alert('Rapor iÃ§eriÄŸinde indirilecek bir tablo bulunamadÄ±.');
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(title, 14, 20);
        doc.autoTable({
            html: tableElement,
            startY: 30,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 2 },
            didParseCell: function (data) {
                if (data.cell.text && typeof data.cell.text[0] === 'string') {
                    data.cell.text[0] = data.cell.text[0]
                        .replace(/Ä°/g, 'I').replace(/Ä±/g, 'i')
                        .replace(/Å/g, 'S').replace(/ÅŸ/g, 's')
                        .replace(/Ä/g, 'G').replace(/ÄŸ/g, 'g')
                        .replace(/Ãœ/g, 'U').replace(/Ã¼/g, 'u')
                        .replace(/Ã–/g, 'O').replace(/Ã¶/g, 'o')
                        .replace(/Ã‡/g, 'C').replace(/Ã§/g, 'c')
                        .replace(/â‚º/g, 'TL');
                }
            }
        });
        doc.save(`${fileName}_${new Date().toLocaleDateString('tr-TR')}.pdf`);
    }
}


function generateRandomColors(count) {
    const colors = [];
    for (let i = 0; i < count; i++) {
        const r = Math.floor(Math.random() * 200);
        const g = Math.floor(Math.random() * 200);
        const b = Math.floor(Math.random() * 200);
        colors.push(`rgba(${r}, ${g}, ${b}, 0.8)`);
    }
    return colors;
}

async function renderAylikSutunGrafik() {
    const ayYil = document.getElementById('aylikChartAySecimi').value;
    const ctx = document.getElementById('aylikSutGrafik').getContext('2d');

    if (aylikSutunChartInstance) {
        aylikSutunChartInstance.destroy();
    }
    
    // Her iÅŸlemden Ã¶nce tuvali temizle
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

    if (!ayYil) {
        ctx.font = "16px Segoe UI";
        ctx.fillStyle = "#666";
        ctx.textAlign = "center";
        ctx.fillText("LÃ¼tfen bir ay seÃ§ip 'GrafiÄŸi GÃ¶ster' butonuna basÄ±n.", ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    }

    const currentUser = auth.currentUser;
    if (!currentUser) return;
    
    ctx.font = "16px Segoe UI";
    ctx.fillStyle = "#666";
    ctx.textAlign = "center";
    ctx.fillText("Grafik oluÅŸturuluyor...", ctx.canvas.width / 2, ctx.canvas.height / 2);

    try {
        const [year, month] = ayYil.split('-');
        const startDateStr = new Date(year, month - 1, 1).toISOString().split('T')[0];
        const endDateStr = new Date(year, month, 0).toISOString().split('T')[0];

        const alimlarSnapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', currentUser.uid)
            .where('tarih', '>=', startDateStr)
            .where('tarih', '<=', endDateStr)
            .get();

        // --- Ä°STEDÄ°ÄÄ°NÄ°Z KONTROL VE MESAJ ---
        if (alimlarSnapshot.empty) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillText("Bu ayda sÃ¼t alÄ±mÄ± yok.", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return; // Fonksiyonu burada sonlandÄ±r.
        }
        
        // --- Veri Varsa Grafik Ã‡izim KodlarÄ± ---
        const carilerSnapshot = await db.collection('cariler').where('sahipId', '==', currentUser.uid).get();
        const kategoriMap = new Map();
        carilerSnapshot.forEach(doc => {
            kategoriMap.set(doc.id, doc.data().kategori || 'BelirtilmemiÅŸ');
        });

        const dataByKategori = {};
        alimlarSnapshot.forEach(doc => {
            const alim = doc.data();
            const kategori = kategoriMap.get(alim.cariId) || "DiÄŸer";
            if (!dataByKategori[kategori]) {
                dataByKategori[kategori] = 0;
            }
            dataByKategori[kategori] += alim.toplam;
        });

        const labels = Object.keys(dataByKategori);
        const data = Object.values(dataByKategori);
        
        aylikSutunChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Toplam SÃ¼t (Lt)',
                    data: data,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                 plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: (value) => value.toFixed(0) + ' Lt',
                        color: '#333',
                        font: { weight: 'bold' }
                    }
                },
                scales: { y: { beginAtZero: true } }
            }
        });
    } catch (error) {
        console.error("AylÄ±k sÃ¼t grafiÄŸi oluÅŸturulurken hata:", error);
    }
}

        
async function editCari(id) { 
    try {
        const doc = await db.collection('cariler').doc(id).get();
        if (!doc.exists) return;
        const cari = doc.data();

        const cariKoduInput = document.getElementById('cariKodu');
        cariKoduInput.readOnly = false;

        editingCariId = id; 
        document.getElementById('cariEditId').value = id; 
        document.getElementById('cariKodu').value = cari.kodu || ''; 
        document.getElementById('cariRotaSirasi').value = cari.rotaSirasi || null; 
        document.getElementById('cariAdiSoyadi').value = cari.adiSoyadi || ''; 
        document.getElementById('cariKategori').value = cari.kategori || ''; 
        document.getElementById('cariDurum').value = cari.durum || 'aktif';
        document.getElementById('cariTipi').value = cari.cariTipi || 'sut_ve_yem';
        document.getElementById('cariTelefon').value = cari.telefon || ''; 
        document.getElementById('cariEposta').value = cari.eposta || ''; 
        document.getElementById('cariAdres').value = cari.adres || ''; 
        document.getElementById('cariBankaAdi').value = cari.bankaAdi || ''; 
        document.getElementById('cariIban').value = cari.iban || ''; 
        document.getElementById('cariVergiDairesi').value = cari.vergiDairesi || ''; 
        document.getElementById('cariVergiNo').value = cari.vergiNo || ''; 
        document.getElementById('cariNotlar').value = cari.notlar || ''; 

        setEditingMode(
            document.getElementById('cariFormBaslik'),
            document.getElementById('cariKaydetBtn'),
            document.getElementById('cariFormTemizleBtn'),
            editingCariId,
            'Cari'
        );
    } catch (e) {
        console.error("Cari bilgileri yÃ¼klenirken hata:", e);
    }
}

async function deleteCari(id) {
    const currentUser = auth.currentUser;
    if (!currentUser) {
        alert("LÃ¼tfen giriÅŸ yapÄ±n.");
        return;
    }

    try {
        const cariRef = db.collection('cariler').doc(id);
        const cariDoc = await cariRef.get();
        if (!cariDoc.exists) {
            alert("Silinecek cari bulunamadÄ±!");
            return;
        }
        
        const cariData = cariDoc.data();
        const cariAdi = cariData.adiSoyadi;
        const cariKodu = cariData.kodu || '';

        // 1. AÅAMA: Ä°lk Onay Penceresi
        const ilkOnay = confirm(`âš ï¸ DÄ°KKAT!
'${cariAdi}' isimli cariyi silmek Ã¼zeresiniz.

Bu iÅŸlem, cariye ait TÃœM SÃœT, YEM, Ã–DEME ve TAHSÄ°LAT kayÄ±tlarÄ±nÄ± kalÄ±cÄ± olarak silecektir. Bu iÅŸlem geri alÄ±namaz!

Devam etmek istediÄŸinizden emin misiniz?`);

        if (!ilkOnay) {
            return; // KullanÄ±cÄ± iptal etti
        }

        // 2. AÅAMA: YazÄ±lÄ± Onay Penceresi
        const ikinciOnayMesaji = `ğŸ›‘ SON UYARI!
Silme iÅŸlemini onaylamak iÃ§in lÃ¼tfen carinin kodunu (${cariKodu}) aÅŸaÄŸÄ±daki kutucuÄŸa yazÄ±n.`;
        
        const kullaniciGirdisi = prompt(ikinciOnayMesaji, "");

        // KullanÄ±cÄ± iptal ettiyse veya bir ÅŸey yazmadÄ±ysa iÅŸlemi durdur
        if (kullaniciGirdisi === null) {
            return;
        }
        
        // KullanÄ±cÄ±nÄ±n girdiÄŸi kod, carinin koduyla eÅŸleÅŸmiyorsa iÅŸlemi durdur
        if (kullaniciGirdisi.trim() !== cariKodu) {
            alert("Girilen cari kodu yanlÄ±ÅŸ! Silme iÅŸlemi iptal edildi.");
            return;
        }

        // TÃ¼m onaylar baÅŸarÄ±lÄ±ysa silme iÅŸlemine geÃ§
        // (Buradaki kod, rota sÄ±rasÄ±nÄ± gÃ¼ncelleyen ve tÃ¼m hareketleri silen mevcut kodunuzdur)
        const silinenRotaSirasi = cariData.rotaSirasi;
        const hareketler = ['sut_alimlari', 'yem_alimlari', 'yem_satislari', 'odemeVeTahsilatlar'];
        const hareketSnapshots = [];
        for (const koleksiyon of hareketler) {
            const q = db.collection(koleksiyon).where('cariId', '==', id).where('sahipId', '==', currentUser.uid);
            const snapshot = await q.get();
            hareketSnapshots.push(snapshot);
        }

        let carilerToUpdateSnapshot = null;
        if (silinenRotaSirasi) {
            const carilerToUpdateQuery = db.collection('cariler')
                .where('sahipId', '==', currentUser.uid)
                .where('rotaSirasi', '>', silinenRotaSirasi);
            carilerToUpdateSnapshot = await carilerToUpdateQuery.get();
        }

        await db.runTransaction(async (transaction) => {
            hareketSnapshots.forEach(snapshot => {
                snapshot.forEach(doc => transaction.delete(doc.ref));
            });

            if (carilerToUpdateSnapshot) {
                carilerToUpdateSnapshot.forEach(doc => {
                    const mevcutSira = doc.data().rotaSirasi;
                    transaction.update(doc.ref, { rotaSirasi: mevcutSira - 1 });
                });
            }
            
            transaction.delete(cariRef);
        });

        console.log("Cari baÅŸarÄ±yla silindi ve rota sÄ±ralarÄ± gÃ¼ncellendi.");
        await renderCariListesi();
        alert(`'${cariAdi}' isimli cari ve tÃ¼m hareketleri baÅŸarÄ±yla silindi.`);

    } catch (error) {
        console.error("Cari silinirken hata:", error);
        alert("Cari silinirken bir hata oluÅŸtu: " + error);
    }
}

function resetCariForm(){ 
    document.getElementById('cariForm').reset(); 
    editingCariId = null; 
    document.getElementById('cariEditId').value = ''; 
    setEditingMode(document.getElementById('cariFormBaslik'), document.getElementById('cariKaydetBtn'), document.getElementById('cariFormTemizleBtn'), null, 'Cari Kart');
}

async function handleCariKategoriEkle(event) {
    event.preventDefault();
    const yeniCariKategoriAdiInput = document.getElementById('yeniCariKategoriAdi');
    const yeniAd = yeniCariKategoriAdiInput.value.trim();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("LÃ¼tfen giriÅŸ yapÄ±n."); return; }
    if (yeniAd === '') { alert('Kategori/KÃ¶y adÄ± boÅŸ olamaz.'); return; }
    try {
        await db.collection('cari_kategorileri').add({ ad: yeniAd, sahipId: currentUser.uid });
        await Promise.all([
          renderCariKategoriListesi(),
          populateCariKategoriSelect(document.getElementById('cariKategori')),
          populateCariKategoriFiltre(),
          populateCariKategoriSelect(document.getElementById('topluGirisKategori'))
        ]);
        yeniCariKategoriAdiInput.value = '';
    } catch (error) {
        console.error("Kategori eklenirken hata: ", error);
        alert("Kategori eklenemedi. Konsolu kontrol edin.");
    }
}

async function renderCariKategoriListesi() {
    const cariKategoriListesiUl = document.getElementById('cariKategoriListesiUl');
    const currentUser = auth.currentUser;
    if (!cariKategoriListesiUl || !currentUser) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", currentUser.uid).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        cariKategoriListesiUl.innerHTML = ''; 
        if (kategoriler.length === 0) { cariKategoriListesiUl.innerHTML = '<li>TanÄ±mlÄ± kategori/kÃ¶y bulunmuyor.</li>'; return; } 
        kategoriler.forEach(kat => { const li = document.createElement('li'); li.textContent = kat.ad; const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Sil'; deleteBtn.classList.add('btn', 'btn-delete', 'btn-sm', 'dont-print'); deleteBtn.onclick = () => deleteCariKategori(kat.id); li.appendChild(deleteBtn); cariKategoriListesiUl.appendChild(li); });
    } catch(error) { console.error("Kategoriler listelenirken hata:", error); }
}

async function deleteCariKategori(id) { 
    if (confirm('Bu kategoriyi/kÃ¶yÃ¼ silmek istediÄŸinizden emin misiniz?')) { 
        try {
            await db.collection('cari_kategorileri').doc(id).delete(); 
            await Promise.all([renderCariKategoriListesi(), populateCariKategoriSelect(document.getElementById('cariKategori')), populateCariKategoriFiltre(), populateCariKategoriSelect(document.getElementById('topluGirisKategori'))]);
        } catch(error) { console.error("Kategori silinirken hata:", error); }
    }
}



async function populateCariKategoriFiltre() { 
    const selectElement = document.getElementById('cariKategoriFiltre');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", currentUser.uid).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value; 
        selectElement.innerHTML = `<option value="">TÃ¼m Kategoriler</option>`; 
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); 
        selectElement.value = currentValue; 
    } catch(error) { console.error("Kategori filtresi yÃ¼klenirken hata:", error); }
}

async function populateCariKategoriSelect(selectElement, defaultOptionText = "SeÃ§iniz...") { 
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('cari_kategorileri').where("sahipId", "==", currentUser.uid).orderBy('ad').get();
        const kategoriler = snapshot.docs.map(doc => doc.data());
        const currentValue = selectElement.value; 
        selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`; 
        kategoriler.forEach(kat => { const option = document.createElement('option'); option.value = kat.ad; option.textContent = kat.ad; selectElement.appendChild(option); }); 
        if (kategoriler.some(kat => kat.ad === currentValue)) { selectElement.value = currentValue; }
    } catch(error) { console.error("Kategori seÃ§imi yÃ¼klenirken hata:", error); }
}

async function populateCariSelect(selectElement, defaultText = "SeÃ§iniz...") { 
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('cariler').where("sahipId", "==", currentUser.uid).where("durum", "==", "aktif").orderBy('adiSoyadi').get();
        const cariler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const currentValue = selectElement.value; 
        selectElement.innerHTML = ''; 
        const firstOption = document.createElement('option'); firstOption.value = ""; firstOption.textContent = defaultText; selectElement.appendChild(firstOption); 
        cariler.forEach(c => { const option = document.createElement('option'); option.value = c.id; option.textContent = `${c.adiSoyadi} (${c.kodu || 'Kodsuz'})`; selectElement.appendChild(option); }); 
        if (cariler.some(c => c.id === currentValue)) { selectElement.value = currentValue; }
    } catch(error) { console.error("Cari seÃ§imi yÃ¼klenirken hata:", error); }
}

async function populateYemSelect(selectElement, defaultText = "Yem SeÃ§iniz...") {
    if(!selectElement) return;
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yemler').where("sahipId", "==", currentUser.uid).orderBy('ad').get();
        const yemler = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        
        window.yemDataMap = new Map(); // FiyatlarÄ± saklamak iÃ§in global bir map
        yemler.forEach(y => window.yemDataMap.set(y.id, y));

        selectElement.innerHTML = ''; 
        const firstOption = document.createElement('option'); firstOption.value = ""; firstOption.textContent = defaultText; selectElement.appendChild(firstOption);
        yemler.forEach(y => {
            const option = document.createElement('option');
            option.value = y.id;
            option.textContent = `${y.ad} (${y.kod}) - Stok: ${y.stokMiktari || 0} ${y.birim}`;
            selectElement.appendChild(option);
        });
    } catch (error) {
        console.error("Yem seÃ§imi yÃ¼klenirken hata:", error);
    }
}


async function renderGunlukSutGrafik() {
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    const ctx = document.getElementById('gunlukSutGrafik').getContext('2d');
    if(gunlukSutunChartInstance) {
        gunlukSutunChartInstance.destroy();
    }

    try {
        const tarihStr = getTodayForInput();
        const alimlarSnapshot = await db.collection('sut_alimlari').where('sahipId', '==', currentUser.uid).where('tarih', '==', tarihStr).get();
        
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        if (alimlarSnapshot.empty) {
            ctx.font = "16px Segoe UI";
            ctx.fillStyle = "#666";
            ctx.textAlign = "center";
            ctx.fillText("BugÃ¼n iÃ§in sÃ¼t alÄ±m verisi bulunmuyor.", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        const carilerSnapshot = await db.collection('cariler').where('sahipId', '==', currentUser.uid).get();
        const kategoriMap = new Map();
        carilerSnapshot.forEach(doc => {
            kategoriMap.set(doc.id, doc.data().kategori || 'BelirtilmemiÅŸ');
        });

        const dataByKategori = {};
        alimlarSnapshot.forEach(doc => {
            const alim = doc.data();
            const kategori = kategoriMap.get(alim.cariId) || "DiÄŸer";
            if (!dataByKategori[kategori]) {
                dataByKategori[kategori] = 0;
            }
            dataByKategori[kategori] += alim.toplam;
        });

        const labels = Object.keys(dataByKategori);
        const data = Object.values(dataByKategori);

        gunlukSutunChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Toplam SÃ¼t (Lt)',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                // indexAxis: 'y' satÄ±rÄ± kaldÄ±rÄ±larak grafik dikey hale getirildi.
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        formatter: (value) => value.toFixed(1) + ' Lt',
                        color: '#111',
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                scales: {
                    y: { // DeÄŸerler artÄ±k Y ekseninde
                        beginAtZero: true
                    }
                }
            }
        });
    } catch(error) {
        console.error("GÃ¼nlÃ¼k sÃ¼t grafiÄŸi oluÅŸturulurken hata:", error);
    }
}



async function handleKullaniciKaydet(event) {
    event.preventDefault();
    alert("Bu Ã¶zellik gÃ¼venlik nedeniyle doÄŸrudan yeni kullanÄ±cÄ± oluÅŸturmaz. LÃ¼tfen Ã¶nce Firebase Authentication panelinden kullanÄ±cÄ±yÄ± e-posta/ÅŸifre ile oluÅŸturun, ardÄ±ndan bu panelden o kullanÄ±cÄ±ya ait bir profil (rol atamasÄ±) oluÅŸturabilirsiniz.");
}

async function deleteKullanici(id) {
    if(confirm("KullanÄ±cÄ±yÄ± silmek istiyor musunuz?")) {
        try {
            await db.collection('kullanicilar').doc(id).delete();
            await renderKullaniciListesi();
        } catch (error) {
            console.error("KullanÄ±cÄ± silinirken hata:", error);
        }
    }
}

async function renderKullaniciListesi() {
    const kullaniciListesiBody = document.getElementById('kullaniciListesiBody');
    const currentUser = auth.currentUser;
    if(!kullaniciListesiBody || !currentUser) return;
    try {
        const snapshot = await db.collection('kullanicilar').where("sahipId", "==", currentUser.uid).get();
        kullaniciListesiBody.innerHTML = '';
        snapshot.forEach(doc => {
            const user = doc.data();
            if(user.rol === 'admin') return;
            const row = kullaniciListesiBody.insertRow();
            row.innerHTML = `<td>${user.kullaniciAdi}</td><td>Ã‡alÄ±ÅŸan</td><td class="dont-print"><button class="btn btn-delete btn-sm" onclick="deleteKullanici('${doc.id}')">Sil</button></td>`;
        });
    } catch(error) { console.error("KullanÄ±cÄ±lar listelenirken hata", error); }
}

async function editYemAlisi(id) {
    try {
        const doc = await db.collection('yem_alimlari').doc(id).get();
        if (!doc.exists) {
            alert("DÃ¼zenlenecek kayÄ±t bulunamadÄ±.");
            return;
        }
        const data = doc.data();
        
        editingYemAlisId = id; // Global dÃ¼zenleme ID'sini ayarla
        document.getElementById('yemAlisEditId').value = id;
        document.getElementById('yemAlisTarih').value = data.tarih;
        document.getElementById('yemSecimiAlis').value = data.yemId;
        document.getElementById('yemAlisMiktar').value = data.miktar;
        document.getElementById('yemAlisTedarikci').value = data.cariId;
        document.getElementById('yemAlisBirimFiyati').value = data.alisFiyati;
        hesaplaToplamTutar('yemAlisMiktar', 'yemAlisBirimFiyati', 'yemAlisToplamTutar');

        setEditingMode(document.getElementById('yemAlisFormBaslik'), document.getElementById('yemAlisKaydetBtn'), document.getElementById('yemAlisFormTemizleBtn'), id, 'Yem AlÄ±ÅŸÄ±');
        document.getElementById('yemAlisForm').scrollIntoView();
    } catch (error) {
        console.error("Yem alÄ±ÅŸÄ± dÃ¼zenleme iÃ§in getirilirken hata:", error);
    }
}


async function editYemSatisi(id) {
    try {
        const doc = await db.collection('yem_satislari').doc(id).get();
        if (!doc.exists) { alert("DÃ¼zenlenecek kayÄ±t bulunamadÄ±."); return; }
        const data = doc.data();

        document.getElementById('yemSatisEditId').value = id;
        document.getElementById('yemSatisTarih').value = data.tarih;
        document.getElementById('yemAlanTedarikci').value = data.cariId;
        document.getElementById('yemSecimiSatis').value = data.yemId;
        document.getElementById('yemSatisMiktar').value = data.miktar;
        document.getElementById('yemSatisBirimFiyati').value = data.satisFiyati;
        hesaplaToplamTutar('yemSatisMiktar', 'yemSatisBirimFiyati', 'yemSatisToplamTutar');

        setEditingMode(document.getElementById('yemSatisFormBaslik'), document.getElementById('yemSatisKaydetBtn'), document.getElementById('yemSatisFormTemizleBtn'), id, 'Yem SatÄ±ÅŸÄ±');
        document.getElementById('yemSatisForm').scrollIntoView();
        alert("StoklarÄ± etkileyen bu kaydÄ± dÃ¼zenlemek ÅŸu an iÃ§in desteklenmemektedir. LÃ¼tfen kaydÄ± silip yeniden oluÅŸturun.");
    } catch (error) {
        console.error("Yem satÄ±ÅŸÄ± dÃ¼zenleme iÃ§in getirilirken hata:", error);
    }
}

async function handleYemTanimKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("LÃ¼tfen giriÅŸ yapÄ±n."); return; }
    const formData = {
        kod: document.getElementById('yemKodu').value,
        ad: document.getElementById('yemAdi').value,
        kategori: document.getElementById('yemKategorisi').value,
        birim: document.getElementById('yemBirimi').value,
        alisFiyati: parseFloat(document.getElementById('yemAlisFiyati').value) || 0,
        satisFiyati: parseFloat(document.getElementById('yemSatisFiyati').value) || 0,
        sahipId: currentUser.uid
    };
    try {
        if (editingYemTanimId) {
            await db.collection('yemler').doc(editingYemTanimId).set(formData, { merge: true }); // merge:true stokMiktarÄ±nÄ± korur
            alert("Yem tanÄ±mÄ± gÃ¼ncellendi.");
        } else {
            formData.stokMiktari = 0; // Yeni tanÄ±mda stok 0'dÄ±r.
            await db.collection('yemler').add(formData);
            alert("Yem tanÄ±mÄ± kaydedildi.");
        }
        resetYemTanimForm();
        await renderYemStokListesi();
    } catch (error) {
        console.error("Yem tanÄ±mÄ± kaydedilirken hata:", error);
        alert("Yem tanÄ±mÄ± kaydedilirken bir hata oluÅŸtu.");
    }
}





function resetYemTanimForm() {
    const yemTanimForm = document.getElementById('yemTanimForm');
    const yemTanimFormBaslik = document.getElementById('yemTanimFormBaslik');
    const yemTanimKaydetBtn = document.getElementById('yemTanimKaydetBtn');
    const yemTanimFormTemizleBtn = document.getElementById('yemTanimFormTemizleBtn');
    yemTanimForm.reset();
    editingYemTanimId = null;
    document.getElementById('yemTanimEditId').value = '';
    if(yemTanimFormBaslik) yemTanimFormBaslik.textContent = 'Yeni Yem TanÄ±mla';
    if(yemTanimKaydetBtn) yemTanimKaydetBtn.textContent = 'Kaydet';
    if(yemTanimFormTemizleBtn) yemTanimFormTemizleBtn.style.display = 'none';
}

async function renderYemStokListesi() {
    const yemStokListesiBody = document.getElementById('yemStokListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yemler').where('sahipId', '==', currentUser.uid).orderBy('ad').get();
        if (snapshot.empty) {
            yemStokListesiBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">TanÄ±mlÄ± yem bulunmuyor.</td></tr>';
            return;
        }
        let rows = '';
        snapshot.forEach(doc => {
            const yem = doc.data();
            rows += `<tr>
                <td>${yem.kod || ''}</td>
                <td>${yem.ad || ''}</td>
                <td>${yem.kategori || ''}</td>
                <td>${yem.birim || ''}</td>
                <td>${formatCurrency(yem.alisFiyati || 0)}</td>
                <td>${formatCurrency(yem.satisFiyati || 0)}</td>
                <td>${yem.stokMiktari || 0}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemTanimi('${doc.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemTanimi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        yemStokListesiBody.innerHTML = rows;
    } catch (error) { console.error("Yem stok listesi yÃ¼klenirken hata:", error); }
}


async function handleYemAlisKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("LÃ¼tfen giriÅŸ yapÄ±n."); return; }

    const miktar = parseInt(document.getElementById('yemAlisMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('yemAlisBirimFiyati').value);
    const yemId = document.getElementById('yemSecimiAlis').value;
    
    if (!yemId || isNaN(miktar) || miktar < 0 || isNaN(birimFiyat)) {
        alert("LÃ¼tfen yem, miktar ve fiyat alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doldurun.");
        return;
    }

    const formData = {
        tarih: document.getElementById('yemAlisTarih').value,
        yemId: yemId,
        miktar: miktar,
        cariId: document.getElementById('yemAlisTedarikci').value || '',
        alisFiyati: birimFiyat,
        toplamTutar: miktar * birimFiyat,
        sahipId: currentUser.uid
    };

    const yemRef = db.collection('yemler').doc(yemId);

    // DÃœZENLEME MANTIÄI
    if (editingYemAlisId) {
        const alisRef = db.collection('yem_alimlari').doc(editingYemAlisId);
        
        try {
            await db.runTransaction(async (transaction) => {
                const eskiAlisDoc = await transaction.get(alisRef);
                if (!eskiAlisDoc.exists) throw "DÃ¼zenlenecek kayÄ±t bulunamadÄ±.";
                
                const eskiMiktar = eskiAlisDoc.data().miktar;
                if (eskiAlisDoc.data().yemId !== yemId) throw "Yem tÃ¼rÃ¼ dÃ¼zenleme sÄ±rasÄ±nda deÄŸiÅŸtirilemez. LÃ¼tfen kaydÄ± silip yeniden oluÅŸturun.";

                const stokFarki = miktar - eskiMiktar; // Yeni ve eski miktar arasÄ±ndaki fark

                transaction.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(stokFarki) });
                transaction.update(alisRef, formData);
            });
            
            alert("Yem alÄ±ÅŸÄ± baÅŸarÄ±yla gÃ¼ncellendi.");
            resetYemAlisForm();
            await Promise.all([renderYemStokListesi(), renderYemAlisHareketleri()]);

        } catch (error) {
            console.error("Yem alÄ±ÅŸÄ± gÃ¼ncellenirken hata:", error);
            alert("Hata: " + error);
        }
    } 
    // YENÄ° KAYIT MANTIÄI
    else {
        try {
            const batch = db.batch();
            const yemAlimRef = db.collection('yem_alimlari').doc();
            batch.set(yemAlimRef, formData);
            batch.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(miktar) });
            await batch.commit();
            
            resetYemAlisForm();
            await Promise.all([renderYemStokListesi(), renderYemAlisHareketleri()]);
        } catch (error) {
            console.error("Yem alÄ±ÅŸÄ± kaydedilirken hata:", error);
            alert("Yem alÄ±ÅŸÄ± kaydedilirken bir hata oluÅŸtu.");
        }
    }
}


async function deleteYemTanimi(id) {
    if (!confirm("Bu yem tanÄ±mÄ±nÄ± silmek istediÄŸinizden emin misiniz? EÄŸer bu yem ile ilgili bir alÄ±ÅŸ veya satÄ±ÅŸ yapÄ±ldÄ±ysa, silme iÅŸlemi engellenecektir.")) return;
    try {
        // Bu yemin kullanÄ±lÄ±p kullanÄ±lmadÄ±ÄŸÄ±nÄ± kontrol et
        const alisSnapshot = await db.collection('yem_alimlari').where('yemId', '==', id).limit(1).get();
        const satisSnapshot = await db.collection('yem_satislari').where('yemId', '==', id).limit(1).get();
        if (!alisSnapshot.empty || !satisSnapshot.empty) {
            alert("Bu yem ile ilgili alÄ±ÅŸ veya satÄ±ÅŸ hareketleri bulunduÄŸu iÃ§in silemezsiniz.");
            return;
        }
        await db.collection('yemler').doc(id).delete();
        alert("Yem tanÄ±mÄ± silindi.");
        await renderYemStokListesi();
    } catch (error) {
        console.error("Yem tanÄ±mÄ± silinirken hata:", error);
        alert("Yem tanÄ±mÄ± silinirken bir hata oluÅŸtu.");
    }
}

async function editYemTanimi(id) {
    try {
        const doc = await db.collection('yemler').doc(id).get();
        if (!doc.exists) { alert("DÃ¼zenlenecek yem bulunamadÄ±."); return; }
        const yem = doc.data();
        
        editingYemTanimId = id;
        document.getElementById('yemTanimEditId').value = id;
        document.getElementById('yemKodu').value = yem.kod;
        document.getElementById('yemAdi').value = yem.ad;
        document.getElementById('yemKategorisi').value = yem.kategori;
        document.getElementById('yemBirimi').value = yem.birim;
        document.getElementById('yemAlisFiyati').value = yem.alisFiyati;
        document.getElementById('yemSatisFiyati').value = yem.satisFiyati;
        
        setEditingMode(document.getElementById('yemTanimFormBaslik'), document.getElementById('yemTanimKaydetBtn'), document.getElementById('yemTanimFormTemizleBtn'), id, 'Yem TanÄ±mÄ±');
        document.getElementById('yemTanimForm').scrollIntoView();
    } catch (error) { console.error("Yem tanÄ±mÄ± dÃ¼zenlenirken hata:", error); }
}


function resetYemAlisForm() {
    document.getElementById('yemAlisForm').reset();
    editingYemAlisId = null;
    document.getElementById('yemAlisEditId').value = '';
    setEditingMode(document.getElementById('yemAlisFormBaslik'), document.getElementById('yemAlisKaydetBtn'), document.getElementById('yemAlisFormTemizleBtn'), null, 'Yeni Yem AlÄ±ÅŸÄ±');
}

async function renderYemAlisHareketleri() {
    const listBody = document.getElementById('yemAlisHareketListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yem_alimlari').where('sahipId', '==', currentUser.uid).orderBy('tarih', 'desc').limit(20).get();
        if (snapshot.empty) {
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Yem alÄ±m hareketi bulunmuyor.</td></tr>';
            return;
        }
        
        const yemIds = new Set(snapshot.docs.map(doc => doc.data().yemId));
        const cariIds = new Set(snapshot.docs.filter(doc => doc.data().cariId).map(doc => doc.data().cariId));

        const yemMap = new Map();
        const cariMap = new Map();

        if (yemIds.size > 0) {
            const yemSnapshot = await db.collection('yemler').where(firebase.firestore.FieldPath.documentId(), 'in', Array.from(yemIds)).get();
            yemSnapshot.forEach(doc => yemMap.set(doc.id, doc.data().ad));
        }
        if (cariIds.size > 0) {
            const cariSnapshot = await db.collection('cariler').where(firebase.firestore.FieldPath.documentId(), 'in', Array.from(cariIds)).get();
            cariSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));
        }
        
        let rows = '';
        snapshot.forEach(doc => {
            const alim = doc.data();
            const yemAdi = yemMap.get(alim.yemId) || 'Bilinmiyor';
            const cariAdi = alim.cariId ? cariMap.get(alim.cariId) : 'PeÅŸin AlÄ±ÅŸ';

            rows += `<tr>
                <td>${formatDate(alim.tarih)}</td>
                <td>${yemAdi}</td>
                <td>${alim.miktar}</td>
                <td>${cariAdi}</td>
                <td>${formatCurrency(alim.alisFiyati)}</td>
                <td>${formatCurrency(alim.toplamTutar)}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemAlisi('${doc.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemAlisi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;
    } catch(e) { console.error("Yem alÄ±ÅŸ hareketleri yÃ¼klenirken hata:", e); }
}


async function editOdeme(id) {
    try {
        const doc = await db.collection('odemeVeTahsilatlar').doc(id).get();
        if (!doc.exists) {
            alert("DÃ¼zenlenecek kayÄ±t bulunamadÄ±.");
            return;
        }
        const data = doc.data();
        
        document.getElementById('odemeEditId').value = id;
        document.getElementById('islemTuru').value = data.islemTuru;
        document.getElementById('odemeTarih').value = data.tarih;
        document.getElementById('odemeYapilanTedarikci').value = data.cariId;
        document.getElementById('odemeTuru').value = data.odemeTuru || 'Kasa'; // YENÄ° EKLENDÄ°

        document.getElementById('odemeTutari').value = data.tutar;
        document.getElementById('odemeAciklama').value = data.aciklama;
        
        setEditingMode(document.getElementById('odemeFormBaslik'), document.getElementById('odemeKaydetBtn'), document.getElementById('odemeFormTemizleBtn'), id, 'Hareket GiriÅŸi');
        document.getElementById('odemeForm').scrollIntoView();

    } catch (error) {
        console.error("Ã–deme dÃ¼zenleme iÃ§in getirilirken hata:", error);
    }
}



async function deleteOdeme(id) {
    if (confirm("Bu iÅŸlem hareketini silmek istediÄŸinizden emin misiniz?")) {
        try {
            await db.collection('odemeVeTahsilatlar').doc(id).delete();
            await renderOdemeListesi(); // Listeyi yenile
        } catch (error) {
            console.error("Ã–deme silinirken hata:", error);
            alert("Ä°ÅŸlem silinirken bir hata oluÅŸtu.");
        }
    }
}

function closeSutDuzenleForm() {
    document.getElementById('sutDuzenleFormAlani').style.display = 'none';
    document.getElementById('sutDuzenleForm').reset();
}



async function renderHareketDokumu() {
    const listBody = document.getElementById('hareketDokumuBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">YÃ¼kleniyor...</td></tr>';

    try {
        let tumHareketler = [];

        // Veri kaynaklarÄ±nÄ± ve nasÄ±l iÅŸleneceklerini tanÄ±mla
        const kaynaklar = [
            { koleksiyon: 'sut_alimlari', tur: 'SÃ¼t AlÄ±mÄ±', aciklamaEk: 'Lt', tutarAlan: 'toplamTutar' },
            { koleksiyon: 'yem_satislari', tur: 'Yem SatÄ±ÅŸÄ±', aciklamaEk: 'Adet', tutarAlan: 'toplamTutar' },
            { koleksiyon: 'odemeVeTahsilatlar', tur: 'islemTuru', aciklamaEk: '', tutarAlan: 'tutar' }
        ];

        // TÃ¼m carilerin isimlerini almak iÃ§in bir harita oluÅŸtur
        const carilerSnapshot = await db.collection('cariler').where('sahipId', '==', currentUser.uid).get();
        const cariMap = new Map();
        carilerSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));

        // TÃ¼m veri kaynaklarÄ±ndan verileri Ã§ek
        const sorguPromise_leri = kaynaklar.map(kaynak => 
            db.collection(kaynak.koleksiyon).where('sahipId', '==', currentUser.uid).get()
        );
        const sonuclar = await Promise.all(sorguPromise_leri);

        // Verileri standart bir formata dÃ¶nÃ¼ÅŸtÃ¼r
        sonuclar.forEach((snapshot, index) => {
            const kaynak = kaynaklar[index];
            snapshot.forEach(doc => {
                const data = doc.data();
                let islemTuru = kaynak.tur;
                if(kaynak.tur === 'islemTuru') {
                    islemTuru = data.islemTuru === 'odeme' ? 'Ã–deme' : 'Tahsilat';
                }
                
                let aciklama = data.aciklama || '';
                if(kaynak.koleksiyon === 'sut_alimlari') aciklama = `${data.toplam.toFixed(2)} ${kaynak.aciklamaEk}`;
                if(kaynak.koleksiyon === 'yem_satislari') aciklama = `${data.miktar} ${kaynak.aciklamaEk}`;

                tumHareketler.push({
                    tarih: data.tarih,
                    cariAdi: cariMap.get(data.cariId) || 'Ä°liÅŸkisiz Cari',
                    islemTuru: islemTuru,
                    aciklama: aciklama,
                    tutar: data[kaynak.tutarAlan]
                });
            });
        });

        // TÃ¼m hareketleri tarihe gÃ¶re en yeniden eskiye sÄ±rala
        tumHareketler.sort((a, b) => new Date(b.tarih) - new Date(a.tarih));

        if (tumHareketler.length === 0) {
            listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">HiÃ§ iÅŸlem hareketi bulunmuyor.</td></tr>';
            return;
        }

        // HTML tablosunu oluÅŸtur
        listBody.innerHTML = tumHareketler.map(h => `
            <tr>
                <td>${formatDate(h.tarih)}</td>
                <td>${h.cariAdi}</td>
                <td>${h.islemTuru}</td>
                <td>${h.aciklama}</td>
                <td>${formatCurrency(h.tutar)}</td>
            </tr>
        `).join('');

    } catch (error) {
        console.error("Hareket dÃ¶kÃ¼mÃ¼ oluÅŸturulurken hata:", error);
        listBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Rapor yÃ¼klenirken bir hata oluÅŸtu.</td></tr>';
    }
}

async function deleteSutAlimi(id) {
    if (confirm("Bu sÃ¼t alÄ±m kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?")) {
        try {
            await db.collection('sut_alimlari').doc(id).delete();
            await renderSutAlimGecmisi();
            await renderTopluSutGirisFormu();
        } catch (error) {
            console.error("SÃ¼t alÄ±mÄ± silinirken hata:", error);
        }
    }
}

async function handleSutAlimiGuncelle(event) {
    event.preventDefault();
    const id = document.getElementById('sutDuzenleId').value;
    const sabah = parseFloat(document.getElementById('sutDuzenleSabah').value) || 0;
    const aksam = parseFloat(document.getElementById('sutDuzenleAksam').value) || 0;
    const fiyat = parseFloat(document.getElementById('sutDuzenleFiyat').value) || 0;
    const toplam = sabah + aksam;

    const guncelVeri = {
        sabah: sabah,
        aksam: aksam,
        fiyat: fiyat,
        toplam: toplam,
        toplamTutar: toplam * fiyat
    };

    try {
        await db.collection('sut_alimlari').doc(id).update(guncelVeri);
        closeSutDuzenleForm();
        await renderSutAlimGecmisi();
    } catch (error) { console.error("SÃ¼t alÄ±mÄ± gÃ¼ncellenirken hata:", error); }
}


async function editSutAlimi(id) {
    const formAlani = document.getElementById('sutDuzenleFormAlani');
    try {
        const doc = await db.collection('sut_alimlari').doc(id).get();
        if (!doc.exists) return;
        const data = doc.data();
        
        document.getElementById('sutDuzenleId').value = id;
        document.getElementById('sutDuzenleSabah').value = data.sabah;
        document.getElementById('sutDuzenleAksam').value = data.aksam;
        document.getElementById('sutDuzenleFiyat').value = data.fiyat;
        
        formAlani.style.display = 'block';
        formAlani.scrollIntoView({behavior: 'smooth'});
    } catch (error) { console.error("SÃ¼t alÄ±mÄ± dÃ¼zenleme iÃ§in getirilirken hata:", error); }
}

async function handleYemSatisKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("LÃ¼tfen giriÅŸ yapÄ±n."); return; }
    
    if (editingYemSatisId) {
        alert("StoklarÄ± etkileyen satÄ±ÅŸ iÅŸlemleri dÃ¼zenlenemez. LÃ¼tfen kaydÄ± silip doÄŸru bir ÅŸekilde yeniden oluÅŸturun.");
        resetYemSatisForm();
        return;
    }

    const miktar = parseInt(document.getElementById('yemSatisMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('yemSatisBirimFiyati').value);
    const yemId = document.getElementById('yemSecimiSatis').value;
    const cariId = document.getElementById('yemAlanTedarikci').value;
    if (!yemId || !cariId || isNaN(miktar) || miktar <= 0 || isNaN(birimFiyat)) {
        alert("LÃ¼tfen cari, yem, miktar ve fiyat alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doldurun."); return;
    }
    const yemRef = db.collection('yemler').doc(yemId);
    const yemSatisRef = db.collection('yem_satislari').doc();
    try {
        await db.runTransaction(async (transaction) => {
            const yemDoc = await transaction.get(yemRef);
            if (!yemDoc.exists) { throw "SatÄ±lmak istenen yem veritabanÄ±nda bulunamadÄ±."; }
            const anlikStok = yemDoc.data().stokMiktari || 0;
            if (anlikStok < miktar) { throw `Yetersiz stok! AnlÄ±k stok: ${anlikStok}`; }
            const formData = {
                tarih: document.getElementById('yemSatisTarih').value, yemId: yemId, cariId: cariId, 
                miktar: miktar, satisFiyati: birimFiyat, toplamTutar: miktar * birimFiyat, sahipId: currentUser.uid
            };
            transaction.set(yemSatisRef, formData);
            transaction.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(-miktar) });
        });
        resetYemSatisForm();
        await renderYemStokListesi();
        await renderYemSatisListesi();
    } catch (error) {
        console.error("Yem satÄ±ÅŸÄ± kaydedilirken hata:", error);
        alert("Yem satÄ±ÅŸÄ± kaydedilemedi: " + error);
    }
}





function resetYemSatisForm() {
    document.getElementById('yemSatisForm').reset();
    editingYemSatisId = null;
    document.getElementById('yemSatisEditId').value = '';
    setEditingMode(document.getElementById('yemSatisFormBaslik'), document.getElementById('yemSatisKaydetBtn'), document.getElementById('yemSatisFormTemizleBtn'), null, 'Yeni Yem SatÄ±ÅŸÄ±');
}

async function calculateCariBakiyeDetayli(cariId, endDate = null) {
    let alacak = 0, borc = 0;
    const currentUser = auth.currentUser;
    if (!currentUser) return { alacak: 0, borc: 0, bakiye: 0 };

    try {
        // --- GÃœNCELLEME: TÃ¼m sorgulara tarih filtresi eklendi ---
        const createQuery = (collectionName) => {
            let query = db.collection(collectionName).where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId);
            if (endDate) {
                query = query.where('tarih', '<=', endDate);
            }
            return query.get();
        };

        const sutQuery = createQuery('sut_alimlari');
        const yemSatisQuery = createQuery('yem_satislari');
        const odemeQuery = createQuery('odemeVeTahsilatlar');
        const yemAlimQuery = createQuery('yem_alimlari');

        const [sutSnapshot, yemSatisSnapshot, odemeSnapshot, yemAlimSnapshot] = await Promise.all([
            sutQuery, yemSatisQuery, odemeQuery, yemAlimQuery
        ]);

        sutSnapshot.forEach(doc => alacak += doc.data().toplamTutar);
        yemAlimSnapshot.forEach(doc => alacak += doc.data().toplamTutar);
        yemSatisSnapshot.forEach(doc => borc += doc.data().toplamTutar);
        
        odemeSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.islemTuru === 'odeme' || data.islemTuru === 'alacak') alacak += data.tutar;
            else if (data.islemTuru === 'tahsilat' || data.islemTuru === 'borc') borc += data.tutar;
        });
        return { alacak, borc, bakiye: alacak - borc };
    } catch (error) {
        console.error(`Bakiye hesaplanÄ±rken hata (Cari ID: ${cariId}):`, error);
        return { alacak: 0, borc: 0, bakiye: 0 };
    }
}
        
async function renderYemSatisListesi() {
    const listBody = document.getElementById('yemSatisListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    try {
        const snapshot = await db.collection('yem_satislari').where('sahipId', '==', currentUser.uid).orderBy('tarih', 'desc').limit(20).get();
        if (snapshot.empty) { listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Yem satÄ±ÅŸ hareketi bulunmuyor.</td></tr>'; return; }
        
        const yemIds = [...new Set(snapshot.docs.map(doc => doc.data().yemId))];
        const cariIds = [...new Set(snapshot.docs.map(doc => doc.data().cariId))];
        const yemMap = new Map();
        const cariMap = new Map();
        if (yemIds.length > 0) {
            const yemSnapshot = await db.collection('yemler').where(firebase.firestore.FieldPath.documentId(), 'in', yemIds).get();
            yemSnapshot.forEach(doc => yemMap.set(doc.id, doc.data().ad));
        }
        if (cariIds.length > 0) {
            const cariSnapshot = await db.collection('cariler').where(firebase.firestore.FieldPath.documentId(), 'in', cariIds).get();
            cariSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));
        }
        
        let rows = '';
        snapshot.forEach(doc => {
            const satis = doc.data();
            const yemAdi = yemMap.get(satis.yemId) || 'Bilinmiyor';
            const cariAdi = cariMap.get(satis.cariId) || 'Bilinmiyor';
            rows += `<tr>
                <td>${formatDate(satis.tarih)}</td><td>${cariAdi}</td><td>${yemAdi}</td><td>${satis.miktar}</td>
                <td>${formatCurrency(satis.satisFiyati)}</td><td>${formatCurrency(satis.toplamTutar)}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editYemSatisi('${doc.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteYemSatisi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;
    } catch(e) { console.error("Yem satÄ±ÅŸ hareketleri yÃ¼klenirken hata:", e); }
}




async function handleOdemeKaydet(event) {
    event.preventDefault();
    const currentUser = auth.currentUser;
    if (!currentUser) { alert("LÃ¼tfen giriÅŸ yapÄ±n."); return; }
    const tutar = parseFloat(document.getElementById('odemeTutari').value);
    const cariId = document.getElementById('odemeYapilanTedarikci').value;
    if (!cariId || isNaN(tutar) || tutar <= 0) {
        alert("LÃ¼tfen cari ve tutar alanlarÄ±nÄ± doÄŸru bir ÅŸekilde doldurun.");
        return;
    }
    const formData = {
        tarih: document.getElementById('odemeTarih').value,
        cariId: cariId,
        islemTuru: document.getElementById('islemTuru').value,
	odemeTuru: document.getElementById('odemeTuru').value,
        tutar: tutar,
        aciklama: document.getElementById('odemeAciklama').value.trim(),
        sahipId: currentUser.uid
    };
    try {
        if (editingOdemeId) {
            await db.collection('odemeVeTahsilatlar').doc(editingOdemeId).set(formData, { merge: true });
        } else {
            await db.collection('odemeVeTahsilatlar').add(formData);
        }
        resetOdemeForm();
        await renderOdemeListesi();
    } catch (error) {
        console.error("Ã–deme/Tahsilat kaydedilirken hata:", error);
        alert("Ä°ÅŸlem kaydedilirken bir hata oluÅŸtu.");
    }
}

function resetOdemeForm() {
    document.getElementById('odemeForm').reset();
    editingOdemeId = null;
    document.getElementById('odemeEditId').value = '';
    setEditingMode(document.getElementById('odemeFormBaslik'), document.getElementById('odemeKaydetBtn'), document.getElementById('odemeFormTemizleBtn'), null, 'Yeni Hareket GiriÅŸi');
}

async function renderOdemeListesi() {
    const listBody = document.getElementById('odemeListesiBody');
    const currentUser = auth.currentUser;
    if (!currentUser) return;

    // Tablo baÅŸlÄ±ÄŸÄ±nÄ± dinamik olarak gÃ¼ncelle (yeni "Ã–deme TÃ¼rÃ¼" sÃ¼tunu iÃ§in)
    const thead = listBody.parentElement.querySelector('thead');
    if (thead) {
        thead.innerHTML = `
            <tr>
                <th>Tarih</th>
                <th>Cari</th>
                <th>Ä°ÅŸlem TÃ¼rÃ¼</th>
                <th>Ã–deme TÃ¼rÃ¼</th>
                <th>Tutar</th>
                <th>AÃ§Ä±klama</th>
                <th class="dont-print">Ä°ÅŸlemler</th>
            </tr>`;
    }
    
    try {
        const snapshot = await db.collection('odemeVeTahsilatlar')
            .where('sahipId', '==', currentUser.uid)
            .orderBy('tarih', 'desc')
            .limit(30) // Performans iÃ§in son 30 hareketi gÃ¶ster
            .get();
        
        if(snapshot.empty){
            // Yeni sÃ¼tun eklendiÄŸi iÃ§in colspan 7'ye gÃ¼ncellendi
            listBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Ä°ÅŸlem hareketi bulunmuyor.</td></tr>';
            return;
        }

        // Performans iÃ§in tÃ¼m cari isimlerini tek seferde Ã§ek
        const cariIds = [...new Set(snapshot.docs.map(doc => doc.data().cariId))];
        const cariMap = new Map();
        if (cariIds.length > 0) {
            const cariSnapshot = await db.collection('cariler').where(firebase.firestore.FieldPath.documentId(), 'in', cariIds).get();
            cariSnapshot.forEach(doc => cariMap.set(doc.id, doc.data().adiSoyadi));
        }

        let rows = '';
        snapshot.forEach(doc => {
            const islem = doc.data();
            const cariAdi = cariMap.get(islem.cariId) || 'Bilinmiyor';
            
            // "islemTuru" alanÄ±nÄ± daha okunaklÄ± hale getir
            let islemTuruText = islem.islemTuru;
            if(islem.islemTuru === 'odeme') islemTuruText = 'Ã–deme';
            if(islem.islemTuru === 'tahsilat') islemTuruText = 'Tahsilat';
            // AÃ§Ä±lÄ±ÅŸ bakiyesinden gelen eski kayÄ±tlar iÃ§in de kontrol
            if(islem.islemTuru === 'borc') islemTuruText = 'AÃ§Ä±lÄ±ÅŸ Borcu';
            if(islem.islemTuru === 'alacak') islemTuruText = 'AÃ§Ä±lÄ±ÅŸ AlacaÄŸÄ±';


            rows += `<tr>
                <td>${formatDate(islem.tarih)}</td>
                <td>${cariAdi}</td>
                <td>${islemTuruText}</td>
                <td>${islem.odemeTuru || '-'}</td>
                <td>${formatCurrency(islem.tutar)}</td>
                <td>${islem.aciklama}</td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editOdeme('${doc.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteOdeme('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        listBody.innerHTML = rows;

    } catch (e) { 
        console.error("Ã–deme listesi yÃ¼klenirken hata:", e);
        listBody.innerHTML = '<tr><td colspan="7" style="color: red; text-align:center;">Ã–deme listesi yÃ¼klenirken bir hata oluÅŸtu.</td></tr>';
    }
}


async function deleteYemSatisi(id) {
    if (confirm("Bu yem satÄ±ÅŸÄ±nÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem, satÄ±lan yemi stoÄŸa geri ekleyecektir.")) {
        const currentUser = auth.currentUser;
        if (!currentUser) return;

        const satisRef = db.collection('yem_satislari').doc(id);
        try {
            const satisDoc = await satisRef.get();
            if (!satisDoc.exists) {
                throw "Silinecek satÄ±ÅŸ kaydÄ± bulunamadÄ±.";
            }
            const satisData = satisDoc.data();
            const yemRef = db.collection('yemler').doc(satisData.yemId);

            const batch = db.batch();
            // SatÄ±ÅŸ kaydÄ±nÄ± sil
            batch.delete(satisRef);
            // StoÄŸu geri ekle
            batch.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(satisData.miktar) });
            
            await batch.commit();
            alert("Yem satÄ±ÅŸÄ± silindi ve stok gÃ¼ncellendi.");

            await renderYemSatisListesi();
            await renderYemStokListesi();

        } catch (error) {
            console.error("Yem satÄ±ÅŸÄ± silinirken hata:", error);
            alert("Hata: " + error);
        }
    }
}

        

// --- BU FONKSÄ°YONU AÅAÄIDAKÄ° Ä°LE DEÄÄ°ÅTÄ°RÄ°N ---
async function renderTopluSutGirisFormu() {
    const tarih = document.getElementById('topluGirisTarih').value;
    const kategori = document.getElementById('topluGirisKategori').value;
    const container = document.getElementById('topluSutGirisTablosuAlani');
    const yokMesaji = document.getElementById('topluGirisTedarikciYokMesaji');
    const currentUser = auth.currentUser;
    if (!currentUser || !tarih) {
        container.innerHTML = '<p style="text-align:center;">LÃ¼tfen bir tarih seÃ§in.</p>';
        yokMesaji.style.display = 'none';
        return;
    }

    try {
        const sutAlimSnapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', currentUser.uid)
            .where('tarih', '==', tarih)
            .get();
        const kayitliCariIdleri = new Set(sutAlimSnapshot.docs.map(doc => doc.data().cariId));

        let query = db.collection('cariler')
            .where('sahipId', '==', currentUser.uid)
            .where('durum', '==', 'aktif')
            .where('cariTipi', 'in', ['sut_ve_yem', 'sadece_sut']);

        if (kategori) {
            query = query.where('kategori', '==', kategori);
        }
        
        // --- GÃœNCELLEME: SÄ±ralama artÄ±k sadece 'rotaSirasi'na gÃ¶re yapÄ±lÄ±yor. ---
        const carilerSnapshot = await query.orderBy('rotaSirasi').get();
        
        const gosterilecekCariler = carilerSnapshot.docs.filter(doc => !kayitliCariIdleri.has(doc.id));

        if (gosterilecekCariler.length === 0) {
            container.innerHTML = '';
            yokMesaji.textContent = 'Bu kriterlere uygun, sÃ¼t giriÅŸi bekleyen cari bulunmuyor.';
            yokMesaji.style.display = 'block';
            return;
        }
        yokMesaji.style.display = 'none';
        
        let tableHTML = `<table><thead><tr><th>Cari AdÄ±</th><th>AkÅŸam (Lt)</th><th>Sabah (Lt)</th><th>Toplam (Lt)</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">Ä°ÅŸlemler</th></tr></thead><tbody>`;

        const defaultFiyat = (globalSettings.defaultMilkPrice || 15.50).toFixed(2);
        gosterilecekCariler.forEach(doc => {
            const cari = { id: doc.id, ...doc.data() };
            const escapedCariAdi = cari.adiSoyadi.replace(/'/g, "\\'").replace(/"/g, '\\"');
            tableHTML += `<tr id="satir-${cari.id}">
                <td>${cari.adiSoyadi} (${cari.kategori || 'BelirtilmemiÅŸ'})</td>
                <td><input type="number" id="aksam-${cari.id}" class="sut-input" step="0.1" min="0" oninput="sutMiktarGuncelle('${cari.id}')"></td>
                <td><input type="number" id="sabah-${cari.id}" class="sut-input" step="0.1" min="0" oninput="sutMiktarGuncelle('${cari.id}')"></td>
                <td><span id="toplam-lt-${cari.id}">0.00</span></td>
                <td><input type="number" id="fiyat-${cari.id}" class="sut-input" step="0.01" min="0" value="${defaultFiyat}" oninput="sutMiktarGuncelle('${cari.id}')"></td>
                <td><span id="toplam-tutar-${cari.id}">0,00 â‚º</span></td>
                <td class="dont-print"><button id="kaydet-btn-${cari.id}" class="btn btn-primary btn-sm" onclick="handleTopluSutKaydet('${cari.id}', '${escapedCariAdi}', '${tarih}')">Kaydet</button></td>
            </tr>`;
        });
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;

    } catch (error) {
        console.error("SÃ¼t giriÅŸi iÃ§in cariler getirilirken hata:", error);
        if (error.code === 'failed-precondition') {
             container.innerHTML = '<p style="text-align:center; color: red;"><b>VeritabanÄ± HatasÄ±:</b> Bu sorgu iÃ§in bir dizin (index) oluÅŸturmanÄ±z gerekiyor.<br>LÃ¼tfen tarayÄ±cÄ± konsolundaki (F12) hatayÄ± kontrol edin ve Firestore tarafÄ±ndan sunulan index oluÅŸturma linkine tÄ±klayÄ±n.</p>';
        } else {
             container.innerHTML = '<p style="text-align:center; color: red;">TedarikÃ§iler yÃ¼klenirken bir hata oluÅŸtu.</p>';
        }
    }
}


function sutMiktarGuncelle(cariId) {
    const sabah = parseFloat(document.getElementById(`sabah-${cariId}`).value) || 0;
    const aksam = parseFloat(document.getElementById(`aksam-${cariId}`).value) || 0;
    const fiyat = parseFloat(document.getElementById(`fiyat-${cariId}`).value) || 0;
    const toplamLt = sabah + aksam;
    const toplamTutar = toplamLt * fiyat;
    document.getElementById(`toplam-lt-${cariId}`).textContent = toplamLt.toFixed(2);
    document.getElementById(`toplam-tutar-${cariId}`).textContent = formatCurrency(toplamTutar);
}

async function handleTopluSutKaydet(cariId, cariAdi, tarih) {
    const sabahInput = document.getElementById(`sabah-${cariId}`);
    const aksamInput = document.getElementById(`aksam-${cariId}`);
    const fiyatInput = document.getElementById(`fiyat-${cariId}`);
    const satir = document.getElementById(`satir-${cariId}`);

    const sabahMiktar = parseFloat(sabahInput.value) || 0;
    const aksamMiktar = parseFloat(aksamInput.value) || 0;
    // DÃœZELTME: Fiyat input'tan okunuyor
    const birimFiyat = parseFloat(fiyatInput.value) || globalSettings.defaultMilkPrice || 0;
    const toplamMiktar = sabahMiktar + aksamMiktar;

    if (toplamMiktar <= 0) { return; }

    const sutAlimData = {
        tarih: tarih, cariId: cariId, cariAdi: cariAdi,
        sabah: sabahMiktar, aksam: aksamMiktar, toplam: toplamMiktar,
        fiyat: birimFiyat, // DÃ¼zeltilmiÅŸ fiyat kullanÄ±lÄ±yor
        toplamTutar: toplamMiktar * birimFiyat, // DÃ¼zeltilmiÅŸ tutar
        sahipId: auth.currentUser.uid
    };

    try {
        await db.collection("sut_alimlari").add(sutAlimData);
        if (satir) satir.style.display = 'none';
        await renderSutAlimGecmisi();
    } catch (error) {
        console.error("SÃ¼t alÄ±mÄ± kaydedilirken hata:", error);
    }
}


        
function hesaplaToplamTutar(miktarInputId, fiyatInputId, toplamInputId) {
    const miktarInput = document.getElementById(miktarInputId);
    const fiyatInput = document.getElementById(fiyatInputId);
    const toplamInput = document.getElementById(toplamInputId);

    const miktar = parseFloat(miktarInput.value) || 0;
    const fiyat = parseFloat(fiyatInput.value) || 0;
    toplamInput.value = formatCurrency(miktar * fiyat);
}

async function renderSutAlimGecmisi() {
    const tarih = document.getElementById('topluGirisTarih').value;
    const gecmisTarihSpan = document.getElementById('gecmisTarihSpan');
    const header = document.getElementById('sutAlimGecmisiHeader');
    const body = document.getElementById('sutAlimGecmisiBody');
    const footer = document.getElementById('sutAlimGecmisiFooter'); // Footer elemanÄ±nÄ± seÃ§
    const currentUser = auth.currentUser;
    if (!currentUser || !tarih) {
        header.innerHTML = '';
        body.innerHTML = '';
        footer.innerHTML = ''; // Tarih yoksa footer'Ä± da temizle
        return;
    }

    gecmisTarihSpan.textContent = formatDate(tarih);
    header.innerHTML = `<tr><th>Cari AdÄ±</th><th>AkÅŸam (Lt)</th><th>Sabah (Lt)</th><th>Toplam</th><th>Fiyat</th><th>Tutar</th><th class="dont-print">Ä°ÅŸlemler</th></tr>`;
    body.innerHTML = '<tr><td colspan="7">YÃ¼kleniyor...</td></tr>';
    footer.innerHTML = ''; // Her yeni render'da footer'Ä± temizle

    try {
        const snapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', currentUser.uid).where('tarih', '==', tarih).orderBy('cariAdi').get();

        if (snapshot.empty) {
            body.innerHTML = '<tr><td colspan="7" style="text-align:center;">Bu tarih iÃ§in sÃ¼t alÄ±m kaydÄ± bulunmuyor.</td></tr>';
            return;
        }

        let bodyHTML = '';
        // ToplamlarÄ± hesaplamak iÃ§in deÄŸiÅŸkenler
        let toplamAksam = 0;
        let toplamSabah = 0;
        let toplamLitre = 0;
        let toplamTutar = 0;

        snapshot.forEach(doc => {
            const alim = doc.data();
            // DeÄŸiÅŸkenlere deÄŸerleri ekle
            toplamAksam += alim.aksam || 0;
            toplamSabah += alim.sabah || 0;
            toplamLitre += alim.toplam || 0;
            toplamTutar += alim.toplamTutar || 0;

            bodyHTML += `<tr>
                <td>${alim.cariAdi}</td>
                <td>${alim.aksam.toFixed(2)}</td>
                <td>${alim.sabah.toFixed(2)}</td>
                <td><strong>${alim.toplam.toFixed(2)}</strong></td>
                <td>${formatCurrency(alim.fiyat)}</td>
                <td><strong>${formatCurrency(alim.toplamTutar)}</strong></td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editSutAlimi('${doc.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteSutAlimi('${doc.id}')">Sil</button>
                </td>
            </tr>`;
        });
        body.innerHTML = bodyHTML;

        // Ortalama fiyatÄ± hesapla
        const ortalamaFiyat = toplamLitre > 0 ? (toplamTutar / toplamLitre) : 0;

        // Footer satÄ±rÄ±nÄ± oluÅŸtur ve ekle
        footer.innerHTML = `
            <tr style="background-color: #f0f0f0; font-weight: bold;">
                <td><strong>GÃœNLÃœK TOPLAM</strong></td>
                <td><strong>${toplamAksam.toFixed(2)}</strong></td>
                <td><strong>${toplamSabah.toFixed(2)}</strong></td>
                <td><strong>${toplamLitre.toFixed(2)}</strong></td>
                <td><strong>${formatCurrency(ortalamaFiyat)}</strong></td>
                <td><strong>${formatCurrency(toplamTutar)}</strong></td>
                <td class="dont-print"></td>
            </tr>
        `;

    } catch (error) {
        console.error("SÃ¼t alÄ±m geÃ§miÅŸi yÃ¼klenirken hata:", error);
        body.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">GeÃ§miÅŸ yÃ¼klenirken bir hata oluÅŸtu.</td></tr>';
    }
}



 
async function deleteYemAlisi(id) {
    if (confirm("Bu yem alÄ±ÅŸÄ±nÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem, alÄ±nan yemi stoktan dÃ¼ÅŸecektir.")) {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert("LÃ¼tfen giriÅŸ yapÄ±n.");
            return;
        }

        const alisRef = db.collection('yem_alimlari').doc(id);
        try {
            const alisDoc = await alisRef.get();
            if (!alisDoc.exists) {
                throw "Silinecek alÄ±ÅŸ kaydÄ± bulunamadÄ±.";
            }
            const alisData = alisDoc.data();
            const yemRef = db.collection('yemler').doc(alisData.yemId);

            // Hem alÄ±ÅŸ kaydÄ±nÄ± silmek hem de stoÄŸu gÃ¼ncellemek iÃ§in toplu iÅŸlem kullan
            const batch = db.batch();
            
            // 1. AlÄ±ÅŸ kaydÄ±nÄ± sil
            batch.delete(alisRef);
            // 2. StoÄŸu azalt (alÄ±nan miktarÄ±n negatifini ekleyerek)
            batch.update(yemRef, { stokMiktari: firebase.firestore.FieldValue.increment(-alisData.miktar) });
            
            await batch.commit();
            alert("Yem alÄ±ÅŸÄ± silindi ve stok gÃ¼ncellendi.");

            // Listeleri yenile
            await renderYemAlisHareketleri();
            await renderYemStokListesi();

        } catch (error) {
            console.error("Yem alÄ±ÅŸÄ± silinirken hata:", error);
            alert("Hata: " + error);
        }
    }
}
       

async function handleSutAlimRaporuOlustur(options) {
    toggleReportButtons('sutRaporu', false);
    const cariId = document.getElementById('sutRaporuTedarikciSecimi').value;
    const ayYil = document.getElementById('sutRaporuAySecimi').value;
    const kategori = document.getElementById('sutRaporuKategoriSecimi').value;
    const raporBaslik = document.getElementById('sutRaporuBaslik');
    const raporDetayAlani = document.getElementById('sutRaporuDetayAlani');
    const currentUser = auth.currentUser;

    if (!currentUser || !ayYil) {
        alert("Rapor oluÅŸturmak iÃ§in lÃ¼tfen bir ay seÃ§in.");
        return;
    }

    if (!options.tumu && !options.kategori && !cariId) {
        alert("LÃ¼tfen bir cari seÃ§in veya 'Kategori' ya da 'Toplu' raporu seÃ§in.");
        return;
    }
    if (options.kategori && !kategori) {
        alert("Kategori raporu iÃ§in lÃ¼tfen bir kategori seÃ§in.");
        return;
    }
    
    raporDetayAlani.innerHTML = '<p>Rapor oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';
    raporBaslik.textContent = '...';

    const [year, month] = ayYil.split('-');
    const startDateStr = `${year}-${month}-01`;
    const endDate = new Date(year, month, 0);
    const endDateStr = endDate.toISOString().split('T')[0];

    try {
        let baseQuery = db.collection('sut_alimlari')
            .where('sahipId', '==', currentUser.uid)
            .where('tarih', '>=', startDateStr)
            .where('tarih', '<=', endDateStr);

        if (!options.tumu && !options.kategori) {
            const cariAdi = document.getElementById('sutRaporuTedarikciSecimi').options[document.getElementById('sutRaporuTedarikciSecimi').selectedIndex].text;
            raporBaslik.textContent = `${formatMonthYear(ayYil)} - ${cariAdi} AylÄ±k SÃ¼t DetaylarÄ±`;
            const snapshot = await baseQuery.where('cariId', '==', cariId).orderBy('tarih').get();

            if (snapshot.empty) {
                raporDetayAlani.innerHTML = '<p>SeÃ§ili cari iÃ§in bu ayda sÃ¼t alÄ±m kaydÄ± bulunamadÄ±.</p>';
                return;
            }

            let tableHTML = `<table class="report-table"><thead><tr><th>Tarih</th><th>AkÅŸam</th><th>Sabah</th><th>Toplam (Lt)</th><th>Fiyat</th><th>Tutar</th></tr></thead><tbody>`;
            let toplamSabah = 0, toplamAksam = 0, toplamLitre = 0, toplamTutar = 0;

            snapshot.forEach(doc => {
                const alim = doc.data();
                toplamSabah += alim.sabah;
                toplamAksam += alim.aksam;
                toplamLitre += alim.toplam;
                toplamTutar += alim.toplamTutar;
                tableHTML += `<tr><td>${formatDate(alim.tarih)}</td><td>${alim.aksam.toFixed(2)}</td><td>${alim.sabah.toFixed(2)}</td><td>${alim.toplam.toFixed(2)}</td><td>${formatCurrency(alim.fiyat)}</td>			<td>${formatCurrency(alim.toplamTutar)}</td></tr>`;
            });

            const ortalamaFiyat = toplamLitre > 0 ? (toplamTutar / toplamLitre) : 0;
            tableHTML += `</tbody><tfoot><tr class="report-totals-row">
                            <td>AYLIK TOPLAM</td>
                            <td>${toplamAksam.toFixed(2)}</td>
                            <td>${toplamSabah.toFixed(2)}</td>
                            <td>${toplamLitre.toFixed(2)}</td>
                            <td>${formatCurrency(ortalamaFiyat)}</td>
                            <td>${formatCurrency(toplamTutar)}</td>
                         </tr></tfoot></table>`;
            raporDetayAlani.innerHTML = tableHTML;
            toggleReportButtons('sutRaporu', true);
        } 
        else {
            if(options.kategori) {
                raporBaslik.textContent = `${kategori} Kategorisi - ${formatMonthYear(ayYil)} AylÄ±k Ã–zet`;
            } else {
                raporBaslik.textContent = `TÃ¼m Cariler - ${formatMonthYear(ayYil)} AylÄ±k Ã–zet`;
            }

            let alimlarSnapshot = await baseQuery.get();
            let alimlar = alimlarSnapshot.docs.map(doc => doc.data());

            if (options.kategori) {
                const cariSnapshot = await db.collection('cariler').where('sahipId', '==', currentUser.uid).where('kategori', '==', kategori).get();
                const cariIdsInKategori = cariSnapshot.docs.map(doc => doc.id);
                alimlar = alimlar.filter(alim => cariIdsInKategori.includes(alim.cariId));
            }
            
            if (alimlar.length === 0) {
                raporDetayAlani.innerHTML = '<p>SeÃ§ili kriterlere uygun sÃ¼t alÄ±m kaydÄ± bulunamadÄ±.</p>';
                return;
            }

            const raporData = {};
            alimlar.forEach(alim => {
                if (!raporData[alim.cariId]) {
                    raporData[alim.cariId] = { cariAdi: alim.cariAdi, toplamSabah: 0, toplamAksam: 0, toplamLitre: 0, toplamTutar: 0 };
                }
                raporData[alim.cariId].toplamSabah += alim.sabah;
                raporData[alim.cariId].toplamAksam += alim.aksam;
                raporData[alim.cariId].toplamLitre += alim.toplam;
                raporData[alim.cariId].toplamTutar += alim.toplamTutar;
            });

            let tableHTML = `<table class="report-table"><thead><tr><th>Cari AdÄ±</th><th>Toplam AkÅŸam</th><th>Toplam Sabah</th><th>Toplam Litre</th><th>Ortalama Fiyat</th><th>Toplam Tutar</th></tr></thead><tbody>`;
            let genelToplamSabah = 0, genelToplamAksam = 0, genelToplamLitre = 0, genelToplamTutar = 0;

            Object.values(raporData).sort((a,b) => a.cariAdi.localeCompare(b.cariAdi)).forEach(data => {
                const ortalamaFiyat = data.toplamLitre > 0 ? (data.toplamTutar / data.toplamLitre) : 0;
                tableHTML += `<tr><td>${data.cariAdi}</td><td>${data.toplamAksam.toFixed(2)}</td><td>${data.toplamSabah.toFixed(2)}</td><td><strong>${data.toplamLitre.toFixed(2)}</strong></td><td>${formatCurrency(ortalamaFiyat)}</td>	<td><strong>${formatCurrency(data.toplamTutar)}</strong></td></tr>`;
                genelToplamSabah += data.toplamSabah;
                genelToplamAksam += data.toplamAksam;
                genelToplamLitre += data.toplamLitre;
                genelToplamTutar += data.toplamTutar;
            });
            
            const genelOrtalamaFiyat = genelToplamLitre > 0 ? (genelToplamTutar / genelToplamLitre) : 0;
            tableHTML += `</tbody><tfoot><tr class="report-totals-row">
                            <td>GENEL TOPLAM</td>
                            <td>${genelToplamAksam.toFixed(2)}</td>
                            <td>${genelToplamSabah.toFixed(2)}</td>
                            <td>${genelToplamLitre.toFixed(2)}</td>
                            <td>${formatCurrency(genelOrtalamaFiyat)}</td>
                            <td>${formatCurrency(genelToplamTutar)}</td>
                         </tr></tfoot></table>`;
            raporDetayAlani.innerHTML = tableHTML;
            toggleReportButtons('sutRaporu', true);
        }
    } catch (error) {
        console.error("AylÄ±k SÃ¼t Raporu oluÅŸturulurken hata:", error);
        raporDetayAlani.innerHTML = `<p style="color:red; font-weight:bold;">RAPOR OLUÅTURULAMADI!<br>Hata DetayÄ±: ${error.message}</p>`;
        alert(`SÃ¼t raporu oluÅŸturulurken bir hata oluÅŸtu!\n\nHata: ${error.message}\n\nLÃ¼tfen konsol (F12) loglarÄ±nÄ± kontrol edin.`);
    }
}



// --- YENÄ°, KAPSAMLI RAPOR FONKSÄ°YONU ---
async function handleYemPivotRaporu(reportType) {
    const raporAlani = document.getElementById('yemRaporuAlani');
    toggleReportButtons('yemRaporu', false);
    const ayYil = document.getElementById('yemRaporuAySecimi').value;
    const currentUser = auth.currentUser;
    
    if (!currentUser || !ayYil) {
        alert("LÃ¼tfen bir ay seÃ§in.");
        raporAlani.innerHTML = '';
        return;
    }

    raporAlani.innerHTML = '<p>Rapor oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';

    try {
        const [year, month] = ayYil.split('-');
        const startDateStr = `${year}-${month}-01`;
        const endDate = new Date(year, month, 0);
        const endDateStr = endDate.toISOString().split('T')[0];

        // 1. Gerekli tÃ¼m verileri tek seferde Ã§ek
        const satisPromise = db.collection('yem_satislari').where('sahipId', '==', currentUser.uid).where('tarih', '>=', startDateStr).where('tarih', '<=', endDateStr).get();
        const yemlerPromise = db.collection('yemler').where('sahipId', '==', currentUser.uid).get();
        const carilerPromise = db.collection('cariler').where('sahipId', '==', currentUser.uid).get();

        const [satisSnapshot, yemlerSnapshot, carilerSnapshot] = await Promise.all([satisPromise, yemlerPromise, carilerPromise]);

        if (satisSnapshot.empty) {
            raporAlani.innerHTML = '<h4>Bu ay iÃ§in yem satÄ±ÅŸÄ± bulunmuyor.</h4>';
            return;
        }

        // 2. Verileri kolay eriÅŸim iÃ§in Map yapÄ±sÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
        const yemMap = new Map(yemlerSnapshot.docs.map(doc => [doc.id, doc.data()]));
        const cariMap = new Map(carilerSnapshot.docs.map(doc => [doc.id, doc.data()]));

        // 3. Veriyi MÃ¼ÅŸteri ve Yem bazÄ±nda grupla (pivot)
        const reportData = {};
        const yemlerInReport = new Set();

        satisSnapshot.forEach(doc => {
            const satis = doc.data();
            yemlerInReport.add(satis.yemId);

            // MÃ¼ÅŸteri (cari) anahtarÄ±nÄ± oluÅŸtur
            if (!reportData[satis.cariId]) {
                reportData[satis.cariId] = {
                    cariAdi: cariMap.get(satis.cariId)?.adiSoyadi || 'Bilinmeyen Cari',
                    yemler: {},
                    musteriToplamSatis: 0,
                    musteriToplamKar: 0
                };
            }
            
            // Yem anahtarÄ±nÄ± oluÅŸtur
            if (!reportData[satis.cariId].yemler[satis.yemId]) {
                reportData[satis.cariId].yemler[satis.yemId] = {
                    adet: 0,
                    toplamSatis: 0,
                    toplamKar: 0,
                    satisFiyatlari: []
                };
            }

            const yemData = reportData[satis.cariId].yemler[satis.yemId];
            yemData.adet += satis.miktar;
            yemData.toplamSatis += satis.toplamTutar;
            yemData.satisFiyatlari.push(satis.satisFiyati);

            const alisFiyati = yemMap.get(satis.yemId)?.alisFiyati || 0;
            yemData.toplamKar += (satis.satisFiyati - alisFiyati) * satis.miktar;

            // MÃ¼ÅŸteri geneli toplamlarÄ±nÄ± gÃ¼ncelle
            reportData[satis.cariId].musteriToplamSatis += satis.toplamTutar;
            reportData[satis.cariId].musteriToplamKar += (satis.satisFiyati - alisFiyati) * satis.miktar;
        });

        const sortedYemList = Array.from(yemlerInReport).sort((a, b) => (yemMap.get(a)?.ad || '').localeCompare(yemMap.get(b)?.ad || ''));

        // 4. HTML Tablosunu oluÅŸtur
        let tableHTML = `<h3 class="print-only print-title" style="text-align:center;">${reportType === 'satis' ? 'DetaylÄ± Yem SatÄ±ÅŸ Raporu' : 'MÃ¼ÅŸteri BazlÄ± Yem KÃ¢rlÄ±lÄ±k Raporu'} - ${formatMonthYear(ayYil)}</h3>`;
        tableHTML += `<table class="report-table"><thead>`;
        
        // Ãœst BaÅŸlÄ±k (Yem AdlarÄ±)
        tableHTML += `<tr><th rowspan="2" style="vertical-align: middle;">MÃ¼ÅŸteri AdÄ±</th>`;
        sortedYemList.forEach(yemId => {
            const yemAdi = yemMap.get(yemId)?.ad || 'Bilinmeyen Yem';
            const colSpan = reportType === 'satis' ? 3 : 5;
            tableHTML += `<th colspan="${colSpan}" style="text-align: center;">${yemAdi}</th>`;
        });
        tableHTML += `<th rowspan="2" style="vertical-align: middle;">${reportType === 'satis' ? 'MÃ¼ÅŸteri ToplamÄ±' : 'MÃ¼ÅŸteri Toplam KÃ¢rÄ±'}</th></tr>`;

        // Alt BaÅŸlÄ±klar (Adet, Fiyat vb.)
        tableHTML += `<tr>`;
        sortedYemList.forEach(() => {
            if (reportType === 'satis') {
                tableHTML += `<th>Adet</th><th>Fiyat</th><th>Toplam</th>`;
            } else { // karlilik
                tableHTML += `<th>Adet</th><th>SatÄ±ÅŸ F.</th><th>AlÄ±ÅŸ F.</th><th>Birim KÃ¢r</th><th>Toplam KÃ¢r</th>`;
            }
        });
        tableHTML += `</tr></thead><tbody>`;

        const genelToplamlar = {};
        
        // MÃ¼ÅŸteri SatÄ±rlarÄ±
        Object.values(reportData).sort((a,b) => a.cariAdi.localeCompare(b.cariAdi)).forEach(cariData => {
            tableHTML += `<tr><td>${cariData.cariAdi}</td>`;
            sortedYemList.forEach(yemId => {
                const yemSatis = cariData.yemler[yemId];
                if (yemSatis) {
                    const ortSatisFiyati = yemSatis.toplamSatis / yemSatis.adet;
                    const alisFiyati = yemMap.get(yemId)?.alisFiyati || 0;
                    const birimKar = ortSatisFiyati - alisFiyati;

                    if (reportType === 'satis') {
                        tableHTML += `<td>${yemSatis.adet}</td><td>${formatCurrency(ortSatisFiyati)}</td><td>${formatCurrency(yemSatis.toplamSatis)}</td>`;
                    } else {
                        tableHTML += `<td>${yemSatis.adet}</td><td>${formatCurrency(ortSatisFiyati)}</td><td>${formatCurrency(alisFiyati)}</td><td style="color:green;">${formatCurrency(birimKar)}</td><td style="color:green; font-weight:bold;">${formatCurrency(yemSatis.toplamKar)}</td>`;
                    }

                    // Genel toplamlarÄ± biriktir
                    if (!genelToplamlar[yemId]) genelToplamlar[yemId] = { adet: 0, toplamSatis: 0, toplamKar: 0 };
                    genelToplamlar[yemId].adet += yemSatis.adet;
                    genelToplamlar[yemId].toplamSatis += yemSatis.toplamSatis;
                    genelToplamlar[yemId].toplamKar += yemSatis.toplamKar;

                } else {
                    const colSpan = reportType === 'satis' ? 3 : 5;
                    for (let i = 0; i < colSpan; i++) tableHTML += `<td>-</td>`;
                }
            });
            const musteriToplam = reportType === 'satis' ? cariData.musteriToplamSatis : cariData.musteriToplamKar;
            tableHTML += `<td style="font-weight:bold;">${formatCurrency(musteriToplam)}</td></tr>`;
        });
        
        tableHTML += `</tbody><tfoot><tr class="report-totals-row"><td><strong>Genel Toplam</strong></td>`;

        let sonGenelToplam = 0;
        sortedYemList.forEach(yemId => {
            const toplam = genelToplamlar[yemId];
            if (toplam) {
                 if (reportType === 'satis') {
                    tableHTML += `<td><strong>${toplam.adet}</strong></td><td></td><td><strong>${formatCurrency(toplam.toplamSatis)}</strong></td>`;
                    sonGenelToplam += toplam.toplamSatis;
                } else {
                    tableHTML += `<td><strong>${toplam.adet}</strong></td><td></td><td></td><td></td><td><strong style="color:green;">${formatCurrency(toplam.toplamKar)}</strong></td>`;
                    sonGenelToplam += toplam.toplamKar;
                }
            } else {
                const colSpan = reportType === 'satis' ? 3 : 5;
                for (let i = 0; i < colSpan; i++) tableHTML += `<td></td>`;
            }
        });
        tableHTML += `<td><strong>${formatCurrency(sonGenelToplam)}</strong></td></tr>`;
        tableHTML += `</tfoot></table>`;

        raporAlani.innerHTML = tableHTML;
        toggleReportButtons('yemRaporu', true);

    } catch (error) {
        console.error("Yem raporu oluÅŸturulurken hata:", error);
        raporAlani.innerHTML = `<p style="color:red; font-weight:bold;">RAPOR OLUÅTURULAMADI!<br>Hata DetayÄ±: ${error.message}</p>`;
    }
}

// ======================================================
// YENÄ° EKLENEN TANK FONKSÄ°YONLARI
// ======================================================

// --- TANK YÃ–NETÄ°MÄ° FONKSÄ°YONLARI ---

async function renderTankListesi() {
    const listBody = document.getElementById('tankListesiBody');
    if (!listBody) return;
    listBody.innerHTML = '<tr><td colspan="5">YÃ¼kleniyor...</td></tr>';
    
    const snapshot = await db.collection('tanklar').orderBy('ad').get();
    if (snapshot.empty) {
        listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">TanÄ±mlÄ± tank bulunmuyor.</td></tr>';
        return;
    }

    let rows = '';
    snapshot.forEach(doc => {
        const tank = doc.data();
        const dolulukOrani = (tank.mevcutLitre / tank.kapasite) * 100;
        rows += `
            <tr>
                <td>${tank.ad}</td>
                <td>${tank.kapasite.toLocaleString('tr-TR')} Lt</td>
                <td>${tank.mevcutLitre.toLocaleString('tr-TR', {maximumFractionDigits: 2})} Lt</td>
                <td>
                    <div class="progress-bar-container" style="height:20px;">
                        <div class="progress-bar" style="width: ${dolulukOrani.toFixed(2)}%; background-color:#3498db; color:white; text-align:center; font-size:11px; line-height:20px;">
                            % ${dolulukOrani.toFixed(1)}
                        </div>
                    </div>
                </td>
                <td class="dont-print">
                    <button class="btn btn-edit btn-sm" onclick="editTank('${doc.id}')">DÃ¼zenle</button>
                    <button class="btn btn-delete btn-sm" onclick="deleteTank('${doc.id}')">Sil</button>
                </td>
            </tr>
        `;
    });
    listBody.innerHTML = rows;
}

function resetTankForm() {
    document.getElementById('tankForm').reset();
    document.getElementById('tankEditId').value = '';
    document.getElementById('tankFormBaslik').textContent = 'Yeni Tank TanÄ±mla';
    document.getElementById('tankKaydetBtn').textContent = 'Kaydet';
    document.getElementById('tankFormTemizleBtn').style.display = 'none';
}

async function handleTankKaydet(event) {
    event.preventDefault();
    const editId = document.getElementById('tankEditId').value;
    const formData = {
        ad: document.getElementById('tankAdi').value,
        kapasite: parseFloat(document.getElementById('tankKapasite').value) || 0,
    };

    try {
        if (editId) {
            await db.collection('tanklar').doc(editId).update(formData);
        } else {
            formData.mevcutLitre = 0; // Yeni tank boÅŸ baÅŸlar
            await db.collection('tanklar').add(formData);
        }
        resetTankForm();
        renderTankListesi();
        renderDashboardTanks();
    } catch (error) {
        console.error("Tank kaydedilirken hata:", error);
        alert("Tank kaydedilirken bir hata oluÅŸtu.");
    }
}

async function editTank(id) {
    const doc = await db.collection('tanklar').doc(id).get();
    if (!doc.exists) return;
    const tank = doc.data();
    
    document.getElementById('tankEditId').value = id;
    document.getElementById('tankAdi').value = tank.ad;
    document.getElementById('tankKapasite').value = tank.kapasite;

    document.getElementById('tankFormBaslik').textContent = 'Tank Bilgilerini DÃ¼zenle';
    document.getElementById('tankKaydetBtn').textContent = 'GÃ¼ncelle';
    document.getElementById('tankFormTemizleBtn').style.display = 'inline-block';
}

async function deleteTank(id) {
    const doc = await db.collection('tanklar').doc(id).get();
    if(doc.data().mevcutLitre > 0) {
        alert("Ä°Ã§inde sÃ¼t bulunan bir tankÄ± silemezsiniz. LÃ¼tfen Ã¶nce tankÄ± boÅŸaltÄ±n.");
        return;
    }
    if (confirm("Bu tankÄ± silmek istediÄŸinizden emin misiniz?")) {
        await db.collection('tanklar').doc(id).delete();
        renderTankListesi();
        renderDashboardTanks();
    }
}

// --- TANKTAN AKTARIM FONKSÄ°YONLARI ---

async function populateTankSelect(selectElement) {
     if(!selectElement) return;
     selectElement.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
     const snapshot = await db.collection('tanklar').orderBy('ad').get();
     if(snapshot.empty) {
         selectElement.innerHTML = '<option value="">TanÄ±mlÄ± tank yok</option>';
         return;
     }
     selectElement.innerHTML = '<option value="">Tank SeÃ§iniz...</option>';
     window.tankDataMap = new Map();
     snapshot.forEach(doc => {
        const tank = doc.data();
        window.tankDataMap.set(doc.id, tank);
        selectElement.innerHTML += `<option value="${doc.id}">${tank.ad}</option>`;
     });
}

async function handleTankAktarim(event) {
    event.preventDefault();
    const form = document.getElementById('tankAktarimForm');
    const kaynakTankId = document.getElementById('aktarimKaynakTank').value;
    const hedefCariId = document.getElementById('aktarimHedefCari').value;
    const aktarimMiktar = parseFloat(document.getElementById('aktarimMiktar').value);
    const birimFiyat = parseFloat(document.getElementById('aktarimFiyat').value);
    const tarih = document.getElementById('aktarimTarih').value;

    if (!kaynakTankId || !hedefCariId || !aktarimMiktar || !birimFiyat || !tarih || aktarimMiktar <= 0) {
        alert("LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru bir ÅŸekilde doldurun.");
        return;
    }

    const tankRef = db.collection('tanklar').doc(kaynakTankId);
    
    try {
        await db.runTransaction(async (transaction) => {
            const tankDoc = await transaction.get(tankRef);
            if (!tankDoc.exists) throw "Kaynak tank bulunamadÄ±!";

            const mevcutLitre = tankDoc.data().mevcutLitre;
            if (mevcutLitre < aktarimMiktar) {
                throw `Yetersiz sÃ¼t! Tankta sadece ${mevcutLitre.toFixed(2)} Lt sÃ¼t var.`;
            }

            // 1. SÃ¼t alÄ±m kaydÄ±nÄ± oluÅŸtur
            const sutAlimRef = db.collection('sut_alimlari').doc();
            const hedefCariAdi = document.getElementById('aktarimHedefCari').options[document.getElementById('aktarimHedefCari').selectedIndex].text;
            transaction.set(sutAlimRef, {
                tarih: tarih,
                cariId: hedefCariId,
                cariAdi: hedefCariAdi,
                sabah: 0, // Bu toplu bir aktarÄ±m olduÄŸu iÃ§in sabah/akÅŸam detayÄ± yok
                aksam: 0,
                toplam: aktarimMiktar,
                fiyat: birimFiyat,
                toplamTutar: aktarimMiktar * birimFiyat,
                aciklama: `${tankDoc.data().ad} tankÄ±ndan aktarÄ±ldÄ±.`,
                sahipId: currentUserId
            });

            // 2. Tanktaki sÃ¼tÃ¼ azalt
            transaction.update(tankRef, {
                mevcutLitre: firebase.firestore.FieldValue.increment(-aktarimMiktar)
            });
        });

        alert("AktarÄ±m baÅŸarÄ±yla tamamlandÄ±!");
        form.reset();
        document.getElementById('kaynakTankMiktar').textContent = '0.00 Lt';
        renderDashboardTanks();

    } catch (error) {
        console.error("Tank aktarÄ±mÄ± sÄ±rasÄ±nda hata:", error);
        alert("AktarÄ±m sÄ±rasÄ±nda bir hata oluÅŸtu: " + error);
    }
}

// --- DASHBOARD TANK GRAFÄ°ÄÄ° FONKSÄ°YONU ---
async function renderDashboardTanks() {
    const container = document.getElementById('dashboardTanklar');
    if (!container) return;
    container.innerHTML = 'YÃ¼kleniyor...';

    const snapshot = await db.collection('tanklar').orderBy('ad').get();
    if (snapshot.empty) {
        container.innerHTML = '<p>TanÄ±mlÄ± tank bulunmuyor.</p>';
        return;
    }
    let html = '';
    snapshot.forEach(doc => {
        const tank = doc.data();
        const dolulukOrani = (tank.mevcutLitre / tank.kapasite) * 100;
        const barClass = dolulukOrani > 95 ? 'tank-bar full' : 'tank-bar';
        html += `
            <div class="tank-item">
                <div class="tank-item-header">
                    <span>${tank.ad}</span>
                    <span>${tank.mevcutLitre.toLocaleString('tr-TR', {maximumFractionDigits:1})} / ${tank.kapasite.toLocaleString('tr-TR')} Lt</span>
                </div>
                <div class="tank-bar-wrapper">
                    <div class="${barClass}" style="width: ${dolulukOrani.toFixed(2)}%;">
                        %${dolulukOrani.toFixed(1)}
                    </div>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}


// BU FONKSÄ°YONU GÃœNCELLEYÄ°N
// --- BU FONKSÄ°YONU GÃœNCELLEYÄ°N ---
async function handleHesapOzetiRaporuOlustur() {
    toggleReportButtons('hesapOzeti', false);
    const cariId = document.getElementById('raporCariSecimi').value;
    const ayYil = document.getElementById('raporTarihAraligi').value;
    const raporBaslik = document.getElementById('raporBaslik');
    const raporDetayAlani = document.getElementById('raporDetayAlani');
    const currentUser = auth.currentUser;

    if (!currentUser || !cariId || !ayYil) {
        alert("LÃ¼tfen cari ve ay seÃ§imi yapÄ±n.");
        raporDetayAlani.innerHTML = '';
        raporBaslik.textContent = 'LÃ¼tfen Rapor Kriterlerini SeÃ§in';
        return;
    }

    const cariAdi = document.getElementById('raporCariSecimi').options[document.getElementById('raporCariSecimi').selectedIndex].text;
    const [year, month] = ayYil.split('-');
    
    raporBaslik.textContent = `${cariAdi} - ${formatMonthYear(ayYil)} Hesap Ã–zeti`;
    raporDetayAlani.innerHTML = '<p>Rapor oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';

    try {
        const startDate = new Date(year, month - 1, 1).toISOString().split('T')[0];
        const endDate = new Date(year, month, 0).toISOString().split('T')[0];
        const devirTarihiStr = new Date(year, month - 1, 0).toISOString().split('T')[0];
        
        const createQuery = (collection, isDevir) => {
            let q = db.collection(collection).where('sahipId', '==', currentUser.uid).where('cariId', '==', cariId);
            q = isDevir ? q.where('tarih', '<=', devirTarihiStr) : q.where('tarih', '>=', startDate).where('tarih', '<=', endDate);
            return q.get();
        };
        
        const yemlerPromise = db.collection('yemler').where('sahipId', '==', currentUser.uid).get();

        const [
            devirSut, devirYemSatis, devirYemAlim, devirOdeme,
            aySut, ayYemSatis, ayYemAlim, ayOdeme, yemlerSnapshot
        ] = await Promise.all([
            createQuery('sut_alimlari', true), createQuery('yem_satislari', true), createQuery('yem_alimlari', true), createQuery('odemeVeTahsilatlar', true),
            createQuery('sut_alimlari', false), createQuery('yem_satislari', false), createQuery('yem_alimlari', false), createQuery('odemeVeTahsilatlar', false),
            yemlerPromise
        ]);
        
        const yemMap = new Map(yemlerSnapshot.docs.map(doc => [doc.id, doc.data()]));
        
        // Devir bakiyesi hesaplama...
        let devredenAlacak = 0, devredenBorc = 0;
        devirSut.forEach(doc => devredenAlacak += doc.data().toplamTutar);
        devirYemAlim.forEach(doc => devredenAlacak += doc.data().toplamTutar);
        devirYemSatis.forEach(doc => devredenBorc += doc.data().toplamTutar);
        devirOdeme.forEach(doc => { 
            const data = doc.data();
            if (data.islemTuru === 'odeme' || data.islemTuru === 'alacak') devredenAlacak += data.tutar;
            else if (data.islemTuru === 'tahsilat' || data.islemTuru === 'borc') devredenBorc += data.tutar;
        });
        const devredenBakiye = devredenAlacak - devredenBorc;

        // --- GÃœNCELLEME: TÃ¼m detay tablolarÄ± iÃ§in HTML oluÅŸturma ---
        let toplamSutDegeri = 0, sutDetayHTML = '';
        if (!aySut.empty) {
            sutDetayHTML = '<table class="report-table"><thead><tr><th>Tarih</th><th>Sabah</th><th>AkÅŸam</th><th>Toplam Lt</th><th>Fiyat</th><th>Tutar</th></tr></thead><tbody>';
            aySut.docs.sort((a,b) => a.data().tarih.localeCompare(b.data().tarih)).forEach(doc => {
                const alim = doc.data();
                toplamSutDegeri += alim.toplamTutar;
                sutDetayHTML += `<tr><td>${formatDate(alim.tarih)}</td><td>${alim.sabah.toFixed(2)}</td><td>${alim.aksam.toFixed(2)}</td><td>${alim.toplam.toFixed(2)}</td><td>${formatCurrency(alim.fiyat)}</td><td>${formatCurrency(alim.toplamTutar)}</td></tr>`;
            });
            sutDetayHTML += '</tbody></table>';
        }

        let toplamYemAlisTutari = 0, yemAlimDetayHTML = '';
        if (!ayYemAlim.empty) {
            yemAlimDetayHTML = '<table class="report-table"><thead><tr><th>Tarih</th><th>Yem AdÄ±</th><th>Miktar</th><th>Tutar</th></tr></thead><tbody>';
            ayYemAlim.docs.sort((a,b) => a.data().tarih.localeCompare(b.data().tarih)).forEach(doc => {
                const alim = doc.data();
                toplamYemAlisTutari += alim.toplamTutar;
                const yemAdi = yemMap.get(alim.yemId)?.ad || 'Bilinmeyen Yem';
                yemAlimDetayHTML += `<tr><td>${formatDate(alim.tarih)}</td><td>${yemAdi}</td><td>${alim.miktar}</td><td>${formatCurrency(alim.toplamTutar)}</td></tr>`;
            });
            yemAlimDetayHTML += '</tbody></table>';
        }

        let toplamYemSatisTutari = 0, yemSatisDetayHTML = '';
        if (!ayYemSatis.empty) {
            yemSatisDetayHTML = '<table class="report-table"><thead><tr><th>Tarih</th><th>Yem AdÄ±</th><th>Miktar</th><th>Tutar</th></tr></thead><tbody>';
            ayYemSatis.docs.sort((a,b) => a.data().tarih.localeCompare(b.data().tarih)).forEach(doc => {
                const satis = doc.data();
                toplamYemSatisTutari += satis.toplamTutar;
                const yemAdi = yemMap.get(satis.yemId)?.ad || 'Bilinmeyen Yem';
                yemSatisDetayHTML += `<tr><td>${formatDate(satis.tarih)}</td><td>${yemAdi}</td><td>${satis.miktar}</td><td>${formatCurrency(satis.toplamTutar)}</td></tr>`;
            });
            yemSatisDetayHTML += '</tbody></table>';
        }

        let toplamOdemeTutari = 0, odemeDetayHTML = '';
        let toplamTahsilatTutari = 0, tahsilatDetayHTML = '';
        if(!ayOdeme.empty) {
            odemeDetayHTML = '<table class="report-table"><thead><tr><th>Tarih</th><th>Ã–deme TÃ¼rÃ¼</th><th>AÃ§Ä±klama</th><th>Tutar</th></tr></thead><tbody>';
            tahsilatDetayHTML = '<table class="report-table"><thead><tr><th>Tarih</th><th>Ã–deme TÃ¼rÃ¼</th><th>AÃ§Ä±klama</th><th>Tutar</th></tr></thead><tbody>';
            let odemeEklendi = false, tahsilatEklendi = false;
            ayOdeme.docs.sort((a,b) => a.data().tarih.localeCompare(b.data().tarih)).forEach(doc => {
                const islem = doc.data();
                if (islem.islemTuru === 'odeme') {
                    toplamOdemeTutari += islem.tutar;
                    odemeDetayHTML += `<tr><td>${formatDate(islem.tarih)}</td><td>${islem.odemeTuru || '-'}</td><td>${islem.aciklama}</td><td>${formatCurrency(islem.tutar)}</td></tr>`;
                    odemeEklendi = true;
                } else if (islem.islemTuru === 'tahsilat') {
                    toplamTahsilatTutari += islem.tutar;
                    tahsilatDetayHTML += `<tr><td>${formatDate(islem.tarih)}</td><td>${islem.odemeTuru || '-'}</td><td>${islem.aciklama}</td><td>${formatCurrency(islem.tutar)}</td></tr>`;
                    tahsilatEklendi = true;
                }
            });
            odemeDetayHTML += '</tbody></table>';
            tahsilatDetayHTML += '</tbody></table>';
            if(!odemeEklendi) odemeDetayHTML = '';
            if(!tahsilatEklendi) tahsilatDetayHTML = '';
        }
        
        const donemSonuBakiye = devredenBakiye + toplamSutDegeri + toplamYemAlisTutari - toplamYemSatisTutari + toplamOdemeTutari - toplamTahsilatTutari;

        // --- GÃœNCELLEME: Rapor HTML'i tÃ¼m detaylarÄ± ve 'open' attribute'Ã¼nÃ¼ iÃ§erecek ÅŸekilde dÃ¼zenlendi ---
        let reportHTML = `
            <div class="report-block"><h5>Ã–nceki DÃ¶nemden Devir</h5><p class="block-total">Devreden Bakiye: <strong>${formatCurrency(devredenBakiye)} (${devredenBakiye >= 0 ? 'AlacaklÄ±' : 'BorÃ§lu'})</strong></p></div>
            <div class="report-block"><h5>SÃ¼t AlÄ±mlarÄ± (Cari'nin AlacaÄŸÄ±)</h5><p class="block-total">AylÄ±k Toplam SÃ¼t DeÄŸeri: <strong>${formatCurrency(toplamSutDegeri)}</strong></p>${sutDetayHTML ? `<details open><summary>DetaylarÄ± GÃ¶ster/Gizle</summary>${sutDetayHTML}</details>` : ''}</div>
            <div class="report-block"><h5>Yem AlÄ±mlarÄ± (Cari'nin AlacaÄŸÄ±)</h5><p class="block-total">AylÄ±k Toplam Yem AlÄ±ÅŸ TutarÄ±: <strong>${formatCurrency(toplamYemAlisTutari)}</strong></p>${yemAlimDetayHTML ? `<details open><summary>DetaylarÄ± GÃ¶ster/Gizle</summary>${yemAlimDetayHTML}</details>` : ''}</div>
            <div class="report-block"><h5>Yem SatÄ±ÅŸlarÄ± (Cari'nin Borcu)</h5><p class="block-total">AylÄ±k Toplam Yem SatÄ±ÅŸ TutarÄ±: <strong>${formatCurrency(toplamYemSatisTutari)}</strong></p>${yemSatisDetayHTML ? `<details open><summary>DetaylarÄ± GÃ¶ster/Gizle</summary>${yemSatisDetayHTML}</details>` : ''}</div>
            <div class="report-block"><h5>YapÄ±lan Ã–demeler (Cari'ye)</h5><p class="block-total">AylÄ±k Toplam Ã–deme TutarÄ±: <strong>${formatCurrency(toplamOdemeTutari)}</strong></p>${odemeDetayHTML ? `<details open><summary>DetaylarÄ± GÃ¶ster/Gizle</summary>${odemeDetayHTML}</details>` : ''}</div>
            <div class="report-block"><h5>YapÄ±lan Tahsilatlar (Cari'den)</h5><p class="block-total">AylÄ±k Toplam Tahsilat TutarÄ±: <strong>${formatCurrency(toplamTahsilatTutari)}</strong></p>${tahsilatDetayHTML ? `<details open><summary>DetaylarÄ± GÃ¶ster/Gizle</summary>${tahsilatDetayHTML}</details>` : ''}</div>
            <div class="report-block final-summary">
                <h5>DÃ–NEM SONU HESAPLAMASI</h5>
                <p><span>Ã–nceki Aydan Devir:</span> <span>${formatCurrency(devredenBakiye)}</span></p>
                <p><span>+ Cari Ay SÃ¼t AlÄ±mlarÄ±:</span> <span>+ ${formatCurrency(toplamSutDegeri)}</span></p>
                <p><span>+ Cari Ay Yem AlÄ±mlarÄ±:</span> <span>+ ${formatCurrency(toplamYemAlisTutari)}</span></p>
                <p><span>+ Cari Ay YapÄ±lan Ã–demeler:</span> <span>+ ${formatCurrency(toplamOdemeTutari)}</span></p>
                <p><span>- Cari Ay Yem SatÄ±ÅŸlarÄ±:</span> <span>- ${formatCurrency(toplamYemSatisTutari)}</span></p>
                <p><span>- Cari Ay YapÄ±lan Tahsilatlar:</span> <span>- ${formatCurrency(toplamTahsilatTutari)}</span></p>
                <hr><p><strong>DÃ–NEM SONU NET BAKÄ°YE:</strong> <strong>${formatCurrency(donemSonuBakiye)} (${donemSonuBakiye >= 0 ? 'Cari AlacaklÄ±' : 'Cari BorÃ§lu'})</strong></p>
            </div>
        `;
        raporDetayAlani.innerHTML = reportHTML;
        toggleReportButtons('hesapOzeti', true);

    } catch (error) {
        console.error("Hesap Ã¶zeti raporu oluÅŸturulurken hata:", error);
        raporDetayAlani.innerHTML = `<p style="color:red; font-weight:bold;">RAPOR OLUÅTURULAMADI!<br>Hata DetayÄ±: ${error.message}</p>`;
    }
}

function toggleReportButtons(reportPrefix, show) {
    const displayStyle = show ? 'inline-block' : 'none';
    const pdfBtn = document.getElementById(`${reportPrefix}PdfBtn`);
    const xlsxBtn = document.getElementById(`${reportPrefix}XlsxBtn`);
    const printBtn = document.getElementById(`${reportPrefix}YazdirBtn`); // YazdÄ±r butonunu da dahil edelim

    if (pdfBtn) pdfBtn.style.display = displayStyle;
    if (xlsxBtn) xlsxBtn.style.display = displayStyle;
    if (printBtn) printBtn.style.display = displayStyle;
}



function handleCariListeYazdir() {
    handleYazdir('cari-yonetimi');
}


function handleYazdir(sectionId) {
    const sectionToPrint = document.getElementById(sectionId);
    if (!sectionToPrint) {
        console.error("YazdÄ±rma hatasÄ±: YazdÄ±rÄ±lacak bÃ¶lÃ¼m bulunamadÄ± ->", sectionId);
        return;
    }

    const reportContent = sectionToPrint.querySelector('.printable-content');

    if (!reportContent || reportContent.innerHTML.trim() === '') {
        alert("LÃ¼tfen yazdÄ±rmadan Ã¶nce bir rapor oluÅŸturun.");
        return;
    }
    
    const bodyElement = document.body;
    bodyElement.classList.add('print-active');
    sectionToPrint.classList.add('print-section-active');

    const pageFormatClass = reportContent.classList.contains('format-a5') ? 'format-a5' : 'format-a4';
    bodyElement.classList.add(pageFormatClass);
    
    window.print();
}

window.onafterprint = () => {
    const bodyElement = document.body;
    bodyElement.classList.remove('print-active', 'format-a4', 'format-a5');
    document.querySelectorAll('.print-section-active').forEach(el => {
        el.classList.remove('print-section-active');
    });
};

</script>
</body>
</html>
