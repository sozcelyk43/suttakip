<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Müşteri Süt Hareketleri</title>
    <link rel="stylesheet" href="style.css">
    <meta name="theme-color" content="#2c3e50">
    <style>
        /* Bu sayfaya özel ek stiller */
        .summary-box { border-top: 2px solid #3498db; margin-top: 25px; padding-top: 15px; }
        .summary-box p { font-size: 1.1em; display: flex; justify-content: space-between; margin-bottom: 8px; }
        .summary-box strong { color: #2c3e50; }
        .filter-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .welcome-header { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body id="musteri_portali"> <div class="main-content">
<div class="module-header">
    <h2>Müşteri Süt Hareketleri</h2>
    <h3 style="margin:0; padding:0; border:none; font-weight: normal; font-size: 1.1em;">Hoş Geldiniz, <span id="musteriAdi">...</span></h3>
</div>
        <div class="container">


<div class="filter-buttons">
    <select id="ayFiltresi" class="form-control" style="height: 45px;"></select>
    <select id="yilFiltresi" class="form-control" style="height: 45px;"></select>
    <button type="button" id="raporGosterBtn" class="btn btn-primary" style="height: 45px;">Göster</button>

    <a href="sifre_degistir.html" class="btn btn-secondary">Şifre Değiştir</a>
    <a href="#" id="logoutButton" class="btn btn-danger" style="display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; padding-top: 5px; padding-bottom: 5px;">
        <div>Çıkış Yap</div>
        <div id="logoutUserEmail" style="font-size: 0.7em; font-weight: normal; text-transform: none;"></div>
    </a>
</div>

            <div class="list-section">
                <div class="table-responsive-wrapper">
                    <table id="sutHareketleriTablosu">
                        <thead>
                            <tr>
                                <th>TARİH</th>
                                <th>AKŞAM (LT)</th>
                                <th>SABAH (LT)</th>
                                <th>TOPLAM (LT)</th>
                                <th>BİRİM FİYAT (TL)</th>
                                <th>TOPLAM FİYAT (TL)</th>
                            </tr>
                        </thead>
                        <tbody id="sutListesiBody">
                            <tr><td colspan="6" style="text-align:center;">Lütfen bir ay seçin.</td></tr>
                        </tbody>
 			<tfoot id="sutListesiFooter"></tfoot>
                    </table>
                </div>
            </div>

        
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
            authDomain: "sut-takip-projem.firebaseapp.com",
            projectId: "sut-takip-projem",
            storageBucket: "sut-takip-projem.appspot.com",
            messagingSenderId: "512756958486",
            appId: "1:512756958486:web:13cceb6835e2c575e9fc37",
            measurementId: "G-LYLT9WFVNK"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let userCariId = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                const userEmailDiv = document.getElementById('logoutUserEmail');
                if (userEmailDiv) {
                    userEmailDiv.textContent = user.email;
                }

                db.collection('cariler').where('authUID', '==', user.uid).limit(1).get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        const cariDoc = snapshot.docs[0];
                        userCariId = cariDoc.id;
                        document.getElementById('musteriAdi').textContent = cariDoc.data().adiSoyadi;
                        
                        // --- YENİ KOD BLOĞU BAŞLANGICI ---
                        const aySelect = document.getElementById('ayFiltresi');
                        const yilSelect = document.getElementById('yilFiltresi');
                        const gosterBtn = document.getElementById('raporGosterBtn');
                        const now = new Date();

                        const ayIsimleri = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
                        ayIsimleri.forEach((ay, index) => {
                            const option = document.createElement('option');
                            option.value = String(index + 1).padStart(2, '0');
                            option.textContent = ay;
                            aySelect.appendChild(option);
                        });
                        aySelect.value = String(now.getMonth() + 1).padStart(2, '0');

                        for (let yil = 2050; yil >= 2000; yil--) {
                            const option = document.createElement('option');
                            option.value = yil;
                            option.textContent = yil;
                            yilSelect.appendChild(option);
                        }
                        yilSelect.value = now.getFullYear();

                        gosterBtn.addEventListener('click', () => {
                            const secilenAy = aySelect.value;
                            const secilenYil = yilSelect.value;
                            if (secilenAy && secilenYil && userCariId) {
                                const ayYil = `${secilenYil}-${secilenAy}`;
                                fetchSutHareketleri(ayYil);
                            }
                        });

                        gosterBtn.click();
                        // --- YENİ KOD BLOĞU SONU ---
                    } else {
                        alert("Bu hesaba bağlı bir müşteri kartı bulunamadı.");
                        handleLogout();
                    }
                })
                .catch(error => { // Hata yönetimi için .catch eklemek iyi bir pratiktir.
                    console.error("Müşteri bilgileri alınırken hata oluştu:", error);
                    alert("Müşteri bilgileri alınırken bir hata oluştu. Lütfen daha sonra tekrar deneyin.");
                    handleLogout();
                });

            } else {
                // Kullanıcı giriş yapmamışsa login sayfasına yönlendirilebilir.
                // Bu kısım zaten handleLogout ile dolaylı olarak yapılıyor.
                // handleLogout(); // Bu satır, giriş yapmamış kullanıcıyı login'e atar.
            }
        }); // <-- EKSİK OLAN KAPATMA PARANTEZİ

        const logoutButton = document.getElementById('logoutButton');

function handleLogout() {
    auth.signOut().then(() => {
        window.location.href = 'login.html';
    }).catch(error => console.error("Çıkış hatası:", error));
}

async function fetchSutHareketleri(ayYil) {
    const [year, month] = ayYil.split('-');
    const startDate = `${year}-${month}-01`;
    const endDate = new Date(year, month, 0).toISOString().split('T')[0];
    
    const listBody = document.getElementById('sutListesiBody');
    const listFooter = document.getElementById('sutListesiFooter'); // Yeni footer elemanını seç
    listBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Veriler yükleniyor...</td></tr>`;
    listFooter.innerHTML = ''; // Footer'ı temizle

    try {
        const snapshot = await db.collection('sut_alimlari')
            .where('cariId', '==', userCariId)
            .where('tarih', '>=', startDate)
            .where('tarih', '<=', endDate)
            .orderBy('tarih', 'desc')
            .get();

        if (snapshot.empty) {
            listBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Bu dönem için süt kaydı bulunmuyor.</td></tr>`;
            return;
        }

        let rows = '';
        // YENİ: Tüm toplamlar için değişkenler tanımla
        let donemToplamAksam = 0;
        let donemToplamSabah = 0;
        let donemToplamLitre = 0;
        let donemToplamHasiat = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            // YENİ: Her bir değeri ilgili toplama ekle
            donemToplamAksam += data.aksam || 0;
            donemToplamSabah += data.sabah || 0;
            donemToplamLitre += data.toplam || 0;
            donemToplamHasiat += data.toplamTutar || 0;

            rows += `
                <tr>
                    <td>${new Date(data.tarih + 'T00:00:00').toLocaleDateString('tr-TR')}</td>
                    <td>${(data.aksam || 0).toFixed(2)}</td>
                    <td>${(data.sabah || 0).toFixed(2)}</td>
                    <td><strong>${(data.toplam || 0).toFixed(2)}</strong></td>
                    <td>${(data.fiyat || 0).toFixed(2)}</td>
                    <td><strong>${(data.toplamTutar || 0).toFixed(2)}</strong></td>
                </tr>
            `;
        });
        
        listBody.innerHTML = rows;

        // YENİ: Ortalama birim fiyatı hesapla
        const ortalamaBirimFiyat = donemToplamLitre > 0 ? (donemToplamHasiat / donemToplamLitre) : 0;

        // YENİ: Tablonun en altına eklenecek toplam satırını oluştur
        const footerRow = `
            <tr class="report-totals-row">
                <td><strong>DÖNEM TOPLAMI</strong></td>
                <td><strong>${donemToplamAksam.toFixed(2)}</strong></td>
                <td><strong>${donemToplamSabah.toFixed(2)}</strong></td>
                <td><strong>${donemToplamLitre.toFixed(2)}</strong></td>
                <td><strong>${ortalamaBirimFiyat.toFixed(2)}</strong></td>
                <td><strong>${donemToplamHasiat.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}</strong></td>
            </tr>
        `;
        listFooter.innerHTML = footerRow;

    } catch (error) {
        console.error("Süt hareketleri alınırken hata: ", error);
        listBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Veriler yüklenemedi.</td></tr>`;
    }
}



    </script>
</body>
</html>
