<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gelişmiş Süt Girişi</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --light-color: #f8f9fa;
            --dark-color: #343a40; --border-color: #dee2e6; --white-color: #fff;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 0; background-color: var(--light-color); color: var(--dark-color); }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        header { 
            background-color: var(--primary-color); color: var(--white-color); padding: 15px 20px; text-align: center; 
            border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        header h1 { margin: 0; font-size: 1.5em; }
        main { padding: 20px 0; }
        #logoutButton { position: static; background-color: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9em; 
            font-weight: 600; transition: background-color 0.2s; line-height: 1.3; text-align: right; }
        #logoutButton:hover { background-color: #c0392b; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 1.1em; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .time-selection { display: flex; gap: 10px; }
        .time-selection input[type="radio"] { display: none; }
        .time-selection label { flex: 1; text-align: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out; font-weight: 600; }
        .time-selection input:not(:checked) + label { background-color: #f8f9fa; border: 1px solid #dee2e6; color: #6c757d; }
        .time-selection input:not(:checked) + label:hover { background-color: #e9ecef; border-color: #adb5bd; }
        .time-selection input:checked + label { color: white; font-weight: 700; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border: 2px solid rgba(0,0,0,0.1); }
        .time-selection input[id="aksam"]:checked + label { background-color: #ff8c00; }
        .time-selection input[id="sabah"]:checked + label { background-color: #28a745; }
        #producer-panel, #history-section { background-color: var(--white-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 25px; }
        #current-producer-name { font-size: 1.5em; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; text-align: center; }
.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
}

#history-list li:nth-child(odd) {
    background-color: #f1f1f1; }

#history-list li:nth-child(even) {
    background-color: #ffffff; }
.history-item {
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 4px;
}

.btn-icon {
    background: none;
    border: none;
    font-size: 1.1em;
    margin: 0 3px;
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 6px;
    transition: background-color 0.2s;
}

.btn-icon:hover {
    background-color: #e2e6ea;
}

.btn-delete {
    color: #dc3545;
}
.history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid #eee;
    font-size: 0.95em;
}

        .btn { padding: 15px; font-size: 1.1em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-secondary { background-color: var(--secondary-color); color: var(--white-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        #session-summary { background-color: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        #history-list { list-style: none; padding: 0; margin: 0; }
        .history-item { padding: 10px 0; border-bottom: 1px solid #f0f2f5; display: flex; align-items: center; gap: 10px; }
        .history-item-info { font-weight: 600; flex-grow: 1; }
        .history-item-details { text-align: right; }
.btn-sm {
    padding: 6px 10px;
    font-size: 0.8em;
    font-weight: 500;
    border-radius: 6px;
}
        .history-item .delete-btn { background-color: var(--danger-color); color: var(--white-color); padding: 8px 12px; font-size: 0.9em; flex-shrink: 0; border: none; border-radius: 6px; cursor: pointer; }
        #cancel-edit-btn { display: none; margin-top: 10px; width: 100%; background-color: var(--danger-color); color: var(--white-color); }
        .toast-message { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 1000; font-size: 1.1em; font-weight: 500; display: none; opacity: 0; transition: opacity 0.5s ease; }
        .toast-message.show { display: block; opacity: 1; }
    </style>
</head>
<body>

    <div id="toast-message" class="toast-message"></div>
    <div class="container">
        <header>
            <h1>Gelişmiş Süt Girişi</h1>
            <button id="logoutButton">🚪 Çıkış Yap</button>
        </header>
        <main>
            <form id="setup-form" onsubmit="return false;">
                <input type="hidden" id="editingSutAlimId">
                <div class="form-group">
                    <label for="collection-date">Süt Alım Tarihi</label>
                    <input type="date" id="collection-date" name="collection-date">
                </div>
                <div class="form-group">
                    <label for="unit-price">Süt Birim Fiyatı (₺)</label>
                    <input type="number" id="unit-price" name="unit-price" step="0.01">
                </div>
                <div class="form-group">
                    <label>Zaman</label>
                    <div class="time-selection">
                        <input type="radio" id="aksam" name="time" value="akşam" checked><label for="aksam">AKŞAM</label>
                        <input type="radio" id="sabah" name="time" value="sabah"><label for="sabah">SABAH</label>
                    </div>
                </div>
                <div class="form-group">
    <label for="category">
        Kategori/Köy (Rota)
        <span id="gunlukGenelToplamGosterge" style="float: right; color: var(--primary-color); font-weight: bold;"></span>
    </label>
    <select id="category" name="category"></select>
</div>
            </form>






            <div id="producer-panel" style="display: none;">
                <h2 id="current-producer-name">Üretici Adı</h2>
                

                <div class="form-group">
                    <label for="producer-select">Rota Dışı Seçim / Üretici Atlama</label>
                    <select id="producer-select" name="producer-select"></select>
                </div>
                <div class="form-group">
                    <label for="quantity">Miktar (Litre)</label>
                    <input type="number" id="quantity" name="quantity" step="0.1" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label for="notes">Açıklama</label>
                    <textarea id="notes" name="notes" rows="3"></textarea>
                </div>
                <div class="action-buttons">
    <button type="button" id="skip-btn" class="btn btn-secondary">Pas Geç</button>
    <button type="button" id="save-btn" class="btn btn-success">Kaydet ve Sonraki</button>
    <button type="button" id="cancel-edit-btn" class="btn btn-danger">İptal</button>
		</div>


            <section id="history-section" style="display: none;">
                <h2>Süt Alım Geçmişi (Bu Oturum)</h2>
                <div id="session-summary"></div>
                <ul id="history-list"></ul>
            </section>
        </main>
    </div>
	
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase başlatma
        if (!firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyCWG4nFwpXRffr_3MO8-Us9mWK6Wsfn0mY",
                authDomain: "sut-takip-projem.firebaseapp.com",
                projectId: "sut-takip-projem",
                storageBucket: "sut-takip-projem.appspot.com",
                messagingSenderId: "512756958486",
                appId: "1:512756958486:web:13cceb6835e2c575e9fc37"
            };
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        document.getElementById('logoutButton').addEventListener('click', () => {
            auth.signOut().then(() => { window.location.href = 'login.html'; }).catch(error => { console.error("Çıkış yaparken hata oluştu:", error); });
        });

        // Global değişkenler
let fullHistoryForDate = [];
let allProducersMap = new Map();
        let sahipId = '';
        let currentUserRole = '';
        let routeProducers = [], collectionHistory = [];
        let currentProducerIndex = 0;
        let editingEntry = null;

        // HTML Elemanları
        const collectionDateInput = document.getElementById('collection-date');
        const unitPriceInput = document.getElementById('unit-price');
        const categorySelect = document.getElementById('category');
        const producerPanel = document.getElementById('producer-panel');
        const currentProducerName = document.getElementById('current-producer-name');
        const producerSelect = document.getElementById('producer-select');
        const quantityInput = document.getElementById('quantity');
        const notesInput = document.getElementById('notes');
        const saveBtn = document.getElementById('save-btn');
        const skipBtn = document.getElementById('skip-btn');
        const historySection = document.getElementById('history-section');
        const historyList = document.getElementById('history-list');
        const sessionSummary = document.getElementById('session-summary');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editingSutAlimIdInput = document.getElementById('editingSutAlimId');
        const gunlukToplamGosterge = document.getElementById('gunlukToplamGosterge');

        // Ana uygulama akışı
        auth.onAuthStateChanged(user => {
            if (user) {
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton && user.email) {
                    logoutButton.innerHTML = `🚪 Çıkış Yap<br><small style="font-weight:normal; font-size:0.8em;">${user.email}</small>`;
                }
                db.collection('kullanicilar').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        sahipId = userData.sahipId || user.uid;
                        currentUserRole = userData.rol;
                        initializeApp();
                    } else {
                        alert("Kullanıcı profili bulunamadı.");
                        auth.signOut();
                    }
                });
            } else { window.location.href = 'login.html'; }
        });

        async function initializeApp() {
            collectionDateInput.value = new Date().toISOString().split('T')[0];
            const settings = await getSettings();
            unitPriceInput.value = settings.defaultMilkPrice ? settings.defaultMilkPrice.toFixed(2) : "15.50";
            const producersSnapshot = await db.collection('cariler').where('sahipId', '==', sahipId).get();
    	    producersSnapshot.forEach(doc => allProducersMap.set(doc.id, doc.data()));
            await populateCategories();
            await fetchAndRenderHistory(collectionDateInput.value);



    showDailyGrandTotal();
collectionDateInput.addEventListener('change', showDailyGrandTotal);


    collectionDateInput.addEventListener('change', () => fetchAndRenderHistory(collectionDateInput.value));
    categorySelect.addEventListener('change', startRoute);
    producerSelect.addEventListener('change', jumpToProducer);
    saveBtn.addEventListener('click', handleSave); // handleSave'i çağırır
    skipBtn.addEventListener('click', handleSkip);
    cancelEditBtn.addEventListener('click', cancelEditMode);
            
            const inputsToTriggerRoute = [collectionDateInput, ...document.querySelectorAll('input[name="time"]')];
            inputsToTriggerRoute.forEach(el => {
                el.addEventListener('change', () => { if (categorySelect.value) startRoute(); });
            });
        }
        
        async function getSettings() {
            if (!sahipId) return {};
            try {
                const doc = await db.collection('ayarlar').doc(sahipId).get();
                return doc.exists ? doc.data() : {};
            } catch (e) { console.error("Ayarlar alınamadı:", e); return {}; }
        }


async function fetchAndRenderHistory(date) {
    if (!date) return;
    historySection.style.display = 'none';
    historyList.innerHTML = '';

    try {
        const existingEntriesSnapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('tarih', '==', date)
            .get();
        
        fullHistoryForDate = existingEntriesSnapshot.docs.map(doc => ({ ...doc.data(), sutAlimId: doc.id }));
        filterAndRenderHistory(); // Filtreleme ve gösterme işini bu fonksiyona devret
    } catch (error) {
        console.error("Geçmiş yüklenirken hata:", error);
    }
} 
    
function filterAndRenderHistory() {
    const selectedCategory = categorySelect.value;
    let historyToRender = fullHistoryForDate;

    // Eğer bir kategori seçilmişse, sadece o kategoriye ait geçmişi göster
    if (selectedCategory) {
        historyToRender = fullHistoryForDate.filter(entry => {
            const producer = allProducersMap.get(entry.cariId);
            return producer && producer.kategori === selectedCategory;
        });
    }
    
    renderHistory(historyToRender); // Filtrelenmiş veriyi ekrana bas
}

    
function getDayDifference(dateStr) {
    const today = new Date();
    const entryDate = new Date(dateStr);
    today.setHours(0, 0, 0, 0);
    entryDate.setHours(0, 0, 0, 0);
    const diffTime = today - entryDate;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
}

async function saveMilkEntry(quantity, notes) {
    const unitPrice = parseFloat(String(unitPriceInput.value).replace(',', '.')) || 0;
    const alimTarihi = collectionDateInput.value;
    const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
    const currentProducer = routeProducers[currentProducerIndex];

    if (isNaN(unitPrice) || !alimTarihi) {
        alert('Lütfen Fiyat ve Tarih seçimlerini doğru yapın.');
        return;
    }
    saveBtn.disabled = true;
    skipBtn.disabled = true;

    try {
        if (quantity > 0) {
            const todayForCalc = new Date(alimTarihi);
            const yesterdayForCalc = new Date(todayForCalc);
            yesterdayForCalc.setDate(todayForCalc.getDate() - 1);
            const yesterdayStr = `${yesterdayForCalc.getFullYear()}-${String(yesterdayForCalc.getMonth() + 1).padStart(2, '0')}-${String(yesterdayForCalc.getDate()).padStart(2, '0')}`;
            const dunkuSutSnapshot = await db.collection('sut_alimlari').where('sahipId', '==', sahipId).where('cariId', '==', currentProducer.id).where('tarih', '==', yesterdayStr).get();
            
            if (!dunkuSutSnapshot.empty) {
                let dunkuToplam = 0;
                dunkuSutSnapshot.forEach(doc => { dunkuToplam += (doc.data().toplam || 0); });
                if (dunkuToplam > 0) {
                    const altLimit = dunkuToplam * 0.80;
                    const ustLimit = dunkuToplam * 1.20;
                    if (quantity < altLimit || quantity > ustLimit) {
                        const durum = quantity > dunkuToplam ? 'daha fazla' : 'daha az';
                        const onay = confirm(`⚠️ DİKKAT! \n\nGirilen miktar (${quantity.toFixed(1)} Lt), dünkü toplam miktardan (${dunkuToplam.toFixed(1)} Lt) %20 oranında ${durum}.\n\nBu miktar doğru mu? Kaydetmek için 'Tamam'a basın.`);
                        if (!onay) {
                            saveBtn.disabled = false; 
                            skipBtn.disabled = false; 
                            return;
                        }
                    }
                }
            }
        }
        
        const totalPrice = (quantity * unitPrice);
        const batch = db.batch();
        const sutAlimQuery = db.collection('sut_alimlari').where('sahipId', '==', sahipId).where('cariId', '==', currentProducer.id).where('tarih', '==', alimTarihi);
        const existingSutAlimSnapshot = await sutAlimQuery.get();
        let sutAlimRef;
        let newEntryData;
        
        if (existingSutAlimSnapshot.empty) {
            sutAlimRef = db.collection('sut_alimlari').doc();
            newEntryData = { 
                tarih: alimTarihi, cariId: currentProducer.id, cariAdi: currentProducer.adiSoyadi, 
                sabah: (zamanDilimi === 'sabah' ? quantity : 0), 
                aksam: (zamanDilimi === 'akşam' ? quantity : 0), 
                toplam: quantity, fiyat: unitPrice, toplamTutar: totalPrice, sahipId: sahipId,
                aciklama: `Hızlı giriş ile eklendi. Not: ${notes || ''}`
            };
            batch.set(sutAlimRef, newEntryData);
        } else {
            sutAlimRef = existingSutAlimSnapshot.docs[0].ref;
            const data = existingSutAlimSnapshot.docs[0].data();
            const newSabah = (zamanDilimi === 'sabah') ? quantity : (data.sabah || 0);
            const newAksam = (zamanDilimi === 'akşam') ? quantity : (data.aksam || 0);
            const newToplam = newSabah + newAksam;
            const newToplamTutar = newToplam * unitPrice;
            newEntryData = { 
                ...data,
                sabah: newSabah, aksam: newAksam, toplam: newToplam, toplamTutar: newToplamTutar, fiyat: unitPrice,
                aciklama: `Hızlı giriş ile güncellendi. Not: ${notes || ''}`
            };
            batch.update(sutAlimRef, newEntryData);
        }
        
        await batch.commit();

        const toast = document.getElementById('toast-message');
        toast.textContent = `✅ ${currentProducer.adiSoyadi} için ${quantity} Lt kaydedildi.`;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);

        // ARAYÜZÜ GÜNCELLEMEK İÇİN ESKİ YÖNTEM YERİNE YENİ YÖNTEM:
        // 1. Hafızadaki geçmiş listesini yeni kayıtla güncelle
        fullHistoryForDate = fullHistoryForDate.filter(item => item.sutAlimId !== sutAlimRef.id);
        fullHistoryForDate.push({ ...newEntryData, sutAlimId: sutAlimRef.id });

        // 2. Rota ve geçmişi yeniden oluşturan ana fonksiyonu çağır
        await startRoute();
        
    } catch (error) {
        console.error("Kayıt hatası:", error);
        alert("Veri kaydedilirken bir hata oluştu: " + error.message);
    } finally {
        saveBtn.disabled = false;
        skipBtn.disabled = false;
    }
}
        async function handleSaveAndNext() {
            const quantity = parseFloat(String(quantityInput.value).replace(',', '.')) || 0;
            if (isNaN(quantity) || quantity < 0) { alert('Lütfen geçerli bir miktar girin.'); return; }
            await saveMilkEntry(quantity, notesInput.value);
        }

        function handleSkip() {
            const producerName = routeProducers[currentProducerIndex]?.adiSoyadi || 'Bu üretici';
            const confirmation = confirm(`'${producerName}' için işlem seçin:\n\n➡️ SÜT YOK ise -> 'Tamam'a basın (0 Lt olarak kaydedilecektir).\n\n➡️ ULAŞILAMADIYSA veya başka bir sebeple atlamak için -> 'İptal'e basın.`);
            if (confirmation) {
                saveMilkEntry(0, "Süt yok");
            } else {
                currentProducerIndex++;
                displayCurrentProducer();
            }
        }

        function populateCategories() {
            db.collection('cari_kategorileri').where('sahipId', '==', sahipId).orderBy('ad').get()
                .then(snapshot => {
                    categorySelect.innerHTML = '<option value="">Rota Seçiniz...</option>';
                    snapshot.forEach(doc => {
                        categorySelect.innerHTML += `<option value="${doc.data().ad}">${doc.data().ad}</option>`;
                    });
                }).catch(e => {
                    console.error("Kategoriler yüklenirken hata:", e);
                    categorySelect.innerHTML = '<option value="" disabled selected>Hata: Rotalar yüklenemedi</option>';
                });
        }

// Mevcut startRoute fonksiyonunu bununla değiştirin
async function startRoute() {
    // Kategori seçildiği an, geçmiş listesini hemen filtrele
    filterAndRenderHistory();
    
    producerPanel.style.display = 'none';
    const category = categorySelect.value;
    if (!category) return;
    
    try {
        const producersSnapshot = await db.collection('cariler').where('sahipId', '==', sahipId).where('kategori', '==', category).where('durum', '==', 'aktif').where('cariGrup', 'array-contains', 'üretici').orderBy('rotaSirasi').get();

        const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
        const savedProducerIds = new Set();
        
        // `fullHistoryForDate` üzerinden kontrol yap
        fullHistoryForDate.forEach(entry => {
            if (
    (zamanDilimi === 'sabah' && (entry.sabah || 0) > 0) ||
    (zamanDilimi === 'akşam' && (entry.aksam || 0) > 0)
) {
    savedProducerIds.add(entry.cariId);
}

        });

        routeProducers = producersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(p => {
            const producerData = allProducersMap.get(p.id);
            return producerData && producerData.kategori === category && !savedProducerIds.has(p.id);
        });

        if(routeProducers.length === 0) {
            alert("Bu rota için bu zaman diliminde tüm süt girişleri tamamlanmış veya uygun üretici bulunamadı.");
            return;
        }
        
        currentProducerIndex = 0;
        populateProducerSelect();
        displayCurrentProducer();
        producerPanel.style.display = 'block';
    } catch (error) { 
        console.error("Rota başlatılırken hata:", error); 
        alert("Rota başlatılamadı."); 
    }
}

function displayCurrentProducer() {
    if (currentProducerIndex >= routeProducers.length) {
        producerPanel.style.display = 'none';
        if (routeProducers.length > 0 || collectionHistory.length > 0) {
             alert(`${categorySelect.options[categorySelect.selectedIndex].text} rotası tamamlandı!`);
        }
        return;
    }
    const producer = routeProducers[currentProducerIndex];
    currentProducerName.textContent = producer.adiSoyadi;
    producerSelect.value = currentProducerIndex;
    quantityInput.value = '';
    notesInput.value = '';
    quantityInput.focus();
}


async function showDailyGrandTotal() {
    const displayElement = document.getElementById('gunlukGenelToplamGosterge');
    const date = collectionDateInput.value; // Üstten seçilen tarih

    // Tarih seçili değilse uyarı verip çık
    if (!date) {
        displayElement.textContent = 'Lütfen bir tarih seçin.';
        return;
    }

    displayElement.textContent = 'Toplam yükleniyor...'; // Yükleme durumunu göster

    try {
        // Seçilen tarihe ait tüm süt alımlarını Firestore'dan çek
        const snapshot = await db.collection('sut_alimlari')
            .where('sahipId', '==', sahipId)
            .where('tarih', '==', date)
            .get();

        if (snapshot.empty) {
            // Eğer o tarihe ait hiç kayıt yoksa 0.0 Lt göster
            displayElement.textContent = `Mevcut: 0.0 Lt`;
        } else {
            let toplamSabah = 0;
            let toplamAksam = 0;

            // Helper fonksiyon: Değeri güvenli bir şekilde sayıya çevirir
            const toNumber = (val) => parseFloat(String(val || 0).replace(',', '.')) || 0;

            // Her bir süt alımı kaydını döngüye alarak sabah ve akşam toplamlarını hesapla
            snapshot.forEach(doc => {
                const data = doc.data();
                toplamSabah += toNumber(data.sabah);
                toplamAksam += toNumber(data.aksam);
            });

            // Sabah ve akşam toplamlarını birleştirerek genel toplamı bul
            const genelToplam = toplamSabah + toplamAksam;

            // Hesaplanan genel toplamı ekranda göster
            displayElement.textContent = `Mevcut: ${genelToplam.toFixed(1)} Lt`;
        }
    } catch (error) {
        // Hata durumunda konsola logla ve kullanıcıya mesaj göster
        console.error("Günlük genel toplam alınırken hata:", error);
        displayElement.textContent = 'Toplam alınamadı';
    }
}


       
        function populateProducerSelect() {
             producerSelect.innerHTML = '';
            routeProducers.forEach((producer, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${producer.rotaSirasi || (index + 1)}. ${producer.adiSoyadi}`;
                producerSelect.appendChild(option);
            });
        }

        function jumpToProducer() {
            currentProducerIndex = parseInt(this.value);
            displayCurrentProducer();
        }
function renderHistory(dataToRender) {
    if (!historySection || !historyList || !sessionSummary) return;

    if (!dataToRender || dataToRender.length === 0) {
        historySection.style.display = 'none';
        return;
    }

    historySection.style.display = 'block';
    historyList.innerHTML = '';

    let toplamSabah = 0;
    let toplamAksam = 0;

    const groupedByProducer = {};
    dataToRender.forEach(item => {
        if (!groupedByProducer[item.cariId]) {
            groupedByProducer[item.cariId] = {
                cariAdi: item.cariAdi,
                sabah: 0,
                aksam: 0,
                fiyat: item.fiyat,
                sutAlimId: item.sutAlimId,
                tarih: item.tarih
            };
        }
        groupedByProducer[item.cariId].sabah += item.sabah || 0;
        groupedByProducer[item.cariId].aksam += item.aksam || 0;
    });

		Object.values(groupedByProducer).forEach(item => {
   	 const listItem = document.createElement('li');
   	 listItem.className = 'history-item';

   	 const gunlukToplam = item.sabah + item.aksam;
    	toplamSabah += item.sabah;
    	toplamAksam += item.aksam;

    	let buttonHTML = '';
	buttonHTML += `<button class="btn-icon" title="Sabah Düzenle" onclick="editHistoryItem('${item.sutAlimId}', 'sabah')">☀️✏️</button>`;
	buttonHTML += `<button class="btn-icon" title="Akşam Düzenle" onclick="editHistoryItem('${item.sutAlimId}', 'aksam')">🌙✏️</button>`;
	buttonHTML += `<button class="btn-icon btn-delete" title="Sil" onclick="deleteHistoryItem('${item.sutAlimId}')">🗑️</button>`;


    listItem.innerHTML = `
        <div class="history-item-info">${item.cariAdi}</div>
        <div class="history-item-details">
            <span>${gunlukToplam.toFixed(1)} Lt (S:${item.sabah.toFixed(1)}, A:${item.aksam.toFixed(1)})</span>
        </div>
        <div>
            ${buttonHTML}
        </div>`;
        
    historyList.appendChild(listItem);
});


    const toplamGenel = toplamSabah + toplamAksam;

    sessionSummary.innerHTML = `
        <p>Seçilen güne ait Sabah Sütü: <strong>${toplamSabah.toFixed(1)} Lt</strong></p>
        <p>Seçilen güne ait Akşam Sütü: <strong>${toplamAksam.toFixed(1)} Lt</strong></p>
        <p>Seçilen güne ait Toplam Süt: <strong>${toplamGenel.toFixed(1)} Lt</strong></p>
    `;
}


// Mevcut deleteHistoryItem fonksiyonunu silip bunu yapıştırın:
async function deleteHistoryItem(sutAlimId) {
    // DEĞİŞİKLİK: Artık doğru dizi olan 'fullHistoryForDate' içinde arama yapıyor
    const entryToDelete = fullHistoryForDate.find(item => item.sutAlimId === sutAlimId);
    if (!entryToDelete) {
        alert("Silinecek kayıt oturum geçmişinde bulunamadı.");
        return;
    }

    const dayDifference = getDayDifference(entryToDelete.tarih);
    if (currentUserRole !== 'admin' && dayDifference > 2) {
        alert('Bu kaydı silme yetkiniz yok.');
        return;
    }
    
    if (!confirm(`'${entryToDelete.cariAdi}' için girilen tüm süt kayıtlarını kalıcı olarak silmek istediğinizden emin misiniz?`)) {
        return;
    }

    const saveBtn = document.getElementById('save-btn');
    const skipBtn = document.getElementById('skip-btn');
    saveBtn.disabled = true;
    skipBtn.disabled = true;

    try {
        const alimTarihi = entryToDelete.tarih;
        await db.collection('sut_alimlari').doc(sutAlimId).delete();
        alert("Kayıt başarıyla silindi.");
        
        await fetchAndRenderHistory(alimTarihi);
        if (categorySelect.value) {
            await startRoute();
        }
    } catch (error) {
        console.error("Silme hatası:", error);
        alert("Kayıt silinirken bir hata oluştu: " + error.message);
    } finally {
        saveBtn.disabled = false;
        skipBtn.disabled = false;
    }
}

function handleSave() {
    if (editingSutAlimIdInput.value) {
        handleUpdate();
    } else {
        handleSaveAndNext();
    }
}

function setEditMode(entry, zamanDilimi) {
    producerPanel.style.display = 'block';
    editingEntry = entry;
    editingSutAlimIdInput.value = entry.sutAlimId;

    const miktar = zamanDilimi === 'sabah' ? entry.sabah : entry.aksam;

    document.getElementById(zamanDilimi).checked = true;
    
    currentProducerName.textContent = `DÜZENLE: ${entry.cariAdi}`;
    quantityInput.value = miktar;
    notesInput.value = entry.not || '';
    unitPriceInput.value = (entry.fiyat || 0).toFixed(2);
    
    producerSelect.disabled = true;
    categorySelect.disabled = true;
    
    skipBtn.style.display = 'none';
    saveBtn.textContent = 'Güncelle';
    saveBtn.className = 'btn btn-warning';
    cancelEditBtn.style.display = 'block';
    
    producerPanel.scrollIntoView({ behavior: 'smooth' });
}

function cancelEditMode() {
    editingEntry = null;
    editingSutAlimIdInput.value = '';
    producerSelect.disabled = false;
    categorySelect.disabled = false;
    skipBtn.style.display = 'block';
    saveBtn.textContent = 'Kaydet ve Sonraki';
    saveBtn.className = 'btn btn-success';
    cancelEditBtn.style.display = 'none';
    
    // Aktif üreticiyi tekrar göster
    if(routeProducers.length > 0 && currentProducerIndex < routeProducers.length) {
         displayCurrentProducer();
    } else {
         producerPanel.style.display = 'none';
    }
}

async function handleUpdate() {
    const yeniMiktar = parseFloat(String(quantityInput.value).replace(',', '.')) || 0;
    if (isNaN(yeniMiktar) || yeniMiktar < 0) { alert('Lütfen geçerli bir miktar girin.'); return; }
    if (!editingEntry) { alert("Hata: Düzenlenecek giriş bilgisi bulunamadı."); return; }

    saveBtn.disabled = true;
    
    const yeniBirimFiyat = parseFloat(unitPriceInput.value);
    const zamanDilimi = document.querySelector('input[name="time"]:checked').value;
    const sutAlimId = editingSutAlimIdInput.value;
    const alimTarihi = collectionDateInput.value;

    const sutAlimRef = db.collection('sut_alimlari').doc(sutAlimId);

    try {
        await db.runTransaction(async (transaction) => {
            const sutDoc = await transaction.get(sutAlimRef);
            if (!sutDoc.exists) throw new Error("Ana süt alım kaydı bulunamadı!");
            
            const data = sutDoc.data();
            const sutUpdates = {};
            
            // Diğer zaman dilimindeki değeri koru
            let mevcutSabah = data.sabah || 0;
            let mevcutAksam = data.aksam || 0;

            if (zamanDilimi === 'sabah') {
                mevcutSabah = yeniMiktar;
            } else { 
                mevcutAksam = yeniMiktar;
            }

            sutUpdates.sabah = mevcutSabah;
            sutUpdates.aksam = mevcutAksam;
            sutUpdates.toplam = mevcutSabah + mevcutAksam;
            sutUpdates.fiyat = yeniBirimFiyat;
            sutUpdates.toplamTutar = sutUpdates.toplam * yeniBirimFiyat;
            sutUpdates.not = notesInput.value;

            transaction.update(sutAlimRef, sutUpdates);
        });

        alert("Kayıt başarıyla güncellendi.");
        await fetchAndRenderHistory(alimTarihi);
        if (categorySelect.value) { await startRoute(); }
        cancelEditMode(); 
    } catch (error) {
        alert("Güncelleme sırasında bir hata oluştu: " + error.message);
        console.error("Update Error:", error);
    } finally {
        saveBtn.disabled = false;
    }
}

function editHistoryItem(sutAlimId, zaman) {
    const entry = fullHistoryForDate.find(item => item.sutAlimId === sutAlimId);
    
    if (entry) {
        const dayDifference = getDayDifference(entry.tarih);
        if (currentUserRole !== 'admin' && dayDifference > 2) {
            alert('Bu kaydı düzenleme yetkiniz yok. Sadece son 2 güne ait kayıtlar düzenlenebilir.');
            return;
        }
        setEditMode(entry, zaman);
    } else {
        alert("Düzenlenecek kayıt bulunamadı. Lütfen sayfayı yenileyip tekrar deneyin.");
    }
}
        
        
    </script>
</body>
</html>